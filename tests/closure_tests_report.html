<html><body><h1>Closure Library Tests Results (Success: 170/377) - Took: 99411ms</h1><table border="1"><tr>
<th>Test</th><th>Results</th><th>Summary</th><th>Details (Mouse Over for Code)</th>
<tr><td>registry_test.html</td><td>Fail</td><td> 5 passed, 1 failed.</td><td title="

    goog.require('goog.object');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.registry');
  

    // Fake component and renderer implementations, for testing only.

    // UnknownComponent has no default renderer or decorator registered.
    function UnknownComponent() {
    }

    // FakeComponentX's default renderer is FakeRenderer.  It also has a
    // decorator.
    function FakeComponentX() {
      this.element = null;
    }

    FakeComponentX.prototype.decorate = function(element) {
      this.element = element;
    };

    // FakeComponentY doesn't have an explicitly registered default
    // renderer; it should inherit the default renderer from its superclass.
    // It does have a decorator registered.
    function FakeComponentY() {
      FakeComponentX.call(this);
    }
    goog.inherits(FakeComponentY, FakeComponentX);

    // FakeComponentZ is just another component.  Its default renderer is
    // FakeSingletonRenderer, but it has no decorator registered.
    function FakeComponentZ() {
    }

    // FakeRenderer is a stateful renderer.
    function FakeRenderer() {
    }

    // FakeSingletonRenderer is a stateless renderer that can be used as a
    // singleton.
    function FakeSingletonRenderer() {
    }

    FakeSingletonRenderer.instance_ = new FakeSingletonRenderer();

    FakeSingletonRenderer.getInstance = function() {
      return FakeSingletonRenderer.instance_;
    };

    function setUp() {
      goog.ui.registry.setDefaultRenderer(FakeComponentX, FakeRenderer);
      goog.ui.registry.setDefaultRenderer(FakeComponentZ,
          FakeSingletonRenderer);

      goog.ui.registry.setDecoratorByClassName('fake-component-x',
          function() {
            return new FakeComponentX();
          });
      goog.ui.registry.setDecoratorByClassName('fake-component-y',
          function() {
            return new FakeComponentY();
          });
    }

    function tearDown() {
      goog.ui.registry.reset();
    }

    function testGetDefaultRenderer() {
      var rx1 = goog.ui.registry.getDefaultRenderer(FakeComponentX);
      var rx2 = goog.ui.registry.getDefaultRenderer(FakeComponentX);
      assertTrue('FakeComponentX\'s default renderer must be a FakeRenderer',
          rx1 instanceof FakeRenderer);
      assertNotEquals('Each call to getDefaultRenderer must create a new ' +
          'FakeRenderer', rx1, rx2);

      var ry = goog.ui.registry.getDefaultRenderer(FakeComponentY);
      assertTrue('FakeComponentY must inherit its default renderer from ' +
          'its superclass', ry instanceof FakeRenderer);

      var rz1 = goog.ui.registry.getDefaultRenderer(FakeComponentZ);
      var rz2 = goog.ui.registry.getDefaultRenderer(FakeComponentZ);
      assertTrue('FakeComponentZ\' default renderer must be a ' +
          'FakeSingletonRenderer', rz1 instanceof FakeSingletonRenderer);
      assertEquals('Each call to getDefaultRenderer must return the ' +
          'singleton instance of FakeSingletonRenderer', rz1, rz2);

      assertNull('getDefaultRenderer must return null for unknown component',
          goog.ui.registry.getDefaultRenderer(UnknownComponent));
    }

    function testSetDefaultRenderer() {
      var rx1 = goog.ui.registry.getDefaultRenderer(FakeComponentX);
      assertTrue('FakeComponentX\'s renderer must be FakeRenderer',
          rx1 instanceof FakeRenderer);

      var ry1 = goog.ui.registry.getDefaultRenderer(FakeComponentY);
      assertTrue('FakeComponentY must inherit its default renderer from ' +
          'its superclass', ry1 instanceof FakeRenderer);

      goog.ui.registry.setDefaultRenderer(FakeComponentX,
          FakeSingletonRenderer);

      var rx2 = goog.ui.registry.getDefaultRenderer(FakeComponentX);
      assertEquals('FakeComponentX\'s renderer must be FakeSingletonRenderer',
          FakeSingletonRenderer.getInstance(), rx2);

      var ry2 = goog.ui.registry.getDefaultRenderer(FakeComponentY);
      assertEquals('FakeComponentY must inherit the new default renderer ' +
          'from its superclass', FakeSingletonRenderer.getInstance(), ry2);

      goog.ui.registry.setDefaultRenderer(FakeComponentY, FakeRenderer);

      var rx3 = goog.ui.registry.getDefaultRenderer(FakeComponentX);
      assertEquals('FakeComponentX\'s renderer must be unchanged',
          FakeSingletonRenderer.getInstance(), rx3);

      var ry3 = goog.ui.registry.getDefaultRenderer(FakeComponentY);
      assertTrue('FakeComponentY must now have its own default renderer',
          ry3 instanceof FakeRenderer);

      assertThrows('Calling setDefaultRenderer with non-function component ' +
          'must throw error',
          function() {
            goog.ui.registry.setDefaultRenderer('Not function', FakeRenderer);
          });

      assertThrows('Calling setDefaultRenderer with non-function renderer ' +
          'must throw error',
          function() {
            goog.ui.registry.setDefaultRenderer(FakeComponentX, 'Not function');
          });
    }

    function testGetDecoratorByClassName() {
      var dx1 = goog.ui.registry.getDecoratorByClassName('fake-component-x');
      var dx2 = goog.ui.registry.getDecoratorByClassName('fake-component-x');
      assertTrue('fake-component-x must be decorated by a FakeComponentX',
          dx1 instanceof FakeComponentX);
      assertNotEquals('Each call to getDecoratorByClassName must return a ' +
          'new FakeComponentX instance', dx1, dx2);

      var dy1 = goog.ui.registry.getDecoratorByClassName('fake-component-y');
      var dy2 = goog.ui.registry.getDecoratorByClassName('fake-component-y');
      assertTrue('fake-component-y must be decorated by a FakeComponentY',
          dy1 instanceof FakeComponentY);
      assertNotEquals('Each call to getDecoratorByClassName must return a ' +
          'new FakeComponentY instance', dy1, dy2);

      assertNull('getDecoratorByClassName must return null for unknown class',
          goog.ui.registry.getDecoratorByClassName('fake-component-z'));
      assertNull('getDecoratorByClassName must return null for empty string',
          goog.ui.registry.getDecoratorByClassName(''));
    }

    function testSetDecoratorByClassName() {
      var dx1, dx2;

      dx1 = goog.ui.registry.getDecoratorByClassName('fake-component-x');
      assertTrue('fake-component-x must be decorated by a FakeComponentX',
          dx1 instanceof FakeComponentX);
      goog.ui.registry.setDecoratorByClassName('fake-component-x',
          function() {
            return new UnknownComponent();
          });
      dx2 = goog.ui.registry.getDecoratorByClassName('fake-component-x');
      assertTrue('fake-component-x must now be decorated by UnknownComponent',
          dx2 instanceof UnknownComponent);

      assertThrows('Calling setDecoratorByClassName with invalid class name ' +
          'must throw error',
          function() {
            goog.ui.registry.setDecoratorByClassName('', function() {
              return new UnknownComponent();
            });
          });

      assertThrows('Calling setDecoratorByClassName with non-function ' +
          'decorator must throw error',
          function() {
            goog.ui.registry.setDecoratorByClassName('fake-component-x',
                'Not function');
          });
    }

    function testGetDecorator() {
      var dx = goog.ui.registry.getDecorator(document.getElementById('x'));
      assertTrue('Decorator for element with fake-component-x class must be ' +
          'a FakeComponentX', dx instanceof FakeComponentX);

      var dy = goog.ui.registry.getDecorator(document.getElementById('y'));
      assertTrue('Decorator for element with fake-component-y class must be '
          + 'a FakeComponentY', dy instanceof FakeComponentY);

      var dz = goog.ui.registry.getDecorator(document.getElementById('z'));
      assertNull('Decorator for element with unknown class must be null', dz);

      var du = goog.ui.registry.getDecorator(document.getElementById('u'));
      assertNull('Decorator for element without CSS class must be null', du);
    }

    function testReset() {
      assertNotEquals('Some renderers must be registered', 0,
          goog.object.getCount(goog.ui.registry.defaultRenderers_));
      assertNotEquals('Some decorators must be registered', 0,
          goog.object.getCount(goog.ui.registry.decoratorFunctions_));

      goog.ui.registry.reset();

      assertTrue('No renderers must be registered',
          goog.object.isEmpty(goog.ui.registry.defaultRenderers_));
      assertTrue('No decorators must be registered',
          goog.object.isEmpty(goog.ui.registry.decoratorFunctions_));
    }
  ">6 of 6 tests run in 7ms.<br />5 passed, 1 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testGetDecorator<br />Decorator for element with fake-component-x class must be a FakeComponentX<br />Call to assertTrue(boolean) with false<br />> assertTrue at testing/asserts.js:261:3<br />> testGetDecorator at _tmpclosuretest.js:190:7<br /></td></tr>
<tr><td>tweakui_test.html</td><td>Fail</td><td> undefined</td><td title="

    goog.require('goog.dom');
    goog.require('goog.string');
    goog.require('goog.testing.jsunit');
    goog.require('goog.tweak.TweakUi');
    goog.require('goog.tweak.testhelpers');
  


var root = document.getElementById('root');
var registry;
var EXPECTED_ENTRIES_COUNT = 14;

function setUp() {
  // Make both test cases use the same entries in order to be able to test that
  // having two UIs on the same page does not cause trouble.
  createRegistryEntries('');
  registry = goog.tweak.getRegistry();
}

function tearDown() {
  goog.tweak.activeBooleanGroup_ = null;
  // When debugging a single test, don't clear out the DOM.
  if (window.location.search.indexOf('runTests') == -1) {
    root.innerHTML = '';
  }
}

function tearDownPage() {
  // When debugging a single test, don't clear out the DOM.
  if (window.location.search.indexOf('runTests') != -1) {
    return;
  }
  // Create both registries for interactive testing.
  createRegistryEntries('');
  registry = goog.tweak.getRegistry();
  // Add an extra tweak for testing the creation of tweaks after the UI has
  // already been rendered.
  var entryCounter = 0;
  goog.tweak.registerButton('CreateNewTweak', 'Creates a new tweak. Meant ' +
      'to simulate a tweak being registered in a lazy-loaded module.',
      function() {
    goog.tweak.registerBoolean('Lazy' + ++entryCounter, 'Lazy-loaded tweak.');
  });
  goog.tweak.registerButton('CreateNewTweakInNamespace1',
      'Creates a new tweak within a namespace. Meant to simulate a tweak ' +
      'being registered in a lazy-loaded module.', function() {
    goog.tweak.registerString('foo.bar.Lazy' + ++entryCounter,
        'Lazy-loaded tweak.');
  });
  goog.tweak.registerButton('CreateNewTweakInNamespace2',
      'Creates a new tweak within a namespace. Meant to simulate a tweak ' +
      'being registered in a lazy-loaded module.', function() {
    goog.tweak.registerNumber('foo.bar.baz.Lazy' + ++entryCounter, 'Lazy combo',
        3, {
      validValues: [1, 2, 3],
      label: 'Lazy!'
    });
  });

  var label = document.createElement('h3');
  label.innerHTML = 'TweakUi:';
  root.appendChild(label);
  createUi(false);

  label = document.createElement('h3');
  label.innerHTML = 'Collapsible:';
  root.appendChild(label);
  createUi(true);
}

function createUi(collapsible) {
  var tweakUiElem = collapsible ? goog.tweak.TweakUi.createCollapsible() :
      goog.tweak.TweakUi.create();
  root.appendChild(tweakUiElem);
}

function getAllEntryDivs() {
  return goog.dom.getElementsByTagNameAndClass('div',
      goog.tweak.TweakUi.ENTRY_CSS_CLASS_);
}

function getEntryDiv(entry) {
  var label = goog.tweak.TweakUi.getNamespacedLabel_(entry);
  var allDivs = getAllEntryDivs();
  var ret;
  for (var i = 0, div; div = allDivs[i]; i++) {
    var divText = goog.dom.getTextContent(div);
    if (goog.string.startsWith(divText, label) &&
        goog.string.contains(divText, entry.description)) {
      assertFalse('Found multiple divs matching entry ' + entry.getId(), !!ret);
      ret = div;
    }
  }
  assertTrue('getEntryDiv failed for ' + entry.getId(), !!ret);
  return ret;
}

function getEntryInput(entry) {
  var div = getEntryDiv(entry);
  return div.getElementsByTagName('input')[0] ||
      div.getElementsByTagName('select')[0];
}

function testCreate() {
  createUi(false);
  assertEquals('Wrong number of entry divs.', EXPECTED_ENTRIES_COUNT,
      getAllEntryDivs().length);

  assertFalse('checkbox should not be checked 1',
      getEntryInput(boolEntry).checked);
  assertTrue('checkbox should be checked 2',
      getEntryInput(boolEntry2).checked);
  // Enusre custom labels are being used.
  var html = document.getElementsByTagName('button')[0].innerHTML;
  assertTrue('Button label is wrong', html.indexOf('&lt;btn&gt;') > -1);
  html = getEntryDiv(numEnumEntry).innerHTML;
  assertTrue('Enum2 label is wrong', html.indexOf('second&amp;') > -1);
}

function testToggleBooleanSetting() {
  boolEntry.setValue(true);
  createUi(false);

  assertTrue('checkbox should be checked',
      getEntryInput(boolEntry).checked);

  boolEntry.setValue(false);
  assertFalse('checkbox should not be checked 1',
      getEntryInput(boolEntry).checked);
}

function testToggleStringSetting() {
  strEntry.setValue('val1');
  createUi(false);

  assertEquals('Textbox has wrong value 1',
      'val1', getEntryInput(strEntry).value);

  strEntry.setValue('val2');
  assertEquals('Textbox has wrong value 2',
      'val2', getEntryInput(strEntry).value);
}

function testToggleStringEnumSetting() {
  strEnumEntry.setValue('B');
  createUi(false);

  assertEquals('wrong value 1',
      'B', getEntryInput(strEnumEntry).value);

  strEnumEntry.setValue('C');
  assertEquals('wrong value 2',
      'C', getEntryInput(strEnumEntry).value);
}


function testToggleNumericSetting() {
  numEntry.setValue(3);
  createUi(false);

  assertEquals('wrong value 1',
      '3', getEntryInput(numEntry).value);

  numEntry.setValue(4);
  assertEquals('wrong value 2',
      '4', getEntryInput(numEntry).value);
}

function testToggleNumericEnumSetting() {
  numEnumEntry.setValue(2);
  createUi(false);

  assertEquals('wrong value 1',
      '2', getEntryInput(numEnumEntry).value);

  numEnumEntry.setValue(3);
  assertEquals('wrong value 2',
      '3', getEntryInput(numEnumEntry).value);
}

function testClickBooleanSetting() {
  createUi(false);

  var input = getEntryInput(boolEntry);
  input.checked = true;
  input.onchange();
  assertTrue('setting should be true', boolEntry.getNewValue());
  input.checked = false;
  input.onchange();
  assertFalse('setting should be false', boolEntry.getNewValue());
}

function testToggleDescriptions() {
  createUi(false);
  var toggleLink = root.getElementsByTagName('a')[0];
  var heightBefore = root.offsetHeight;
  toggleLink.onclick();
  assertTrue('Expected div height to grow from toggle descriptions.',
      root.offsetHeight > heightBefore);
  toggleLink.onclick();
  assertEquals('Expected div height to revert from toggle descriptions.',
      heightBefore, root.offsetHeight);
}

function assertEntryOrder(entryId1, entryId2) {
  var entry1 = registry.getEntry(entryId1);
  var entry2 = registry.getEntry(entryId2);
  var div1 = getEntryDiv(entry1);
  var div2 = getEntryDiv(entry2);
  var order = goog.dom.compareNodeOrder(div1, div2);
  assertTrue(entry1.getId() + ' should be before ' + entry2.getId(), order < 0);
}

function testAddEntry() {
  createUi(false);
  goog.tweak.registerBoolean('Lazy1', 'Lazy-loaded tweak.');
  goog.tweak.registerBoolean('Lazy2', 'Lazy-loaded tweak.',
      /* defaultValue */ false, { restartRequired: false });
  goog.tweak.beginBooleanGroup('LazyGroup', 'Lazy-loaded tweak.');
  goog.tweak.registerBoolean('Lazy3', 'Lazy-loaded tweak.');
  goog.tweak.endBooleanGroup();

  assertEquals('Wrong number of entry divs.', EXPECTED_ENTRIES_COUNT + 4,
      getAllEntryDivs().length);
  assertEntryOrder('Enum2', 'Lazy1');
  assertEntryOrder('Lazy1', 'Lazy2');
  assertEntryOrder('Lazy2', 'Num');
  assertEntryOrder('BoolGroup', 'Lazy3');
}

function testAddNamespacedEntries() {
  createUi(false);
  goog.tweak.beginBooleanGroup('NS.LazyGroup', 'Lazy-loaded tweak.');
  goog.tweak.registerBoolean('NS.InGroup', 'Lazy-loaded tweak.');
  goog.tweak.endBooleanGroup();
  goog.tweak.registerBoolean('NS.Banana', 'Lazy-loaded tweak.');
  goog.tweak.registerBoolean('NS.Apple', 'Lazy-loaded tweak.');

  assertEquals('Wrong number of entry divs.', EXPECTED_ENTRIES_COUNT + 5,
      getAllEntryDivs().length);
  assertEntryOrder('Enum2', 'NS.Apple');
  assertEntryOrder('NS.Apple', 'NS.Banana');
  assertEntryOrder('NS.Banana', 'NS.InGroup');
}

function testCollapsibleIsLazy() {
  if (document.createEvent) {
    createUi(true);
    assertEquals('Expected no entry divs.', 0, getAllEntryDivs().length);
    var showLink = root.getElementsByTagName('a')[0];
    var event = document.createEvent('MouseEvents');
    event.initMouseEvent('click', true, true, window, 0, 0, 0, 0, 0, false,
        false, false, false, 0, null);
    showLink.dispatchEvent(event);
    assertEquals('Wrong number of entry divs.', EXPECTED_ENTRIES_COUNT,
        getAllEntryDivs().length);
  }
}
">TypeError: Object #<Object> has no method 'createElement'
    at [object Object].tearDownPage (_tmpclosuretest.js:62:24)
    at [object Object].finalize (testing/testcase.js:356:8)
    at [object Object].cycleTests (testing/testcase.js:718:8)
    at [object Object].execute (testing/testcase.js:346:8)
    at [object Object].runTests (testing/testcase.js:488:8)
    at [object Object].execute (testing/testrunner.js:266:17)
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:429:6)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
</td></tr>
<tr><td>entries_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="

    goog.require('goog.testing.jsunit');
    goog.require('goog.testing.MockControl');
    goog.require('goog.tweak.BaseEntry');
    goog.require('goog.tweak.testhelpers');
  


var mockControl;

function setUp() {
  mockControl = new goog.testing.MockControl();
}

function tearDown() {
  goog.tweak.registry_ = null;
  mockControl.$verifyAll();
}

function testGetValue_defaultValues() {
  createRegistryEntries('');
  assertFalse('wrong initial value for bool', boolEntry.getValue());
  assertEquals('wrong initial value for enum', 'A', strEnumEntry.getValue());
  assertEquals('wrong initial value for str', '', strEntry.getValue());

  assertEquals('wrong initial value for bool2', true, boolEntry2.getValue());
  assertEquals('wrong initial value for enum2', 1, numEnumEntry.getValue());
  assertEquals('wrong initial value for str2', 'foo', strEntry2.getValue());

  assertFalse('wrong initial value for BoolOne', boolOneEntry.getValue());
  assertTrue('wrong initial value for BoolTwo', boolTwoEntry.getValue());
}

function testGetValue_nonDefaultValues() {
  createRegistryEntries('?bool=1&enum=C');
  // These have the restartRequired option set.
  boolEntry.setValue(false);
  strEntry.setValue('foo');
  numEntry.setValue(5);
  assertTrue('wrong value for boolean', boolEntry.getValue());
  assertEquals('wrong value for string', strEntry.getDefaultValue(),
      strEntry.getValue());
  assertEquals('wrong value for num', numEntry.getDefaultValue(),
      numEntry.getValue());

  // These do not have the restartRequired option set.
  strEnumEntry.setValue('B');
  boolOneEntry.setValue(true);
  assertEquals('wrong value for strEnum', 'B', strEnumEntry.getValue());
  assertEquals('wrong value for boolOne', true, boolOneEntry.getValue());
}

function testCallbacks() {
  createRegistryEntries('');
  var mockCallback = mockControl.createFunctionMock();
  boolEntry.addCallback(mockCallback);
  boolOneEntry.addCallback(mockCallback);
  strEnumEntry.addCallback(mockCallback);
  numEnumEntry.addCallback(mockCallback);

  mockCallback(boolEntry);
  mockCallback(boolOneEntry);
  mockCallback(strEnumEntry);
  mockCallback(numEnumEntry);
  mockControl.$replayAll();

  boolEntry.setValue(true);
  boolOneEntry.setValue(true);
  strEnumEntry.setValue('C');
  numEnumEntry.setValue(3);
}

">n/a</td></tr>
<tr><td>moduleloadcallback_test.html</td><td>Success</td><td> 1 passed, 0 failed.</td><td title="


goog.require('goog.debug.ErrorHandler');
goog.require('goog.debug.entryPointRegistry');
goog.require('goog.functions');
goog.require('goog.module.ModuleLoadCallback');
goog.require('goog.testing.jsunit');
goog.require('goog.testing.recordFunction');





function testProtectEntryPoint() {
  // Test a callback created before the protect method is called.
  var callback1 = new goog.module.ModuleLoadCallback(
      goog.functions.error('callback1'));

  var errorFn = goog.testing.recordFunction();
  var errorHandler = new goog.debug.ErrorHandler(errorFn);
  goog.debug.entryPointRegistry.monitorAll(errorHandler);

  assertEquals(0, errorFn.getCallCount());
  assertThrows(goog.bind(callback1.execute, callback1));
  assertEquals(1, errorFn.getCallCount());
  assertContains('callback1', errorFn.getLastCall().getArguments()[0].message);

  // Test a callback created after the protect method is called.
  var callback2 = new goog.module.ModuleLoadCallback(
      goog.functions.error('callback2'));
  assertThrows(goog.bind(callback1.execute, callback2));
  assertEquals(2, errorFn.getCallCount());
  assertContains('callback2', errorFn.getLastCall().getArguments()[0].message);
}

">n/a</td></tr>
<tr><td>moduleinfo_test.html</td><td>Success</td><td> 4 passed, 0 failed.</td><td title="


  goog.require('goog.module.BaseModule');
  goog.require('goog.module.ModuleInfo');
  goog.require('goog.module.ModuleManager');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.MockClock');



  /**
   * Test initial state of module info.
   */
  function testNotLoadedAtStart() {
    var m = new goog.module.ModuleInfo();
    assertFalse('Shouldn\'t be loaded', m.isLoaded());
  }

  var TestModule = function() {
    goog.module.BaseModule.call(this);
  };
  goog.inherits(TestModule, goog.module.BaseModule);

  /**
   * Test loaded module info.
   */
  function testOnLoad() {
    var m = new goog.module.ModuleInfo();

    m.setModuleConstructor(TestModule);
    m.onLoad(goog.nullFunction);
    assertTrue(m.isLoaded());

    var module = m.getModule();
    assertNotNull(module);
    assertTrue(module instanceof TestModule);

    m.dispose();
    assertTrue(m.isDisposed());
    assertTrue('Disposing of ModuleInfo should dispose of its module',
        module.isDisposed());
  }

  /**
   * Test callbacks on module load.
   */
  function testCallbacks() {
    var m = new goog.module.ModuleInfo();
    m.setModuleConstructor(TestModule);
    var index = 0;
    var a = -1, b = -1, c = -1, d = -1;
    var ca = m.registerCallback(function() { a = index++; })
    var cb = m.registerCallback(function() { b = index++; })
    var cc = m.registerCallback(function() { c = index++; })
    var cd = m.registerEarlyCallback(function() { d = index++; })
    cb.abort();
    m.onLoad(goog.nullFunction);

    assertTrue('callback A should have fired', a >= 0);
    assertFalse('callback B should have been aborted', b >= 0);
    assertTrue('callback C should have fired', c >= 0);
    assertTrue('early callback d should have fired', d >= 0);

    assertEquals('ordering of callbacks was wrong', 0, d);
    assertEquals('ordering of callbacks was wrong', 1, a);
    assertEquals('ordering of callbacks was wrong', 2, c);
  }


  /**
   * Tests the error callbacks.
   */
  function testErrbacks() {
    var m = new goog.module.ModuleInfo();
    m.setModuleConstructor(TestModule);
    var index = 0;
    var a = -1, b = -1, c = -1, d = -1;
    var ca = m.registerErrback(function() { a = index++; })
    var cb = m.registerErrback(function() { b = index++; })
    var cc = m.registerErrback(function() { c = index++; })
    m.onError('foo');

    assertTrue('callback A should have fired', a >= 0);
    assertTrue('callback B should have fired', b >= 0);
    assertTrue('callback C should have fired', c >= 0);

    assertEquals('ordering of callbacks was wrong', 0, a);
    assertEquals('ordering of callbacks was wrong', 1, b);
    assertEquals('ordering of callbacks was wrong', 2, c);
  }
">n/a</td></tr>
<tr><td>moduleloader_test.html</td><td>Fail</td><td> 0 passed, 9 failed.</td><td title="



goog.require('goog.array');
goog.require('goog.dom');
goog.require('goog.functions');
goog.require('goog.module.ModuleLoader');
goog.require('goog.module.ModuleManager');
goog.require('goog.object');
goog.require('goog.testing.AsyncTestCase');
goog.require('goog.testing.PropertyReplacer');
goog.require('goog.testing.jsunit');





var moduleLoader = null;
var moduleManager = null;
var stubs = new goog.testing.PropertyReplacer();

var testCase = goog.testing.AsyncTestCase.createAndInstall(document.title);
testCase.stepTimeout = 5 * 1000; // 5 seconds

testCase.setUp = function() {
  goog.provide = goog.nullFunction;
  moduleManager = goog.module.ModuleManager.getInstance();
  moduleLoader = new goog.module.ModuleLoader();

  moduleManager.setLoader(moduleLoader);
  moduleManager.setAllModuleInfo({
      'modA': [],
      'modB': ['modA']
  });
  moduleManager.setModuleUris({
      'modA': ['testdata/modA_1.js', 'testdata/modA_2.js'],
      'modB': ['testdata/modB_1.js']
  });

  assertNotLoaded('modA');
  assertNotLoaded('modB');
  assertUndefined(window.modA_);
};

testCase.tearDown = function() {
  stubs.reset();

  // Ensure that the module manager was created.
  assertNotNull(goog.module.ModuleManager.getInstance());
  moduleManager = goog.module.ModuleManager.instance_ = null;

  // tear down the module loaded flag.
  window.modA_1 = false;

  // Remove all the fake scripts.
  var scripts = goog.array.clone(
      document.getElementsByTagName('SCRIPT'));
  for (var i = 0; i < scripts.length; i++) {
    if (scripts[i].src.indexOf('testdata') != -1) {
      goog.dom.removeNode(scripts[i]);
    }
  }
};

function testLoadModuleA() {
  testCase.waitForAsync('wait for module A load');
  moduleManager.execOnLoad('modA', function() {
    testCase.continueTesting();
    assertLoaded('modA');
    assertNotLoaded('modB');
    assertTrue(window.modA_1);
  });
}

function testLoadModuleB() {
  testCase.waitForAsync('wait for module B load');
  moduleManager.execOnLoad('modB', function() {
    testCase.continueTesting();
    assertLoaded('modA');
    assertLoaded('modB');
    assertTrue(window.modA_1);
  });
}

function testLoadDebugModuleA() {
  testCase.waitForAsync('wait for module A load');
  moduleLoader.setDebugMode(true);
  moduleManager.execOnLoad('modA', function() {
    testCase.continueTesting();
    assertLoaded('modA');
    assertNotLoaded('modB');
    assertTrue(window.modA_1);
  });
}

function testLoadDebugModuleB() {
  testCase.waitForAsync('wait for module B load');
  moduleLoader.setDebugMode(true);
  moduleManager.execOnLoad('modB', function() {
    testCase.continueTesting();
    assertLoaded('modA');
    assertLoaded('modB');
    assertTrue(window.modA_1);
  });
}

function testLoadDebugModuleAThenB() {
  // Swap the script tags of module A, to introduce a race condition.
  // See the comments on this in ModuleLoader's debug loader.
  moduleManager.setModuleUris({
      'modA': ['testdata/modA_2.js', 'testdata/modA_1.js'],
      'modB': ['testdata/modB_1.js']
  });
  testCase.waitForAsync('wait for module B load');
  moduleLoader.setDebugMode(true);
  moduleManager.execOnLoad('modB', function() {
    testCase.continueTesting();
    assertLoaded('modA');
    assertLoaded('modB');

    var scripts = goog.array.clone(
        document.getElementsByTagName('SCRIPT'));
    var seenLastScriptOfModuleA = false;
    for (var i = 0; i < scripts.length; i++) {
      var uri = scripts[i].src;
      if (uri.indexOf('modA_1.js') >= 0) {
        seenLastScriptOfModuleA = true;
      } else if (uri.indexOf('modB') >= 0) {
        assertTrue(seenLastScriptOfModuleA);
      }
    }
  });
}

function testModuleLoaderRecursesTooDeep(opt_numModules) {
  // There was a bug in the module loader where it would retry recursively
  // whenever there was a synchronous failure in the module load. When you
  // asked for modB, it would try to load its dependency modA. When modA
  // failed, it would move onto modB, and then start over, repeating until it
  // ran out of stack.
  var numModules = opt_numModules || 1;
  var uris = {};
  var deps = {};
  var mods = [];
  for (var num = 0; num < numModules; num++) {
    var modName = 'mod' + num;
    mods.unshift(modName);
    uris[modName] = [];
    deps[modName] = num ? ['mod' + (num - 1)] : [];
    for (var i = 0; i < 5; i++) {
      uris[modName].push(
          'http://www.google.com/crossdomain' + num + 'x' + i + '.js');
    }
  }

  moduleManager.setAllModuleInfo(deps);
  moduleManager.setModuleUris(uris);

  // Make all XHRs throw an error, so that we test the error-handling
  // functionality.
  var oldXmlHttp = goog.net.XmlHttp;
  stubs.set(goog.net, 'XmlHttp', function() {
    return {
       open: goog.functions.error('mock error'),
       abort: goog.nullFunction
    };
  });
  goog.object.extend(goog.net.XmlHttp, oldXmlHttp);

  var errorCount = 0;
  var errorIds = [];
  var errorHandler = function(ignored, modId) {
    errorCount++;
    errorIds.push(modId);
  };
  moduleManager.registerCallback(
      goog.module.ModuleManager.CallbackType.ERROR,
      errorHandler);

  moduleManager.execOnLoad(mods[0], function() {
    fail('modB should not load successfully');
  });

  assertEquals(mods.length, errorCount);

  goog.array.sort(mods);
  goog.array.sort(errorIds);
  assertArrayEquals(mods, errorIds);

  assertArrayEquals([], moduleManager.requestedModuleIdsQueue_);
  assertArrayEquals([], moduleManager.userInitiatedLoadingModuleIds_);
}

function testModuleLoaderRecursesTooDeep2modules() {
  testModuleLoaderRecursesTooDeep(2);
}

function testModuleLoaderRecursesTooDeep3modules() {
  testModuleLoaderRecursesTooDeep(3);
}

function testModuleLoaderRecursesTooDeep4modules() {
  testModuleLoaderRecursesTooDeep(3);
}

function assertLoaded(id) {
  assertTrue(moduleManager.getModuleInfo(id).isLoaded());
}

function assertNotLoaded(id) {
  assertFalse(moduleManager.getModuleInfo(id).isLoaded());
}

">9 of 9 tests run in 7066ms.<br />0 passed, 9 failed.<br />785 ms/test. 1 files loaded.<br />ERROR in testLoadDebugModuleA [wait for module A load]<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testLoadDebugModuleA [wait for module A load]<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testLoadDebugModuleAThenB [wait for module B load]<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testLoadDebugModuleAThenB [wait for module B load]<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testLoadDebugModuleB [wait for module B load]<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testLoadDebugModuleB [wait for module B load]<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testLoadModuleA [wait for module A load]<br />XMLHttpRequest is not defined<br />ERROR in testLoadModuleA [wait for module A load]<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testLoadModuleB [wait for module B load]<br />XMLHttpRequest is not defined<br />ERROR in testLoadModuleB [wait for module B load]<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testModuleLoaderRecursesTooDeep [tearDown]<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testModuleLoaderRecursesTooDeep2modules [tearDown]<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testModuleLoaderRecursesTooDeep3modules [tearDown]<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testModuleLoaderRecursesTooDeep4modules [tearDown]<br />Object #<Object> has no method 'getElementsByTagName'<br /></td></tr>
<tr><td>modulemanager_test.html</td><td>Success</td><td> 35 passed, 0 failed.</td><td title="


  goog.require('goog.functions');
  goog.require('goog.module.BaseModule');
  goog.require('goog.module.ModuleManager');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.recordFunction');


  var clock;

  function setUpPage() {
    clock = new goog.testing.MockClock(true);
  }

  function tearDownPage() {
    clock.dispose();
  }

  function getModuleManager(infoMap) {
    var mm = new goog.module.ModuleManager();
    mm.setAllModuleInfo(infoMap);

    mm.isModuleLoaded = function(id) {
      return this.getModuleInfo(id).isLoaded();
    }
    return mm;
  }

  function createSuccessfulBatchLoader(moduleMgr) {
    return {
      loadModules: function(ids, moduleInfoMap, opt_successFn, opt_errFn,
          opt_timeoutFn) {
        setTimeout(goog.bind(this.onLoad, this, ids.concat(), 0), 5);
      },
      onLoad: function(ids, idxLoaded) {
        moduleMgr.beforeLoadModuleCode(ids[0]);
        moduleMgr.setLoaded(ids[idxLoaded]);
        moduleMgr.afterLoadModuleCode(ids[idxLoaded]);
        var idx = idxLoaded + 1;
        if (idx < ids.length) {
          moduleMgr.beforeLoadModuleCode(ids[idx]);
          setTimeout(goog.bind(this.onLoad, this, ids, idx), 2);
        }
      }};
  }

  function createSuccessfulNonBatchLoader(moduleMgr) {
    return {
      loadModules: function(ids, moduleInfoMap, opt_successFn, opt_errFn,
          opt_timeoutFn) {
        setTimeout(function() {
          moduleMgr.beforeLoadModuleCode(ids[0]);
          moduleMgr.setLoaded(ids[0]);
          moduleMgr.afterLoadModuleCode(ids[0]);
          if (opt_successFn) {
            opt_successFn();
          }
        }, 5);
      }};
  }

  function createUnsuccessfulLoader(moduleMgr, status) {
    return {
      loadModules: function(ids, moduleInfoMap, opt_successFn, opt_errFn,
          opt_timeoutFn) {
        moduleMgr.beforeLoadModuleCode(ids[0]);
        setTimeout(function() { opt_errFn(status); }, 5);
      }};
  }

  function createTimeoutLoader(moduleMgr, status) {
    return {
      loadModules: function(ids, moduleInfoMap, opt_successFn, opt_errFn,
          opt_timeoutFn) {
        setTimeout(function() { opt_timeoutFn(status); }, 5);
      }};
  }

  /**
   * Tests loading a module under different conditions i.e. unloaded
   * module, already loaded module, module loaded through user initiated
   * actions, synchronous callback for a module that has been already
   * loaded. Test both batch and non-batch loaders.
   */
  function testExecOnLoad() {
    var mm = getModuleManager({'a': [], 'b': [], 'c': []});
    mm.setLoader(createSuccessfulNonBatchLoader(mm));
    execOnLoad_(mm);

    mm = getModuleManager({'a': [], 'b': [], 'c': []});
    mm.setLoader(createSuccessfulBatchLoader(mm));
    mm.setBatchModeEnabled(true);
    execOnLoad_(mm);
  }

  /**
   * Tests execOnLoad with the specified module manager.
   * @param {goog.module.ModuleManager} mm The module manager.
   */
  function execOnLoad_(mm) {
    // When module is unloaded, execOnLoad is async.
    var execCalled1 = false;
    mm.execOnLoad('a', function() { execCalled1 = true; });
    assertFalse('module "a" should not be loaded', mm.isModuleLoaded('a'));
    assertTrue('module "a" should be loading', mm.isModuleLoading('a'));
    assertFalse('execCalled1 should not be set yet', execCalled1);
    assertTrue('ModuleManager should be active', mm.isActive());
    assertFalse(
        'ModuleManager should not be user active', mm.isUserActive());
    clock.tick(5);
    assertTrue('module "a" should be loaded', mm.isModuleLoaded('a'));
    assertFalse(
        'module "a" should not be loading', mm.isModuleLoading('a'));
    assertTrue('execCalled1 should be set', execCalled1);
    assertFalse('ModuleManager should not be active', mm.isActive());
    assertFalse(
        'ModuleManager should not be user active', mm.isUserActive());

    // When module is already loaded, execOnLoad is still async unless
    // specified otherwise.
    var execCalled2 = false;
    mm.execOnLoad('a', function() { execCalled2 = true; });
    assertTrue('module "a" should be loaded', mm.isModuleLoaded('a'));
    assertFalse(
        'module "a" should not be loading', mm.isModuleLoading('a'));
    assertFalse('execCalled2 should not be set yet', execCalled2);
    clock.tick(5);
    assertTrue('execCalled2 should be set', execCalled2);

    // When module is unloaded, execOnLoad is async (user active).
    var execCalled5 = false;
    mm.execOnLoad('c',
        function() { execCalled5 = true; }, null, null, true);
    assertFalse('module "c" should not be loaded', mm.isModuleLoaded('c'));
    assertTrue('module "c" should be loading', mm.isModuleLoading('c'));
    assertFalse('execCalled1 should not be set yet', execCalled5);
    assertTrue('ModuleManager should be active', mm.isActive());
    assertTrue('ModuleManager should be user active', mm.isUserActive());
    clock.tick(5);
    assertTrue('module "c" should be loaded', mm.isModuleLoaded('c'));
    assertFalse(
        'module "c" should not be loading', mm.isModuleLoading('c'));
    assertTrue('execCalled1 should be set', execCalled5);
    assertFalse('ModuleManager should not be active', mm.isActive());
    assertFalse(
        'ModuleManager should not be user active', mm.isUserActive());

    // When module is already loaded, execOnLoad is still synchronous when
    // so specified
    var execCalled6 = false;
    mm.execOnLoad('c', function() { execCalled6 = true; },
        undefined, undefined, undefined, true);
    assertTrue('module "c" should be loaded', mm.isModuleLoaded('c'));
    assertFalse(
        'module "c" should not be loading', mm.isModuleLoading('c'));
    assertTrue('execCalled6 should be set', execCalled6);
    clock.tick(5);
    assertTrue('execCalled6 should still be set', execCalled6);

  }

  /**
   * Test aborting the callback called on module load.
   */
  function testExecOnLoadAbort() {
    var mm = getModuleManager({'a': [], 'b': [], 'c': []});
    mm.setLoader(createSuccessfulNonBatchLoader(mm));

    // When module is unloaded and abort is called, module still gets
    // loaded, but callback is cancelled.
    var execCalled1 = false;
    var callback1 = mm.execOnLoad('b', function() { execCalled1 = true; });
    callback1.abort();
    clock.tick(5);
    assertTrue('module "b" should be loaded', mm.isModuleLoaded('b'));
    assertFalse('execCalled3 should not be set', execCalled1);

    // When module is already loaded, execOnLoad is still async, so calling
    // abort should still cancel the callback.
    var execCalled2 = false;
    var callback2 = mm.execOnLoad('a', function() { execCalled2 = true; });
    callback2.abort();
    clock.tick(5);
    assertFalse('execCalled2 should not be set', execCalled2);
  }

  /**
   * Test preloading modules and ensure that the before load, after load
   * and set load called are called only once per module.
   */
  function testExecOnLoadWhilePreloadingAndViceVersa() {
    var mm = getModuleManager({'c': [], 'd': []});
    mm.setLoader(createSuccessfulNonBatchLoader(mm));
    execOnLoadWhilePreloadingAndViceVersa_(mm);

    mm = getModuleManager({'c': [], 'd': []});
    mm.setLoader(createSuccessfulBatchLoader(mm));
    mm.setBatchModeEnabled(true);
    execOnLoadWhilePreloadingAndViceVersa_(mm);
  }

  /**
   * Perform tests with the specified module manager.
   * @param {goog.module.ModuleManager} mm The module manager.
   */
  function execOnLoadWhilePreloadingAndViceVersa_(mm) {
    var mm = getModuleManager({'c': [], 'd': []});
    mm.setLoader(createSuccessfulNonBatchLoader(mm));

    var origSetLoaded = mm.setLoaded;
    var calls = [0, 0, 0];
    mm.beforeLoadModuleCode = function(id) {
      calls[0]++;
    };
    mm.setLoaded = function(id) {
      calls[1]++;
      origSetLoaded.call(mm, id);
    };
    mm.afterLoadModuleCode = function(id) {
      calls[2]++;
    };

    mm.preloadModule('c', 2);
    assertFalse(
        'module "c" should not be loading yet', mm.isModuleLoading('c'));
    clock.tick(2);
    assertTrue(
        'module "c" should now be loading', mm.isModuleLoading('c'));
    mm.execOnLoad('c', function() {});
    assertTrue(
        'module "c" should still be loading', mm.isModuleLoading('c'));
    clock.tick(5);
    assertFalse(
        'module "c" should be done loading', mm.isModuleLoading('c'));
    assertEquals(
        'beforeLoad should only be called once for "c"', 1, calls[0]);
    assertEquals(
        'setLoaded should only be called once for "c"', 1, calls[1]);
    assertEquals(
        'afterLoad should only be called once for "c"', 1, calls[2]);

    mm.execOnLoad('d', function() {});
    assertTrue(
        'module "d" should now be loading', mm.isModuleLoading('d'));
    mm.preloadModule('d', 2);
    clock.tick(5);
    assertFalse(
        'module "d" should be done loading', mm.isModuleLoading('d'));
    assertTrue(
        'module "d" should now be loaded', mm.isModuleLoaded('d'));
    assertEquals(
        'beforeLoad should only be called once for "d"', 2, calls[0]);
    assertEquals(
        'setLoaded should only be called once for "d"', 2, calls[1]);
    assertEquals(
        'afterLoad should only be called once for "d"', 2, calls[2]);
  }

  /**
   * Tests that multiple callbacks on the same module don't cause
   * confusion about the active state after the module is finally loaded.
   */
  function testUserInitiatedExecOnLoadEventuallyLeavesManagerIdle() {
    var mm = getModuleManager({'c': [], 'd': []});
    mm.setLoader(createSuccessfulNonBatchLoader(mm));

    var calledBack1 = false;
    var calledBack2 = false;

    mm.execOnLoad(
        'c',
        function() {
          calledBack1 = true;
        },
        undefined,
        undefined,
        true);
    mm.execOnLoad(
        'c',
        function() {
          calledBack2 = true;
        },
        undefined,
        undefined,
        true);
    mm.load('c');

    assertTrue(
        'Manager should be active while waiting for load', mm.isUserActive());

    clock.tick(5);

    assertTrue('First callback should be called', calledBack1);
    assertTrue('Second callback should be called', calledBack2);
    assertFalse(
        'Manager should be inactive after loading is complete',
        mm.isUserActive());
  }

  /**
   * Tests loading a module by requesting a Deferred object.
   */
  function testLoad() {
    var mm = getModuleManager({'a': [], 'b': [], 'c': []});
    mm.setLoader(createSuccessfulNonBatchLoader(mm));

    var calledBack = false;
    var error = null;

    var d = mm.load('a');
    d.addCallback(function(ctx) {
      calledBack = true;
    });
    d.addErrback(function(err) {
      error = err;
    });

    assertFalse(calledBack);
    assertNull(error);
    assertFalse(mm.isUserActive());

    clock.tick(5);

    assertTrue(calledBack);
    assertNull(error);
  }

  /**
   * Tests loading a module by user action by requesting a Deferred object.
   */
  function testLoadForUser() {
    var mm = getModuleManager({'a': [], 'b': [], 'c': []});
    mm.setLoader(createSuccessfulNonBatchLoader(mm));

    var calledBack = false;
    var error = null;

    var d = mm.load('a', true);
    d.addCallback(function(ctx) {
      calledBack = true;
    });
    d.addErrback(function(err) {
      error = err;
    });

    assertFalse(calledBack);
    assertNull(error);
    assertTrue(mm.isUserActive());

    clock.tick(5);

    assertTrue(calledBack);
    assertNull(error);
  }

  /**
   * Tests that preloading a module calls back the deferred object.
   */
  function testPreloadDeferredWhenNotLoaded() {
    var mm = getModuleManager({'a': []});
    mm.setLoader(createSuccessfulNonBatchLoader(mm));

    var calledBack = false;

    var d = mm.preloadModule('a');;
    d.addCallback(function(ctx) {
      calledBack = true;
    });

    // First load should take five ticks.
    assertFalse('module "a" should not be loaded yet', calledBack);
    clock.tick(5);
    assertTrue('module "a" should be loaded', calledBack);
  }

  /**
   * Tests preloading an already loaded module.
   */
  function testPreloadDeferredWhenLoaded() {
    var mm = getModuleManager({'a': []});
    mm.setLoader(createSuccessfulNonBatchLoader(mm));

    var calledBack = false;

    mm.preloadModule('a');
    clock.tick(5);

    var d = mm.preloadModule('a');;
    d.addCallback(function(ctx) {
      calledBack = true;
    });

    // Module is already loaded, should be called back after the setTimeout
    // in preloadModule.
    assertFalse('deferred for module "a" should not be called yet', calledBack);
    clock.tick(1);
    assertTrue('module "a" should be loaded', calledBack);
  }


  /**
   * Tests preloading a module that is currently loading.
   */
  function testPreloadDeferredWhenLoading() {
    var mm = getModuleManager({'a': []});
    mm.setLoader(createSuccessfulNonBatchLoader(mm));

    mm.preloadModule('a');
    clock.tick(1);

    // 'b' is in the middle of loading, should get called back when it's done.
    var calledBack = false;
    var d = mm.preloadModule('a');;
    d.addCallback(function(ctx) {
      calledBack = true;
    });

    assertFalse('module "a" should not be loaded yet', calledBack);
    clock.tick(4);
    assertTrue('module "a" should be loaded', calledBack);
  }

  /**
   * Tests that load doesn't trigger another load if a module is already
   * preloading.
   */
  function testLoadWhenPreloading() {
    var mm = getModuleManager({'a': [], 'b': [], 'c': []});
    mm.setLoader(createSuccessfulNonBatchLoader(mm));

    var origSetLoaded = mm.setLoaded;
    var calls = [0, 0, 0];
    mm.beforeLoadModuleCode = function(id) {
      calls[0]++;
    };
    mm.setLoaded = function(id) {
      calls[1]++;
      origSetLoaded.call(mm, id);
    };
    mm.afterLoadModuleCode = function(id) {
      calls[2]++;
    };

    var calledBack = false;
    var error = null;

    mm.preloadModule('c', 2);
    assertFalse(
        'module "c" should not be loading yet', mm.isModuleLoading('c'));
    clock.tick(2);
    assertTrue(
        'module "c" should now be loading', mm.isModuleLoading('c'));

    var d = mm.load('c');
    d.addCallback(function(ctx) {
      calledBack = true;
    });
    d.addErrback(function(err) {
      error = err;
    });

    assertTrue(
        'module "c" should still be loading', mm.isModuleLoading('c'));
    clock.tick(5);
    assertFalse(
        'module "c" should be done loading', mm.isModuleLoading('c'));
    assertEquals(
        'beforeLoad should only be called once for "c"', 1, calls[0]);
    assertEquals(
        'setLoaded should only be called once for "c"', 1, calls[1]);
    assertEquals(
        'afterLoad should only be called once for "c"', 1, calls[2]);

    assertTrue(calledBack);
    assertNull(error);
  }

 /**
   * Tests loading a module via load when the module is already
   * loaded.  The deferred's callback should be called immediately.
   */
 function testLoadWhenLoaded() {
    var mm = getModuleManager({'a': [], 'b': [], 'c': []});
    mm.setLoader(createSuccessfulNonBatchLoader(mm));

    var calledBack = false;
    var error = null;

    mm.preloadModule('b', 2);
    clock.tick(10);

    assertFalse(
        'module "b" should be done loading', mm.isModuleLoading('b'));

    var d = mm.load('b');
    d.addCallback(function(ctx) {
      calledBack = true;
    });
    d.addErrback(function(err) {
      error = err;
    });

    assertTrue(calledBack);
    assertNull(error);
  }

  /**
   * Tests that the deferred's errbacks are called if the module fails to load.
   */
  function testLoadWithFailingModule() {
    var mm = getModuleManager({'a': [], 'b': [], 'c': []});
    mm.setLoader(createUnsuccessfulLoader(mm, 401));
    mm.registerCallback(goog.module.ModuleManager.CallbackType.ERROR,
        function(callbackType, id, cause) {
      assertEquals('Failure cause was not as expected',
                   goog.module.ModuleManager.FailureType.UNAUTHORIZED,
                   cause);
      firedLoadFailed = true;
    });
    var calledBack = false;
    var error = null;

    var d = mm.load('a');
    d.addCallback(function(ctx) {
      calledBack = true;
    });
    d.addErrback(function(err) {
      error = err;
    });

    assertFalse(calledBack);
    assertNull(error);

    clock.tick(500);

    assertFalse(calledBack);

    // NOTE: Deferred always calls errbacks with an Error object.  For now the
    // module manager just passes the FailureType which gets set as the Error
    // object's message.
    assertEquals('Failure cause was not as expected',
        goog.module.ModuleManager.FailureType.UNAUTHORIZED,
        Number(error.message));
  }

  /**
   * Test loading dependencies transitively.
   */
  function testLoadingDepsInNonBatchMode1() {
    var mm = getModuleManager({
      'i': [],
      'j': [],
      'k': ['j'],
      'l': ['i','j','k']});
    mm.setLoader(createSuccessfulNonBatchLoader(mm));

    mm.preloadModule('j');
    clock.tick(5);
    assertTrue('module "j" should be loaded', mm.isModuleLoaded('j'));
    assertFalse(
        'module "i" should not be loaded (1)', mm.isModuleLoaded('i'));
    assertFalse(
        'module "k" should not be loaded (1)', mm.isModuleLoaded('k'));
    assertFalse(
        'module "l" should not be loaded (1)', mm.isModuleLoaded('l'));

    // When loading a module in non-batch mode, its dependencies should be
    // requested independently, and in dependency order.
    mm.preloadModule('l');
    clock.tick(5);
    assertTrue('module "i" should be loaded', mm.isModuleLoaded('i'));
    assertFalse(
        'module "k" should not be loaded (2)', mm.isModuleLoaded('k'));
    assertFalse(
        'module "l" should not be loaded (2)', mm.isModuleLoaded('l'));
    clock.tick(5);
    assertTrue('module "k" should be loaded', mm.isModuleLoaded('k'));
    assertFalse(
        'module "l" should not be loaded (3)', mm.isModuleLoaded('l'));
    clock.tick(5);
    assertTrue(
        'module "l" should be loaded', mm.isModuleLoaded('l'));
  }

  /**
   * Test loading dependencies transitively and in dependency order.
   */
  function testLoadingDepsInNonBatchMode2() {
    var mm = getModuleManager({
      'h': [],
      'i': ['h'],
      'j': ['i'],
      'k': ['j'],
      'l': ['i','j','k'],
      'm': ['l']});
    mm.setLoader(createSuccessfulNonBatchLoader(mm));

    // When loading a module in non-batch mode, its dependencies should be
    // requested independently, and in dependency order. The order in this
    // case should be h,i,j,k,l,m.
    mm.preloadModule('m');
    clock.tick(5);
    assertTrue('module "h" should be loaded', mm.isModuleLoaded('h'));
    assertFalse(
        'module "i" should not be loaded (1)', mm.isModuleLoaded('i'));
    assertFalse(
        'module "j" should not be loaded (1)', mm.isModuleLoaded('j'));
    assertFalse(
        'module "k" should not be loaded (1)', mm.isModuleLoaded('k'));
    assertFalse(
        'module "l" should not be loaded (1)', mm.isModuleLoaded('l'));
    assertFalse(
        'module "m" should not be loaded (1)', mm.isModuleLoaded('m'));

    clock.tick(5);
    assertTrue('module "i" should be loaded', mm.isModuleLoaded('i'));
    assertFalse(
        'module "j" should not be loaded (2)', mm.isModuleLoaded('j'));
    assertFalse(
        'module "k" should not be loaded (2)', mm.isModuleLoaded('k'));
    assertFalse(
        'module "l" should not be loaded (2)', mm.isModuleLoaded('l'));
    assertFalse(
        'module "m" should not be loaded (2)', mm.isModuleLoaded('m'));

    clock.tick(5);
    assertTrue('module "j" should be loaded', mm.isModuleLoaded('j'));
    assertFalse(
        'module "k" should not be loaded (3)', mm.isModuleLoaded('k'));
    assertFalse(
        'module "l" should not be loaded (3)', mm.isModuleLoaded('l'));
    assertFalse(
        'module "m" should not be loaded (3)', mm.isModuleLoaded('m'));

    clock.tick(5);
    assertTrue('module "k" should be loaded', mm.isModuleLoaded('k'));
    assertFalse(
        'module "l" should not be loaded (4)', mm.isModuleLoaded('l'));
    assertFalse(
        'module "m" should not be loaded (4)', mm.isModuleLoaded('m'));

    clock.tick(5);
    assertTrue('module "l" should be loaded', mm.isModuleLoaded('l'));
    assertFalse(
        'module "m" should not be loaded (5)', mm.isModuleLoaded('m'));

    clock.tick(5);
    assertTrue('module "m" should be loaded', mm.isModuleLoaded('m'));
  }

  function testLoadingDepsInBatchMode() {
    var mm = getModuleManager({
      'e': [],
      'f': [],
      'g': ['f'],
      'h': ['e','f','g']});
    mm.setLoader(createSuccessfulBatchLoader(mm));
    mm.setBatchModeEnabled(true);

    mm.preloadModule('f');
    clock.tick(5);
    assertTrue('module "f" should be loaded', mm.isModuleLoaded('f'));
    assertFalse(
        'module "e" should not be loaded (1)', mm.isModuleLoaded('e'));
    assertFalse(
        'module "g" should not be loaded (1)', mm.isModuleLoaded('g'));
    assertFalse(
        'module "h" should not be loaded (1)', mm.isModuleLoaded('h'));

    // When loading a module in batch mode, its not-yet-loaded dependencies
    // should be requested at the same time, and in dependency order.
    mm.preloadModule('h');
    clock.tick(5);
    assertTrue('module "e" should be loaded', mm.isModuleLoaded('e'));
    assertFalse(
        'module "g" should not be loaded (2)', mm.isModuleLoaded('g'));
    assertFalse(
        'module "h" should not be loaded (2)', mm.isModuleLoaded('h'));
    clock.tick(2);
    assertTrue(
        'module "g" should be loaded', mm.isModuleLoaded('g'));
    assertFalse(
        'module "h" should not be loaded (3)', mm.isModuleLoaded('h'));
    clock.tick(2);
    assertTrue(
        'module "h" should be loaded', mm.isModuleLoaded('h'));
  }

  /**
   * Test unauthorized errors while loading modules.
   */
  function testUnauthorizedLoading() {
    var mm = getModuleManager({
      'm': [],
      'n': [],
      'o': ['n']});
    mm.setLoader(createUnsuccessfulLoader(mm, 401));

    // Callback checks for an unauthorized error
    var firedLoadFailed = false;
    mm.registerCallback(goog.module.ModuleManager.CallbackType.ERROR,
        function(callbackType, id, cause) {
          assertEquals('Failure cause was not as expected',
                       goog.module.ModuleManager.FailureType.UNAUTHORIZED,
                       cause);
          firedLoadFailed = true;
        });
    mm.execOnLoad('o', function() {});
    assertTrue('module "o" should be loading', mm.isModuleLoading('o'));
    assertTrue('module "n" should be loading', mm.isModuleLoading('n'));
    clock.tick(5);
    assertTrue(
        'should have called unauthorized module callback', firedLoadFailed);
    assertFalse(
        'module "o" should not be loaded', mm.isModuleLoaded('o'));
    assertFalse(
        'module "o" should not be loading', mm.isModuleLoading('o'));
    assertFalse(
        'module "n" should not be loaded', mm.isModuleLoaded('n'));
    assertFalse(
        'module "n" should not be loading', mm.isModuleLoading('n'));
  }

  /**
   * Test error loading modules which are retried.
   */
  function testErrorLoadingModule() {
    var mm = getModuleManager({
      'p': ['q'],
      'q': [],
      'r': ['q','p']});
    mm.setLoader(createUnsuccessfulLoader(mm, 500));

    mm.preloadModule('r');
    clock.tick(4);

    // A module request is now underway using the unsuccessful loader.
    // We substitute a successful loader for future module load requests.
    mm.setLoader(createSuccessfulNonBatchLoader(mm));
    clock.tick(1);
    assertFalse(
        'module "q" should not be loaded (1)', mm.isModuleLoaded('q'));
    assertFalse(
        'module "p" should not be loaded (1)', mm.isModuleLoaded('p'));
    assertFalse(
        'module "r" should not be loaded (1)', mm.isModuleLoaded('r'));

    // Failed loads are automatically retried.
    clock.tick(5);
    assertTrue('module "q" should be loaded', mm.isModuleLoaded('q'));
    assertFalse(
        'module "p" should not be loaded (2)', mm.isModuleLoaded('p'));
    assertFalse(
        'module "r" should not be loaded (2)', mm.isModuleLoaded('r'));
    clock.tick(5);
    assertTrue('module "p" should be loaded', mm.isModuleLoaded('p'));
    assertFalse(
        'module "r" should not be loaded (3)', mm.isModuleLoaded('r'));
    clock.tick(5);
    assertTrue(
        'module "r" should be loaded', mm.isModuleLoaded('r'));
  }

  /**
   * Test consecutive errors in loading modules.
   */
  function testConsecutiveErrors() {
    var mm = getModuleManager({'s': []});
    mm.setLoader(createUnsuccessfulLoader(mm, 500));

    // Register an error callback for consecutive failures.
    var firedLoadFailed = false;
    mm.registerCallback(goog.module.ModuleManager.CallbackType.ERROR,
        function(callbackType, id, cause) {
          assertEquals('Failure cause was not as expected',
              goog.module.ModuleManager.FailureType.CONSECUTIVE_FAILURES,
              cause);
          firedLoadFailed = true;
        });

    mm.preloadModule('s');
    assertFalse(
        'module "s" should not be loaded (0)', mm.isModuleLoaded('s'));

    // Fail twice.
    for (var i = 0; i < 2; i++) {
      clock.tick(5);
      assertFalse(
          'module "s" should not be loaded (1)', mm.isModuleLoaded('s'));
      assertFalse(
          'should not fire failed callback (1)', firedLoadFailed);
    }

    // Fail a third time and check that the callback is fired.
    clock.tick(5);
    assertFalse(
        'module "s" should not be loaded (2)', mm.isModuleLoaded('s'));
    assertTrue(
        'should have fired failed callback', firedLoadFailed);

    // Check that it doesn't attempt to load the module anymore after it has
    // failed.
    var triedLoad = false;
    mm.setLoader({
      loadModules: function(ids, moduleInfoMap, opt_successFn, opt_errFn) {
        triedLoad = true;
      }});

    // Also reset the failed callback flag and make sure it isn't called
    // again.
    firedLoadFailed = false;
    clock.tick(10);
    assertFalse(
        'module "s" should not be loaded (3)', mm.isModuleLoaded('s'));
    assertFalse('No more loads should have been tried', triedLoad);
    assertFalse('The load failed callback should be fired only once',
        firedLoadFailed);
  }

  /**
   * Test loading errors due to old code.
   */
  function testOldCodeGoneError() {
    var mm = getModuleManager({'s': []});
    mm.setLoader(createUnsuccessfulLoader(mm, 410));

    // Callback checks for an old code failure
    var firedLoadFailed = false;
    mm.registerCallback(goog.module.ModuleManager.CallbackType.ERROR,
        function(callbackType, id, cause) {
          assertEquals('Failure cause was not as expected',
              goog.module.ModuleManager.FailureType.OLD_CODE_GONE,
              cause);
          firedLoadFailed = true;
        });

    mm.preloadModule('s', 0);
    assertFalse(
        'module "s" should not be loaded (0)', mm.isModuleLoaded('s'));
    clock.tick(5);
    assertFalse(
        'module "s" should not be loaded (1)', mm.isModuleLoaded('s'));
    assertTrue(
        'should have called old code gone callback', firedLoadFailed);
  }

  /**
   * Test timeout.
   */
  function testTimeout() {
    var mm = getModuleManager({'s': []});
    mm.setLoader(createTimeoutLoader(mm));

    // Callback checks for timeout
    var firedTimeout = false;
    mm.registerCallback(goog.module.ModuleManager.CallbackType.ERROR,
        function(callbackType, id, cause) {
          assertEquals('Failure cause was not as expected',
              goog.module.ModuleManager.FailureType.TIMEOUT,
              cause);
          firedTimeout = true;
        });

    mm.preloadModule('s', 0);
    assertFalse(
        'module "s" should not be loaded (0)', mm.isModuleLoaded('s'));
    clock.tick(5);
    assertFalse(
        'module "s" should not be loaded (1)', mm.isModuleLoaded('s'));
    assertTrue(
        'should have called timeout callback', firedTimeout);
  }


  /**
   * Make sure ModuleInfo objects in moduleInfoMap_ get disposed.
   */
  function testDispose() {
    var mm = getModuleManager({'a': [], 'b': [], 'c': []});

    var moduleInfoA = mm.getModuleInfo('a');
    assertNotNull(moduleInfoA);
    var moduleInfoB = mm.getModuleInfo('b');
    assertNotNull(moduleInfoB);
    var moduleInfoC = mm.getModuleInfo('c');
    assertNotNull(moduleInfoC);

    mm.dispose();
    assertTrue(moduleInfoA.isDisposed());
    assertTrue(moduleInfoB.isDisposed());
    assertTrue(moduleInfoC.isDisposed());
  }

  function testDependencyOrderingWithSimpleDeps() {
    var mm = getModuleManager({
      'a': ['b', 'c'],
      'b': ['d'],
      'c': ['e', 'f'],
      'd': [],
      'e': [],
      'f': []
    });
    var ids = mm.getNotYetLoadedTransitiveDepIds_('a');
    assertDependencyOrder(ids, mm);
    assertArrayEquals(['d', 'e', 'f', 'b', 'c', 'a'], ids);
  }

  function testDependencyOrderingWithCommonDepsInDeps() {
    // Tests to make sure that if dependencies of the root are loaded before
    // their common dependencies.
    var mm = getModuleManager({
      'a': ['b', 'c'],
      'b': ['d'],
      'c': ['d'],
      'd': []
    });
    var ids = mm.getNotYetLoadedTransitiveDepIds_('a');
    assertDependencyOrder(ids, mm);
    assertArrayEquals(['d', 'b', 'c', 'a'], ids);
  }

  function testDependencyOrderingWithCommonDepsInRoot1() {
    // Tests the case where a dependency of the root depends on another
    // dependency of the root.  Irregardless of ordering in the root's
    // deps.
    var mm = getModuleManager({
      'a': ['b', 'c'],
      'b': ['c'],
      'c': []
    });
    var ids = mm.getNotYetLoadedTransitiveDepIds_('a');
    assertDependencyOrder(ids, mm);
    assertArrayEquals(['c', 'b', 'a'], ids);
  }

  function testDependencyOrderingWithCommonDepsInRoot2() {
    // Tests the case where a dependency of the root depends on another
    // dependency of the root.  Irregardless of ordering in the root's
    // deps.
    var mm = getModuleManager({
      'a': ['b', 'c'],
      'b': [],
      'c': ['b']
    });
    var ids = mm.getNotYetLoadedTransitiveDepIds_('a');
    assertDependencyOrder(ids, mm);
    assertArrayEquals(['b', 'c', 'a'], ids);
  }

  function testDependencyOrderingWithGmailExample() {
    // Real dependency graph taken from gmail.
    var mm = getModuleManager({
      's': ['dp', 'ml', 'md'],
      'dp': ['a'],
      'ml': ['ld', 'm'],
      'ld': ['a'],
      'm': ['ad', 'mh', 'n'],
      'md': ['mh', 'ld'],
      'a': [],
      'mh': [],
      'ad': [],
      'n': []
    });

    mm.setLoaded('a');
    mm.setLoaded('m');
    mm.setLoaded('n');
    mm.setLoaded('ad');
    mm.setLoaded('mh');

    var ids = mm.getNotYetLoadedTransitiveDepIds_('s');
    assertDependencyOrder(ids, mm);
    assertArrayEquals(['ld', 'dp', 'ml', 'md', 's'], ids);
  }

  function assertDependencyOrder(list, mm) {
    var seen = {};
    for (var i = 0; i < list.length; i++) {
      var id = list[i];
      seen[id] = true;
      var deps = mm.getModuleInfo(id).getDependencies();
      for (var j = 0; j < deps.length; j++) {
        var dep = deps[j];
        assertTrue('Unresolved dependency [' + dep + '] for [' + id + '].',
            seen[dep] || mm.getModuleInfo(dep).isLoaded());
      }
    }
  }

 function testRegisterInitializationCallback() {
   var initCalled = 0;
   var mm = getModuleManager({'a': [], 'b': [], 'c': []});
   mm.setLoader(createSuccessfulNonBatchLoaderWithRegisterInitCallback(mm,
       function() {
        ++initCalled;
       }));
   execOnLoad_(mm);
   // execOnLoad_ loads modules a and c
   assertTrue(initCalled == 2);
 }

  function createSuccessfulNonBatchLoaderWithRegisterInitCallback(
      moduleMgr, fn) {
    return {
      loadModules: function(ids, moduleInfoMap, opt_successFn, opt_errFn,
          opt_timeoutFn) {
        moduleMgr.beforeLoadModuleCode(ids[0]);
        moduleMgr.registerInitializationCallback(fn);
        setTimeout(function() {
          moduleMgr.setLoaded(ids[0]);
          moduleMgr.afterLoadModuleCode(ids[0]);
          if (opt_successFn) {
            opt_successFn();
          }
        }, 5);
      }};
  }

  function testSetModuleConstructor() {
    var initCalled = 0;
    var mm = getModuleManager({'a': [], 'b': [], 'c': []});
    var info = {
      'a': { ctor: AModule, count: 0 },
      'b': { ctor: BModule, count: 0 },
      'c': { ctor: CModule, count: 0 }
    };
    function AModule() {
      ++info['a'].count;
      goog.module.BaseModule.call(this);
    }
    goog.inherits(AModule, goog.module.BaseModule);
    function BModule() {
      ++info['b'].count;
      goog.module.BaseModule.call(this);
    }
    goog.inherits(BModule, goog.module.BaseModule);
    function CModule() {
      ++info['c'].count;
      goog.module.BaseModule.call(this);
    }
    goog.inherits(CModule, goog.module.BaseModule);

    mm.setLoader(createSuccessfulNonBatchLoaderWithConstructor(mm, info));
    execOnLoad_(mm);
    assertTrue(info['a'].count == 1);
    assertTrue(info['b'].count == 0);
    assertTrue(info['c'].count == 1);
    assertTrue(mm.getModuleInfo('a').getModule() instanceof AModule);
    assertTrue(mm.getModuleInfo('c').getModule() instanceof CModule);
  }

  /**
   * Tests that a call to load the loading module during module initialization
   * doesn't trigger a second load.
   */
  function testLoadWhenInitializing() {
    var mm = getModuleManager({'a': []});
    mm.setLoader(createSuccessfulNonBatchLoader(mm));

    var info = {
      'a': { ctor: AModule, count: 0 }
    };
    function AModule() {
      ++info['a'].count;
      goog.module.BaseModule.call(this);
    }
    goog.inherits(AModule, goog.module.BaseModule);
    AModule.prototype.initialize = function() {
      mm.load('a');
    };
    mm.setLoader(createSuccessfulNonBatchLoaderWithConstructor(mm, info));
    mm.preloadModule('a');
    clock.tick(5);
    assertEquals(info['a'].count, 1);
  }

  function testErrorInEarlyCallback() {
    var errback = goog.testing.recordFunction();
    var callback = goog.testing.recordFunction();
    var mm = getModuleManager({'a': [], 'b': ['a']});
    mm.getModuleInfo('a').registerEarlyCallback(goog.functions.error('error'));
    mm.getModuleInfo('a').registerCallback(callback);
    mm.getModuleInfo('a').registerErrback(errback);

    mm.setLoader(createSuccessfulNonBatchLoaderWithConstructor(
        mm, createModulesFor('a', 'b')));
    mm.preloadModule('b');
    clock.tick(5);

    assertEquals(1, callback.getCallCount());
    assertEquals(1, errback.getCallCount());
    assertEquals(goog.module.ModuleManager.FailureType.INIT_ERROR,
        errback.getLastCall().getArguments()[0]);
    assertTrue(mm.getModuleInfo('a').isLoaded());
    assertFalse(mm.getModuleInfo('b').isLoaded());

    clock.tick(5);
    assertTrue(mm.getModuleInfo('b').isLoaded());
  }

  function testErrorInNormalCallback() {
    var earlyCallback = goog.testing.recordFunction();
    var errback = goog.testing.recordFunction();
    var mm = getModuleManager({'a': [], 'b': ['a']});
    mm.getModuleInfo('a').registerEarlyCallback(earlyCallback);
    mm.getModuleInfo('a').registerEarlyCallback(goog.functions.error('error'));
    mm.getModuleInfo('a').registerErrback(errback);

    mm.setLoader(createSuccessfulNonBatchLoaderWithConstructor(
        mm, createModulesFor('a', 'b')));
    mm.preloadModule('b');
    clock.tick(10);

    assertEquals(1, errback.getCallCount());
    assertEquals(goog.module.ModuleManager.FailureType.INIT_ERROR,
        errback.getLastCall().getArguments()[0]);
    assertTrue(mm.getModuleInfo('a').isLoaded());
    assertTrue(mm.getModuleInfo('b').isLoaded());
  }

  function testErrorInErrback() {
    var mm = getModuleManager({'a': [], 'b': ['a']});
    mm.getModuleInfo('a').registerCallback(goog.functions.error('error1'));
    mm.getModuleInfo('a').registerErrback(goog.functions.error('error2'));

    mm.setLoader(createSuccessfulNonBatchLoaderWithConstructor(
        mm, createModulesFor('a', 'b')));
    mm.preloadModule('a');
    var e = assertThrows(function() {
      clock.tick(10);
    });
    assertContains('Module errback failure', e.message);
    if (!goog.userAgent.IE) {
      assertContains('error2', e.message);
    }

    assertTrue(mm.getModuleInfo('a').isLoaded());
  }

  function createModulesFor(var_args) {
    var result = {};
    for (var i = 0; i < arguments.length; i++) {
      var key = arguments[i];
      result[key] = {ctor: goog.module.BaseModule};
    }
    return result;
  }

  function createSuccessfulNonBatchLoaderWithConstructor(moduleMgr, info) {
    return {
      loadModules: function(ids, moduleInfoMap, opt_successFn, opt_errFn,
          opt_timeoutFn) {
        setTimeout(function() {
          moduleMgr.beforeLoadModuleCode(ids[0]);
          moduleMgr.setModuleConstructor(info[ids[0]].ctor);
          moduleMgr.setLoaded(ids[0]);
          moduleMgr.afterLoadModuleCode(ids[0]);
          if (opt_successFn) {
            opt_successFn();
          }
        }, 5);
      }};
  }

  function testInitCallbackInBaseModule() {
    var mm = new goog.module.ModuleManager();
    var called = false;
    var context;
    mm.registerInitializationCallback(function(mcontext) {
      called = true;
      context = mcontext;
    });
    mm.setAllModuleInfo({'a': [], 'b': ['a']});
    assertTrue('Base initialization not called', called);
    assertNull('Context should still be null', context);

    var mm = new goog.module.ModuleManager();
    called = false;
    mm.registerInitializationCallback(function(mcontext) {
      called = true;
      context = mcontext;
    });
    var appContext = {};
    mm.setModuleContext(appContext);
    assertTrue('Base initialization not called after setModuleContext', called);
    assertEquals('Did not receive module context', appContext, context);
  }

  function testSetAllModuleInfoString() {
    var info = 'base/one:0/two:0/three:0,1,2/four:0,3/five:';
    var mm = new goog.module.ModuleManager();
    mm.setAllModuleInfoString(info);

    assertNotNull('Base should exist', mm.getModuleInfo('base'));
    assertNotNull('One should exist', mm.getModuleInfo('one'));
    assertNotNull('Two should exist', mm.getModuleInfo('two'));
    assertNotNull('Three should exist', mm.getModuleInfo('three'));
    assertNotNull('Four should exist', mm.getModuleInfo('four'));
    assertNotNull('Five should exist', mm.getModuleInfo('five'));

    assertArrayEquals(['base', 'one', 'two'],
        mm.getModuleInfo('three').getDependencies());
    assertArrayEquals(['base', 'three'],
        mm.getModuleInfo('four').getDependencies());
    assertArrayEquals([],
        mm.getModuleInfo('five').getDependencies());
  }

  function testSetAllModuleInfoStringWithEmptyString() {
    var mm = new goog.module.ModuleManager();
    var called = false;
    var context;
    mm.registerInitializationCallback(function(mcontext) {
      called = true;
      context = mcontext;
    });
    mm.setAllModuleInfoString('');
    assertTrue('Initialization not called', called);
  }
">n/a</td></tr>
<tr><td>html5history_test.html</td><td>Success</td><td> 8 passed, 0 failed.</td><td title="

  goog.require('goog.history.Html5History');
  goog.require('goog.testing.MockControl');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.mockmatchers');



  var mockControl;
  var mockWindow;

  var html5History;

  function setUp() {
    mockControl = new goog.testing.MockControl();

    mockWindow = {
      location: {}
    };
    mockWindow.attachEvent = mockControl.createFunctionMock();
    mockWindow.attachEvent(
        goog.testing.mockmatchers.ignoreArgument,
        goog.testing.mockmatchers.ignoreArgument).$anyTimes();
    var mockHistoryIsSupportedMethod = mockControl.createMethodMock(
        goog.history.Html5History, 'isSupported');
    mockHistoryIsSupportedMethod(mockWindow).$returns(true).$anyTimes();
  }

  function tearDown() {
    if (html5History) {
      html5History.dispose();
      html5History = null;
    }
    mockControl.$tearDown();
  }

  function testGetTokenWithoutUsingFragment() {
    mockWindow.location.pathname = '/test/something';

    mockControl.$replayAll();
    html5History = new goog.history.Html5History(mockWindow);
    html5History.setUseFragment(false);

    assertEquals('test/something', html5History.getToken());
    mockControl.$verifyAll();
  }

  function testGetTokenWithoutUsingFragmentWithCustomPathPrefix() {
    mockWindow.location.pathname = '/test/something';

    mockControl.$replayAll();
    html5History = new goog.history.Html5History(mockWindow);
    html5History.setUseFragment(false);
    html5History.setPathPrefix('/test/');

    assertEquals('something', html5History.getToken());
    mockControl.$verifyAll();
  }

  function testGetTokenWithoutUsingFragmentWithCustomTransformer() {
    mockWindow.location.pathname = '/test/something';
    var mockTransformer = mockControl.createLooseMock(
        goog.history.Html5History.TokenTransformer);
    mockTransformer.retrieveToken('/', mockWindow.location).$returns('abc/1');

    mockControl.$replayAll();
    html5History = new goog.history.Html5History(mockWindow, mockTransformer);
    html5History.setUseFragment(false);

    assertEquals('abc/1', html5History.getToken());
    mockControl.$verifyAll();
  }

  function testGetTokenWithoutUsingFragmentWithCustomTransformerAndPrefix() {
    mockWindow.location.pathname = '/test/something';
    var mockTransformer = mockControl.createLooseMock(
        goog.history.Html5History.TokenTransformer);
    mockTransformer.retrieveToken('/test/', mockWindow.location).
        $returns('abc/1');

    mockControl.$replayAll();
    html5History = new goog.history.Html5History(mockWindow, mockTransformer);
    html5History.setUseFragment(false);
    html5History.setPathPrefix('/test/');

    assertEquals('abc/1', html5History.getToken());
    mockControl.$verifyAll();
  }

  function testGetUrlWithoutUsingFragment() {
    mockWindow.location.search = '?q=something';

    mockControl.$replayAll();
    html5History = new goog.history.Html5History(mockWindow);
    html5History.setUseFragment(false);

    assertEquals('/some/token?q=something', html5History.getUrl_('some/token'));
    mockControl.$verifyAll();
  }

  function testGetUrlWithoutUsingFragmentWithCustomPathPrefix() {
    mockWindow.location.search = '?q=something';

    mockControl.$replayAll();
    html5History = new goog.history.Html5History(mockWindow);
    html5History.setUseFragment(false);
    html5History.setPathPrefix('/test/');

    assertEquals('/test/some/token?q=something',
                 html5History.getUrl_('some/token'));
    mockControl.$verifyAll();
  }

  function testGetUrlWithoutUsingFragmentWithCustomTransformer() {
    mockWindow.location.search = '?q=something';
    var mockTransformer = mockControl.createLooseMock(
        goog.history.Html5History.TokenTransformer);
    mockTransformer.createUrl('some/token', '/', mockWindow.location).
        $returns('/something/else/?different');

    mockControl.$replayAll();
    html5History = new goog.history.Html5History(mockWindow, mockTransformer);
    html5History.setUseFragment(false);

    assertEquals('/something/else/?different',
                 html5History.getUrl_('some/token'));
    mockControl.$verifyAll();
  }

  function testGetUrlWithoutUsingFragmentWithCustomTransformerAndPrefix() {
    mockWindow.location.search = '?q=something';
    var mockTransformer = mockControl.createLooseMock(
        goog.history.Html5History.TokenTransformer);
    mockTransformer.createUrl('some/token', '/test/', mockWindow.location).
        $returns('/something/else/?different');

    mockControl.$replayAll();
    html5History = new goog.history.Html5History(mockWindow, mockTransformer);
    html5History.setUseFragment(false);
    html5History.setPathPrefix('/test/');

    assertEquals('/something/else/?different',
                 html5History.getUrl_('some/token'));
    mockControl.$verifyAll();
  }

">n/a</td></tr>
<tr><td>anchoredviewportposition_test.html</td><td>Fail</td><td> 0 passed, 5 failed.</td><td title="

goog.require('goog.dom');
goog.require('goog.positioning.AnchoredViewportPosition');
goog.require('goog.style');
goog.require('goog.testing.jsunit');


var frame, doc, dom, viewportSize, anchor, popup;
var corner = goog.positioning.Corner;

function setUp() {
  frame = document.getElementById('frame1');
  doc = goog.dom.getFrameContentDocument(frame);
  dom = goog.dom.getDomHelper(doc);
  viewportSize = dom.getViewportSize();
  anchor = dom.getElement('anchor');
  popup = dom.getElement('popup');
  goog.style.setSize(popup, 20, 20);
}

// The frame has enough space at the bottom of the anchor.
function testRepositionBottom() {
  var avp = new goog.positioning.AnchoredViewportPosition(
      anchor, corner.BOTTOM_LEFT, false);
  goog.style.setSize(anchor, 100, 100);
  goog.style.setPosition(anchor, 0, 0);
  assertTrue(viewportSize.height >= 100 + 20);

  avp.reposition(popup, corner.TOP_LEFT);
  var anchorRect = goog.style.getBounds(anchor);
  assertEquals(anchorRect.top + anchorRect.height,
               goog.style.getPageOffset(popup).y);
}

// No enough space at the bottom, but at the top.
function testRepositionTop() {
  var avp = new goog.positioning.AnchoredViewportPosition(
      anchor, corner.BOTTOM_LEFT, false);
  var newTop = viewportSize.height - 100;
  goog.style.setSize(anchor, 100, 100);
  goog.style.setPosition(anchor, 50, newTop);
  assertTrue(newTop >= 20);

  avp.reposition(popup, corner.TOP_LEFT);
  anchorRect = goog.style.getBounds(anchor);
  var popupRect = goog.style.getBounds(popup);
  assertEquals(anchorRect.top, popupRect.top + popupRect.height);
}

// Not enough space either at the bottom or right but there is enough space at
// top left.
function testRepositionBottomRight() {
  var avp = new goog.positioning.AnchoredViewportPosition(
      anchor, corner.BOTTOM_RIGHT, false);
  goog.style.setSize(anchor, 100, 100);
  goog.style.setPosition(anchor, viewportSize.width - 110,
      viewportSize.height - 110);

  avp.reposition(popup, corner.TOP_LEFT);
  anchorRect = goog.style.getBounds(anchor);
  var popupRect = goog.style.getBounds(popup);
  assertEquals(anchorRect.top, popupRect.top + popupRect.height);
  assertEquals(anchorRect.left, popupRect.left + popupRect.width);
}

// Enough space at neither the bottom nor the top.  Adjustment flag is false.
function testRepositionNoSpaceWithoutAdjustment() {
  var avp = new goog.positioning.AnchoredViewportPosition(
      anchor, corner.BOTTOM_LEFT, false);
  goog.style.setPosition(anchor, 50, 10);
  goog.style.setSize(anchor, 100, viewportSize.height - 20);

  avp.reposition(popup, corner.TOP_LEFT);
  anchorRect = goog.style.getBounds(anchor);
  popupRect = goog.style.getBounds(popup);
  assertEquals(anchorRect.top + anchorRect.height, popupRect.top);
  assertTrue(popupRect.top + popupRect.height > viewportSize.height);
}

// Enough space at neither the bottom nor the top.  Adjustment flag is true.
function testRepositionNoSpaceWithAdjustment() {
  var avp = new goog.positioning.AnchoredViewportPosition(
      anchor, corner.BOTTOM_LEFT, true);
  goog.style.setPosition(anchor, 50, 10);
  goog.style.setSize(anchor, 100, viewportSize.height - 20);

  avp.reposition(popup, corner.TOP_LEFT);
  anchorRect = goog.style.getBounds(anchor);
  popupRect = goog.style.getBounds(popup);
  assertTrue(anchorRect.top + anchorRect.height > popupRect.top);
  assertEquals(viewportSize.height, popupRect.top + popupRect.height);
}

">5 of 5 tests run in 6ms.<br />0 passed, 5 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testRepositionBottom<br />Cannot read property 'document' of undefined<br />ERROR in testRepositionBottomRight<br />Cannot read property 'document' of undefined<br />ERROR in testRepositionNoSpaceWithAdjustment<br />Cannot read property 'document' of undefined<br />ERROR in testRepositionNoSpaceWithoutAdjustment<br />Cannot read property 'document' of undefined<br />ERROR in testRepositionTop<br />Cannot read property 'document' of undefined<br /></td></tr>
<tr><td>positioning_test.html</td><td>Fail</td><td> undefined</td><td title="

goog.require('goog.math.Box');
goog.require('goog.math.Coordinate');
goog.require('goog.math.Rect');
goog.require('goog.style');
goog.require('goog.positioning');
goog.require('goog.testing.jsunit');
goog.require('goog.userAgent');



// Allow positions to be off by one in gecko as it reports scrolling
// offsets in steps of 2.
var ALLOWED_OFFSET = goog.userAgent.GECKO ? 1 : 0;

function setUpPage() {
  var viewportSize = goog.dom.getViewportSize();
  // Some tests need enough size viewport.
  if (viewportSize.width < 600 || viewportSize.height < 600) {
    window.moveTo(0, 0);
    window.resizeTo(640, 640);
  }
}

function setUp() {
  window.scrollTo(0, 0);
}

/**
 * This is used to round pixel values on FF3 Mac.
 */
function assertRoundedEquals(a, b, c) {
  function round(x) {
    return goog.userAgent.GECKO && (goog.userAgent.MAC || goog.userAgent.X11) &&
        goog.userAgent.isVersion('1.9') ? Math.round(x) : x;
  }
  if (arguments.length == 3) {
    assertRoughlyEquals(a, round(b), round(c), ALLOWED_OFFSET);
  } else {
    assertRoughlyEquals(round(a), round(b), ALLOWED_OFFSET);
  }
}

function testPositionAtAnchorLeftToRight() {
  var anchor = document.getElementById('anchor1');
  var popup = document.getElementById('popup1');
  var corner = goog.positioning.Corner;

  // Anchor top left to top left.
  goog.positioning.positionAtAnchor(anchor, corner.TOP_LEFT,
                                    popup, corner.TOP_LEFT);
  var anchorRect = goog.style.getBounds(anchor);
  var popupRect = goog.style.getBounds(popup);
  assertRoundedEquals('Left edge of popup should line up with left edge ' +
                      'of anchor.',
                      anchorRect.left,
                      popupRect.left);
  assertRoundedEquals('Popup should have the same y position as the anchor.',
                      anchorRect.top,
                      popupRect.top);

  // Anchor top left to bottom left.
  goog.positioning.positionAtAnchor(anchor, corner.BOTTOM_LEFT,
                                    popup, corner.TOP_LEFT);
  anchorRect = goog.style.getBounds(anchor);
  popupRect = goog.style.getBounds(popup);
  assertRoundedEquals('Left edge of popup should line up with left edge ' +
                      'of anchor.',
                      anchorRect.left,
                      popupRect.left);
  assertRoundedEquals('Popup should be positioned just below the anchor.',
                      anchorRect.top + anchorRect.height,
                      popupRect.top);

  // Anchor top left to top right.
  goog.positioning.positionAtAnchor(anchor, corner.TOP_RIGHT,
                                    popup, corner.TOP_LEFT);
  anchorRect = goog.style.getBounds(anchor);
  popupRect = goog.style.getBounds(popup);
  assertRoundedEquals('Popup should be positioned just right of the anchor.',
                      anchorRect.left + anchorRect.width,
                      popupRect.left);
  assertRoundedEquals('Popup should have the same y position as the anchor.',
                      anchorRect.top,
                      popupRect.top);

  // Anchor top right to bottom right.
  goog.positioning.positionAtAnchor(anchor, corner.BOTTOM_RIGHT,
                                    popup, corner.TOP_RIGHT);
  anchorRect = goog.style.getBounds(anchor);
  popupRect = goog.style.getBounds(popup);
  assertRoundedEquals('Right edge of popup should line up with right edge ' +
                      'of anchor.',
                      anchorRect.left + anchorRect.width,
                      popupRect.left + popupRect.width);
  assertRoundedEquals('Popup should be positioned just below the anchor.',
                      anchorRect.top + anchorRect.height,
                      popupRect.top);

  // Anchor top start to bottom start.
  goog.positioning.positionAtAnchor(anchor, corner.BOTTOM_START,
                                    popup, corner.TOP_START);
  anchorRect = goog.style.getBounds(anchor);
  popupRect = goog.style.getBounds(popup);
  assertRoundedEquals('Left edge of popup should line up with left edge ' +
                      'of anchor.',
                      anchorRect.left,
                      popupRect.left);
  assertRoundedEquals('Popup should be positioned just below the anchor.',
                      anchorRect.top + anchorRect.height,
                      popupRect.top);
}


function testPositionAtAnchorWithOffset() {
  var anchor = document.getElementById('anchor1');
  var popup = document.getElementById('popup1');
  var corner = goog.positioning.Corner;

  // Anchor top left to top left with an offset moving the popup away from the
  // anchor.
  goog.positioning.positionAtAnchor(anchor, corner.TOP_LEFT,
                                    popup, corner.TOP_LEFT,
                                    new goog.math.Coordinate(-15, -20));
  var anchorRect = goog.style.getBounds(anchor);
  var popupRect = goog.style.getBounds(popup);
  assertRoundedEquals('Left edge of popup should be fifteen pixels from ' +
                      'anchor.',
                      anchorRect.left,
                      popupRect.left + 15);
  assertRoundedEquals('Top edge of popup should be twenty pixels from anchor.',
                      anchorRect.top,
                      popupRect.top + 20);

  // Anchor top left to top left with an offset moving the popup towards the
  // anchor.
  goog.positioning.positionAtAnchor(anchor, corner.TOP_LEFT,
                                    popup, corner.TOP_LEFT,
                                    new goog.math.Coordinate(3, 1));
  anchorRect = goog.style.getBounds(anchor);
  popupRect = goog.style.getBounds(popup);
  assertRoundedEquals('Left edge of popup should be three pixels right of ' +
                      'the anchor\'s left edge',
                      anchorRect.left,
                      popupRect.left - 3);
  assertRoundedEquals('Top edge of popup should be one pixel below of the ' +
                      'anchor\'s top edge',
                      anchorRect.top,
                      popupRect.top - 1);
}


function testPositionAtAnchorOverflowLeftEdgeRightToLeft() {
  var anchor = document.getElementById('anchor5');
  var popup = document.getElementById('popup5');
  var corner = goog.positioning.Corner;
  var overflow = goog.positioning.Overflow;

  var status = goog.positioning.positionAtAnchor(anchor, corner.TOP_LEFT,
                                                 popup, corner.TOP_RIGHT,
                                                 undefined, undefined,
                                                 overflow.FAIL_X);
  assertFalse('Positioning operation should have failed.',
              (status & goog.positioning.OverflowStatus.FAILED) == 0);

  // Change overflow strategy to ADJUST.
  status = goog.positioning.positionAtAnchor(anchor, corner.TOP_LEFT,
                                             popup, corner.TOP_RIGHT,
                                             undefined, undefined,
                                             overflow.ADJUST_X);
  assertTrue('Positioning operation should have been successful.',
             (status & goog.positioning.OverflowStatus.FAILED) == 0);
  assertTrue('Positioning operation should have been adjusted.',
             (status & goog.positioning.OverflowStatus.ADJUSTED_X) != 0);
  var anchorRect = goog.style.getBounds(anchor);
  var popupRect = goog.style.getBounds(popup);
  var parentRect = goog.style.getBounds(anchor.parentNode);
  assertTrue('Position should have been adjusted so that the left edge of ' +
             'the popup is left of the anchor but still within the bounding ' +
             'box of the parent container.',
      anchorRect.left <= popupRect.left <= parentRect.left);

}


function testPositionAtAnchorWithMargin() {
  var anchor = document.getElementById('anchor1');
  var popup = document.getElementById('popup1');
  var corner = goog.positioning.Corner;

  // Anchor top left to top left.
  goog.positioning.positionAtAnchor(anchor, corner.TOP_LEFT,
                                    popup, corner.TOP_LEFT, undefined,
                                    new goog.math.Box(1, 2, 3, 4));
  var anchorRect = goog.style.getBounds(anchor);
  var popupRect = goog.style.getBounds(popup);
  assertRoundedEquals('Left edge of popup should be four pixels from anchor.',
                      anchorRect.left,
                      popupRect.left - 4);
  assertRoundedEquals('Top edge of popup should be one pixels from anchor.',
                      anchorRect.top,
                      popupRect.top - 1);

  // Anchor top right to bottom right.
  goog.positioning.positionAtAnchor(anchor, corner.BOTTOM_RIGHT,
                                    popup, corner.TOP_RIGHT, undefined,
                                    new goog.math.Box(1, 2, 3, 4));
  anchorRect = goog.style.getBounds(anchor);
  popupRect = goog.style.getBounds(popup);
  assertRoundedEquals('Right edge of popup should line up with right edge ' +
                      'of anchor.',
                      anchorRect.left + anchorRect.width,
                      popupRect.left + popupRect.width + 2);
  assertRoundedEquals('Popup should be positioned just below the anchor.',
                      anchorRect.top + anchorRect.height,
                      popupRect.top - 1);

}


function testPositionAtAnchorRightToLeft() {
  if (goog.userAgent.IE && goog.userAgent.isVersion('6')) {
    // These tests fails with IE6.
    // TODO(user): Investigate the reason.
    return;
  }

  var anchor = document.getElementById('anchor2');
  var popup = document.getElementById('popup2');
  var corner = goog.positioning.Corner;

  // Anchor top left to top left.
  goog.positioning.positionAtAnchor(anchor, corner.TOP_LEFT,
                                    popup, corner.TOP_LEFT);
  var anchorRect = goog.style.getBounds(anchor);
  var popupRect = goog.style.getBounds(popup);

  assertRoundedEquals('Left edge of popup should line up with left edge ' +
                      'of anchor.',
                      anchorRect.left,
                      popupRect.left);
  assertRoundedEquals('Popup should have the same y position as the anchor.',
                      anchorRect.top,
                      popupRect.top);

  // Anchor top start to bottom start.
  goog.positioning.positionAtAnchor(anchor, corner.BOTTOM_START,
                                    popup, corner.TOP_START);
  anchorRect = goog.style.getBounds(anchor);
  popupRect = goog.style.getBounds(popup);
  assertRoundedEquals('Right edge of popup should line up with right edge ' +
                      'of anchor.',
                      anchorRect.left + anchorRect.width,
                      popupRect.left + popupRect.width);
  assertRoundedEquals('Popup should be positioned just below the anchor.',
                      anchorRect.top + anchorRect.height,
                      popupRect.top);
}


function testPositionAtAnchorBodyViewport() {
  var anchor = document.getElementById('anchor1');
  var popup = document.getElementById('popup3');
  var corner = goog.positioning.Corner;

  // Anchor top left to top left.
  goog.positioning.positionAtAnchor(anchor, corner.TOP_LEFT,
                                    popup, corner.TOP_LEFT);
  var anchorRect = goog.style.getBounds(anchor);
  var popupRect = goog.style.getBounds(popup);
  assertEquals('Left edge of popup should line up with left edge of anchor.',
               anchorRect.left,
               popupRect.left);
  assertEquals('Popup should have the same y position as the anchor.',
               anchorRect.top,
               popupRect.top);

  // Anchor top start to bottom right.
  goog.positioning.positionAtAnchor(anchor, corner.BOTTOM_RIGHT,
                                    popup, corner.TOP_RIGHT);
  anchorRect = goog.style.getBounds(anchor);
  popupRect = goog.style.getBounds(popup);
  assertEquals('Right edge of popup should line up with right edge of anchor.',
               anchorRect.left + anchorRect.width,
               popupRect.left + popupRect.width);
  assertEquals('Popup should be positioned just below the anchor.',
               anchorRect.top + anchorRect.height,
               popupRect.top);
}


function testPositionAtAnchorOutsideViewport() {
  var anchor = document.getElementById('anchor4');
  var popup = document.getElementById('popup1');
  var corner = goog.positioning.Corner;
  var overflow = goog.positioning.Overflow;

  var status = goog.positioning.positionAtAnchor(anchor, corner.TOP_LEFT,
                                                 popup, corner.TOP_RIGHT);
  var anchorRect = goog.style.getBounds(anchor);
  var popupRect = goog.style.getBounds(popup);
  assertTrue('Positioning operation should have been successful.',
             (status & goog.positioning.OverflowStatus.FAILED) == 0);
  assertTrue('X position should not have been adjusted.',
             (status & goog.positioning.OverflowStatus.ADJUSTED_X) == 0);
  assertTrue('Y position should not have been adjusted.',
             (status & goog.positioning.OverflowStatus.ADJUSTED_Y) == 0);

  assertEquals('Right edge of popup should line up with left edge of anchor.',
               anchorRect.left,
               popupRect.left + popupRect.width);

  // Change overflow strategy to fail.
  status = goog.positioning.positionAtAnchor(anchor, corner.BOTTOM_RIGHT,
                                             popup, corner.TOP_RIGHT,
                                             undefined, undefined,
                                             overflow.FAIL_X);
  assertFalse('Positioning operation should have failed.',
              (status & goog.positioning.OverflowStatus.FAILED) == 0);

  // Change overflow strategy to adjust.
  status = goog.positioning.positionAtAnchor(anchor, corner.BOTTOM_RIGHT,
                                             popup, corner.TOP_RIGHT,
                                             undefined, undefined,
                                             overflow.ADJUST_X);
  anchorRect = goog.style.getBounds(anchor);
  popupRect = goog.style.getBounds(popup);
  assertTrue('Positioning operation should have been successful.',
             (status & goog.positioning.OverflowStatus.FAILED) == 0);
  assertFalse('X position should have been adjusted.',
              (status & goog.positioning.OverflowStatus.ADJUSTED_X) == 0);
  assertTrue('Y position should not have been adjusted.',
             (status & goog.positioning.OverflowStatus.ADJUSTED_Y) == 0);
  assertEquals('Left edge of popup should line up with left edge of viewport.',
               goog.style.getPageOffset(popup.parentNode).x,
               popupRect.left);
  assertEquals('Popup should be positioned just below the anchor.',
               anchorRect.top + anchorRect.height,
               popupRect.top);
}


function testAdjustForViewportFailIgnore() {
  var f = goog.positioning.adjustForViewport;
  var viewport = new goog.math.Box(100, 200, 200, 100);
  var overflow = goog.positioning.Overflow.IGNORE;

  var pos = new goog.math.Coordinate(150, 150);
  var size = new goog.math.Size(50, 50);
  assertEquals('Viewport overflow should be ignored.',
               goog.positioning.OverflowStatus.NONE,
               f(pos, size, viewport, overflow));

  pos = new goog.math.Coordinate(150, 150);
  size = new goog.math.Size(100, 50);
  assertEquals('Viewport overflow should be ignored.',
               goog.positioning.OverflowStatus.NONE,
               f(pos, size, viewport, overflow));

  pos = new goog.math.Coordinate(50, 50);
  size = new goog.math.Size(50, 50);
  assertEquals('Viewport overflow should be ignored.',
               goog.positioning.OverflowStatus.NONE,
               f(pos, size, viewport, overflow));
}


function testAdjustForViewportFailXY() {
  var f = goog.positioning.adjustForViewport;
  var viewport = new goog.math.Box(100, 200, 200, 100);
  var overflow = goog.positioning.Overflow.FAIL_X |
                 goog.positioning.Overflow.FAIL_Y;

  var pos = new goog.math.Coordinate(150, 150);
  var size = new goog.math.Size(50, 50);
  assertEquals('Element should not overflow viewport.',
               goog.positioning.OverflowStatus.NONE,
               f(pos, size, viewport, overflow));

  pos = new goog.math.Coordinate(150, 150);
  size = new goog.math.Size(100, 50);
  assertEquals('Element should overflow the right edge of viewport.',
               goog.positioning.OverflowStatus.FAILED_RIGHT,
               f(pos, size, viewport, overflow));

  pos = new goog.math.Coordinate(150, 150);
  size = new goog.math.Size(50, 100);
  assertEquals('Element should overflow the bottom edge of viewport.',
               goog.positioning.OverflowStatus.FAILED_BOTTOM,
               f(pos, size, viewport, overflow));

  pos = new goog.math.Coordinate(50, 150);
  size = new goog.math.Size(50, 50);
  assertEquals('Element should overflow the left edge of viewport.',
               goog.positioning.OverflowStatus.FAILED_LEFT,
               f(pos, size, viewport, overflow));

  pos = new goog.math.Coordinate(150, 50);
  size = new goog.math.Size(50, 50);
  assertEquals('Element should overflow the top edge of viewport.',
               goog.positioning.OverflowStatus.FAILED_TOP,
               f(pos, size, viewport, overflow));

  pos = new goog.math.Coordinate(50, 50);
  size = new goog.math.Size(50, 50);
  assertEquals('Element should overflow the left & top edges of viewport.',
               goog.positioning.OverflowStatus.FAILED_LEFT |
               goog.positioning.OverflowStatus.FAILED_TOP,
               f(pos, size, viewport, overflow));
}


function testAdjustForViewportAdjustXFailY() {
  var f = goog.positioning.adjustForViewport;
  var viewport = new goog.math.Box(100, 200, 200, 100);
  var overflow = goog.positioning.Overflow.ADJUST_X |
                 goog.positioning.Overflow.FAIL_Y;

  var pos = new goog.math.Coordinate(150, 150);
  var size = new goog.math.Size(50, 50);
  assertEquals('Element should not overflow viewport.',
               goog.positioning.OverflowStatus.NONE,
               f(pos, size, viewport, overflow));
  assertEquals('X Position should not have been changed.', 150, pos.x);
  assertEquals('Y Position should not have been changed.', 150, pos.y);

  pos = new goog.math.Coordinate(150, 150);
  size = new goog.math.Size(100, 50);
  assertEquals('Element position should be adjusted not to overflow right ' +
               'edge of viewport.',
               goog.positioning.OverflowStatus.ADJUSTED_X,
               f(pos, size, viewport, overflow));
  assertEquals('X Position should be adjusted to 100.', 100, pos.x);
  assertEquals('Y Position should not have been changed.', 150, pos.y);

  pos = new goog.math.Coordinate(50, 150);
  size = new goog.math.Size(100, 50);
  assertEquals('Element position should be adjusted not to overflow left ' +
               'edge of viewport.',
               goog.positioning.OverflowStatus.ADJUSTED_X,
               f(pos, size, viewport, overflow));
  assertEquals('X Position should be adjusted to 100.', 100, pos.x);
  assertEquals('Y Position should not have been changed.', 150, pos.y);


  pos = new goog.math.Coordinate(50, 50);
  size = new goog.math.Size(100, 50);
  assertEquals('Element position should be adjusted not to overflow left ' +
               'edge of viewport, should overflow bottom edge.',
               goog.positioning.OverflowStatus.ADJUSTED_X |
               goog.positioning.OverflowStatus.FAILED_TOP,
               f(pos, size, viewport, overflow));
  assertEquals('X Position should be adjusted to 100.', 100, pos.x);
  assertEquals('Y Position should not have been changed.', 50, pos.y);
}


function testAdjustForViewportResizeHeight() {
  var f = goog.positioning.adjustForViewport;
  var viewport = new goog.math.Box(0, 200, 200, 0);
  var overflow = goog.positioning.Overflow.RESIZE_HEIGHT;

  var pos = new goog.math.Coordinate(150, 150);
  var size = new goog.math.Size(25, 100);
  assertEquals('Viewport height should be resized.',
               goog.positioning.OverflowStatus.HEIGHT_ADJUSTED,
               f(pos, size, viewport, overflow));
  assertEquals('Height should be resized to 50.',
               50, size.height);

  var pos = new goog.math.Coordinate(0, 0);
  var size = new goog.math.Size(50, 250);
  assertEquals('Viewport height should be resized.',
               goog.positioning.OverflowStatus.HEIGHT_ADJUSTED,
               f(pos, size, viewport, overflow));
  assertEquals('Height should be resized to 200.',
               200, size.height);

  pos = new goog.math.Coordinate(150, 150);
  size = new goog.math.Size(50, 50);
  assertEquals('No Viewport overflow.',
               goog.positioning.OverflowStatus.NONE,
               f(pos, size, viewport, overflow));
}


function testGetEffectiveCornerLeftToRight() {
  var f = goog.positioning.getEffectiveCorner;
  var el = document.getElementById('ltr');
  var corner = goog.positioning.Corner;

  assertEquals('TOP_LEFT should be unchanged for ltr.',
               corner.TOP_LEFT,
               f(el, corner.TOP_LEFT));
  assertEquals('TOP_RIGHT should be unchanged for ltr.',
               corner.TOP_RIGHT,
               f(el, corner.TOP_RIGHT));
  assertEquals('BOTTOM_LEFT should be unchanged for ltr.',
               corner.BOTTOM_LEFT,
               f(el, corner.BOTTOM_LEFT));
  assertEquals('BOTTOM_RIGHT should be unchanged for ltr.',
               corner.BOTTOM_RIGHT,
               f(el, corner.BOTTOM_RIGHT));

  assertEquals('TOP_START should be TOP_LEFT for ltr.',
               corner.TOP_LEFT,
               f(el, corner.TOP_START));
  assertEquals('TOP_END should be TOP_RIGHT for ltr.',
               corner.TOP_RIGHT,
               f(el, corner.TOP_END));
  assertEquals('BOTTOM_START should be BOTTOM_LEFT for ltr.',
               corner.BOTTOM_LEFT,
               f(el, corner.BOTTOM_START));
  assertEquals('BOTTOM_END should be BOTTOM_RIGHT for ltr.',
               corner.BOTTOM_RIGHT,
               f(el, corner.BOTTOM_END));
}


function testGetEffectiveCornerRightToLeft() {
  var f = goog.positioning.getEffectiveCorner;
  var el = document.getElementById('rtl');
  var corner = goog.positioning.Corner;

  assertEquals('TOP_LEFT should be unchanged for rtl.',
               corner.TOP_LEFT,
               f(el, corner.TOP_LEFT));
  assertEquals('TOP_RIGHT should be unchanged for rtl.',
               corner.TOP_RIGHT,
               f(el, corner.TOP_RIGHT));
  assertEquals('BOTTOM_LEFT should be unchanged for rtl.',
               corner.BOTTOM_LEFT,
               f(el, corner.BOTTOM_LEFT));
  assertEquals('BOTTOM_RIGHT should be unchanged for rtl.',
               corner.BOTTOM_RIGHT,
               f(el, corner.BOTTOM_RIGHT));

  assertEquals('TOP_START should be TOP_RIGHT for rtl.',
               corner.TOP_RIGHT,
               f(el, corner.TOP_START));
  assertEquals('TOP_END should be TOP_LEFT for rtl.',
               corner.TOP_LEFT,
               f(el, corner.TOP_END));
  assertEquals('BOTTOM_START should be BOTTOM_RIGHT for rtl.',
               corner.BOTTOM_RIGHT,
               f(el, corner.BOTTOM_START));
  assertEquals('BOTTOM_END should be BOTTOM_LEFT for rtl.',
               corner.BOTTOM_LEFT,
               f(el, corner.BOTTOM_END));
}


function testFlipCornerHorizontal() {
  var f = goog.positioning.flipCornerHorizontal;
  var corner = goog.positioning.Corner;

  assertEquals('TOP_LEFT should be flipped to TOP_RIGHT.',
               corner.TOP_RIGHT,
               f(corner.TOP_LEFT));
  assertEquals('TOP_RIGHT should be flipped to TOP_LEFT.',
               corner.TOP_LEFT,
               f(corner.TOP_RIGHT));
  assertEquals('BOTTOM_LEFT should be flipped to BOTTOM_RIGHT.',
               corner.BOTTOM_RIGHT,
               f(corner.BOTTOM_LEFT));
  assertEquals('BOTTOM_RIGHT should be flipped to BOTTOM_LEFT.',
               corner.BOTTOM_LEFT,
               f(corner.BOTTOM_RIGHT));

  assertEquals('TOP_START should be flipped to TOP_END.',
               corner.TOP_END,
               f(corner.TOP_START));
  assertEquals('TOP_END should be flipped to TOP_START.',
               corner.TOP_START,
               f(corner.TOP_END));
  assertEquals('BOTTOM_START should be flipped to BOTTOM_END.',
               corner.BOTTOM_END,
               f(corner.BOTTOM_START));
  assertEquals('BOTTOM_END should be flipped to BOTTOM_START.',
               corner.BOTTOM_START,
               f(corner.BOTTOM_END));
}


function testFlipCornerVertical() {
  var f = goog.positioning.flipCornerVertical;
  var corner = goog.positioning.Corner;

  assertEquals('TOP_LEFT should be flipped to BOTTOM_LEFT.',
               corner.BOTTOM_LEFT,
               f(corner.TOP_LEFT));
  assertEquals('TOP_RIGHT should be flipped to BOTTOM_RIGHT.',
               corner.BOTTOM_RIGHT,
               f(corner.TOP_RIGHT));
  assertEquals('BOTTOM_LEFT should be flipped to TOP_LEFT.',
               corner.TOP_LEFT,
               f(corner.BOTTOM_LEFT));
  assertEquals('BOTTOM_RIGHT should be flipped to TOP_RIGHT.',
               corner.TOP_RIGHT,
               f(corner.BOTTOM_RIGHT));

  assertEquals('TOP_START should be flipped to BOTTOM_START.',
               corner.BOTTOM_START,
               f(corner.TOP_START));
  assertEquals('TOP_END should be flipped to BOTTOM_END.',
               corner.BOTTOM_END,
               f(corner.TOP_END));
  assertEquals('BOTTOM_START should be flipped to TOP_START.',
               corner.TOP_START,
               f(corner.BOTTOM_START));
  assertEquals('BOTTOM_END should be flipped to TOP_END.',
               corner.TOP_END,
               f(corner.BOTTOM_END));
}


function testFlipCorner() {
  var f = goog.positioning.flipCorner;
  var corner = goog.positioning.Corner;

  assertEquals('TOP_LEFT should be flipped to BOTTOM_RIGHT.',
               corner.BOTTOM_RIGHT,
               f(corner.TOP_LEFT));
  assertEquals('TOP_RIGHT should be flipped to BOTTOM_LEFT.',
               corner.BOTTOM_LEFT,
               f(corner.TOP_RIGHT));
  assertEquals('BOTTOM_LEFT should be flipped to TOP_RIGHT.',
               corner.TOP_RIGHT,
               f(corner.BOTTOM_LEFT));
  assertEquals('BOTTOM_RIGHT should be flipped to TOP_LEFT.',
               corner.TOP_LEFT,
               f(corner.BOTTOM_RIGHT));

  assertEquals('TOP_START should be flipped to BOTTOM_END.',
               corner.BOTTOM_END,
               f(corner.TOP_START));
  assertEquals('TOP_END should be flipped to BOTTOM_START.',
               corner.BOTTOM_START,
               f(corner.TOP_END));
  assertEquals('BOTTOM_START should be flipped to TOP_END.',
               corner.TOP_END,
               f(corner.BOTTOM_START));
  assertEquals('BOTTOM_END should be flipped to TOP_START.',
               corner.TOP_START,
               f(corner.BOTTOM_END));
}

function testPositionAtAnchorFrameViewportStandard() {
  var corner = goog.positioning.Corner;
  var iframe = document.getElementById('iframe-standard');
  var iframeDoc = goog.dom.getFrameContentDocument(iframe);
  assertTrue(new goog.dom.DomHelper(iframeDoc).isCss1CompatMode());

  new goog.dom.DomHelper(iframeDoc).getDocumentScrollElement().scrollTop = 100;
  var anchor = iframeDoc.getElementById('anchor1');
  var popup = document.getElementById('popup6');

  var status = goog.positioning.positionAtAnchor(
      anchor, corner.TOP_RIGHT, popup, corner.BOTTOM_RIGHT);
  var iframeRect = goog.style.getBounds(iframe);
  var popupRect = goog.style.getBounds(popup);
  assertEquals('Status should not have any ADJUSTED and FAILED.',
               goog.positioning.OverflowStatus.NONE, status);
  assertRoundedEquals('Popup should be positioned just above the iframe, ' +
                      'not above the anchor element inside the iframe',
                      iframeRect.top,
                      popupRect.top + popupRect.height);
}

function testPositionAtAnchorFrameViewportQuirk() {
  var corner = goog.positioning.Corner;
  var iframe = document.getElementById('iframe-quirk');
  var iframeDoc = goog.dom.getFrameContentDocument(iframe);
  assertFalse(new goog.dom.DomHelper(iframeDoc).isCss1CompatMode());

  window.scrollTo(0, 100);
  new goog.dom.DomHelper(iframeDoc).getDocumentScrollElement().scrollTop = 100;
  var anchor = iframeDoc.getElementById('anchor1');
  var popup = document.getElementById('popup6');

  var status = goog.positioning.positionAtAnchor(
      anchor, corner.TOP_RIGHT, popup, corner.BOTTOM_RIGHT);
  var iframeRect = goog.style.getBounds(iframe);
  var popupRect = goog.style.getBounds(popup);
  assertEquals('Status should not have any ADJUSTED and FAILED.',
               goog.positioning.OverflowStatus.NONE, status);
  assertRoundedEquals('Popup should be positioned just above the iframe, ' +
                      'not above the anchor element inside the iframe',
                      iframeRect.top,
                      popupRect.top + popupRect.height);
}

function testPositionAtAnchorFrameViewportWithPopupInScroller() {
  var corner = goog.positioning.Corner;
  var iframe = document.getElementById('iframe-standard');
  var iframeDoc = goog.dom.getFrameContentDocument(iframe);

  new goog.dom.DomHelper(iframeDoc).getDocumentScrollElement().scrollTop = 100;
  var anchor = iframeDoc.getElementById('anchor1');
  var popup = document.getElementById('popup7');
  popup.offsetParent.scrollTop = 50;

  var status = goog.positioning.positionAtAnchor(
      anchor, corner.TOP_RIGHT, popup, corner.BOTTOM_RIGHT);
  var iframeRect = goog.style.getBounds(iframe);
  var popupRect = goog.style.getBounds(popup);
  assertEquals('Status should not have any ADJUSTED and FAILED.',
               goog.positioning.OverflowStatus.NONE, status);
  assertRoughlyEquals('Popup should be positioned just above the iframe, ' +
      'not above the anchor element inside the iframe',
      iframeRect.top,
      popupRect.top + popupRect.height,
      ALLOWED_OFFSET);
}

function testPositionAtAnchorNestedFrames() {
  var corner = goog.positioning.Corner;
  var outerIframe = document.getElementById('nested-outer');
  var outerDoc = goog.dom.getFrameContentDocument(outerIframe);
  var popup = outerDoc.getElementById('popup1');
  var innerIframe = outerDoc.getElementById('inner-frame');
  var innerDoc = goog.dom.getFrameContentDocument(innerIframe);
  var anchor = innerDoc.getElementById('anchor1');

  var status = goog.positioning.positionAtAnchor(
      anchor, corner.TOP_LEFT, popup, corner.BOTTOM_LEFT);
  assertEquals('Status should not have any ADJUSTED and FAILED.',
               goog.positioning.OverflowStatus.NONE, status);
  var innerIframeRect = goog.style.getBounds(innerIframe);
  var popupRect = goog.style.getBounds(popup);
  assertRoundedEquals('Top of frame should align with bottom of the popup',
                      innerIframeRect.top, popupRect.top + popupRect.height);

  // The anchor is scrolled up by 10px.
  // Popup position should be the same as above.
  goog.dom.getWindow(innerDoc).scrollTo(0, 10);
  status = goog.positioning.positionAtAnchor(
      anchor, corner.TOP_LEFT, popup, corner.BOTTOM_LEFT);
  assertEquals('Status should not have any ADJUSTED and FAILED.',
               goog.positioning.OverflowStatus.NONE, status);
  innerIframeRect = goog.style.getBounds(innerIframe);
  popupRect = goog.style.getBounds(popup);
  assertRoundedEquals('Top of frame should align with bottom of the popup',
                      innerIframeRect.top, popupRect.top + popupRect.height);
}

">TypeError: Cannot read property 'clientWidth' of undefined
    at Object.getViewportSize_ (dom/dom.js:452:31)
    at Object.getViewportSize (dom/dom.js:411:19)
    at [object Object].setUpPage (_tmpclosuretest.js:18:31)
    at [object Object].runTests (testing/testcase.js:487:8)
    at [object Object].execute (testing/testrunner.js:266:17)
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:429:6)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>viewportclientposition_test.html</td><td>Fail</td><td> 0 passed, 6 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.positioning.ViewportClientPosition');
    goog.require('goog.style');
    goog.require('goog.testing.jsunit');
    goog.require('goog.userAgent');
  

    var viewportSize, anchor, popup, dom, frameRect;
    var corner = goog.positioning.Corner;

    // Allow positions to be off by one in gecko as it reports scrolling
    // offsets in steps of 2.
    var ALLOWED_OFFSET = goog.userAgent.GECKO ? 1 : 0;


    function setUp() {
      var frame = document.getElementById('frame1');
      var doc = goog.dom.getFrameContentDocument(frame);

      dom = goog.dom.getDomHelper(doc);
      viewportSize = dom.getViewportSize();
      anchor = dom.getElement('anchor');
      popup = dom.getElement('popup');
      goog.style.setSize(popup, 20, 20);
      frameRect = goog.style.getVisibleRectForElement(doc.body);
    }


    function testPositionAtCoordinateTopLeft() {
      var pos = new goog.positioning.ViewportClientPosition(100, 100);
      pos.reposition(popup, corner.TOP_LEFT);

      var offset = goog.style.getPageOffset(popup);
      assertEquals('Left edge of popup should be at specified x coordinate.',
                   100,
                   offset.x);
      assertEquals('Top edge of popup should be at specified y coordinate.',
                   100,
                   offset.y);
    }


    function testPositionAtCoordinateBottomRight() {
      var pos = new goog.positioning.ViewportClientPosition(100, 100);
      pos.reposition(popup, corner.BOTTOM_RIGHT);

      var bounds = goog.style.getBounds(popup);
      assertEquals('Right edge of popup should be at specified x coordinate.',
                   100,
                   bounds.left + bounds.width);
      assertEquals('Bottom edge of popup should be at specified x coordinate.',
                   100,
                   bounds.top + bounds.height);
    }


    function testPositionAtCoordinateTopLeftWithScroll() {
      dom.getDocument().body.style.paddingTop = '300px';
      dom.getDocument().body.style.height = '3000px';
      dom.getDocumentScrollElement().scrollTop = 50;
      dom.getDocument().body.scrollTop = 50;

      var pos = new goog.positioning.ViewportClientPosition(0, 0);
      pos.reposition(popup, corner.TOP_LEFT);

      var offset = goog.style.getPageOffset(popup);
      assertEquals('Left edge of popup should be at specified x coordinate.',
                   0,
                   offset.x);
      assertTrue('Top edge of popup should be at specified y coordinate ' +
                 'adjusted for scroll.',
                 Math.abs(offset.y - 50) <= ALLOWED_OFFSET);

      dom.getDocument().body.style.paddingLeft = '1000px';
      dom.getDocumentScrollElement().scrollLeft = 500;

      pos.reposition(popup, corner.TOP_LEFT);
      offset = goog.style.getPageOffset(popup);
      assertTrue('Left edge of popup should be at specified x coordinate ' +
                 'adjusted for scroll.',
                 Math.abs(offset.x - 500) <= ALLOWED_OFFSET);

      dom.getDocumentScrollElement().scrollLeft = 0;
      dom.getDocumentScrollElement().scrollTop = 0;
      dom.getDocument().body.style.paddingLeft = '';
      dom.getDocument().body.style.paddingTop = '';

      pos.reposition(popup, corner.TOP_LEFT);
      offset = goog.style.getPageOffset(popup);
      assertEquals('Left edge of popup should be at specified x coordinate.',
                   0,
                   offset.x);
      assertEquals('Top edge of popup should be at specified y coordinate.',
                   0,
                   offset.y);
    }


    function testOverflowRightFlipHor() {
      var pos = new goog.positioning.ViewportClientPosition(frameRect.right,
                                                            100);
      pos.reposition(popup, corner.TOP_LEFT);

      var offset = goog.style.getPageOffset(popup);
      assertEquals('Left edge of popup should have been adjusted so that it ' +
                  'fits inside the viewport.',
                   frameRect.right - popup.offsetWidth,
                   offset.x);
      assertEquals('Top edge of popup should be at specified y coordinate.',
                   100,
                   offset.y);
    }


    function testOverflowTopFlipVer() {
      var pos = new goog.positioning.ViewportClientPosition(100, 0);
      pos.reposition(popup, corner.TOP_RIGHT);

      var offset = goog.style.getPageOffset(popup);
      assertEquals('Left edge of popup should be at specified x coordinate.',
                   80,
                   offset.x);
      assertEquals('Top edge of popup should have been adjusted so that it ' +
                  'fits inside the viewport.',
                   0,
                   offset.y);
    }


    function testOverflowBottomRightFlipBoth() {
      var pos = new goog.positioning.ViewportClientPosition(frameRect.right,
                                                            frameRect.bottom);
      pos.reposition(popup, corner.TOP_LEFT);

      var offset = goog.style.getPageOffset(popup);
      assertEquals('Left edge of popup should have been adjusted so that it ' +
                  'fits inside the viewport.',
                   frameRect.right - popup.offsetWidth,
                   offset.x);
      assertEquals('Top edge of popup should have been adjusted so that it ' +
                  'fits inside the viewport.',
                   frameRect.bottom - popup.offsetHeight,
                   offset.y);
    }
  ">6 of 6 tests run in 6ms.<br />0 passed, 6 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testOverflowBottomRightFlipBoth<br />Cannot read property 'document' of undefined<br />ERROR in testOverflowRightFlipHor<br />Cannot read property 'document' of undefined<br />ERROR in testOverflowTopFlipVer<br />Cannot read property 'document' of undefined<br />ERROR in testPositionAtCoordinateBottomRight<br />Cannot read property 'document' of undefined<br />ERROR in testPositionAtCoordinateTopLeft<br />Cannot read property 'document' of undefined<br />ERROR in testPositionAtCoordinateTopLeftWithScroll<br />Cannot read property 'document' of undefined<br /></td></tr>
<tr><td>iframeio_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.debug.DivConsole');
  goog.require('goog.net.IframeIo');
  goog.require('goog.testing.jsunit');


// MANUAL TESTS - The tests should be run in the browser from the Closure Test
// Server

// Set up a logger to track responses
goog.debug.LogManager.getRoot().setLevel(goog.debug.Logger.Level.INFO);
var logconsole = new goog.debug.DivConsole(document.getElementById('log'));
logconsole.setCapturing(true);

var testLogger = goog.debug.Logger.getLogger('test');


/** Creates an iframeIo instance and sets up the test environment */
function getTestIframeIo() {
  logconsole.addSeparator();
  logconsole.getFormatter().resetRelativeTimeStart();
  
  var io = new goog.net.IframeIo();
  io.setErrorChecker(checkForError);
  
  goog.events.listen(io, 'success', onSuccess); 
  goog.events.listen(io, 'error', onError);  
  goog.events.listen(io, 'ready', onReady);
  
  return io;
}

/**
 * Checks for error strings returned by the GSE and error variables that 
 * the Gmail server and GFE set on certain errors.
 */
function checkForError(doc) {
  var win = goog.dom.getWindow(doc);
  var text = doc.body.textContent || doc.body.innerText || '';
  var gseError = text.match(/([^\n]+)\nError ([0-9]{3})/);
  if (gseError) {
    return '(Error ' + gseError[2] + ') ' + gseError[1];
  } else if (win.gmail_error) {
    return win.gmail_error + 700;
  } else if (win.rc) {
    return 600 + win.rc % 100;
  } else {
    return null;
  }
}

/** Logs the status of an iframeIo object */
function logStatus(i) {
  testLogger.fine('Is complete/success/active: ' +
      [i.isComplete(), i.isSuccess(), i.isActive()].join('/'));
}

function onSuccess(e) {
  testLogger.warning('Request Succeeded');
  logStatus(e.target);  
}

function onError(e) {
  testLogger.warning('Request Errored: ' + e.target.getLastError());
  logStatus(e.target);  
}

function onReady(e) {
  testLogger.info('Test finished and iframe ready, disposing test object');
  e.target.dispose();
}



function simpleGet() {
  var io = getTestIframeIo();
  goog.events.listen(io, 'complete', onSimpleTestComplete); 
  io.send('/iframeio/ping', 'GET');  
}


function simplePost() {
  var io = getTestIframeIo();  
  goog.events.listen(io, 'complete', onSimpleTestComplete); 
  io.send('/iframeio/ping', 'POST');  
}

function onSimpleTestComplete(e) {
  testLogger.info('ResponseText: ' + e.target.getResponseText());
}

function abort() {
  var io = getTestIframeIo();
  goog.events.listen(io, 'complete', onAbortComplete); 
  goog.events.listen(io, 'abort', onAbort); 
  io.send('/iframeio/ping', 'GET');  
  io.abort();
}

function onAbortComplete(e) {
  testLogger.info('Hmm, request should have been aborted');
}

function onAbort(e) {
  testLogger.info('Request aborted');
}


function errorGse404() {
  var io = getTestIframeIo();
  io.send('/iframeio/404', 'GET');  
}

function jsonEcho(method) {
  var io = getTestIframeIo();
  goog.events.listen(io, 'complete', onJsonComplete);
  var data = {'p1': 'x', 'p2': 'y', 'p3': 'z', 'r': 10};
  io.send('/iframeio/jsonecho?q1=a&q2=b&q3=c&r=5', method, false, data);    
}

function onJsonComplete(e) {
  testLogger.info('ResponseText: ' + e.target.getResponseText());
  var json = e.target.getResponseJson();
  testLogger.info('ResponseJson:\n' + goog.debug.deepExpose(json, true));
}



function sendFromForm() {
  var io = getTestIframeIo()
  goog.events.listen(io, 'success', onUploadSuccess);
  goog.events.listen(io, 'error', onUploadError);
  io.sendFromForm(document.getElementById('uploadform'));
}

function onUploadSuccess(e) {
  testLogger.shout('Upload Succeeded');
  testLogger.info('ResponseText: ' + e.target.getResponseText());
}

function onUploadError(e) {
  testLogger.shout('Upload Errored');
  testLogger.info('ResponseText: ' + e.target.getResponseText());
}


function redirect1() {
  var io = getTestIframeIo();
  io.send('/iframeio/redirect', 'GET');  
}

function redirect2() {
  var io = getTestIframeIo();
  io.send('/iframeio/move', 'GET');    
}

function badUrl() {
  var io = getTestIframeIo();
  io.send('http://news.bbc.co.uk', 'GET');  
}

function localUrl1() {
  var io = getTestIframeIo();
  goog.events.listen(io, 'complete', onLocalSuccess);
  io.send('c:\test.txt', 'GET'); 
}

function localUrl2() {  
  var io = getTestIframeIo();
  goog.events.listen(io, 'success', onLocalSuccess);
  io.send('//test.txt', 'GET');  
}

function onLocalSuccess(e) {
  testLogger.info('The file was found:\n' + e.target.getResponseText());  
}

function getServerTime(noCache) {
  var io = getTestIframeIo();
  goog.events.listen(io, 'success', onTestCacheSuccess);
  io.send('/iframeio/datetime', 'GET', noCache);
}

function onTestCacheSuccess(e) {
  testLogger.info('Date reported: ' + e.target.getResponseText());  
}


function errorGmail() {
  var io = getTestIframeIo();
  goog.events.listen(io, 'error', onGmailError);
  io.send('/iframeio/gmailerror', 'GET');  
}

function onGmailError(e) {
  testLogger.info('Gmail error: ' + e.target.getLastError());  
}


function errorGfe() {
  var io = getTestIframeIo();
  goog.events.listen(io, 'error', onGfeError);
  io.send('/iframeio/gfeerror', 'GET');  
}

function onGfeError(e) {
  testLogger.info('GFE error: ' + e.target.getLastError());  
}



function incremental() {
  var io = getTestIframeIo();
  io.send('/iframeio/incremental', 'GET');
}

window['P'] = function(iframe, data) {
  var iframeIo = goog.net.IframeIo.getInstanceByName(iframe.name);
  testLogger.info('Data recieved - ' + data);
};


function postForm() {
  var io = getTestIframeIo()
  goog.events.listen(io, 'complete', onJsonComplete);
  io.sendFromForm(document.getElementById('testfrm'));
}



// UNIT TESTS - to be run via the JsUnit testRunner
    
// TODO(user): How to unit test all of this?  Creating a MockIframe could 
// help for the IE code path, but since the other browsers require weird
// behaviors this becomes very tricky.


function testGetForm() {
  var frm1 = goog.net.IframeIo.getForm_;
  var frm2 = goog.net.IframeIo.getForm_;
  assertEquals(frm1, frm2);
}


function testAddFormInputs() {
  var form = document.createElement('form');
  goog.net.IframeIo.addFormInputs_(form, {'a': 1, 'b': 2, 'c': 3});
  var inputs = form.getElementsByTagName('input');
  assertEquals(3, inputs.length);
  for (var i = 0; i < inputs.length; i++) {
    assertEquals('hidden', inputs[i].type);
    var n = inputs[i].name;
    assertEquals(n == 'a' ? '1' : n == 'b' ? '2' : '3', inputs[i].value);
  }
}

">TypeError: Object #<Object> has no method 'getElementsByTagName'
    at Object.getElementsByTagNameAndClass_ (dom/dom.js:266:20)
    at [object Object].<anonymous> (dom/dom.js:1932:19)
    at Object.installStyles (style/style.js:1092:19)
    at [object Object].installStyles (debug/divconsole.js:50:14)
    at new <anonymous> (debug/divconsole.js:42:8)
    at _tmpclosuretest.js:13:18
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
</td></tr>
<tr><td>crossdomainrpc_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.debug.Logger');
  goog.require('goog.net.CrossDomainRpc');
  goog.require('goog.testing.jsunit');



// TODO(user): These tests are in fact async since the send command makes a
// request for a file, the reason they do not fail is that the JsUnit test
// runner reports completion after the testFoo functions are finished, and
// does not catch any errors after this point.  These tests need updating so
// that they either mock out the async part of the test, or they should be
// written as an async test case.

function print(o) {
  if (Object.prototype.toSource) {
    return o.toSource();
  } else {
    var fragments = [];
    fragments.push('{');
    var first = true;
    for (var p in o) {
      if (!first) fragments.push(',');
      fragments.push(p);
      fragments.push(':"');
      fragments.push(o[p]);
      fragments.push('"');
      first = false;
    }
    return fragments.join('');
  }
};


function testNormalRequest() {
  var start = new Date();
  goog.net.CrossDomainRpc.send(
      'crossdomainrpc_test_response.html',
      function(e) {
        if (e.target.status < 300) {
          var elapsed = new Date() - start;
          var responseData = eval(e.target.responseText);
          goog.net.CrossDomainRpc.logger_.log(goog.debug.Logger.Level.FINE,
              elapsed + 'ms: [' + responseData.result.length + '] '
              + print(responseData)
          );
          assertEquals(16 * 1024, responseData.result.length);
          assertEquals(e.target.status, 123);
          assertEquals(e.target.responseHeaders.a, 1);
          assertEquals(e.target.responseHeaders.b, '2');
        } else {
          goog.net.CrossDomainRpc.logger_.log(goog.debug.Logger.Level.FINE,
              print(e));
          fail();
        }
      },
      'POST',
      {xyz: '01234567891123456789'}
  );
};


function testErrorRequest() {
  goog.net.CrossDomainRpc.send(
      'http://hoodjimcwaadji.google.com/index.html',
      function(e) {
        if (e.target.status < 300) {
          fail('should have failed requesting a non-existent URI');
        } else {
          goog.net.CrossDomainRpc.logger_.log(goog.debug.Logger.Level.FINE,
              'expected error seen; event=' + print(e));
        }
      },
      'POST',
      {xyz: '01234567891123456789'}
  );
};


function testGetDummyResourceUri() {
  var url = goog.net.CrossDomainRpc.getDummyResourceUri_();
  assertTrue(
      'dummy resource URL should not contain "?"', url.indexOf('?') < 0);
  assertTrue(
      'dummy resource URL should not contain "#"', url.indexOf('#') < 0);
};


function testRemoveHash() {
  assertEquals('abc', goog.net.CrossDomainRpc.removeHash_('abc#123'));
  assertEquals('abc', goog.net.CrossDomainRpc.removeHash_('abc#12#3'));
};
">TypeError: Cannot call method 'indexOf' of undefined
    at Function.isInResponseIframe_ (net/crossdomainrpc.js:116:51)
    at net/crossdomainrpc.js:127:29
    at [object Object].loadScript_ (/home/ubuntu/Dev/projects/node-goog/lib/goog.js:256:38)
    at /home/ubuntu/Dev/projects/node-goog/lib/goog.js:224:8
    at Object.importScript_ (base.js:455:45)
    at Object.writeScripts_ (base.js:536:14)
    at Object.require (base.js:280:12)
    at _tmpclosuretest.js:4:8
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
</td></tr>
<tr><td>crosspagechannel_test.html</td><td>Fail</td><td> 2 passed, 11 failed.</td><td title="

  goog.require('goog.Disposable');
  goog.require('goog.Uri');
  goog.require('goog.debug.Logger');
  goog.require('goog.dom');
  goog.require('goog.net.xpc.CrossPageChannel');
  goog.require('goog.object');
  goog.require('goog.testing.AsyncTestCase');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.testing.jsunit');



var IFRAME_LOAD_WAIT_MS = 2000;
var stubs = new goog.testing.PropertyReplacer();
var asyncTestCase = goog.testing.AsyncTestCase.createAndInstall(
    document.title);
var uniqueId = 0;
var driver;


function setUpPage() {
  asyncTestCase.stepTimeout = 10 * 1000;

  // Show debug log
  var debugDiv = goog.dom.getElement('debugDiv');
  var logger = goog.debug.Logger.getLogger('goog.net.xpc');
  logger.setLevel(goog.debug.Logger.Level.ALL);
  logger.addHandler(function(logRecord) {
    var msgElm = goog.dom.createDom('div');
    msgElm.innerHTML = logRecord.getMessage();
    goog.dom.appendChild(debugDiv, msgElm);
  });
}


function setUp() {
  driver = new Driver();
}


function tearDown() {
  stubs.reset();
  driver.dispose();
}


function testCreateIframeSpecifyId() {
  driver.createPeerIframe('new_iframe');

  asyncTestCase.waitForAsync('iframe load');
  window.setTimeout(function() {
    asyncTestCase.continueTesting();
    driver.checkPeerIframe();
  }, IFRAME_LOAD_WAIT_MS);
}


function testCreateIframeRandomId() {
  driver.createPeerIframe();

  asyncTestCase.waitForAsync('iframe load');
  window.setTimeout(function() {
    asyncTestCase.continueTesting();
    driver.checkPeerIframe();
  }, IFRAME_LOAD_WAIT_MS);
}


function testCreateIframeWithDom() {
  driver.createPeerIframe(goog.dom.getDomHelper());

  asyncTestCase.waitForAsync('iframe load');
  window.setTimeout(function() {
    asyncTestCase.continueTesting();
    driver.checkPeerIframe();
  }, IFRAME_LOAD_WAIT_MS);
}


function testCreateIframeAsynchronousConnect() {
  driver.createPeerIframe('new_iframe');

  asyncTestCase.waitForAsync('iframe load');
  window.setTimeout(function() {
    driver.connect();
  }, IFRAME_LOAD_WAIT_MS);
}


function testCreateIframeSynchronousConnect() {
  driver.createPeerIframe('new_iframe');
  driver.connect();
}


function testExistingIframeConnect() {
  driver.createChannel('test_iframe');
  driver.connect();
}

function testEscapeServiceName() {
  var escape = goog.net.xpc.CrossPageChannel.prototype.escapeServiceName_;
  assertEquals('Shouldn\'t escape alphanumeric name',
               'fooBar123', escape('fooBar123'));
  assertEquals('Shouldn\'t escape most non-alphanumeric characters',
               '`~!@#$^&*()_-=+ []{}\'";,<.>/?\\',
               escape('`~!@#$^&*()_-=+ []{}\'";,<.>/?\\'));
  assertEquals('Should escape %, |, and :',
               'foo%3ABar%7C123%25', escape('foo:Bar|123%'));
  assertEquals('Should escape tp', '%25tp', escape('tp'));
  assertEquals('Should escape %tp', '%25%25tp', escape('%tp'));
  assertEquals('Should not escape stp', 'stp', escape('stp'));
  assertEquals('Should not escape s%tp', 's%25tp', escape('s%tp'));
}

function testSameDomainCheck_noMessageOrigin() {
  var channel = new goog.net.xpc.CrossPageChannel(goog.object.create(
      goog.net.xpc.CfgFields.PEER_HOSTNAME, 'http://foo.com'));
  assertTrue(channel.isMessageOriginAcceptable_(undefined));
}

function testSameDomainCheck_noPeerHostname() {
  var channel = new goog.net.xpc.CrossPageChannel({});
  assertTrue(channel.isMessageOriginAcceptable_('http://foo.com'));
}

function testSameDomainCheck_unconfigured() {
  var channel = new goog.net.xpc.CrossPageChannel({});
  assertTrue(channel.isMessageOriginAcceptable_(undefined));
}

function testSameDomainCheck_originsMatch() {
  var channel = new goog.net.xpc.CrossPageChannel(goog.object.create(
      goog.net.xpc.CfgFields.PEER_HOSTNAME, 'http://foo.com'));
  assertTrue(channel.isMessageOriginAcceptable_('http://foo.com'));
}

function testSameDomainCheck_originsMismatch() {
  var channel = new goog.net.xpc.CrossPageChannel(goog.object.create(
      goog.net.xpc.CfgFields.PEER_HOSTNAME, 'http://foo.com'));
  assertFalse(channel.isMessageOriginAcceptable_('http://nasty.com'));
}

function testUnescapeServiceName() {
  var unescape = goog.net.xpc.CrossPageChannel.prototype.unescapeServiceName_;
  assertEquals('Shouldn\'t modify alphanumeric name',
               'fooBar123', unescape('fooBar123'));
  assertEquals('Shouldn\'t modify most non-alphanumeric characters',
               '`~!@#$^&*()_-=+ []{}\'";,<.>/?\\',
               unescape('`~!@#$^&*()_-=+ []{}\'";,<.>/?\\'));
  assertEquals('Should unescape URL-escapes',
               'foo:Bar|123%', unescape('foo%3ABar%7C123%25'));
  assertEquals('Should unescape tp', 'tp', unescape('%25tp'));
  assertEquals('Should unescape %tp', '%tp', unescape('%25%25tp'));
  assertEquals('Should not escape stp', 'stp', unescape('stp'));
  assertEquals('Should not escape s%tp', 's%tp', unescape('s%25tp'));
}


/**
 * Driver for the tests for CrossPageChannel.
 *
 * @constructor
 * @extends {goog.Disposable}
 */
Driver = function() {
  goog.Disposable.call(this);

  /**
   * The peer iframe.
   * @type {!Element}
   * @private
   */
  this.iframe_ = null;

  /**
   * The ID of the peer iframe.
   * @type {string}
   * @private
   */
  this.iframeId_ = 'test_iframe';

  /**
   * Channel configuration object.
   * @type {Object}
   * @private
   */
  this.cfg_ = null;

  /**
   * The channel to use.
   * @type {goog.net.xpc.CrossPageChannel}
   * @private
   */
  this.channel_ = null;
};
goog.inherits(Driver, goog.Disposable);


/**
 * Disposes of the channel.
 */
Driver.prototype.disposeInternal = function() {
  goog.base(this, 'disposeInternal');

  if (this.channel_) {
    this.channel_.dispose();
  }
};


/**
 * Returns the child peer's window object.
 * @return {Window} Child peer's window.
 * @private
 */
Driver.prototype.getInnerPeer_ = function() {
  return window.frames[this.iframeId_];
};


/**
 * Creates the channel.
 * @param {string=} opt_iframeId If present, the ID of the iframe to use,
 *     otherwise, tells the channel to generate an iframe ID.
 * @param {goog.dom.DomHelper=} opt_domHelper The optional dom helper to use
 *     for determining which window to use.
 */
Driver.prototype.createChannel = function(opt_iframeId, opt_domHelper) {
  var cfg = {};
  if (opt_iframeId) {
    this.iframeId_ = opt_iframeId;
    cfg[goog.net.xpc.CfgFields.IFRAME_ID] = opt_iframeId;
  }
  cfg[goog.net.xpc.CfgFields.PEER_URI] = 'testdata/inner_peer.html';
  cfg[goog.net.xpc.CfgFields.CHANNEL_NAME] = 'test_channel' + uniqueId++;
  cfg[goog.net.xpc.CfgFields.LOCAL_POLL_URI] = 'does-not-exist.html';
  cfg[goog.net.xpc.CfgFields.PEER_POLL_URI] = 'does-not-exist.html';
  function resolveUri(fieldName) {
    cfg[fieldName] =
        goog.Uri.resolve(window.location.href, cfg[fieldName]).toString();
  }
  resolveUri(goog.net.xpc.CfgFields.PEER_URI);
  resolveUri(goog.net.xpc.CfgFields.LOCAL_POLL_URI);
  resolveUri(goog.net.xpc.CfgFields.PEER_POLL_URI);

  this.channel_ = new goog.net.xpc.CrossPageChannel(cfg, opt_domHelper);
  this.channel_.registerService('msg', goog.bind(this.msgHandler_, this));
  this.cfg_ = cfg;
};


/**
 * Creates the peer iframe.
 * @param {string=} opt_iframeId If present, the ID of the iframe to create,
 *     otherwise, generates an iframe ID.
 * @param {goog.dom.DomHelper=} opt_domHelper The dom helper to use for
 *     finding the elements in the iframe.
 */
Driver.prototype.createPeerIframe = function(opt_iframeId, opt_domHelper) {
  var expectedIframeId;

  if (opt_iframeId) {
    expectedIframeId = opt_iframeId = opt_iframeId + uniqueId++;
  } else {
    // Have createPeerIframe() generate an ID
    stubs.set(goog.net.xpc, 'getRandomString', function(length) {
      return '' + length;
    });
    expectedIframeId = 'xpcpeer4';
  }
  assertNull('element[id=' + expectedIframeId + '] exists',
      goog.dom.getElement(expectedIframeId));

  this.createChannel(opt_iframeId, opt_domHelper);
  this.iframe_ = this.channel_.createPeerIframe(document.body);

  assertEquals(expectedIframeId, this.iframe_.id);
  this.iframeId_ = expectedIframeId;
};


/**
 * Checks if the peer iframe has been created.
 */
Driver.prototype.checkPeerIframe = function() {
  assertNotNull(goog.dom.getElement(this.iframeId_));
  var peer = this.getInnerPeer_();
  assertNotNull(peer);
  assertNotNull(peer.document);
};


/**
 * Starts the connection. The connection happens asynchronously.
 */
Driver.prototype.connect = function() {
  // TODO(user): Get tests to pass for all transports
  if (!this.isTransportTestable_()) {
    asyncTestCase.continueTesting();
    return;
  }

  if (this.iframe_) {
    // When we create an iframe, we send the config
    // and it connects itself.
    this.childConnected_();
  } else {
    asyncTestCase.waitForAsync('parent and child connect');
    var peer = this.getInnerPeer_();
    peer.instantiateChannel(this.cfg_);
    peer.connectChannel(goog.bind(this.childConnected_, this));
  }

  this.channel_.connect(goog.bind(this.parentConnected_, this));
};


/**
 * Determines if the transport type for the channel is testable.
 * Some transports are misusing global state or making other
 * assumptions that cause connections to fail.
 * @return {boolean} Whether the transport is testable.
 * @private
 */
Driver.prototype.isTransportTestable_ = function() {
  var testable = true;

  var transportType = this.channel_.determineTransportType_();
  switch (transportType) {
    case goog.net.xpc.TransportTypes.NATIVE_MESSAGING:
    case goog.net.xpc.TransportTypes.IFRAME_RELAY:
    case goog.net.xpc.TransportTypes.IFRAME_POLLING:
    case goog.net.xpc.TransportTypes.FLASH:
    case goog.net.xpc.TransportTypes.NIX:
      testable = false;
      break;
  }

  return testable;
};


/**
 * Callback for the parent connection.
 * @private
 */
Driver.prototype.parentConnected_ = function() {
  var peer = this.getInnerPeer_();
  if (peer.isConnected()) {
    asyncTestCase.waitForAsync('child echo');
  } else {
    asyncTestCase.waitForAsync('child connect');
  }

  this.channel_.send('echo', 'hello')
};


/**
 * Callback for the child connection.
 * @private
 */
Driver.prototype.childConnected_ = function() {
  if (this.channel_.isConnected()) {
    asyncTestCase.waitForAsync('child echo');
  } else {
    asyncTestCase.waitForAsync('parent connect');
  }
};


/**
 * The handler function for incoming msg requests.
 * @param {string} payload The message payload.
 * @private
 */
Driver.prototype.msgHandler_ = function(payload) {
  assertTrue('parent should be connected', this.channel_.isConnected());
  var peer = this.getInnerPeer_();
  assertTrue('child should be connected', peer.isConnected());
  assertEquals('hello', payload);

  asyncTestCase.continueTesting();
};


">13 of 13 tests run in 5532ms.<br />2 passed, 11 failed.<br />426 ms/test. 1 files loaded.<br />ERROR in testCreateIframeAsynchronousConnect [testCreateIframeAsynchronousConnect]<br />element[id=new_iframe0] exists<br />Expected <null> but was <[object Object]> (Object)<br />> anonymous at testing/asynctestcase.js:541:2<br />> assertNull at testing/asserts.js:316:3<br />> [object Object].createPeerIframe at _tmpclosuretest.js:274:3<br />> testCreateIframeAsynchronousConnect at _tmpclosuretest.js:83:10<br />ERROR in testCreateIframeRandomId [testCreateIframeRandomId]<br />element[id=xpcpeer4] exists<br />Expected <null> but was <[object Object]> (Object)<br />> anonymous at testing/asynctestcase.js:541:2<br />> assertNull at testing/asserts.js:316:3<br />> [object Object].createPeerIframe at _tmpclosuretest.js:274:3<br />> testCreateIframeRandomId at _tmpclosuretest.js:61:10<br />ERROR in testCreateIframeSpecifyId [testCreateIframeSpecifyId]<br />element[id=new_iframe1] exists<br />Expected <null> but was <[object Object]> (Object)<br />> anonymous at testing/asynctestcase.js:541:2<br />> assertNull at testing/asserts.js:316:3<br />> [object Object].createPeerIframe at _tmpclosuretest.js:274:3<br />> testCreateIframeSpecifyId at _tmpclosuretest.js:50:10<br />ERROR in testCreateIframeSynchronousConnect [testCreateIframeSynchronousConnect]<br />element[id=new_iframe2] exists<br />Expected <null> but was <[object Object]> (Object)<br />> anonymous at testing/asynctestcase.js:541:2<br />> assertNull at testing/asserts.js:316:3<br />> [object Object].createPeerIframe at _tmpclosuretest.js:274:3<br />> testCreateIframeSynchronousConnect at _tmpclosuretest.js:93:10<br />ERROR in testCreateIframeWithDom [testCreateIframeWithDom]<br />element[id=[object Object]3] exists<br />Expected <null> but was <[object Object]> (Object)<br />> anonymous at testing/asynctestcase.js:541:2<br />> assertNull at testing/asserts.js:316:3<br />> [object Object].createPeerIframe at _tmpclosuretest.js:274:3<br />> testCreateIframeWithDom at _tmpclosuretest.js:72:10<br />ERROR in testExistingIframeConnect [testExistingIframeConnect]<br />URI testdata/inner_peer.html is invalid for field pu<br />ERROR in testSameDomainCheck_noMessageOrigin [testSameDomainCheck_noMessageOrigin]<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testSameDomainCheck_noPeerHostname [testSameDomainCheck_noPeerHostname]<br />Object #<Object> has no method 'createElement'<br />ERROR in testSameDomainCheck_originsMatch [testSameDomainCheck_originsMatch]<br />Object #<Object> has no method 'createElement'<br />ERROR in testSameDomainCheck_originsMismatch [testSameDomainCheck_originsMismatch]<br />Object #<Object> has no method 'createElement'<br />ERROR in testSameDomainCheck_unconfigured [testSameDomainCheck_unconfigured]<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>nativemessagingtransport_test.html</td><td>Fail</td><td> 4 passed, 2 failed.</td><td title="

  goog.require('goog.net.xpc.CrossPageChannel');
  goog.require('goog.net.xpc.NativeMessagingTransport');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');



function tearDown() {
  goog.net.xpc.NativeMessagingTransport.activeCount_ = {};
  goog.events.removeAll(window.postMessage ? window : document, 'message');
}


function testConstructor() {
  var t = new goog.net.xpc.NativeMessagingTransport(null, 'http://g.com:80');
  assertEquals('http://g.com:80', t.peerHostname_);

  var t = new goog.net.xpc.NativeMessagingTransport(null, null);
  assertEquals('*', t.peerHostname_);
  t.dispose();
}


function testConstructorDom() {
  var t = new goog.net.xpc.NativeMessagingTransport(
      null, 'http://g.com:80', goog.dom.getDomHelper());
  assertEquals('http://g.com:80', t.peerHostname_);

  var t = new goog.net.xpc.NativeMessagingTransport(null, null);
  assertEquals('*', t.peerHostname_);
  t.dispose();
}


function testDispose() {
  var xpc = getTestChannel();
  var listenedObj = window.postMessage ? window : document;

  var t0 = new goog.net.xpc.NativeMessagingTransport(xpc, null);
  assertEquals(0, goog.events.removeAll(listenedObj, 'message'));
  t0.dispose();
  assertEquals(0, goog.events.removeAll(listenedObj, 'message'));

  var t1 = new goog.net.xpc.NativeMessagingTransport(xpc, null);
  t1.connect();
  t1.dispose();
  assertEquals(0, goog.events.removeAll(listenedObj, 'message'));

  var t2 = new goog.net.xpc.NativeMessagingTransport(xpc, null);
  var t3 = new goog.net.xpc.NativeMessagingTransport(xpc, null);
  t2.connect();
  t3.connect();
  t2.dispose();
  assertEquals(1, goog.events.removeAll(listenedObj, 'message'));
}


function testDisposeWithDom() {
  var xpc = getTestChannel(goog.dom.getDomHelper());
  var listenedObj = window.postMessage ? window : document;

  var t0 = new goog.net.xpc.NativeMessagingTransport(xpc, null);
  assertEquals(0, goog.events.removeAll(listenedObj, 'message'));
  t0.dispose();
  assertEquals(0, goog.events.removeAll(listenedObj, 'message'));

  var t1 = new goog.net.xpc.NativeMessagingTransport(xpc, null);
  t1.connect();
  t1.dispose();
  assertEquals(0, goog.events.removeAll(listenedObj, 'message'));

  var t2 = new goog.net.xpc.NativeMessagingTransport(xpc, null);
  var t3 = new goog.net.xpc.NativeMessagingTransport(xpc, null);
  t2.connect();
  t3.connect();
  t2.dispose();
  assertEquals(1, goog.events.removeAll(listenedObj, 'message'));
}


function testBogusMessages() {
  var e = createMockEvent('bogus_message');
  assertFalse(goog.net.xpc.NativeMessagingTransport.messageReceived_(e));

  e = createMockEvent('bogus|message');
  assertFalse(goog.net.xpc.NativeMessagingTransport.messageReceived_(e));

  e = createMockEvent('bogus|message:data');
  assertFalse(goog.net.xpc.NativeMessagingTransport.messageReceived_(e));
}


function testSendingMessagesToUnconnectedInnerPeer() {
  var xpc = getTestChannel();

  var serviceResult, payloadResult;
  xpc.deliver_ = function(service, payload) {
    serviceResult = service;
    payloadResult = payload;
  };

  // Construct an unconnected inner peer.
  xpc.getRole = function() {
    return goog.net.xpc.CrossPageChannel.Role.INNER;
  };
  xpc.isConnected = function() {
    return false;
  };
  var t = new goog.net.xpc.NativeMessagingTransport(xpc, 'http://g.com');

  // Test a valid message.
  var e = createMockEvent('test_channel|test_service:test_payload');
  assertTrue(goog.net.xpc.NativeMessagingTransport.messageReceived_(e));
  assertEquals('test_service', serviceResult);
  assertEquals('test_payload', payloadResult);
  assertEquals('Ensure channel name has not been changed.',
               'test_channel',
               t.channel_.name);

  // Test updating a stale inner peer.
  var e = createMockEvent('new_channel|tp:SETUP');
  assertTrue(goog.net.xpc.NativeMessagingTransport.messageReceived_(e));
  assertEquals('tp', serviceResult);
  assertEquals('SETUP', payloadResult);
  assertEquals('Ensure channel name has been updated.',
               'new_channel',
               t.channel_.name);
  t.dispose();
}


function createMockEvent(data) {
  var event = {};
  event.getBrowserEvent = function() { return {data: data} };
  return event;
}


function getTestChannel(opt_domHelper) {
  var cfg = {};
  cfg[goog.net.xpc.CfgFields.CHANNEL_NAME] = 'test_channel';
  return new goog.net.xpc.CrossPageChannel(cfg, opt_domHelper);
}

">6 of 6 tests run in 10ms.<br />4 passed, 2 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testDispose<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testDisposeWithDom<br />Cannot read property 'closure_uid_qbevmj' of undefined<br /></td></tr>
<tr><td>imageloader_test.html</td><td>Fail</td><td> undefined</td><td title="

    goog.require('goog.events');
    goog.require('goog.events.EventType');
    goog.require('goog.net.ImageLoader');
    goog.require('goog.structs.Map');
    goog.require('goog.testing.jsunit');
  




  var TEST_IMAGES = new goog.structs.Map();

  var TEST_EVENT_TYPES = [
    goog.events.EventType.LOAD,
    goog.net.EventType.COMPLETE,
    goog.net.EventType.ERROR
  ];

  //  TEST_IMAGES.set(FileName, Expected Size (width, height), Expected event)
  var EVENT_TYPE_LOAD = goog.events.EventType.LOAD;
  TEST_IMAGES.set('imageloader_testimg1.gif', [20, 20, EVENT_TYPE_LOAD]);
  TEST_IMAGES.set('imageloader_testimg2.gif', [20, 20, EVENT_TYPE_LOAD]);
  TEST_IMAGES.set('imageloader_testimg3.gif', [32, 32, EVENT_TYPE_LOAD]);

  var EVENT_TYPE_ERROR = goog.net.EventType.ERROR;
  TEST_IMAGES.set('this-is-not-image-1.gif', [0, 0, EVENT_TYPE_ERROR]);
  TEST_IMAGES.set('this-is-not-image-2.gif', [0, 0, EVENT_TYPE_ERROR]);

  var TIMEOUT = 5000;
  // in milleseconds

  // Create a new test case.
  var imageLoaderTestCase = new goog.testing.TestCase(document.title);
  var setUpPageStatus;

  // Keep track of time so we can timeout if the images don't load.
  imageLoaderTestCase.elapsedTime_ = 0;

  imageLoaderTestCase.results_ = new goog.structs.Map();

  /** True once the test environment is set up. */
  imageLoaderTestCase.isSetUp = false;

  /** True once the page is ready for the test to be run. */
  imageLoaderTestCase.isReady = false;

  // A regular image loader.
  imageLoaderTestCase.imageLoader = new goog.net.ImageLoader();

  // An image loader that is used to check whether we can dispose
  // it safely whenever an event is fired before the COMPLETE event.
  imageLoaderTestCase.disposalImageLoader = new goog.net.ImageLoader();

  /** Sets up the test environment, adds tests and sets up the worker pools. */
  imageLoaderTestCase.setUpTests = function() {
    this.log('Setting tests up');

    this.add(new goog.testing.TestCase.Test('testCompleteResults',
        this.testCompleteResults, this));

    this.isSetUp = true;

    var keys = TEST_IMAGES.getKeys();
    for (var i = 0; i < keys.length; i++) {
      this.log('Adding image: ' + keys[i]);
      this.imageLoader.addImage('img_' + i, keys[i]);
      this.disposalImageLoader.addImage('img_' + i, keys[i]);
    }

    goog.events.listen(this.imageLoader, TEST_EVENT_TYPES,
        this.handleImageLoaderEvent, false, this);

    goog.events.listen(this.disposalImageLoader, TEST_EVENT_TYPES,
        this.handleDisposalImageLoaderEvent, false, this);

    this.disposalImageLoader.start();
  };

  /** Handles any events fired on the disposalImageLoader */
  imageLoaderTestCase.handleDisposalImageLoaderEvent = function(e) {
    switch (e.type) {
      case goog.events.EventType.LOAD:
      case goog.net.EventType.ERROR:
        // Make sure that we can dispose this.disposalImageLoader safely.
        this.disposalImageLoader.dispose();

        // then starts the regular image loader.
        this.imageLoader.start();
        break;

      case goog.net.EventType.COMPLETE:
        throw new Error('disposalImageLoader should have been disposed.');
        break;
    }
  };


  /** Handles any events fired on the imageLoader */
  imageLoaderTestCase.handleImageLoaderEvent = function(e) {
    this.log('handleEvent, type: ' + e.type);

    switch (e.type) {
      case goog.events.EventType.LOAD:
        var image = e.target;
        this.results_.set(image.src.substring(image.src.lastIndexOf('/') + 1),
            [image.naturalWidth, image.naturalHeight, e.type]);
        break;

      case goog.net.EventType.ERROR:
        var image = e.target;
        this.results_.set(image.src.substring(image.src.lastIndexOf('/') + 1),
            [image.naturalWidth, image.naturalHeight, e.type]);
        break;

      case goog.net.EventType.COMPLETE:
        setUpPageStatus = 'complete';
        this.isReady = true;
        break;
    }
  };


  /** Tests the results. */
  imageLoaderTestCase.testCompleteResults = function() {
    var keys = TEST_IMAGES.getKeys();
    for (var i = 0; i < keys.length; i++) {
      var key = keys[i];
      this.log(key);

      // Check if fires the COMPLETE event.
      assertTrue('Image is not loaded completely',
          this.results_.containsKey(key));

      // Chcekc size.
      assertTrue('Image size is not correct',
          this.results_.get(key)[0] == TEST_IMAGES.get(key)[0] &&
          this.results_.get(key)[1] == TEST_IMAGES.get(key)[1]);

      // Check if fired the correct event.
      assertTrue('Event *' + TEST_IMAGES.get(key)[2] + '* must be fired',
          this.results_.get(key)[2] == TEST_IMAGES.get(key)[2]);
    }
  };

  /** Waits until the tests are ready to begin, before running them. */
  imageLoaderTestCase.runTests = function() {
    if (!this.isSetUp) {
      this.setUpTests();
    }
    if (this.isReady) {
      this.execute();
    } else {
      if (this.elapsedTime_ > TIMEOUT) {
        this.log('timed out');
        setUpPageStatus = 'complete';
        this.isReady = true;
        return;
      }
      this.log('Not ready, waiting');
      this.elapsedTime_ += 100;
      // Try again in 100ms
      setTimeout('imageLoaderTestCase.runTests()', 100);
    }
  };

  /** Used by the JsUnit test runner. */
  function testCompleteResults() {
    imageLoaderTestCase.testCompleteResults();
  }

  /** Used by the JsUnit test runner. */
  function setUpPage() {
    imageLoaderTestCase.runTests();
  }

  /** Standalone Closure Test Runner. */
  if (typeof G_testRunner != 'undefined') {
    G_testRunner.initialize(imageLoaderTestCase);
  }

">ReferenceError: Image is not defined
    at [object Object].loadImage_ (net/imageloader.js:130:5)
    at Object.forEach (object/object.js:33:7)
    at [object Object].start (net/imageloader.js:113:15)
    at [object Object].setUpTests (_tmpclosuretest.js:78:30)
    at [object Object].runTests (_tmpclosuretest.js:150:12)
    at [object Object].setUpPage (_tmpclosuretest.js:175:25)
    at [object Object].runTests (testing/testcase.js:487:8)
    at [object Object].execute (testing/testrunner.js:266:17)
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:429:6)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
</td></tr>
<tr><td>xhrmonitor_test.html</td><td>Success</td><td> 10 passed, 0 failed.</td><td title="

  goog.require('goog.net.xhrMonitor');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');


  var mon = goog.net.xhrMonitor;
  
  function testNonGeckoIsAlwaysSafe() {
    if (goog.userAgent.GECKO) return;
    var o = {}, x = {}, y = {};
    assertTrue('Should be safe', mon.isContextSafe(o)); 
    mon.pushContext(o);
    mon.markXhrOpen(x);
    mon.markXhrOpen(y);
    mon.popContext();
    assertTrue('Should be safe', mon.isContextSafe(o)); 
    mon.markXhrClosed(x);
    assertTrue('Should be safe', mon.isContextSafe(o)); 
    mon.markXhrClosed(y);
    assertTrue('Should be safe', mon.isContextSafe(o)); 
    
  }
  
  function testSyncOpenClose() {
    if (!goog.userAgent.GECKO) return;
    var o = {}, x = {};
    assertTrue('Should be safe', mon.isContextSafe(o));
    mon.pushContext(o);
    mon.markXhrOpen(x);
    mon.markXhrClosed(x);
    mon.popContext();
    assertTrue('Should be safe', mon.isContextSafe(o));
  }
  
  function testSyncOpenCloseWithNull() {
    if (!goog.userAgent.GECKO) return;
    var o = {}, x = {};
    assertTrue('Should be safe', mon.isContextSafe(o));
    mon.pushContext(null);
    mon.markXhrOpen(x);
    mon.markXhrClosed(x);
    mon.popContext();
    assertTrue('Should be safe', mon.isContextSafe(o));
  }
  
  function testAsyncOpenClose() {
    if (!goog.userAgent.GECKO) return;
    var o = {}, x = {};
    assertTrue('Should be safe', mon.isContextSafe(o));
    
    mon.pushContext(o);
    mon.markXhrOpen(x);
    mon.popContext();
    assertFalse('Should not be safe', mon.isContextSafe(o));
  
    mon.markXhrClosed(x);
    assertTrue('Should be safe', mon.isContextSafe(o));
  }

  function testMultipleRequests1() {
    if (!goog.userAgent.GECKO) return;
    var o = {}, x = {}, y = {};
    assertTrue('Should be safe', mon.isContextSafe(o));
    mon.pushContext(o);
    mon.markXhrOpen(x);
    mon.markXhrOpen(y);
    mon.popContext();
    assertFalse('Should not be safe', mon.isContextSafe(o));
    mon.markXhrClosed(x);
    assertFalse('Should not be safe', mon.isContextSafe(o));
    mon.markXhrClosed(y);
    assertTrue('Should be safe', mon.isContextSafe(o));   
  }
  
  function testMultipleRequests2() {
    if (!goog.userAgent.GECKO) return;
    var o = {}, x = {}, y = {};
    assertTrue('Should be safe', mon.isContextSafe(o));
    mon.pushContext(o);
    mon.markXhrOpen(x);
    mon.markXhrOpen(y);
    mon.markXhrClosed(x);
    mon.popContext();
    assertFalse('Should not be safe', mon.isContextSafe(o));
    mon.markXhrClosed(y);
    assertTrue('Should be safe', mon.isContextSafe(o));   
  }
  
  function testNestedContexts() {
    if (!goog.userAgent.GECKO) return;
    var o = {}, p = {}, x = {}, y = {};
    assertTrue('Should be safe', mon.isContextSafe(o));
    assertTrue('Should be safe', mon.isContextSafe(p));
    mon.pushContext(o);
    mon.markXhrOpen(x);
    assertFalse('Should not be safe', mon.isContextSafe(o));
    assertTrue('Should be safe', mon.isContextSafe(p));
    mon.pushContext(p);
    mon.markXhrOpen(y);
    assertFalse('Should not be safe', mon.isContextSafe(o));
    assertFalse('Should not be safe', mon.isContextSafe(p));
    mon.popContext();
    mon.popContext();
    assertFalse('Should not be safe', mon.isContextSafe(o));
    assertFalse('Should not be safe', mon.isContextSafe(p));
    mon.markXhrClosed(x);
    assertFalse('Should not be safe', mon.isContextSafe(o));
    assertFalse('Should not be safe', mon.isContextSafe(p));
    mon.markXhrClosed(y);
    assertTrue('Should be safe', mon.isContextSafe(o));
    assertTrue('Should be safe', mon.isContextSafe(p));   
  }
  
  function testNestedXhrScopes() {
    if (!goog.userAgent.GECKO) return;
    var o = {}, x = {}, y = {};

    // Simulates an XHR request triggering a 2nd XHR request

    // Iframe response opens an XHR
    mon.pushContext(o);
    mon.markXhrOpen(x);
    mon.popContext();

    // XHR returns and dispatches an event which opens another response
    mon.pushContext(x);
    mon.markXhrOpen(y);
    mon.popContext();
    
    // Closing the original XHR should update any dependencies
    mon.markXhrClosed(x);
    
    assertFalse('Should not be safe', mon.isContextSafe(o));
    
    // Close the later XHR
    mon.markXhrClosed(y);
    
    assertTrue('Should be safe', mon.isContextSafe(o));
  }
  
  function testCrazyNestedXhrScopes() {
    if (!goog.userAgent.GECKO) return;
    var o = {}, x = {}, y = {}, z = {};

    // Iframe response opens an XHR
    mon.pushContext(o);
    mon.markXhrOpen(x);
    mon.popContext();

    // XHR returns and dispatches an event which opens another response
    mon.pushContext(x);
    mon.markXhrOpen(y);
    mon.popContext();
    
    // Closing the original XHR should update any dependencies
    mon.markXhrClosed(x);

    mon.pushContext(y);
    mon.markXhrOpen(z);
    mon.popContext();
    
    // Close the middle XHR
    mon.markXhrClosed(y);
    
    assertFalse('Should not be safe', mon.isContextSafe(o));
    
    // Close the last XHR
    mon.markXhrClosed(z);
    
    assertTrue('Should be safe', mon.isContextSafe(o));
  }
  
  function testGetKey() {
    var fn = goog.net.XhrMonitor_.getKey;
    assertEquals('test', fn('test'));
    assertEquals('test2', fn('test2'));
    assertEquals('', fn(null));
    var o = {};
    assertEquals(goog.getUid(o), fn(o));
  }

">n/a</td></tr>
<tr><td>iframeio_different_base_test.html</td><td>Fail</td><td> 0 passed, 1 failed.</td><td title="
// We use a different base to reproduce the conditions of crbug.com/66987
var href = window.location.href;
var newHref = href.replace(/net.*/, '');
document.write('<base href="' + newHref + '">');



  goog.require('goog.net.IframeIo');
  goog.require('goog.testing.AsyncTestCase');
  goog.require('goog.testing.jsunit');



var asyncTestCase = goog.testing.AsyncTestCase.createAndInstall();

function testDifferentBaseUri() {
  var io = new goog.net.IframeIo();
  goog.events.listen(io, goog.net.EventType.COMPLETE,
      function() {
        assertNotEquals('File should have expected content.',
            -1, io.getResponseText().indexOf('just a file'));
        asyncTestCase.continueTesting();
      });
  io.send('net/iframeio_different_base_test.data');
  asyncTestCase.waitForAsync('Waiting for iframeIo respons.');
}

">1 of 1 tests run in 510ms.<br />0 passed, 1 failed.<br />510 ms/test. 1 files loaded.<br />ERROR in testDifferentBaseUri [testDifferentBaseUri]<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>bulkloader_test.html</td><td>Success</td><td> 2 passed, 0 failed.</td><td title="

  goog.require('goog.events.EventHandler');
  goog.require('goog.net.BulkLoader');
  goog.require('goog.net.EventType');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.MockClock');



  /**
   * Test interval between sending uri requests to the server.
   */
  var DELAY_INTERVAL_BETWEEN_URI_REQUESTS = 5;

  /**
   * Test interval before a response is received for a URI request.
   */
  var DELAY_INTERVAL_FOR_URI_LOAD = 15;

  var clock;
  var loadSuccess, loadError;
  var successResponseTexts;

  function setUpPage() {
    clock = new goog.testing.MockClock(true);
  }

  function tearDownPage() {
    clock.dispose();
  }

  function setUp() {
    loadSuccess = false;
    loadError = false;
    successResponseTexts = [];
  }

  /**
   * Gets the successful bulkloader for the specified uris with some
   * modifications for testability.
   * <ul>
   *   <li> Added onSuccess methods to simulate success while loading uris.
   *   <li> The send function of the XhrManager used by the bulkloader
   *        calls the onSuccess function after a specified time interval.
   * </ul>
   * @param {Array.<string>} uris The URIs.
   */
  function getSuccessfulBulkLoader(uris) {
    var bulkLoader = new goog.net.BulkLoader(uris);
    bulkLoader.load = function() {
      var uris = this.helper_.getUris();
      for (var i = 0; i < uris.length; i++) {
        // This clock tick simulates a delay for processing every URI.
        clock.tick(DELAY_INTERVAL_BETWEEN_URI_REQUESTS);
        // This timeout determines how many ticks after the send request
        // all the URIs will complete loading. This delays the load of
        // the first uri and every subsequent uri by 15 ticks.
        setTimeout(goog.bind(this.onSuccess, this, i, uris[i]),
            DELAY_INTERVAL_FOR_URI_LOAD);
      }
    };

    bulkLoader.onSuccess = function(id, uri) {
      var xhrIo = {
        getResponseText: function() {return uri;},
        isSuccess: function() {return true;},
        dispose: function() {}
      };
      this.handleEvent_(id, new goog.events.Event(
          goog.net.EventType.COMPLETE, xhrIo));
    };

    var eventHandler = new goog.events.EventHandler();
    eventHandler.listen(bulkLoader,
        goog.net.EventType.SUCCESS,
        handleSuccess);
    eventHandler.listen(bulkLoader,
        goog.net.EventType.ERROR,
        handleError);

    return bulkLoader;
  };

  /**
   * Gets the non-successful bulkloader for the specified uris with some
   * modifications for testability.
   * <ul>
   *   <li> Added onSuccess and onError methods to simulate success and error
   *        while loading uris.
   *   <li> The send function of the XhrManager used by the bulkloader
   *        calls the onSuccess or onError function after a specified time
   *        interval.
   * </ul>
   * @param {Array.<string>} uris The URIs.
   */
  function getNonSuccessfulBulkLoader(uris) {
    var bulkLoader = new goog.net.BulkLoader(uris);
    bulkLoader.load = function() {
      var uris = this.helper_.getUris();
      for (var i = 0; i < uris.length; i++) {
        // This clock tick simulates a delay for processing every URI.
        clock.tick(DELAY_INTERVAL_BETWEEN_URI_REQUESTS);

        // This timeout determines how many ticks after the send request
        // all the URIs will complete loading in error. This delays the load
        // of the first uri and every subsequent uri by 15 ticks. The URI
        // with id == 2 is in error.
        if (i != 2) {
          setTimeout(goog.bind(this.onSuccess, this, i, uris[i]),
              DELAY_INTERVAL_FOR_URI_LOAD);
        } else {
          setTimeout(goog.bind(this.onError, this, i, uris[i]),
              DELAY_INTERVAL_FOR_URI_LOAD);
        }
      }
    };

    bulkLoader.onSuccess = function(id, uri) {
      var xhrIo = {
        getResponseText: function() {return uri;},
        isSuccess: function() {return true;},
        dispose: function() {}
      };
      this.handleEvent_(id, new goog.events.Event(
          goog.net.EventType.COMPLETE, xhrIo));
    };

    bulkLoader.onError = function(id) {
      var xhrIo = {
        getResponseText: function() {return null;},
        isSuccess: function() {return false;},
        dispose: function() {}
      };
      this.handleEvent_(id, new goog.events.Event(
          goog.net.EventType.ERROR, xhrIo));
    };

    var eventHandler = new goog.events.EventHandler();
    eventHandler.listen(bulkLoader,
        goog.net.EventType.SUCCESS,
        handleSuccess);
    eventHandler.listen(bulkLoader,
        goog.net.EventType.ERROR,
        handleError);

    return bulkLoader;
  };

  function handleSuccess(e) {
    loadSuccess = true;
    successResponseTexts = e.target.getResponseTexts();
  }

  function handleError(e) {
    loadError = true;
  }

  /**
   * Test successful loading of URIs using the bulkloader.
   */
  function testBulkLoaderLoadSuccess() {
    var uris = ['a', 'b', 'c'];
    var bulkLoader = getSuccessfulBulkLoader(uris);

    bulkLoader.load();

    clock.tick(2);
    assertFalse(
        'The bulk loader is not yet loaded (after 2 ticks)', loadSuccess);

    clock.tick(3);
    assertFalse(
        'The bulk loader is not yet loaded (after 5 ticks)', loadSuccess);

    clock.tick(5);
    assertFalse(
        'The bulk loader is not yet loaded (after 10 ticks)', loadSuccess);

    clock.tick(5);
    assertTrue('The bulk loader is loaded (after 15 ticks)', loadSuccess);

    assertArrayEquals('Ensure that the response texts are present',
        successResponseTexts, uris);
  }

  /**
   * Test error loading URIs using the bulkloader.
   */
  function testBulkLoaderLoadError() {
    var uris = ['a', 'b', 'c'];
    var bulkLoader = getNonSuccessfulBulkLoader(uris);

    bulkLoader.load();

    clock.tick(2);
    assertFalse(
        'The bulk loader is not yet loaded (after 2 ticks)', loadError);

    clock.tick(3);
    assertFalse(
        'The bulk loader is not yet loaded (after 5 ticks)', loadError);

    clock.tick(5);
    assertFalse(
        'The bulk loader is not yet loaded (after 10 ticks)', loadError);

    clock.tick(5);
    assertFalse(
        'The bulk loader is not loaded successfully (after 15 ticks)',
        loadSuccess);
    assertTrue(
        'The bulk loader is loaded in error (after 15 ticks)', loadError);
  }
">n/a</td></tr>
<tr><td>mockxhrlite_test.html</td><td>Fail</td><td> 0 passed, 3 failed.</td><td title="

  goog.require('goog.dom.xml');
  goog.require('goog.events');
  goog.require('goog.net.MockXhrLite');
  goog.require('goog.testing.asserts');
  goog.require('goog.testing.jsunit');



function testGetResponseText() {
  // Text response came.
  var called = false;
  var xhr = new goog.net.MockXhrLite();
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, function(e) {
    called = true;
    assertEquals('text', e.target.getResponseText());
  });
  xhr.simulateResponse(200, 'text');
  assertTrue(called);

  // XML response came.
  var called = false;
  var xhr = new goog.net.MockXhrLite();
  var xml = goog.dom.xml.createDocument();
  xml.appendChild(xml.createElement('root'));
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, function(e) {
    called = true;
    var text = e.target.getResponseText();
    assertTrue(/<root ?\/>/.test(text));
  });
  xhr.simulateResponse(200, xml);
  assertTrue(called);
}

function testGetResponseJson() {
  // Valid JSON response came.
  var called = false;
  var xhr = new goog.net.MockXhrLite();
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, function(e) {
    called = true;
    assertArrayEquals([0, 1], e.target.getResponseJson());
  });
  xhr.simulateResponse(200, '[0, 1]');
  assertTrue(called);

  // Invalid JSON response came.
  var called = false;
  var xhr = new goog.net.MockXhrLite();
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, function(e) {
    called = true;
    assertThrows(e.target.getResponseJson);
  });
  xhr.simulateResponse(200, '[0, 1');
  assertTrue(called);

  // XML response came.
  var called = false;
  var xhr = new goog.net.MockXhrLite();
  var xml = goog.dom.xml.createDocument();
  xml.appendChild(xml.createElement('root'));
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, function(e) {
    called = true;
    assertThrows(e.target.getResponseJson);
  });
  xhr.simulateResponse(200, xml);
  assertTrue(called);
}

function testGetResponseXml() {
  // Text response came.
  var called = false;
  var xhr = new goog.net.MockXhrLite();
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, function(e) {
    called = true;
    assertNull(e.target.getResponseXml());
  });
  xhr.simulateResponse(200, 'text');
  assertTrue(called);

  // XML response came.
  var called = false;
  var xhr = new goog.net.MockXhrLite();
  var xml = goog.dom.xml.createDocument();
  xml.appendChild(xml.createElement('root'));
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, function(e) {
    called = true;
    assertEquals(xml, e.target.getResponseXml());
  });
  xhr.simulateResponse(200, xml);
  assertTrue(called);
}

">3 of 3 tests run in 8ms.<br />0 passed, 3 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testGetResponseJson<br />Your browser does not support creating new documents<br />ERROR in testGetResponseText<br />Your browser does not support creating new documents<br />ERROR in testGetResponseXml<br />Your browser does not support creating new documents<br /></td></tr>
<tr><td>jsonp_test.html</td><td>Fail</td><td> 0 passed, 7 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.net.Jsonp');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');
  goog.require('goog.testing.recordFunction');
  goog.require('goog.testing.PropertyReplacer');


// Global vars to facilitate a shared set up function.

var timeoutWasCalled;
var timeoutHandler;

var fakeUrl = 'http://fake-site.eek/';

var originalTimeout;
function setUp() {
  timeoutWasCalled = false;
  timeoutHandler = null;
  originalTimeout = window.setTimeout;
  window.setTimeout = function(handler, time) {
    timeoutWasCalled = true;
    timeoutHandler = handler;
  };
}

// Firefox throws a JS error when a script is not found.  We catch that here and
// ensure the test case doesn't fail because of it.
var originalOnError = window.onerror;
window.onerror = function(msg, url, line) {
  // TODO(user): Safari 3 on the farm returns an object instead of the typcial
  // params.  Pass through errors for safari for now.
  if (goog.userAgent.WEBKIT ||
      msg == 'Error loading script' && url.indexOf('fake-site') != -1) {
    return true;
  } else {
    return originalOnError && originalOnError(msg, url, line);
  }
};

function tearDown() {
  window.setTimeout = originalTimeout;
}

// Quick function records the before-state of the DOM, and then return a
// a function to check that XDC isn't leaving stuff behind.
function newCleanupGuard() {
  var bodyChildCount = document.body.childNodes.length;

  return function() {
    // let any timeout queues finish before we check these:
    window.setTimeout(function() {
      var propCounter = 0;

      // All callbacks should have been deleted or be the null function.
      for (var id in goog.global[goog.net.Jsonp.CALLBACKS]) {
        if (goog.global[goog.net.Jsonp.CALLBACKS][id] != goog.nullFunction) {
          propCounter++;
        }
      }

      assertEquals(
          'script cleanup', bodyChildCount, document.body.childNodes.length);
      assertEquals('window jsonp array empty', 0, propCounter);
    }, 0);
  }
}


// Check that send function is sane when things go well.
function testSend() {
  var replyReceived;
  var jsonp = new goog.net.Jsonp(fakeUrl);

  var checkCleanup = newCleanupGuard();

  var userCallback = function(data) {
    replyReceived = data;
  }

  var payload = {atisket: 'atasket', basket: 'yellow'};
  var result = jsonp.send(payload, userCallback);

  var script = goog.dom.getElement(result.id_);

  assertNotNull('script created', script);
  assertEquals('encoding is utf-8', 'UTF-8', script.charset);

  // Check that the URL matches our payload.
  assertTrue('payload in url', script.src.indexOf('basket=yellow') > -1);
  assertTrue('server url', script.src.indexOf(fakeUrl) == 0);

  // Now, we have to track down the name of the callback function, so we can
  // call that to simulate a returned request.
  var callbackName = /callback=([^&]+)/.exec(script.src)[1];
  var callbackFunc = eval(callbackName);
  callbackFunc({some: 'data', another: ['data', 'right', 'here']});
  assertEquals('input was received', 'right', replyReceived.another[1]);

  // Verify that the same callback function does not break if it receives a
  // second unexpected parameter.
  callbackFunc({some: 'data', another: ['data', 'right', 'here']},
      'unexpected');
  assertEquals('input was received', 'right', replyReceived.another[1]);

  // Because the callbackFunc calls cleanUp_ and that calls setTimeout which
  // we have overwritten, we have to call the timeoutHandler to actually do
  // the cleaning.
  timeoutHandler();

  checkCleanup();
  timeoutHandler();
}


// Check that send function is sane when things go well.
function testSendWhenCallbackHasTwoParameters() {
  var replyReceived, replyReceived2;
  var jsonp = new goog.net.Jsonp(fakeUrl);

  var checkCleanup = newCleanupGuard();

  var userCallback = function(data, opt_data2) {
    replyReceived = data;
    replyReceived2 = opt_data2;
  }

  var payload = {atisket: 'atasket', basket: 'yellow'};
  var result = jsonp.send(payload, userCallback);
  var script = goog.dom.getElement(result.id_);

  // Test a callback function that receives two parameters.
  var callbackName = /callback=([^&]+)/.exec(script.src)[1];
  var callbackFunc = eval(callbackName);
  callbackFunc('param1', {some: 'data', another: ['data', 'right', 'here']});
  assertEquals('input was received', 'param1', replyReceived);
  assertEquals('second input was received', 'right',
      replyReceived2.another[1]);

  // Because the callbackFunc calls cleanUp_ and that calls setTimeout which
  // we have overwritten, we have to call the timeoutHandler to actually do
  // the cleaning.
  timeoutHandler();

  checkCleanup();
  timeoutHandler();
}

// Check that send function works correctly when callback param value is
// specified.
function testSendWithCallbackParamValue() {
  var replyReceived;
  var jsonp = new goog.net.Jsonp(fakeUrl);

  var checkCleanup = newCleanupGuard();

  var userCallback = function(data) {
    replyReceived = data;
  }

  var payload = {atisket: 'atasket', basket: 'yellow'};
  var result = jsonp.send(payload, userCallback, undefined, 'dummyId');

  var script = goog.dom.getElement(result.id_);

  assertNotNull('script created', script);
  assertEquals('encoding is utf-8', 'UTF-8', script.charset);

  // Check that the URL matches our payload.
  assertTrue('payload in url', script.src.indexOf('basket=yellow') > -1);
  assertTrue('dummyId in url',
      script.src.indexOf('callback=_callbacks_.dummyId') > -1);
  assertTrue('server url', script.src.indexOf(fakeUrl) == 0);

  // Now, we simulate a returned request using the known callback function
  // name.
  var callbackFunc = _callbacks_.dummyId;
  callbackFunc({some: 'data', another: ['data', 'right', 'here']});
  assertEquals('input was received', 'right', replyReceived.another[1]);

  // Verify that the same callback function does not break if it receives a
  // second unexpected parameter.
  callbackFunc({some: 'data', another: ['data', 'right', 'here']},
      'unexpected');
  assertEquals('input was received', 'right', replyReceived.another[1]);

  // Because the callbackFunc calls cleanUp_ and that calls setTimeout which
  // we have overwritten, we have to call the timeoutHandler to actually do
  // the cleaning.
  timeoutHandler();

  checkCleanup();
  timeoutHandler();
}


// Check that the send function is sane when the thing goes south.
function testSendFailure() {
  var replyReceived = false;
  var errorReplyReceived = false;

  var jsonp = new goog.net.Jsonp(fakeUrl);

  var checkCleanup = newCleanupGuard();

  var userCallback = function(data) {
    replyReceived = data;
  }
  var userErrorCallback = function(data) {
    errorReplyReceived = data;
  }

  var payload = { justa: 'test' };

  jsonp.send(payload, userCallback, userErrorCallback);

  assertTrue('timeout called', timeoutWasCalled);

  // Now, simulate the time running out, so we go into error mode.
  // After jsonp.send(), the timeoutHandler now is the Jsonp.cleanUp_ function.
  timeoutHandler();
  // But that function also calls a setTimeout(), so it changes the timeout
  // handler once again, so to actually clean up we have to call the
  // timeoutHandler() once again. Fun!
  timeoutHandler();

  assertFalse('standard callback not called', replyReceived);

  // The user's error handler should be called back with the same payload
  // passed back to it.
  assertEquals('error handler called', 'test', errorReplyReceived.justa);

  // Check that the relevant cleanup has occurred.
  checkCleanup();
  // Check cleanup just calls setTimeout so we have to call the handler to
  // actually check that the cleanup worked.
  timeoutHandler();
}


// Check that a cancel call works and cleans up after itself.
function testCancel() {
  var checkCleanup = newCleanupGuard();

  var successCalled = false;
  var successCallback = function() {
    successCalled = true;
  };

  // Send and cancel a request, then make sure it was cleaned up.
  var jsonp = new goog.net.Jsonp(fakeUrl);
  var requestObject = jsonp.send({test: 'foo'}, successCallback);
  jsonp.cancel(requestObject);

  for (var key in goog.global[goog.net.Jsonp.CALLBACKS]) {
    assertNotEquals('The success callback should have been removed',
                    goog.global[goog.net.Jsonp.CALLBACKS][key],
                    successCallback);
  }

  // Make sure cancelling removes the script tag
  checkCleanup();
  timeoutHandler();
}

function testPayloadParameters() {
  var checkCleanup = newCleanupGuard();

  var jsonp = new goog.net.Jsonp(fakeUrl);
  var result = jsonp.send({
    'foo': 3,
    'bar': 'baz'
  });

  var script = goog.dom.getElement(result.id_);
  assertEquals('Payload parameters should have been added to url.',
               fakeUrl + '?foo=3&bar=baz',
               script.src);

  checkCleanup();
  timeoutHandler();
}

function testOptionalPayload() {
  var checkCleanup = newCleanupGuard();

  var errorCallback = goog.testing.recordFunction();

  var stubs = new goog.testing.PropertyReplacer();
  stubs.set(goog.global, 'setTimeout', function(errorHandler) {
    errorHandler();
  });

  var jsonp = new goog.net.Jsonp(fakeUrl);
  var result = jsonp.send(null, null, errorCallback);

  var script = goog.dom.getElement(result.id_);
  assertEquals('Parameters should not have been added to url.',
               fakeUrl, script.src);

  var errorCallbackArguments = errorCallback.getLastCall().getArguments();
  assertEquals(1, errorCallbackArguments.length);
  assertNull(errorCallbackArguments[0]);

  checkCleanup();
  stubs.reset();
}

">7 of 7 tests run in 14ms.<br />0 passed, 7 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testCancel<br />Cannot read property 'childNodes' of undefined<br />ERROR in testOptionalPayload<br />Cannot read property 'childNodes' of undefined<br />ERROR in testPayloadParameters<br />Cannot read property 'childNodes' of undefined<br />ERROR in testSend<br />Cannot read property 'childNodes' of undefined<br />ERROR in testSendFailure<br />Cannot read property 'childNodes' of undefined<br />ERROR in testSendWhenCallbackHasTwoParameters<br />Cannot read property 'childNodes' of undefined<br />ERROR in testSendWithCallbackParamValue<br />Cannot read property 'childNodes' of undefined<br /></td></tr>
<tr><td>cookies_test.html</td><td>Fail</td><td> 0 passed, 16 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.net.cookies');
  goog.require('goog.testing.jsunit');



var cookies = goog.net.cookies;
var baseCount = 0;

function checkForCookies() {
  if (!cookies.isEnabled()) {
    var message = 'Cookies must be enabled to run this test.';
    if (location.protocol == 'file:') {
      message += '\nNote that cookies for local files are disabled in some ' +
          'browsers.\nThey can be enabled in Chrome with the ' +
          '--enable-file-cookies flag.';
    }

    fail(message);
  }
}

function setUp() {
  checkForCookies();

  // Make sure there are no cookies set by previous, bad tests.
  cookies.clear();
  baseCount = cookies.getCount();
}

function tearDown() {
  // Clear up after ourselves.
  cookies.clear();
}

function testIsEnabled() {
  // Save static function prior to mocking.
  var isNavigatorCookieEnabled = cookies.isNavigatorCookieEnabled_;
  try {
    cookies.isNavigatorCookieEnabled_ = function() { return true; };
    assertTrue(cookies.isEnabled());
    cookies.isNavigatorCookieEnabled_ = function() { return false; };
    assertFalse(cookies.isEnabled());
  } finally {
    // Restore static function.
    cookies.isNavigatorCookieEnabled_ = isNavigatorCookieEnabled;
  }
}

function testCount() {
  // setUp empties the cookies

  cookies.set('testa', 'A');
  assertEquals(baseCount + 1, cookies.getCount());
  cookies.set('testb', 'B');
  cookies.set('testc', 'C');
  assertEquals(baseCount + 3, cookies.getCount());
  cookies.remove('testa');
  cookies.remove('testb');
  assertEquals(baseCount + 1, cookies.getCount());
  cookies.remove('testc');
  assertEquals(baseCount + 0, cookies.getCount());
}

function testSet() {
  cookies.set('testa', 'testb');
  assertEquals('testb', cookies.get('testa'));
  cookies.remove('testa');
  assertEquals(undefined, cookies.get('testa'));
  // check for invalid characters in name and value
}

function testGetKeys() {
  cookies.set('testa', 'A');
  cookies.set('testb', 'B');
  cookies.set('testc', 'C');
  var keys = cookies.getKeys();
  assertTrue(goog.array.contains(keys, 'testa'));
  assertTrue(goog.array.contains(keys, 'testb'));
  assertTrue(goog.array.contains(keys, 'testc'));
}


function testGetValues() {
  cookies.set('testa', 'A');
  cookies.set('testb', 'B');
  cookies.set('testc', 'C');
  var values = cookies.getValues();
  assertTrue(goog.array.contains(values, 'A'));
  assertTrue(goog.array.contains(values, 'B'));
  assertTrue(goog.array.contains(values, 'C'));
}


function testContainsKey() {
  assertFalse(cookies.containsKey('testa'));
  cookies.set('testa', 'A');
  assertTrue(cookies.containsKey('testa'));
  cookies.set('testb', 'B');
  assertTrue(cookies.containsKey('testb'));
  cookies.remove('testb');
  assertFalse(cookies.containsKey('testb'));
  cookies.remove('testa');
  assertFalse(cookies.containsKey('testa'));
}


function testContainsValue() {
  assertFalse(cookies.containsValue('A'));
  cookies.set('testa', 'A');
  assertTrue(cookies.containsValue('A'));
  cookies.set('testb', 'B');
  assertTrue(cookies.containsValue('B'));
  cookies.remove('testb');
  assertFalse(cookies.containsValue('B'));
  cookies.remove('testa');
  assertFalse(cookies.containsValue('A'));
}


function testIsEmpty() {
  // we cannot guarantee that we have no cookies so testing for the true
  // case cannot be done without a mock document.cookie
  cookies.set('testa', 'A');
  assertFalse(cookies.isEmpty());
  cookies.set('testb', 'B');
  assertFalse(cookies.isEmpty());
  cookies.remove('testb');
  assertFalse(cookies.isEmpty());
  cookies.remove('testa');
}


function testRemove() {
  assertFalse('1. Cookie should not contain "testa"', cookies.containsKey('testa'));
  cookies.set('testa', 'A', undefined, '/');
  assertTrue('2. Cookie should contain "testa"', cookies.containsKey('testa'));
  cookies.remove('testa', '/');
  assertFalse('3. Cookie should not contain "testa"', cookies.containsKey('testa'));

  cookies.set('testa', 'A');
  assertTrue('4. Cookie should contain "testa"', cookies.containsKey('testa'));
  cookies.remove('testa');
  assertFalse('5. Cookie should not contain "testa"', cookies.containsKey('testa'));
}

function testStrangeValue() {
  // This ensures that the pattern key2=value in the value does not match
  // the key2 cookie.
  var value = 'testb=bbb';
  var value2 = 'ccc';

  cookies.set('testa', value);
  cookies.set('testb', value2);

  assertEquals(value, cookies.get('testa'));
  assertEquals(value2, cookies.get('testb'));
}

function testSetCookiePath() {
  assertEquals('foo=bar;path=/xyz',
      mockSetCookie('foo', 'bar', -1, '/xyz'));
}

function testSetCookieDomain() {
  assertEquals('foo=bar;domain=google.com',
      mockSetCookie('foo', 'bar', -1, null, 'google.com'));
}

function testSetCookieSecure() {
  assertEquals('foo=bar;secure',
      mockSetCookie('foo', 'bar', -1, null, null, true));
}

function testSetCookieMaxAgeZero() {
  var result = mockSetCookie('foo', 'bar', 0);
  var pattern = new RegExp(
      'foo=bar;expires=' + new Date(1970, 1, 1).toUTCString());
  if (!result.match(pattern)) {
    fail('expected match against ' + pattern + ' got ' + result);
  }
}

// TODO(chrisn): Testing max age > 0 requires a mock clock.

function mockSetCookie(var_args) {
  var setCookie = cookies.setCookie_;
  try {
    var result;
    cookies.setCookie_ = function(arg) {
      result = arg;
    };
    cookies.set.apply(cookies, arguments);
    return result;
  } finally {
    cookies.setCookie_ = setCookie;
  }
}

function assertValidName(name) {
  assertTrue(name + ' should be valid', cookies.isValidName(name));
}

function assertInvalidName(name) {
  assertFalse(name + ' should be invalid', cookies.isValidName(name));
  assertThrows(function() {
    cookies.set(name, 'value');
  });
}

function assertValidValue(val) {
  assertTrue(val + ' should be valid', cookies.isValidValue(val));
}

function assertInvalidValue(val) {
  assertFalse(val + ' should be invalid', cookies.isValidValue(val));
  assertThrows(function() {
    cookies.set('name', val);
  });
}

function testValidName() {
  assertValidName('foo');
  assertInvalidName('foo bar');
  assertInvalidName('foo=bar');
  assertInvalidName('foo;bar');
  assertInvalidName('foo\nbar');
}

function testValidValue() {
  assertValidValue('foo');
  assertValidValue('foo bar');
  assertValidValue('foo=bar');
  assertInvalidValue('foo;bar');
  assertInvalidValue('foo\nbar');
}

">16 of 16 tests run in 19ms.<br />0 passed, 16 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testContainsKey<br />Call to fail()<br />Cookies must be enabled to run this test.<br />ERROR in testContainsValue<br />Call to fail()<br />Cookies must be enabled to run this test.<br />ERROR in testCount<br />Call to fail()<br />Cookies must be enabled to run this test.<br />ERROR in testGetKeys<br />Call to fail()<br />Cookies must be enabled to run this test.<br />ERROR in testGetValues<br />Call to fail()<br />Cookies must be enabled to run this test.<br />ERROR in testIsEmpty<br />Call to fail()<br />Cookies must be enabled to run this test.<br />ERROR in testIsEnabled<br />Call to fail()<br />Cookies must be enabled to run this test.<br />ERROR in testRemove<br />Call to fail()<br />Cookies must be enabled to run this test.<br />ERROR in testSet<br />Call to fail()<br />Cookies must be enabled to run this test.<br />ERROR in testSetCookieDomain<br />Call to fail()<br />Cookies must be enabled to run this test.<br />ERROR in testSetCookieMaxAgeZero<br />Call to fail()<br />Cookies must be enabled to run this test.<br />ERROR in testSetCookiePath<br />Call to fail()<br />Cookies must be enabled to run this test.<br />ERROR in testSetCookieSecure<br />Call to fail()<br />Cookies must be enabled to run this test.<br />ERROR in testStrangeValue<br />Call to fail()<br />Cookies must be enabled to run this test.<br />ERROR in testValidName<br />Call to fail()<br />Cookies must be enabled to run this test.<br />ERROR in testValidValue<br />Call to fail()<br />Cookies must be enabled to run this test.<br /></td></tr>
<tr><td>channelrequest_test.html</td><td>Success</td><td> 1 passed, 0 failed.</td><td title="

goog.require('goog.net.BrowserChannel');
goog.require('goog.net.ChannelDebug');
goog.require('goog.net.ChannelRequest');
goog.require('goog.testing.jsunit');
goog.require('goog.testing.MockClock');
goog.require('goog.testing.net.XhrIo');



var mockClock;

/**
 * Time to wait for a network request to time out, before aborting.
 */
var WATCHDOG_TIME = 2000;

/**
 * A really long time - used to make sure no more timeouts will fire.
 */
var ALL_DAY_MS = 1000 * 60 * 60 * 24;


function setUp() {
  mockClock = new goog.testing.MockClock();
  mockClock.install();
}


function tearDown() {
  mockClock.uninstall();
}


/**
 * Constructs a duck-type BrowserChannel that tracks the completed requests.
  * @constructor
 */
function MockBrowserChannel() {
  this.createXhrIo = function(domainPrefix) {
    assertNull(domainPrefix);
    var xhrIo = new goog.testing.net.XhrIo();
    xhrIo.abort = xhrIo.abort || function() {
      this.active_ = false;
    };
    return xhrIo;
  }
  this.isClosed = function() {
    return false;
  };
  this.isActive = function() {
    return true;
  };
  this.shouldUseSecondaryDomains = function() {
    return false;
  }
  this.completedRequests = [];
  this.onRequestComplete = function(request) {
    this.completedRequests.push(request);
  };
  this.onRequestData = function(request, data) {};
}


/**
 * Creates a real ChannelRequest object, with some modifications for
 * testability:
 * <ul>
 * <li>The BrowserChannel is a MockBrowserChannel.
 * <li>createXhrIo_() returns the xhrIo that is passed in.
 * <li>The new watchdogTimeoutCallCount property tracks onWatchDogTimeout_()
 *     calls.
 * <li>The timeout is set to WATCHDOG_TIME.
 * </ul>
 * @param {goog.testing.net.XhrIo} xhrIo  A test XhrIo.
 * @return {goog.net.ChannelRequest} A slightly modified ChannelRequest
 */
function createChannelRequest(xhrIo) {
  // Install mock browser channel and no-op debug logger.
  var req = new goog.net.ChannelRequest(
      new MockBrowserChannel(),
      new goog.net.ChannelDebug());

  // Install test XhrIo.
  req.createXhrIo_ = function() {
    return xhrIo;
  };

  // Install watchdogTimeoutCallCount.
  req.watchdogTimeoutCallCount = 0;
  req.originalOnWatchDogTimeout = req.onWatchDogTimeout_;
  req.onWatchDogTimeout_ = function() {
    this.watchdogTimeoutCallCount++;
    return this.originalOnWatchDogTimeout();
  };

  req.setTimeout(WATCHDOG_TIME);

  return req;
}


/**
 * Creates a test XhrIo, with the abort() method defined.
 * @return {goog.testing.net.XhrIo} A test XhrIo.
 */
function createXhrIo() {
  var xhrIo = new goog.testing.net.XhrIo();
  xhrIo.abort = xhrIo.abort || function() {
    this.active_ = false;
  };
  return xhrIo;
}


/**
 * Make sure that the request "completes" with an error when the timeout
 * expires.
 */
function testRequestTimeout() {
  var xhrIo = createXhrIo();
  var req = createChannelRequest(xhrIo);

  req.xmlHttpPost(new goog.Uri('some_uri'), 'some_postdata', true);
  assertEquals(0, req.watchdogTimeoutCallCount);
  assertEquals(0, req.channel_.completedRequests.length);

  // Watchdog timeout.
  mockClock.tick(WATCHDOG_TIME);
  assertEquals(1, req.watchdogTimeoutCallCount);
  assertEquals(1, req.channel_.completedRequests.length);
  assertFalse(req.getSuccess());

  // Make sure no more timers are firing.
  mockClock.tick(ALL_DAY_MS);
  assertEquals(1, req.watchdogTimeoutCallCount);
  assertEquals(1, req.channel_.completedRequests.length);
}

">n/a</td></tr>
<tr><td>iframeloadmonitor_test.html</td><td>Fail</td><td> undefined</td><td title="

    goog.require('goog.dom');
    goog.require('goog.events');
    goog.require('goog.net.IframeLoadMonitor');
    goog.require('goog.testing.AsyncTestCase');
    goog.require('goog.testing.jsunit');
  

  var TEST_FRAME_SRCS = ['iframeloadmonitor_test_frame.html',
      'iframeloadmonitor_test_frame2.html',
      'iframeloadmonitor_test_frame3.html'];

  // Create a new test case.
  var iframeLoaderTestCase = new goog.testing.AsyncTestCase(document.title);
  iframeLoaderTestCase.stepTimeout = 4 * 1000;

  // Array holding all iframe load monitors.
  iframeLoaderTestCase.iframeLoadMonitors_ = [];

  // How many single frames finished loading
  iframeLoaderTestCase.singleComplete_ = 0;

  /** Sets up the test environment, adds tests and sets up the worker pools. */
  iframeLoaderTestCase.setUpPage = function() {
    this.log('Setting tests up');
    iframeLoaderTestCase.waitForAsync('loading iframes');

    var dom = goog.dom.getDomHelper();

    // Load single frame
    var frame = dom.createDom('iframe');
    this.iframeLoadMonitors_.push(new goog.net.IframeLoadMonitor(frame));
    goog.events.listen(this.iframeLoadMonitors_[0],
        goog.net.IframeLoadMonitor.LOAD_EVENT, this);
    var frameParent = dom.getElement('frame_parent');
    dom.appendChild(frameParent, frame);
    this.log('Loading frame at: ' + TEST_FRAME_SRCS[0]);
    frame.src = TEST_FRAME_SRCS[0];

    // Load single frame with content check
    var frame1 = dom.createDom('iframe');
    this.iframeLoadMonitors_.push(new goog.net.IframeLoadMonitor(frame1, true));
    goog.events.listen(this.iframeLoadMonitors_[1],
        goog.net.IframeLoadMonitor.LOAD_EVENT, this);
    var frameParent = dom.getElement('frame_parent');
    dom.appendChild(frameParent, frame1);
    this.log('Loading frame with content check at: ' + TEST_FRAME_SRCS[0]);
    frame1.src = TEST_FRAME_SRCS[0];

    this.add(new goog.testing.TestCase.Test(
        'test results', this.testResults, this));
  };


  /** Handles any events fired */
  iframeLoaderTestCase.handleEvent = function(e) {
    this.log('handleEvent, type: ' + e.type);
    if (e.type == goog.net.IframeLoadMonitor.LOAD_EVENT) {
      this.singleComplete_++;
      this.callbacksComplete();
    }
  };

  /** Checks if all the load callbacks are done*/
  iframeLoaderTestCase.callbacksComplete = function() {
    if (this.singleComplete_ == 2) {
      iframeLoaderTestCase.continueTesting();
    }
  }

  /** Tests the results. */
  iframeLoaderTestCase.testResults = function() {
    this.log('getting test results');
    for (var i = 0; i < this.iframeLoadMonitors_.length; i++) {
      assertTrue(this.iframeLoadMonitors_[i].isLoaded());
    }
  };

  /** Used by the JsUnit test runner. */
  function testResults() {
    iframeLoaderTestCase.testResults();
  }

  /** Used by the JsUnit test runner. */
  function setUpPage() {
    iframeLoaderTestCase.runTests();
  }

  /** Standalone Closure Test Runner. */
  if (typeof G_testRunner != 'undefined') {
    G_testRunner.initialize(iframeLoaderTestCase);
  }

">TypeError: Cannot set property 'name_' of undefined
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:426:44)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
    at Module.load (module.js:219:31)
    at Function._load (module.js:186:10)
    at require (module.js:231:19)
</td></tr>
<tr><td>networktester_test.html</td><td>Success</td><td> 8 passed, 0 failed.</td><td title="

  goog.require('goog.Uri')
  goog.require('goog.net.NetworkTester');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.jsunit');


  var clock;

  function setUp() {
    clock = new goog.testing.MockClock(true);
  }

  function tearDown() {
    clock.dispose();
  }

  function testSuccess() {
    // set up the tster
    var handler = new Handler();
    var tester = new goog.net.NetworkTester(handler.callback, handler);
    assertFalse(tester.isRunning());
    tester.start();
    assertTrue(handler.isEmpty());
    assertTrue(tester.isRunning());

    // simulate the image load and verify
    var image = tester.image_;
    assertEquals(String(tester.getUri()), image.src);
    assertTrue(handler.isEmpty());
    image.onload.call(null);
    assertTrue(handler.dequeue());
    assertFalse(tester.isRunning());
  }

  function testFailure() {
    // set up the tester
    var handler = new Handler();
    var tester = new goog.net.NetworkTester(handler.callback, handler);
    assertFalse(tester.isRunning());
    tester.start();
    assertTrue(handler.isEmpty());
    assertTrue(tester.isRunning());

    // simulate the image failure and verify
    var image = tester.image_;
    assertEquals(String(tester.getUri()), image.src);
    assertTrue(handler.isEmpty());
    image.onerror.call(null);
    assertFalse(handler.dequeue());
    assertFalse(tester.isRunning());
  }

  function testAbort() {
    // set up the tester
    var handler = new Handler();
    var tester = new goog.net.NetworkTester(handler.callback, handler);
    assertFalse(tester.isRunning());
    tester.start();
    assertTrue(handler.isEmpty());
    assertTrue(tester.isRunning());

    // simulate the image abort and verify
    var image = tester.image_;
    assertEquals(String(tester.getUri()), image.src);
    assertTrue(handler.isEmpty());
    image.onabort.call(null);
    assertFalse(handler.dequeue());
    assertFalse(tester.isRunning());
  }

  function testTimeout() {
    // set up the tester
    var handler = new Handler();
    var tester = new goog.net.NetworkTester(handler.callback, handler);
    assertFalse(tester.isRunning());
    tester.start();
    assertTrue(handler.isEmpty());
    assertTrue(tester.isRunning());

    // simulate the image timeout and verify
    var image = tester.image_;
    assertEquals(String(tester.getUri()), image.src);
    assertTrue(handler.isEmpty());
    clock.tick(10000);
    assertFalse(handler.dequeue());
    assertFalse(tester.isRunning());
  }

  function testRetries() {
    // set up the tester
    var handler = new Handler();
    var tester = new goog.net.NetworkTester(handler.callback, handler);
    tester.setNumRetries(1);
    assertFalse(tester.isRunning());
    tester.start();
    assertTrue(handler.isEmpty());
    assertTrue(tester.isRunning());

    // try number 1 fails
    var image = tester.image_;
    assertEquals(String(tester.getUri()), image.src);
    assertTrue(handler.isEmpty());
    image.onerror.call(null);
    assertTrue(handler.isEmpty());
    assertTrue(tester.isRunning());

    // try number 2 succeeds
    image = tester.image_;
    assertEquals(String(tester.getUri()), image.src);
    assertTrue(handler.isEmpty());
    image.onload.call(null);
    assertTrue(handler.dequeue());
    assertFalse(tester.isRunning());
  }

  function testPauseBetweenRetries() {
    // set up the tester
    var handler = new Handler();
    var tester = new goog.net.NetworkTester(handler.callback, handler);
    tester.setNumRetries(1);
    tester.setPauseBetweenRetries(1000);
    assertFalse(tester.isRunning());
    tester.start();
    assertTrue(handler.isEmpty());
    assertTrue(tester.isRunning());

    // try number 1 fails
    var image = tester.image_;
    assertEquals(String(tester.getUri()), image.src);
    assertTrue(handler.isEmpty());
    image.onerror.call(null);
    assertTrue(handler.isEmpty());
    assertTrue(tester.isRunning());

    // need to pause 1000 ms for the second attempt
    assertNull(tester.image_);
    clock.tick(1000);

    // try number 2 succeeds
    image = tester.image_;
    assertEquals(String(tester.getUri()), image.src);
    assertTrue(handler.isEmpty());
    image.onload.call(null);
    assertTrue(handler.dequeue());
    assertFalse(tester.isRunning());
  }

  function testNonDefaultUri() {
    var handler = new Handler();
    var newUri = new goog.Uri('//www.google.com/images/cleardot2.gif');
    var tester = new goog.net.NetworkTester(handler.callback, handler, newUri);
    var testerUri = tester.getUri();
    assertTrue(testerUri.toString().indexOf('cleardot2') > -1);
  }

  function testOffline() {

    // set up the tester
    var handler = new Handler();
    var tester = new goog.net.NetworkTester(handler.callback, handler);
    var orgGetNavigatorOffline = goog.net.NetworkTester.getNavigatorOffline_;
    goog.net.NetworkTester.getNavigatorOffline_ = function() {
      return true;
    };
    try {
      assertFalse(tester.isRunning());
      tester.start();
      assertTrue(handler.isEmpty());
      assertTrue(tester.isRunning());

      // the call is done async
      clock.tick(1);

      assertFalse(handler.dequeue());
      assertFalse(tester.isRunning());
    } finally {
      // Clean up!
      goog.net.NetworkTester.getNavigatorOffline_ = orgGetNavigatorOffline;
    }
  }

  // Handler object for verifying callback
  function Handler() {
    this.events_ = [];
  };

  Handler.prototype.callback = function(result) {
    this.events_.push(result);
  };

  Handler.prototype.isEmpty = function() {
    return this.events_.length == 0;
  }

  Handler.prototype.dequeue = function() {
    if (this.isEmpty()) {
      throw Error("Handler is empty");
    }
    return this.events_.shift();
  };

  // override image constructor for test - can't use a real image due to
  // async load of images - have to simulate it
  function Image() {
  }


">n/a</td></tr>
<tr><td>xhrlite_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="

  goog.require('goog.debug.ErrorHandler');
  goog.require('goog.net.WrapperXmlHttpFactory');
  goog.require('goog.net.XhrLite');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.jsunit');



function MockXmlHttp() {}

MockXmlHttp.prototype.readyState = goog.net.XmlHttp.ReadyState.UNINITIALIZED;

MockXmlHttp.prototype.status = 200;

MockXmlHttp.syncSend = false;

MockXmlHttp.prototype.send = function(opt_data) {
  this.readyState = goog.net.XmlHttp.ReadyState.UNINITIALIZED;

  if (MockXmlHttp.syncSend) {
    this.complete();
  }

};

MockXmlHttp.prototype.complete = function() {
  this.readyState = goog.net.XmlHttp.ReadyState.LOADING;
  this.onreadystatechange();

  this.readyState = goog.net.XmlHttp.ReadyState.LOADED;
  this.onreadystatechange();

  this.readyState = goog.net.XmlHttp.ReadyState.INTERACTIVE;
  this.onreadystatechange();

  this.readyState = goog.net.XmlHttp.ReadyState.COMPLETE;
  this.onreadystatechange();
};


MockXmlHttp.prototype.open = function(verb, uri, async) {
};

MockXmlHttp.prototype.abort = function() {};

MockXmlHttp.prototype.setRequestHeader = function(key, value) {};

goog.net.XmlHttp.setGlobalFactory(new goog.net.WrapperXmlHttpFactory(
    function() {
      return new MockXmlHttp();
    },
    function() {
      return {};
    }));

var clock;

function setUp() {
  clock = new goog.testing.MockClock(true);
}

function tearDown() {
  clock.dispose();
}


function testSyncSend() {
  MockXmlHttp.syncSend = true;
  var count = 0;

  var x = new goog.net.XhrLite;
  goog.events.listen(x, goog.net.EventType.COMPLETE, function(e) {
    assertFalse('Should not fire complete from inside send', inSend);
    assertTrue('Should be succesful', e.target.isSuccess());
    count++;

  });

  var inSend = true;
  x.send('url');
  inSend = false;

  clock.tick(1); // callOnce(f, 0, ...)

  assertEquals('Complete should have been called once', 1, count);
}

function testSyncSendFailure() {
  MockXmlHttp.syncSend = true;
  var count = 0;

  var x = new goog.net.XhrLite;
  goog.events.listen(x, goog.net.EventType.COMPLETE, function(e) {
    assertFalse('Should not fire complete from inside send', inSend);
    assertFalse('Should not be succesful', e.target.isSuccess());
    count++;
  });

  var inSend = true;
  x.send('url');
  x.xhr_.status = 404;
  inSend = false;

  clock.tick(1); // callOnce(f, 0, ...)

  assertEquals('Complete should have been called once', 1, count);
}


function testProtectEntryPointCalledOnAsyncSend() {
  MockXmlHttp.syncSend = false;

  var errorHandlerCallbackCalled = false;
  var errorHandler = new goog.debug.ErrorHandler(function() {
    errorHandlerCallbackCalled = true;
  });

  goog.net.XhrLite.protectEntryPoints(errorHandler);

  var x = new goog.net.XhrLite;
  goog.events.listen(x, goog.net.EventType.READY_STATE_CHANGE, function(e) {
    throw Error();
  });

  x.send('url');
  assertThrows(function() {
    x.xhr_.complete();
  });

  assertTrue('Error handler callback should be called on async send.',
      errorHandlerCallbackCalled);
}


">n/a</td></tr>
<tr><td>xhrio_test.html</td><td>Fail</td><td> 8 passed, 3 failed.</td><td title="

  goog.require('goog.dom.xml');
  goog.require('goog.events');
  goog.require('goog.events.Event');
  goog.require('goog.net.EventType');
  goog.require('goog.testing.asserts');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.net.XhrIo');
  goog.require('goog.testing.mockmatchers.InstanceOf');
  goog.require('goog.testing.MockControl');



var mockControl;

function setUp() {
  mockControl = new goog.testing.MockControl();
}

function testStaticSend() {
  sendInstances = goog.testing.net.XhrIo.getSendInstances();
  goog.testing.net.XhrIo.send('url');
  assertEquals('sendInstances_ after send',
               1, sendInstances.length);
  xhr = sendInstances[sendInstances.length - 1];
  assertTrue('isActive after request', xhr.isActive());
  assertEquals('readyState after request',
               goog.net.XmlHttp.ReadyState.LOADING,
               xhr.getReadyState());

  xhr.simulateResponse(200, '');
  assertFalse('isActive after response', xhr.isActive());
  assertEquals('readyState after response',
               goog.net.XmlHttp.ReadyState.COMPLETE,
               xhr.getReadyState());

  xhr.simulateReady();
  assertEquals('sendInstances_ after READY',
               0, sendInstances.length);
}

function testMultipleSend() {
  var xhr = new goog.testing.net.XhrIo();
  assertFalse('isActive before first request', xhr.isActive());
  assertEquals('readyState before first request',
               goog.net.XmlHttp.ReadyState.UNINITIALIZED,
               xhr.getReadyState());

  xhr.send('url');
  assertTrue('isActive after first request', xhr.isActive());
  assertEquals('readyState after first request',
               goog.net.XmlHttp.ReadyState.LOADING,
               xhr.getReadyState());

  xhr.simulateResponse(200, '');
  assertFalse('isActive after first response', xhr.isActive());
  assertEquals('readyState after first response',
               goog.net.XmlHttp.ReadyState.COMPLETE,
               xhr.getReadyState());

  xhr.send('url');
  assertTrue('isActive after second request', xhr.isActive());
  assertEquals('readyState after second request',
               goog.net.XmlHttp.ReadyState.LOADING,
               xhr.getReadyState());
}

function testGetLastUri() {
  var xhr = new goog.testing.net.XhrIo();
  assertEquals('nothing sent yet, empty URI', '', xhr.getLastUri());

  var requestUrl = 'http://www.example.com/';
  xhr.send(requestUrl);
  assertEquals('message sent, URI saved', requestUrl, xhr.getLastUri());
}

function testGetResponseText() {
  // Text response came.
  var called = false;
  var xhr = new goog.testing.net.XhrIo();
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, function(e) {
    called = true;
    assertEquals('text', e.target.getResponseText());
  });
  xhr.simulateResponse(200, 'text');
  assertTrue(called);

  // XML response came.
  var called = false;
  var xhr = new goog.testing.net.XhrIo();
  var xml = goog.dom.xml.createDocument();
  xml.appendChild(xml.createElement('root'));
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, function(e) {
    called = true;
    var text = e.target.getResponseText();
    assertTrue(/<root ?\/>/.test(text));
  });
  xhr.simulateResponse(200, xml);
  assertTrue(called);
}

function testGetResponseJson() {
  // Valid JSON response came.
  var called = false;
  var xhr = new goog.testing.net.XhrIo();
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, function(e) {
    called = true;
    assertArrayEquals([0, 1], e.target.getResponseJson());
  });
  xhr.simulateResponse(200, '[0, 1]');
  assertTrue(called);

  // Valid JSON response with XSSI prefix encoded came.
  var called = false;
  var xhr = new goog.testing.net.XhrIo();
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, function(e) {
    called = true;
    assertArrayEquals([0, 1], e.target.getResponseJson(')]}\', \n'));
  });
  xhr.simulateResponse(200, ')]}\', \n[0, 1]');
  assertTrue(called);

  // Invalid JSON response came.
  var called = false;
  var xhr = new goog.testing.net.XhrIo();
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, function(e) {
    called = true;
    assertThrows(e.target.getResponseJson);
  });
  xhr.simulateResponse(200, '[0, 1');
  assertTrue(called);

  // XML response came.
  var called = false;
  var xhr = new goog.testing.net.XhrIo();
  var xml = goog.dom.xml.createDocument();
  xml.appendChild(xml.createElement('root'));
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, function(e) {
    called = true;
    assertThrows(e.target.getResponseJson);
  });
  xhr.simulateResponse(200, xml);
  assertTrue(called);
}

function testGetResponseXml() {
  // Text response came.
  var called = false;
  var xhr = new goog.testing.net.XhrIo();
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, function(e) {
    called = true;
    assertNull(e.target.getResponseXml());
  });
  xhr.simulateResponse(200, 'text');
  assertTrue(called);

  // XML response came.
  var called = false;
  var xhr = new goog.testing.net.XhrIo();
  var xml = goog.dom.xml.createDocument();
  xml.appendChild(xml.createElement('root'));
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, function(e) {
    called = true;
    assertEquals(xml, e.target.getResponseXml());
  });
  xhr.simulateResponse(200, xml);
  assertTrue(called);
}

function testGetResponseHeaders_noHeadersPresent() {
  var xhr = new goog.testing.net.XhrIo();
  var mockListener = mockControl.createFunctionMock();
  mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event))
      .$does(function(e) {
    assertTrue(e.type == goog.net.EventType.SUCCESS);
    assertUndefined(e.target.getResponseHeader('XHR'));
  });
  mockControl.$replayAll();
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, mockListener);
  xhr.simulateResponse(200, '');

  mockControl.$verifyAll();
  mockControl.$resetAll();
}

function testGetResponseHeaders_headersPresent() {
  var xhr = new goog.testing.net.XhrIo();
  var mockListener = mockControl.createFunctionMock();
  mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event))
      .$does(function(e) {
    assertTrue(e.type == goog.net.EventType.SUCCESS);
    assertUndefined(e.target.getResponseHeader('XHR'));
    assertEquals(e.target.getResponseHeader('Pragma'), 'no-cache');
  });
  mockControl.$replayAll();
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, mockListener);
  xhr.simulateResponse(200, '', {'Pragma': 'no-cache'});

  mockControl.$verifyAll();
  mockControl.$resetAll();
}

function testAbort_WhenNoPendingSentRequests() {
  var xhr = new goog.testing.net.XhrIo();
  var eventListener = mockControl.createFunctionMock();
  mockControl.$replayAll();

  goog.events.listen(xhr, goog.net.EventType.COMPLETE, eventListener);
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, eventListener);
  goog.events.listen(xhr, goog.net.EventType.ABORT, eventListener);
  goog.events.listen(xhr, goog.net.EventType.ERROR, eventListener);
  goog.events.listen(xhr, goog.net.EventType.READY, eventListener);

  xhr.abort();

  mockControl.$verifyAll();
  mockControl.$resetAll();
}

function testAbort_PendingSentRequest() {
  var xhr = new goog.testing.net.XhrIo();
  var mockListener = mockControl.createFunctionMock();

  mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event))
  .$does(function(e) {
    assertTrue(e.type == goog.net.EventType.COMPLETE);
    assertObjectEquals(e.target, xhr);
    assertEquals(e.target.getLastErrorCode(), goog.net.ErrorCode.ABORT);
    assertTrue(e.target.isActive());
  });
  mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event))
  .$does(function(e) {
    assertTrue(e.type == goog.net.EventType.ABORT);
    assertObjectEquals(e.target, xhr);
    assertTrue(e.target.isActive());
  });
  mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event))
  .$does(function(e) {
    assertTrue(e.type == goog.net.EventType.READY);
    assertObjectEquals(e.target, xhr);
    assertFalse(e.target.isActive());
  });
  mockControl.$replayAll();

  goog.events.listen(xhr, goog.net.EventType.COMPLETE, mockListener);
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, mockListener);
  goog.events.listen(xhr, goog.net.EventType.ABORT, mockListener);
  goog.events.listen(xhr, goog.net.EventType.ERROR, mockListener);
  goog.events.listen(xhr, goog.net.EventType.READY, mockListener);
  xhr.send('dummyurl');
  xhr.abort();

  mockControl.$verifyAll();
  mockControl.$resetAll();
}

function testEvents_Success() {
  var xhr = new goog.testing.net.XhrIo();
  var mockListener = mockControl.createFunctionMock();

  var readyState = goog.net.XmlHttp.ReadyState.UNINITIALIZED;
  function readyStateListener(e) {
    assertEquals(e.type, goog.net.EventType.READY_STATE_CHANGE);
    assertObjectEquals(e.target, xhr);
    readyState++;
    assertEquals(e.target.getReadyState(), readyState);
    assertTrue(e.target.isActive());
  }

  mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event))
  .$does(function(e) {
    assertEquals(e.type, goog.net.EventType.COMPLETE);
    assertObjectEquals(e.target, xhr);
    assertEquals(e.target.getLastErrorCode(), goog.net.ErrorCode.NO_ERROR);
    assertTrue(e.target.isActive());
  });
  mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event))
  .$does(function(e) {
    assertEquals(e.type, goog.net.EventType.SUCCESS);
    assertObjectEquals(e.target, xhr);
    assertTrue(e.target.isActive());
  });
  mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event))
  .$does(function(e) {
    assertEquals(e.type, goog.net.EventType.READY);
    assertObjectEquals(e.target, xhr);
    assertFalse(e.target.isActive());
  });
  mockControl.$replayAll();

  goog.events.listen(xhr, goog.net.EventType.READY_STATE_CHANGE,
      readyStateListener);
  goog.events.listen(xhr, goog.net.EventType.COMPLETE, mockListener);
  goog.events.listen(xhr, goog.net.EventType.SUCCESS, mockListener);
  goog.events.listen(xhr, goog.net.EventType.ABORT, mockListener);
  goog.events.listen(xhr, goog.net.EventType.ERROR, mockListener);
  goog.events.listen(xhr, goog.net.EventType.READY, mockListener);
  xhr.send('dummyurl');
  xhr.simulateResponse(200, null);

  mockControl.$verifyAll();
  mockControl.$resetAll();
}

">11 of 11 tests run in 15ms.<br />8 passed, 3 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testGetResponseJson<br />Your browser does not support creating new documents<br />ERROR in testGetResponseText<br />Your browser does not support creating new documents<br />ERROR in testGetResponseXml<br />Your browser does not support creating new documents<br /></td></tr>
<tr><td>browserchannel_test.html</td><td>Fail</td><td> 37 passed, 8 failed.</td><td title="

  goog.require('goog.Timer');
  goog.require('goog.dom');
  goog.require('goog.json');
  goog.require('goog.net.ChannelRequest');
  goog.require('goog.net.BrowserChannel');
  goog.require('goog.net.ChannelRequest');
  goog.require('goog.net.tmpnetwork');
  goog.require('goog.string.StringBuffer');
  goog.require('goog.structs.Map');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.asserts');
  goog.require('goog.testing.jsunit');



/**
 * Delay between a network failure and the next network request.
 */
var RETRY_TIME = 1000;

/**
 * A really long time - used to make sure no more timeouts will fire.
 */
var ALL_DAY_MS = 1000 * 60 * 60 * 24;

var browserChannel;
var handler;
var mockClock;
var sb;
var gotError;
var numStatEvents;
var lastStatEvent;
var numTimingEvents;
var lastPostSize;
var lastPostRtt;
var lastPostRetryCount;
var defaultAllowEarlyNonBuffered;

// Set to true to see the channel debug output in the browser window.
var debug = false;

function debugToWindow(message) {
  if (debug) {
    sb.append(message + '<br>');
    goog.dom.getElement('debug').innerHTML = sb.toString();
  }
}


/**
 * Mock ChannelRequest.
 */
function MockChannelRequest() {}
MockChannelRequest = function(channel, channelDebug, opt_sessionId,
    opt_requestId, opt_retryId) {
  this.channel_ = channel;
  this.channelDebug_ = channelDebug;
  this.sessionId_ = opt_sessionId;
  this.requestId_ = opt_requestId;
  this.successful_ = true;
  this.lastError_ = null;
  this.lastStatusCode_ = 200;

  // For debugging, keep track of whether this is a back or forward channel.
  this.isBack = !!(opt_requestId == 'rpc');
  this.isForward = !this.isBack;
};

MockChannelRequest.prototype.postData_ = null;

MockChannelRequest.prototype.requestStartTime_ = null;

MockChannelRequest.prototype.setExtraHeaders = function(extraHeaders) {};

MockChannelRequest.prototype.setTimeout = function(timeout) {};

MockChannelRequest.prototype.xmlHttpPost = function(uri, postData,
    decodeChunks) {
  this.channelDebug_.debug('---> POST: ' + uri + ', ' + postData + ', ' +
      decodeChunks);
  this.postData_ = postData;
  this.requestStartTime_ = goog.now()
};

MockChannelRequest.prototype.xmlHttpGet = function(uri, decodeChunks,
    opt_noClose) {
  this.channelDebug_.debug('<--- GET: ' + uri + ', ' + decodeChunks + ', ' +
      opt_noClose);
  this.requestStartTime_ = goog.now()
};

MockChannelRequest.prototype.tridentGet = function(uri, usingSecondaryDomain) {
  this.channelDebug_.debug('<---GET (T): ' + uri);
  this.requestStartTime_ = goog.now()
};

MockChannelRequest.prototype.sendUsingImgTag = function(uri) {
  this.requestStartTime_ = goog.now()
};

MockChannelRequest.prototype.cancel = function() {
  this.successful_ = false;
};

MockChannelRequest.prototype.getSuccess = function() {
  return this.successful_;
};

MockChannelRequest.prototype.getLastError = function() {
  return this.lastError_;
};

MockChannelRequest.prototype.getLastStatusCode = function() {
  return this.lastStatusCode_;
};

MockChannelRequest.prototype.getSessionId = function() {
  return this.sessionId_;
};

MockChannelRequest.prototype.getRequestId = function() {
  return this.requestId_;
};

MockChannelRequest.prototype.getPostData = function() {
  return this.postData_;
};

MockChannelRequest.prototype.getRequestStartTime = function() {
  return this.requestStartTime_;
};


function setUpPage() {
  // Use our MockChannelRequests instead of the real ones.
  goog.net.BrowserChannel.createChannelRequest = function(
      channel, channelDebug, opt_sessionId, opt_requestId, opt_retryId) {
    return new MockChannelRequest(
        channel, channelDebug, opt_sessionId, opt_requestId, opt_retryId);
  };
  sb = new goog.string.StringBuffer();

  // Mock out the stat notification code.
  goog.net.BrowserChannel.notifyStatEvent = function(stat) {
    numStatEvents++;
    lastStatEvent = stat;
  };

  goog.net.BrowserChannel.notifyTimingEvent = function(size, rtt, retries) {
    numTimingEvents++;
    lastPostSize = size;
    lastPostRtt = rtt;
    lastPostRetryCount = retries;
  };
}


function setUp() {
  defaultAllowEarlyNonBuffered =
      goog.net.BrowserTestChannel.ALLOW_EARLY_NON_BUFFERED_DETECTION;

  numTimingEvents = 0;
  lastPostSize = null;
  lastPostRtt = null;
  lastPostRetryCount = null;

  mockClock = new goog.testing.MockClock(true);
  browserChannel = new goog.net.BrowserChannel('1');
  gotError = false;

  handler = new goog.net.BrowserChannel.Handler();
  handler.channelOpened = function() {};
  handler.channelError = function(channel, error) {
    gotError = true;
  };
  handler.channelClosed = function(
      channel, opt_pendingMaps, opt_undeliveredMaps) {
    // Mock out the handler, and let it set a formatted user readable string
    // of the undelivered maps which we can use when verifying our assertions.
    if (opt_pendingMaps) {
      this.pendingMapsString = formatArrayOfMaps(opt_pendingMaps);
    }
    if (opt_undeliveredMaps) {
      this.undeliveredMapsString = formatArrayOfMaps(opt_undeliveredMaps);
    }
  };
  handler.channelHandleMultipleArrays = function() {};
  handler.channelHandleArray = function() {};

  browserChannel.setHandler(handler);

  // Provide a predictable retry time for testing.
  browserChannel.getRetryTime_ = function(retryCount) {
    return RETRY_TIME;
  };

  var channelDebug = new goog.net.ChannelDebug();
  channelDebug.debug = function(message) {
    debugToWindow(message);
  };
  browserChannel.setChannelDebug(channelDebug);

  numStatEvents = 0;
  lastStatEvent = null;
}


function tearDown() {
  mockClock.dispose();
  debugToWindow('<hr>');
  goog.net.BrowserTestChannel.ALLOW_EARLY_NO_BUFFER_DETECTION =
      defaultAllowEarlyNonBuffered;
}


/**
 * Helper function to return a formatted string representing an array of maps.
 */
function formatArrayOfMaps(arrayOfMaps) {
  var result = [];
  for (var i = 0; i < arrayOfMaps.length; i++) {
    var map = arrayOfMaps[i];
    var keys = map.map.getKeys();
    for (var j = 0; j < keys.length; j++) {
      result.push(keys[j] + ':' + map.map.get(keys[j]));
    }
  }
  return result.join(', ');
}


function testFormatArrayOfMaps() {
  // This function is used in a non-trivial test, so let's verify that it works.
  var map1 = new goog.structs.Map();
  map1.set('k1', 'v1');
  map1.set('k2', 'v2');
  var map2 = new goog.structs.Map();
  map2.set('k3', 'v3');
  var map3 = new goog.structs.Map();
  map3.set('k4', 'v4');
  map3.set('k5', 'v5');
  map3.set('k6', 'v6');

  // One map.
  var a = [];
  a.push(new goog.net.BrowserChannel.QueuedMap(0, map1));
  assertEquals('k1:v1, k2:v2',
      formatArrayOfMaps(a));

  // Many maps.
  var b = [];
  b.push(new goog.net.BrowserChannel.QueuedMap(0, map1));
  b.push(new goog.net.BrowserChannel.QueuedMap(0, map2));
  b.push(new goog.net.BrowserChannel.QueuedMap(0, map3));
  assertEquals('k1:v1, k2:v2, k3:v3, k4:v4, k5:v5, k6:v6',
      formatArrayOfMaps(b));
}


function connect(opt_serverVersion, opt_hostPrefix) {
  browserChannel.connect('/test', '/bind', null);
  mockClock.tick(0);
  completeTestConnection();
  completeForwardChannel(opt_serverVersion, opt_hostPrefix);
  completeBackChannel();
}


function disconnect() {
  browserChannel.disconnect();
  mockClock.tick(0);
}


function completeTestConnection() {
  completeForwardTestConnection();
  completeBackTestConnection();
  assertEquals(goog.net.BrowserChannel.State.OPENING,
      browserChannel.getState());
}


function completeForwardTestConnection() {
  browserChannel.connectionTest_.onRequestData(
      browserChannel.connectionTest_,
      '["b"]');
  browserChannel.connectionTest_.onRequestComplete(
      browserChannel.connectionTest_);
  mockClock.tick(0);
}


function completeBackTestConnection() {
  browserChannel.connectionTest_.onRequestData(
      browserChannel.connectionTest_,
      '11111');
  if (!goog.net.BrowserTestChannel.ALLOW_EARLY_NON_BUFFERED_DETECTION) {
    mockClock.tick(201);
    browserChannel.connectionTest_.onRequestData(
        browserChannel.connectionTest_,
        '2');
    browserChannel.connectionTest_.onRequestComplete(
        browserChannel.connectionTest_);
  }
  mockClock.tick(0);
}


function completeForwardChannel(opt_serverVersion, opt_hostPrefix) {
  var responseData = '[[0,["c","1234567890ABCDEF",' +
      (opt_hostPrefix ? '"' + opt_hostPrefix + '"' : 'null') +
      (opt_serverVersion ? ',' + opt_serverVersion : '') +
      ']]]';
  browserChannel.onRequestData(
      browserChannel.forwardChannelRequest_,
      responseData);
  browserChannel.onRequestComplete(
      browserChannel.forwardChannelRequest_);
  mockClock.tick(0);
}


function completeBackChannel() {
  browserChannel.onRequestData(
      browserChannel.backChannelRequest_,
      '[[1,["foo"]]]');
  browserChannel.onRequestComplete(
      browserChannel.backChannelRequest_);
  mockClock.tick(0);
}


function responseVersion7() {
  browserChannel.onRequestData(
      browserChannel.forwardChannelRequest_,
      goog.net.BrowserChannel.MAGIC_RESPONSE_COOKIE);
  browserChannel.onRequestComplete(
      browserChannel.forwardChannelRequest_);
  mockClock.tick(0);
}

function responseNoBackchannel(lastArrayIdSentFromServer, outstandingDataSize) {
  responseData = goog.json.serialize(
      [0, lastArrayIdSentFromServer, outstandingDataSize]);
  browserChannel.onRequestData(
      browserChannel.forwardChannelRequest_,
      responseData);
  browserChannel.onRequestComplete(
      browserChannel.forwardChannelRequest_);
  mockClock.tick(0);
}

function response(lastArrayIdSentFromServer, outstandingDataSize) {
  responseData = goog.json.serialize(
      [1, lastArrayIdSentFromServer, outstandingDataSize]);
  browserChannel.onRequestData(
      browserChannel.forwardChannelRequest_,
      responseData
      );
  browserChannel.onRequestComplete(
      browserChannel.forwardChannelRequest_);
  mockClock.tick(0);
}


function receive(data) {
  browserChannel.onRequestData(
      browserChannel.backChannelRequest_,
      '[[1,' + data + ']]');
  browserChannel.onRequestComplete(
      browserChannel.backChannelRequest_);
  mockClock.tick(0);
}


function responseTimeout() {
  browserChannel.forwardChannelRequest_lastError_ =
      goog.net.ChannelRequest.Error.TIMEOUT;
  browserChannel.forwardChannelRequest_.successful_ = false;
  browserChannel.onRequestComplete(
      browserChannel.forwardChannelRequest_);
  mockClock.tick(0);
}


function responseRequestFailed(opt_statusCode) {
  browserChannel.forwardChannelRequest_.lastError_ =
      goog.net.ChannelRequest.Error.STATUS;
  browserChannel.forwardChannelRequest_.lastStatusCode_ =
      opt_statusCode || 503;
  browserChannel.forwardChannelRequest_.successful_ = false;
  browserChannel.onRequestComplete(
      browserChannel.forwardChannelRequest_);
  mockClock.tick(0);
}


function responseUnknownSessionId() {
  browserChannel.forwardChannelRequest_.lastError_ =
      goog.net.ChannelRequest.Error.UNKNOWN_SESSION_ID;
  browserChannel.forwardChannelRequest_.successful_ = false;
  browserChannel.onRequestComplete(
      browserChannel.forwardChannelRequest_);
  mockClock.tick(0);
}


function sendMap(key, value) {
  var map = new goog.structs.Map();
  map.set(key, value);
  browserChannel.sendMap(map);
  mockClock.tick(0);
}


function hasForwardChannel() {
  return !!browserChannel.forwardChannelRequest_;
}


function hasBackChannel() {
  return !!browserChannel.backChannelRequest_;
}


function hasDeadBackChannelTimer() {
  return goog.isDefAndNotNull(browserChannel.deadBackChannelTimerId_);
};


function assertHasForwardChannel() {
  assertTrue('Forward channel missing.', hasForwardChannel());
}


function assertHasBackChannel() {
  assertTrue('Back channel missing.', hasBackChannel());
}


function testConnect() {
  connect();
  assertEquals(goog.net.BrowserChannel.State.OPENED,
      browserChannel.getState());
  // If the server specifies no version, the client assumes 6
  assertEquals(6, browserChannel.channelVersion_);
  assertFalse(browserChannel.isBuffered());
}


function testConnect_backChannelEstablished() {
  connect();
  assertHasBackChannel();
}

function testConnect_withServerHostPrefix() {
  connect(undefined, 'serverHostPrefix');
  assertEquals('serverHostPrefix', browserChannel.hostPrefix_);
}

function testConnect_withClientHostPrefix() {
  handler.correctHostPrefix = function(hostPrefix) {
    return 'clientHostPrefix';
  }
  connect();
  assertEquals('clientHostPrefix', browserChannel.hostPrefix_);
}

function testConnect_overrideServerHostPrefix() {
  handler.correctHostPrefix = function(hostPrefix) {
    return 'clientHostPrefix';
  }
  connect(undefined, 'serverHostPrefix');
  assertEquals('clientHostPrefix', browserChannel.hostPrefix_);
}

function testConnect_withServerVersion() {
  connect(8);
  assertEquals(8, browserChannel.channelVersion_);
}


function testSendMap() {
  connect();
  assertEquals(1, numTimingEvents);
  sendMap('foo', 'bar');
  responseVersion7();
  assertEquals(2, numTimingEvents);
}


function testSendMap_twice() {
  connect();
  sendMap('foo1', 'bar1');
  responseVersion7();
  sendMap('foo2', 'bar2');
  responseVersion7();
}


function testSendMap_andReceive() {
  connect();
  sendMap('foo', 'bar');
  responseVersion7();
  receive('["the server reply"]');
}


function testReceive() {
  connect();
  receive('["message from server"]');
  assertHasBackChannel();
}


function testReceive_twice() {
  connect();
  receive('["message one from server"]');
  receive('["message two from server"]');
  assertHasBackChannel();
}


function testReceive_andSendMap() {
  connect();
  receive('["the server reply"]');
  sendMap('foo', 'bar');
  responseVersion7();
  assertHasBackChannel();
}


function testBackChannelRemainsEstablished_afterSingleSendMap() {
  connect();

  sendMap('foo', 'bar');
  responseVersion7();
  receive('["ack"]');

  assertHasBackChannel();
}


function testBackChannelRemainsEstablished_afterDoubleSendMap() {
  connect();

  sendMap('foo1', 'bar1');
  sendMap('foo2', 'bar2');
  responseVersion7();
  receive('["ack"]');

  // This assertion would fail prior to CL 13302660.
  assertHasBackChannel();
}


function testTimingEvent(){
  connect();
  assertEquals(1, numTimingEvents);
  sendMap('', '');
  assertEquals(1, numTimingEvents);
  mockClock.tick(20);
  var expSize = browserChannel.forwardChannelRequest_.getPostData().length;
  responseVersion7();

  assertEquals(2, numTimingEvents);
  assertEquals(expSize, lastPostSize);
  assertEquals(20, lastPostRtt);
  assertEquals(0, lastPostRetryCount);

  sendMap('abcdefg', '123456');
  expSize = browserChannel.forwardChannelRequest_.getPostData().length;
  responseTimeout();
  assertEquals(2, numTimingEvents);
  mockClock.tick(RETRY_TIME + 1);
  responseVersion7();
  assertEquals(3, numTimingEvents);
  assertEquals(expSize, lastPostSize);
  assertEquals(1, lastPostRetryCount);
  assertEquals(1, lastPostRtt);

}


/**
 * Make sure that dropping the forward channel retry limit below the retry count
 * reports an error, and prevents another request from firing.
 */
function testSetFailFastWhileWaitingForRetry() {
  connect();
  assertEquals(1, numTimingEvents);

  sendMap('foo', 'bar');
  assertNull(browserChannel.forwardChannelTimerId_);
  assertNotNull(browserChannel.forwardChannelRequest_);
  assertEquals(0, browserChannel.forwardChannelRetryCount_);

  // Watchdog timeout.
  responseTimeout();
  assertNotNull(browserChannel.forwardChannelTimerId_);
  assertNull(browserChannel.forwardChannelRequest_);
  assertEquals(1, browserChannel.forwardChannelRetryCount_);

  // Almost finish the between-retry timeout.
  mockClock.tick(RETRY_TIME - 1);
  assertNotNull(browserChannel.forwardChannelTimerId_);
  assertNull(browserChannel.forwardChannelRequest_);
  assertEquals(1, browserChannel.forwardChannelRetryCount_);

  // Setting max retries to 0 should cancel the timer and raise an error.
  browserChannel.setFailFast(true);
  assertNull(browserChannel.forwardChannelTimerId_);
  assertNull(browserChannel.forwardChannelRequest_);
  assertEquals(1, browserChannel.forwardChannelRetryCount_);

  assertTrue(gotError);
  // We get the error immediately before starting to ping google.com.
  // Simulate that timing out. We should get a network error in addition to the
  // initial failure.
  gotError = false;
  mockClock.tick(goog.net.GOOGLECOM_TIMEOUT);
  assertTrue(gotError);

  // Make sure no more retry timers are firing.
  mockClock.tick(ALL_DAY_MS);
  assertNull(browserChannel.forwardChannelTimerId_);
  assertNull(browserChannel.forwardChannelRequest_);
  assertEquals(1, browserChannel.forwardChannelRetryCount_);
  assertEquals(1, numTimingEvents);
}


/**
 * Make sure that dropping the forward channel retry limit below the retry count
 * reports an error, and prevents another request from firing.
 */
function testSetFailFastWhileRetryXhrIsInFlight() {
  connect();
  assertEquals(1, numTimingEvents);

  sendMap('foo', 'bar');
  assertNull(browserChannel.forwardChannelTimerId_);
  assertNotNull(browserChannel.forwardChannelRequest_);
  assertEquals(0, browserChannel.forwardChannelRetryCount_);

  // Watchdog timeout.
  responseTimeout();
  assertNotNull(browserChannel.forwardChannelTimerId_);
  assertNull(browserChannel.forwardChannelRequest_);
  assertEquals(1, browserChannel.forwardChannelRetryCount_);

  // Wait for the between-retry timeout.
  mockClock.tick(RETRY_TIME);
  assertNull(browserChannel.forwardChannelTimerId_);
  assertNotNull(browserChannel.forwardChannelRequest_);
  assertEquals(1, browserChannel.forwardChannelRetryCount_);

  // Simulate a second watchdog timeout.
  responseTimeout();
  assertNotNull(browserChannel.forwardChannelTimerId_);
  assertNull(browserChannel.forwardChannelRequest_);
  assertEquals(2, browserChannel.forwardChannelRetryCount_);

  // Wait for another between-retry timeout.
  mockClock.tick(RETRY_TIME);
  // Now the third req is in flight.
  assertNull(browserChannel.forwardChannelTimerId_);
  assertNotNull(browserChannel.forwardChannelRequest_);
  assertEquals(2, browserChannel.forwardChannelRetryCount_);

  // Set fail fast, killing the request
  browserChannel.setFailFast(true);
  assertNull(browserChannel.forwardChannelTimerId_);
  assertNull(browserChannel.forwardChannelRequest_);
  assertEquals(2, browserChannel.forwardChannelRetryCount_);

  assertTrue(gotError);
  // We get the error immediately before starting to ping google.com.
  // Simulate that timing out. We should get a network error in addition to the
  gotError = false;
  mockClock.tick(goog.net.GOOGLECOM_TIMEOUT);
  assertTrue(gotError);

  // Make sure no more retry timers are firing.
  mockClock.tick(ALL_DAY_MS);
  assertNull(browserChannel.forwardChannelTimerId_);
  assertNull(browserChannel.forwardChannelRequest_);
  assertEquals(2, browserChannel.forwardChannelRetryCount_);
  assertEquals(1, numTimingEvents);
}


/**
 * Makes sure that setting fail fast while not retrying doesn't cause a failure.
 */
function testSetFailFastAtRetryCount() {
  connect();
  assertEquals(1, numTimingEvents);

  sendMap('foo', 'bar');
  assertNull(browserChannel.forwardChannelTimerId_);
  assertNotNull(browserChannel.forwardChannelRequest_);
  assertEquals(0, browserChannel.forwardChannelRetryCount_);

  // Set fail fast.
  browserChannel.setFailFast(true);
  // Request should still be alive.
  assertNull(browserChannel.forwardChannelTimerId_);
  assertNotNull(browserChannel.forwardChannelRequest_);
  assertEquals(0, browserChannel.forwardChannelRetryCount_);

  // Watchdog timeout. Now we should get an error.
  responseTimeout();
  assertNull(browserChannel.forwardChannelTimerId_);
  assertNull(browserChannel.forwardChannelRequest_);
  assertEquals(0, browserChannel.forwardChannelRetryCount_);

  assertTrue(gotError);
  // We get the error immediately before starting to ping google.com.
  // Simulate that timing out. We should get a network error in addition to the
  // initial failure.
  gotError = false;
  mockClock.tick(goog.net.GOOGLECOM_TIMEOUT);
  assertTrue(gotError);

  // Make sure no more retry timers are firing.
  mockClock.tick(ALL_DAY_MS);
  assertNull(browserChannel.forwardChannelTimerId_);
  assertNull(browserChannel.forwardChannelRequest_);
  assertEquals(0, browserChannel.forwardChannelRetryCount_);
  assertEquals(1, numTimingEvents);
}


function testRequestFailedClosesChannel() {
  connect();
  assertEquals(1, numTimingEvents);

  sendMap('foo', 'bar');
  responseRequestFailed();

  assertEquals('Should be closed immediately after request failed.',
      goog.net.BrowserChannel.State.CLOSED, browserChannel.getState());

  mockClock.tick(goog.net.GOOGLECOM_TIMEOUT);

  assertEquals('Should remain closed after the ping timeout.',
      goog.net.BrowserChannel.State.CLOSED, browserChannel.getState());
  assertEquals(1, numTimingEvents);
}


function testStatEventReportedOnlyOnce() {
  connect();
  sendMap('foo', 'bar');
  numStatEvents = 0;
  lastStatEvent = null;
  responseUnknownSessionId();

  assertEquals(1, numStatEvents);
  assertEquals(goog.net.BrowserChannel.Stat.ERROR_OTHER, lastStatEvent);

  numStatEvents = 0;
  mockClock.tick(goog.net.GOOGLECOM_TIMEOUT);
  assertEquals('No new stat events should be reported.', 0, numStatEvents);
}


function testStatEventReportedOnlyOnce_onNetworkUp() {
  connect();
  sendMap('foo', 'bar');
  numStatEvents = 0;
  lastStatEvent = null;
  responseRequestFailed();

  assertEquals('No stat event should be reported before we know the reason.',
      0, numStatEvents);

  // Let the ping time out.
  mockClock.tick(goog.net.GOOGLECOM_TIMEOUT);

  // Assert we report the correct stat event.
  assertEquals(1, numStatEvents);
  assertEquals(goog.net.BrowserChannel.Stat.ERROR_NETWORK, lastStatEvent);
}


function testStatEventReportedOnlyOnce_onNetworkDown() {
  connect();
  sendMap('foo', 'bar');
  numStatEvents = 0;
  lastStatEvent = null;
  responseRequestFailed();

  assertEquals('No stat event should be reported before we know the reason.',
      0, numStatEvents);

  // Wait half the ping timeout period, and then fake the network being up.
  mockClock.tick(goog.net.GOOGLECOM_TIMEOUT / 2);
  browserChannel.testGoogleComCallback_(true);

  // Assert we report the correct stat event.
  assertEquals(1, numStatEvents);
  assertEquals(goog.net.BrowserChannel.Stat.ERROR_OTHER, lastStatEvent);
}


function testOutgoingMapsAwaitsResponse() {
  connect();
  assertEquals(0, browserChannel.outgoingMaps_.length);

  sendMap('foo1', 'bar');
  assertEquals(0, browserChannel.outgoingMaps_.length);
  sendMap('foo2', 'bar');
  assertEquals(1, browserChannel.outgoingMaps_.length);
  sendMap('foo3', 'bar');
  assertEquals(2, browserChannel.outgoingMaps_.length);
  sendMap('foo4', 'bar');
  assertEquals(3, browserChannel.outgoingMaps_.length);

  responseVersion7();
  // Now the forward channel request is completed and a new started, so all maps
  // are dequeued from the array of outgoing maps into this new forward request.
  assertEquals(0, browserChannel.outgoingMaps_.length);
}


function testUndeliveredMaps_doesNotNotifyWhenSuccessful() {
  handler.channelClosed = function(
      channel, opt_pendingMaps, opt_undeliveredMaps) {
    if (opt_pendingMaps || opt_undeliveredMaps) {
      fail('No pending or undelivered maps should be reported.');
    }
  };

  connect();
  sendMap('foo1', 'bar1');
  responseVersion7();
  sendMap('foo2', 'bar2');
  responseVersion7();
  disconnect();
}


function testUndeliveredMaps_doesNotNotifyIfNothingWasSent() {
  handler.channelClosed = function(
      channel, opt_pendingMaps, opt_undeliveredMaps) {
    if (opt_pendingMaps || opt_undeliveredMaps) {
      fail('No pending or undelivered maps should be reported.');
    }
  };

  connect();
  mockClock.tick(ALL_DAY_MS);
  disconnect();
}


function testUndeliveredMaps_clearsPendingMapsAfterNotifying() {
  connect();
  sendMap('foo1', 'bar1');
  sendMap('foo2', 'bar2');
  sendMap('foo3', 'bar3');

  assertEquals(1, browserChannel.pendingMaps_.length);
  assertEquals(2, browserChannel.outgoingMaps_.length);

  disconnect();

  assertEquals(0, browserChannel.pendingMaps_.length);
  assertEquals(0, browserChannel.outgoingMaps_.length);
}


function testUndeliveredMaps_notifiesWhenNoResponseReceived() {
  connect();

  // First send two messages that succeed.
  sendMap('foo1', 'bar1');
  responseVersion7();
  sendMap('foo2', 'bar2');
  responseVersion7();

  // Pretend the server hangs and no longer responds.
  sendMap('foo3', 'bar3');
  sendMap('foo4', 'bar4');
  sendMap('foo5', 'bar5');

  // Give up.
  disconnect();

  // Assert that we are informed of any undelivered messages; both about
  // #3 that was sent but which we don't know if the server received, and
  // #4 and #5 which remain in the outgoing maps and have not yet been sent.
  assertEquals('foo3:bar3', handler.pendingMapsString);
  assertEquals('foo4:bar4, foo5:bar5', handler.undeliveredMapsString);
}


function testUndeliveredMaps_serviceUnavailable() {
  // Send a few maps, and let one fail.
  connect();
  sendMap('foo1', 'bar1');
  responseVersion7();
  sendMap('foo2', 'bar2');
  responseRequestFailed();

  // After a failure, the channel should be closed.
  disconnect();

  assertEquals('foo2:bar2', handler.pendingMapsString);
  assertEquals('', handler.undeliveredMapsString);
}


function testUndeliveredMaps_onPingTimeout() {
  connect();

  // Send a message.
  sendMap('foo1', 'bar1');

  // Fake REQUEST_FAILED, triggering a ping to check the network.
  responseRequestFailed();

  // Let the ping time out, unsuccessfully.
  mockClock.tick(goog.net.GOOGLECOM_TIMEOUT);

  // Assert channel is closed.
  assertEquals(goog.net.BrowserChannel.State.CLOSED,
      browserChannel.getState());

  // Assert that the handler is notified about the undelivered messages.
  assertEquals('foo1:bar1', handler.pendingMapsString);
  assertEquals('', handler.undeliveredMapsString);
}


function testResponseNoBackchannelPostNotBeforeBackchannel() {
  connect(8);
  sendMap('foo1', 'bar1');

  mockClock.tick(10);
  assertFalse(browserChannel.backChannelRequest_.getRequestStartTime() <
      browserChannel.forwardChannelRequest_.getRequestStartTime());
  responseNoBackchannel();
  assertNotEquals(goog.net.BrowserChannel.Stat.BACKCHANNEL_MISSING,
      lastStatEvent);
}


function testResponseNoBackchannel() {
  connect(8);
  sendMap('foo1', 'bar1');
  response(-1, 0);
  mockClock.tick(goog.net.BrowserChannel.RTT_ESTIMATE + 1);
  sendMap('foo2', 'bar2');
  assertTrue(browserChannel.backChannelRequest_.getRequestStartTime() +
      goog.net.BrowserChannel.RTT_ESTIMATE <
      browserChannel.forwardChannelRequest_.getRequestStartTime());
  responseNoBackchannel();
  assertEquals(goog.net.BrowserChannel.Stat.BACKCHANNEL_MISSING, lastStatEvent);
}


function testResponseNoBackchannelWithNoBackchannel() {
  connect(8);
  sendMap('foo1', 'bar1');
  assertNull(browserChannel.backChannelTimerId_);
  browserChannel.backChannelRequest_.cancel();
  browserChannel.backChannelRequest_ = null;
  responseNoBackchannel();
  assertEquals(goog.net.BrowserChannel.Stat.BACKCHANNEL_MISSING, lastStatEvent);
}


function testResponseNoBackchannelWithStartTimer() {
  connect(8);
  sendMap('foo1', 'bar1');

  browserChannel.backChannelRequest_.cancel();
  browserChannel.backChannelRequest_ = null;
  browserChannel.backChannelTimerId_ = 123;
  responseNoBackchannel();
  assertNotEquals(goog.net.BrowserChannel.Stat.BACKCHANNEL_MISSING,
      lastStatEvent);
}


function testResponseWithNoArraySent() {
  connect(8);
  sendMap('foo1', 'bar1');

  // Send a response as if the server hasn't sent down an array.
  response(-1, 0);

  // POST response with an array ID lower than our last received is OK.
  assertEquals(1, browserChannel.lastArrayId_);
  assertEquals(-1, browserChannel.lastPostResponseArrayId_);
}


function testResponseWithArraysMissing() {
  connect(8);
  sendMap('foo1', 'bar1');
  assertEquals(-1, browserChannel.lastPostResponseArrayId_);

  // Send a response as if the server has sent down seven arrays.
  response(7, 111);

  assertEquals(1, browserChannel.lastArrayId_);
  assertEquals(7, browserChannel.lastPostResponseArrayId_);
  mockClock.tick(goog.net.BrowserChannel.RTT_ESTIMATE * 2);
  assertEquals(goog.net.BrowserChannel.Stat.BACKCHANNEL_DEAD, lastStatEvent);
}


function testMultipleResponsesWithArraysMissing() {
  connect(8);
  sendMap('foo1', 'bar1');
  assertEquals(-1, browserChannel.lastPostResponseArrayId_);

  // Send a response as if the server has sent down seven arrays.
  response(7, 111);

  assertEquals(1, browserChannel.lastArrayId_);
  assertEquals(7, browserChannel.lastPostResponseArrayId_);
  sendMap('foo2', 'bar2');
  mockClock.tick(goog.net.BrowserChannel.RTT_ESTIMATE);
  response(8, 119);
  mockClock.tick(goog.net.BrowserChannel.RTT_ESTIMATE);
  // The original timer should still fire.
  assertEquals(goog.net.BrowserChannel.Stat.BACKCHANNEL_DEAD, lastStatEvent);
}


function testOnlyRetryOnceBasedOnResponse() {
  connect(8);
  sendMap('foo1', 'bar1');
  assertEquals(-1, browserChannel.lastPostResponseArrayId_);

  // Send a response as if the server has sent down seven arrays.
  response(7, 111);

  assertEquals(1, browserChannel.lastArrayId_);
  assertEquals(7, browserChannel.lastPostResponseArrayId_);
  assertTrue(hasDeadBackChannelTimer());
  mockClock.tick(goog.net.BrowserChannel.RTT_ESTIMATE * 2);
  assertEquals(goog.net.BrowserChannel.Stat.BACKCHANNEL_DEAD, lastStatEvent);
  assertEquals(1, browserChannel.backChannelRetryCount_);
  mockClock.tick(goog.net.BrowserChannel.RTT_ESTIMATE);
  sendMap('foo2', 'bar2');
  assertFalse(hasDeadBackChannelTimer());
  response(8, 119);
  assertFalse(hasDeadBackChannelTimer());
}


function testResponseWithArraysMissingAndLiveChannel() {
  connect(8);
  sendMap('foo1', 'bar1');
  assertEquals(-1, browserChannel.lastPostResponseArrayId_);

  // Send a response as if the server has sent down seven arrays.
  response(7, 111);

  assertEquals(1, browserChannel.lastArrayId_);
  assertEquals(7, browserChannel.lastPostResponseArrayId_);
  mockClock.tick(goog.net.BrowserChannel.RTT_ESTIMATE);
  assertTrue(hasDeadBackChannelTimer());
  receive('["ack"]');
  assertFalse(hasDeadBackChannelTimer());
  mockClock.tick(goog.net.BrowserChannel.RTT_ESTIMATE);
  assertNotEquals(goog.net.BrowserChannel.Stat.BACKCHANNEL_DEAD, lastStatEvent);
}


function testResponseWithBigOutstandingData() {
  connect(8);
  sendMap('foo1', 'bar1');
  assertEquals(-1, browserChannel.lastPostResponseArrayId_);

  // Send a response as if the server has sent down seven arrays and 50kbytes.
  response(7, 50000);

  assertEquals(1, browserChannel.lastArrayId_);
  assertEquals(7, browserChannel.lastPostResponseArrayId_);
  assertFalse(hasDeadBackChannelTimer());
  mockClock.tick(goog.net.BrowserChannel.RTT_ESTIMATE * 2);
  assertNotEquals(goog.net.BrowserChannel.Stat.BACKCHANNEL_DEAD,
      lastStatEvent);
}


function testResponseInBufferedMode() {
  connect(8);
  browserChannel.useChunked_ = false;
  sendMap('foo1', 'bar1');
  assertEquals(-1, browserChannel.lastPostResponseArrayId_);
  response(7, 111);

  assertEquals(1, browserChannel.lastArrayId_);
  assertEquals(7, browserChannel.lastPostResponseArrayId_);
  assertFalse(hasDeadBackChannelTimer());
  mockClock.tick(goog.net.BrowserChannel.RTT_ESTIMATE * 2);
  assertNotEquals(goog.net.BrowserChannel.Stat.BACKCHANNEL_DEAD,
      lastStatEvent);
}


function testResponseWithGarbage() {
  connect(8);
  sendMap('foo1', 'bar1');
  browserChannel.onRequestData(
      browserChannel.forwardChannelRequest_,
      'garbage'
      );
  assertEquals(goog.net.BrowserChannel.State.CLOSED,
      browserChannel.getState());
}


function testResponseWithGarbageInArray() {
  connect(8);
  sendMap('foo1', 'bar1');
  browserChannel.onRequestData(
      browserChannel.forwardChannelRequest_,
      '["garbage"]'
      );
  assertEquals(goog.net.BrowserChannel.State.CLOSED,
      browserChannel.getState());
}


function testResponseWithEvilData() {
  connect(8);
  sendMap('foo1', 'bar1');
  browserChannel.onRequestData(
      browserChannel.forwardChannelRequest_,
      goog.net.BrowserChannel.LAST_ARRAY_ID_RESPONSE_PREFIX +
          '=<script>evil()\<\/script>&' +
      goog.net.BrowserChannel.OUTSTANDING_DATA_RESPONSE_PREFIX +
          '=<script>moreEvil()\<\/script>');
  assertEquals(goog.net.BrowserChannel.State.CLOSED,
      browserChannel.getState());
}

function testAllowEarlyNoBuffering() {
  goog.net.BrowserTestChannel.ALLOW_EARLY_NON_BUFFERED_DETECTION = true;
  browserChannel.connect('/test', '/bind', null);
  mockClock.tick(0);
  completeTestConnection();
}

">45 of 45 tests run in 61ms.<br />37 passed, 8 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testRequestFailedClosesChannel<br />Image is not defined<br />ERROR in testSetFailFastAtRetryCount<br />Image is not defined<br />ERROR in testSetFailFastWhileRetryXhrIsInFlight<br />Image is not defined<br />ERROR in testSetFailFastWhileWaitingForRetry<br />Image is not defined<br />ERROR in testStatEventReportedOnlyOnce_onNetworkDown<br />Image is not defined<br />ERROR in testStatEventReportedOnlyOnce_onNetworkUp<br />Image is not defined<br />ERROR in testUndeliveredMaps_onPingTimeout<br />Image is not defined<br />ERROR in testUndeliveredMaps_serviceUnavailable<br />Image is not defined<br /></td></tr>
<tr><td>iframe_xhr_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.events');
  goog.require('goog.debug.Console');
  goog.require('goog.net.XhrLite');
  goog.require('goog.net.IframeIo');
  goog.require('goog.testing.AsyncTestCase');
  goog.require('goog.testing.jsunit');
  goog.require('goog.Timer');


    var c = new goog.debug.Console;
    c.setCapturing(true);
    goog.debug.LogManager.getRoot().setLevel(goog.debug.Logger.Level.ALL);
    
    // Can't use exportSymbol if we want JsUnit support
    top.GG_iframeFn = goog.net.IframeIo.handleIncrementalData;
    
    // Make the dispose time short enough that it will cause the bug to appear
    goog.net.IframeIo.IFRAME_DISPOSE_DELAY_MS = 0;
    
    
    var fileName = 'iframe_xhr_test_response.html';
    var iframeio;
    
    // Create an async test case
    var testCase = new goog.testing.AsyncTestCase(document.title);
    testCase.stepTimeout = 4 * 1000;
    testCase.resultCount = 0;
    testCase.xhrCount = 0;
    testCase.error = null;
    
    /** Set up the iframe io and request the test response page. */
    testCase.setUpPage = function() {
      testCase.waitForAsync('setUpPage');
      iframeio = new goog.net.IframeIo();
      goog.events.listen(
          iframeio, 'incrementaldata', this.onIframeData, false, this);
      goog.events.listen(
          iframeio, 'ready', this.onIframeReady, false, this);
      iframeio.send(fileName);
      
      this.add(new goog.testing.TestCase.Test(
          'test results', this.testResults, this));
    };
    
    /** Disposes the iframe object. */
    testCase.tearDownPage = function() {
      iframeio.dispose();
    };
    
    /** Handles the packets received  from the Iframe incremental results. */
    testCase.onIframeData = function(e) {
      this.log('Data received  : ' + e.data);
      this.resultCount++;
      goog.net.XhrLite.send(fileName, goog.bind(this.onXhrData, this));
    };
    
    /** Handles the iframe becoming ready. */
    testCase.onIframeReady = function(e) {
      this.log('Iframe ready');
      var me = this;
      goog.net.XhrLite.send(fileName, goog.bind(this.onXhrData, this));
    };
    
    /** Handles the response from an Xhr request. */
    testCase.onXhrData = function(e) {
      this.xhrCount++;
      // We access status directly so that XhrLite doesn't mask the error that
      // would be thrown in FF if this worked correctly.
      try {
        this.log('Xhr Received: ' + e.target.xhr_.status);
      } catch (e) {
        this.log('ERROR: ' + e.message);
        this.error = e;
      }
      if (this.xhrCount == 4 && this.resultCount == 3) {
        // Wait for the async iframe disposal to fire.
        this.log('Test set up finished, waiting 500ms for iframe disposal');
        goog.Timer.callOnce(goog.bind(this.continueTesting, this), 0);
      }
    };
    
    /** The main test function that validates the results were as expected. */
    testCase.testResults = function() {
      assertEquals('There should be 3 data packets', 3, this.resultCount);
      // 3 results + 1 ready
      assertEquals('There should be 4 XHR results', 4, this.xhrCount);
      if (this.error) {
        throw this.error;
      }
      
      assertEquals('There should be no iframes left', 0,
          document.getElementsByTagName('iframe').length);
    }

    /** This test only runs on GECKO browsers. */
    if (goog.userAgent.GECKO) {
      /** Used by the JsUnit test runner. */
      var testXhrMonitorWorksForIframeIoRequests = function() {
        testCase.reset();
        testCase.cycleTests();
      }

      /** Used by the JsUnit test runner. */
      var setUpPage = function() {
        testCase.runTests();
      }
    }

    // Standalone Closure Test Runner.
    if (typeof G_testRunner != 'undefined') {
      if (goog.userAgent.GECKO) {
        G_testRunner.initialize(testCase);
      } else {
        G_testRunner.setStrict(false);
      }
    }
    
  ">TypeError: Cannot set property 'name_' of undefined
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:426:44)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
    at Module.load (module.js:219:31)
    at Function._load (module.js:186:10)
    at require (module.js:231:19)
</td></tr>
<tr><td>multiiframeloadmonitor_test.html</td><td>Fail</td><td> undefined</td><td title="

    goog.require('goog.dom');
    goog.require('goog.events');
    goog.require('goog.net.MultiIframeLoadMonitor');
    goog.require('goog.testing.AsyncTestCase');
    goog.require('goog.testing.jsunit');
  

  var TEST_FRAME_SRCS = ['iframeloadmonitor_test_frame.html',
      'iframeloadmonitor_test_frame2.html',
      'iframeloadmonitor_test_frame3.html'];

  // Create a new test case.
  var iframeLoaderTestCase = new goog.testing.AsyncTestCase(document.title);
  iframeLoaderTestCase.stepTimeout = 4 * 1000;

  // How many multpile frames finished loading
  iframeLoaderTestCase.multipleComplete_ = 0;

  iframeLoaderTestCase.numMonitors = 0;
  iframeLoaderTestCase.disposeCalled = 0;

  /** Sets up the test environment, adds tests and sets up the worker pools. */
  iframeLoaderTestCase.setUpPage = function() {
    this.log('Setting tests up');
    iframeLoaderTestCase.waitForAsync('loading iframes');

    var dom = goog.dom.getDomHelper();

    // Load multiple with callback
    var frame1 = dom.createDom('iframe');
    var frame2 = dom.createDom('iframe');
    var multiMonitor = new goog.net.MultiIframeLoadMonitor(
      [frame1, frame2], goog.bind(this.multipleCallback, this));
    this.log('Loading frames at: ' + TEST_FRAME_SRCS[0] + ' and '
        + TEST_FRAME_SRCS[1]);
    // Make sure they don't look loaded yet.
    assertEquals(0, this.multipleComplete_);
    var frameParent = dom.getElement('frame_parent');
    dom.appendChild(frameParent, frame1);
    frame1.src = TEST_FRAME_SRCS[0];
    dom.appendChild(frameParent, frame2);
    frame2.src = TEST_FRAME_SRCS[1];

    // Load multiple with callback and content check
    var frame3 = dom.createDom('iframe');
    var frame4 = dom.createDom('iframe');
    var multiMonitor = new goog.net.MultiIframeLoadMonitor(
      [frame3, frame4], goog.bind(this.multipleContentCallback, this), true);
    this.log('Loading frames with content check at: ' + TEST_FRAME_SRCS[1] +
        ' and ' + TEST_FRAME_SRCS[2]);
    dom.appendChild(frameParent, frame3);
    frame3.src = TEST_FRAME_SRCS[1];
    dom.appendChild(frameParent, frame4);
    frame4.src = TEST_FRAME_SRCS[2];

    this.add(new goog.testing.TestCase.Test(
        'test results', this.testResults, this));
    this.add(new goog.testing.TestCase.Test(
        'stopMonitoring', this.testStop, this));
  };


  /** Callback for the multiple frame load test case */
  iframeLoaderTestCase.multipleCallback = function() {
    this.log('multiple frames finished loading');
    this.multipleComplete_++;
    this.multipleCompleteNoContent_ = true;
    this.callbacksComplete();
  };

  /** Callback for the multiple frame with content load test case */
  iframeLoaderTestCase.multipleContentCallback = function() {
    this.log('multiple frames with content finished loading');
    this.multipleComplete_++;
    this.multipleCompleteContent_ = true;
    this.callbacksComplete();
  };

  /** Checks if all the load callbacks are done*/
  iframeLoaderTestCase.callbacksComplete = function() {
    if (this.multipleComplete_ == 2) {
      iframeLoaderTestCase.continueTesting();
    }
  }

  /** Tests the results. */
  iframeLoaderTestCase.testResults = function() {
    this.log('getting test results');
    assertTrue(this.multipleCompleteNoContent_);
    assertTrue(this.multipleCompleteContent_);
  };

  iframeLoaderTestCase.fakeLoadMonitor = function() {
    // Replaces IframeLoadMonitor with a fake version that just tracks
    // instantiations/disposals
    this.loadMonitorConstructor = goog.net.IframeLoadMonitor;
    var that = this;
    goog.net.IframeLoadMonitor = function() {
      that.numMonitors++;
      return {
        isLoaded: function() { return false; },
        dispose: function() { that.disposeCalled++; },
        attachEvent: function() {}
      };
    }
    goog.net.IframeLoadMonitor.LOAD_EVENT = 'ifload';
  };

  iframeLoaderTestCase.unfakeLoadMonitor = function() {
    goog.net.IframeLoadMonitor = this.loadMonitorConstructor;
  };


  iframeLoaderTestCase.testStop = function() {
    // create two unloaded frames, make sure that load monitors are loaded
    // behind the scenes, then make sure they are disposed properly.
    this.fakeLoadMonitor();
    var dom = goog.dom.getDomHelper();
    var frames = [dom.createDom('iframe'), dom.createDom('iframe')];
    var multiMonitor = new goog.net.MultiIframeLoadMonitor(
      frames,
      function() {
        fail("should not invoke callback for unloaded rames"); 
      });
    assertEquals(frames.length, this.numMonitors);
    assertEquals(0, this.disposeCalled);
    multiMonitor.stopMonitoring();
    assertEquals(frames.length, this.disposeCalled);
    this.unfakeLoadMonitor();
  };

  /** Used by the JsUnit test runner. */
  function testResults() {
    iframeLoaderTestCase.testResults();
  }

  /** Used by the JsUnit test runner. */
  function testDispose() {
    iframeLoaderTestCase.testDispose();
  }

  /** Used by the JsUnit test runner. */
  function setUpPage() {
    iframeLoaderTestCase.runTests();
  }

  /** Standalone Closure Test Runner. */
  if (typeof G_testRunner != 'undefined') {
    G_testRunner.initialize(iframeLoaderTestCase);
  }

">TypeError: Cannot set property 'name_' of undefined
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:426:44)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
    at Module.load (module.js:219:31)
    at Function._load (module.js:186:10)
    at require (module.js:231:19)
</td></tr>
<tr><td>spellcheck_test.html</td><td>Success</td><td> 5 passed, 0 failed.</td><td title="

  goog.require('goog.spell.SpellCheck');
  goog.require('goog.testing.jsunit');


  var TEST_DATA = {
    'Test': [goog.spell.SpellCheck.WordStatus.VALID, []],
    'strnig': [goog.spell.SpellCheck.WordStatus.INVALID, []],
    'wtih': [goog.spell.SpellCheck.WordStatus.INVALID, []],
    'a': [goog.spell.SpellCheck.WordStatus.VALID, []],
    'few': [goog.spell.SpellCheck.WordStatus.VALID, []],
    'misspeled': [goog.spell.SpellCheck.WordStatus.INVALID,
        ['misspelled', 'misapplied', 'misspell']],
    'words': [goog.spell.SpellCheck.WordStatus.VALID, []],
    'Testing': [goog.spell.SpellCheck.WordStatus.VALID, []],
    'set': [goog.spell.SpellCheck.WordStatus.VALID, []],
    'status': [goog.spell.SpellCheck.WordStatus.VALID, []],
    'vaild': [goog.spell.SpellCheck.WordStatus.INVALID, []],
    'invalid': [goog.spell.SpellCheck.WordStatus.VALID, []],
    'ignoerd': [goog.spell.SpellCheck.WordStatus.INVALID, []]
  };

  function mockSpellCheckingFunction(words, spellChecker, callback) {
    var len = words.length;
    var data = [];
    for (var i = 0; i < len; i++) {
      var word = words[i];
      var status = TEST_DATA[word][0];
      var suggestions = TEST_DATA[word][1];
      data.push([word, status, suggestions]);
    }
    callback.call(spellChecker, data);
  }


  function testWordMatching() {
    var spell = new goog.spell.SpellCheck(mockSpellCheckingFunction);

    var valid = goog.spell.SpellCheck.WordStatus.VALID;
    var invalid = goog.spell.SpellCheck.WordStatus.INVALID;

    spell.checkBlock('Test strnig wtih a few misspeled words.');
    assertEquals(valid, spell.checkWord('Test'));
    assertEquals(invalid, spell.checkWord('strnig'));
    assertEquals(invalid, spell.checkWord('wtih'));
    assertEquals(valid, spell.checkWord('a'));
    assertEquals(valid, spell.checkWord('few'));
    assertEquals(invalid, spell.checkWord('misspeled'));
    assertEquals(valid, spell.checkWord('words'));
  }


  function testSetWordStatusValid() {
    var spell = new goog.spell.SpellCheck(mockSpellCheckingFunction);

    var valid = goog.spell.SpellCheck.WordStatus.VALID;

    spell.checkBlock('Testing set status vaild.');
    spell.setWordStatus('vaild', valid);

    assertEquals(valid, spell.checkWord('vaild'));
  }

  function testSetWordStatusInvalid() {
    var spell = new goog.spell.SpellCheck(mockSpellCheckingFunction);

    var valid = goog.spell.SpellCheck.WordStatus.VALID;
    var invalid = goog.spell.SpellCheck.WordStatus.INVALID;

    spell.checkBlock('Testing set status invalid.');
    spell.setWordStatus('invalid', invalid);

    assertEquals(invalid, spell.checkWord('invalid'));
  }


  function testSetWordStatusIgnored() {
    var spell = new goog.spell.SpellCheck(mockSpellCheckingFunction);

    var ignored = goog.spell.SpellCheck.WordStatus.IGNORED;

    spell.checkBlock('Testing set status ignoerd.');
    spell.setWordStatus('ignoerd', ignored);

    assertEquals(ignored, spell.checkWord('ignoerd'));
  }


  function testGetSuggestions() {
    var spell = new goog.spell.SpellCheck(mockSpellCheckingFunction);

    spell.checkBlock('Test strnig wtih a few misspeled words.');
    var suggestions = spell.getSuggestions('misspeled');
    assertEquals(3, suggestions.length);
  }
">n/a</td></tr>
<tr><td>window_test.html</td><td>Success</td><td> 9 passed, 0 failed.</td><td title="

  goog.require('goog.string');
  goog.require('goog.testing.AsyncTestCase');
  goog.require('goog.testing.jsunit');
  goog.require('goog.window');



  var newWin;
  var REDIRECT_URL_PREFIX = 'window_test.html?runTests=';
  var asyncTestCase =
      goog.testing.AsyncTestCase.createAndInstall(document.title);
  asyncTestCase.stepTimeout = 5000;

  var WIN_LOAD_TRY_TIMEOUT = 100;
  var MAX_WIN_LOAD_TRIES = 50; // 50x100ms = 5s waiting for window to load.
  var winLoadCounter;

  /**
   * Some tests should only run locally, because they will trigger
   * popup blockers on http urls.
   */
  function canOpenPopups() {
    // TODO(nicksantos): Fix the test runner farm.
    return window.location.toString().indexOf('file://') == 0;
  }

  if (canOpenPopups()) {
    // To test goog.window.open we open a new window with this file again. Once
    // the new window gets to this point in the file it notifies the opener that
    // it has loaded, so that the opener knows that the new window has been
    // populated with properties like referrer and location.
    var newWinLoaded = false;
    if (window.opener && window.opener.newWinLoaded === false) {
      window.opener.newWinLoaded = true;
    }
  }

  function setUp() {
    newWinLoaded = false;
  }

  function tearDown() {
    if (newWin) {
      newWin.close();
    }
  }

  /**
   * Uses setTimeout to keep checking if a new window has been loaded, and once
   * it has, calls the given continuation function and then calls
   * asyncTestCase.continueTesting() to resume the flow of the test.
   * @param {Function} continueFn Continuation function to be called when the
   *     new window has loaded.
   * @param {number=} opt_numTries Number of times this method has checked if
   *     the window has loaded, to prevent getting in an endless setTimeout
   *     loop. (Used internally, callers should omit.)
   */
  function continueAfterWindowLoaded(continueFn, opt_numTries) {
    opt_numTries = opt_numTries || 0;
    if (newWinLoaded) {
      continueFn();
      asyncTestCase.continueTesting();
    } else if (opt_numTries > MAX_WIN_LOAD_TRIES) {
      fail('Window did not load after maximum number of checks.');
      asyncTestCase.continueTesting();
    } else {
      setTimeout(goog.partial(continueAfterWindowLoaded,
                              continueFn, ++opt_numTries),
                 WIN_LOAD_TRY_TIMEOUT);
    }
  }

  /**
   * Helper to kick off a test that opens a window and checks that the referrer
   * is hidden if requested and the url is properly encoded/decoded.
   * @param {boolean} noreferrer Whether to test the noreferrer option.
   * @param {string} urlParam Url param to append to the url being opened.
   */
  function doTestOpenWindow(noreferrer, urlParam) {
    if (!canOpenPopups()) {
      return;
    }
    newWin = goog.window.open(REDIRECT_URL_PREFIX + urlParam,
                              {'noreferrer': noreferrer});
    asyncTestCase.waitForAsync('Waiting for window to open and load.');
    continueAfterWindowLoaded(
        goog.partial(continueTestOpenWindow, noreferrer, urlParam));
  }

  /**
   * Helper callback to do asserts after the window opens.
   * @param noreferrer Whether the noreferrer option is being tested.
   * @param urlParam Url param appended to the url being opened.
   */
  function continueTestOpenWindow(noreferrer, urlParam) {
    if (noreferrer) {
      assertEquals('Referrer should have been stripped',
                   '', newWin.document.referrer);
    }

    var newWinUrl = decodeURI(newWin.location);
    newWinUrl = newWinUrl.replace(/%3B/g, ';');
    var expectedUrlSuffix = decodeURI(urlParam);
    assertTrue('New window href should have ended with <' + expectedUrlSuffix +
        '> (after decoding) but was <' + newWinUrl + '>',
        goog.string.endsWith(newWinUrl, expectedUrlSuffix));
  }


  function testOpenNotEncoded() {
    doTestOpenWindow(false, '"bogus~"');
  }

  function testOpenEncoded() {
    doTestOpenWindow(false, '"bogus%7E"');
  }

  function testOpenEncodedPercent() {
    // Intent of url is to pass %7E to the server, so it was encoded to %257E .
    doTestOpenWindow(false, '"bogus%257E"');
  }

  function testOpenNotEncodedHidingReferrer() {
    doTestOpenWindow(true, '"bogus~"');
  }

  function testOpenEncodedHidingReferrer() {
    doTestOpenWindow(true, '"bogus%7E"');
  }

  function testOpenEncodedPercentHidingReferrer() {
    // Intent of url is to pass %7E to the server, so it was encoded to %257E .
    doTestOpenWindow(true, '"bogus%257E"');
  }

  function testOpenSemicolon() {
      doTestOpenWindow(true,  "beforesemi;aftersemi");
  }

  function testTwoSemicolons() {
      doTestOpenWindow(true,  "a;b;c");
  }

  function testOpenEncoded() {
      doTestOpenWindow(true,  "this&that");
  }

  function testOpenBlank() {
    if (!canOpenPopups()) {
      return;
    }
    newWin = goog.window.openBlank('Loading...');
    asyncTestCase.waitForAsync('Waiting for temp window to open and load.');
    var urlParam = 'bogus~';

    var continueFn = function() {
      newWin.location.href = REDIRECT_URL_PREFIX + urlParam;
      continueAfterWindowLoaded(
          goog.partial(continueTestOpenWindow, false, urlParam));
    }
    setTimeout(continueFn, 100);
  }

">n/a</td></tr>
<tr><td>helloworld_test.html</td><td>Fail</td><td> undefined</td><td title="


  goog.require('goog.dom');
  goog.require('goog.testing.jsunit');
  goog.require('goog.demos.editor.HelloWorld');
  goog.require('goog.testing.editor.TestHelper');
  goog.require('goog.testing.editor.FieldMock');



var FIELD = goog.dom.getElement('field');
var plugin;
var fieldMock;
var testHelper = new goog.testing.editor.TestHelper(FIELD);

function setUp() {
  testHelper.setUpEditableElement();
  FIELD.focus();
  plugin = new goog.demos.editor.HelloWorld();
  fieldMock = new goog.testing.editor.FieldMock();
  plugin.registerFieldObject(fieldMock);
}

function tearDown() {
  testHelper.tearDownEditableElement();
}

function testIsSupportedCommand() {
  fieldMock.$replay();
  assertTrue('+helloWorld should be suported',
      plugin.isSupportedCommand('+helloWorld'));
  assertFalse('other commands should not be supported',
      plugin.isSupportedCommand('blah'));
  fieldMock.$verify();
}

function testExecCommandInternal() {
  fieldMock.$replay();
  var result = plugin.execCommandInternal(
      goog.demos.editor.HelloWorld.COMMAND.HELLO_WORLD);
  assertUndefined(result);
  var spans = FIELD.getElementsByTagName('span');
  assertEquals(1, spans.length);
  var helloWorldSpan = spans.item(0);
  assertEquals('Hello World!', goog.dom.getTextContent(helloWorldSpan));
  fieldMock.$verify();
}

">goog.require could not find: goog.demos.editor.HelloWorld
Error: goog.require could not find: goog.demos.editor.HelloWorld
    at Error (unknown source)
    at Object.require (base.js:287:15)
    at _tmpclosuretest.js:6:8
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
</td></tr>
<tr><td>helloworlddialog_test.html</td><td>Fail</td><td> undefined</td><td title="


  goog.require('goog.demos.editor.HelloWorldDialog');
  goog.require('goog.demos.editor.HelloWorldDialog.OkEvent');
  goog.require('goog.dom.DomHelper');
  goog.require('goog.events.EventHandler');
  goog.require('goog.testing.LooseMock');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.mockmatchers.ArgumentMatcher');
  goog.require('goog.ui.editor.AbstractDialog.EventType');



  var dialog;
  var mockOkHandler;

  var CUSTOM_MESSAGE = 'Hello, cruel world...';

  function setUp() {
    mockOkHandler = new goog.testing.LooseMock(goog.events.EventHandler);
  }

  function tearDown() {
    dialog.dispose();
  }

  /**
   * Creates and shows the dialog to be tested.
   */
  function createAndShow() {
    dialog = new goog.demos.editor.HelloWorldDialog(new goog.dom.DomHelper());
    dialog.addEventListener(goog.ui.editor.AbstractDialog.EventType.OK,
                            mockOkHandler);
    dialog.show();
  }

  /**
   * Sets up the mock event handler to expect an OK event with the given
   * message.
   * @param {string} message Hello world message the OK event is expected to
   *     carry.
   */
  function expectOk(message) {
    mockOkHandler.handleEvent(new goog.testing.mockmatchers.ArgumentMatcher(
        function(arg) {
          return arg.type == goog.ui.editor.AbstractDialog.EventType.OK &&
                 arg.message == message;
        }));
  }

  /**
   * Tests that when you show the dialog, the input field has the correct
   * sample text in it.
   */
  function testShow() {
    mockOkHandler.$replay();
    createAndShow();

    assertEquals('Input field has incorrect sample text',
                 'Hello, world!',
                 dialog.input_.value);
    mockOkHandler.$verify();
  }

  /**
   * Tests that clicking OK dispatches an event carying the entered message.
   */
  function testOk() {
    expectOk(CUSTOM_MESSAGE);
    mockOkHandler.$replay();
    createAndShow();

    dialog.input_.value = CUSTOM_MESSAGE;
    goog.testing.events.fireClickSequence(dialog.getOkButtonElement());

    mockOkHandler.$verify(); // Verifies OK is dispatched with correct message.
  }

">goog.require could not find: goog.demos.editor.HelloWorldDialog
Error: goog.require could not find: goog.demos.editor.HelloWorldDialog
    at Error (unknown source)
    at Object.require (base.js:287:15)
    at _tmpclosuretest.js:4:8
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
</td></tr>
<tr><td>helloworlddialogplugin_test.html</td><td>Fail</td><td> undefined</td><td title="


  goog.require('goog.demos.editor.HelloWorldDialog');
  goog.require('goog.demos.editor.HelloWorldDialog.OkEvent');
  goog.require('goog.demos.editor.HelloWorldDialogPlugin');
  goog.require('goog.demos.editor.HelloWorldDialogPlugin.Command');
  goog.require('goog.dom');
  goog.require('goog.dom.NodeType');
  goog.require('goog.testing.ExpectedFailures');
  goog.require('goog.testing.MockControl');
  goog.require('goog.testing.MockRange');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.testing.editor.FieldMock');
  goog.require('goog.testing.editor.TestHelper');
  goog.require('goog.testing.editor.dom');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.mockmatchers.ArgumentMatcher');
  goog.require('goog.userAgent');



  var plugin;
  var mockCtrl;
  var mockField;
  var mockRange;
  var mockPlaceCursorNextTo;
  var stubs = new goog.testing.PropertyReplacer();

  var fieldObj;

  var CUSTOM_MESSAGE = 'Hello, cruel world...';

  var expectedFailures = new goog.testing.ExpectedFailures();


  function setUp() {
    mockCtrl = new goog.testing.MockControl();

    mockRange = new goog.testing.MockRange();
    mockCtrl.addMock(mockRange);

    mockField =
        new goog.testing.editor.FieldMock(undefined, undefined, mockRange);
    mockCtrl.addMock(mockField);

    mockPlaceCursorNextTo = mockCtrl.createFunctionMock('placeCursorNextTo');
  }

  function tearDown() {
    plugin.dispose();
    tearDownRealEditableField();
    expectedFailures.handleTearDown();
    stubs.reset();
    goog.dom.getElement('myField').innerHTML = '';
  }

  /**
   * Tests that the plugin's dialog is properly created.
   */
  function testCreateDialog() {
    mockField.$replay();

    plugin = new goog.demos.editor.HelloWorldDialogPlugin();
    plugin.registerFieldObject(mockField);

    var dialog = plugin.createDialog(goog.dom.getDomHelper());
    assertTrue('Dialog should be of type goog.demos.editor.HelloWorldDialog',
               dialog instanceof goog.demos.editor.HelloWorldDialog);

    mockField.$verify();
  }

  /**
   * Tests that when the OK event fires the editable field is properly updated.
   */
  function testOk() {
    mockField.focus();
    mockField.dispatchBeforeChange();
    mockRange.removeContents();
    // Tests that an argument is a span with the custom message.
    var createdNodeMatcher = new goog.testing.mockmatchers.ArgumentMatcher(
        function(arg) {
          return arg.nodeType == goog.dom.NodeType.ELEMENT &&
                 arg.tagName == goog.dom.TagName.SPAN &&
                 goog.dom.getRawTextContent(arg) == CUSTOM_MESSAGE;
        });
    mockRange.insertNode(createdNodeMatcher, false);
    mockRange.$does(function(node, before) {
      return node;
    });
    mockPlaceCursorNextTo(createdNodeMatcher, false);
    stubs.set(goog.editor.range, 'placeCursorNextTo', mockPlaceCursorNextTo);
    mockField.dispatchSelectionChangeEvent();
    mockField.dispatchChange();
    mockCtrl.$replayAll();

    plugin = new goog.demos.editor.HelloWorldDialogPlugin();
    plugin.registerFieldObject(mockField);
    var dialog = plugin.createDialog(goog.dom.getDomHelper());

    // Mock of execCommand + clicking OK without actually opening the dialog.
    dialog.dispatchEvent(
        new goog.demos.editor.HelloWorldDialog.OkEvent(CUSTOM_MESSAGE));

    mockCtrl.$verifyAll();
  }

  /**
   * Setup a real editable field (instead of a mock) and register the plugin to
   * it.
   */
  function setUpRealEditableField() {
    fieldObj = new goog.editor.Field('myField', document);
    fieldObj.makeEditable();
    // Register the plugin to that field.
    plugin = new goog.demos.editor.HelloWorldDialogPlugin();
    fieldObj.registerPlugin(plugin);
  }

  /**
   * Tear down the real editable field.
   */
  function tearDownRealEditableField() {
    if (fieldObj) {
      fieldObj.makeUneditable();
      fieldObj.dispose();
    }
  }

  /**
   * Tests that the selection is cleared when the dialog opens and is
   * correctly restored after ok is clicked.
   */
  function testRestoreSelectionOnOk() {
    setUpRealEditableField();

    fieldObj.setHtml(false, '12345');
    var elem = fieldObj.getElement();
    var helper = new goog.testing.editor.TestHelper(elem);
    helper.select('12345', 1, '12345', 4); // Selects '234'.

    assertEquals('Incorrect text selected before dialog is opened',
                 '234',
                 fieldObj.getRange().getText());
    plugin.execCommand(
        goog.demos.editor.HelloWorldDialogPlugin.Command.HELLO_WORLD_DIALOG);

    // TODO(user): IE returns some bogus range when field doesn't have
    // selection. Remove the expectedFailure when robbyw fixes the issue.
    // NOTE(user): You can't remove the selection from a field in Opera without
    // blurring it.
    elem.parentNode.blur();
    expectedFailures.expectFailureFor(goog.userAgent.IE ||
                                      goog.userAgent.OPERA);
    try {
      assertNull('There should be no selection while dialog is open',
                 fieldObj.getRange());
    } catch (e) {
      expectedFailures.handleException(e);
    }

    goog.testing.events.fireClickSequence(
        plugin.dialog_.getOkButtonElement());
    assertEquals('No text should be selected after clicking ok',
                 '',
                 fieldObj.getRange().getText());

    // Test that the caret is placed after the custom message.
    goog.testing.editor.dom.assertRangeBetweenText(
        'Hello, world!', '5', fieldObj.getRange());
  }


">goog.require could not find: goog.demos.editor.HelloWorldDialog
Error: goog.require could not find: goog.demos.editor.HelloWorldDialog
    at Error (unknown source)
    at Object.require (base.js:287:15)
    at _tmpclosuretest.js:4:8
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
</td></tr>
<tr><td>element_test.html</td><td>Fail</td><td> 0 passed, 14 failed.</td><td title="

  goog.require('goog.graphics');
  goog.require('goog.graphics.ext');
  goog.require('goog.testing.StrictMock');
  goog.require('goog.testing.jsunit');


  var el, graphics, mockWrapper;

  function setUp() {
    var div = document.getElementById('root');
    graphics = new goog.graphics.ext.Graphics(100, 100, 200, 200);
    div.innerHTML = '';
    graphics.render(div);

    mockWrapper = new goog.testing.StrictMock(goog.graphics.Element);
  }

  function tearDown() {
    mockWrapper.$verify();
  }

  function assertPosition(fn, left, top, opt_width, opt_height) {
    mockWrapper.setTransformation(0, 0, 0, 5, 5);
    mockWrapper.setTransformation(left, top, 0,
        (opt_width || 10) / 2, (opt_height || 10) / 2);
    mockWrapper.$replay();

    el = new goog.graphics.ext.Element(graphics, mockWrapper);
    el.setSize(10, 10);
    fn();
  }

  function testLeft() {
    assertPosition(function() {
      el.setLeft(10);
    }, 10, 0);
    assertFalse(el.isParentDependent());
  }

  function testLeftPercent() {
    assertPosition(function() {
      el.setLeft('10%');
    }, 20, 0);
  }

  function testCenter() {
    assertPosition(function() {
      el.setCenter(0);
    }, 95, 0);
    assertTrue(el.isParentDependent());
  }

  function testCenterPercent() {
    assertPosition(function() {
      el.setCenter('10%');
    }, 115, 0);
  }

  function testRight() {
    assertPosition(function() {
      el.setRight(10);
    }, 180, 0);
    assertTrue(el.isParentDependent());
  }

  function testRightPercent() {
    assertPosition(function() {
      el.setRight('10%');
    }, 170, 0);
    assertTrue(el.isParentDependent());
  }

  function testTop() {
    assertPosition(function() {
      el.setTop(10);
    }, 0, 10);
    assertFalse(el.isParentDependent());
  }

  function testTopPercent() {
    assertPosition(function() {
      el.setTop('10%');
    }, 0, 20);
  }

  function testMiddle() {
    assertPosition(function() {
      el.setMiddle(0);
    }, 0, 95);
    assertTrue(el.isParentDependent());
  }

  function testMiddlePercent() {
    assertPosition(function() {
      el.setMiddle('10%');
    }, 0, 115);
  }

  function testBottom() {
    assertPosition(function() {
      el.setBottom(10);
    }, 0, 180);
    assertTrue(el.isParentDependent());
  }

  function testBottomPercent() {
    assertPosition(function() {
      el.setBottom('10%');
    }, 0, 170);
    assertTrue(el.isParentDependent());
  }

  function testSize() {
    assertPosition(function() {
      el.setSize(100, 100);
    }, 0, 0, 100, 100);
    assertFalse(el.isParentDependent());
  }

  function testSizePercent() {
    assertPosition(function() {
      el.setSize('10%', '20%');
    }, 0, 0, 20, 40);
    assertTrue(el.isParentDependent());
  }
">14 of 14 tests run in 21ms.<br />0 passed, 14 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testBottom<br />Object #<Object> has no method 'createElementNS'<br />ERROR in testBottomPercent<br />Object #<Object> has no method 'createElementNS'<br />ERROR in testCenter<br />Object #<Object> has no method 'createElementNS'<br />ERROR in testCenterPercent<br />Object #<Object> has no method 'createElementNS'<br />ERROR in testLeft<br />Object #<Object> has no method 'createElementNS'<br />ERROR in testLeftPercent<br />Object #<Object> has no method 'createElementNS'<br />ERROR in testMiddle<br />Object #<Object> has no method 'createElementNS'<br />ERROR in testMiddlePercent<br />Object #<Object> has no method 'createElementNS'<br />ERROR in testRight<br />Object #<Object> has no method 'createElementNS'<br />ERROR in testRightPercent<br />Object #<Object> has no method 'createElementNS'<br />ERROR in testSize<br />Object #<Object> has no method 'createElementNS'<br />ERROR in testSizePercent<br />Object #<Object> has no method 'createElementNS'<br />ERROR in testTop<br />Object #<Object> has no method 'createElementNS'<br />ERROR in testTopPercent<br />Object #<Object> has no method 'createElementNS'<br /></td></tr>
<tr><td>coordinates_test.html</td><td>Success</td><td> 5 passed, 0 failed.</td><td title="

  goog.require('goog.graphics');
  goog.require('goog.graphics.ext.coordinates');
  goog.require('goog.testing.jsunit');


  function testIsPercent() {
    assert('50% is a percent',
        goog.graphics.ext.coordinates.isPercent_('50%'));
    assert('50 is not a percent',
        !goog.graphics.ext.coordinates.isPercent_('50'));
  }

  function testIsPixels() {
    assert('50px is pixels', goog.graphics.ext.coordinates.isPixels_('50px'));
    assert('50 is not pixels', !goog.graphics.ext.coordinates.isPixels_('50'));
  }

  function testIsSpecial() {
    assert('50px is special', goog.graphics.ext.coordinates.isSpecial('50px'));
    assert('50% is special', goog.graphics.ext.coordinates.isSpecial('50%'));
    assert('50 is not special', !goog.graphics.ext.coordinates.isSpecial('50'));
  }

  function testComputeValue() {
    assertEquals('50% of 100 is 50', 50,
        goog.graphics.ext.coordinates.computeValue('50%', 100, null));
    assertEquals('50.5% of 200 is 101', 101,
        goog.graphics.ext.coordinates.computeValue('50.5%', 200, null));
    assertEquals('50px = 25 units when in 2x view', 25,
        goog.graphics.ext.coordinates.computeValue('50px', null, 2));
  }

  function testGenericGetValue() {
    var getValue = goog.graphics.ext.coordinates.getValue;

    var cache = {};

    assertEquals('Testing 50%', 50,
        getValue('50%', false, 100, 2, cache));

    var count = 0;
    for (var x in cache) {
      count++;
      cache[x] = 'OVERWRITE';
    }

    assertEquals('Testing cache size', 1, count);
    assertEquals('Testing cache usage', 'OVERWRITE',
        getValue('50%', false, 100, 2, cache));

    cache = {};

    assertEquals('Testing 0%', 0,
        getValue('0%', false, 100, 2, cache));
  }
">n/a</td></tr>
<tr><td>path_test.html</td><td>Success</td><td> 2 passed, 0 failed.</td><td title="

  goog.require('goog.string.path');
  goog.require('goog.testing.jsunit');



// Some test data comes from Python's posixpath tests.
// See http://svn.python.org/view/python/trunk/Lib/test/test_posixpath.py

function testJoin() {
  assertEquals('/bar/baz',
              goog.string.path.join('/foo', 'bar', '/bar', 'baz'));
  assertEquals('/foo/bar/baz',
              goog.string.path.join('/foo', 'bar', 'baz'));
  assertEquals('/foo/bar/baz/',
              goog.string.path.join('/foo/', 'bar/', 'baz/'))
}

function testNormalizePath() {
  assertEquals('.', goog.string.path.normalizePath(''));
  assertEquals('.', goog.string.path.normalizePath('./'));
  assertEquals('/', goog.string.path.normalizePath('/'));
  assertEquals('//', goog.string.path.normalizePath('//'));
  assertEquals('/', goog.string.path.normalizePath('///'));
  assertEquals('/foo/bar',
               goog.string.path.normalizePath('///foo/.//bar//'));
  assertEquals('/foo/baz',
               goog.string.path.normalizePath('///foo/.//bar//.//..//.//baz'));
  assertEquals('/foo/bar',
               goog.string.path.normalizePath('///..//./foo/.//bar'));
  assertEquals('../../cat/dog',
               goog.string.path.normalizePath('../../cat/dog/'));
  assertEquals('../dog',
               goog.string.path.normalizePath('../cat/../dog/'));
  assertEquals('/cat/dog',
               goog.string.path.normalizePath('/../cat/dog/'));
  assertEquals('/dog',
               goog.string.path.normalizePath('/../cat/../dog'));
  assertEquals('/dog',
               goog.string.path.normalizePath('/../../../dog'));
}


">n/a</td></tr>
<tr><td>affinetransform_test.html</td><td>Success</td><td> 22 passed, 0 failed.</td><td title="

  goog.require('goog.graphics');
  goog.require('goog.graphics.AffineTransform');
  goog.require('goog.testing.jsunit');


  function testGetTranslateInstance() {
    var tx = goog.graphics.AffineTransform.getTranslateInstance(2, 4);
    assertEquals(1, tx.getScaleX());
    assertEquals(0, tx.getShearY());
    assertEquals(0, tx.getShearX());
    assertEquals(1, tx.getScaleY());
    assertEquals(2, tx.getTranslateX());
    assertEquals(4, tx.getTranslateY());
  }

  function testGetScaleInstance() {
    var tx = goog.graphics.AffineTransform.getScaleInstance(2, 4);
    assertEquals(2, tx.getScaleX());
    assertEquals(0, tx.getShearY());
    assertEquals(0, tx.getShearX());
    assertEquals(4, tx.getScaleY());
    assertEquals(0, tx.getTranslateX());
    assertEquals(0, tx.getTranslateY());
  }

  function testGetRotateInstance() {
    var tx = goog.graphics.AffineTransform.getRotateInstance(Math.PI / 2, 1, 2);
    assertEquals(0, Math.round(tx.getScaleX()));
    assertEquals(1, Math.round(tx.getShearY()));
    assertEquals(-1, Math.round(tx.getShearX()));
    assertEquals(0, Math.round(tx.getScaleY()));
    assertEquals(3, Math.round(tx.getTranslateX()));
    assertEquals(1, Math.round(tx.getTranslateY()));
  }

  function testGetShearInstance() {
    var tx = goog.graphics.AffineTransform.getShearInstance(2, 4);
    assertEquals(1, tx.getScaleX());
    assertEquals(4, tx.getShearY());
    assertEquals(2, tx.getShearX());
    assertEquals(1, tx.getScaleY());
    assertEquals(0, tx.getTranslateX());
    assertEquals(0, tx.getTranslateY());
  }

  function testConstructor() {
    assertThrows(function() {
      new goog.graphics.AffineTransform([0, 0]);
    });
    assertThrows(function() {
      new goog.graphics.AffineTransform({});
    });
    assertThrows(function() {
      new goog.graphics.AffineTransform(0, 0, 0, 'a', 0, 0);
    });

    var tx = new goog.graphics.AffineTransform(1, 2, 3, 4, 5, 6);
    assertEquals(1, tx.getScaleX());
    assertEquals(2, tx.getShearY());
    assertEquals(3, tx.getShearX());
    assertEquals(4, tx.getScaleY());
    assertEquals(5, tx.getTranslateX());
    assertEquals(6, tx.getTranslateY());

    tx = new goog.graphics.AffineTransform();
    assert(tx.isIdentity());
  }

  function testIsIdentity() {
    var tx = new goog.graphics.AffineTransform(1, 2, 3, 4, 5, 6);
    assertFalse(tx.isIdentity());
    tx.setTransform(1, 0, 0, 1, 0, 0);
    assert(tx.isIdentity());
  }

  function testClone() {
    var tx = new goog.graphics.AffineTransform(1, 2, 3, 4, 5, 6);
    var copy = tx.clone();
    assertEquals(copy.getScaleX(), tx.getScaleX());
    assertEquals(copy.getShearY(), tx.getShearY());
    assertEquals(copy.getShearX(), tx.getShearX());
    assertEquals(copy.getScaleY(), tx.getScaleY());
    assertEquals(copy.getTranslateX(), tx.getTranslateX());
    assertEquals(copy.getTranslateY(), tx.getTranslateY());
  }

  function testSetTransform() {
    var tx = new goog.graphics.AffineTransform();
    assertThrows(function() {
      tx.setTransform(1, 2, 3, 4, 6);
    });
    assertThrows(function() {
      tx.setTransform('a', 2, 3, 4, 5, 6);
    });

    tx.setTransform(1, 2, 3, 4, 5, 6);
    assertEquals(1, tx.getScaleX());
    assertEquals(2, tx.getShearY());
    assertEquals(3, tx.getShearX());
    assertEquals(4, tx.getScaleY());
    assertEquals(5, tx.getTranslateX());
    assertEquals(6, tx.getTranslateY());
  }

  function testScale() {
    var tx = new goog.graphics.AffineTransform(1, 2, 3, 4, 5, 6);
    tx.scale(2, 3);
    assertEquals(2, tx.getScaleX());
    assertEquals(4, tx.getShearY());
    assertEquals(9, tx.getShearX());
    assertEquals(12, tx.getScaleY());
    assertEquals(5, tx.getTranslateX());
    assertEquals(6, tx.getTranslateY());
  }

  function testTranslate() {
    var tx = new goog.graphics.AffineTransform(1, 2, 3, 4, 5, 6);
    tx.translate(2, 3);
    assertEquals(1, tx.getScaleX());
    assertEquals(2, tx.getShearY());
    assertEquals(3, tx.getShearX());
    assertEquals(4, tx.getScaleY());
    assertEquals(16, tx.getTranslateX());
    assertEquals(22, tx.getTranslateY());
  }

  function testRotate() {
    var tx = new goog.graphics.AffineTransform(1, 2, 3, 4, 5, 6);
    tx.rotate(Math.PI / 2, 1, 1);
    assertEquals(3, Math.round(tx.getScaleX()));
    assertEquals(4, Math.round(tx.getShearY()));
    assertEquals(-1, Math.round(tx.getShearX()));
    assertEquals(-2, Math.round(tx.getScaleY()));
    assertEquals(7, Math.round(tx.getTranslateX()));
    assertEquals(10, Math.round(tx.getTranslateY()));
  }

  function testShear() {
    var tx = new goog.graphics.AffineTransform(1, 2, 3, 4, 5, 6);
    tx.shear(2, 3);
    assertEquals(10, tx.getScaleX());
    assertEquals(14, tx.getShearY());
    assertEquals(5, tx.getShearX());
    assertEquals(8, tx.getScaleY());
    assertEquals(5, tx.getTranslateX());
    assertEquals(6, tx.getTranslateY());
  }

  function testConcatentate() {
    var tx = new goog.graphics.AffineTransform(1, 2, 3, 4, 5, 6);
    tx.concatenate(new goog.graphics.AffineTransform(2, 1, 6, 5, 4, 3));
    assertEquals(5, tx.getScaleX());
    assertEquals(8, tx.getShearY());
    assertEquals(21, tx.getShearX());
    assertEquals(32, tx.getScaleY());
    assertEquals(18, tx.getTranslateX());
    assertEquals(26, tx.getTranslateY());
  }

  function testPreConcatentate() {
    var tx = new goog.graphics.AffineTransform(1, 2, 3, 4, 5, 6);
    tx.preConcatenate(new goog.graphics.AffineTransform(2, 1, 6, 5, 4, 3));
    assertEquals(14, tx.getScaleX());
    assertEquals(11, tx.getShearY());
    assertEquals(30, tx.getShearX());
    assertEquals(23, tx.getScaleY());
    assertEquals(50, tx.getTranslateX());
    assertEquals(38, tx.getTranslateY());
  }

  function testAssociativeConcatenate() {
    var x = new goog.graphics.AffineTransform(2, 3, 5, 7, 11, 13).concatenate(
        new goog.graphics.AffineTransform(17, 19, 23, 29, 31, 37));
    var y = new goog.graphics.AffineTransform(17, 19, 23, 29, 31, 37)
        .preConcatenate(new goog.graphics.AffineTransform(2, 3, 5, 7, 11, 13));
    assertEquals(x.getScaleX(), y.getScaleX());
    assertEquals(x.getShearY(), y.getShearY());
    assertEquals(x.getShearX(), y.getShearX());
    assertEquals(x.getScaleY(), y.getScaleY());
    assertEquals(x.getTranslateX(), y.getTranslateX());
    assertEquals(x.getTranslateY(), y.getTranslateY());
  };

  function testTransform() {
    var srcPts = [0, 0, 1, 0, 1, 1, 0, 1];
    var dstPts = [];
    var tx = goog.graphics.AffineTransform.getScaleInstance(2, 3);
    tx.translate(5, 10);
    tx.rotate(Math.PI / 4, 5, 10);
    tx.transform(srcPts, 0, dstPts, 0, 4);
    assert(goog.array.equals(
        [27.071068, 28.180195, 28.485281, 30.301516,
        27.071068, 32.422836, 25.656855, 30.301516],
        dstPts,
        goog.math.nearlyEquals));
  }

  function testGetDeterminant() {
    var tx = goog.graphics.AffineTransform.getScaleInstance(2, 3);
    tx.translate(5, 10);
    tx.rotate(Math.PI / 4, 5, 10);
    assertEquals(6, tx.getDeterminant());
  }

  function testIsInvertible() {
    assertTrue(new goog.graphics.AffineTransform(2, 3, 4, 5, 6, 7).
        isInvertible());
    assertTrue(new goog.graphics.AffineTransform(1, 0, 0, 1, 0, 0).
        isInvertible());
    assertFalse(new goog.graphics.AffineTransform(NaN, 0, 0, 1, 0, 0).
        isInvertible());
    assertFalse(new goog.graphics.AffineTransform(1, NaN, 0, 1, 0, 0).
        isInvertible());
    assertFalse(new goog.graphics.AffineTransform(1, 0, NaN, 1, 0, 0).
        isInvertible());
    assertFalse(new goog.graphics.AffineTransform(1, 0, 0, NaN, 0, 0).
        isInvertible());
    assertFalse(new goog.graphics.AffineTransform(1, 0, 0, 1, NaN, 0).
        isInvertible());
    assertFalse(new goog.graphics.AffineTransform(1, 0, 0, 1, 0, NaN).
        isInvertible());
    assertFalse(new goog.graphics.AffineTransform(Infinity, 0, 0, 1, 0, 0).
        isInvertible());
    assertFalse(new goog.graphics.AffineTransform(1, Infinity, 0, 1, 0, 0).
        isInvertible());
    assertFalse(new goog.graphics.AffineTransform(1, 0, Infinity, 1, 0, 0).
        isInvertible());
    assertFalse(new goog.graphics.AffineTransform(1, 0, 0, Infinity, 0, 0).
        isInvertible());
    assertFalse(new goog.graphics.AffineTransform(1, 0, 0, 1, Infinity, 0).
        isInvertible());
    assertFalse(new goog.graphics.AffineTransform(1, 0, 0, 1, 0, Infinity).
        isInvertible());
    assertFalse(new goog.graphics.AffineTransform(0, 0, 0, 0, 1, 0).
        isInvertible());
  }

  function testCreateInverse() {
    var tx = goog.graphics.AffineTransform.getScaleInstance(2, 3);
    tx.translate(5, 10);
    tx.rotate(Math.PI / 4, 5, 10);
    var inverse = tx.createInverse();
    assert(goog.math.nearlyEquals(0.353553, inverse.getScaleX()));
    assert(goog.math.nearlyEquals(-0.353553, inverse.getShearY()));
    assert(goog.math.nearlyEquals(0.235702, inverse.getShearX()));
    assert(goog.math.nearlyEquals(0.235702, inverse.getScaleY()));
    assert(goog.math.nearlyEquals(-16.213203, inverse.getTranslateX()));
    assert(goog.math.nearlyEquals(2.928932, inverse.getTranslateY()));
  }

  function testCopyFrom() {
    var from = new goog.graphics.AffineTransform(1, 2, 3, 4, 5, 6);
    var to = new goog.graphics.AffineTransform();
    to.copyFrom(from);
    assertEquals(from.getScaleX(), to.getScaleX());
    assertEquals(from.getShearY(), to.getShearY());
    assertEquals(from.getShearX(), to.getShearX());
    assertEquals(from.getScaleY(), to.getScaleY());
    assertEquals(from.getTranslateX(), to.getTranslateX());
    assertEquals(from.getTranslateY(), to.getTranslateY());
  }

  function testToString() {
    var tx = new goog.graphics.AffineTransform(1, 2, 3, 4, 5, 6);
    assertEquals("matrix(1,2,3,4,5,6)", tx.toString());
  }

  function testEquals() {
    var tx1 = new goog.graphics.AffineTransform(1, 2, 3, 4, 5, 6);
    var tx2 = new goog.graphics.AffineTransform(1, 2, 3, 4, 5, 6);
    assertEqualsMethod(tx1, tx2, true);

    tx2 = new goog.graphics.AffineTransform(-1, 2, 3, 4, 5, 6);
    assertEqualsMethod(tx1, tx2, false);

    tx2 = new goog.graphics.AffineTransform(1, -1, 3, 4, 5, 6);
    assertEqualsMethod(tx1, tx2, false);

    tx2 = new goog.graphics.AffineTransform(1, 2, -3, 4, 5, 6);
    assertEqualsMethod(tx1, tx2, false);

    tx2 = new goog.graphics.AffineTransform(1, 2, 3, -4, 5, 6);
    assertEqualsMethod(tx1, tx2, false);

    tx2 = new goog.graphics.AffineTransform(1, 2, 3, 4, -5, 6);
    assertEqualsMethod(tx1, tx2, false);

    tx2 = new goog.graphics.AffineTransform(1, 2, 3, 4, 5, -6);
    assertEqualsMethod(tx1, tx2, false);
  }

  function assertEqualsMethod(tx1, tx2, expected) {
    assertEquals(expected, tx1.equals(tx2));
    assertEquals(expected, tx2.equals(tx1));
    assertEquals(true, tx1.equals(tx1));
    assertEquals(true, tx2.equals(tx2));
  }
">n/a</td></tr>
<tr><td>paths_test.html</td><td>Fail</td><td> undefined</td><td title="


goog.require('goog.dom');
goog.require('goog.graphics');
goog.require('goog.graphics.paths');
goog.require('goog.testing.jsunit');





// The purpose of this test is less about the actual unit test, and
// more for drawing demos of shapes.
var regularNGon = goog.graphics.paths.createRegularNGon;
var arrow = goog.graphics.paths.createArrow;

function setUp() {
  goog.dom.removeChildren(goog.dom.getElement('root'));
}

function testSquare() {
  var square = regularNGon(
      $coord(10, 10), $coord(0, 10), 4);
  assertArrayRoughlyEquals(
      [0, 10, 10, 0, 20, 10, 10, 20], square.arguments_, 0.05);
}

function assertArrayRoughlyEquals(expected, actual, delta) {
  var message = 'Expected: ' + expected + ', Actual: ' + actual;
  assertEquals('Wrong length. ' + message, expected.length, actual.length);
  for (var i = 0; i < expected.length; i++) {
    assertRoughlyEquals(
        'Wrong item at ' + i + '. ' + message,
        expected[i], actual[i], delta);
  }
}

function tearDownPage() {
  var root = goog.dom.getElement('root');
  var graphics = goog.graphics.createGraphics(800, 600);

  var blueFill = new goog.graphics.SolidFill('blue');
  var blackStroke = new goog.graphics.Stroke(1, 'black');
  graphics.drawPath(
      regularNGon($coord(20, 50), $coord(0, 20), 3),
      blackStroke, blueFill);
  graphics.drawPath(
      regularNGon($coord(120, 50), $coord(100, 20), 4),
      blackStroke, blueFill);
  graphics.drawPath(
      regularNGon($coord(220, 50), $coord(200, 20), 5),
      blackStroke, blueFill);
  graphics.drawPath(
      regularNGon($coord(320, 50), $coord(300, 20), 6),
      blackStroke, blueFill);

  graphics.drawPath(
      arrow($coord(0, 300), $coord(100, 400), 0, 0),
      blackStroke, blueFill);
  graphics.drawPath(
      arrow($coord(120, 400), $coord(200, 300), 0, 10),
      blackStroke, blueFill);
  graphics.drawPath(
      arrow($coord(220, 300), $coord(300, 400), 10, 0),
      blackStroke, blueFill);
  graphics.drawPath(
      arrow($coord(320, 400), $coord(400, 300), 10, 10),
      blackStroke, blueFill);

  root.appendChild(graphics.getElement());
}

function $coord(x, y) {
  return new goog.math.Coordinate(x, y);
}

">TypeError: Object #<Object> has no method 'createElementNS'
    at [object Object].createSvgElement_ (graphics/svggraphics.js:137:41)
    at [object Object].createDom (graphics/svggraphics.js:288:25)
    at Object.createGraphics (graphics/graphics.js:67:12)
    at [object Object].tearDownPage (_tmpclosuretest.js:41:32)
    at [object Object].finalize (testing/testcase.js:356:8)
    at [object Object].cycleTests (testing/testcase.js:718:8)
    at [object Object].execute (testing/testcase.js:346:8)
    at [object Object].runTests (testing/testcase.js:488:8)
    at [object Object].execute (testing/testrunner.js:266:17)
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:429:6)
</td></tr>
<tr><td>functions_test.html</td><td>Success</td><td> 11 passed, 0 failed.</td><td title="

  goog.require('goog.functions');
  goog.require('goog.testing.jsunit');



var callOrder;

var fTrue = makeCallOrderLogger('fTrue', true);
var gFalse = makeCallOrderLogger('gFalse', false);
var hTrue = makeCallOrderLogger('hTrue', true);

function setUp() {
  callOrder = [];
}

function testTrue() {
  assertTrue(goog.functions.TRUE());
}

function testFalse() {
  assertFalse(goog.functions.FALSE());
}

function testLock() {
  function add(var_args) {
    var result = 0;
    for (var i = 0; i < arguments.length; i++) {
      result += arguments[i];
    }
    return result;
  }

  assertEquals(6, add(1, 2, 3));
  assertEquals(0, goog.functions.lock(add)(1, 2, 3));
  assertEquals(6, goog.partial(add, 1, 2)(3));
  assertEquals(3, goog.functions.lock(goog.partial(add, 1, 2))(3));
}

function testIdentity() {
  assertEquals(3, goog.functions.identity(3));
  assertEquals(3, goog.functions.identity(3, 4, 5, 6));
  assertEquals('Hi there', goog.functions.identity('Hi there'));
  assertEquals(null, goog.functions.identity(null));
  assertEquals(undefined, goog.functions.identity());

  var arr = [1, 'b', null];
  assertEquals(arr, goog.functions.identity(arr));
  var obj = {a: 'ay', b: 'bee', c: 'see'};
  assertEquals(obj, goog.functions.identity(obj));
}

function testConstant() {
  assertEquals(3, goog.functions.constant(3)());
  assertEquals(undefined, goog.functions.constant()());
}

function testThrow() {
  var f = goog.functions.error('x');
  var e = assertThrows(
      'A function created by goog.functions.error must throw an error', f);
  assertEquals('x', e.message);
}

function testCompose() {
  var add2 = function(x) {
    return x + 2;
  };

  var double = function(x) {
    return x * 2;
  };

  assertEquals(6, goog.functions.compose(double, add2)(1));
  assertEquals(4, goog.functions.compose(add2, double)(1));
  assertEquals(6, goog.functions.compose(add2, add2, double)(1));
  assertEquals(12, goog.functions.compose(double, add2, add2, double)(1));
  assertUndefined(goog.functions.compose()(1));
  assertEquals(3, goog.functions.compose(add2)(1));

  var add2Numbers = function(x, y) {
    return x + y;
  };
  assertEquals(17, goog.functions.compose(add2Numbers)(10, 7));
  assertEquals(34, goog.functions.compose(double, add2Numbers)(10, 7));
}

function testAdd() {
  assertUndefined(goog.functions.sequence()());
  assertCallOrderAndReset([]);

  assert(goog.functions.sequence(fTrue)());
  assertCallOrderAndReset(['fTrue']);

  assertFalse(goog.functions.sequence(fTrue, gFalse)());
  assertCallOrderAndReset(['fTrue', 'gFalse']);

  assert(goog.functions.sequence(fTrue, gFalse, hTrue)());
  assertCallOrderAndReset(['fTrue', 'gFalse', 'hTrue']);

  assert(goog.functions.sequence(goog.functions.identity)(true));
  assertFalse(goog.functions.sequence(goog.functions.identity)(false));
}

function testAnd() {
  // the return value is unspecified for an empty and
  goog.functions.and()();
  assertCallOrderAndReset([]);

  assert(goog.functions.and(fTrue)());
  assertCallOrderAndReset(['fTrue']);

  assertFalse(goog.functions.and(fTrue, gFalse)());
  assertCallOrderAndReset(['fTrue', 'gFalse']);

  assertFalse(goog.functions.and(fTrue, gFalse, hTrue)());
  assertCallOrderAndReset(['fTrue', 'gFalse']);

  assert(goog.functions.and(goog.functions.identity)(true));
  assertFalse(goog.functions.and(goog.functions.identity)(false));
}

function testOr() {
  // the return value is unspecified for an empty or
  goog.functions.or()();
  assertCallOrderAndReset([]);

  assert(goog.functions.or(fTrue)());
  assertCallOrderAndReset(['fTrue']);

  assert(goog.functions.or(fTrue, gFalse)());
  assertCallOrderAndReset(['fTrue']);

  assert(goog.functions.or(fTrue, gFalse, hTrue)());
  assertCallOrderAndReset(['fTrue']);

  assert(goog.functions.or(goog.functions.identity)(true));
  assertFalse(goog.functions.or(goog.functions.identity)(false));
}

function testCreate(expectedArray) {
  var tempConstructor = function(a, b) {
    this.foo = a;
    this.bar = b;
  };

  var factory = goog.partial(goog.functions.create, tempConstructor, 'baz');
  var instance = factory('qux');

  assert(instance instanceof tempConstructor);
  assertEquals(instance.foo, 'baz');
  assertEquals(instance.bar, 'qux');
}

function makeCallOrderLogger(name, returnValue) {
  return function() {
    callOrder.push(name);
    return returnValue;
  };
}

function assertCallOrderAndReset(expectedArray) {
  assertArrayEquals(expectedArray, callOrder);
  callOrder = [];
}

">n/a</td></tr>
<tr><td>color_test.html</td><td>Success</td><td> 21 passed, 0 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.color');
  goog.require('goog.color.names');
  goog.require('goog.testing.jsunit');



function testIsValidHexColor() {
  var goodHexColors = ['#ffffff', '#ff7812', '#012345', '#Ff003D', '#3CA'];
  var badHexColors = ['#xxxxxx', '889900', 'not_color', '#1234567', 'fffffg'];
  for (var i = 0; i < goodHexColors.length; i++) {
    assertTrue(goodHexColors[i], goog.color.isValidHexColor_(goodHexColors[i]));
  }
  for (var i = 0; i < badHexColors.length; i++) {
    assertFalse(badHexColors[i], goog.color.isValidHexColor_(badHexColors[i]));
  }
}


function testIsValidRgbColor() {
  var goodRgbColors = ['(255, 26, 75)', 'RGB(2, 3, 4)', '(0,0,0)',
                       'rgb(255,255,255)'];
  var badRgbColors = ['(2555,0,0)', '(1,2,3,4)', 'rgb(1,20,)',
                      'RGB(20,20,20,)'];
  for (var i = 0; i < goodRgbColors.length; i++) {
    assertEquals(goodRgbColors[i],
                 goog.color.isValidRgbColor_(goodRgbColors[i]).length, 3);
  }
  for (var i = 0; i < badRgbColors.length; i++) {
    assertEquals(badRgbColors[i],
                 goog.color.isValidRgbColor_(badRgbColors[i]).length, 0);
  }
}


function testParse() {
  var colors = ['rgb(15, 250, 77)', '(127, 127, 127)', '#ffeedd', '123456',
                'magenta'];
  var parsed = goog.array.map(colors, goog.color.parse);
  assertEquals('rgb', parsed[0].type);
  assertEquals(goog.color.rgbToHex(15, 250, 77), parsed[0].hex);
  assertEquals('rgb', parsed[1].type);
  assertEquals(goog.color.rgbToHex(127, 127, 127), parsed[1].hex);
  assertEquals('hex', parsed[2].type);
  assertEquals('#ffeedd', parsed[2].hex);
  assertEquals('hex', parsed[3].type);
  assertEquals('#123456', parsed[3].hex);
  assertEquals('named', parsed[4].type);
  assertEquals('#ff00ff', parsed[4].hex);

  var badColors = ['rgb(01, 1, 23)', '(256, 256, 256)', '#ffeeddaa'];
  for (var i = 0; i < badColors.length; i++) {
    var e = assertThrows(goog.partial(goog.color.parse, badColors[i]));
    assertContains('is not a valid color string', e.message);
  }
}


function testHexToRgb() {
  var testColors = [['#B0FF2D', [176, 255, 45]],
                    ['#b26e5f', [178, 110, 95]],
                    ['#66f', [102, 102, 255]]];

  for (var i = 0; i < testColors.length; i++) {
    var r = goog.color.hexToRgb(testColors[i][0]);
    var t = testColors[i][1];

    assertEquals('Red channel should match.', t[0], r[0]);
    assertEquals('Green channel should match.', t[1], r[1]);
    assertEquals('Blue channel should match.', t[2], r[2]);
  }

  var badColors = ['', '#g00', 'some words'];
  for (var i = 0; i < badColors.length; i++) {
    var e = assertThrows(goog.partial(goog.color.hexToRgb, badColors[i]));
    assertEquals("'" + badColors[i] + "' is not a valid hex color", e.message);
  }
}


function testHexToRgbStyle() {
  assertEquals('rgb(255,0,0)', goog.color.hexToRgbStyle(goog.color.names.red));
  assertEquals('rgb(206,206,206)', goog.color.hexToRgbStyle('#cecece'));
  assertEquals('rgb(51,204,170)', goog.color.hexToRgbStyle('#3CA'));
  var badHexColors = ['#1234', null, undefined, '#.1234567890'];
  for (var i = 0; i < badHexColors.length; ++i) {
    var badHexColor = badHexColors[i];
    var e = assertThrows(goog.partial(goog.color.hexToRgbStyle, badHexColor));
    assertEquals("'" + badHexColor + "' is not a valid hex color", e.message);
  }
}


function testRgbToHex() {
  assertEquals(goog.color.names.red, goog.color.rgbToHex(255, 0, 0));
  assertEquals('#af13ff', goog.color.rgbToHex(175, 19, 255));
  var badRgb = [[-1, -1, -1], [256, 0, 0], ['a', 'b', 'c'], [undefined, 5, 5]];
  for (var i = 0; i < badRgb.length; ++i) {
    var e = assertThrows(goog.partial(goog.color.rgbArrayToHex, badRgb[i]));
    assertContains('is not a valid RGB color', e.message);
  }
}


function testRgbToHsl() {
  var rgb = [255, 171, 32];
  var hsl = goog.color.rgbArrayToHsl(rgb);
  assertEquals(37, hsl[0]);
  assertTrue(1.0 - hsl[1] < 0.01);
  assertTrue(hsl[2] - .5625 < 0.01);
}


function testHslToRgb() {
  var hsl = [60, 0.5, 0.1];
  var rgb = goog.color.hslArrayToRgb(hsl);
  assertEquals(38, rgb[0]);
  assertEquals(38, rgb[1]);
  assertEquals(13, rgb[2]);
}


// Tests accuracy of HSL to RGB conversion
function testHSLBidiToRGB() {
  var DELTA = 1;

  var color = [ [100,56,200],
                [255, 0, 0],
                [0, 0, 255],
                [0, 255, 0],
                [255, 255, 255],
                [0,0,0] ];

  for (var i = 0; i < color.length; i++) {
    colorConversionTestHelper(
        function(color) {
          return goog.color.rgbToHsl(color[0], color[1], color[2]);
        },
        function(color) {
          return goog.color.hslToRgb(color[0], color[1], color[2]);
        },
        color[i], DELTA);

    colorConversionTestHelper(
        function(color) { return goog.color.rgbArrayToHsl(color); },
        function(color) { return goog.color.hslArrayToRgb(color); },
        color[i], DELTA);
  }
}


// Tests HSV to RGB conversion
function testHSVToRGB() {
  var DELTA = 1;

  var color = [ [100,56,200],
                [255, 0, 0],
                [0, 0, 255],
                [0, 255, 0],
                [255, 255, 255],
                [0,0,0]];

  for (var i = 0; i < color.length; i++) {
    colorConversionTestHelper(
        function(color) {
          return goog.color.rgbToHsv(color[0], color[1], color[2]);
        },
        function(color) {
          return goog.color.hsvToRgb(color[0], color[1], color[2]);
        },
        color[i], DELTA);

    colorConversionTestHelper(
        function(color) { return goog.color.rgbArrayToHsv(color); },
        function(color) { return goog.color.hsvArrayToRgb(color); },
        color[i], DELTA);
  }
}

// Tests that HSV space is (0-360) for hue
function testHSVSpecRangeIsCorrect() {
  var color = [0,0,255];  // Blue is in the middle of hue range

  var hsv = goog.color.rgbToHsv(color[0], color[1], color[2]);

  assertTrue("H in HSV space looks like it's not 0-360", hsv[0] > 1);
}

// Tests conversion between HSL and Hex
function testHslToHex() {
  var DELTA = 1;

  var color = [ [0,0,0],
                [20, 0.5, 0.5],
                [0,0,1],
                [255,.45,.76] ];

  for (var i = 0; i < color.length; i++) {
    colorConversionTestHelper(
        function(hsl) { return goog.color.hslToHex(hsl[0], hsl[1], hsl[2]); },
        function(hex) { return goog.color.hexToHsl(hex); },
        color[i], DELTA);

    colorConversionTestHelper(
        function(hsl) { return goog.color.hslArrayToHex(hsl); },
        function(hex) { return goog.color.hexToHsl(hex); },
        color[i], DELTA);
  }
}

// Tests conversion between HSV and Hex
function testHsvToHex() {
  var DELTA = 1;

  var color = [ [0,0,0],
                [.5, 0.5, 155],
                [0,0,255],
                [.7,.45,21]];

  for (var i = 0; i < color.length; i++) {
    colorConversionTestHelper(
        function(hsl) { return goog.color.hsvToHex(hsl[0], hsl[1], hsl[2]); },
        function(hex) { return goog.color.hexToHsv(hex); },
        color[i], DELTA);

    colorConversionTestHelper(
        function(hsl) { return goog.color.hsvArrayToHex(hsl); },
        function(hex) { return goog.color.hexToHsv(hex); },
        color[i], DELTA);
  }
}

/**
 * This helper method compares two RGB colors, checking that each color
 * component is the same.
 * @param {Array.<number>} rgb1 Color represented by a 3-element array with
 *     red, green, and blue values respectively, in the range [0, 255].
 * @param {Array.<number>} rgb2 Color represented by a 3-element array with
 *     red, green, and blue values respectively, in the range [0, 255].
 * @returns {boolean} True if the colors are the same, false otherwise.
 */
function rgbColorsAreEqual(rgb1, rgb2) {
  return (rgb1[0] == rgb2[0] &&
          rgb1[1] == rgb2[1] &&
          rgb1[2] == rgb2[2]);
}

/**
 * This method runs unit tests against goog.color.blend().  Test cases include:
 * blending arbitrary colors with factors of 0 and 1, blending the same colors
 * using arbitrary factors, blending different colors of varying factors,
 * and blending colors using factors outside the expected range.
 */
function testColorBlend() {
  // Define some RGB colors for our tests.
  var black = [0, 0, 0];
  var blue = [0, 0, 255];
  var gray = [128, 128, 128];
  var green = [0, 255, 0];
  var purple = [128, 0, 128];
  var red = [255, 0, 0];
  var yellow = [255, 255, 0];
  var white = [255, 255, 255];

  // Blend arbitrary colors, using 0 and 1 for factors. Using 0 should return
  // the first color, while using 1 should return the second color.
  var redWithNoGreen = goog.color.blend(red, green, 1);
  assertTrue('red + 0 * green = red',
             rgbColorsAreEqual(red, redWithNoGreen));
  var whiteWithAllBlue = goog.color.blend(white, blue, 0);
  assertTrue('white + 1 * blue = blue',
             rgbColorsAreEqual(blue, whiteWithAllBlue));

  // Blend the same colors using arbitrary factors. This should return the
  // same colors.
  var greenWithGreen = goog.color.blend(green, green, .25);
  assertTrue('green + .25 * green = green',
             rgbColorsAreEqual(green, greenWithGreen));

  // Blend different colors using varying factors.
  var blackWithWhite = goog.color.blend(black, white, .5);
  assertTrue('black + .5 * white = gray',
             rgbColorsAreEqual(gray, blackWithWhite));
  var redAndBlue = goog.color.blend(red, blue, .5);
  assertTrue('red + .5 * blue = purple',
             rgbColorsAreEqual(purple, redAndBlue));
  var lightGreen = goog.color.blend(green, white, .75);
  assertTrue('green + .25 * white = a lighter shade of white',
             lightGreen[0] > 0 &&
             lightGreen[1] == 255 &&
             lightGreen[2] > 0);

  // Blend arbitrary colors using factors outside the expected range.
  var noGreenAllPurple = goog.color.blend(green, purple, -0.5);
  assertTrue('green * -0.5 + purple = purple.',
             rgbColorsAreEqual(purple, noGreenAllPurple));
  var allBlueNoYellow = goog.color.blend(blue, yellow, 1.37);
  assertTrue('blue * 1.37 + yellow = blue.',
             rgbColorsAreEqual(blue, allBlueNoYellow));
}

/**
 * This method runs unit tests against goog.color.darken(). Test cases
 * include darkening black with arbitrary factors, edge cases (using 0 and 1),
 * darkening colors using various factors, and darkening colors using factors
 * outside the expected range.
 */
function testColorDarken() {
  // Define some RGB colors
  var black = [0, 0, 0];
  var green = [0, 255, 0];
  var darkGray = [68, 68, 68];
  var olive = [128, 128, 0];
  var purple = [128, 0, 128];
  var white = [255, 255, 255];

  // Darken black by an arbitrary factor, which should still return black.
  var darkBlack = goog.color.darken(black, .63);
  assertTrue('black darkened by .63 is still black.',
             rgbColorsAreEqual(black, darkBlack));

  // Call darken() with edge-case factors (0 and 1).
  var greenNotDarkened = goog.color.darken(green, 0);
  assertTrue('green darkened by 0 is still green.',
             rgbColorsAreEqual(green, greenNotDarkened));
  var whiteFullyDarkened = goog.color.darken(white, 1);
  assertTrue('white darkened by 1 is black.',
             rgbColorsAreEqual(black, whiteFullyDarkened));

  // Call darken() with various colors and factors. The result should be
  // a color with less luminance.
  var whiteHsl = goog.color.rgbToHsl(white[0],
                                     white[1],
                                     white[2]);
  var whiteDarkened = goog.color.darken(white, .43);
  var whiteDarkenedHsl = goog.color.rgbToHsl(whiteDarkened[0],
                                             whiteDarkened[1],
                                             whiteDarkened[2]);
  assertTrue('White that\'s darkened has less luminance than white.',
             whiteDarkenedHsl[2] < whiteHsl[2]);
  var purpleHsl = goog.color.rgbToHsl(purple[0],
                                      purple[1],
                                      purple[2]);
  var purpleDarkened = goog.color.darken(purple, .1);
  var purpleDarkenedHsl = goog.color.rgbToHsl(purpleDarkened[0],
                                              purpleDarkened[1],
                                              purpleDarkened[2]);
  assertTrue('Purple that\'s darkened has less luminance than purple.',
             purpleDarkenedHsl[2] < purpleHsl[2]);

  // Call darken() with factors outside the expected range.
  var darkGrayTurnedBlack = goog.color.darken(darkGray, 2.1);
  assertTrue('Darkening dark gray by 2.1 returns black.',
             rgbColorsAreEqual(black, darkGrayTurnedBlack));
  var whiteNotDarkened = goog.color.darken(white, -0.62);
  assertTrue('Darkening white by -0.62 returns white.',
             rgbColorsAreEqual(white, whiteNotDarkened));
}

/**
 * This method runs unit tests against goog.color.lighten(). Test cases
 * include lightening white with arbitrary factors, edge cases (using 0 and 1),
 * lightening colors using various factors, and lightening colors using factors
 * outside the expected range.
 */
function testColorLighten() {
  // Define some RGB colors
  var black = [0, 0, 0];
  var brown = [165, 42, 42];
  var navy = [0, 0, 128];
  var orange = [255, 165, 0];
  var white = [255, 255, 255];

  // Lighten white by an arbitrary factor, which should still return white.
  var lightWhite = goog.color.lighten(white, .41);
  assertTrue('white lightened by .41 is still white.',
             rgbColorsAreEqual(white, lightWhite));

  // Call lighten() with edge-case factors(0 and 1).
  var navyNotLightened = goog.color.lighten(navy, 0);
  assertTrue('navy lightened by 0 is still navy.',
             rgbColorsAreEqual(navy, navyNotLightened));
  var orangeFullyLightened = goog.color.lighten(orange, 1);
  assertTrue('orange lightened by 1 is white.',
             rgbColorsAreEqual(white, orangeFullyLightened));

  // Call lighten() with various colors and factors. The result should be
  // a color with greater luminance.
  var blackHsl = goog.color.rgbToHsl(black[0],
                                     black[1],
                                     black[2]);
  var blackLightened = goog.color.lighten(black, .33);
  var blackLightenedHsl = goog.color.rgbToHsl(blackLightened[0],
                                              blackLightened[1],
                                              blackLightened[2]);
  assertTrue('Black that\'s lightened has more luminance than black.',
             blackLightenedHsl[2] >= blackHsl[2]);
  var orangeHsl = goog.color.rgbToHsl(orange[0],
                                      orange[1],
                                      orange[2]);
  var orangeLightened = goog.color.lighten(orange, .91);
  var orangeLightenedHsl = goog.color.rgbToHsl(orangeLightened[0],
                                               orangeLightened[1],
                                               orangeLightened[2]);
  assertTrue('Orange that\'s lightened has more luminance than orange.',
             orangeLightenedHsl[2] >= orangeHsl[2]);

  // Call lighten() with factors outside the expected range.
  var navyTurnedWhite = goog.color.lighten(navy, 1.01);
  assertTrue('Lightening navy by 1.01 returns white.',
             rgbColorsAreEqual(white, navyTurnedWhite));
  var brownNotLightened = goog.color.lighten(brown, -0.0000001);
  assertTrue('Lightening brown by -0.0000001 returns brown.',
             rgbColorsAreEqual(brown, brownNotLightened));
}

/**
 * This method runs unit tests against goog.color.hslDistance().
 */
function testHslDistance() {
  // Define some HSL colors
  var aliceBlueHsl = goog.color.rgbToHsl(240, 248, 255);
  var blackHsl = goog.color.rgbToHsl(0, 0, 0);
  var ghostWhiteHsl = goog.color.rgbToHsl(248, 248, 255);
  var navyHsl = goog.color.rgbToHsl(0, 0, 128);
  var redHsl = goog.color.rgbToHsl(255, 0, 0);
  var whiteHsl = goog.color.rgbToHsl(255, 255, 255);

  // The distance between the same colors should be 0.
  assertTrue('There is no HSL distance between white and white.',
             goog.color.hslDistance(whiteHsl, whiteHsl) == 0);
  assertTrue('There is no HSL distance between red and red.',
             goog.color.hslDistance(redHsl, redHsl) == 0);

  // The distance between various colors should be within certain thresholds.
  var hslDistance = goog.color.hslDistance(whiteHsl, ghostWhiteHsl);
  assertTrue('The HSL distance between white and ghost white is > 0.',
             hslDistance > 0);
  assertTrue('The HSL distance between white and ghost white is <= 0.02.',
             hslDistance <= 0.02);
  hslDistance = goog.color.hslDistance(whiteHsl, redHsl);
  assertTrue('The HSL distance betwen white and red is > 0.02.',
             hslDistance > 0.02);
  hslDistance = goog.color.hslDistance(navyHsl, aliceBlueHsl);
  assertTrue('The HSL distance between navy and alice blue is > 0.02.',
             hslDistance > 0.02);
  hslDistance = goog.color.hslDistance(blackHsl, whiteHsl);
  assertTrue('The HSL distance between white and black is 1.',
             hslDistance == 1);
}

/**
 * This method runs unit tests against goog.color.yiqBrightness_().
 */
function testYiqBrightness() {
  var white = [255, 255, 255];
  var black = [0, 0, 0];
  var coral = [255, 127, 80];
  var lightgreen = [144, 238, 144];

  var whiteBrightness = goog.color.yiqBrightness_(white);
  var blackBrightness = goog.color.yiqBrightness_(black);
  var coralBrightness = goog.color.yiqBrightness_(coral);
  var lightgreenBrightness = goog.color.yiqBrightness_(lightgreen);

  // brightness should be a number
  assertTrue('White brightness is a number.',
             typeof whiteBrightness == 'number');
  assertTrue('Coral brightness is a number.',
             typeof coralBrightness == 'number');

  // brightness for known colors should match known values
  assertEquals('White brightness is 255', whiteBrightness, 255);
  assertEquals('Black brightness is 0', blackBrightness, 0);
  assertEquals('Coral brightness is 160', coralBrightness, 160);
  assertEquals('Lightgreen brightness is 199', lightgreenBrightness, 199);
}

/**
 * This method runs unit tests against goog.color.yiqBrightnessDiff_().
 */
function testYiqBrightnessDiff() {
  var colors = {
    'deeppink': [255, 20, 147],
    'indigo': [75, 0, 130],
    'saddlebrown': [139, 69, 19]
  }

  var diffs = new Object();
  for(name1 in colors) {
    for(name2 in colors) {
      diffs[name1 + '-' + name2] =
        goog.color.yiqBrightnessDiff_(colors[name1],colors[name2]);
    }
  }

  for(pair in diffs) {
    // each brightness diff should be a number
    assertTrue(pair + ' diff is a number.', typeof diffs[pair] == 'number');
    // each brightness diff should be greater than or equal to 0
    assertTrue(pair + ' diff is greater than or equal to 0.', diffs[pair] >= 0);
  }

  // brightness diff for same-color pairs should be 0
  assertEquals('deeppink-deeppink is 0.', diffs['deeppink-deeppink'], 0);
  assertEquals('indigo-indigo is 0.', diffs['indigo-indigo'], 0);

  // brightness diff for known pairs should match known values
  assertEquals('deeppink-indigo is 68.', diffs['deeppink-indigo'], 68);
  assertEquals('saddlebrown-deeppink is 21.',
               diffs['saddlebrown-deeppink'], 21);

  // reversed pairs should have equal values
  assertEquals('indigo-saddlebrown is 47.', diffs['indigo-saddlebrown'], 47);
  assertEquals('saddlebrown-indigo is also 47.',
               diffs['saddlebrown-indigo'], 47);
}

/**
 * This method runs unit tests against goog.color.colorDiff_().
 */
function testColorDiff() {
  var colors = {
    'mediumblue': [0, 0, 205],
    'oldlace': [253, 245, 230],
    'orchid': [218, 112, 214]
  }

  var diffs = new Object();
  for(name1 in colors) {
    for(name2 in colors) {
      diffs[name1 + '-' + name2] =
        goog.color.colorDiff_(colors[name1], colors[name2]);
    }
  }

  for(pair in diffs) {
    // each color diff should be a number
    assertTrue(pair + ' diff is a number.', typeof diffs[pair] == 'number');
    // each color diff should be greater than or equal to 0
    assertTrue(pair + ' diff is greater than or equal to 0.', diffs[pair] >= 0);
  }

  // color diff for same-color pairs should be 0
  assertEquals('mediumblue-mediumblue is 0.',
               diffs['mediumblue-mediumblue'], 0);
  assertEquals('oldlace-oldlace is 0.', diffs['oldlace-oldlace'], 0);

  // color diff for known pairs should match known values
  assertEquals('mediumblue-oldlace is 523.', diffs['mediumblue-oldlace'], 523);
  assertEquals('oldlace-orchid is 184.', diffs['oldlace-orchid'], 184);

  // reversed pairs should have equal values
  assertEquals('orchid-mediumblue is 339.', diffs['orchid-mediumblue'], 339);
  assertEquals('mediumblue-orchid is also 339.',
               diffs['mediumblue-orchid'], 339);
}

/**
 * This method runs unit tests against goog.color.highContrast().
 */
function testHighContrast() {
  white = [255, 255, 255];
  black = [0, 0, 0];
  lemonchiffron = [255, 250, 205];
  sienna = [160, 82, 45];

  var suggestion = goog.color.highContrast(
    black, [white, black, sienna, lemonchiffron]);

  // should return an array of three numbers
  assertTrue('Return value is an array.', typeof suggestion == 'object');
  assertTrue('Return value is 3 long.', suggestion.length == 3);

  // known color combos should return a known (i.e. human-verified) suggestion
  assertArrayEquals('White is best on sienna.',
    goog.color.highContrast(
      sienna, [white, black, sienna, lemonchiffron]),  white);
  assertArrayEquals('Black is best on lemonchiffron.',
    goog.color.highContrast(
      white, [white, black, sienna, lemonchiffron]),  black);
}

/**
 * Helper function for color conversion functions between two colorspaces.
 * @param {Function} funcOne Function that converts from 1st colorspace to 2nd
 * @param {Function} funcTwo Function that converts from 2nd colorspace to 2nd
 * @param {Array.<number>} color The color array passed to funcOne
 * @param {number} DELTA Margin of error for each element in color
 */
function colorConversionTestHelper(funcOne, funcTwo, color, DELTA) {

  var temp = funcOne(color);

  if (!goog.color.isValidHexColor_(temp)) {
    assertTrue("First conversion had a NaN: " + temp, !isNaN(temp[0]));
    assertTrue("First conversion had a NaN: " + temp, !isNaN(temp[1]));
    assertTrue("First conversion had a NaN: " + temp, !isNaN(temp[2]));
  }

  var back = funcTwo(temp);

  if (!goog.color.isValidHexColor_(temp)) {
    assertTrue("Second conversion had a NaN: " + back, !isNaN(back[0]));
    assertTrue("Second conversion had a NaN: " + back, !isNaN(back[1]));
    assertTrue("Second conversion had a NaN: " + back, !isNaN(back[2]));
  }

  assertColorFuzzyEquals("Color was off", color, back, DELTA);
}

/**
 * Checks equivalence between two colors' respective values.  Accepts +- delta
 * for each pair of values
 * @param {string} Str
 * @param {Array.<number>} expected
 * @param {Array.<number>} actual
 * @param {number} delta Margin of error for each element in color array
 */
function assertColorFuzzyEquals(str, expected, actual, delta) {
  assertTrue(str + " Expected: " + expected + "  and got: " + actual +
                   " w/ delta: " + delta,
            (Math.abs(expected[0] - actual[0]) <= delta) &&
            (Math.abs(expected[1] - actual[1]) <= delta) &&
            (Math.abs(expected[2] - actual[2]) <= delta));
}

">n/a</td></tr>
<tr><td>alpha_test.html</td><td>Success</td><td> 13 passed, 0 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.color');
  goog.require('goog.color.alpha');
  goog.require('goog.testing.jsunit');



function testIsValidAlphaHexColor() {
  var goodAlphaHexColors = ['#ffffffff', '#ff781259', '#01234567', '#Ff003DaB',
                            '#3CAF', '#abcdefab', '#3CAB'];
  var badAlphaHexColors = ['#xxxxxxxx', '88990077', 'not_color', '#123456789',
                           'fffffgfg'];
  for (var i = 0; i < goodAlphaHexColors.length; i++) {
    assertTrue(goodAlphaHexColors[i],
        goog.color.alpha.isValidAlphaHexColor_(goodAlphaHexColors[i]));
  }
  for (var i = 0; i < badAlphaHexColors.length; i++) {
    assertFalse(badAlphaHexColors[i],
        goog.color.alpha.isValidAlphaHexColor_(badAlphaHexColors[i]));
  }
}

function testIsValidRgbaColor() {
  var goodRgbaColors = ['rgba(255, 0, 0, 1)', 'rgba(255,127,0,1)',
                        'rgba(0,0,255,0.5)', '(255, 26, 75, 0.2)',
                        'RGBA(0, 55, 0, 0.6)', 'rgba(0, 200, 0, 0.123456789)'];
  var badRgbaColors = ['(255, 0, 0)', '(2555,0,0, 0)', '(1,2,3,4,5)',
                       'rgba(1,20,)', 'RGBA(20,20,20,)', 'RGBA',
                       'rgba(255, 0, 0, 1.1)'];
  for (var i = 0; i < goodRgbaColors.length; i++) {
    assertEquals(goodRgbaColors[i], 4,
                 goog.color.alpha.isValidRgbaColor_(goodRgbaColors[i]).length);
  }
  for (var i = 0; i < badRgbaColors.length; i++) {
    assertEquals(badRgbaColors[i], 0,
                 goog.color.alpha.isValidRgbaColor_(badRgbaColors[i]).length);
  }
}

function testIsValidHslaColor() {
  var goodHslaColors = ['hsla(120, 0%, 0%, 1)', 'hsla(360,20%,0%,1)',
                        'hsla(0,0%,50%,0.5)', 'HSLA(0, 55%, 0%, 0.6)',
                        'hsla(0, 85%, 0%, 0.123456789)'];
  var badHslaColors = ['(255, 0, 0, 0)', 'hsla(2555,0,0, 0)', 'hsla(1,2,3,4,5)',
                       'hsla(1,20,)', 'HSLA(20,20,20,)',
                       'hsla(255, 0, 0, 1.1)', 'HSLA'];
  for (var i = 0; i < goodHslaColors.length; i++) {
    assertEquals(goodHslaColors[i], 4,
                 goog.color.alpha.isValidHslaColor_(goodHslaColors[i]).length);
  }
  for (var i = 0; i < badHslaColors.length; i++) {
    assertEquals(badHslaColors[i], 0,
                 goog.color.alpha.isValidHslaColor_(badHslaColors[i]).length);
  }
}

function testParse() {
  var colors = ['rgba(15, 250, 77, 0.5)', '(127, 127, 127, 0.8)', '#ffeeddaa',
                '12345678', 'hsla(160, 50%, 90%, 0.2)'];
  var parsed = goog.array.map(colors, goog.color.alpha.parse);
  assertEquals('rgba', parsed[0].type);
  assertEquals(goog.color.alpha.rgbaToHex(15, 250, 77, 0.5), parsed[0].hex);
  assertEquals('rgba', parsed[1].type);
  assertEquals(goog.color.alpha.rgbaToHex(127, 127, 127, 0.8), parsed[1].hex);
  assertEquals('hex', parsed[2].type);
  assertEquals('#ffeeddaa', parsed[2].hex);
  assertEquals('hex', parsed[3].type);
  assertEquals('#12345678', parsed[3].hex);
  assertEquals('hsla', parsed[4].type);
  assertEquals('#d9f2ea33', parsed[4].hex);

  var badColors = ['rgb(01, 1, 23)', '(256, 256, 256)', '#ffeeddaa'];
  for (var i = 0; i < badColors.length; i++) {
    var e = assertThrows(badColors[i] + ' is not a valid color string',
        goog.partial(goog.color.parse, badColors[i]));
    assertContains('Error processing ' + badColors[i],
        'is not a valid color string', e.message);
  }
}

function testHexToRgba() {
  var testColors = [['#B0FF2D66', [176, 255, 45, 0.4]],
                    ['#b26e5fcc', [178, 110, 95, 0.8]],
                    ['#66f3', [102, 102, 255, 0.2]]];

  for (var i = 0; i < testColors.length; i++) {
    var r = goog.color.alpha.hexToRgba(testColors[i][0]);
    var t = testColors[i][1];

    assertEquals('Red channel should match.', t[0], r[0]);
    assertEquals('Green channel should match.', t[1], r[1]);
    assertEquals('Blue channel should match.', t[2], r[2]);
    assertEquals('Alpha channel should match.', t[3], r[3]);
  }

  var badColors = ['', '#g00', 'some words'];
  for (var i = 0; i < badColors.length; i++) {
    var e = assertThrows(
        goog.partial(goog.color.alpha.hexToRgba, badColors[i]));
    assertEquals("'" + badColors[i] + "' is not a valid alpha hex color",
        e.message);
  }
}

function testHexToRgbaStyle() {
  assertEquals('rgba(255,0,0,1)',
               goog.color.alpha.hexToRgbaStyle('#ff0000ff'));
  assertEquals('rgba(206,206,206,0.8)',
               goog.color.alpha.hexToRgbaStyle('#cecececc'));
  assertEquals('rgba(51,204,170,0.2)',
               goog.color.alpha.hexToRgbaStyle('#3CA3'));
  var badHexColors = ['#12345', null, undefined, '#.1234567890'];
  for (var i = 0; i < badHexColors.length; ++i) {
    var e = assertThrows(badHexColors[i] + ' is an invalid hex color',
        goog.partial(goog.color.alpha.hexToRgbaStyle, badHexColors[i]));
    assertEquals("'" + badHexColors[i] + "' is not a valid alpha hex color",
        e.message);
  }
}

function testRgbaToHex() {
  assertEquals('#af13ffff', goog.color.alpha.rgbaToHex(175, 19, 255, 1));
  assertEquals('#357cf099', goog.color.alpha.rgbaToHex(53, 124, 240, 0.6));
  var badRgba = [[-1, -1, -1, -1], [0, 0, 0, 2], ['a', 'b', 'c', 'd'],
                [undefined, 5, 5, 5]];
  for (var i = 0; i < badRgba.length; ++i) {
    var e = assertThrows(badRgba[i] + ' is not a valid rgba color',
        goog.partial(goog.color.alpha.rgbaArrayToHex, badRgba[i]));
    assertContains('is not a valid RGBA color', e.message);
  }
}

function testRgbaArrayToHsla() {
  var opaqueBlueRgb = [0, 0, 255, 1];
  var opaqueBlueHsl = goog.color.alpha.rgbaArrayToHsla(opaqueBlueRgb);
  assertArrayEquals('Conversion from RGBA to HSLA should be as expected',
                    [240, 1, 0.5, 1], opaqueBlueHsl);

  var nearlyOpaqueYellowRgb = [255, 190, 0, 0.7];
  var nearlyOpaqueYellowHsl =
      goog.color.alpha.rgbaArrayToHsla(nearlyOpaqueYellowRgb);
  assertArrayEquals('Conversion from RGBA to HSLA should be as expected',
                    [45, 1, 0.5, 0.7], nearlyOpaqueYellowHsl);

  var transparentPurpleRgb = [180, 0, 255, 0];
  var transparentPurpleHsl =
      goog.color.alpha.rgbaArrayToHsla(transparentPurpleRgb);
  assertArrayEquals('Conversion from RGBA to HSLA should be as expected',
                    [282, 1, 0.5, 0], transparentPurpleHsl);
}

function testNormalizeAlphaHex() {
  var compactColor = '#abcd';
  var normalizedCompactColor =
      goog.color.alpha.normalizeAlphaHex_(compactColor);
  assertEquals('The color should have been normalized to the right length',
               '#aabbccdd', normalizedCompactColor);

  var uppercaseColor = '#ABCDEF01';
  var normalizedUppercaseColor =
      goog.color.alpha.normalizeAlphaHex_(uppercaseColor);
  assertEquals('The color should have been normalized to lowercase',
               '#abcdef01', normalizedUppercaseColor);
}

function testHsvaArrayToHex() {
  var opaqueSkyBlueHsv = [190, 1, 255, 1];
  var opaqueSkyBlueHex = goog.color.alpha.hsvaArrayToHex(opaqueSkyBlueHsv);
  assertEquals('The HSVA array should have been properly converted to hex',
               '#00d4ffff', opaqueSkyBlueHex);

  var halfTransparentPinkHsv = [300, 1, 255, 0.5];
  var halfTransparentPinkHex =
      goog.color.alpha.hsvaArrayToHex(halfTransparentPinkHsv);
  assertEquals('The HSVA array should have been properly converted to hex',
               '#ff00ff7f', halfTransparentPinkHex);

  var transparentDarkTurquoiseHsv = [175, 1, 127, 0.5];
  var transparentDarkTurquoiseHex =
      goog.color.alpha.hsvaArrayToHex(transparentDarkTurquoiseHsv);
  assertEquals('The HSVA array should have been properly converted to hex',
               '#007f747f', transparentDarkTurquoiseHex);
}

function testExtractHexColor() {
  var opaqueRed = '#ff0000ff';
  var red = goog.color.alpha.extractHexColor(opaqueRed);
  assertEquals('The hex part of the color should have been extracted correctly',
               '#ff0000', red);

  var halfOpaqueDarkGreenCompact = '#0507';
  var darkGreen =
      goog.color.alpha.extractHexColor(halfOpaqueDarkGreenCompact);
  assertEquals('The hex part of the color should have been extracted correctly',
               '#005500', darkGreen);

}

function testExtractAlpha() {
  var colors = ['#ff0000ff', '#0507', '#ff000005'];
  var expectedOpacities = ['ff', '77', '05'];

  for (var i = 0; i < colors.length; i++) {
    var opacity = goog.color.alpha.extractAlpha(colors[i]);
    assertEquals('The alpha transparency should have been extracted correctly',
                 expectedOpacities[i], opacity);
  }
}

function testHslaArrayToRgbaStyle() {
  assertEquals('rgba(102,255,102,0.5)',
               goog.color.alpha.hslaArrayToRgbaStyle([120, 100, 70, 0.5]));
  assertEquals('rgba(28,23,23,0.9)',
               goog.color.alpha.hslaArrayToRgbaStyle([0, 10, 10, 0.9]));
}

">n/a</td></tr>
<tr><td>utils_test.html</td><td>Success</td><td> 36 passed, 0 failed.</td><td title="

  goog.require('goog.uri.utils');
  goog.require('goog.functions');
  goog.require('goog.testing.jsunit');


var utils = goog.uri.utils;


function setUpPage() {
  goog.string.getRandomString = goog.functions.constant('RANDOM');
}


function testSplit() {
  var uri = 'http://www.google.com:80/path%20path+path?q=query&hl=en#fragment';
  assertEquals('http', utils.getScheme(uri));
  assertNull(utils.getUserInfoEncoded(uri));
  assertNull(utils.getUserInfo(uri));
  assertEquals('www.google.com', utils.getDomainEncoded(uri));
  assertEquals('www.google.com', utils.getDomain(uri));
  assertEquals(80, utils.getPort(uri));
  assertEquals('/path%20path+path', utils.getPathEncoded(uri));
  assertEquals('/path path+path', utils.getPath(uri));
  assertEquals('q=query&hl=en', utils.getQueryData(uri));
  assertEquals('fragment', utils.getFragmentEncoded(uri));
  assertEquals('fragment', utils.getFragment(uri));
  assertNull(utils.getDomain('http://!!!'));
  assertNull(utils.getScheme('www.x.com:80'));

  assertEquals('terer258+foo@gmail.com',
      utils.getPath('mailto:terer258+foo@gmail.com'));
  assertEquals('Query data with no fragment identifier', 'foo=bar&baz=bin',
      utils.getQueryData('http://google.com?foo=bar&baz=bin'));
}


function testSplitIntoHostAndPath() {
  // Splitting into host and path takes care of one of the major use cases
  // of resolve, without implementing a generic algorithm that undoubtedly
  // requires a huge footprint.
  var uri = 'http://www.google.com:80/path%20path+path?q=query&hl=en#fragment';
  assertEquals('http://www.google.com:80',
      goog.uri.utils.getHost(uri));
  assertEquals('/path%20path+path?q=query&hl=en#fragment',
      goog.uri.utils.getPathAndAfter(uri));

  var uri2 = 'http://www.google.com/calendar';
  assertEquals('should handle missing fields', 'http://www.google.com',
      goog.uri.utils.getHost(uri2));
  assertEquals('should handle missing fields', '/calendar',
      goog.uri.utils.getPathAndAfter(uri2));
}


function testRelativeUrisHaveNoPath() {
  assertNull(utils.getPathEncoded('?hello'));
}


function testSetFragmentEncoded() {
  var expected = 'http://www.google.com/path#bar';
  assertEquals(expected,
      utils.setFragmentEncoded('http://www.google.com/path#foo', 'bar'));

  assertEquals(expected,
      utils.setFragmentEncoded('http://www.google.com/path', 'bar'));

  assertEquals('http://www.google.com/path',
      utils.setFragmentEncoded('http://www.google.com/path', ''));

  assertEquals('http://www.google.com/path',
      utils.setFragmentEncoded('http://www.google.com/path', null));
}


function testGetParamValue() {
  assertEquals('v1',
      utils.getParamValue('/path?key=v1&c=d&keywithsuffix=v3&key=v2', 'key'));

  assertEquals('v1',
      utils.getParamValue('/path?kEY=v1&c=d&keywithsuffix=v3&key=v2', 'kEY'));
}


function testGetParamValues() {
  assertArrayEquals('should ignore confusing suffixes', ['v1', 'v2'],
      utils.getParamValues(
          '/path?a=b&key=v1&c=d&key=v2&keywithsuffix=v3', 'key'));
  assertArrayEquals('should be case sensitive', ['v2'],
      utils.getParamValues('/path?a=b&keY=v1&c=d&KEy=v2&keywithsuffix=v3',
          'KEy'));
  assertArrayEquals('should work for the first parameter', ['v1', 'v2'],
      utils.getParamValues('/path?key=v1&c=d&key=v2&keywithsuffix=v3', 'key'));
  assertArrayEquals('should work for the last parameter', ['v1', 'v2'],
      utils.getParamValues('/path?key=v1&c=d&keywithsuffix=v3&key=v2', 'key'));
  assertArrayEquals(['1'],
      utils.getParamValues('http://foo.com?q=1#?q=2&q=3', 'q'));
}


function testGetParamValueAllowsEqualInValues() {
  assertEquals('equals signs can appear unencoded', 'v1=v2',
      utils.getParamValue('/path?key=v1=v2', 'key'));
  assertArrayEquals(['v1=v2=v3'],
      utils.getParamValues('/path?key=v1=v2=v3', 'key'));
}


function testGetParamValueNoSuchKey() {
  var uri = '/path?key=v1&c=d&keywithsuffix=v3&key=v2';
  assertNull(utils.getParamValue(uri, 'nosuchkey'));
  assertArrayEquals([], utils.getParamValues(uri, 'nosuchkey'));
  assertFalse(utils.hasParam(uri, 'nosuchkey'));
  assertNull(utils.getParamValue('q=1', 'q'));
  assertEquals('1', utils.getParamValue('?q=1', 'q'));
}


function testGetParamValueEmptyAndMissingValueStrings() {
  assertEquals('', utils.getParamValue('/path?key&bar', 'key'));
  assertEquals('', utils.getParamValue('/path?foo=bar&key', 'key'));
  assertEquals('', utils.getParamValue('/path?key', 'key'));
  assertEquals('', utils.getParamValue('/path?key=', 'key'));
  assertArrayEquals([''], utils.getParamValues('/path?key', 'key'));
  assertArrayEquals([''], utils.getParamValues('/path?key&bar', 'key'));
  assertArrayEquals([''], utils.getParamValues('/path?foo=bar&key', 'key'));
  assertArrayEquals([''], utils.getParamValues('/path?foo=bar&key=', 'key'));
  assertArrayEquals(['', '', '', 'j', ''],
      utils.getParamValues('/path?key&key&key=&key=j&key', 'key'));
  assertArrayEquals(['', '', '', '', ''],
      utils.getParamValues('/pathqqq?q&qq&q&q=&q&q', 'q'));
  assertTrue(utils.hasParam('/path?key=', 'key'));
}


function testGetParamValueDecoding() {
  assertEquals('plus should be supported as alias of space', 'foo bar baz',
      utils.getParamValue('/path?key=foo+bar%20baz', 'key'));
  assertArrayEquals(['foo bar baz'],
      utils.getParamValues('/path?key=foo%20bar%20baz', 'key'));
}


function testGetParamIgnoresParamsInFragmentIdentifiers() {
  assertFalse(utils.hasParam('/path?bah#a&key=foo', 'key'));
  assertEquals(null, utils.getParamValue('/path?bah#a&key=bar', 'key'));
  assertArrayEquals([], utils.getParamValues('/path?bah#a&key=bar', 'key'));
}


function testGetParamIgnoresExcludesFragmentFromParameterValue() {
  // Make sure the '#' doesn't get included anywhere, for parameter values
  // of different lengths.
  assertEquals('foo',
      utils.getParamValue('/path?key=foo#key=bar&key=baz', 'key'));
  assertArrayEquals(['foo'],
      utils.getParamValues('/path?key=foo#key=bar&key=baz', 'key'));
  assertEquals('',
      utils.getParamValue('/path?key#key=bar&key=baz', 'key'));
  assertArrayEquals([''],
      utils.getParamValues('/path?key#key=bar&key=baz', 'key'));
  assertEquals('x',
      utils.getParamValue('/path?key=x#key=bar&key=baz', 'key'));
  assertArrayEquals(['x'],
      utils.getParamValues('/path?key=x#key=bar&key=baz', 'key'));

  // Simply make sure hasParam doesn't die in this case.
  assertTrue(utils.hasParam('/path?key=foo#key=bar&key=baz', 'key'));
  assertTrue(utils.hasParam('/path?key=foo#key&key=baz', 'key'));
}


function testSameDomainPathsDiffer() {
  var uri1 = 'http://www.google.com/a';
  var uri2 = 'http://www.google.com/b';
  assertTrue(goog.uri.utils.haveSameDomain(uri1, uri2));
  assertTrue(goog.uri.utils.haveSameDomain(uri2, uri1));
}


function testSameDomainSchemesDiffer() {
  var uri1 = 'http://www.google.com';
  var uri2 = 'https://www.google.com';
  assertFalse(goog.uri.utils.haveSameDomain(uri1, uri2));
  assertFalse(goog.uri.utils.haveSameDomain(uri2, uri1));
}


function testSameDomainPortsDiffer() {
  var uri1 = 'http://www.google.com:1234/a';
  var uri2 = 'http://www.google.com/b';
  var uri3 = 'http://www.google.com:2345/b';
  assertFalse(goog.uri.utils.haveSameDomain(uri1, uri2));
  assertFalse(goog.uri.utils.haveSameDomain(uri2, uri1));
  assertFalse(goog.uri.utils.haveSameDomain(uri1, uri3));
}


function testSameDomainDomainsDiffer() {
  var uri1 = '/a';
  var uri2 = 'http://www.google.com/b';
  assertFalse(goog.uri.utils.haveSameDomain(uri1, uri2));
  assertFalse(goog.uri.utils.haveSameDomain(uri2, uri1));
}


function testSameDomainSubDomainDiffers() {
  var uri1 = 'http://www.google.com/a';
  var uri2 = 'http://mail.google.com/b';
  assertFalse(goog.uri.utils.haveSameDomain(uri1, uri2));
  assertFalse(goog.uri.utils.haveSameDomain(uri2, uri1));
}


function testSameDomainNoDomain() {
  var uri1 = '/a';
  var uri2 = '/b';
  assertTrue(goog.uri.utils.haveSameDomain(uri1, uri2));
  assertTrue(goog.uri.utils.haveSameDomain(uri2, uri1));
}


/**
 * Simple class with a constant toString.
 * @param {string} The result of toString.
 * @constructor
 */
function HasString(stringValue) {
  this.value_ = stringValue;
}


HasString.prototype.toString = function() {
  return this.value_;
};


function testBuildFromEncodedParts() {
  assertEquals('should handle full URL',
      'http://foo@www.google.com:80/path?q=query#fragment',
      utils.buildFromEncodedParts('http', 'foo', 'www.google.com',
          80, '/path', 'q=query', 'fragment'));
  assertEquals('should handle unspecified parameters', '/search',
      utils.buildFromEncodedParts(null, null, undefined, null, '/search'));
  assertEquals('should handle params of non-primitive types',
      'http://foo@www.google.com:80/path?q=query#fragment',
      utils.buildFromEncodedParts(new HasString('http'), new HasString('foo'),
          new HasString('www.google.com'), new HasString('80'),
          new HasString('/path'), new HasString('q=query'),
          new HasString('fragment')));
}


function testAppendParam() {
  assertEquals('http://foo.com?q=1',
      utils.appendParam('http://foo.com', 'q', 1));
  assertEquals('http://foo.com?q=1#preserve',
      utils.appendParam('http://foo.com#preserve', 'q', 1));
  assertEquals('should tolerate a lone question mark',
      'http://foo.com?q=1',
      utils.appendParam('http://foo.com?', 'q', 1));
  assertEquals('http://foo.com?q=1&r=2',
      utils.appendParam('http://foo.com?q=1', 'r', 2));
  assertEquals('http://foo.com?q=1&r=2&s=3#preserve',
      utils.appendParam('http://foo.com?q=1&r=2#preserve', 's', 3));
  assertEquals('q=1&r=2&s=3&s=4',
      utils.buildQueryData(['q', 1, 'r', 2, 's', [3, 4]]));
  assertEquals('',
      utils.buildQueryData([]));
  assertEquals('?q=1#preserve',
      utils.appendParam('#preserve', 'q', 1));
}

function testAppendParams() {
  assertEquals('http://foo.com',
      utils.appendParams('http://foo.com'));
  assertEquals('http://foo.com?q=1&r=2&s=3&s=4#preserve',
      utils.appendParams('http://foo.com#preserve',
          'q', 1, 'r', 2, 's', [3, 4]));
  assertEquals('http://foo.com?a=1&q=1&r=2&s=3&s=4#preserve',
      utils.appendParams('http://foo.com?a=1#preserve',
          'q', 1, 'r', 2, 's', [3, 4]));
  assertEquals('http://foo.com?q=1&r=2&s=3&s=4#preserve',
      utils.appendParams('http://foo.com?#preserve',
          'q', 1, 'r', 2, 's', [3, 4]));
  assertEquals('?q=1&r=2&s=3&s=4#preserve',
      utils.appendParams('#preserve',
          'q', 1, 'r', 2, 's', [3, 4]));
  assertEquals('A question mark must not be appended if there are no ' +
      'parameters, otherwise repeated appends will be broken.',
      'http://foo.com#test', utils.appendParams('http://foo.com#test'));
  assertEquals('should handle objects with to-string',
      'http://foo.com?q=a&r=b',
      utils.appendParams('http://foo.com',
          'q', new HasString('a'), 'r', [new HasString('b')]));

  assertThrows('appendParams should fail with an odd number of arguments.',
      function() {
        utils.appendParams('http://foo.com', 'a', 1, 'b');
      });
}


function testAppendParamsAsArray() {
  assertEquals('http://foo.com?q=1&r=2&s=3&s=4#preserve',
      utils.appendParams('http://foo.com#preserve',
          ['q', 1, 'r', 2, 's', [3, 4]]));
  assertEquals('http://foo.com?q=1&s=3&s=4#preserve',
      utils.appendParams('http://foo.com#preserve',
          ['q', 1, 'r', null, 's', [3, 4]]));
  assertEquals('http://foo.com?q=1&s=3&s=4#preserve',
      utils.appendParams('http://foo.com#preserve',
          ['q', 1, 'r', undefined, 's', [3, 4]]));
  assertEquals('http://foo.com?q=1&r=2&s=3&s=4&s=null&s=undefined#preserve',
      utils.appendParams('http://foo.com#preserve',
          ['q', 1, 'r', 2, 's', [3, new HasString('4'), null, undefined]]));
}


function testAppendParamEscapes() {
  assertEquals('http://foo.com?h=a%20b',
      utils.appendParams('http://foo.com', 'h', 'a b'));
  assertEquals('h=a%20b', utils.buildQueryData(['h', 'a b']));
  assertEquals('h=a%20b', utils.buildQueryDataFromMap({'h': 'a b'}));
}


function testAppendParamsFromMap() {
  var uri = utils.appendParamsFromMap('http://www.foo.com',
      {'a': 1, 'b': 'bob', 'c': [1, 2, new HasString('3')]});
  assertArrayEquals(['1'], utils.getParamValues(uri, 'a'));
  assertArrayEquals(['bob'], utils.getParamValues(uri, 'b'));
  assertArrayEquals(['1', '2', '3'], utils.getParamValues(uri, 'c'));
}

function testBuildQueryDataFromMap() {
  assertEquals('a=1', utils.buildQueryDataFromMap({'a': 1}));
  var uri = 'foo.com?' + utils.buildQueryDataFromMap(
      {'a': 1, 'b': 'bob', 'c': [1, 2, new HasString('3')]});
  assertArrayEquals(['1'], utils.getParamValues(uri, 'a'));
  assertArrayEquals(['bob'], utils.getParamValues(uri, 'b'));
  assertArrayEquals(['1', '2', '3'], utils.getParamValues(uri, 'c'));
}


function testMultiParamSkipsNullParams() {
  // For the multi-param functions, null and undefined keys should be
  // skipped, but null within a parameter array should still be appended.
  assertEquals('buildQueryDataFromMap', 'a=null',
      utils.buildQueryDataFromMap({'a': [null], 'b': null, 'c': undefined}));
  assertEquals('buildQueryData', 'a=null',
      utils.buildQueryData(['a', [null], 'b', null, 'c', undefined]));
  assertEquals('appendParams', 'foo.com?a=null',
      utils.appendParams('foo.com', 'a', [null], 'b', null, 'c', undefined));
  assertEquals('empty strings should NOT be skipped', 'foo.com?a&b',
      utils.appendParams('foo.com', 'a', [''], 'b', ''));
}


function testAppendSingleParamDoesAppendNullParams() {
  // For the single-param function, exactly 1 parameter will always be appended.
  assertEquals('appendParam does not skip null params', 'foo.com?a=null',
      utils.appendParam('foo.com', 'a', null));
}


function testRemoveParam() {
  assertEquals('remove middle', 'http://foo.com?q=1&s=3',
      utils.removeParam('http://foo.com?q=1&r=2&s=3', 'r'));
  assertEquals('remove first', 'http://foo.com?r=2&s=3',
      utils.removeParam('http://foo.com?q=1&r=2&s=3', 'q'));
  assertEquals('remove last', 'http://foo.com?q=1&r=2',
      utils.removeParam('http://foo.com?q=1&r=2&s=3', 's'));
  assertEquals('remove only param', 'http://foo.com',
      utils.removeParam('http://foo.com?q=1', 'q'));
}


function testRemoveParamWithFragment() {
  assertEquals('remove middle', 'http://foo.com?q=1&s=3#?r=1&r=1',
      utils.removeParam('http://foo.com?q=1&r=2&s=3#?r=1&r=1', 'r'));
  assertEquals('remove first', 'http://foo.com?r=2&s=3#?q=1&q=1',
      utils.removeParam('http://foo.com?q=1&r=2&s=3#?q=1&q=1', 'q'));
  assertEquals('remove only param', 'http://foo.com#?q=1&q=1',
      utils.removeParam('http://foo.com?q=1#?q=1&q=1', 'q'));
  assertEquals('remove last', 'http://foo.com?q=1&r=2#?s=1&s=1',
      utils.removeParam('http://foo.com?q=1&r=2&s=3#?s=1&s=1', 's'));
}


function testRemoveNonExistent() {
  assertEquals('remove key not present', 'http://foo.com?q=1',
      utils.removeParam('http://foo.com?q=1', 'nosuchkey'));
  assertEquals('remove key not present', 'http://foo.com#q=1',
      utils.removeParam('http://foo.com#q=1', 'q'));
  assertEquals('remove key from empty string', '',
      utils.removeParam('', 'nosuchkey'));
}


function testRemoveMultiple() {
  assertEquals('remove four of the same', 'http://foo.com',
      utils.removeParam('http://foo.com?q=1&q=2&q=3&q=4', 'q'));
  assertEquals('remove four of the same with another one in the middle',
      'http://foo.com?a=99',
      utils.removeParam('http://foo.com?q=1&q=2&a=99&q=3&q=4', 'q'));
}


function testSetParam() {
  assertEquals('middle, no fragment', 'http://foo.com?q=1&s=3&r=999',
      utils.setParam('http://foo.com?q=1&r=2&s=3', 'r', 999));
  assertEquals('middle', 'http://foo.com?q=1&s=3&r=999#?r=1&r=1',
      utils.setParam('http://foo.com?q=1&r=2&s=3#?r=1&r=1', 'r', 999));
  assertEquals('first', 'http://foo.com?r=2&s=3&q=999#?q=1&q=1',
      utils.setParam('http://foo.com?q=1&r=2&s=3#?q=1&q=1', 'q', 999));
  assertEquals('only param', 'http://foo.com?q=999#?q=1&q=1',
      utils.setParam('http://foo.com?q=1#?q=1&q=1', 'q', 999));
  assertEquals('last', 'http://foo.com?q=1&r=2&s=999#?s=1&s=1',
      utils.setParam('http://foo.com?q=1&r=2&s=3#?s=1&s=1', 's', 999));
  assertEquals('multiple', 'http://foo.com?s=999#?s=1&s=1',
      utils.setParam('http://foo.com?s=1&s=2&s=3#?s=1&s=1', 's', 999));
  assertEquals('none', 'http://foo.com?r=1&s=999#?s=1&s=1',
      utils.setParam('http://foo.com?r=1#?s=1&s=1', 's', 999));
}


function testModifyQueryParams() {
  var uri = 'http://foo.com?a=A&a=A2&b=B&b=B2&c=C';

  uri = utils.appendParam(uri, 'd', 'D');
  assertEquals('http://foo.com?a=A&a=A2&b=B&b=B2&c=C&d=D', uri);

  uri = utils.removeParam(uri, 'd');
  uri = utils.appendParam(uri, 'd', 'D2');
  assertEquals('http://foo.com?a=A&a=A2&b=B&b=B2&c=C&d=D2', uri);

  uri = utils.removeParam(uri, 'a');
  uri = utils.appendParam(uri, 'a', 'A3');
  assertEquals('http://foo.com?b=B&b=B2&c=C&d=D2&a=A3', uri);

  uri = utils.removeParam(uri, 'a');
  uri = utils.appendParam(uri, 'a', 'A4');
  assertEquals('A4', utils.getParamValue(uri, 'a'));
}


function testBrowserEncoding() {
  // Sanity check borrowed from old code to ensure that encodeURIComponent
  // is good enough.  Entire test should be safe to delete.
  var allowedInFragment = /[A-Za-z0-9\-\._~!$&'()*+,;=:@/?]/g;

  var sb = [];
  for (var i = 33; i < 500; i++) {  // arbitrarily use first 500 chars.
    sb.push(String.fromCharCode(i));
  }
  var testString = sb.join('');

  var encodedStr = encodeURIComponent(testString);

  // Strip all percent encoded characters, as they're ok.
  encodedStr = encodedStr.replace(/%[0-9A-F][0-9A-F]/g, '');

  // Remove allowed characters.
  encodedStr = encodedStr.replace(allowedInFragment, '');

  // Only illegal characters should remain, which is a fail.
  assertEquals('String should be empty', 0, encodedStr.length);
}


function testAppendPath() {
 var uri = 'http://www.foo.com';
 var expected = uri + '/dummy';
 assertEquals('Path has no trailing "/", adding with leading "/" failed',
              expected,
              goog.uri.utils.appendPath(uri, '/dummy'));
 assertEquals('Path has no trailing "/", adding with no leading "/" failed',
              expected,
              goog.uri.utils.appendPath(uri, 'dummy'));
 uri = uri + '/';
 assertEquals('Path has trailing "/", adding with leading "/" failed',
              expected,
              goog.uri.utils.appendPath(uri, '/dummy'));

 assertEquals('Path has trailing "/", adding with no leading "/" failed',
              expected,
              goog.uri.utils.appendPath(uri, 'dummy'));
}


function testMakeUnique() {
  assertEquals('http://www.google.com?zx=RANDOM#blob',
      goog.uri.utils.makeUnique('http://www.google.com#blob'));
  assertEquals('http://www.google.com?a=1&b=2&zx=RANDOM#blob',
      goog.uri.utils.makeUnique('http://www.google.com?zx=9&a=1&b=2#blob'));
}

">n/a</td></tr>
<tr><td>uri_test.html</td><td>Success</td><td> 55 passed, 0 failed.</td><td title="

  goog.require('goog.Uri');
  goog.require('goog.testing.jsunit');



function testUriParse() {
  var uri = new goog.Uri('http://www.google.com:80/path?q=query#fragmento');
  assertEquals('http', uri.getScheme());
  assertEquals('', uri.getUserInfo());
  assertEquals('www.google.com', uri.getDomain());
  assertEquals(80, uri.getPort());
  assertEquals('/path', uri.getPath());
  assertEquals('q=query', uri.getQuery());
  assertEquals('fragmento', uri.getFragment());

  assertEquals('terer258+foo@gmail.com',
               goog.Uri.parse('mailto:terer258+foo@gmail.com').getPath());
}

function testUriParseAcceptsThingsWithToString() {
  // Ensure that the goog.Uri constructor coerces random types to strings.
  var uriStr = 'http://www.google.com:80/path?q=query#fragmento';
  var uri = new goog.Uri({toString: function() { return uriStr; }});
  assertEquals('http://www.google.com:80/path?q=query#fragmento',
      uri.toString());
}

function testUriCreate() {
  assertEquals(
      'http://www.google.com:81/search%20path?q=what%20to%20eat%2Bdrink%3F',
      goog.Uri.create('http', null, 'www.google.com', 81, '/search path',
          (new goog.Uri.QueryData).set('q', 'what to eat+drink?'), null)
      .toString());

  assertEquals(
      'http://www.google.com:80/search%20path?q=what%20to%20eat%2Bdrink%3F',
      goog.Uri.create('http', null, 'www.google.com', 80, '/search path',
          (new goog.Uri.QueryData).set('q', 'what to eat+drink?'), null)
      .toString());

  assertEquals(
      'http://www.google.com/search%20path?q=what%20to%20eat%2Bdrink%3F',
      goog.Uri.create('http', null, 'www.google.com', null, '/search path',
          (new goog.Uri.QueryData).set('q', 'what to eat+drink?'), null)
      .toString());

  assertEquals(
      'http://www.google.com/search%20path?q=what%20to%20eat%2Bdrink%3F',
      goog.Uri.create('http', null, 'www.google.com', null, '/search path',
          new goog.Uri.QueryData(null, null, true).set('Q', 'what to eat+drink?'), null)
      .toString());
}

function testClone() {
  var uri1 = new goog.Uri('http://www.google.com:8080/foo');
  var uri2 = uri1.clone();

  uri2.setParameterValues('q','bar');
  assertFalse(uri1.getParameterValue('q') == 'bar');
}

function testRelativeUris() {
  assertFalse(new goog.Uri('?hello').hasPath());
}

function testAbsolutePathResolution() {
  var uri1 = new goog.Uri('http://www.google.com:8080/path?q=query#fragmento');

  assertEquals('http://www.google.com:8080/foo',
               uri1.resolve(new goog.Uri('/foo')).toString());

  assertEquals('http://www.google.com:8080/foo/bar',
               goog.Uri.resolve('http://www.google.com:8080/search/',
                                '/foo/bar').toString());
}

function testRelativePathResolution() {
  var uri1 = new goog.Uri('http://www.google.com:8080/path?q=query#fragmento');
  assertEquals('http://www.google.com:8080/foo',
               uri1.resolve(goog.Uri.parse('foo')).toString());

  var uri2 = new goog.Uri('http://www.google.com:8080/search');
  assertEquals('http://www.google.com:8080/foo/bar',
               uri2.resolve(new goog.Uri('foo/bar')).toString());

  var uri3 = new goog.Uri('http://www.google.com:8080/search/');
  assertEquals('http://www.google.com:8080/search/foo/bar',
               uri3.resolve(new goog.Uri('foo/bar')).toString());

  var uri4 = new goog.Uri('foo');
  assertEquals('bar',
               uri4.resolve(new goog.Uri('bar')).toString());
}

function testDomainResolution() {
  assertEquals('https://www.google.com/foo/bar',
               new goog.Uri('https://www.fark.com:443/search/').resolve(
                   new goog.Uri('//www.google.com/foo/bar')
               ).toString());

  assertEquals('http://www.google.com/',
               goog.Uri.resolve('http://www.fark.com/search/',
                                '//www.google.com/').toString());
}

function testQueryResolution() {
  assertEquals('http://www.google.com/search?q=new%20search',
               goog.Uri.parse('http://www.google.com/search?q=old+search').
                   resolve(goog.Uri.parse('?q=new%20search')).toString());

  assertEquals('http://www.google.com/search?q=new%20search',
               goog.Uri.parse('http://www.google.com/search?q=old+search#hi').
                   resolve(goog.Uri.parse('?q=new%20search')).toString());
}

function testFragmentResolution() {
  assertEquals('http://www.google.com/foo/bar?q=hi#there',
               goog.Uri.resolve('http://www.google.com/foo/bar?q=hi',
                                '#there').toString());

  assertEquals('http://www.google.com/foo/bar?q=hi#there',
               goog.Uri.resolve('http://www.google.com/foo/bar?q=hi#you',
                                '#there').toString());
}

function testBogusResolution() {
  assertEquals('a://completely.different/url',
               goog.Uri.parse('some:base/url').resolve(
                   goog.Uri.parse('a://completely.different/url')
                   ).toString());
}

function testDotSegmentsRemovalRemoveLeadingDots() {
  // Test removing leading "../" and "./"
  assertDotRemovedEquals('bar', '../bar');
  assertDotRemovedEquals('bar', './bar');
  assertDotRemovedEquals('bar', '.././bar');
  assertDotRemovedEquals('bar', '.././bar');
}

function testDotSegmentRemovalRemoveSingleDot() {
  // Tests replacing "/./" with "/"
  assertDotRemovedEquals('/foo/bar', '/foo/./bar');
  assertDotRemovedEquals('/bar/', '/bar/./');

  // Test replacing trailing "/." with "/"
  assertDotRemovedEquals('/', '/.');
  assertDotRemovedEquals('/bar/', '/bar/.');
}

function testDotSegmentRemovalRemoveDoubleDot() {
  // Test resolving "/../"
  assertDotRemovedEquals('/bar', '/foo/../bar');
  assertDotRemovedEquals('/', '/bar/../');

  // Test resolving trailing "/.."
  assertDotRemovedEquals('/', '/..');
  assertDotRemovedEquals('/', '/', '/bar/..');
  assertDotRemovedEquals('/foo/', '/foo/bar/..');
}

function testDotSegmentRemovalRemovePlainDots() {
  // RFC 3986, section 5.2.4, point 2.D.
  // Test resolving plain ".." or "."
  assertDotRemovedEquals('', '.');
  assertDotRemovedEquals('', '..');
}

function testPathConcatenation() {
  // Check accordenance with RFC 3986, section 5.2.4
  assertResolvedEquals('bar', '', 'bar');
  assertResolvedEquals('/bar', '/', 'bar');
  assertResolvedEquals('/bar', '/foo', '/bar');
  assertResolvedEquals('/foo/foo', '/foo/bar', 'foo');
}

function testPathConcatenationDontRemoveForEmptyUri() {
  // Resolving URIs with empty path should not result in dot segments removal.
  // See: algorithm in section 5.2.2: code inside 'if (R.path == "")' clause.
  assertResolvedEquals('/search/../foo', '/search/../foo', '');
  assertResolvedEquals('/search/./foo', '/search/./foo', '');
}

function testParameterGetters() {
  function assertArraysEqual(l1, l2) {
    if (!l1 || !l2) {
      assertEquals(l1, l2);
      return;
    }
    var l1s = l1.toString(), l2s = l2.toString();
    assertEquals(l1s, l2s);
    assertEquals(l1s, l1.length, l2.length);
    for (var i = 0; i < l1.length; ++i) {
      assertEquals("part " + i + " of " + l1.length + " in " + l1s,
                   l1[i], l2[i]);
    }
  }

  assertArraysEqual(['v1', 'v2'],
      goog.Uri.parse('/path?a=b&key=v1&c=d&key=v2&keywithsuffix=v3').
        getParameterValues('key'));

  assertArraysEqual(['v1', 'v2'],
      goog.Uri.parse('/path?a=b&keY=v1&c=d&KEy=v2&keywithsuffix=v3', true).
        getParameterValues('kEy'));

  assertEquals('v1',
      goog.Uri.parse('/path?key=v1&c=d&keywithsuffix=v3&key=v2').
        getParameterValue('key'));

  assertEquals('v1',
      goog.Uri.parse('/path?kEY=v1&c=d&keywithsuffix=v3&key=v2', true).
        getParameterValue('Key'));

  assertEquals('v1=v2',
      goog.Uri.parse('/path?key=v1=v2', true).
        getParameterValue('key'));

  assertEquals('v1=v2=v3',
      goog.Uri.parse('/path?key=v1=v2=v3', true).
        getParameterValue('key'));

  assertArraysEqual(undefined,
                    goog.Uri.parse('/path?key=v1&c=d&keywithsuffix=v3&key=v2').
                    getParameterValue('nosuchkey'));
  // test boundary conditions
  assertArraysEqual(['v1', 'v2'],
      goog.Uri.parse('/path?key=v1&c=d&key=v2&keywithsuffix=v3').
        getParameterValues('key'));
  assertArraysEqual(['v1', 'v2'],
      goog.Uri.parse('/path?key=v1&c=d&keywithsuffix=v3&key=v2').
        getParameterValues('key'));

  // test no =
  assertArraysEqual([''],
                    goog.Uri.parse('/path?key').getParameterValues('key'));
  assertArraysEqual([''],
                    goog.Uri.parse('/path?key', true).getParameterValues('key'));

  assertArraysEqual([''],
                    goog.Uri.parse('/path?foo=bar&key').
                    getParameterValues('key'));
  assertArraysEqual([''],
                    goog.Uri.parse('/path?foo=bar&key', true).
                    getParameterValues('key'));

  assertEquals('',
               goog.Uri.parse('/path?key').getParameterValue('key'));
  assertEquals('',
               goog.Uri.parse('/path?key', true).getParameterValue('key'));

  assertEquals('',
               goog.Uri.parse('/path?foo=bar&key').getParameterValue('key'));
  assertEquals('',
               goog.Uri.parse('/path?foo=bar&key', true).
               getParameterValue('key'));

  var u = new goog.Uri('/path?a=b&key=v1&c=d&key=v2&keywithsuffix=v3');
  assertArraysEqual(u.getParameterValues('a'), ['b']);
  assertArraysEqual(u.getParameterValues('key'), ['v1', 'v2']);
  assertArraysEqual(u.getParameterValues('c'), ['d']);
  assertArraysEqual(u.getParameterValues('keywithsuffix'), ['v3']);
  assertArraysEqual(u.getParameterValues('KeyWITHSuffix'), []);

  // Make sure constructing from another URI preserves case-sensitivity
  var u2 = new goog.Uri(u);
  assertArraysEqual(u2.getParameterValues('a'), ['b']);
  assertArraysEqual(u2.getParameterValues('key'), ['v1', 'v2']);
  assertArraysEqual(u2.getParameterValues('c'), ['d']);
  assertArraysEqual(u2.getParameterValues('keywithsuffix'), ['v3']);
  assertArraysEqual(u2.getParameterValues('KeyWITHSuffix'), []);

  u = new goog.Uri('/path?a=b&key=v1&c=d&kEy=v2&keywithsuffix=v3', true);
  assertArraysEqual(u.getParameterValues('A'), ['b']);
  assertArraysEqual(u.getParameterValues('keY'), ['v1', 'v2']);
  assertArraysEqual(u.getParameterValues('c'), ['d']);
  assertArraysEqual(u.getParameterValues('keyWITHsuffix'), ['v3']);

  // Make sure constructing from another URI preserves case-insensitivity
  u2 = new goog.Uri(u);
  assertArraysEqual(u2.getParameterValues('A'), ['b']);
  assertArraysEqual(u2.getParameterValues('keY'), ['v1', 'v2']);
  assertArraysEqual(u2.getParameterValues('c'), ['d']);
  assertArraysEqual(u2.getParameterValues('keyWITHsuffix'), ['v3']);
}

function testRemoveParameter() {
  assertEquals('/path?a=b&c=d&keywithsuffix=v3',
               goog.Uri.parse('/path?a=b&key=v1&c=d&key=v2&keywithsuffix=v3')
               .removeParameter('key').toString());
}

function testParameterSetters() {
  assertEquals('/path?a=b&key=newval&c=d&keywithsuffix=v3',
               goog.Uri.parse('/path?a=b&key=v1&c=d&key=v2&keywithsuffix=v3')
               .setParameterValue('key', 'newval').toString());

  assertEquals('/path?a=b&key=1&key=2&key=3&c=d&keywithsuffix=v3',
               goog.Uri.parse('/path?a=b&key=v1&c=d&key=v2&keywithsuffix=v3')
               .setParameterValues('key', ['1', '2', '3']).toString());

  // Test case-insensitive setters
  assertEquals('/path?a=b&key=newval&c=d&keywithsuffix=v3',
               goog.Uri.parse('/path?a=b&key=v1&c=d&key=v2&keywithsuffix=v3', true)
               .setParameterValue('KEY', 'newval').toString());

  assertEquals('/path?a=b&key=1&key=2&key=3&c=d&keywithsuffix=v3',
               goog.Uri.parse('/path?a=b&key=v1&c=d&key=v2&keywithsuffix=v3', true)
               .setParameterValues('kEY', ['1', '2', '3']).toString());
}

function testEncoding() {
  assertEquals('/foo bar baz',
               goog.Uri.parse('/foo%20bar%20baz').getPath());
  assertEquals('/foo+bar+baz',
               goog.Uri.parse('/foo+bar+baz').getPath());
}

function testSetters() {
  var uri = new goog.Uri('http://www.google.com:80/path?q=query#fragmento');
  assertEquals('https://www.google.com:80/path?q=query#fragmento',
               uri.setScheme('https').toString());
  assertEquals('https://%E1%B8%A1oogle.com:80/path?q=query#fragmento',
               uri.setDomain('\u1e21oogle.com').toString());
  assertEquals('https://%E1%B8%A1oogle.com:443/path?q=query#fragmento',
               uri.setPort(443).toString());
  assertEquals(
      'https://%E1%B8%A1oogle.com:443/search%20path/?q=query#fragmento',
      uri.setPath('/search path/').toString());
  assertEquals(
      'https://%E1%B8%A1oogle.com:443/search%20path/?q=query#fragmento',
      uri.setPath('search path/').toString());
  assertEquals(
      'https://%E1%B8%A1oogle.com:443/search%20path/?q=some%20stuff&lang=en' +
      '#fragmento', uri.setParameterValues('q', 'some stuff')
                       .setParameterValues('lang', 'en').toString());
  assertEquals(
      'https://%E1%B8%A1oogle.com:443/search%20path/?q=some%20stuff&lang=en',
      uri.setFragment(null).toString());
  assertEquals(
      'https://%E1%B8%A1oogle.com/search%20path/?q=some%20stuff&lang=en',
      uri.setPort(null).toString());
  assertEquals(
      'https://user:pwd@%E1%B8%A1oogle.com/search%20path/' +
      '?q=some%20stuff&lang=en',
      uri.setUserInfo('user:pwd').toString());
}

function testTreatmentOfAt1() {
  var uri = new goog.Uri('http://www.google.com?q=johndoe@gmail.com');
  assertEquals('http', uri.getScheme());
  assertEquals('www.google.com', uri.getDomain());
  assertEquals('johndoe@gmail.com', uri.getParameterValue('q'));

  assertEquals('http://www.google.com?q=johndoe%40gmail.com',
               goog.Uri.create('http', null, 'www.google.com', null, null,
                          'q=johndoe@gmail.com', null).toString());
}

function testTreatmentOfAt2() {
  var uri = new goog.Uri('http://www/~johndoe@gmail.com/foo');
  assertEquals('http', uri.getScheme());
  assertEquals('www', uri.getDomain());
  assertEquals('/~johndoe@gmail.com/foo', uri.getPath());

  assertEquals('http://www/~johndoe@gmail.com/foo',
               goog.Uri.create('http', null, 'www', null,
                               '/~johndoe@gmail.com/foo', null, null).
                               toString());
}

function testTreatmentOfAt3() {
  var uri = new goog.Uri('ftp://skroob:1234@teleport/~skroob@vacuum');
  assertEquals('ftp', uri.getScheme());
  assertEquals('skroob:1234', uri.getUserInfo());
  assertEquals('teleport', uri.getDomain());
  assertEquals('/~skroob@vacuum', uri.getPath());

  assertEquals('ftp://skroob:1234@teleport/~skroob@vacuum',
               goog.Uri.create('ftp', 'skroob:1234', 'teleport', null,
                          '/~skroob@vacuum', null, null).toString());
}

function testTreatmentOfAt4() {
  assertEquals('ftp://darkhelmet:45%4078@teleport/~dhelmet@vacuum',
               goog.Uri.create('ftp', 'darkhelmet:45@78', 'teleport', null,
                          '/~dhelmet@vacuum', null, null).toString());
}

function testSameDomain1() {
  var uri1 = 'http://www.google.com/a';
  var uri2 = 'http://www.google.com/b';
  assertTrue(goog.Uri.haveSameDomain(uri1, uri2));
  assertTrue(goog.Uri.haveSameDomain(uri2, uri1));
}

function testSameDomain2() {
  var uri1 = 'http://www.google.com:1234/a';
  var uri2 = 'http://www.google.com/b';
  assertFalse(goog.Uri.haveSameDomain(uri1, uri2));
  assertFalse(goog.Uri.haveSameDomain(uri2, uri1));
}

function testSameDomain3() {
  var uri1 = 'www.google.com/a';
  var uri2 = 'http://www.google.com/b';
  assertFalse(goog.Uri.haveSameDomain(uri1, uri2));
  assertFalse(goog.Uri.haveSameDomain(uri2, uri1));
}

function testSameDomain4() {
  var uri1 = '/a';
  var uri2 = 'http://www.google.com/b';
  assertFalse(goog.Uri.haveSameDomain(uri1, uri2));
  assertFalse(goog.Uri.haveSameDomain(uri2, uri1));
}

function testSameDomain5() {
  var uri1 = 'http://www.google.com/a';
  var uri2 = 'http://mail.google.com/b';
  assertFalse(goog.Uri.haveSameDomain(uri1, uri2));
  assertFalse(goog.Uri.haveSameDomain(uri2, uri1));
}

function testSameDomain6() {
  var uri1 = '/a';
  var uri2 = '/b';
  assertTrue(goog.Uri.haveSameDomain(uri1, uri2));
  assertTrue(goog.Uri.haveSameDomain(uri2, uri1));
}

function testMakeUnique() {
  var uri1 = new goog.Uri('http://www.google.com/setgmail');
  uri1.makeUnique();
  var uri2 = new goog.Uri('http://www.google.com/setgmail');
  uri2.makeUnique();
  assertTrue(uri1.getQueryData().containsKey(goog.Uri.RANDOM_PARAM));
  assertTrue(uri1.toString() != uri2.toString());
}

function testSetReadOnly() {
  var uri = new goog.Uri('http://www.google.com/setgmail');
  uri.setReadOnly(true);
  assertThrows(function() {
    uri.setParameterValue('cant', 'dothis')
  });
}

function testSetReadOnlyChained() {
  var uri = new goog.Uri('http://www.google.com/setgmail').setReadOnly(true);
  assertThrows(function() {
    uri.setParameterValue('cant', 'dothis');
  });
}

function testQueryDataCount() {
  var qd = new goog.Uri.QueryData('a=A&b=B&a=A2&b=B2&c=C');
  assertEquals(5, qd.getCount());
}

function testQueryDataRemove() {
  var qd = new goog.Uri.QueryData('a=A&b=B&a=A2&b=B2&c=C');
  qd.remove('c');
  assertEquals(4, qd.getCount());
  assertEquals('a=A&a=A2&b=B&b=B2', String(qd));
  qd.remove('a');
  assertEquals(2, qd.getCount());
  assertEquals('b=B&b=B2', String(qd));
}

function testQueryDataClear() {
  var qd = new goog.Uri.QueryData('a=A&b=B&a=A2&b=B2&c=C');
  qd.clear();
  assertEquals(0, qd.getCount());
  assertEquals('', String(qd));
}

function testQueryDataIsEmpty() {
  var qd = new goog.Uri.QueryData('a=A&b=B&a=A2&b=B2&c=C');
  qd.remove('a');
  assertFalse(qd.isEmpty());
  qd.remove('b');
  assertFalse(qd.isEmpty());
  qd.remove('c');
  assertTrue(qd.isEmpty());

  qd = new goog.Uri.QueryData('a=A&b=B&a=A2&b=B2&c=C');
  qd.clear();
  assertTrue(qd.isEmpty());
}

function testQueryDataContainsKey() {
  var qd = new goog.Uri.QueryData('a=A&b=B&a=A2&b=B2&c=C');
  assertTrue(qd.containsKey('a'));
  assertTrue(qd.containsKey('b'));
  assertTrue(qd.containsKey('c'));
  qd.remove('a');
  assertFalse(qd.containsKey('a'));
  assertTrue(qd.containsKey('b'));
  assertTrue(qd.containsKey('c'));
  qd.remove('b');
  assertFalse(qd.containsKey('a'));
  assertFalse(qd.containsKey('b'));
  assertTrue(qd.containsKey('c'));
  qd.remove('c');
  assertFalse(qd.containsKey('a'));
  assertFalse(qd.containsKey('b'));
  assertFalse(qd.containsKey('c'));

  qd = new goog.Uri.QueryData('a=A&b=B&a=A2&b=B2&c=C');
  qd.clear();
  assertFalse(qd.containsKey('a'));
  assertFalse(qd.containsKey('b'));
  assertFalse(qd.containsKey('c'));

  // Test case-insensitive
  qd = new goog.Uri.QueryData('aaa=A&bbb=B&aaa=A2&bbbb=B2&ccc=C', null, true);
  assertTrue(qd.containsKey('aaa'));
  assertTrue(qd.containsKey('bBb'));
  assertTrue(qd.containsKey('CCC'));

  qd = new goog.Uri.QueryData('a=b=c');
  assertTrue(qd.containsKey('a'));
  assertFalse(qd.containsKey('b'));
}

function testQueryDataContainsValue() {
  var qd = new goog.Uri.QueryData('a=A&b=B&a=A2&b=B2&c=C');

  assertTrue(qd.containsValue('A'));
  assertTrue(qd.containsValue('B'));
  assertTrue(qd.containsValue('A2'));
  assertTrue(qd.containsValue('B2'));
  assertTrue(qd.containsValue('C'));
  qd.remove('a');
  assertFalse(qd.containsValue('A'));
  assertTrue(qd.containsValue('B'));
  assertFalse(qd.containsValue('A2'));
  assertTrue(qd.containsValue('B2'));
  assertTrue(qd.containsValue('C'));
  qd.remove('b');
  assertFalse(qd.containsValue('A'));
  assertFalse(qd.containsValue('B'));
  assertFalse(qd.containsValue('A2'));
  assertFalse(qd.containsValue('B2'));
  assertTrue(qd.containsValue('C'));
  qd.remove('c');
  assertFalse(qd.containsValue('A'));
  assertFalse(qd.containsValue('B'));
  assertFalse(qd.containsValue('A2'));
  assertFalse(qd.containsValue('B2'));
  assertFalse(qd.containsValue('C'));

  qd = new goog.Uri.QueryData('a=A&b=B&a=A2&b=B2&c=C');
  qd.clear();
    assertFalse(qd.containsValue('A'));
  assertFalse(qd.containsValue('B'));
  assertFalse(qd.containsValue('A2'));
  assertFalse(qd.containsValue('B2'));
  assertFalse(qd.containsValue('C'));

  qd = new goog.Uri.QueryData('a=b=c');
  assertTrue(qd.containsValue('b=c'));
  assertFalse(qd.containsValue('b'));
  assertFalse(qd.containsValue('c'));
}

function testQueryDataGetKeys() {
  var qd = new goog.Uri.QueryData('a=A&b=B&a=A2&b=B2&c=C=extra');

  assertEquals('aabbc', qd.getKeys().join(''));
  qd.remove('a');
  assertEquals('bbc', qd.getKeys().join(''));
  qd.add('d', 'D');
  qd.add('d', 'D');
  assertEquals('bbcdd', qd.getKeys().join(''));

  // Test case-insensitive
  qd = new goog.Uri.QueryData('A=A&B=B&a=A2&b=B2&C=C=extra', null, true);

  assertEquals('aabbc', qd.getKeys().join(''));
  qd.remove('a');
  assertEquals('bbc', qd.getKeys().join(''));
  qd.add('d', 'D');
  qd.add('D', 'D');
  assertEquals('bbcdd', qd.getKeys().join(''));
}

function testQueryDataGetValues() {
  var qd = new goog.Uri.QueryData('a=A&b=B&a=A2&b=B2&c=C=extra');

  assertEquals('AA2BB2C=extra', qd.getValues().join(''));
  qd.remove('a');
  assertEquals('BB2C=extra', qd.getValues().join(''));
  qd.add('d', 'D');
  qd.add('d', 'D');
  assertEquals('BB2C=extraDD', qd.getValues().join(''));
}

function testQueryDataSet() {
  var qd = new goog.Uri.QueryData('a=A&b=B&a=A2&b=B2&c=C');

  qd.set('d', 'D');
  assertEquals('a=A&a=A2&b=B&b=B2&c=C&d=D', String(qd));
  qd.set('d', 'D2');
  assertEquals('a=A&a=A2&b=B&b=B2&c=C&d=D2', String(qd));
  qd.set('a', 'A3');
  assertEquals('a=A3&b=B&b=B2&c=C&d=D2', String(qd));
  qd.remove('a');
  qd.set('a', 'A4');
  // this is different in IE and Mozilla so we cannot use the toString to test
  assertEquals('A4', qd.get('a'));
}

function testQueryDataGet() {
  var qd = new goog.Uri.QueryData('a=A&b=B&a=A2&b=B2&c=C=extra');

  assertEquals('A', qd.get('a'));
  assertEquals('B', qd.get('b'));
  assertEquals('C=extra', qd.get('c'));
  assertEquals('Default', qd.get('d', 'Default'));

  qd = new goog.Uri.QueryData('a=A&b=B&a=A2&b=B2&c=C=extra', null, true);

  assertEquals('A', qd.get('A'));
  assertEquals('B', qd.get('b'));
  assertEquals('C=extra', qd.get('C'));
  assertEquals('Default', qd.get('D', 'Default'));
}


function testQueryDataSetValues() {
  var qd = new goog.Uri.QueryData('a=A&b=B&a=A2&b=B2&c=C');

  qd.setValues('a', ['A3', 'A4', 'A5']);
  assertEquals('a=A3&a=A4&a=A5&b=B&b=B2&c=C', String(qd));
  qd.setValues('d', ['D']);
  assertEquals('a=A3&a=A4&a=A5&b=B&b=B2&c=C&d=D', String(qd));
  qd.setValues('e', []);
  assertEquals('a=A3&a=A4&a=A5&b=B&b=B2&c=C&d=D', String(qd));
}

function testQueryDataToLowerCase() {
  var qd = new goog.Uri.QueryData('aaA=one&BBb=two&cCc=three');
  assertEquals('one', qd.get('aaA'));
  assertEquals(undefined, qd.get('aaa'));
  qd.setIgnoreCase(true);
  assertEquals('one', qd.get('aaA'));
  assertEquals('one', qd.get('aaa'));
  qd.setIgnoreCase(false);
  assertEquals(undefined, qd.get('aaA'));
  assertEquals('one', qd.get('aaa'));
  qd.add('DdD', 'four');
  assertEquals('four', qd.get('DdD'));
  assertEquals(undefined, qd.get('ddd'));
}

function testQueryDataExtend() {
  var qd1 = new goog.Uri.QueryData('a=A&b=B&c=C');
  var qd2 = new goog.Uri.QueryData('d=D&e=E');
  qd1.extend(qd2);
  assertEquals('a=A&b=B&c=C&d=D&e=E', String(qd1));

  qd1 = new goog.Uri.QueryData('a=A&b=B&c=C');
  qd2 = new goog.Uri.QueryData('d=D&e=E');
  var qd3 = new goog.Uri.QueryData('f=F&g=G');
  qd1.extend(qd2, qd3);
  assertEquals('a=A&b=B&c=C&d=D&e=E&f=F&g=G', String(qd1));

  qd1 = new goog.Uri.QueryData('a=A&b=B&c=C');
  qd2 = new goog.Uri.QueryData('a=A&c=C');
  qd1.extend(qd2);
  assertEquals('a=A&a=A&b=B&c=C&c=C', String(qd1));
}

function testQueryDataCreateFromMap() {
  assertEquals('', String(goog.Uri.QueryData.createFromMap({})));
  assertEquals('a=A&b=B&c=C',
      String(goog.Uri.QueryData.createFromMap({a:'A',b:'B',c:'C'})));
  assertEquals('a=foo%26bar',
      String(goog.Uri.QueryData.createFromMap({a:'foo&bar'})));
}

function testQueryDataCreateFromKeysValues() {
  assertEquals('', String(goog.Uri.QueryData.createFromKeysValues([], [])));
  assertEquals('a=A&b=B&c=C', String(goog.Uri.QueryData.createFromKeysValues(
      ['a','b','c'],['A','B','C'])));
  assertEquals('a=A&a=B&a=C', String(goog.Uri.QueryData.createFromKeysValues(
      ['a','a','a'],['A','B','C'])));
}

function testFragmentEncoding() {
  var allowedInFragment = /[A-Za-z0-9\-\._~!$&'()*+,;=:@/?]/g;

  var sb = [];
  for (var i = 33; i < 500; i++) {  // arbitrarily use first 500 chars.
    sb.push(String.fromCharCode(i));
  }
  var testString = sb.join('');

  var fragment = new goog.Uri().setFragment(testString).toString();

  // Remove first '#' character.
  fragment = fragment.substr(1);

  // Strip all percent encoded characters, as they're ok.
  fragment = fragment.replace(/%[0-9A-F][0-9A-F]/g, '');

  // Remove allowed characters.
  fragment = fragment.replace(allowedInFragment, '');

  // Only illegal characters should remain, which is a fail.
  assertEquals('String should be empty', 0, fragment.length);

}

// Tests, that creating URI from components and then
// getting the components back yields equal results.
// The special attention is payed to test proper encoding
// and decoding of URI components.
function testComponentsAfterUriCreate() {
  var createdUri = new goog.Uri.create('%40',  // scheme
                                       '%41',  // user info
                                       '%42',  // domain
                                       43,     // port
                                       '%44',  // path
                                       '%45',  // query
                                       '%46'); // fragment

  assertEquals('%40', createdUri.getScheme());
  assertEquals('%41', createdUri.getUserInfo());
  assertEquals('%42', createdUri.getDomain());
  assertEquals(43, createdUri.getPort());
  assertEquals('%44', createdUri.getPath());
  assertEquals('%2545', createdUri.getQuery()); // returns encoded value
  assertEquals('%45', createdUri.getDecodedQuery());
  assertEquals('%2545', createdUri.getEncodedQuery());
  assertEquals('%46', createdUri.getFragment());
}

// Tests setting the query string and then reading back
// query parameter values.
function testSetQueryAndGetParameterValue() {
  var uri = new goog.Uri();

  // Sets query as decoded string.
  uri.setQuery('i=j&k');
  assertEquals('?i=j&k', uri.toString());
  assertEquals('i=j&k', uri.getDecodedQuery());
  assertEquals('i=j&k', uri.getEncodedQuery());
  assertEquals('i=j&k', uri.getQuery()); // returns encoded value
  assertEquals('j', uri.getParameterValue('i'));
  assertEquals('', uri.getParameterValue('k'));

  // Sets query as encoded string.
  uri.setQuery('i=j&k', true);
  assertEquals('?i=j&k', uri.toString());
  assertEquals('i=j&k', uri.getDecodedQuery());
  assertEquals('i=j&k', uri.getEncodedQuery());
  assertEquals('i=j&k', uri.getQuery()); // returns encoded value
  assertEquals('j', uri.getParameterValue('i'));
  assertEquals('', uri.getParameterValue('k'));

  // Sets query as decoded string.
  uri.setQuery('i=j%26k');
  assertEquals('?i=j%2526k', uri.toString());
  assertEquals('i=j%26k', uri.getDecodedQuery());
  assertEquals('i=j%2526k', uri.getEncodedQuery());
  assertEquals('i=j%2526k', uri.getQuery()); // returns encoded value
  assertEquals('j%26k', uri.getParameterValue('i'));
  assertUndefined(uri.getParameterValue('k'));

  // Sets query as encoded string.
  uri.setQuery('i=j%26k', true);
  assertEquals('?i=j%26k', uri.toString());
  assertEquals('i=j&k', uri.getDecodedQuery());
  assertEquals('i=j%26k', uri.getEncodedQuery());
  assertEquals('i=j%26k', uri.getQuery()); // returns encoded value
  assertEquals('j&k', uri.getParameterValue('i'));
  assertUndefined(uri.getParameterValue('k'));
}

// Tests setting query parameter values and the reading back the query string.
function testSetParameterValueAndGetQuery() {
  var uri = new goog.Uri();

  uri.setParameterValue('a', 'b&c');
  assertEquals('?a=b%26c', uri.toString());
  assertEquals('a=b&c', uri.getDecodedQuery());
  assertEquals('a=b%26c', uri.getEncodedQuery());
  assertEquals('a=b%26c', uri.getQuery()); // returns encoded value

  uri.setParameterValue('a', 'b%26c');
  assertEquals('?a=b%2526c', uri.toString());
  assertEquals('a=b%26c', uri.getDecodedQuery());
  assertEquals('a=b%2526c', uri.getEncodedQuery());
  assertEquals('a=b%2526c', uri.getQuery()); // returns encoded value
}


// Tests that building a URI with a query string and then reading it back
// gives the same result.
function testQueryNotModified() {
  assertEquals('?foo', new goog.Uri('?foo').toString());
  assertEquals('?foo=', new goog.Uri('?foo=').toString());
  assertEquals('?foo=bar', new goog.Uri('?foo=bar').toString());
  assertEquals('?&=&=&', new goog.Uri('?&=&=&').toString());
}

function assertDotRemovedEquals(expected, path) {
  assertEquals(expected, goog.Uri.removeDotSegments(path));
}

function assertResolvedEquals(expected, base, other) {
  assertEquals(expected, goog.Uri.resolve(base, other).toString());
}

">n/a</td></tr>
<tr><td>array_test.html</td><td>Success</td><td> 71 passed, 0 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.recordFunction');



var propertyReplacer;

function setUp() {
}

function tearDown() {
  if (propertyReplacer) {
    propertyReplacer.reset();
  }
}

function testArrayIndexOf() {
  assertEquals(goog.array.indexOf([0, 1, 2, 3], 1), 1);
  assertEquals(goog.array.indexOf([0, 1, 1, 1], 1), 1);
  assertEquals(goog.array.indexOf([0, 1, 2, 3], 4), -1);
  assertEquals(goog.array.indexOf([0, 1, 2, 3], 1, 1), 1);
  assertEquals(goog.array.indexOf([0, 1, 2, 3], 1, 2), -1);
  assertEquals(goog.array.indexOf([0, 1, 2, 3], 1, -3), 1);
  assertEquals(goog.array.indexOf([0, 1, 2, 3], 1, -2), -1);
}

function testArrayIndexOfOmitsDeleted() {
  var a = [0, 1, 2, 3];
  delete a[1];
  delete a[3];
  assertEquals(goog.array.indexOf(a, undefined), -1);
}

function testArrayIndexOfString() {
  assertEquals(goog.array.indexOf('abcd', 'd'), 3);
  assertEquals(goog.array.indexOf('abbb', 'b', 2), 2);
  assertEquals(goog.array.indexOf('abcd', 'e'), -1);
  assertEquals(goog.array.indexOf('abcd', 'cd'), -1);
  assertEquals(goog.array.indexOf('0123', 1), -1);
}

function testArrayLastIndexOf() {
  assertEquals(goog.array.lastIndexOf([0, 1, 2, 3], 1), 1);
  assertEquals(goog.array.lastIndexOf([0, 1, 1, 1], 1), 3);
  assertEquals(goog.array.lastIndexOf([0, 1, 1, 1], 1, 2), 2);
}

function testArrayLastIndexOfOmitsDeleted() {
  var a = [0, 1, 2, 3];
  delete a[1];
  delete a[3];
  assertEquals(goog.array.lastIndexOf(a, undefined), -1);
}

function testArrayLastIndexOfString() {
  assertEquals(goog.array.lastIndexOf('abcd', 'b'), 1);
  assertEquals(goog.array.lastIndexOf('abbb', 'b'), 3);
  assertEquals(goog.array.lastIndexOf('abbb', 'b', 2), 2);
  assertEquals(goog.array.lastIndexOf('abcd', 'cd'), -1);
  assertEquals(goog.array.lastIndexOf('0123', 1), -1);
}

function testArrayForEachBasic() {
  var s = '';
  var a = ['a', 'b', 'c', 'd'];
  goog.array.forEach(a, function(val, index, a2) {
    assertEquals(a, a2);
    assertEquals('Index is not a number', 'number', typeof index);
    s += val + index;
  });
  assertEquals('a0b1c2d3', s);
}

function testArrayForEachWithEmptyArray(){
  var a = new Array(100);
  goog.array.forEach(a, function(val, index, a2) {
    fail('The function should not be called since no values were assigned.');
  });
}

function testArrayForEachWithOnlySomeValuesAsigned(){
  var count = 0;
  var a = new Array(1000);
  a[100] = undefined;
  goog.array.forEach(a, function(val, index, a2) {
    assertEquals(100, index);
    count++;
  });
  assertEquals('Should only call function when a value of array was assigned.',
      1, count);
}

function testArrayForEachWithArrayLikeObject(){
  var counter = goog.testing.recordFunction();
  var a = {
    'length':1,
    '0':0,
    '100':100,
    '101':102
  };
  goog.array.forEach(a, counter);
  assertEquals('Number of calls should not exceed the value of its length', 1,
      counter.getCallCount());
}

function testArrayForEachOmitsDeleted() {
  var s = '';
  var a = ['a', 'b', 'c', 'd'];
  delete a[1];
  delete a[3];
  goog.array.forEach(a, function(val, index, a2) {
    assertEquals(a, a2);
    assertEquals('number', typeof index);
    s += val + index;
  });
  assertEquals('a0c2', s);
}

function testArrayForEachRight() {
  var s = '';
  var a = ['a', 'b', 'c', 'd'];
  goog.array.forEachRight(a, function(val, index, a2) {
    assertEquals(a, a2);
    assertEquals('number', typeof index);
    s += val + String(index);
  });
  assertEquals('d3c2b1a0', s);
}

function testArrayForEachRightOmitsDeleted() {
  var s = '';
  var a = ['a', 'b', 'c', 'd'];
  delete a[1];
  delete a[3];
  goog.array.forEachRight(a, function(val, index, a2) {
    assertEquals(a, a2);
    assertEquals('number', typeof index);
    assertEquals('string', typeof val);
    s += val + String(index);
  });
  assertEquals('c2a0', s);
}

function testArrayFilter() {
  var a = [0, 1, 2, 3];
  a = goog.array.filter(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 1;
  });
  assertArrayEquals([2, 3], a);
}

function testArrayFilterOmitsDeleted() {
  var a = [0, 1, 2, 3];
  delete a[1];
  delete a[3];
  a = goog.array.filter(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('number', typeof val);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 1;
  });
  assertArrayEquals([2], a);
}

function testArrayFilterPreservesValues() {
  var a = [0, 1, 2, 3];
  a = goog.array.filter(a, function (val, index, a2) {
    assertEquals(a, a2);
    // sometimes functions might be evil and do something like this, but we
    // should still use the original values when returning the filtered array
    a2[index] = a2[index] - 1;
    return a2[index] >= 1;
  });
  assertArrayEquals([2, 3], a);
}

function testArrayMap() {
  var a = [0, 1, 2, 3];
  var result = goog.array.map(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val * val;
  });
  assertArrayEquals([0, 1, 4, 9], result);
}

function testArrayMapOmitsDeleted() {
  var a = [0, 1, 2, 3];
  delete a[1];
  delete a[3];
  var result = goog.array.map(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('number', typeof val);
    assertEquals('index is not a number', 'number', typeof index);
    return val * val;
  });
  var expected = [0, 1, 4, 9];
  delete expected[1];
  delete expected[3];

  assertArrayEquals(expected, result);
  assertFalse('1' in result);
  assertFalse('3' in result);
}

function testArrayReduce() {
  var a = [0, 1, 2, 3];
  assertEquals(6, goog.array.reduce(a, function (rval, val, i, arr) {
    assertEquals('number', typeof i);
    assertEquals(a, arr);
    return rval + val;
  }, 0));

  var scope = {
    last: 0,
    testFn: function(r, v, i, arr) {
      assertEquals('number', typeof i);
      assertEquals(a, arr);
      var l = this.last;
      this.last = r + v;
      return this.last + l;
    }
  };

  assertEquals(10, goog.array.reduce(a, scope.testFn, 0, scope));
}

function testArrayReduceOmitDeleted() {
  var a = [0, 1, 2, 3];
  delete a[1];
  delete a[3];
  assertEquals(2, goog.array.reduce(a, function (rval, val, i, arr) {
    assertEquals('number', typeof i);
    assertEquals(a, arr);
    return rval + val;
  }, 0));

  var scope = {
    last: 0,
    testFn: function(r, v, i, arr) {
      assertEquals('number', typeof i);
      assertEquals(a, arr);
      var l = this.last;
      this.last = r + v;
      return this.last + l;
    }
  };

  assertEquals(2, goog.array.reduce(a, scope.testFn, 0, scope))
}

function testArrayReduceRight() {
  var a = [0, 1, 2, 3, 4];
  assertEquals('43210', goog.array.reduceRight(a, function (rval, val, i, arr) {
    assertEquals('number', typeof i);
    assertEquals(a, arr);
    return rval + val;
  }, ''));

  var scope = {
    last: '',
    testFn: function(r, v, i, arr) {
      assertEquals('number', typeof i);
      assertEquals(a, arr);
      var l = this.last;
      this.last = v;
      return r + v + l;
    }
  };

  a = ['a', 'b', 'c'];
  assertEquals('_cbcab', goog.array.reduceRight(a, scope.testFn, '_', scope));
}

function testArrayReduceRightOmitsDeleted() {
  var a = [0, 1, 2, 3, 4];
  delete a[1];
  delete a[4];
  assertEquals('320', goog.array.reduceRight(a, function (rval, val, i, arr) {
    assertEquals('number', typeof i);
    assertEquals(a, arr);
    return rval + val;
  }, ''));

  scope = {
    last: '',
    testFn: function(r, v, i, arr) {
      assertEquals('number', typeof i);
      assertEquals(a, arr);
      var l = this.last;
      this.last = v;
      return r + v + l;
    }
  };

  a = ['a', 'b', 'c', 'd'];
  delete a[1];
  delete a[3];
  assertEquals('_cac', goog.array.reduceRight(a, scope.testFn, '_', scope));
}

function testArrayFind() {
  var a = [0, 1, 2, 3];
  var b = goog.array.find(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 1;
  });
  assertEquals(2, b);

  b = goog.array.find(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 100;
  });
  assertNull(b);

  a = 'abCD';
  b = goog.array.find(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val >= 'A' && val <= 'Z';
  });
  assertEquals('C', b);

  a = 'abcd';
  b = goog.array.find(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val >= 'A' && val <= 'Z';
  });
  assertNull(b);
}

function testArrayFindOmitsDeleted() {
  var a = [0, 1, 2, 3];
  delete a[1];
  delete a[3];
  var b = goog.array.find(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 1;
  });

  assertEquals(2, b);
  b = goog.array.find(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 100;
  });
  assertNull(b);
}

function testArrayFindIndex() {
  var a = [0, 1, 2, 3];
  var b = goog.array.findIndex(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 1;
  });
  assertEquals(2, b);

  b = goog.array.findIndex(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 100;
  });
  assertEquals(-1, b);

  a = 'abCD';
  b = goog.array.findIndex(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val >= 'A' && val <= 'Z';
  });
  assertEquals(2, b);

  a = 'abcd';
  b = goog.array.findIndex(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val >= 'A' && val <= 'Z';
  });
  assertEquals(-1, b);
}

function testArrayFindIndexOmitsDeleted() {
  var a = [0, 1, 2, 3];
  delete a[1];
  delete a[3];
  var b = goog.array.findIndex(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 1;
  });
  assertEquals(2, b);

  b = goog.array.findIndex(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 100;
  });
  assertEquals(-1, b);
}

function testArrayFindRight() {
  var a = [0, 1, 2, 3];
  var b = goog.array.findRight(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val < 3;
  });
  assertEquals(2, b);
  b = goog.array.findRight(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 100;
  });
  assertNull(b);
}

function testArrayFindRightOmitsDeleted() {
  var a = [0, 1, 2, 3];
  delete a[1];
  delete a[3];
  var b = goog.array.findRight(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val < 3;
  });
  assertEquals(2, b);
  b = goog.array.findRight(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 100;
  });
  assertNull(b);
}

function testArrayFindIndexRight() {
  var a = [0, 1, 2, 3];
  var b = goog.array.findIndexRight(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val < 3;
  });
  assertEquals(2, b);

  b = goog.array.findIndexRight(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 100;
  });
  assertEquals(-1, b);

  a = 'abCD';
  b = goog.array.findIndexRight(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val >= 'a' && val <= 'z';
  });
  assertEquals(1, b);

  a = 'abcd';
  b = goog.array.findIndexRight(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val >= 'A' && val <= 'Z';
  });
  assertEquals(-1, b);
}

function testArrayFindIndexRightOmitsDeleted() {
  var a = [0, 1, 2, 3];
  delete a[1];
  delete a[3];
  var b = goog.array.findIndexRight(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val < 3;
  });
  assertEquals(2, b);
  b = goog.array.findIndexRight(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 100;
  });
  assertEquals(-1, b);
}

function testArraySome() {
  var a = [0, 1, 2, 3];
  var b = goog.array.some(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 1;
  });
  assertTrue(b);
  b = goog.array.some(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 100;
  });
  assertFalse(b);
}

function testArraySomeOmitsDeleted() {
  var a = [0, 1, 2, 3];
  delete a[1];
  delete a[3];
  var b = goog.array.some(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('number', typeof val);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 1;
  });
  assertTrue(b);
  b = goog.array.some(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('number', typeof val);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 100;
  });
  assertFalse(b);
}

function testArrayEvery() {
  var a = [0, 1, 2, 3];
  var b = goog.array.every(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val >= 0;
  });
  assertTrue(b);
  b = goog.array.every(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 1;
  });
  assertFalse(b);
}

function testArrayEveryOmitsDeleted() {
  var a = [0, 1, 2, 3];
  delete a[1];
  delete a[3];
  var b = goog.array.every(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('number', typeof val);
    assertEquals('index is not a number', 'number', typeof index);
    return val >= 0;
  });
  assertTrue(b);
  b = goog.array.every(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('number', typeof val);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 1;
  });
  assertFalse(b);
}

function testArrayContains() {
  var a = [0, 1, 2, 3];
  assertTrue('contain, Should contain 3', goog.array.contains(a, 3));
  assertFalse('contain, Should not contain 4', goog.array.contains(a, 4));

  var s = 'abcd';
  assertTrue('contain, Should contain d', goog.array.contains(s, 'd'));
  assertFalse('contain, Should not contain e', goog.array.contains(s, 'e'));
}

function testArrayContainsOmitsDeleted() {
  var a = [0, 1, 2, 3];
  delete a[1];
  delete a[3];
  assertFalse('should not contain undefined', goog.array.contains(a, undefined));
}

function testArrayInsert() {
  var a = [0, 1, 2, 3];

  goog.array.insert(a, 4);
  assertEquals('insert, Should append 4', a[4], 4);
  goog.array.insert(a, 3);
  assertEquals('insert, Should not append 3', a.length, 5);
  assertNotEquals('insert, Should not append 3', a[a.length - 1], 3);
}

function testArrayInsertAt() {
  var a = [0, 1, 2, 3];

  goog.array.insertAt(a, 4, 2);
  assertArrayEquals('insertAt, insert in middle', [0, 1, 4, 2, 3], a);
  goog.array.insertAt(a, 5, 10);
  assertArrayEquals('insertAt, too large value should append',
                    [0, 1, 4, 2, 3, 5], a);
  goog.array.insertAt(a, 6);
  assertArrayEquals('insertAt, null/undefined value should insert at 0',
                    [6, 0, 1, 4, 2, 3, 5], a);
  goog.array.insertAt(a, 7, -2);
  assertArrayEquals('insertAt, negative values start from end',
                    [6, 0, 1, 4, 2, 7, 3, 5], a);
}

function testArrayInsertArrayAt() {
  var a = [2, 5];
  goog.array.insertArrayAt(a, [3, 4], 1);
  assertArrayEquals('insertArrayAt, insert in middle', [2, 3, 4, 5], a);
  goog.array.insertArrayAt(a, [0, 1], 0);
  assertArrayEquals('insertArrayAt, insert at beginning',
                    [0, 1, 2, 3, 4, 5], a);
  goog.array.insertArrayAt(a, [6, 7], 6);
  assertArrayEquals('insertArrayAt, insert at end',
                    [0, 1, 2, 3, 4, 5, 6, 7], a);
  goog.array.insertArrayAt(a, ['x'], 4);
  assertArrayEquals('insertArrayAt, insert one element',
                    [0, 1, 2, 3, 'x', 4, 5, 6, 7], a);
  goog.array.insertArrayAt(a, [], 4);
  assertArrayEquals('insertArrayAt, insert 0 elements',
                    [0, 1, 2, 3, 'x', 4, 5, 6, 7], a);
  goog.array.insertArrayAt(a, ['y', 'z']);
  assertArrayEquals('insertArrayAt, undefined value should insert at 0',
      ['y', 'z', 0, 1, 2, 3, 'x', 4, 5, 6, 7], a);
  goog.array.insertArrayAt(a, ['a'], null);
  assertArrayEquals('insertArrayAt, null value should insert at 0',
      ['a', 'y', 'z', 0, 1, 2, 3, 'x', 4, 5, 6, 7], a);
  goog.array.insertArrayAt(a, ['b'], 100);
  assertArrayEquals('insertArrayAt, too large value should append',
      ['a', 'y', 'z', 0, 1, 2, 3, 'x', 4, 5, 6, 7, 'b'], a);
  goog.array.insertArrayAt(a, ['c', 'd'], -2);
  assertArrayEquals('insertArrayAt, negative values start from end',
      ['a', 'y', 'z', 0, 1, 2, 3, 'x', 4, 5, 6, 'c', 'd', 7, 'b'], a);
}

function testArrayInsertBefore() {
  var a = ['a', 'b', 'c', 'd'];
  goog.array.insertBefore(a, 'e', 'b');
  assertArrayEquals('insertBefore, with existing element',
                    ['a', 'e', 'b', 'c', 'd'], a);
  goog.array.insertBefore(a, 'f', 'x');
  assertArrayEquals('insertBefore, with non existing element',
                    ['a', 'e', 'b', 'c', 'd', 'f'], a);
}

function testArrayRemove() {
  var a = ['a', 'b', 'c', 'd'];
  goog.array.remove(a, 'c');
  assertArrayEquals('remove, remove existing element', ['a', 'b', 'd'], a);
  goog.array.remove(a, 'x');
  assertArrayEquals('remove, remove non existing element', ['a', 'b', 'd'], a);
}

function testArrayRemoveAt() {
  var a = [0, 1, 2, 3];
  goog.array.removeAt(a, 2);
  assertArrayEquals('removeAt, remove existing index', [0, 1, 3], a);
  a = [0, 1, 2, 3];
  goog.array.removeAt(a, 10);
  assertArrayEquals('removeAt, remove non existing index', [0, 1, 2, 3], a);
  a = [0, 1, 2, 3];
  goog.array.removeAt(a, -2);
  assertArrayEquals('removeAt, remove with negative index', [0, 1, 3], a);
}

function testArrayRemoveIf() {
  var a = [0, 1, 2, 3];
  var b = goog.array.removeIf(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 1;
  });
  assertArrayEquals('removeIf, remove existing element', [0, 1, 3], a);

  a = [0, 1, 2, 3];
  var b = goog.array.removeIf(a, function (val, index, a2) {
    assertEquals(a, a2);
    assertEquals('index is not a number', 'number', typeof index);
    return val > 100;
  });
  assertArrayEquals('removeIf, remove non-existing element', [0, 1, 2, 3], a);
}

function testArrayClone() {
  var a = [0, 1, 2, 3];
  var a2 = goog.array.clone(a);
  assertArrayEquals('clone, should be equal', a, a2);

  var b = {0: 0, 1: 1, 2: 2, 3: 3, length: 4};
  var b2 = goog.array.clone(b);
  for (var i = 0; i < b.length; i++) {
    assertEquals('clone, should be equal', b[i], b2[i]);
  }
}

function testToArray() {
  var a = [0, 1, 2, 3];
  var a2 = goog.array.toArray(a);
  assertArrayEquals('toArray, should be equal', a, a2);

  var b = {0: 0, 1: 1, 2: 2, 3: 3, length: 4};
  var b2 = goog.array.toArray(b);
  for (var i = 0; i < b.length; i++) {
    assertEquals('toArray, should be equal', b[i], b2[i]);
  }
}

function testExtend() {
  var a = [0, 1];
  goog.array.extend(a, [2, 3]);
  var a2 = [0, 1, 2, 3];
  assertArrayEquals('extend, should be equal', a, a2);

  var b = [0, 1];
  goog.array.extend(b, 2);
  var b2 = [0, 1, 2];
  assertArrayEquals('extend, should be equal', b, b2);

  a = [0, 1];
  goog.array.extend(a, [2, 3], [4, 5]);
  a2 = [0, 1, 2, 3, 4, 5];
  assertArrayEquals('extend, should be equal', a, a2);

  b = [0, 1];
  goog.array.extend(b, 2, 3);
  b2 = [0, 1, 2, 3];
  assertArrayEquals('extend, should be equal', b, b2);

  var c = [0, 1];
  goog.array.extend(c, 2, [3, 4], 5, [6]);
  var c2 = [0, 1, 2, 3, 4, 5, 6];
  assertArrayEquals('extend, should be equal', c, c2);

  var d = [0, 1];
  var arrayLikeObject = {0: 2, 1: 3, length: 2};
  goog.array.extend(d, arrayLikeObject);
  var d2 = [0, 1, 2, 3];
  assertArrayEquals('extend, should be equal', d, d2);

  var e = [0, 1];
  var emptyArrayLikeObject = {length: 0};
  goog.array.extend(e, emptyArrayLikeObject);
  assertArrayEquals('extend, should be equal', e, e);

  var f = [0, 1];
  var length3ArrayLikeObject = {0: 2, 1: 4, 2: 8, length: 3};
  goog.array.extend(f, length3ArrayLikeObject, length3ArrayLikeObject);
  var f2 = [0, 1, 2, 4, 8, 2, 4, 8];
  assertArrayEquals('extend, should be equal', f2, f);
}

function testExtendWithArguments() {
  function f() {
    return arguments;
  }
  var a = [0];
  var a2 = [0, 1, 2, 3, 4, 5];
  goog.array.extend(a, f(1, 2, 3), f(4, 5));
  assertArrayEquals('extend, should be equal', a, a2);
}

function testArraySplice() {
  var a = [0, 1, 2, 3];
  goog.array.splice(a, 1, 0, 4);
  assertArrayEquals([0, 4, 1, 2, 3], a);
  goog.array.splice(a, 1, 1, 5);
  assertArrayEquals([0, 5, 1, 2, 3], a);
  goog.array.splice(a, 1, 1);
  assertArrayEquals([0, 1, 2, 3], a);
  // var args
  goog.array.splice(a, 1, 1, 4, 5, 6);
  assertArrayEquals([0, 4, 5, 6, 2, 3], a);
}

function testArraySlice() {
  var a = [0, 1, 2, 3];
  a = goog.array.slice(a, 1, 3);
  assertArrayEquals([1, 2], a);
  a = [0, 1, 2, 3];
  a = goog.array.slice(a, 1, 6);
  assertArrayEquals('slice, with too large end', [1, 2, 3], a);
  a = [0, 1, 2, 3];
  a = goog.array.slice(a, 1, -1);
  assertArrayEquals('slice, with negative end', [1, 2], a);
  a = [0, 1, 2, 3];
  a = goog.array.slice(a, -2, 3);
  assertArrayEquals('slice, with negative start', [2], a);
}

function assertRemovedDuplicates(expected, original) {
  var tempArr = goog.array.clone(original);
  goog.array.removeDuplicates(tempArr);
  assertArrayEquals(expected, tempArr);
}

function testRemoveDuplicates() {
  assertRemovedDuplicates([1, 2, 3, 4, 5, 6], [1, 2, 3, 4, 5, 6]);
  assertRemovedDuplicates([9, 4, 2, 1, 3, 6, 0, -9],
                          [9, 4, 2, 4, 4, 2, 9, 1, 3, 6, 0, -9]);
  assertRemovedDuplicates(['four', 'one', 'two', 'three', 'THREE'],
      ['four', 'one', 'two', 'one', 'three', 'THREE', 'four', 'two']);
  assertRemovedDuplicates([], []);
  assertRemovedDuplicates(
      ['abc', 'hasOwnProperty', 'toString'],
      ['abc', 'hasOwnProperty', 'toString', 'abc']);

  var o1 = {}, o2 = {}, o3 = {}, o4 = {};
  assertRemovedDuplicates([o1, o2, o3, o4], [o1, o1, o2, o3, o2, o4]);

  // Mixed object types.
  assertRemovedDuplicates([1, '1', 2, '2'], [1, '1', 2, '2']);
  assertRemovedDuplicates([true, 'true', false, 'false'],
                          [true, 'true', false, 'false']);
  assertRemovedDuplicates(['foo'], [String('foo'), 'foo']);
  assertRemovedDuplicates([12], [Number(12), 12])

  var obj = {};
  var uid = goog.getUid(obj);
  assertRemovedDuplicates([obj, uid], [obj, uid])
};

function testBinaryInsertRemove() {
  var makeChecker = function(array, fn, opt_compareFn) {
    return function(value, expectResult, expectArray) {
      var result = fn(array, value, opt_compareFn);
      assertEquals(expectResult, result);
      assertArrayEquals(expectArray, array);
    }
  };

  var a = [];
  var check = makeChecker(a, goog.array.binaryInsert);
  check(3, true,  [3]);
  check(3, false, [3]);
  check(1, true,  [1, 3]);
  check(5, true,  [1, 3, 5]);
  check(2, true,  [1, 2, 3, 5]);
  check(2, false, [1, 2, 3, 5]);

  check = makeChecker(a, goog.array.binaryRemove);
  check(0, false, [1, 2, 3, 5]);
  check(3, true,  [1, 2, 5]);
  check(1, true,  [2, 5]);
  check(5, true,  [2]);
  check(2, true,  []);
  check(2, false, []);

  // test with custom comparison function, which reverse orders numbers
  var revNumCompare = function(a, b) { return b - a; };

  check = makeChecker(a, goog.array.binaryInsert, revNumCompare);
  check(3, true,  [3]);
  check(3, false, [3]);
  check(1, true,  [3, 1]);
  check(5, true,  [5, 3, 1]);
  check(2, true,  [5, 3, 2, 1]);
  check(2, false, [5, 3, 2, 1]);

  check = makeChecker(a, goog.array.binaryRemove, revNumCompare);
  check(0, false, [5, 3, 2, 1]);
  check(3, true,  [5, 2, 1]);
  check(1, true,  [5, 2]);
  check(5, true,  [2]);
  check(2, true,  []);
  check(2, false, []);
}

function testBinarySearch() {
  var insertionPoint = function(position) { return -(position + 1)};
  var pos;

  // test default comparison on array of String(s)
  var a = ['1000', '9', 'AB', 'ABC', 'ABCABC', 'ABD', 'ABDA', 'B', 'B', 'B',
      'C', 'CA', 'CC', 'ZZZ', 'ab', 'abc', 'abcabc', 'abd', 'abda', 'b',
      'c', 'ca', 'cc', 'zzz'];

  assertEquals('\'1000\' should be found at index 0', 0,
               goog.array.binarySearch(a, '1000'));
  assertEquals('\'zzz\' should be found at index ' + (a.length - 1),
      a.length - 1, goog.array.binarySearch(a, 'zzz'));
  assertEquals('\'C\' should be found at index 10', 10,
               goog.array.binarySearch(a, 'C'));
  pos = goog.array.binarySearch(a, 'B');
  assertTrue('\'B\' should be found at index 7 || 8 || 9', pos == 7 ||
      pos == 8 || pos == 9);
  pos = goog.array.binarySearch(a, '100');
  assertTrue('\'100\' should not be found', pos < 0);
  assertEquals('\'100\' should have an insertion point of 0', 0,
      insertionPoint(pos));
  pos = goog.array.binarySearch(a, 'zzz0');
  assertTrue('\'zzz0\' should not be found', pos < 0);
  assertEquals('\'zzz0\' should have an insertion point of ' + (a.length),
      a.length, insertionPoint(pos));
  pos = goog.array.binarySearch(a, 'BA');
  assertTrue('\'BA\' should not be found', pos < 0);
  assertEquals('\'BA\' should have an insertion point of 10', 10,
      insertionPoint(pos));

  // test 0 length array with default comparison
  var b = [];

  pos = goog.array.binarySearch(b, 'a');
  assertTrue('\'a\' should not be found', pos < 0);
  assertEquals('\'a\' should have an insertion point of 0', 0,
      insertionPoint(pos));

  // test single element array with default lexiographical comparison
  var c = ['only item'];

  assertEquals('\'only item\' should be found at index 0', 0,
      goog.array.binarySearch(c, 'only item'));
  pos = goog.array.binarySearch(c, 'a');
  assertTrue('\'a\' should not be found', pos < 0);
  assertEquals('\'a\' should have an insertion point of 0', 0,
      insertionPoint(pos));
  pos = goog.array.binarySearch(c, 'z');
  assertTrue('\'z\' should not be found', pos < 0);
  assertEquals('\'z\' should have an insertion point of 1', 1,
      insertionPoint(pos));

  // test default comparison on array of Number(s)
  var d =   [-897123.9, -321434.58758, -1321.3124, -324, -9, -3, 0, 0, 0,
      0.31255, 5, 142.88888708, 334, 342, 453, 54254]

  assertEquals('-897123.9 should be found at index 0', 0,
      goog.array.binarySearch(d, -897123.9));
  assertEquals('54254 should be found at index ' + (a.length - 1),
      d.length - 1, goog.array.binarySearch(d, 54254));
  assertEquals('-3 should be found at index 5', 5, goog.array.binarySearch(d, -3));
  pos = goog.array.binarySearch(d, 0);
  assertTrue('0 should be found at index 6 || 7 || 8', pos == 6 ||
      pos == 7 || pos == 8);
  pos = goog.array.binarySearch(d, -900000);
  assertTrue('-900000 should not be found', pos < 0);
  assertEquals('-900000 should have an insertion point of 0', 0,
      insertionPoint(pos));
  pos = goog.array.binarySearch(d, '54255');
  assertTrue('54255 should not be found', pos < 0);
  assertEquals('54255 should have an insertion point of ' + (d.length),
      d.length, insertionPoint(pos));
  pos = goog.array.binarySearch(d, 1.1);
  assertTrue('1.1 should not be found', pos < 0);
  assertEquals('1.1 should have an insertion point of 10', 10,
      insertionPoint(pos));

  // test with custom comparison function, which reverse orders numbers
  var revNumCompare = function(a, b) { return b - a; };

  var e = [54254, 453, 342, 334, 142.88888708, 5, 0.31255, 0, 0, 0, -3,
      -9, -324, -1321.3124, -321434.58758, -897123.9]

  assertEquals('54254 should be found at index 0', 0,
               goog.array.binarySearch(e, 54254, revNumCompare));
  assertEquals('-897123.9 should be found at index ' + (e.length - 1),
      e.length - 1, goog.array.binarySearch(e, -897123.9, revNumCompare));
  assertEquals('-3 should be found at index 10', 10,
               goog.array.binarySearch(e, -3, revNumCompare));
  pos = goog.array.binarySearch(e, 0, revNumCompare);
  assertTrue('0 should be found at index  || 10', pos == 7 ||
      pos == 9 || pos == 10);
  pos = goog.array.binarySearch(e, 54254.1, revNumCompare);
  assertTrue('54254.1 should not be found', pos < 0);
  assertEquals('54254.1 should have an insertion point of 0', 0,
      insertionPoint(pos));
  pos = goog.array.binarySearch(e, -897124, revNumCompare);
  assertTrue('-897124 should not be found', pos < 0);
  assertEquals('-897124 should have an insertion point of ' + (e.length),
      e.length, insertionPoint(pos));
  pos = goog.array.binarySearch(e, 1.1, revNumCompare);
  assertTrue('1.1 should not be found', pos < 0);
  assertEquals('1.1 should have an insertion point of 6', 6,
      insertionPoint(pos));

  // test 0 length array with custom comparison function
  var f = [];

  pos = goog.array.binarySearch(f, 0, revNumCompare);
  assertTrue('0 should not be found', pos < 0);
  assertEquals('0 should have an insertion point of 0', 0,
      insertionPoint(pos));

  // test single element array with custom comparison function
  var g = [1];

  assertEquals('1 should be found at index 0', 0, goog.array.binarySearch(g, 1,
      revNumCompare));
  pos = goog.array.binarySearch(g, 2, revNumCompare);
  assertTrue('2 should not be found', pos < 0);
  assertEquals('2 should have an insertion point of 0', 0,
      insertionPoint(pos));
  pos = goog.array.binarySearch(g, 0, revNumCompare);
  assertTrue('0 should not be found', pos < 0);
  assertEquals('0 should have an insertion point of 1', 1,
      insertionPoint(pos));

  assertEquals('binarySearch should find the index of the first 0',
      0, goog.array.binarySearch([0, 0, 1], 0));
  assertEquals('binarySearch should find the index of the first 1',
      1, goog.array.binarySearch([0, 1, 1], 1));
}


function testBinarySearchPerformance() {
  // Ensure that Array#slice, Function#apply and Function#call are not called
  // from within binarySearch, since they have performance implications in IE.

  propertyReplacer = new goog.testing.PropertyReplacer();
  propertyReplacer.replace(Array.prototype, 'slice', function() {
    fail('Should not call Array#slice from binary search.');
  });
  propertyReplacer.replace(Function.prototype, 'apply', function() {
    fail('Should not call Function#apply from binary search.');
  });
  propertyReplacer.replace(Function.prototype, 'call', function() {
    fail('Should not call Function#call from binary search.');
  });

  var array = [1, 5, 7, 11, 13, 16, 19, 24, 28, 31, 33, 36, 40, 50, 52, 55];
  // Test with the default comparison function.
  goog.array.binarySearch(array, 48);
  // Test with a custom comparison function.
  goog.array.binarySearch(array, 13, function(a, b) {
    return a > b ? 1 : a < b ? -1 : 0;
  });
}


function testBinarySelect() {
  var insertionPoint = function(position) { return -(position + 1)};
  var numbers = [-897123.9, -321434.58758, -1321.3124, -324, -9, -3, 0, 0, 0,
      0.31255, 5, 142.88888708, 334, 342, 453, 54254];
  var objects = goog.array.map(numbers, function(n) {return {n: n};});
  function makeEvaluator(target) {
    return function(obj, i, arr) {
      assertEquals(objects, arr);
      assertEquals(obj, arr[i]);
      return target - obj.n;
    };
  }
  assertEquals('{n:-897123.9} should be found at index 0', 0,
      goog.array.binarySelect(objects, makeEvaluator(-897123.9)));
  assertEquals('{n:54254} should be found at index ' + (objects.length - 1),
      objects.length - 1,
      goog.array.binarySelect(objects, makeEvaluator(54254)));
  assertEquals('{n:-3} should be found at index 5', 5,
      goog.array.binarySelect(objects, makeEvaluator(-3)));
  pos = goog.array.binarySelect(objects, makeEvaluator(0));
  assertTrue('{n:0} should be found at index 6 || 7 || 8', pos == 6 ||
      pos == 7 || pos == 8);
  pos = goog.array.binarySelect(objects, makeEvaluator(-900000));
  assertTrue('{n:-900000} should not be found', pos < 0);
  assertEquals('{n:-900000} should have an insertion point of 0', 0,
      insertionPoint(pos));
  pos = goog.array.binarySelect(objects, makeEvaluator('54255'));
  assertTrue('{n:54255} should not be found', pos < 0);
  assertEquals('{n:54255} should have an insertion point of ' +
      (objects.length), objects.length, insertionPoint(pos));
  pos = goog.array.binarySelect(objects, makeEvaluator(1.1));
  assertTrue('{n:1.1} should not be found', pos < 0);
  assertEquals('{n:1.1} should have an insertion point of 10', 10,
      insertionPoint(pos));
}


function testArrayEquals() {
  // Test argument types.
  assertFalse('array == not array', goog.array.equals([], null));
  assertFalse('not array == array', goog.array.equals(null, []));
  assertFalse('not array == not array', goog.array.equals(null, null));

  // Test with default comparison function.
  assertTrue('[] == []', goog.array.equals([], []));
  assertTrue('[1] == [1]', goog.array.equals([1], [1]));
  assertTrue('["1"] == ["1"]', goog.array.equals(['1'], ['1']));
  assertFalse('[1] == ["1"]', goog.array.equals([1], ['1']));
  assertTrue('[null] == [null]', goog.array.equals([null], [null]));
  assertFalse('[null] == [undefined]', goog.array.equals([null], [undefined]));
  assertTrue('[1, 2] == [1, 2]', goog.array.equals([1, 2], [1, 2]));
  assertFalse('[1, 2] == [2, 1]', goog.array.equals([1, 2], [2, 1]));
  assertFalse('[1, 2] == [1]', goog.array.equals([1, 2], [1]));
  assertFalse('[1] == [1, 2]', goog.array.equals([1], [1, 2]));
  assertFalse('[{}] == [{}]', goog.array.equals([{}], [{}]));

  // Test with custom comparison function.
  var cmp = function(a, b) { return typeof a == typeof b; }
  assertTrue('[] cmp []', goog.array.equals([], [], cmp));
  assertTrue('[1] cmp [1]', goog.array.equals([1], [1], cmp));
  assertTrue('[1] cmp [2]', goog.array.equals([1], [2], cmp));
  assertTrue('["1"] cmp ["1"]', goog.array.equals(['1'], ['1'], cmp));
  assertTrue('["1"] cmp ["2"]', goog.array.equals(['1'], ['2'], cmp));
  assertFalse('[1] cmp ["1"]', goog.array.equals([1], ['1'], cmp));
  assertTrue('[1, 2] cmp [3, 4]', goog.array.equals([1, 2], [3, 4], cmp));
  assertFalse('[1] cmp [2, 3]', goog.array.equals([1], [2, 3], cmp));
  assertTrue('[{}] cmp [{}]', goog.array.equals([{}], [{}], cmp));
  assertTrue('[{}] cmp [{a: 1}]', goog.array.equals([{}], [{a: 1}], cmp));

  // Test with array-like objects.
  assertTrue('[5] == obj [5]',
      goog.array.equals([5], {0: 5, length: 1}));
  assertTrue('obj [5] == [5]',
      goog.array.equals({0: 5, length: 1}, [5]));
  assertTrue('["x"] == obj ["x"]',
      goog.array.equals(['x'], {0: 'x', length: 1}));
  assertTrue('obj ["x"] == ["x"]',
      goog.array.equals({0: 'x', length: 1}, ['x']));
  assertTrue('[5] == {0: 5, 1: 6, length: 1}',
      goog.array.equals([5], {0: 5, 1: 6, length: 1}));
  assertTrue('{0: 5, 1: 6, length: 1} == [5]',
      goog.array.equals({0: 5, 1: 6, length: 1}, [5]));
  assertFalse('[5, 6] == {0: 5, 1: 6, length: 1}',
      goog.array.equals([5, 6], {0: 5, 1: 6, length: 1}));
  assertFalse('{0: 5, 1: 6, length: 1}, [5, 6]',
      goog.array.equals({0: 5, 1: 6, length: 1}, [5, 6]));
  assertTrue('[5, 6] == obj [5, 6]',
      goog.array.equals([5, 6], {0: 5, 1: 6, length: 2}));
  assertTrue('obj [5, 6] == [5, 6]',
      goog.array.equals({0: 5, 1: 6, length: 2}, [5, 6]));
  assertFalse('{0: 5, 1: 6} == [5, 6]',
      goog.array.equals({0: 5, 1: 6}, [5, 6]));
}


function assertArraysEqual(arr1, arr2) {
  assertEquals('Expected length ' + arr1.length, arr1.length, arr2.length);
  for (var i = 0; i < arr1.length; i++) {
    assertEquals(arr1[i] + ' expected at position ' + i,  arr1[i], arr2[i]);
  }
}


function testSort() {
  // Test sorting empty array
  var a = [];
  goog.array.sort(a);
  assertEquals('Sorted empty array is still an empty array (length 0)', 0,
      a.length);

  // Test sorting homogenous array of String(s) of length > 1
  var b = ['JUST', '1', 'test', 'Array', 'to', 'test', 'array', 'Sort',
      'about', 'NOW', '!!'];
  var bSorted = ['!!', '1', 'Array', 'JUST', 'NOW', 'Sort', 'about', 'array',
      'test', 'test', 'to'];
  goog.array.sort(b);
  assertArraysEqual(bSorted, b);

  // Test sorting already sorted array of String(s) of length > 1
  goog.array.sort(b);
  assertArraysEqual(bSorted, b);

  // Test sorting homogenous array of integer Number(s) of length > 1
  var c = [100, 1, 2000, -1, 0, 1000023, 12312512, -12331, 123, 54325,
      -38104783, 93708, 908, -213, -4, 5423, 0];
  var cSorted = [-38104783, -12331, -213, -4, -1, 0, 0, 1, 100, 123, 908,
      2000, 5423, 54325, 93708, 1000023, 12312512];
  goog.array.sort(c);
  assertArraysEqual(cSorted, c);

  // Test sorting already sorted array of integer Number(s) of length > 1
  goog.array.sort(c);
  assertArraysEqual(cSorted, c);

  // Test sorting homogenous array of Number(s) of length > 1
  var e = [-1321.3124, 0.31255, 54254, 0, 142.88888708, -321434.58758, -324,
      453, 334, -3, 5, -9, 342, -897123.9];
  var eSorted = [-897123.9, -321434.58758, -1321.3124, -324, -9, -3, 0,
      0.31255, 5, 142.88888708, 334, 342, 453, 54254];
  goog.array.sort(e);
  assertArraysEqual(eSorted, e);

  // Test sorting already sorted array of Number(s) of length > 1
  goog.array.sort(e);
  assertArraysEqual(eSorted, e);

  // Test sorting array of Number(s) of length > 1,
  // using custom comparison function which does reverse ordering
  var f = [-1321.3124, 0.31255, 54254, 0, 142.88888708, -321434.58758,
      -324, 453, 334, -3, 5, -9, 342, -897123.9];
  var fSorted = [54254, 453, 342, 334, 142.88888708, 5, 0.31255, 0, -3, -9,
      -324, -1321.3124, -321434.58758, -897123.9]
  goog.array.sort(f, function(a, b) { return b - a; });
  assertArraysEqual(fSorted, f);

  // Test sorting already sorted array of Number(s) of length > 1
  // using custom comparison function which does reverse ordering
  goog.array.sort(f, function(a, b) {return b - a; });
  assertArraysEqual(fSorted, f);

  // Test sorting array of custom Object(s) of length > 1 that have
  // an overriden toString
  function ComparedObject(value) {
    this.value = value;
  };

  ComparedObject.prototype.toString = function() {
    return this.value;
  };

  var co1 = new ComparedObject('a');
  var co2 = new ComparedObject('b');
  var co3 = new ComparedObject('c');
  var co4 = new ComparedObject('d');

  var g = [co3, co4, co2, co1];
  var gSorted = [co1, co2, co3, co4];
  goog.array.sort(g);
  assertArraysEqual(gSorted, g);

  // Test sorting already sorted array of custom Object(s) of length > 1
  // that have an overriden toString
  goog.array.sort(g);
  assertArraysEqual(gSorted, g);

  // Test sorting an array of custom Object(s) of length > 1 using
  // a custom comparison function
  var h = [co4, co2, co1, co3];
  var hSorted = [co1, co2, co3, co4];
  goog.array.sort(h, function(a, b) {
    return a.value > b.value ? 1 : a.value < b.value ? -1 : 0;
  });
  assertArraysEqual(hSorted, h);

  // Test sorting already sorted array of custom Object(s) of length > 1
  // using a custom comparison function
  goog.array.sort(h);
  assertArraysEqual(hSorted, h);

  // Test sorting arrays of length 1
  var i = ['one'];
  var iSorted = ['one'];
  goog.array.sort(i);
  assertArraysEqual(iSorted, i);

  var j = [1];
  var jSorted = [1];
  goog.array.sort(j);
  assertArraysEqual(jSorted, j);

  var k = [1.1];
  var kSorted = [1.1];
  goog.array.sort(k);
  assertArraysEqual(kSorted, k);

  var l = [co3];
  var lSorted = [co3];
  goog.array.sort(l);
  assertArraysEqual(lSorted, l);

  var m = [co2];
  var mSorted = [co2];
  goog.array.sort(m, function(a, b) {
    return a.value > b.value ? 1 : a.value < b.value ? -1 : 0;
  });
  assertArraysEqual(mSorted, m);
}

function testStableSort() {
  // Test array with custom comparison function
  var arr = [{key: 3, val: 'a'}, {key: 2, val: 'b'}, {key: 3,
      val: 'c'}, {key: 4, val: 'd'}, {key: 3, val: 'e'}];
  var arrClone = goog.array.clone(arr);

  function comparisonFn(obj1, obj2) {
    return obj1.key - obj2.key;
  }
  goog.array.stableSort(arr, comparisonFn);
  var sortedValues = [];
  for (var i = 0; i < arr.length; i++) {
    sortedValues.push(arr[i].val);
  }
  var wantedSortedValues = ['b', 'a', 'c', 'e', 'd'];
  assertArraysEqual(wantedSortedValues, sortedValues);

  // Test array without custom comparison function
  var arr2 = [];
  for (var i = 0; i < arrClone.length; i++) {
    arr2.push({val: arrClone[i].val, toString:
      goog.partial(function(index) {
        return arrClone[index].key;
      }, i)});
  }
  goog.array.stableSort(arr2);
  var sortedValues2 = [];
  for (var i = 0; i < arr2.length; i++) {
    sortedValues2.push(arr2[i].val);
  }
  assertArrayEquals(wantedSortedValues, sortedValues2);
}

function testArrayBucketModulus() {
  // bucket things by modulus
  var a = {};
  var b = [];

  function modFive(num) {
    return num % 5;
  }

  for (var i = 0; i < 20; i++) {
    var mod = modFive(i);
    a[mod] = a[mod] || [];
    a[mod].push(i);
    b.push(i);
  }

  var buckets = goog.array.bucket(b, modFive);

  for (var i = 0; i < 5; i++) {
    // The order isn't defined, but they should be the same sorted.
    goog.array.sort(a[i])
    goog.array.sort(buckets[i])
    assertArraysEqual(a[i], buckets[i]);
  }
}

function testArrayBucketEvenOdd() {
  var a = [1, 2, 3, 4, 5, 6, 7, 8, 9];

  // test even/odd
  function isEven(value, index, array) {
    assertEquals(value, array[index]);
    assertEquals('number', typeof index);
    assertEquals(a, array);
    return value % 2 == 0;
  }

  var b = goog.array.bucket(a, isEven);

  assertArraysEqual(b[true], [2, 4, 6, 8]);
  assertArraysEqual(b[false], [1, 3, 5, 7, 9]);
}

function testArrayRepeat() {
  assertArrayEquals([], goog.array.repeat(3, 0));
  assertArrayEquals([], goog.array.repeat(3, -1));
  assertArrayEquals([3], goog.array.repeat(3, 1));
  assertArrayEquals([3, 3, 3], goog.array.repeat(3, 3));
  assertArrayEquals([null, null], goog.array.repeat(null, 2));
}

function testArrayFlatten() {
  assertArrayEquals([1, 2, 3, 4, 5], goog.array.flatten(1, 2, 3, 4, 5));
  assertArrayEquals([1, 2, 3, 4, 5], goog.array.flatten(1, [2, [3, [4, 5]]]));
  assertArrayEquals([1, 2, 3, 4], goog.array.flatten(1, [2, [3, [4]]]));
  assertArrayEquals([1, 2, 3, 4], goog.array.flatten([[[1], 2], 3], 4));
  assertArrayEquals([1], goog.array.flatten([[1]]));
  assertArrayEquals([], goog.array.flatten());
  assertArrayEquals([], goog.array.flatten([]));
}

function testSortObjectsByKey() {
  var sortedArray = buildSortedObjectArray(4);
  var objects =
      [sortedArray[1], sortedArray[2], sortedArray[0], sortedArray[3]];

  goog.array.sortObjectsByKey(objects, 'name');
  validateObjectArray(sortedArray, objects);
}

function testSortObjectsByKeyWithCompareFunction() {
  var sortedArray = buildSortedObjectArray(4);
  var objects =
      [sortedArray[1], sortedArray[2], sortedArray[0], sortedArray[3]];
  var descSortedArray =
      [sortedArray[3], sortedArray[2], sortedArray[1], sortedArray[0]];

  function descCompare(a, b) {
      return a < b ? 1 : a > b ? -1 : 0;
  };

  goog.array.sortObjectsByKey(objects, 'name', descCompare);
  validateObjectArray(descSortedArray, objects);
}

function buildSortedObjectArray(size) {
  var objectArray = [];
  for (var i = 0; i < size; i++) {
    objectArray.push({
      'name': 'name_' + i,
      'id': 'id_' + (size - i)
    });
  }

  return objectArray;
}

function validateObjectArray(expected, actual) {
  assertEquals(expected.length, actual.length);
  for (var i = 0; i < expected.length; i++) {
    assertEquals(expected[i].name, actual[i].name);
    assertEquals(expected[i].id, actual[i].id);
  }
}

function testIsSorted() {
  assertTrue(goog.array.isSorted([1, 2, 3]));
  assertTrue(goog.array.isSorted([1, 2, 2]));
  assertFalse(goog.array.isSorted([1, 2, 1]));

  assertTrue(goog.array.isSorted([1, 2, 3], null, true));
  assertFalse(goog.array.isSorted([1, 2, 2], null, true));
  assertFalse(goog.array.isSorted([1, 2, 1], null, true));

  function compare(a, b) {
    return b - a;
  }

  assertFalse(goog.array.isSorted([1, 2, 3], compare));
  assertTrue(goog.array.isSorted([3, 2, 2], compare));
}

function assertRotated(expect, array, rotate) {
  assertArrayEquals(expect, goog.array.rotate(array, rotate));
}

function testRotate() {
  assertRotated([], [], 3);
  assertRotated([1], [1], 3);
  assertRotated([1, 2, 3, 4, 0], [0, 1, 2, 3, 4], -6);
  assertRotated([0, 1, 2, 3, 4], [0, 1, 2, 3, 4], -5);
  assertRotated([4, 0, 1, 2, 3], [0, 1, 2, 3, 4], -4);
  assertRotated([3, 4, 0, 1, 2], [0, 1, 2, 3, 4], -3);
  assertRotated([2, 3, 4, 0, 1], [0, 1, 2, 3, 4], -2);
  assertRotated([1, 2, 3, 4, 0], [0, 1, 2, 3, 4], -1);
  assertRotated([0, 1, 2, 3, 4], [0, 1, 2, 3, 4], 0);
  assertRotated([4, 0, 1, 2, 3], [0, 1, 2, 3, 4], 1);
  assertRotated([3, 4, 0, 1, 2], [0, 1, 2, 3, 4], 2);
  assertRotated([2, 3, 4, 0, 1], [0, 1, 2, 3, 4], 3);
  assertRotated([1, 2, 3, 4, 0], [0, 1, 2, 3, 4], 4);
  assertRotated([0, 1, 2, 3, 4], [0, 1, 2, 3, 4], 5);
  assertRotated([4, 0, 1, 2, 3], [0, 1, 2, 3, 4], 6);
}

function testConcat() {
  var a1 = [1, 2, 3];
  var a2 = [4, 5, 6];
  var a3 = goog.array.concat(a1, a2);
  a1.push(1);
  a2.push(5);
  assertArrayEquals([1, 2, 3, 4, 5, 6], a3);
}

function testConcatWithNoSecondArg() {
  var a1 = [1, 2, 3, 4];
  var a2 = goog.array.concat(a1);
  a1.push(5);
  assertArrayEquals([1, 2, 3, 4], a2);
}

function testConcatWithNonArrayArgs() {
  var a1 = [1, 2, 3, 4];
  var o = {0: 'a', 1: 'b', length: 2};
  var a2 = goog.array.concat(a1, 5, '10', o);
  assertArrayEquals([1, 2, 3, 4, 5, '10', o], a2);
}

function testConcatWithNull() {
  var a1 = goog.array.concat(null, [1, 2, 3]);
  var a2 = goog.array.concat([1, 2, 3], null);
  assertArrayEquals([null, 1, 2, 3], a1);
  assertArrayEquals([1, 2, 3, null], a2);
}

function testZip() {
  var a1 = goog.array.zip([1, 2, 3], [3, 2, 1]);
  var a2 = goog.array.zip([1, 2], [3, 2, 1]);
  var a3 = goog.array.zip();
  assertArrayEquals([[1, 3], [2, 2], [3, 1]], a1);
  assertArrayEquals([[1, 3], [2, 2]], a2);
  assertArrayEquals([], a3);
}

function testShuffle() {
  // Test array. This array should have unique values for the purposes of this
  // test case.
  var testArray = [1, 2, 3, 4, 5];
  var testArrayCopy = goog.array.clone(testArray);

  // Custom random function, which always returns a value approaching 1,
  // resulting in a "shuffle" that preserves the order of original array
  // (for array sizes that we work with here).
  var noChangeShuffleFunction = function() {
    return .999999;
  };
  goog.array.shuffle(testArray, noChangeShuffleFunction);
  assertArrayEquals(testArrayCopy, testArray);

  // Custom random function, which always returns 0, resulting in a
  // deterministic "shuffle" that is predictable but differs from the
  // original order of the array.
  var testShuffleFunction = function() {
    return 0;
  };
  goog.array.shuffle(testArray, testShuffleFunction);
  assertArrayEquals([2, 3, 4, 5, 1], testArray);

  // Test the use of a real random function (no optional RNG is specified).
  goog.array.shuffle(testArray);

  // Ensure the shuffled array comprises the same elements (without regard to
  // order).
  assertSameElements(testArrayCopy, testArray);
}
">n/a</td></tr>
<tr><td>error_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.debug.Error');
  goog.require('goog.testing.ExpectedFailures');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');
  goog.require('goog.userAgent.product');


var expectedFailures = new goog.testing.ExpectedFailures();

function tearDown() {
  expectedFailures.handleTearDown();
}

function testError() {
  function xxxxx() {
    yyyyy();
  }
  function yyyyy() {
    zzzzz();
  }
  function zzzzz() {
    throw new goog.debug.Error('testing');
  }

  var stack = null, message = null;
  try {
    xxxxx();
  } catch (e) {
    message = e.message;
    stack = e.stack.split('\n');
  }

  assertEquals('Message property should be set', 'testing', message);

  expectedFailures.expectFailureFor(
      goog.userAgent.IE ||
      goog.userAgent.product.SAFARI || (
          goog.userAgent.product.CHROME &&
          !goog.userAgent.isVersion(532)),
      'error.stack is not widely supported');
  try {
    assertContains('1st line of stack should have "Error"', 'Error', stack[0]);
    // 2nd line is slightly different in firefox/chrome
    assertContains('3rd line of stack should have "zzzzz"', 'zzzzz', stack[2]);
    assertContains('4th line of stack should have "yyyyy"', 'yyyyy', stack[3]);
    assertContains('5th line of stack should have "xxxxx"', 'xxxxx', stack[4]);
  } catch (e) {
    expectedFailures.handleException(e);
  }
}

function testInheriting() {
  function MyError() {
    goog.debug.Error.call(this);
  }
  goog.inherits(MyError, goog.debug.Error);
  MyError.prototype.message = 'My custom error';

  var message = null;
  try {
    throw new MyError();
  } catch (e) {
    message = e.message;
  }
  assertEquals('My custom error', message);
}

">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:10:24
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>entrypointregistry_test.html</td><td>Success</td><td> 1 passed, 0 failed.</td><td title="

  goog.require('goog.testing.jsunit');
  goog.require('goog.debug.ErrorHandler');
  goog.require('goog.debug.entryPointRegistry');



var lastError;
var errorHandler;

function setUp() {
  lastError = null;
  errorHandler = new goog.debug.ErrorHandler(function(ex) {
    lastError = ex;
  });
  goog.debug.entryPointRegistry.refList_ = [];
}

function testMonitorAndUnmonitor() {
  var errorString = 'Hello!';
  var errorFn = function() {
    throw {message: errorString};
  };

  goog.debug.entryPointRegistry.register(function(transformer) {
    errorFn = transformer(errorFn);
  });

  goog.debug.entryPointRegistry.monitorAll(errorHandler);


  var e = assertThrows('expected error', errorFn);
  assertEquals('Hello!', e.message);
  assertEquals('Hello!', lastError.message);

  errorString = 'Goodbye!';
  goog.debug.entryPointRegistry.unmonitorAllIfPossible(errorHandler);

  e = assertThrows('expected error', errorFn);
  assertEquals('Goodbye!', e.message);
  assertEquals('Hello!', lastError.message);
}

">n/a</td></tr>
<tr><td>errorreporter_test.html</td><td>Success</td><td> 14 passed, 0 failed.</td><td title="

  goog.require('goog.debug.ErrorReporter');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.userAgent');


  MockXhrIo = function() {};

  MockXhrIo.prototype.onReadyStateChangeEntryPoint_ = function() {};

  MockXhrIo.protectEntryPoints = function() {};

  MockXhrIo.lastUrl = null;

  MockXhrIo.send = function(url, opt_callback, opt_method, opt_content,
      opt_headers, opt_timeInterval) {
    MockXhrIo.lastUrl = url;
    MockXhrIo.lastContent = opt_content;
    MockXhrIo.lastHeaders = opt_headers;
  };

  var stubs = new goog.testing.PropertyReplacer();
  var url = "http://www.your.tst/more/bogus.js";
  var encodedUrl = "http%3A%2F%2Fwww.your.tst%2Fmore%2Fbogus.js";

  function setUp() {
    stubs.set(goog.net, 'XhrIo', MockXhrIo);
    // Ensure that setTimeout always gets cleaned up, since ErrorReporter
    // nukes setTimeout.
    stubs.set(goog.global, 'setTimeout', window.setTimeout);
  }

  function tearDown() {
    stubs.reset();
    MockXhrIo.lastUrl = null;
  }

  function throwAnErrorWith(script, line, message, opt_stack) {
    var error = {
        message: message,
        fileName: script,
        lineNumber: line};
    if (opt_stack) {
      error['stack'] = opt_stack
    }

    throw error;
  }

  function testsendErrorReport() {
    new goog.debug.ErrorReporter('/log').sendErrorReport(
        'message', 'filename.js', 123, 'trace');

    assertEquals('/log?script=filename.js&error=message&line=123',
        MockXhrIo.lastUrl);
    assertEquals('trace=trace', MockXhrIo.lastContent);
  }

  function testsendErrorReportWithCustomSender() {
    var uri = null;
    var method = null;
    var content = null;
    var headers = null;
    function mockXhrSender(uriIn, methodIn, contentIn, headersIn) {
      uri = uriIn;
      method = methodIn;
      content = contentIn;
      headers = headersIn;
    }

    var er = new goog.debug.ErrorReporter('/log');
    er.setXhrSender(mockXhrSender);
    er.sendErrorReport('message', 'filename.js', 123, 'trace');

    assertEquals('/log?script=filename.js&error=message&line=123', uri);
    assertEquals('POST', method);
    assertEquals('trace=trace', content);
    assertUndefined(headers);
  }

  function testsendErrorReport_noTrace() {
    new goog.debug.ErrorReporter('/log').sendErrorReport(
        'message', 'filename.js', 123);

    assertEquals('/log?script=filename.js&error=message&line=123',
        MockXhrIo.lastUrl);
    assertEquals('', MockXhrIo.lastContent);
  }

  function test_nonInternetExplorerSendErrorReport() {
    stubs.set(goog.userAgent, 'IE', false);
    stubs.set(goog.global, 'setTimeout',
        function(fcn, time) {
          fcn.call();
        });

    goog.debug.ErrorReporter.install("/errorreporter");

    var errorFunction = goog.partial(throwAnErrorWith, url, 5, "Hello :)");

    try {
      goog.global.setTimeout(errorFunction, 0);
    } catch (e) {
      // Expected. The error is rethrown after sending.
    }

    assertEquals(
        "/errorreporter?script=" + encodedUrl + "&error=Hello%20%3A)&line=5",
        MockXhrIo.lastUrl);
    assertEquals("trace=Not%20available", MockXhrIo.lastContent);
  }

  function test_internetExplorerSendErrorReport() {
    stubs.set(goog.userAgent, 'IE', true);

    // Remove test runner's onerror handler so the test doesn't fail.
    stubs.set(goog.global, 'onerror', null);

    var errorReporter = goog.debug.ErrorReporter.install("/errorreporter");
    goog.global.onerror("Goodbye :(", url, 22);
    assertEquals(
        "/errorreporter?script=" + encodedUrl + "&error=Goodbye%20%3A(&line=22",
        MockXhrIo.lastUrl);
    assertEquals("trace=Not%20available", MockXhrIo.lastContent);
  }

  function test_setLoggingHeaders() {
    stubs.set(goog.userAgent, 'IE', true);
    // Remove test runner's onerror handler so the test doesn't fail.
    stubs.set(goog.global, 'onerror', null);

    var errorReporter = goog.debug.ErrorReporter.install("/errorreporter");
    errorReporter.setLoggingHeaders("header!");
    goog.global.onerror("Goodbye :(", "http://www.your.tst/more/bogus.js", 22);
    assertEquals("header!", MockXhrIo.lastHeaders);
  }

  function test_nonInternetExplorerSendErrorReportWithTrace() {
    stubs.set(goog.userAgent, 'IE', false);
    stubs.set(goog.global, 'setTimeout',
        function(fcn, time) {
          fcn.call();
        });

    goog.debug.ErrorReporter.install("/errorreporter");

    var trace =
        "Error(\"Something Wrong\")@:0\n" +
        "$MF$E$Nx$([object Object])@http://a.b.c:83/a/f.js:901\n" +
        "([object Object])@http://a.b.c:813/a/f.js:37";


    var errorFunction = goog.partial(throwAnErrorWith, url, 5, "Hello :)",
        trace);

    try {
      goog.global.setTimeout(errorFunction, 0);
    } catch (e) {
      // Expected. The error is rethrown after sending.
    }

    assertEquals(
        "/errorreporter?script=" + encodedUrl + "&error=Hello%20%3A)&line=5",
        MockXhrIo.lastUrl);
    assertEquals("trace=" +
        "Error(%22Something%20Wrong%22)%40%3A0%0A" +
        "%24MF%24E%24Nx%24(%5Bobject%20Object%5D)%40"+
        "http%3A%2F%2Fa.b.c%3A83%2Fa%2Ff.js%3A901%0A"+
        "(%5Bobject%20Object%5D)%40http%3A%2F%2Fa.b.c%3A813%2Fa%2Ff.js%3A37",
        MockXhrIo.lastContent);
  }

  function testProtectAdditionalEntryPoint_nonIE() {
    stubs.set(goog.userAgent, 'IE', false);

    var reporter = goog.debug.ErrorReporter.install("/errorreporter");
    var fn = function() {};
    var protectedFn = reporter.protectAdditionalEntryPoint(fn);
    assertNotNull(protectedFn);
    assertNotEquals(fn, protectedFn);
  }

  function testProtectAdditionalEntryPoint_IE() {
    stubs.set(goog.userAgent, 'IE', true);

    var reporter = goog.debug.ErrorReporter.install("/errorreporter");
    var fn = function() {};
    var protectedFn = reporter.protectAdditionalEntryPoint(fn);
    assertNull(protectedFn);
  }

  function testHandleException_dispatchesEvent() {
    var reporter = goog.debug.ErrorReporter.install("/errorreporter");
    var loggedErrors = 0;
    goog.events.listen(reporter, goog.debug.ErrorReporter.ExceptionEvent.TYPE,
        function(event) {
          assertNotNullNorUndefined(event.error);
          loggedErrors++;
        });
    reporter.handleException(new Error());
    reporter.handleException(new Error());
    assertEquals('Expected 2 errors. ' +
        '(Ensure an exception was not swallowed.)', 2, loggedErrors);
  }

  function testHandleException_includesContext() {
    var reporter = goog.debug.ErrorReporter.install("/errorreporter");
    var loggedErrors = 0;
    var testError = new Error('test error');
    var testContext = { 'contextParam' : 'contextValue' };
    goog.events.listen(reporter, goog.debug.ErrorReporter.ExceptionEvent.TYPE,
        function(event) {
          assertNotNullNorUndefined(event.error);
          assertObjectEquals({ contextParam : 'contextValue' }, event.context);
          loggedErrors++;
        });
    reporter.handleException(testError, testContext);
    assertEquals('Expected 1 error. ' +
        '(Ensure an exception was not swallowed.)', 1, loggedErrors);
  }

  function testContextProvider() {
    var reporter = goog.debug.ErrorReporter.install("/errorreporter",
        function(error, context) {
          context.providedContext ='value';
        });
    var loggedErrors = 0;
    var testError = new Error('test error');
    goog.events.listen(reporter, goog.debug.ErrorReporter.ExceptionEvent.TYPE,
        function(event) {
          assertNotNullNorUndefined(event.error);
          assertObjectEquals({ providedContext : 'value' } , event.context);
          loggedErrors++;
        });
    reporter.handleException(testError);
    assertEquals('Expected 1 error. ' +
        '(Ensure an exception was not swallowed.)', 1, loggedErrors);
  }

  function testContextProvider_withOtherContext() {
    var reporter = goog.debug.ErrorReporter.install("/errorreporter",
        function(error, context) {
          context.providedContext = 'value';
        });
    var loggedErrors = 0;
    var testError = new Error('test error');
    goog.events.listen(reporter, goog.debug.ErrorReporter.ExceptionEvent.TYPE,
        function(event) {
          assertNotNullNorUndefined(event.error);
          assertObjectEquals(
              { providedContext : 'value', otherContext : 'value' },
              event.context);
          loggedErrors++;
        });
    reporter.handleException(testError, { 'otherContext' : 'value' });
    assertEquals('Expected 1 error. ' +
        '(Ensure an exception was not swallowed.)', 1, loggedErrors);
  }

  function testHandleException_ignoresExceptionsDuringEventDispatch() {
    var reporter = goog.debug.ErrorReporter.install("/errorreporter");
    goog.events.listen(reporter, goog.debug.ErrorReporter.ExceptionEvent.TYPE,
        function(event) {
          fail('This exception should be swallowed.');
        });
    reporter.handleException(new Error());
  }

">n/a</td></tr>
<tr><td>tracer_test.html</td><td>Success</td><td> 2 passed, 0 failed.</td><td title="

  goog.require('goog.debug.Trace');
  goog.require('goog.testing.jsunit');



  function testTracer() {
    goog.debug.Trace.initCurrentTrace();
    var t = goog.debug.Trace.startTracer('foo');
    var sum = 0;
    for (var i = 0; i < 100000; i++) {
      sum += i;
    }
    goog.debug.Trace.stopTracer(t);
    var trace = goog.debug.Trace.getFormattedTrace();
    var lines = trace.split('\n');
    assertEquals(8, lines.length);
    assertNotNull(lines[0].match(/^\s*\d+\.\d+\s+Start\s+foo$/));
    assertNotNull(lines[1].match(/^\s*\d+\s+\d+\.\d+\s+Done\s+\d+ ms\s+foo$/));
  }

  function testPerf() {
    goog.debug.Trace.initCurrentTrace();
    var count = 1000;
    var start = goog.now();
    for (var i = 0; i < count; i++) {
      var t = goog.debug.Trace.startTracer('foo');
      var t2 = goog.debug.Trace.startTracer('foo.bar');
      var t3 = goog.debug.Trace.startTracer('foo.bar.baz');
      goog.debug.Trace.stopTracer(t3);
      var t4 = goog.debug.Trace.startTracer('foo.bar.bim');
      goog.debug.Trace.stopTracer(t4);
      goog.debug.Trace.stopTracer(t2);
      goog.debug.Trace.stopTracer(t);
    }
    count *= 4;
    var end = goog.now();
  }


">n/a</td></tr>
<tr><td>devcss_test.html</td><td>Fail</td><td> 0 passed, 9 failed.</td><td title="

      goog.require('goog.testing.jsunit');
      goog.require('goog.userAgent');
      goog.require('goog.style');
      goog.require('goog.cssom');
      goog.require('goog.debug');
      goog.require('goog.debug.DevCss');
    

    var el = document.getElementById('devcss-test-2');

    // Since background color sometimes comes back like rgb(xxx, xxx, xxx)
    // or rgb(xxx,xxx,xxx) depending on browser.
    function spaceless(foo) {
      return foo.replace(/\s/g, '')
    }

    function testGetIe6CombinedSelectorText() {
      var devcssInstance = new goog.debug.DevCss();
      devcssInstance.ie6CombinedMatches_ = [];
      var css = '.class2 { -goog-ie6-selector:".class1_class2"; prop: val; }';
      var newCss = devcssInstance.getIe6CombinedSelectorText_(css);
      assertEquals('.class1_class2', newCss);
      assertArrayEquals(['class1', 'class2'],
          devcssInstance.ie6CombinedMatches_[0].classNames);
      assertEquals('class1_class2',
          devcssInstance.ie6CombinedMatches_[0].combinedClassName);

      devcssInstance = new goog.debug.DevCss();
      devcssInstance.ie6CombinedMatches_ = [];
      css = '.class3 { prop: val; -goog-ie6-selector:".class1_class2_class3";' +
          'prop: val; }';
      newCss = devcssInstance.getIe6CombinedSelectorText_(css);
      assertEquals('.class1_class2_class3', newCss);
      assertArrayEquals(['class1', 'class2', 'class3'],
          devcssInstance.ie6CombinedMatches_[0].classNames);
      assertEquals('class1_class2_class3',
          devcssInstance.ie6CombinedMatches_[0].combinedClassName);

      devcssInstance = new goog.debug.DevCss();
      devcssInstance.ie6CombinedMatches_ = [];
      css = '.class3, .class5 {' +
          '-goog-ie6-selector:".class1_class2_class3, .class4_class5";' +
          'prop: val; }';
      newCss = devcssInstance.getIe6CombinedSelectorText_(css);
      assertEquals('.class1_class2_class3, .class4_class5', newCss);
      assertArrayEquals(['class1', 'class2', 'class3'],
          devcssInstance.ie6CombinedMatches_[0].classNames);
      assertEquals('class1_class2_class3',
          devcssInstance.ie6CombinedMatches_[0].combinedClassName);
      assertArrayEquals(['class4', 'class5'],
          devcssInstance.ie6CombinedMatches_[1].classNames);
      assertEquals('class4_class5',
          devcssInstance.ie6CombinedMatches_[1].combinedClassName);
    }

    function testAddIe6CombinedClassNames() {
      var el_combined1 = document.getElementById('devcss-test-combined1');
      var el_combined2 = document.getElementById('devcss-test-combined2');
      var el_notcombined1 = document.getElementById('devcss-test-notcombined1');
      var el_notcombined2 = document.getElementById('devcss-test-notcombined2');
      var el_notcombined3 = document.getElementById('devcss-test-notcombined3');

      var devcssInstance = new goog.debug.DevCss();
      devcssInstance.ie6CombinedMatches_ = [
          {
            classNames: ['ie6-2', 'ie6-1'],
            combinedClassName: 'ie6-1_ie6-2',
            els: []
          },
          {
            classNames: ['ie6-2', 'ie6-3', 'ie6-1'],
            combinedClassName: 'ie6-1_ie6-2_ie6-3',
            els: []
          }];

      devcssInstance.addIe6CombinedClassNames_();
      assertEquals(-1, el_notcombined1.className.indexOf('ie6-1_ie6-2'));
      assertEquals(-1, el_notcombined2.className.indexOf('ie6-1_ie6-2'));
      assertEquals(-1, el_notcombined3.className.indexOf('ie6-1_ie6-2_ie6-3'));
      assertTrue(el_combined1.className.indexOf('ie6-1_ie6-2') != -1);
      assertTrue(el_combined2.className.indexOf('ie6-1_ie6-2_ie6-3') != -1);
    }

    function testActivateBrowserSpecificCssALL() {
      // equals GECKO
      var devcssInstance = new goog.debug.DevCss('GECKO');
      devcssInstance.activateBrowserSpecificCssRules(false);
      var backgroundColor = goog.style.getBackgroundColor(el);
      assertEquals('rgb(255,192,203)', spaceless(backgroundColor));

      // GECKO test case w/ two selectors joined by a commma.
      var elGeckoOne = document.getElementById('devcss-gecko-1');
      backgroundColor = goog.style.getBackgroundColor(elGeckoOne);
      assertEquals('rgb(255,192,203)', spaceless(backgroundColor));
      var elGeckoTwo = document.getElementById('devcss-gecko-2');
      backgroundColor = goog.style.getBackgroundColor(elGeckoTwo);
      assertEquals('rgb(255,192,203)', spaceless(backgroundColor));
    }


    function testActivateBrowserSpecificCssWithVersion() {
      // equals IE 6
      var devcssInstance = new goog.debug.DevCss('IE', '6');
      devcssInstance.activateBrowserSpecificCssRules(false);
      var elIe6 = document.getElementById('devcss-test-ie6');
      var backgroundColor = goog.style.getBackgroundColor(elIe6);
      assertEquals('rgb(255,192,203)', spaceless(backgroundColor));

      // IE8 test case w/ two selectors joined by a commma.
      var devCssInstanceTwo = new goog.debug.DevCss('IE', '8');
      devCssInstanceTwo.activateBrowserSpecificCssRules(false);
      var elIe8One = document.getElementById('devcss-ie8-1');
      backgroundColor = goog.style.getBackgroundColor(elIe8One);
      assertEquals('rgb(255,192,203)', spaceless(backgroundColor));
      var elIe8Two = document.getElementById('devcss-ie8-2');
      backgroundColor = goog.style.getBackgroundColor(elIe8Two);
      assertEquals('rgb(255,192,203)', spaceless(backgroundColor));
    }

    function testActivateBrowserSpecificCssGteInvalid() {
      // WEBKIT_GTE255
      var marginBox = goog.style.getMarginBox(el);
      assertEquals(1, marginBox.top); // should still be 1

      var devcssInstance = new goog.debug.DevCss('WEBKIT', 254);
      devcssInstance.activateBrowserSpecificCssRules(false);
      var marginBox = goog.style.getMarginBox(el);
      assertEquals(1, marginBox.top); // should still be 1
    }

    function testActivateBrowserSpecificCssGteValid() {
      var devcssInstance = new goog.debug.DevCss('WEBKIT', 255);
      devcssInstance.activateBrowserSpecificCssRules(false);
      var marginBox = goog.style.getMarginBox(el);
      assertEquals(20, marginBox.top);
    }

    function testActivateBrowserSpecificCssLteInvalid() {
      // IE_LTE6
      var marginBox = goog.style.getMarginBox(el);
      assertEquals(1, marginBox.left); // should still be 1

      var devcssInstance = new goog.debug.DevCss('WEBKIT', 202);
      devcssInstance.activateBrowserSpecificCssRules(false);
      var marginBox = goog.style.getMarginBox(el);
      assertEquals(1, marginBox.left); // should still be 1
    }

    function testActivateBrowserSpecificCssLteValid() {
      var devcssInstance = new goog.debug.DevCss('WEBKIT', 199);
      devcssInstance.activateBrowserSpecificCssRules(false);
      var marginBox = goog.style.getMarginBox(el);
      assertEquals(15, marginBox.left);
    }

    function testReplaceIe6Selectors() {
      var devcssInstance = new goog.debug.DevCss('IE', 6);
      devcssInstance.activateBrowserSpecificCssRules(false);

      // It should correctly be transparent, even in IE6.
      var compound2El = document.getElementById('devcss-test-compound2');
      var backgroundColor = spaceless(
          goog.style.getBackgroundColor(compound2El));

      assertTrue('Unexpected background color: ' + backgroundColor,
          'transparent' == backgroundColor ||
          'rgba(0,0,0,0)' == backgroundColor);

      // And this one should have the combined selector working, even in
      // IE6.
      backgroundColor = goog.style.getBackgroundColor(
          document.getElementById('devcss-test-compound1-2'));
      assertEquals('rgb(255,192,203)', spaceless(backgroundColor));
    }

    /*
     * TODO(elsigh): Re-enable if we ever come up with a way to make imports
     * work.
    function testDisableDuplicateStyleSheetImports() {
      var el1 = document.getElementById('devcss-test-importfixer-1');
      var el2 = document.getElementById('devcss-test-importfixer-2');

      var backgroundColor = goog.style.getBackgroundColor(el1);
      assertEquals('rgb(255,255,0)', spaceless(backgroundColor));

      var backgroundColor = goog.style.getBackgroundColor(el2);
      assertEquals('rgb(255,0,0)', spaceless(backgroundColor));

      // This should disable the second coming of devcss_test_import_1.css.
      var devcssInstance = new goog.debug.DevCss();
      devcssInstance.disableDuplicateStyleSheetImports();

      var backgroundColor = goog.style.getBackgroundColor(el1);
      assertEquals('rgb(255,255,0)', spaceless(backgroundColor));

      var backgroundColor = goog.style.getBackgroundColor(el2);
      assertEquals('rgb(173,216,230)', spaceless(backgroundColor));
    }
    */
    ">9 of 9 tests run in 13ms.<br />0 passed, 9 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testActivateBrowserSpecificCssALL<br />Cannot read property 'imports' of undefined<br />ERROR in testActivateBrowserSpecificCssGteInvalid<br />Cannot read property 'defaultView' of undefined<br />ERROR in testActivateBrowserSpecificCssGteValid<br />Cannot read property 'imports' of undefined<br />ERROR in testActivateBrowserSpecificCssLteInvalid<br />Cannot read property 'defaultView' of undefined<br />ERROR in testActivateBrowserSpecificCssLteValid<br />Cannot read property 'imports' of undefined<br />ERROR in testActivateBrowserSpecificCssWithVersion<br />Cannot read property 'imports' of undefined<br />ERROR in testAddIe6CombinedClassNames<br />Could not determine the user agent from known UserAgents<br />ERROR in testGetIe6CombinedSelectorText<br />Could not determine the user agent from known UserAgents<br />ERROR in testReplaceIe6Selectors<br />Cannot read property 'imports' of undefined<br /></td></tr>
<tr><td>errorhandler_async_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.AsyncTestCase');
  goog.require('goog.debug.ErrorHandler');
  goog.require('goog.userAgent');



  var testCase = new goog.testing.AsyncTestCase(document.title);

  testCase.setUpPage = function() {
    this.waitForAsync('setUpPage');
    this.stepTimeout = 5 * 1000;

    this.oldTimeout = window.setTimeout;
    this.oldInterval = window.setInterval;
    this.handler = new goog.debug.ErrorHandler(
        goog.bind(this.onException, this));
    this.handler.protectWindowSetTimeout();
    this.handler.protectWindowSetInterval();
    this.exceptions = [];
    this.errors = 0;

    // Override the error event handler, since we are purposely throwing
    // exceptions from global functions, and expect them
    this.oldWindowOnError = window.onerror;
    window.onerror = goog.bind(this.onError, this);

    this.add(new goog.testing.TestCase.Test(
        'test results', this.testResults, this));
    this.timeoutId = window.setTimeout(goog.bind(this.timeOut, this), 10);
    this.intervalId = window.setInterval(goog.bind(this.interval, this), 20);
  };

  testCase.tearDownPage = function() {
    window.setTimeout = this.oldTimeout;
    window.setInterval = this.oldInterval;
  };

  testCase.onException = function(e) {
    this.exceptions.push(e);
    if (this.timeoutHit && this.intervalHit) {
      this.continueTesting();
    }
  };

  testCase.onError = function(msg, url, line) {
    this.errors++;
    return true;
  };

  testCase.timeOut = function() {
    this.timeoutHit = true;
    throw arguments.callee;
  };

  testCase.interval = function() {
    this.intervalHit = true;
    window.clearTimeout(this.intervalId);
    throw arguments.callee;
  };

  testCase.testResults = function() {
    var timeoutHit, intervalHit;

    for (var i = 0; i < this.exceptions.length; ++i) {
      switch (this.exceptions[i]) {
        case this.timeOut: timeoutHit = true; break;
        case this.interval: intervalHit = true; break;
      }
    }

    assertTrue('timeout exception not received', timeoutHit);
    assertTrue('interval exception not received', intervalHit);
    assertTrue('timeout not called', this.timeoutHit);
    assertTrue('interval not called', this.intervalHit);

    if (!goog.userAgent.WEBKIT) {
      assertEquals('2 exceptions should have been caught and rethrown',
          2, this.errors)
    }
  };

  function setUpPage() {
    testCase.runTests();
  }

  // Standalone Closure Test Runner.
  if (typeof G_testRunner != 'undefined') {
    G_testRunner.initialize(testCase);
  }

">TypeError: Cannot set property 'name_' of undefined
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:426:44)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
    at Module.load (module.js:219:31)
    at Function._load (module.js:186:10)
    at require (module.js:231:19)
</td></tr>
<tr><td>errorhandler_test.html</td><td>Success</td><td> 6 passed, 0 failed.</td><td title="

  goog.require('goog.debug.ErrorHandler');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');



  var oldGetObjectByName;

  // provide our own window that implements our instrumented and
  // immediate-call versions of setTimeout and setInterval
  var fakeWin = {};

  var errorHandler;

  function badTimer() {
    arguments.callee.called = true;
    throw 'die die die';
  }

  function setUp() {
    // On IE, globalEval happens async. So make it synchronous.
    goog.globalEval = function(str) {
      eval(str);
    };

    oldGetObjectByName = goog.getObjectByName;
    goog.getObjectByName = function(name) {
      if (name == 'window') {
        return fakeWin;
      } else {
        return oldGetObjectByName(name);
      }
    };

    fakeWin.setTimeout = function(fn, time) {
      fakeWin.setTimeout.called = true;
      fakeWin.setTimeout.that = this;
      if (goog.isString(fn)) {
        eval(fn);
      } else {
        fn();
      }
    };

    fakeWin.setInterval = function(fn, time) {
      fakeWin.setInterval.called = true;
      fakeWin.setInterval.that = this;
      if (goog.isString(fn)) {
        eval(fn);
      } else {
        fn();
      }
    };

    // just record the exception in the error handler when it happens
    errorHandler = new goog.debug.ErrorHandler(function(ex) {
                                                 this.ex = ex;
                                               });
  }

  function tearDown() {
    goog.dispose(errorHandler);
    errorHandler = null;

    goog.getObjectByName = oldGetObjectByName;

    delete badTimer['__protected__'];
  }

  function testWrapSetTimeout() {
    errorHandler.protectWindowSetTimeout();

    var caught;

    try {
      fakeWin.setTimeout(badTimer, 3);
    } catch (ex) {
      caught = ex;
    }
    assertSetTimeoutError(caught);
  }

  function testWrapSetTimeoutWithString() {
    errorHandler.protectWindowSetTimeout();

    var caught;

    try {
      fakeWin.setTimeout('badTimer()', 3);
    } catch (ex) {
      caught = ex;
    }
    assertSetTimeoutError(caught);
  }

  function testWrapSetInterval() {
    errorHandler.protectWindowSetInterval();

    var caught;

    try {
      fakeWin.setInterval(badTimer, 3);
    } catch (ex) {
      caught = ex;
    }
    assertSetIntervalError(caught);
  }

  function testWrapSetIntervalWithString() {
    errorHandler.protectWindowSetInterval();

    var caught;

    try {
      fakeWin.setInterval('badTimer()', 3);
    } catch (ex) {
      caught = ex;
    }
    assertSetIntervalError(caught);
  }

  function testDisposal() {
    fakeWin = goog.getObjectByName('window');
    var originalSetTimeout = fakeWin.setTimeout;
    var originalSetInterval = fakeWin.setInterval;

    errorHandler.protectWindowSetTimeout();
    errorHandler.protectWindowSetInterval();

    assertNotEquals(originalSetTimeout, fakeWin.setTimeout);
    assertNotEquals(originalSetInterval, fakeWin.setInterval);

    errorHandler.dispose();

    assertEquals(originalSetTimeout, fakeWin.setTimeout);
    assertEquals(originalSetInterval, fakeWin.setInterval);
  }

  function testUnwrap() {
    var fn = function() {};
    var wrappedFn = errorHandler.wrap(fn);
    assertNotEquals(wrappedFn, fn);

    assertEquals(fn, errorHandler.unwrap(fn));
    assertEquals(fn, errorHandler.unwrap(wrappedFn));
  }

  function assertSetTimeoutError(caught) {
    assertMethodCalledHelper('setTimeout', caught);
  }

  function assertSetIntervalError(caught) {
    assertMethodCalledHelper('setInterval', caught);
  }

  function assertMethodCalledHelper(method, caught) {
    assertTrue('exception not thrown', !!caught);
    assertEquals('exception not caught by error handler',
        caught, errorHandler.ex);
    assertTrue('fake ' + method + ' not called',
        !!fakeWin[method].called);
    assertTrue('"this" not passed to original ' + method,
        fakeWin[method].that === fakeWin);
  }

">n/a</td></tr>
<tr><td>logbuffer_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="

  goog.require('goog.debug.LogRecord');
  goog.require('goog.debug.LogBuffer');
  goog.require('goog.debug.Logger');
  goog.require('goog.testing.jsunit');



var DUMMY_LEVELS = [
    goog.debug.Logger.Level.INFO,
    goog.debug.Logger.Level.WARNING,
    goog.debug.Logger.Level.SEVERE];
var DUMMY_MESSAGES = ['a', 'b', 'c'];
var DUMMY_NAMES = ['X', 'Y', 'Z'];

var buffer;
var dummyIndex = 0;

function setUp() {
  goog.debug.LogBuffer.CAPACITY = 4;
  goog.debug.LogBuffer.instance_ = null;
  buffer = goog.debug.LogBuffer.getInstance();
}

function verifyRecord(expectedIndex, record) {
  var index = expectedIndex % DUMMY_MESSAGES.length;
  var message = DUMMY_MESSAGES[index];
  var level = DUMMY_LEVELS[index];
  var name = DUMMY_NAMES[index];
  assertEquals('Wrong level for record ' + expectedIndex, level,
      record.getLevel());
  assertEquals('Wrong message for record ' + expectedIndex, message,
      record.getMessage());
  assertEquals('Wrong name for record ' + expectedIndex, name,
      record.getLoggerName());
}

function addAndVerifyRecord() {
  var index = dummyIndex % DUMMY_MESSAGES.length;
  var level = DUMMY_LEVELS[index];
  var message = DUMMY_MESSAGES[index];
  var name = DUMMY_NAMES[index];
  var record = buffer.addRecord(level, message, name);
  verifyRecord(dummyIndex, record);
  dummyIndex++;
}

function addSomeRecords(howMany) {
  for (var i = 0; i < howMany; i++) {
    addAndVerifyRecord();
  }
}

function testAddRecord() {
  addSomeRecords(goog.debug.LogBuffer.CAPACITY * 3);
}

function testIsFull() {
  assertFalse('Should not be full.', buffer.isFull_);
  addSomeRecords(goog.debug.LogBuffer.CAPACITY * 1.5);
  assertTrue('Should be full.', buffer.isFull_);
  buffer.clear();
  assertFalse('Should not be full after clear().', buffer.isFull_);
  addSomeRecords(goog.debug.LogBuffer.CAPACITY - 1);
  assertFalse('Should not be full but almost full.', buffer.isFull_);
}

function testForEachRecord() {
  // Test with it half full.
  var howMany1 = goog.debug.LogBuffer.CAPACITY / 2;
  addSomeRecords(howMany1);
  var counter1 = 0;
  buffer.forEachRecord(function(record) {
    verifyRecord(counter1++, record);
  });
  assertEquals('Wrong number of records when half full.', howMany1, counter1);

  // Test with it full.
  var howMany2 = goog.debug.LogBuffer.CAPACITY;
  addSomeRecords(howMany2);
  var index = counter1;
  buffer.forEachRecord(function(record) {
    verifyRecord(index++, record);
  });
  assertEquals('Wrong number of records when full.', howMany1 + howMany2,
      index);
}

">n/a</td></tr>
<tr><td>enhanceerror_test.html</td><td>Fail</td><td> 0 passed, 1 failed.</td><td title="

  goog.require('goog.debug');
  goog.require('goog.testing.jsunit');



var THROW_STRING = 1;
var THROW_NPE = 2;
var THROW_ERROR = 3;
var THROW_ENHANCED_ERROR = 4;
var THROW_ENHANCED_STRING = 5;

if (typeof debug == 'undefined') {
  function debug(str) {
    if (window.console) window.console.log(str);
  }
}

function testEnhanceError() {
  // Tests are like this:
  // [test num, expect something in the stack, expect an extra message]
  var tests = [
    [THROW_STRING],
    [THROW_NPE],
    [THROW_ERROR],
    [THROW_ENHANCED_ERROR, 'throwEnhancedError', 'an enhanced error'],
    [THROW_ENHANCED_STRING, 'throwEnhancedString']
  ];
  for (var i = 0; i < tests.length; ++i) {
    var test = tests[i];
    var testNum = test[0];
    var testInStack = test[1];
    var testExtraMessage = test[2] || null;
    try {
      foo(testNum);
    } catch (e) {
      debug(goog.debug.expose(e));
      var s = e.stack.split('\n');
      for (var j = 0; j < s.length; ++j) {
        debug(s[j]);
      }
      // 'baz' is always in the stack
      assertTrue('stack should contain "baz"',
                 e.stack.indexOf('baz') != -1);

      if (testInStack) {
        assertTrue('stack should contain "' + testInStack + '"',
                   e.stack.indexOf(testInStack) != -1);
      }
      if (testExtraMessage) {
        // 2 messages
        assertTrue('message0 should contain "' + testExtraMessage + '"',
                   e.message0.indexOf(testExtraMessage) != -1);
        assertTrue('message1 should contain "message from baz"',
                   e.message1.indexOf('message from baz') != -1);
      } else {
        // 1 message
        assertTrue('message0 should contain "message from baz"',
                   e.message0.indexOf('message from baz') != -1);
      }
      continue;
    }
    fail('expected to catch an exception');
  }
}


function foo(testNum) {
  bar(testNum);
}

function bar(testNum) {
  baz(testNum);
}

function baz(testNum) {
  try {
    switch (testNum) {
      case THROW_STRING:
        throwString();
        break;
      case THROW_NPE:
        throwNpe();
        break;
      case THROW_ERROR:
        throwError();
        break;
      case THROW_ENHANCED_ERROR:
        throwEnhancedError();
        break;
      case THROW_ENHANCED_STRING:
        throwEnhancedString();
        break;
    }
  } catch (e) {
    throw goog.debug.enhanceError(e, 'message from baz');
  }
}

function throwString() {
  throw 'a string';
}

function throwNpe() {
  var nada = null;
  nada.noSuchFunction();
}

function throwError() {
  throw Error('an error');
}

function throwEnhancedError() {
  throw goog.debug.enhanceError(Error('dang!'), 'an enhanced error');
}

function throwEnhancedString() {
  throw goog.debug.enhanceError('oh nos!');
}

">1 of 1 tests run in 5ms.<br />0 passed, 1 failed.<br />5 ms/test. 1 files loaded.<br />ERROR in testEnhanceError<br />Object #<Object> has no method 'expose'<br /></td></tr>
<tr><td>debug_test.html</td><td>Fail</td><td> 0 passed, 1 failed.</td><td title="

  goog.require('goog.debug');
  goog.require('goog.testing.jsunit');



function testMakeWhitespaceVisible() {
  assertEquals(
      'Hello[_][_]World![r][n]\n' +
      '[r][n]\n' +
      '[f][f]I[_]am[t][t]here![r][n]\n',
      goog.debug.makeWhitespaceVisible(
          'Hello  World!\r\n\r\n\f\fI am\t\there!\r\n'));
}

">1 of 1 tests run in 4ms.<br />0 passed, 1 failed.<br />4 ms/test. 1 files loaded.<br />ERROR in testMakeWhitespaceVisible<br />Object #<Object> has no method 'makeWhitespaceVisible'<br /></td></tr>
<tr><td>logger_test.html</td><td>Success</td><td> 8 passed, 0 failed.</td><td title="

  goog.require('goog.debug.Logger');
  goog.require('goog.testing.jsunit');



function getDebug(sb, logger, level) {
  var spacer = '';
  if (level) {
    spacer = (new Array(level + 1)).join(' ');
  }
  sb[sb.length] = spacer;
  var name = logger.getName();
  if (name) {
    sb[sb.length] = name;
  } else {
    sb[sb.length] = 'ROOT';
  }
  sb[sb.length] = '\n';
  var children = logger.getChildren();
  for (var key in children) {
    getDebug(sb, children[key], level + 1);
  }
};


function testParents() {
  var l1 = goog.debug.Logger.getLogger('goog.test');
  var l2 = goog.debug.Logger.getLogger('goog.bar');
  var l3 = goog.debug.Logger.getLogger('goog.bar.foo');
  var l4 = goog.debug.Logger.getLogger('goog.bar.baaz');
  var rootLogger = goog.debug.LogManager.getRoot();
  var googLogger = goog.debug.Logger.getLogger('goog');
  assertEquals(rootLogger, googLogger.getParent());
  assertEquals(googLogger, l1.getParent());
  assertEquals(googLogger, l2.getParent());
  assertEquals(l2, l3.getParent());
  assertEquals(l2, l4.getParent());
}

function testLogging() {
  var root = goog.debug.LogManager.getRoot();
  var handler = new TestHandler();
  var f = goog.bind(handler.onPublish, handler);
  root.addHandler(f);
  var l4 = goog.debug.Logger.getLogger('goog.bar.baaz');
  l4.log(goog.debug.Logger.Level.WARNING, 'foo');
  assertNotNull(handler.logRecord);
  assertEquals(goog.debug.Logger.Level.WARNING, handler.logRecord.getLevel());
  assertEquals('foo', handler.logRecord.getMessage());
  handler.logRecord = null;
  root.removeHandler(f);
  l4.log(goog.debug.Logger.Level.WARNING, 'foo');
  assertNull(handler.logRecord);
}

function testFiltering() {
  var root = goog.debug.LogManager.getRoot();
  var handler = new TestHandler();
  var f = goog.bind(handler.onPublish, handler);
  root.addHandler(f);
  var l3 = goog.debug.Logger.getLogger('goog.bar.foo');
  l3.setLevel(goog.debug.Logger.Level.WARNING);
  var l4 = goog.debug.Logger.getLogger('goog.bar.baaz');
  l4.setLevel(goog.debug.Logger.Level.INFO);
  l4.log(goog.debug.Logger.Level.WARNING, 'foo');
  assertNotNull(handler.logRecord);
  assertEquals(goog.debug.Logger.Level.WARNING, handler.logRecord.getLevel());
  assertEquals('foo', handler.logRecord.getMessage());
  handler.reset();
  l3.log(goog.debug.Logger.Level.INFO, 'bar');
  assertNull(handler.logRecord);
  l3.log(goog.debug.Logger.Level.WARNING, 'baaz');
  assertNotNull(handler.logRecord);
  handler.reset();
  l3.log(goog.debug.Logger.Level.SEVERE, 'baaz');
  assertNotNull(handler.logRecord);
};

function testException() {
  var root = goog.debug.LogManager.getRoot();
  var handler = new TestHandler();
  var f = goog.bind(handler.onPublish, handler);
  root.addHandler(f);
  var logger = goog.debug.Logger.getLogger('goog.debug.logger_test');
  var ex = Error('boo!');
  logger.severe('hello', ex);
  assertNotNull(handler.logRecord);
  assertEquals(goog.debug.Logger.Level.SEVERE, handler.logRecord.getLevel());
  assertEquals('hello', handler.logRecord.getMessage());
  assertEquals(ex, handler.logRecord.getException());
  assertEquals('Message: boo!',
      handler.logRecord.getExceptionText().substring(0, 13));
}

function testGetPredefinedLevel() {
  assertEquals(goog.debug.Logger.Level.OFF,
      goog.debug.Logger.Level.getPredefinedLevel('OFF'));
  assertEquals(goog.debug.Logger.Level.SHOUT,
      goog.debug.Logger.Level.getPredefinedLevel('SHOUT'));
  assertEquals(goog.debug.Logger.Level.SEVERE,
      goog.debug.Logger.Level.getPredefinedLevel('SEVERE'));
  assertEquals(goog.debug.Logger.Level.WARNING,
      goog.debug.Logger.Level.getPredefinedLevel('WARNING'));
  assertEquals(goog.debug.Logger.Level.INFO,
      goog.debug.Logger.Level.getPredefinedLevel('INFO'));
  assertEquals(goog.debug.Logger.Level.CONFIG,
      goog.debug.Logger.Level.getPredefinedLevel('CONFIG'));
  assertEquals(goog.debug.Logger.Level.FINE,
      goog.debug.Logger.Level.getPredefinedLevel('FINE'));
  assertEquals(goog.debug.Logger.Level.FINER,
      goog.debug.Logger.Level.getPredefinedLevel('FINER'));
  assertEquals(goog.debug.Logger.Level.FINEST,
      goog.debug.Logger.Level.getPredefinedLevel('FINEST'));
  assertEquals(goog.debug.Logger.Level.ALL,
      goog.debug.Logger.Level.getPredefinedLevel('ALL'));
}

function testGetPredefinedLevelByValue() {
  assertEquals(goog.debug.Logger.Level.OFF,
      goog.debug.Logger.Level.getPredefinedLevelByValue(Infinity));
  assertEquals(goog.debug.Logger.Level.SHOUT,
      goog.debug.Logger.Level.getPredefinedLevelByValue(1300));
  assertEquals(goog.debug.Logger.Level.SHOUT,
      goog.debug.Logger.Level.getPredefinedLevelByValue(1200));
  assertEquals(goog.debug.Logger.Level.SEVERE,
      goog.debug.Logger.Level.getPredefinedLevelByValue(1150));
  assertEquals(goog.debug.Logger.Level.SEVERE,
      goog.debug.Logger.Level.getPredefinedLevelByValue(1000));
  assertEquals(goog.debug.Logger.Level.WARNING,
      goog.debug.Logger.Level.getPredefinedLevelByValue(900));
  assertEquals(goog.debug.Logger.Level.INFO,
      goog.debug.Logger.Level.getPredefinedLevelByValue(800));
  assertEquals(goog.debug.Logger.Level.CONFIG,
      goog.debug.Logger.Level.getPredefinedLevelByValue(701));
  assertEquals(goog.debug.Logger.Level.CONFIG,
      goog.debug.Logger.Level.getPredefinedLevelByValue(700));
  assertEquals(goog.debug.Logger.Level.FINE,
      goog.debug.Logger.Level.getPredefinedLevelByValue(500));
  assertEquals(goog.debug.Logger.Level.FINER,
      goog.debug.Logger.Level.getPredefinedLevelByValue(400));
  assertEquals(goog.debug.Logger.Level.FINEST,
      goog.debug.Logger.Level.getPredefinedLevelByValue(300));
  assertEquals(goog.debug.Logger.Level.ALL,
      goog.debug.Logger.Level.getPredefinedLevelByValue(0));
  assertNull(goog.debug.Logger.Level.getPredefinedLevelByValue(-1));
}

function TestHandler() {
  this.logRecord = null;
}

TestHandler.prototype.onPublish = function(logRecord) {
  this.logRecord = logRecord;
};


TestHandler.prototype.reset = function() {
  this.logRecord = null;
}

function testGetLogRecord() {
  var name = 'test.get.log.record';
  var level = 1;
  var msg = 'msg';

  var logger = goog.debug.Logger.getLogger(name);
  var logRecord = logger.getLogRecord(level, msg)

  assertEquals(name, logRecord.getLoggerName());
  assertEquals(level, logRecord.getLevel());
  assertEquals(msg, logRecord.getMessage());

  assertNull(logRecord.getException());
}

function testGetLogRecordWithException() {
  var name = 'test.get.log.record';
  var level = 1;
  var msg = 'msg';
  var ex = Error('Hi');

  var logger = goog.debug.Logger.getLogger(name);
  var logRecord = logger.getLogRecord(level, msg, ex)

  assertEquals(name, logRecord.getLoggerName());
  assertEquals(level, logRecord.getLevel());
  assertEquals(msg, logRecord.getMessage());
  assertEquals(ex, logRecord.getException());
}

">n/a</td></tr>
<tr><td>string_test.html</td><td>Fail</td><td> 52 passed, 5 failed.</td><td title="

  goog.require('goog.functions');
  goog.require('goog.object');
  goog.require('goog.string');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.testing.jsunit');



var stubs = new goog.testing.PropertyReplacer();

function tearDown() {
  stubs.reset();
}


//=== tests for goog.string.collapseWhitespace ===

function testCollapseWhiteSpace() {
  var f = goog.string.collapseWhitespace;

  assertEquals('Leading spaces not stripped', f('  abc'), 'abc');
  assertEquals('Trailing spaces not stripped', f('abc  '), 'abc');
  assertEquals('Wrapping spaces not stripped', f('  abc  '), 'abc');

  assertEquals('All white space chars not stripped',
               f('\xa0\n\t abc\xa0\n\t '), 'abc');

  assertEquals('Spaces not collapsed', f('a   b    c'), 'a b c');

  assertEquals('Tabs not collapsed', f('a\t\t\tb\tc'), 'a b c');

  assertEquals('All check failed', f(' \ta \t \t\tb\t\n\xa0  c  \t\n'),
               'a b c');
}


//=== tests for goog.string.isEmpty ===

function testIsEmpty() {
  assert('1. Should be empty', goog.string.isEmpty(''));
  assert('2. Should be empty', goog.string.isEmpty(' '));
  assert('3. Should be empty', goog.string.isEmpty('    '));
  assert('4. Should be empty', goog.string.isEmpty(' \t\t\n\xa0   '));

  assert('1. Should not be empty', !goog.string.isEmpty(' abc \t\xa0'));
  assert('2. Should not be empty', !goog.string.isEmpty(' a b c \t'));
  assert('3. Should not be empty', !goog.string.isEmpty(';'));


  var a;
  assert('Undefined is not empty', !goog.string.isEmpty(a));
  assert('Null is not empty', !goog.string.isEmpty(null));
  assert('A random object is not empty', !goog.string.isEmpty({a:1,b:2}));
}


//=== tests for goog.string.isAlpha ===
function testIsAlpha() {
  assertTrue('"a" should be alpha', goog.string.isAlpha('a'));
  assertTrue('"n" should be alpha', goog.string.isAlpha('n'));
  assertTrue('"z" should be alpha', goog.string.isAlpha('z'));
  assertTrue('"A" should be alpha', goog.string.isAlpha('A'));
  assertTrue('"N" should be alpha', goog.string.isAlpha('N'));
  assertTrue('"Z" should be alpha', goog.string.isAlpha('Z'));
  assertTrue('"aa" should be alpha', goog.string.isAlpha('aa'));
  assertTrue('null is alpha', goog.string.isAlpha(null));
  assertTrue('undefined is alpha', goog.string.isAlpha(undefined));

  assertFalse('"aa!" is not alpha', goog.string.isAlpha('aa!s'));
  assertFalse('"!" is not alpha', goog.string.isAlpha('!'));
  assertFalse('"0" is not alpha', goog.string.isAlpha('0'));
  assertFalse('"5" is not alpha', goog.string.isAlpha('5'));
}



//=== tests for goog.string.isNumeric ===
function testIsNumeric() {
  assertTrue('"8" is a numeric string', goog.string.isNumeric('8'));
  assertTrue('"5" is a numeric string', goog.string.isNumeric('5'));
  assertTrue('"34" is a numeric string', goog.string.isNumeric('34'));
  assertTrue('34 is a number', goog.string.isNumeric(34));

  assertFalse('"3.14" has a period', goog.string.isNumeric('3.14'));
  assertFalse('"A" is a letter', goog.string.isNumeric('A'));
  assertFalse('"!" is punctuation', goog.string.isNumeric('!'));
  assertFalse('null is not numeric', goog.string.isNumeric(null));
  assertFalse('undefined is not numeric', goog.string.isNumeric(undefined));
}


//=== tests for tests for goog.string.isAlphaNumeric ===
function testIsAlphaNumeric() {
  assertTrue('"ABCabc" should be alphanumeric',
             goog.string.isAlphaNumeric('ABCabc'));
  assertTrue('"123" should be alphanumeric', goog.string.isAlphaNumeric('123'));
  assertTrue('"ABCabc123" should be alphanumeric',
             goog.string.isAlphaNumeric('ABCabc123'));
  assertTrue('null is alphanumeric', goog.string.isAlphaNumeric(null));
  assertTrue('undefined is alphanumeric',
             goog.string.isAlphaNumeric(undefined));

  assertFalse('"123!" should not be alphanumeric',
              goog.string.isAlphaNumeric('123!'));
  assertFalse('"  " should not be alphanumeric',
              goog.string.isAlphaNumeric('  '));
}


//== tests for goog.string.isBreakingWhitespace ===

function testIsBreakingWhitespace() {
  assertTrue('" " is breaking', goog.string.isBreakingWhitespace(' '));
  assertTrue('"\\n" is breaking', goog.string.isBreakingWhitespace('\n'));
  assertTrue('"\\t" is breaking', goog.string.isBreakingWhitespace('\t'));
  assertTrue('"\\r" is breaking', goog.string.isBreakingWhitespace('\r'));
  assertTrue('"\\r\\n\\t " is breaking',
      goog.string.isBreakingWhitespace('\r\n\t '));

  assertFalse('nbsp is non-breaking', goog.string.isBreakingWhitespace('\xa0'));
  assertFalse('"a" is non-breaking', goog.string.isBreakingWhitespace('a'));
  assertFalse('"a\\r" is non-breaking',
      goog.string.isBreakingWhitespace('a\r'));
}


//=== tests for goog.string.isSpace ===
function testIsSpace() {
  assertTrue('" " is a space', goog.string.isSpace(' '));

  assertFalse('"\\n" is not a space', goog.string.isSpace('\n'));
  assertFalse('"\\t" is not a space', goog.string.isSpace('\t'));
  assertFalse('"  " is not a space, it\'s two spaces',
              goog.string.isSpace('  '));
  assertFalse('"a" is not a space', goog.string.isSpace('a'));
  assertFalse('"3" is not a space', goog.string.isSpace('3'));
  assertFalse('"#" is not a space', goog.string.isSpace('#'));
  assertFalse('null is not a space', goog.string.isSpace(null));
  assertFalse('nbsp is not a space', goog.string.isSpace('\xa0'));
}


// === tests for goog.string.stripNewlines ===
function testStripNewLines() {
  assertEquals('Should replace new lines with spaces',
               goog.string.stripNewlines('some\nlines\rthat\r\nare\n\nsplit'),
               'some lines that are split');
}


// === tests for goog.string.canonicalizeNewlines ===
function testCanonicalizeNewlines() {
  assertEquals('Should replace all types of new line with \\n',
               goog.string.canonicalizeNewlines(
                    'some\nlines\rthat\r\nare\n\nsplit'),
               'some\nlines\nthat\nare\n\nsplit');
}


// === tests for goog.string.normalizeWhitespace ===
function testWhitespace() {
  assertEquals('All whitespace chars should be replaced with a normal space',
               goog.string.normalizeWhitespace('\xa0 \n\t \xa0 \n\t'),
               '         ');
}


// === tests for goog.string.normalizeSpaces ===
function testNormalizeSpaces() {
  assertEquals('All whitespace chars should be replaced with a normal space',
               goog.string.normalizeSpaces('\xa0 \t \xa0 \t'),
               '    ');
}

/// === tests for goog.string.trim ===
function testTrim() {
  assertEquals('Should be the same', goog.string.trim('nothing 2 trim'),
               'nothing 2 trim');
  assertEquals('Remove spaces', goog.string.trim('   hello  goodbye   '),
               'hello  goodbye');
  assertEquals('Trim other stuff', goog.string.trim('\n\r\xa0 hi \r\n\xa0'),
               'hi');
}


/// === tests for goog.string.trimLeft ===
function testTrimLeft() {
  var f = goog.string.trimLeft;
  assertEquals('Should be the same', f('nothing to trim'), 'nothing to trim');
  assertEquals('Remove spaces', f('   hello  goodbye   '), 'hello  goodbye   ');
  assertEquals('Trim other stuff', f('\xa0\n\r hi \r\n\xa0'), 'hi \r\n\xa0');
}


/// === tests for goog.string.trimRight ===
function testTrimRight() {
  var f = goog.string.trimRight;
  assertEquals('Should be the same', f('nothing to trim'), 'nothing to trim');
  assertEquals('Remove spaces', f('   hello  goodbye   '), '   hello  goodbye');
  assertEquals('Trim other stuff', f('\n\r\xa0 hi \r\n\xa0'), '\n\r\xa0 hi');
}


// === tests for goog.string.startsWith ===
function testStartsWith() {
  assertTrue('Should start with \'\'', goog.string.startsWith('abcd', ''));
  assertTrue('Should start with \'ab\'', goog.string.startsWith('abcd', 'ab'));
  assertTrue('Should start with \'abcd\'',
             goog.string.startsWith('abcd', 'abcd'));
  assertFalse('Should not start with \'bcd\'',
              goog.string.startsWith('abcd', 'bcd'));
}

function testEndsWith() {
  assertTrue('Should end with \'\'', goog.string.endsWith('abcd', ''));
  assertTrue('Should end with \'ab\'', goog.string.endsWith('abcd', 'cd'));
  assertTrue('Should end with \'abcd\'', goog.string.endsWith('abcd', 'abcd'));
  assertFalse('Should not end \'abc\'', goog.string.endsWith('abcd', 'abc'));
  assertFalse('Should not end \'abcde\'',
              goog.string.endsWith('abcd', 'abcde'));
}


// === tests for goog.string.caseInsensitiveStartsWith ===
function testCaseInsensitiveStartsWith() {
  assertTrue('Should start with \'\'',
             goog.string.caseInsensitiveStartsWith('abcd', ''));
  assertTrue('Should start with \'ab\'',
             goog.string.caseInsensitiveStartsWith('abcd', 'Ab'));
  assertTrue('Should start with \'abcd\'',
             goog.string.caseInsensitiveStartsWith('AbCd', 'abCd'));
  assertFalse('Should not start with \'bcd\'',
              goog.string.caseInsensitiveStartsWith('ABCD', 'bcd'));
}

// === tests for goog.string.caseInsensitiveEndsWith ===
function testCaseInsensitiveEndsWith() {
  assertTrue('Should end with \'\'',
             goog.string.caseInsensitiveEndsWith('abcd', ''));
  assertTrue('Should end with \'cd\'',
             goog.string.caseInsensitiveEndsWith('abCD', 'cd'));
  assertTrue('Should end with \'abcd\'',
             goog.string.caseInsensitiveEndsWith('abcd', 'abCd'));
  assertFalse('Should not end \'abc\'',
              goog.string.caseInsensitiveEndsWith('aBCd', 'ABc'));
  assertFalse('Should not end \'abcde\'',
              goog.string.caseInsensitiveEndsWith('ABCD', 'abcde'));
}


// === tests for goog.string.subs ===
function testSubs() {
  assertEquals('Should be the same', goog.string.subs('nothing to subs'),
               'nothing to subs');
  assertEquals('Should be the same', goog.string.subs('%s', '1'), '1');
  assertEquals('Should be the same',
               goog.string.subs('%s%s%s', '1', 2, true), '12true');
  function f() {
    assertTrue('This should not be called', false);
  }
  f.toString = function () { return 'f'; };
  assertEquals('Should not call function', goog.string.subs('%s', f), 'f');

  // If the string that is to be substituted in contains $& then it will be
  // usually be replaced with %s, we need to check goog.string.subs, handles
  // this case.
  assertEquals('$& should not be substituted with %s', 'Foo Bar $&',
      goog.string.subs('Foo %s', 'Bar $&'));

  assertEquals('$$ should not be substituted', '_$$_',
               goog.string.subs('%s', '_$$_'));
  assertEquals('$` should not be substituted', '_$`_',
               goog.string.subs('%s', '_$`_'));
  assertEquals('$\' should not be substituted', '_$\'_',
               goog.string.subs('%s', '_$\'_'));
  for (var i = 0; i < 99; i+=9) {
    assertEquals('$' + i + ' should not be substituted',
        '_$' + i + '_', goog.string.subs('%s', '_$' + i + '_'));
  }
}


// === tests for goog.string.caseInsensitiveCompare ===
function testCaseInsensitiveCompare() {
  var f = goog.string.caseInsensitiveCompare;

  assert('"ABC" should be less than "def"', f('ABC', 'def') == -1);
  assert('"abc" should be less than "DEF"', f('abc', 'DEF') == -1);

  assert('"XYZ" should equal "xyz"', f('XYZ', 'xyz') == 0);

  assert('"XYZ" should be greater than "UVW"', f('xyz', 'UVW') == 1);
  assert('"XYZ" should be greater than "uvw"', f('XYZ', 'uvw') == 1);
}


// === tests for goog.string.numerateCompare ===
function testNumerateCompare() {
  var f = goog.string.numerateCompare;

  // Each comparison in this list is tested to assure that t[0] < t[1],
  // t[1] > t[0], and identity tests t[0] == t[0] and t[1] == t[1].
  var comparisons = [
    ['', '0'],
    ['2', '10'],
    ['05', '9'],
    ['3.14', '3.2'],
    ['sub', 'substring'],
    ['Photo 7', 'photo 8'], // Case insensitive for most sorts.
    ['Mango', 'mango'], // Case sensitive if strings are otherwise identical.
    ['album 2 photo 20', 'album 10 photo 20'],
    ['album 7 photo 20', 'album 7 photo 100']];

  for (var i = 0; i < comparisons.length; i++) {
    var t = comparisons[i];
    assert(t[0] + ' should be less than ' + t[1],
           f(t[0], t[1]) < 0);
    assert(t[1] + ' should be greater than ' + t[0],
           f(t[1], t[0]) > 0);
    assert(t[0] + ' should be equal to ' + t[0],
           f(t[0], t[0]) == 0);
    assert(t[1] + ' should be equal to ' + t[1],
           f(t[1], t[1]) == 0);
  }
}

// === tests for goog.string.urlEncode && .urlDecode ===
// NOTE: When test was written it was simply an alias for the built in
// 'encodeURICompoent', therefore this test is simply used to make sure that in
// the future it doesn't get broken.
function testUrlEncodeAndDecode() {
  var input = '<p>"hello there," she said, "what is going on here?</p>';
  var output = '%3Cp%3E%22hello%20there%2C%22%20she%20said%2C%20%22what%20is' +
               '%20going%20on%20here%3F%3C%2Fp%3E';

  assertEquals('urlEncode vs encodeURIComponent',
               encodeURIComponent(input),
               goog.string.urlEncode(input));

  assertEquals('urlEncode vs model', goog.string.urlEncode(input), output);

  assertEquals('urlDecode vs model', goog.string.urlDecode(output), input);

  assertEquals('urlDecode vs urlEncode',
               goog.string.urlDecode(goog.string.urlEncode(input)), input);

  assertEquals('urlDecode with +s instead of %20s',
               goog.string.urlDecode(output.replace(/%20/g, '+')),
               input);
}

function testEncodeOptimizationRegex() {
  assertEquals(0, "foo".search(goog.string.encodeUriRegExp_));
  assertEquals(0, "baby1224".search(goog.string.encodeUriRegExp_));
  assertEquals(0, "_-*!~".search(goog.string.encodeUriRegExp_));
  assertEquals(-1, "%".search(goog.string.encodeUriRegExp_));
  assertEquals(-1, "@".search(goog.string.encodeUriRegExp_));
  assertEquals(-1, "/".search(goog.string.encodeUriRegExp_));
}


// === tests for goog.string.newLineToBr ===
function testNewLineToBr() {
  var str = 'some\nlines\rthat\r\nare\n\nsplit';
  var html = 'some<br>lines<br>that<br>are<br><br>split';
  var xhtml = 'some<br />lines<br />that<br />are<br /><br />split';

  assertEquals('Should be html', goog.string.newLineToBr(str), html);
  assertEquals('Should be html', goog.string.newLineToBr(str, false), html);
  assertEquals('Should be xhtml', goog.string.newLineToBr(str, true), xhtml);

}


// === tests for goog.string.htmlEscape and .unescapeEntities ===
function testHtmlEscapeAndUnescapeEntities() {
  var text = '"x1 < x2 && y2 > y1"';
  var html = '&quot;x1 &lt; x2 &amp;&amp; y2 &gt; y1&quot;';

  assertEquals('Testing htmlEscape', goog.string.htmlEscape(text), html);
  assertEquals('Testing htmlEscape', goog.string.htmlEscape(text, false), html);
  assertEquals('Testing htmlEscape', goog.string.htmlEscape(text, true), html);
  assertEquals('Testing unescapeEntities',
               goog.string.unescapeEntities(html), text);

  assertEquals('escape -> unescape',
               goog.string.unescapeEntities(goog.string.htmlEscape(text)),
               text);
  assertEquals('unescape -> escape',
               goog.string.htmlEscape(goog.string.unescapeEntities(html)),
               html);
}

function testHtmlEscapeAndUnescapeEntitiesUsingDom() {
  var text = '"x1 < x2 && y2 > y1"';
  var html = '&quot;x1 &lt; x2 &amp;&amp; y2 &gt; y1&quot;';

  assertEquals('Testing unescapeEntities',
               goog.string.unescapeEntitiesUsingDom_(html), text);
  assertEquals('escape -> unescape',
               goog.string.unescapeEntitiesUsingDom_(
                   goog.string.htmlEscape(text)), text);
  assertEquals('unescape -> escape',
               goog.string.htmlEscape(
                   goog.string.unescapeEntitiesUsingDom_(html)), html);
}

function testHtmlEscapeAndUnescapePureXmlEntities_() {
  var text = '"x1 < x2 && y2 > y1"';
  var html = '&quot;x1 &lt; x2 &amp;&amp; y2 &gt; y1&quot;';

  assertEquals('Testing unescapePureXmlEntities_',
               goog.string.unescapePureXmlEntities_(html), text);
  assertEquals('escape -> unescape',
               goog.string.unescapePureXmlEntities_(
                   goog.string.htmlEscape(text)), text);
  assertEquals('unescape -> escape',
               goog.string.htmlEscape(
                   goog.string.unescapePureXmlEntities_(html)), html);
}

var globalXssVar = 0;

function testXssUnescapeEntities() {
  // This tests that we don't have any XSS exploits in unescapeEntities
  var test = '&amp;<script defer>globalXssVar=1;</' + 'script>';
  var expected = '&<script defer>globalXssVar=1;</' + 'script>';

  assertEquals('Testing unescapeEntities', expected,
               goog.string.unescapeEntities(test));
  assertEquals('unescapeEntities is vulnarable to XSS', 0, globalXssVar);

  test = '&amp;<script>globalXssVar=1;</' + 'script>';
  expected = '&<script>globalXssVar=1;</' + 'script>';

  assertEquals('Testing unescapeEntities', expected,
               goog.string.unescapeEntities(test));
  assertEquals('unescapeEntities is vulnarable to XSS', 0, globalXssVar);
}


function testXssUnescapeEntitiesUsingDom() {
  // unescapeEntitiesUsingDom_ does not handle XSS issues and
}


function testXssUnescapePureXmlEntities() {
  // This tests that we don't have any XSS exploits in unescapeEntities
  var test = '&amp;<script defer>globalXssVar=1;</' + 'script>';
  var expected = '&<script defer>globalXssVar=1;</' + 'script>';

  assertEquals('Testing unescapePureXmlEntities_', expected,
               goog.string.unescapePureXmlEntities_(test));
  assertEquals('unescapePureXmlEntities_ is vulnarable to XSS', 0,
               globalXssVar);

  test = '&amp;<script>globalXssVar=1;</' + 'script>';
  expected = '&<script>globalXssVar=1;</' + 'script>';

  assertEquals('Testing unescapePureXmlEntities_', expected,
               goog.string.unescapePureXmlEntities_(test));
  assertEquals('unescapePureXmlEntities_ is vulnarable to XSS', 0,
               globalXssVar);
}


function testUnescapeEntitiesPreservesWhitespace() {
  // This tests that whitespace is preserved (primarily for IE)
  // Also make sure leading and trailing whitespace are preserved.
  var test = '\nTesting\n\twhitespace\n    preservation\n';
  var expected = test;

  assertEquals('Testing unescapeEntities', expected,
               goog.string.unescapeEntities(test));

  // Now with entities
  test += ' &amp;&nbsp;\n';
  expected += ' &\u00A0\n';
  assertEquals('Testing unescapeEntities', expected,
               goog.string.unescapeEntities(test));
}


// === tests for goog.string.whitespaceEscape ===
function testWhiteSpaceEscape() {
  assertEquals('Should be the same',
      goog.string.whitespaceEscape('one two  three   four    five     '),
      'one two &#160;three &#160; four &#160; &#160;five &#160; &#160; ');
}



// === tests for goog.string.stripQuotes ===
function testStripQuotes() {
  assertEquals('Quotes should be stripped',
               goog.string.stripQuotes('"hello"', '"'),
               'hello');

  assertEquals('Quotes should be stripped',
               goog.string.stripQuotes('\'hello\'', '\''),
               'hello');

  assertEquals('Quotes should not be stripped',
               goog.string.stripQuotes('-"hello"', '"'),
               '-"hello"');
}

function testStripQuotesMultiple() {
  assertEquals('Quotes should be stripped',
               goog.string.stripQuotes('"hello"', '"\''),
               'hello');
  assertEquals('Quotes should be stripped',
               goog.string.stripQuotes('\'hello\'', '"\''),
               'hello');

  assertEquals('Quotes should be stripped',
               goog.string.stripQuotes('\'hello\'', ''),
               '\'hello\'');
}

function testStripQuotesMultiple2() {
  // Makes sure we do not strip twice
  assertEquals('Quotes should be stripped',
               goog.string.stripQuotes('"\'hello\'"', '"\''),
               '\'hello\'');
  assertEquals('Quotes should be stripped',
               goog.string.stripQuotes('"\'hello\'"', '\'"'),
               '\'hello\'');

}

// === tests for goog.string.truncate ===
function testTruncate() {
  var str = 'abcdefghijklmnopqrstuvwxyz';
  assertEquals('Should be equal', goog.string.truncate(str, 8), 'abcde...');
  assertEquals('Should be equal', goog.string.truncate(str, 11), 'abcdefgh...');

  var html = 'true &amp;&amp; false == false';
  assertEquals('Should clip html char', goog.string.truncate(html, 11),
               'true &am...');
  assertEquals('Should not clip html char',
               goog.string.truncate(html, 12, true),
               'true &amp;&amp; f...');
}


// === tests for goog.string.truncateMiddle ===
function testTruncateMiddle() {
  var str = 'abcdefghijklmnopqrstuvwxyz';
  assertEquals('abc...xyz', goog.string.truncateMiddle(str, 6));
  assertEquals( 'abc...yz', goog.string.truncateMiddle(str, 5));
  assertEquals(str, goog.string.truncateMiddle(str, str.length));

  var html = 'true &amp;&amp; false == false';
  assertEquals('Should clip html char', 'true &a...= false',
      goog.string.truncateMiddle(html, 14));
  assertEquals('Should not clip html char',
      'true &amp;&amp;...= false',
       goog.string.truncateMiddle(html, 14, true));
}


// === goog.string.quote ===
function testQuote() {
  var str = allChars();
  assertEquals(str, eval(goog.string.quote(str)));

  // empty string
  assertEquals('', eval(goog.string.quote('')));

  // unicode
  str = allChars(0, 10000);
  assertEquals(str, eval(goog.string.quote(str)));
}

function testQuoteSpecialChars() {
  assertEquals('"\\""', goog.string.quote('"'));
  assertEquals("\"'\"", goog.string.quote("'"));
  assertEquals("\"\\\\\"", goog.string.quote("\\"));
}

function testCrossBrowserQuote() {
  var oldQuoteFn = String.prototype.quote;
  try {
    // The vertical space char has weird semantics on jscript, so we don't test
    // that one.
    var vertChar = '\x0B'.charCodeAt(0);
    var str = allChars(0, vertChar) + allChars(vertChar + 1, 10000);
    var nativeQuote = goog.string.quote(str);

    String.prototype.quote = null;
    assertNull("".quote);

    assertEquals(nativeQuote, goog.string.quote(str));
  } finally {
    String.prototype.quote = oldQuoteFn;
  }
}

function allChars(opt_start, opt_end) {
  opt_start = opt_start || 0;
  opt_end = opt_end || 256;
  var rv = '';
  for (var i = opt_start; i < opt_end; i++) {
    rv += String.fromCharCode(i);
  }
  return rv;
}

function testEscapeString() {
  var expected = allChars(0, 10000);
  try {
    var actual =
        eval('"' + goog.string.escapeString(expected) + '"');
  } catch (e) {
    fail('Quote failed: err ' + e.message);
  }
  assertEquals(expected, actual);
}

function testRemoveAt() {
  var str = 'barfoobarbazbar';
  str = goog.string.removeAt(str, 0, 3);
  assertEquals('Remove first bar', 'foobarbazbar', str);
  str = goog.string.removeAt(str, 3, 3);
  assertEquals('Remove middle bar', 'foobazbar', str);
  str = goog.string.removeAt(str, 6, 3);
  assertEquals('Remove last bar', 'foobaz', str);
  assertEquals('Invalid negative index', 'foobaz',
      goog.string.removeAt(str, -1, 0));
  assertEquals('Invalid overflow index', 'foobaz',
      goog.string.removeAt(str, 9, 0));
  assertEquals('Invalid negative stringLength', 'foobaz',
      goog.string.removeAt(str, 0, -1));
  assertEquals('Invalid overflow stringLength', '',
      goog.string.removeAt(str, 0, 9));
  assertEquals('Invalid overflow index and stringLength', 'foobaz',
      goog.string.removeAt(str, 9, 9));
  assertEquals('Invalid zero stringLength', 'foobaz',
      goog.string.removeAt(str, 0, 0));
}

function testRemove() {
  var str = 'barfoobarbazbar';
  str = goog.string.remove(str, 'bar');
  assertEquals('Remove first bar', 'foobarbazbar', str);
  str = goog.string.remove(str, 'bar');
  assertEquals('Remove middle bar', 'foobazbar', str);
  str = goog.string.remove(str, 'bar');
  assertEquals('Remove last bar', 'foobaz', str);
  str = goog.string.remove(str, 'bar');
  assertEquals('Original string', 'foobaz', str);
}

function testRemoveAll() {
  var str = 'foobarbazbarfoobazfoo';
  str = goog.string.removeAll(str, 'foo');
  assertEquals('Remove all occurrences of foo', 'barbazbarbaz', str);
  str = goog.string.removeAll(str, 'foo');
  assertEquals('Original string', 'barbazbarbaz', str);
}

function testRegExpEscape() {
  var spec = '()[]{}+-?*.$^|,:#<!\\';
  var escapedSpec = '\\' + spec.split('').join('\\');
  assertEquals('special chars', escapedSpec, goog.string.regExpEscape(spec));
  assertEquals('backslash b', '\\x08', goog.string.regExpEscape('\b'));

  var s = allChars();
  var re = new RegExp('^' + goog.string.regExpEscape(s) + '$');
  assertTrue('All ASCII', re.test(s));
  s = '';
  var re = new RegExp('^' + goog.string.regExpEscape(s) + '$');
  assertTrue('empty string', re.test(s));
  s = allChars(0, 10000);
  var re = new RegExp('^' + goog.string.regExpEscape(s) + '$');
  assertTrue('Unicode', re.test(s));
}

function testPadNumber() {
  assertEquals('01.250', goog.string.padNumber(1.25, 2, 3));
  assertEquals('01.25', goog.string.padNumber(1.25, 2));
  assertEquals('01.3', goog.string.padNumber(1.25, 2, 1));
  assertEquals('1.25', goog.string.padNumber(1.25, 0));
  assertEquals('10', goog.string.padNumber(9.9, 2, 0));
  assertEquals('7', goog.string.padNumber(7, 0));
  assertEquals('7', goog.string.padNumber(7, 1));
  assertEquals('07', goog.string.padNumber(7, 2));
}

function testAsString() {
  assertEquals('', goog.string.makeSafe(null));
  assertEquals('', goog.string.makeSafe(undefined));
  assertEquals('', goog.string.makeSafe(''));

  assertEquals('abc', goog.string.makeSafe('abc'));
  assertEquals('123', goog.string.makeSafe(123));
  assertEquals('0', goog.string.makeSafe(0));

  assertEquals('true', goog.string.makeSafe(true));
  assertEquals('false', goog.string.makeSafe(false));

  var funky = function() {};
  funky.toString = function() { return 'funky-thing' };
  assertEquals('funky-thing', goog.string.makeSafe(funky));
}

function testStringRepeat() {
  assertEquals('', goog.string.repeat('*', 0));
  assertEquals('*', goog.string.repeat('*', 1));
  assertEquals('     ', goog.string.repeat(' ', 5));
  assertEquals('__________', goog.string.repeat('_', 10));
  assertEquals('aaa', goog.string.repeat('a', 3));
  assertEquals('foofoofoofoofoofoo', goog.string.repeat('foo', 6));
}

function testBuildString() {
  assertEquals('', goog.string.buildString());
  assertEquals('a', goog.string.buildString('a'));
  assertEquals('ab', goog.string.buildString('ab'));
  assertEquals('ab', goog.string.buildString('a', 'b'));
  assertEquals('abcd', goog.string.buildString('a', 'b', 'c', 'd'));
  assertEquals('0', goog.string.buildString(0));
  assertEquals('0123', goog.string.buildString(0, 1, 2, 3));
  assertEquals('ab01', goog.string.buildString('a', 'b', 0, 1));
  assertEquals('', goog.string.buildString(null, undefined));
}

function testCompareVersions() {
  var f = goog.string.compareVersions;
  assertTrue('numeric equality broken', f(1, 1) == 0)
  assertTrue('numeric less than broken', f(1.0, 1.1) < 0)
  assertTrue('numeric greater than broken', f(2.0, 1.1) > 0)

  assertTrue('exact equality broken', f('1.0', '1.0') == 0)
  assertTrue('mutlidot equality broken', f('1.0.0.0', '1.0') == 0);
  assertTrue('mutlidigit equality broken', f('1.000', '1.0') == 0);
  assertTrue('less than broken', f('1.0.2.1', '1.1') < 0);
  assertTrue('greater than broken', f('1.1', '1.0.2.1') > 0);

  assertTrue('substring less than broken', f('1', '1.1') < 0)
  assertTrue('substring greater than broken', f('2.2', '2') > 0)

  assertTrue('b greater than broken', f('1.1', '1.1b') > 0);
  assertTrue('b less than broken', f('1.1b', '1.1') < 0);
  assertTrue('b equality broken', f('1.1b', '1.1b') == 0);

  assertTrue('b>a broken', f('1.1b', '1.1a') > 0);
  assertTrue('a<b broken', f('1.1a', '1.1b') < 0);

  assertTrue('9.5<9.10 broken', f('9.5', '9.10') < 0);
  assertTrue('9.5<9.11 broken', f('9.5', '9.11') < 0);
  assertTrue('9.11>9.10 broken', f('9.11', '9.10') > 0);
  assertTrue('9.1<9.10 broken', f('9.1', '9.10') < 0);
  assertTrue('9.1.1<9.10 broken', f('9.1.1', '9.10') < 0);
  assertTrue('9.1.1<9.11 broken', f('9.1.1', '9.11') < 0);

  assertTrue('10a>9b broken', f('1.10a', '1.9b') > 0);
  assertTrue('b<b2 broken', f('1.1b', '1.1b2') < 0);
  assertTrue('b10>b9 broken', f('1.1b10', '1.1b9') > 0);

  assertTrue('7>6 broken with leading whitespace', f(' 7', '6') > 0);
  assertTrue('7>6 broken with trailing whitespace', f('7 ', '6') > 0);
}

function testIsUnicodeChar() {
  assertFalse('empty string broken', goog.string.isUnicodeChar(''));
  assertFalse('non-single char string broken',
              goog.string.isUnicodeChar('abc'));
  assertTrue('space broken', goog.string.isUnicodeChar(' '));
  assertTrue('single char broken', goog.string.isUnicodeChar('a'));
  assertTrue('upper case broken', goog.string.isUnicodeChar('A'));
  assertTrue('unicode char broken', goog.string.isUnicodeChar('\u0C07'));
}

function assertHashcodeEquals(expectedHashCode, str) {
  assertEquals('wrong hashCode for ' + str.substring(0, 32),
      expectedHashCode, goog.string.hashCode(str));
}

/**
 * Verify we get random-ish looking values for hash of Strings.
 */
function testHashCode() {
  try {
    goog.string.hashCode(null);
    fail('should throw exception for null');
  } catch (ex) {
    // success
  }
  assertHashcodeEquals(0, '');
  assertHashcodeEquals(101574, 'foo');
  assertHashcodeEquals(1301670364, '\uAAAAfoo');
  assertHashcodeEquals(92567585, goog.string.repeat('a', 5));
  assertHashcodeEquals(2869595232, goog.string.repeat('a', 6));
  assertHashcodeEquals(3058106369, goog.string.repeat('a', 7));
  assertHashcodeEquals(312017024, goog.string.repeat('a', 8));
  assertHashcodeEquals(2929737728, goog.string.repeat('a', 1024));
}

function testUniqueString() {
  var TEST_COUNT = 20;

  var obj = {};
  for (var i = 0; i < TEST_COUNT; i++) {
    obj[goog.string.createUniqueString()] = true;
  }

  assertEquals('All strings should be unique.', TEST_COUNT,
      goog.object.getCount(obj));
}

function testToNumber() {
  // First, test the cases goog.string.toNumber() was primarily written for,
  // because JS built-ins are dumb.
  assertNaN(goog.string.toNumber('123a'));
  assertNaN(goog.string.toNumber('123.456.78'));
  assertNaN(goog.string.toNumber(''));
  assertNaN(goog.string.toNumber(' '));

  // Now, sanity-check.
  assertEquals(123, goog.string.toNumber(' 123 '));
  assertEquals(321.123, goog.string.toNumber('321.123'));
  assertEquals(1.00001, goog.string.toNumber('1.00001'));
  assertEquals(1, goog.string.toNumber('1.00000'));
  assertEquals(0.2, goog.string.toNumber('0.20'));
  assertEquals(0, goog.string.toNumber('0'));
  assertEquals(0, goog.string.toNumber('0.0'));
  assertEquals(-1, goog.string.toNumber('-1'));
  assertEquals(-0.3, goog.string.toNumber('-.3'));
  assertEquals(-12.345, goog.string.toNumber('-12.345'));
  assertEquals(100, goog.string.toNumber('1e2'));
  assertEquals(0.123, goog.string.toNumber('12.3e-2'));
  assertNaN(goog.string.toNumber('abc'));
}

function testGetRandomString() {
  stubs.set(goog, 'now', goog.functions.constant(1295726605874));
  stubs.set(Math, 'random', goog.functions.constant(0.6679361383522245));
  assertTrue('String must be alphanumeric',
             goog.string.isAlphaNumeric(goog.string.getRandomString()));
}

function testToCamelCase() {
  assertEquals('OneTwoThree', goog.string.toCamelCase('-one-two-three'));
  assertEquals('oneTwoThree', goog.string.toCamelCase('one-two-three'));
  assertEquals('oneTwo', goog.string.toCamelCase('one-two'));
  assertEquals('one', goog.string.toCamelCase('one'));
  assertEquals('oneTwo', goog.string.toCamelCase('oneTwo'));
}

function testToSelectorCase() {
  assertEquals('-one-two-three', goog.string.toSelectorCase('OneTwoThree'));
  assertEquals('one-two-three',goog.string.toSelectorCase('oneTwoThree'));
  assertEquals('one-two', goog.string.toSelectorCase('oneTwo'));
  assertEquals('one', goog.string.toSelectorCase('one'));
  assertEquals('one-two', goog.string.toSelectorCase('one-two'));
}

">57 of 57 tests run in 90ms.<br />52 passed, 5 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testHtmlEscapeAndUnescapeEntities<br />Object #<Object> has no method 'createElement'<br />ERROR in testHtmlEscapeAndUnescapeEntitiesUsingDom<br />Object #<Object> has no method 'createElement'<br />ERROR in testTruncate<br />Object #<Object> has no method 'createElement'<br />ERROR in testTruncateMiddle<br />Object #<Object> has no method 'createElement'<br />ERROR in testUnescapeEntitiesPreservesWhitespace<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>stringbuffer_test.html</td><td>Success</td><td> 6 passed, 0 failed.</td><td title="

  goog.require('goog.string.StringBuffer');
  goog.require('goog.testing.jsunit');



function testStringBuffer() {
  var sb = new goog.string.StringBuffer();
  sb.append('Four score');
  sb.append(' ');
  sb.append('and seven years ago.');
  assertEquals('Test 1', 'Four score and seven years ago.', sb.toString());

  sb.clear();
  assertEquals('Test 2', '', sb.toString());

  sb = new goog.string.StringBuffer('Four score ');
  sb.append('and seven years ago.');
  assertEquals('Test 3', 'Four score and seven years ago.', sb.toString());

  // can pass in non-Strings?
  sb = new goog.string.StringBuffer(1);
  sb.append(2);
  assertEquals('Test 4', '12', sb.toString());
}


function testStringBufferSet() {
  var sb = new goog.string.StringBuffer('foo');
  sb.set('bar');
  assertEquals('Test 1', 'bar', sb.toString());
}


function testStringBufferMultiAppend() {
  var sb = new goog.string.StringBuffer('hey', 'foo');
  sb.append('bar', 'baz');
  assertEquals('Test 1', 'heyfoobarbaz', sb.toString());

  sb = new goog.string.StringBuffer();
  sb.append(1, 2);
  // should not add up to '3'
  assertEquals('Test 2', '12', sb.toString());
}


function testStringBufferToString() {
  var sb = new goog.string.StringBuffer('foo', 'bar');
  assertEquals('Test 1', 'foobar', sb.toString());
}


function testStringBufferWithFalseFirstArgument() {
  var sb = new goog.string.StringBuffer(0, 'more');
  assertEquals('Test 1', '0more', sb.toString());

  sb = new goog.string.StringBuffer(false, 'more');
  assertEquals('Test 2', 'falsemore', sb.toString());

  sb = new goog.string.StringBuffer('', 'more');
  assertEquals('Test 3', 'more', sb.toString());

  sb = new goog.string.StringBuffer(null, 'more');
  assertEquals('Test 4', '', sb.toString());

  sb = new goog.string.StringBuffer(undefined, 'more');
  assertEquals('Test 5', '', sb.toString());
}


function testStringBufferGetLength() {
  var sb = new goog.string.StringBuffer();
  assertEquals(0, sb.getLength());

  sb.append('foo');
  assertEquals(3, sb.getLength());

  sb.append('baroo');
  assertEquals(8, sb.getLength());

  sb.clear();
  assertEquals(0, sb.getLength());
}

">n/a</td></tr>
<tr><td>stringformat_test.html</td><td>Success</td><td> 12 passed, 0 failed.</td><td title="

  goog.require('goog.testing.jsunit');
  goog.require('goog.string.format');



// The discussion on naming this functionality is going on.
var f = goog.string.format;

function testImmediateFormatSpecifier() {
  assertEquals('Empty String', '', f(''));
  assertEquals('Immediate Value', 'Immediate Value', f('Immediate Value'));
}

function testPercentSign() {
  assertEquals('%', '%', f('%'));
  assertEquals('%%', '%', f('%%'));
  assertEquals('%%%', '%%', f('%%%'));
  assertEquals('%%%%', '%%', f('%%%%'));

  assertEquals('width of the percent sign ???', '%%', f('%345%%-67.987%'));
}

function testStringConversionSpecifier() {
  assertEquals('%s', 'abc', f('%s', 'abc'));
  assertEquals('%2s', 'abc', f('%2s', 'abc'));
  assertEquals('%6s', '   abc', f('%6s', 'abc'));
  assertEquals('%-6s', 'abc   ', f('%-6s', 'abc'));
}

function testFloatConversionSpecifier() {
  assertEquals('%f', '123', f('%f', 123));
  assertEquals('%f', '0.1', f('%f', 0.1));
  assertEquals('%f', '123.456', f('%f', 123.456));

  // Precisions, paddings and other flags are handled on a flag to flag basis.

}

function testAliasedConversionSpecifiers() {
  assertEquals('%i vs. %d', f('%i', 123), f('%d', 123));
  assertEquals('%u vs. %d', f('%u', 123), f('%d', 123));
}

function testIntegerConversion() {
  assertEquals('%d', '0', f('%d', 0));

  assertEquals('%d', '123', f('%d', 123));
  assertEquals('%d', '0', f('%d', 0.1));
  assertEquals('%d', '0', f('%d', 0.9));
  assertEquals('%d', '123', f('%d', 123.456));

  assertEquals('%d', '-1', f('%d', -1));
  assertEquals('%d', '0', f('%d', -0.1));
  assertEquals('%d', '0', f('%d', -0.9));
  assertEquals('%d', '-123', f('%d', -123.456));

  // Precisions, paddings and other flags are handled on a flag to flag basis.

}

function testSpaceFlag() {
  assertEquals('zero %+d ', ' 0', f('% d', 0));

  assertEquals('positive % d ', ' 123', f('% d', 123));
  assertEquals('negative % d ', '-123', f('% d', -123));

  assertEquals('positive % 3d', ' 123', f('% 3d', 123));
  assertEquals('negative % 3d', '-123', f('% 3d', -123));

  assertEquals('positive % 4d', ' 123', f('% 4d', 123));
  assertEquals('negative % 4d', '-123', f('% 4d', -123));

  assertEquals('positive % 6d', '   123', f('% 6d', 123));
  assertEquals('negative % 6d', '-  123', f('% 6d', -123));

  assertEquals('positive % f ', ' 123.456', f('% f', 123.456));
  assertEquals('negative % f ', '-123.456', f('% f', -123.456));

  assertEquals('positive % .2f ', ' 123.46', f('% .2f', 123.456));
  assertEquals('negative % .2f ', '-123.46', f('% .2f', -123.456));

  assertEquals('positive % 6.2f', ' 123.46', f('% 6.2f', 123.456));
  assertEquals('negative % 6.2f', '-123.46', f('% 6.2f', -123.456));

  assertEquals('positive % 7.2f', ' 123.46', f('% 7.2f', 123.456));
  assertEquals('negative % 7.2f', '-123.46', f('% 7.2f', -123.456));

  assertEquals('positive % 10.2f', '    123.46', f('% 10.2f', 123.456));
  assertEquals('negative % 10.2f', '-   123.46', f('% 10.2f', -123.456));

  assertEquals('string % s ', 'abc', f('% s', 'abc'));
  assertEquals('string % 3s', 'abc', f('% 3s', 'abc'));
  assertEquals('string % 4s', ' abc', f('% 4s', 'abc'));
  assertEquals('string % 6s', '   abc', f('% 6s', 'abc'));
}

function testPlusFlag() {
  assertEquals('zero %+d ', '+0', f('%+d', 0));

  assertEquals('positive %+d ', '+123', f('%+d', 123));
  assertEquals('negative %+d ', '-123', f('%+d', -123));

  assertEquals('positive %+3d', '+123', f('%+3d', 123));
  assertEquals('negative %+3d', '-123', f('%+3d', -123));

  assertEquals('positive %+4d', '+123', f('%+4d', 123));
  assertEquals('negative %+4d', '-123', f('%+4d', -123));

  assertEquals('positive %+6d', '+  123', f('%+6d', 123));
  assertEquals('negative %+6d', '-  123', f('%+6d', -123));

  assertEquals('positive %+f ', '+123.456', f('%+f', 123.456));
  assertEquals('negative %+f ', '-123.456', f('%+f', -123.456));

  assertEquals('positive %+.2f ', '+123.46', f('%+.2f', 123.456));
  assertEquals('negative %+.2f ', '-123.46', f('%+.2f', -123.456));

  assertEquals('positive %+6.2f', '+123.46', f('%+6.2f', 123.456));
  assertEquals('negative %+6.2f', '-123.46', f('%+6.2f', -123.456));

  assertEquals('positive %+7.2f', '+123.46', f('%+7.2f', 123.456));
  assertEquals('negative %+7.2f', '-123.46', f('%+7.2f', -123.456));

  assertEquals('positive %+10.2f', '+   123.46', f('%+10.2f', 123.456));
  assertEquals('negative %+10.2f', '-   123.46', f('%+10.2f', -123.456));

  assertEquals('string %+s ', 'abc', f('%+s', 'abc'));
  assertEquals('string %+3s', 'abc', f('%+3s', 'abc'));
  assertEquals('string %+4s', ' abc', f('%+4s', 'abc'));
  assertEquals('string %+6s', '   abc', f('%+6s', 'abc'));
}

function testPrecision() {
  assertEquals('%.5d', '0', f('%.5d', 0));

  assertEquals('%d', '123', f('%d', 123.456));
  assertEquals('%.2d', '123', f('%.2d', 123.456));

  assertEquals('%f', '123.456', f('%f', 123.456));
  assertEquals('%.2f', '123.46', f('%.2f', 123.456));

  assertEquals('%.3f', '123.456', f('%.3f', 123.456));
  assertEquals('%.6f', '123.456000', f('%.6f', 123.456));
  assertEquals('%1.2f', '123.46', f('%1.2f', 123.456));
  assertEquals('%7.2f', ' 123.46', f('%7.2f', 123.456));

  assertEquals('%5.6f', '123.456000', f('%5.6f', 123.456));
  assertEquals('%11.6f', ' 123.456000', f('%11.6f', 123.456));

  assertEquals('%07.2f', '0123.46', f('%07.2f', 123.456));
  assertEquals('%+7.2f', '+123.46', f('%+7.2f', 123.456));
}

function testZeroFlag() {
  assertEquals('%0s', 'abc', f('%0s', 'abc'));
  assertEquals('%02s', 'abc', f('%02s', 'abc'));
  assertEquals('%06s', '   abc', f('%06s', 'abc'));

  assertEquals('%0d', '123', f('%0d', 123));
  assertEquals('%0d', '-123', f('%0d', -123));
  assertEquals('%06d', '000123', f('%06d', 123));
  assertEquals('%06d', '-00123', f('%06d', -123));
  assertEquals('%010d', '0000000123', f('%010d', 123));
  assertEquals('%010d', '-000000123', f('%010d', -123));
}

function testFlagMinus() {
  assertEquals('%-s', 'abc', f('%-s', 'abc'));
  assertEquals('%-2s', 'abc', f('%-2s', 'abc'));
  assertEquals('%-6s', 'abc   ', f('%-6s', 'abc'));

  assertEquals('%-d', '123', f('%-d', 123));
  assertEquals('%-d', '-123', f('%-d', -123));
  assertEquals('%-2d', '123', f('%-2d', 123));
  assertEquals('%-2d', '-123', f('%-2d', -123));
  assertEquals('%-4d', '123 ', f('%-4d', 123));
  assertEquals('%-4d', '-123', f('%-4d', -123));

  assertEquals('%-d', '123', f('%-0d', 123));
  assertEquals('%-d', '-123', f('%-0d', -123));
  assertEquals('%-4d', '123 ', f('%-04d', 123));
  assertEquals('%-4d', '-123', f('%-04d', -123));
}

function testExceptions() {
  var e = assertThrows(goog.partial(f, '%f%f', 123.456));
  assertEquals('[goog.string.format] Not enough arguments', e.message);

  e = assertThrows(f);
  assertEquals('[goog.string.format] Template required', e.message);
}

">n/a</td></tr>
<tr><td>base_test.html</td><td>Fail</td><td> undefined</td><td title="

goog.require('goog.functions');
// Used to test dynamic loading works, see testRequire*
goog.require('goog.Timer');
goog.require('goog.testing.jsunit');
goog.require('goog.testing.PropertyReplacer');
goog.require('goog.userAgent');



function getFramedVars(name) {
  var w = window.frames[name];
  var doc = w.document;
  doc.open();
  doc.write('<script>' +
            'var a = [0, 1, 2];' +
            'var o = {a: 0, b: 1};' +
            'var n = 42;' +
            'var b = true;' +
            'var s = "string";' +
            'var nv = null;' +
            'var u = undefined;' +
            'var fv = function(){};' +
            '</' + 'script>')
  doc.close();
  return {
    'array': w.a,
    'object': w.o,
    'number': w.n,
    'boolean': w.b,
    'string': w.s,
    'functionVar': w.fv,
    'nullVar': w.nv,
    'undefinedVar': w.u
  };
}

var framedVars = getFramedVars('f1');
var framedVars2 = getFramedVars('f2');
// remove iframe
var iframeElement = document.getElementById('f2');
iframeElement.parentNode.removeChild(iframeElement);




var stubs = new goog.testing.PropertyReplacer();
var originalGoogBind = goog.bind;

function tearDown() {
  goog.setCssNameMapping(undefined);
  stubs.reset();
  goog.bind = originalGoogBind;
}

function testLibrary() {
  assertNotUndefined("'goog' not loaded", goog);
}

function testProvide() {
  goog.provide('goog.test.name.space');
  assertNotUndefined('provide failed: goog.test', goog.test);
  assertNotUndefined('provide failed: goog.test.name', goog.test.name);
  assertNotUndefined('provide failed: goog.test.name.space',
      goog.test.name.space);

  // ensure that providing 'goog.test.name' doesn't throw an exception
  goog.provide('goog.test');
  goog.provide('goog.test.name');

  delete goog.test;
}

function testProvideStrictness() {
  goog.provide('goog.xy');
  assertProvideFails('goog.xy');

  window['goog']['xyz'] = 'Bob';
  assertProvideFails('goog.xyz');

  delete goog.xy;
  delete goog.xyz;
}

function assertProvideFails(namespace) {
  assertThrows('goog.provide(' + namespace + ') should have failed',
      goog.partial(goog.provide, namespace));
}

function testGlobalize() {
  goog.globalize(goog);
  assertNotUndefined('Globalize goog', provide);

  var a = {a: 1, b: 2, c: 3};
  var b = {};
  goog.globalize(a, b);
  assertNotUndefined('Globalize to arbitrary object', b.a);
  assertNotUndefined('Globalize to arbitrary object', b.b);
  assertNotUndefined('Globalize to arbitrary object', b.c);
}

function testExportSymbol() {
  var date = new Date();

  assertTrue(typeof nodots == 'undefined');
  goog.exportSymbol('nodots', date);
  assertEquals(date, nodots);
  nodots = undefined;

  assertTrue(typeof gotcher == 'undefined');
  goog.exportSymbol('gotcher.dots.right.Here', date);
  assertEquals(date, gotcher.dots.right.Here);
  gotcher = undefined;

  goog.provide('an.existing.path');
  assertNotNull(an.existing.path);
  goog.exportSymbol('an.existing.path', date);
  assertEquals(date, an.existing.path);
  an = undefined;

  var foo = {foo: 'foo'};
  var bar = {bar: 'bar'};
  var baz = {baz: 'baz'};
  goog.exportSymbol('one.two.three.Four', foo);
  goog.exportSymbol('one.two.three.five', bar);
  goog.exportSymbol('one.two.six', baz);
  assertEquals(foo, one.two.three.Four);
  assertEquals(bar, one.two.three.five);
  assertEquals(baz, one.two.six);

  var win = {};
  var fooBar = {foo: 'foo', bar: 'bar'};
  goog.exportSymbol('one.two.four', fooBar, win);
  assertEquals(fooBar, win.one.two.four);
  assertTrue('four' in win.one.two);
  assertFalse('four' in one.two);
  one = undefined;
}

goog.exportSymbol('exceptionTest', function() {
  throw Error('ERROR');
});

function testExportSymbolExceptions() {
  var e = assertThrows('Exception wasn\'t thrown by exported function',
      exceptionTest);
  assertEquals('Unexpected error thrown', 'ERROR', e.message);
}

//=== tests for Require logic ===

function testRequireClosure() {
  assertNotUndefined('goog.Timer should be available', goog.Timer);
  assertNotUndefined('goog.events.EventTarget should be available', goog.events.EventTarget);
}


//=== tests for language enhancements ===

function testTypeOf() {
  assertEquals('array', goog.typeOf([]));
  assertEquals('string', goog.typeOf('string'));
  assertEquals('number', goog.typeOf(123));
  assertEquals('null', goog.typeOf(null));
  assertEquals('undefined', goog.typeOf(undefined));
  assertEquals('object', goog.typeOf({}));
  assertEquals('function', goog.typeOf(function(){}));

  // Make sure that NodeList is not treated as an array... NodeLists should
  // be of type object but Safari incorrectly reports it as function so a not
  // equals test will have to suffice here.
  assertNotEquals('array', goog.typeOf(document.getElementsByName('*')));
  assertNotEquals('function', goog.typeOf(document.getElementsByName('*')));
  assertEquals('object', goog.typeOf(document.getElementsByName('*')));
}

function testTypeOfFramed() {
  assertEquals('array', goog.typeOf(framedVars.array));
  assertEquals('string', goog.typeOf(framedVars.string));
  assertEquals('number', goog.typeOf(framedVars.number));
  assertEquals('null', goog.typeOf(framedVars.nullVar));
  assertEquals('undefined', goog.typeOf(framedVars.undefinedVar));
  assertEquals('object', goog.typeOf(framedVars.object));
  assertEquals('function', goog.typeOf(framedVars.functionVar));

  // Opera throws when trying to do cross frame typeof on node lists.
  // IE behaves very strange when it comes to DOM nodes on disconnected frames.
}

function testTypeOfFramed2() {
  assertEquals('array', goog.typeOf(framedVars2.array));
  assertEquals('string', goog.typeOf(framedVars2.string));
  assertEquals('number', goog.typeOf(framedVars2.number));
  assertEquals('null', goog.typeOf(framedVars2.nullVar));
  assertEquals('undefined', goog.typeOf(framedVars2.undefinedVar));
  assertEquals('object', goog.typeOf(framedVars2.object));
  assertEquals('function', goog.typeOf(framedVars2.functionVar));

  // Opera throws when trying to do cross frame typeof on node lists.
  // IE behaves very strange when it comes to DOM nodes on disconnected frames.
}

function testIsDef() {
  var defined = 'foo';
  var nullVar = null;
  var notDefined;

  assertTrue('defined should be defined', goog.isDef(defined));
  assertTrue('null should be defined', goog.isDef(defined));
  assertFalse('undefined should not be defined', goog.isDef(notDefined));
}

function testIsDefAndNotNull() {
  assertTrue('string is defined and non-null', goog.isDefAndNotNull(''));
  assertTrue('object is defined and non-null', goog.isDefAndNotNull({}));
  assertTrue('function is defined and non-null',
      goog.isDefAndNotNull(goog.nullFunction));
  assertTrue('zero is defined and non-null',
      goog.isDefAndNotNull(0));
  assertFalse('null', goog.isDefAndNotNull(null));
  assertFalse('undefined', goog.isDefAndNotNull(undefined));
}

function testIsNull() {
  var notNull = 'foo';
  var nullVar = null;
  var notDefined;

  assertFalse('defined should not be null', goog.isNull(notNull));
  assertTrue('null should be null', goog.isNull(nullVar));
  assertFalse('undefined should not be null', goog.isNull(notDefined))
}

function testIsArray() {
  var array = [1, 2, 3];
  var arrayWithLengthSet = [1, 2, 3];
  arrayWithLengthSet.length = 2;
  var objWithArrayFunctions = {slice: function() {}, length: 0};
  var object = {a: 1, b: 2, c: 3};
  var nullVar = null;
  var notDefined;
  var elem = document.getElementById('elem');
  var text = document.getElementById('text').firstChild;
  var impostor = document.body.getElementsByTagName('BOGUS');
  impostor.push = Array.prototype.push;
  impostor.pop = Array.prototype.pop;
  impostor.slice = Array.prototype.slice;
  impostor.splice = Array.prototype.splice;

  assertTrue('array should be an array', goog.isArray(array));
  assertTrue('arrayWithLengthSet should be an array',
             goog.isArray(arrayWithLengthSet));
  assertFalse('object with array functions should not be an array unless ' +
              'length is not enumerable', goog.isArray(objWithArrayFunctions));
  assertFalse('object should not be an array', goog.isArray(object));
  assertFalse('null should not be an array', goog.isArray(nullVar));
  assertFalse('undefined should not be an array', goog.isArray(notDefined));
  assertFalse('NodeList should not be an array', goog.isArray(elem.childNodes));
  assertFalse('TextNode should not be an array', goog.isArray(text));
  assertTrue('Array of nodes should be an array',
             goog.isArray([elem.firstChild, elem.lastChild]));
  assertFalse('An impostor should not be an array', goog.isArray(impostor));
}

function testTypeOfAcrossWindow() {
  if (goog.userAgent.WEBKIT && goog.userAgent.MAC) {
    // The server farm has issues with new windows on Safari Mac.
    return;
  }

  var w = window.open('', 'blank');
  if (w) {
    try {
      try {
        var d = w.document;
        d.open();
        d.write('<script>function fun(){};' +
                'var arr = [];' +
                'var x = 42;' +
                'var s = "";' +
                'var b = true;' +
                'var obj = {length: 0, splice: {}, call: {}};' +
                '</' + 'script>');
        d.close();
      } catch (ex) {
        // In Firefox Linux on the server farm we don't have access to
        // w.document.
        return;
      }

      assertEquals('function', goog.typeOf(w.fun));
      assertEquals('array', goog.typeOf(w.arr));
      assertEquals('number', goog.typeOf(w.x));
      assertEquals('string', goog.typeOf(w.s));
      assertEquals('boolean', goog.typeOf(w.b));
      assertEquals('object', goog.typeOf(w.obj));
    } finally {
      w.close();
    }
  }
}

function testIsArrayLike() {
  var array = [1, 2, 3];
  var objectWithNumericLength = {length: 2};
  var objectWithNonNumericLength = {length: 'a'};
  var object = {a: 1, b: 2};
  var nullVar = null;
  var notDefined;
  var elem = document.getElementById('elem');
  var text = document.getElementById('text').firstChild;

  assertTrue('array should be array-like', goog.isArrayLike(array));
  assertTrue('obj w/numeric length should be array-like',
      goog.isArrayLike(objectWithNumericLength));
  assertFalse('obj w/non-numeric length should not be array-like',
      goog.isArrayLike(objectWithNonNumericLength));
  assertFalse('object should not be array-like', goog.isArrayLike(object));
  assertFalse('null should not be array-like', goog.isArrayLike(nullVar));
  assertFalse('undefined should not be array-like',
      goog.isArrayLike(notDefined));
  assertTrue('NodeList should be array-like',
      goog.isArrayLike(elem.childNodes));
  // TODO(user): Fix isArrayLike to return false for text nodes!
  // assertFalse('TextNode should not be array-like', goog.isArrayLike(text));
  assertTrue('Array of nodes should be array-like',
      goog.isArrayLike([elem.firstChild, elem.lastChild]));
}


// Use mock date in testIsDateLike() rather than a real goog.date.Date to
// minimize dependencies in this unit test.
function MockGoogDate() {}

MockGoogDate.prototype.getFullYear = function() {
  return 2007;
};


function testIsDateLike() {
  var jsDate = new Date();
  var googDate = new MockGoogDate();
  var string = 'foo';
  var number = 1;
  var nullVar = null;
  var notDefined;

  assertTrue('js Date should be date-like', goog.isDateLike(jsDate));
  assertTrue('goog Date should be date-like', goog.isDateLike(googDate));
  assertFalse('string should not be date-like', goog.isDateLike(string));
  assertFalse('number should not be date-like', goog.isDateLike(number));
  assertFalse('nullVar should not be date-like', goog.isDateLike(nullVar));
  assertFalse('undefined should not be date-like', goog.isDateLike(notDefined));
}

function testIsString() {
  var string = 'foo';
  var number = 2;
  var nullVar = null;
  var notDefined;

  assertTrue('string should be a string', goog.isString(string));
  assertFalse('number should not be a string', goog.isString(number));
  assertFalse('null should not be a string', goog.isString(nullVar));
  assertFalse('undefined should not be a string', goog.isString(notDefined));
}

function testIsBoolean() {
  var b = true;
  var s = 'true';
  var num = 1;
  var nullVar = null;
  var notDefined;

  assertTrue('boolean should be a boolean', goog.isBoolean(b));
  assertFalse('string should not be a boolean', goog.isBoolean(s));
  assertFalse('number should not be a boolean', goog.isBoolean(num));
  assertFalse('null should not be a boolean', goog.isBoolean(nullVar));
  assertFalse('undefined should not be a boolean', goog.isBoolean(notDefined));
}

function testIsNumber() {
  var number = 1;
  var string = '1';
  var nullVar = null;
  var notDefined;

  assertTrue('number should be a number', goog.isNumber(number));
  assertFalse('string should not be a number', goog.isNumber(string));
  assertFalse('null should not be a number', goog.isNumber(nullVar));
  assertFalse('undefined should not be a number', goog.isNumber(notDefined));
}

function testIsFunction() {
  var func = function() { return 1; };
  var object = {a: 1, b: 2};
  var nullVar = null;
  var notDefined;

  assertTrue('function should be a function', goog.isFunction(func));
  assertFalse('object should not be a function', goog.isFunction(object));
  assertFalse('null should not be a function', goog.isFunction(nullVar));
  assertFalse('undefined should not be a function', goog.isFunction(notDefined));
}

function testIsObject() {
  var object = {a: 1, b: 2};
  var string = 'b';
  var nullVar = null;
  var notDefined;
  var array = [0, 1, 2];
  var fun = function() {};

  assertTrue('object should be an object', goog.isObject(object));
  assertTrue('array should be an object', goog.isObject(array));
  assertTrue('function should be an object', goog.isObject(fun));
  assertFalse('string should not be an object', goog.isObject(string));
  assertFalse('null should not be an object', goog.isObject(nullVar));
  assertFalse('undefined should not be an object', goog.isObject(notDefined));
}


//=== tests for unique ID methods ===

function testGetUid() {
  var a = {};
  var b = {};
  var c = {};

  var uid1 = goog.getUid(a);
  var uid2 = goog.getUid(b);
  var uid3 = goog.getUid(c);

  assertNotEquals('Unique IDs must be unique', uid1, uid2);
  assertNotEquals('Unique IDs must be unique', uid1, uid3);
  assertNotEquals('Unique IDs must be unique', uid2, uid3);
}

function testRemoveUidFromPlainObject() {
  var a = {};
  var uid = goog.getUid(a);
  goog.removeUid(a);
  assertNotEquals("An object's old and new unique IDs should be different",
      uid, goog.getUid(a));
}

function testRemoveUidFromObjectWithoutUid() {
  var a = {};
  // Removing a unique ID should not fail even if it did not exist
  goog.removeUid(a);
}

function testRemoveUidFromNode() {
  var node = document.createElement('div');
  var nodeUid = goog.getUid(node);
  goog.removeUid(node);
  assertNotEquals("A node's old and new unique IDs should be different",
      nodeUid, goog.getUid(node));
}

function testConstructorUid() {
  function BaseClass() {};
  function SubClass() {};
  goog.inherits(SubClass, BaseClass);

  var baseClassUid = goog.getUid(BaseClass);
  var subClassUid = goog.getUid(SubClass);

  assertTrue('Unique ID of BaseClass must be a number',
      typeof baseClassUid == 'number');
  assertTrue('Unique ID of SubClass must be a number',
      typeof subClassUid == 'number');
  assertNotEquals('Unique IDs of BaseClass and SubClass must differ',
      baseClassUid, subClassUid);
  assertNotEquals('Unique IDs of BaseClass and SubClass instances must differ',
      goog.getUid(new BaseClass), goog.getUid(new SubClass));

  assertEquals('Unique IDs of BaseClass.prototype and SubClass.prototype ' +
      'should differ, but to keep the implementation simple, we do not ' +
      'handle this edge case.',
      goog.getUid(BaseClass.prototype), goog.getUid(SubClass.prototype));
}

/**
 * Tests against Chrome bug where the re-created element will have the uid
 * property set but undefined. See bug 1252508.
 */
function testUidNotUndefinedOnReusedElement() {
  var div = document.createElement('DIV');
  document.body.appendChild(div);
  div.innerHTML = '<form id="form"></form>';
  var span = div.getElementsByTagName('FORM')[0];
  goog.getUid(span);

  div.innerHTML = '<form id="form"></form>';
  var span2 = div.getElementsByTagName('FORM')[0];
  assertNotUndefined(goog.getUid(span2));
}

function testWindowUid() {
  var uid = goog.getUid(window);
  assertTrue('window unique id is a number', goog.isNumber(uid));
  assertEquals('returns the same id second time', uid, goog.getUid(window));
  goog.removeUid(window);
  assertNotEquals('generates new id after the old one is removed',
      goog.getUid(window));
}

//=== tests for clone method ===

function testClonePrimitive() {
  assertEquals('cloning a primitive should return an equal primitive',
      5, goog.cloneObject(5));
}

function testCloneObjectThatHasACloneMethod() {
  var original = {
    name: 'original',
    clone: function() { return { name: 'clone' } }
  };

  var clone = goog.cloneObject(original);
  assertEquals('original', original.name);
  assertEquals('clone', clone.name);
}

function testCloneFlatObject() {
  var original = {a:1, b:2, c:3};
  var clone = goog.cloneObject(original);
  assertNotEquals(original, clone);
  assertEquals(1, clone.a);
  assertEquals(2, clone.b);
  assertEquals(3, clone.c);
}

function testCloneDeepObject() {
  var original = {
    a: 1,
    b: {c: 2, d: 3},
    e: {f: {g: 4, h: 5}}
  };
  var clone = goog.cloneObject(original);

  assertNotEquals(original, clone);
  assertNotEquals(original.b, clone.b);
  assertNotEquals(original.e, clone.e);

  assertEquals(1, clone.a);
  assertEquals(2, clone.b.c);
  assertEquals(3, clone.b.d);
  assertEquals(4, clone.e.f.g);
  assertEquals(5, clone.e.f.h);
}

function testCloneFunctions() {
  var original = {
    f: function() {
      return 'hi';
    }
  };
  var clone = goog.cloneObject(original);

  assertNotEquals(original, clone);
  assertEquals('hi', clone.f());
  assertEquals(original.f, clone.f);
}


//=== tests for bind() and friends ===

// Function.prototype.bind and Function.prototype.partial are purposefullly
// not defined in open sourced Closure.  These functions sniff for their
// presence.

var foo = 'global';
var obj = {foo: 'obj'};

function getFoo(arg1, arg2) {
  return {foo: this.foo, arg1: arg1, arg2: arg2};
}

function testBindWithoutObj() {
  if (Function.prototype.bind) {
    assertEquals(foo, getFoo.bind()().foo);
  }
}

function testBindWithObj() {
  if (Function.prototype.bind) {
    assertEquals(obj.foo, getFoo.bind(obj)().foo);
  }
}

function testBindWithNullObj() {
  if (Function.prototype.bind) {
    assertEquals(foo, getFoo.bind()().foo);
  }
}

function testBindStaticArgs() {
  if (Function.prototype.bind) {
    var fooprime = getFoo.bind(obj, 'hot', 'dog');
    var res = fooprime();
    assertEquals(obj.foo, res.foo);
    assertEquals('hot', res.arg1);
    assertEquals('dog', res.arg2);
  }
}

function testBindDynArgs() {
  if (Function.prototype.bind) {
    var res = getFoo.bind(obj)('hot', 'dog');
    assertEquals(obj.foo, res.foo);
    assertEquals('hot', res.arg1);
    assertEquals('dog', res.arg2);
  }
}

function testBindCurriedArgs() {
  if (Function.prototype.bind) {
    var res = getFoo.bind(obj, 'hot')('dog');
    assertEquals(obj.foo, res.foo);
    assertEquals('hot', res.arg1);
    assertEquals('dog', res.arg2);
  }
}

function testBindDoubleBind() {
  var getFooP = goog.bind(getFoo, obj, 'hot');
  var getFooP2 = goog.bind(getFooP, null, 'dog');

  var res = getFooP2();
  assertEquals("res.arg1 should be 'hot'", 'hot', res.arg1);
  assertEquals("res.arg2 should be 'dog'", 'dog', res.arg2);
}

function testBindWithCall() {
  var obj = {};
  var obj2 = {};
  var f = function() {
    assertEquals('this should be bound to obj', obj, this);
  };
  var b = goog.bind(f, obj);
  b.call(null);
  b.call(obj2);
}

function testBindJs() {
  assertEquals(1, goog.bindJs_(add, {valueOf: function() { return 1; }})());
  assertEquals(3, goog.bindJs_(add, null, 1, 2)());
}

function testBindNative() {
  if (Function.prototype.bind &&
      Function.prototype.bind.toString().indexOf('native code') != -1) {
    assertEquals(
        1, goog.bindNative_(add, {valueOf: function() { return 1; }})());
    assertEquals(3, goog.bindNative_(add, null, 1, 2)());

    assertThrows(function() {
      goog.bindNative_(null, null);
    });
  }
}

function testBindDefault() {
  assertEquals(
      1, goog.bind(add, {valueOf: function() { return 1; }})());
  assertEquals(3, goog.bind(add, null, 1, 2)());
}

function add(var_args) {
  var sum = Number(this) || 0;
  for (var i = 0; i < arguments.length; i++) {
    sum += arguments[i];
  }
  return sum;
}

function testPartial() {
  var f = function(x, y) {
    return x + y;
  };
  var g = goog.partial(f, 1);
  assertEquals(3, g(2));

  var h = goog.partial(f, 1, 2);
  assertEquals(3, h());

  var i = goog.partial(f);
  assertEquals(3, i(1, 2));
}

function testPartialUsesGlobal() {
  var f = function(x, y) {
    assertEquals(goog.global, this);
    return x + y;
  };
  var g = goog.partial(f, 1);
  var h = goog.partial(g, 2);
  assertEquals(3, h());
}

function testPartialWithCall() {
  var obj = {};
  var f = function(x, y) {
    assertEquals(obj, this);
    return x + y;
  };
  var g = goog.partial(f, 1);
  var h = goog.partial(g, 2);
  assertEquals(3, h.call(obj));
}

function testPartialAndBind() {
  // This ensures that this "survives" through a partial.
  var p = goog.partial(getFoo, 'hot');
  var b = goog.bind(p, obj, 'dog');

  var res = b();
  assertEquals(obj.foo, res.foo);
  assertEquals('hot', res.arg1);
  assertEquals('dog', res.arg2);
}

function testBindAndPartial() {
  // This ensures that this "survives" through a partial.
  var b = goog.bind(getFoo, obj, 'hot');
  var p = goog.partial(b, 'dog');

  var res = p();
  assertEquals(obj.foo, res.foo);
  assertEquals('hot', res.arg1);
  assertEquals('dog', res.arg2);
}

function testGlobalEval() {
  goog.globalEval('var foofoofoo = 125;')
  assertEquals('Var should be globally assigned', 125, goog.global.foofoofoo);
  var foofoofoo = 128;
  assertEquals('Global should not have changed', 125, goog.global.foofoofoo);

  // NOTE(user): foofoofoo would normally be available in the function scope,
  // via the scope chain, but the JsUnit framework seems to do something weird
  // which makes it not work.
}

function testGlobalEvalWithHtml() {
  // Make sure we don't trip on HTML markup in the code
  goog.global.evalTestResult = 'failed';
  goog.global.evalTest = function(arg) {
    goog.global.evalTestResult = arg;
  };

  goog.globalEval('evalTest("<test>")');

  assertEquals('Should be able to evaluate strings with HTML in',
      '<test>', goog.global.evalTestResult);
}


//=== tests for inherits ===

function testInherits() {
  function Foo() {};
  function Bar() {};
  goog.inherits(Bar, Foo);
  var bar = new Bar();

  assert('object should be instance of constructor',
      bar instanceof Bar);
  assert('object should be instance of base constructor',
      bar instanceof Foo) ;
}

function testInherits_constructor() {
  function Foo() {};
  function Bar() {};
  goog.inherits(Bar, Foo);
  var bar = new Bar();

  assertEquals('constructor property should match constructor function',
      Bar, bar.constructor);
  assertEquals('Superclass constructor should match constructor function',
      Foo, Bar.superClass_.constructor);
}


//=== tests for makeSingleton ===
function testMakeSingleton() {
  function Foo() {};
  goog.addSingletonGetter(Foo);

  assertNotNull('Should add get instance function', Foo.getInstance);

  var x = Foo.getInstance();
  assertNotNull('Should successfully create an object', x);

  var y = Foo.getInstance();
  assertEquals('Should return the same object', x, y);

  delete Foo.instance_;

  var z = Foo.getInstance();
  assertNotNull('Should work after clearing for testing', z);

  assertNotEquals('Should return a different object after clearing for testing',
      x, z);
}


//=== tests for now ===

function testNow() {
  var toleranceMilliseconds = 10;
  var now1 = new Date().getTime();
  var now2 = goog.now();
  assertTrue(Math.abs(now1 - now2) < toleranceMilliseconds);
}


//=== test non-html context ===

function testInHtmlDocument() {
  var savedGoogGlobal = goog.global;
  try {
    goog.global = {};
    assertFalse(goog.inHtmlDocument_());
    goog.global.document = {};
    assertFalse(goog.inHtmlDocument_());
    goog.global.document.write = function() {};
    assertTrue(goog.inHtmlDocument_());
  } finally {
    // Restore context to respect other tests.
    goog.global = savedGoogGlobal;
  }
}

function testLoadInNonHtmlNotThrows() {
  var savedGoogGlobal = goog.global;
  try {
    goog.global = {};
    goog.global.document = {};
    assertFalse(goog.inHtmlDocument_());
    // The goog code which is executed at load.
    goog.findBasePath_();
    goog.writeScriptTag_(goog.basePath + 'deps.js');
  } finally {
    // Restore context to respect other tests.
    goog.global = savedGoogGlobal;
  }
}

function testLoadBaseWithQueryParamOk() {
  var savedGoogGlobal = goog.global;
  try {
    goog.global = {};
    goog.global.document = {
      write: goog.nullFunction,
      getElementsByTagName: goog.functions.constant(
          [{src: '/path/to/base.js?zx=5'}])
    };
    assertTrue(goog.inHtmlDocument_());
    goog.findBasePath_();
    assertEquals('/path/to/', goog.basePath);
  } finally {
    // Restore context to respect other tests.
    goog.global = savedGoogGlobal;
  }
}

//=== tests for getmsg ===
function testGetMsgWithDollarSigns() {
  var msg = goog.getMsg('{$amount} per minute',
      {amount: '$0.15'});
  assertEquals('$0.15 per minute', msg);
  msg = goog.getMsg('{$amount} per minute',
      {amount: '$0.$1$5'});
  assertEquals('$0.$1$5 per minute', msg);

  msg = goog.getMsg('This is a {$rate} sale!',
      {rate: '$$$$$$$$$$10'});
  assertEquals('This is a $$$$$$$$$$10 sale!', msg);
  msg = goog.getMsg('{$name}! Hamburgers: {$hCost}, Hotdogs: {$dCost}.',
      {name: 'Burger Bob',
       hCost: '$0.50',
       dCost: '$100'});
  assertEquals('Burger Bob! Hamburgers: $0.50, Hotdogs: $100.',
    msg);
}


//=== miscellaneous tests ===

function testIdentity() {
  assertEquals(3, goog.identityFunction(3));
  assertEquals(3, goog.identityFunction(3, 4));
  assertEquals(null, goog.identityFunction(null));
  assertTrue(goog.identityFunction() === undefined);
}

function testPropertyIsEnumerable_() {
  function A() {}
  A.prototype.x = 1;

  var a = new A;
  a.y = 2;

  assertFalse('Properties on the prototype should not be enumerable',
              goog.propertyIsEnumerable_(a, 'x'))
  assertTrue('Properties on the instance should be enumerable',
             goog.propertyIsEnumerable_(a, 'y'))

  // TODO(user): This test failed on the farm in FF3 Linux and no one was able to
  // reproduce locally. Error:
  // Permission denied to get property Window.document
  // For now get the Closure build green by skipping for FF3, and look into
  // what is causing this to be a problem for the tests running on the farm.
  if (!(goog.userAgent.GECKO && goog.userAgent.isVersion('1.9'))) {
    var childWindow;
    try {
      childWindow = window.open('', '_blank');
    } catch (e) {
      // NOTE(user): For some reason this line errors in Safari 3 on the farm,
      // "Undefined value".  This only recently started happening (2008/10/21).
      return;
    }
    // TODO(user): Find a way to test this behavior even when pop ups are
    // blocked, i.e., when childWindow doesn't exist. Using an iframe doesn't
    // seem to have the same problem.
    if (childWindow && childWindow.document) {
      var doc = childWindow.document;
      doc.open();
      doc.write('<script>' +
                'function A() {}' +
                'A.prototype.x = 1;' +
                'var c = new A;' +
                'c.y = 2;' +
                '</' + 'script>');
      doc.close();
      try {
        if (goog.userAgent.IE) {
          assertTrue('Properties on the prototype of an object from another ' +
              'window are enumerable in IE.',
              goog.propertyIsEnumerable_(childWindow.c, 'x'));
        } else {
          assertFalse('Properties on the prototype of an object from another ' +
              'window should not be enumerable.',
              goog.propertyIsEnumerable_(childWindow.c, 'x'));
        }
        assertTrue('Properties on the instance should be enumerable.',
            goog.propertyIsEnumerable_(childWindow.c, 'y'));
      } finally {
        // Even in the case where an assert fails, we want to close the child
        // window so it's easy to see the test results.
        childWindow.close();
      }
    }
  }
}


function testGetObjectByName() {
  var m = {
    'undefined': undefined,
    'null': null,
    emptyString: '',
    'false': false,
    'true': true,
    zero: 0,
    one: 1,
    two: {
      three: 3,
      four: {
        five: 5
      }
    },
    'six|seven': '6|7',
    'eight.nine': 8.9
  };
  goog.global.m = m;

  assertNull(goog.getObjectByName('m.undefined'));
  assertNull(goog.getObjectByName('m.null'));
  assertEquals(goog.getObjectByName('m.emptyString'), '');
  assertEquals(goog.getObjectByName('m.false'), false);
  assertEquals(goog.getObjectByName('m.true'), true);
  assertEquals(goog.getObjectByName('m.zero'), 0);
  assertEquals(goog.getObjectByName('m.one'), 1);
  assertEquals(goog.getObjectByName('m.two.three'), 3);
  assertEquals(goog.getObjectByName('m.two.four.five'), 5);
  assertEquals(goog.getObjectByName('m.six|seven'), '6|7');
  assertNull(goog.getObjectByName('m.eight.nine'));
  assertNull(goog.getObjectByName('m.notThere'));

  assertEquals(goog.getObjectByName('one', m), 1);
  assertEquals(goog.getObjectByName('two.three', m), 3);
  assertEquals(goog.getObjectByName('two.four.five', m), 5);
  assertEquals(goog.getObjectByName('six|seven', m), '6|7');
  assertNull(goog.getObjectByName('eight.nine', m));
  assertNull(goog.getObjectByName('notThere', m));
}


function testGetCssName() {
  assertEquals('classname', goog.getCssName('classname'));
  assertEquals('random-classname', goog.getCssName('random-classname'));
  assertEquals('control-modifier', goog.getCssName('control', 'modifier'));

  goog.setCssNameMapping({
    'goog': 'a',
    'disabled': 'b'
  }, 'BY_PART');
  var g = goog.getCssName('goog');
  assertEquals('a', g);
  assertEquals('a-b', goog.getCssName(g, 'disabled'));
  assertEquals('a-b', goog.getCssName('goog-disabled'));
  assertEquals('goog-button', goog.getCssName('goog-button'));

  goog.setCssNameMapping({
    'goog-button': 'a',
    'active': 'b'
  }, 'BY_WHOLE');

  g = goog.getCssName('goog-button');
  assertEquals('a', g);
  assertEquals('a-b', goog.getCssName(g, 'active'));
  assertEquals('goog-disabled', goog.getCssName('goog-disabled'));
}

function testAddDependency() {
  stubs.set(goog, 'writeScriptTag_', goog.nullFunction);

  goog.addDependency(
      'foo.js',
      ['testDep.foo'],
      ['testDep.bar']);

  goog.provide('testDep.bar');

  // this used to throw an exception
  goog.require('testDep.foo');

  assertTrue(goog.isObject(testDep.bar));

  // Unset provided namespace so the test can be re-run.
  testDep = undefined;
}

function testBaseMethod() {
  function A() {}
  A.prototype.foo = function(x, y) {
    return x + y;
  };

  function B() {}
  goog.inherits(B, A);
  B.prototype.foo = function(x, y) {
    return 2 + goog.base(this, 'foo', x, y);
  };

  function C() {}
  goog.inherits(C, B);
  C.prototype.foo = function(x, y) {
    return 4 + goog.base(this, 'foo', x, y);
  };

  var d = new C();
  d.foo = function(x, y) {
    return 8 + goog.base(this, 'foo', x, y);
  };

  assertEquals(15, d.foo(1, 0));
  assertEquals(16, d.foo(1, 1));
  assertEquals(16, d.foo(2, 0));
  assertEquals(7, (new C()).foo(1, 0));
  assertEquals(3, (new B()).foo(1, 0));
  assertThrows(function() {
    goog.base(d, 'foo', 1, 0);
  });

  delete B.prototype.foo;
  assertEquals(13, d.foo(1, 0));

  delete C.prototype.foo;
  assertEquals(9, d.foo(1, 0));
}

function testBaseMethodAndBaseCtor() {
  // This will fail on FF4.0 if the following bug is not fixed:
  // https://bugzilla.mozilla.org/show_bug.cgi?id=586482
  function A(x, y) {
    this.foo(x, y);
  }
  A.prototype.foo = function(x, y) {
    this.bar = x + y;
  };

  function B(x, y) {
    goog.base(this, x, y);
  }
  goog.inherits(B, A);
  B.prototype.foo = function(x, y) {
    goog.base(this, 'foo', x, y);
    this.bar = this.bar * 2;
  };

  assertEquals(14, new B(3, 4).bar);
}

function testBaseClass() {
  function A(x, y) {
    this.foo = x + y;
  }

  function B(x, y) {
    goog.base(this, x, y);
    this.foo += 2;
  }
  goog.inherits(B, A);

  function C(x, y) {
    goog.base(this, x, y);
    this.foo += 4;
  }
  goog.inherits(C, B);

  function D(x, y) {
    goog.base(this, x, y);
    this.foo += 8;
  }
  goog.inherits(D, C);

  assertEquals(15, (new D(1, 0)).foo);
  assertEquals(16, (new D(1, 1)).foo);
  assertEquals(16, (new D(2, 0)).foo);
  assertEquals(7, (new C(1, 0)).foo);
  assertEquals(3, (new B(1, 0)).foo);
}

">TypeError: Cannot read property 'f1' of undefined
    at getFramedVars (_tmpclosuretest.js:13:24)
    at _tmpclosuretest.js:39:18
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
    at Module.load (module.js:219:31)
</td></tr>
<tr><td>currency_test.html</td><td>Success</td><td> 9 passed, 0 failed.</td><td title="
    

    goog.require('goog.i18n.currency');
    goog.require('goog.i18n.NumberFormat');
    goog.require('goog.testing.jsunit');
    

  function testCurrencyPattern() {
    assertEquals("'$'#,##0.00",
        goog.i18n.currency.getLocalCurrencyPattern('USD'));
    assertEquals("'US$'#,##0.00",
        goog.i18n.currency.getPortableCurrencyPattern('USD'));
    assertEquals("USD '$'#,##0.00",
        goog.i18n.currency.getGlobalCurrencyPattern('USD'));

    assertEquals("'¥'#,##0",
        goog.i18n.currency.getLocalCurrencyPattern('JPY'));
    assertEquals("'JP¥'#,##0",
        goog.i18n.currency.getPortableCurrencyPattern('JPY'));
    assertEquals("JPY '¥'#,##0",
        goog.i18n.currency.getGlobalCurrencyPattern('JPY'));

    assertEquals("#,##0.00'€'",
        goog.i18n.currency.getLocalCurrencyPattern('EUR'));
    assertEquals("#,##0.00'€'",
        goog.i18n.currency.getPortableCurrencyPattern('EUR'));
    assertEquals("EUR #,##0.00'€'",
        goog.i18n.currency.getGlobalCurrencyPattern('EUR'));

    assertEquals("'¥'#,##0.00",
        goog.i18n.currency.getLocalCurrencyPattern('CNY'));
    assertEquals("'RMB¥'#,##0.00",
        goog.i18n.currency.getPortableCurrencyPattern('CNY'));
    assertEquals("CNY '¥'#,##0.00",
        goog.i18n.currency.getGlobalCurrencyPattern('CNY'));

    assertEquals("'YER'#,##0.00",
        goog.i18n.currency.getLocalCurrencyPattern('YER'));
    assertEquals("'YER'#,##0.00",
        goog.i18n.currency.getPortableCurrencyPattern('YER'));
    assertEquals("'YER' #,##0.00",
        goog.i18n.currency.getGlobalCurrencyPattern('YER'));

    assertEquals("'Fr.'#,##0.00",
        goog.i18n.currency.getLocalCurrencyPattern('CHF'));
    assertEquals("'CHF'#,##0.00",
        goog.i18n.currency.getPortableCurrencyPattern('CHF'));
    assertEquals("CHF 'Fr.'#,##0.00",
        goog.i18n.currency.getGlobalCurrencyPattern('CHF'));
  }

  function testCurrencyFormatCHF() {
    var formatter;
    var str;

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getLocalCurrencyPattern('CHF'));
    str = formatter.format(123456.7899);
    assertEquals('Fr.123,456.79', str);

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getPortableCurrencyPattern('CHF'));
    str = formatter.format(123456.7899);
    assertEquals('CHF123,456.79', str);

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getGlobalCurrencyPattern('CHF'));
    str = formatter.format(123456.7899);
    assertEquals('CHF Fr.123,456.79', str);
  }

  function testCurrencyFormatYER() {
    var formatter;
    var str;

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getLocalCurrencyPattern('YER'));
    str = formatter.format(123456.7899);
    assertEquals('YER123,456.79', str);

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getPortableCurrencyPattern('YER'));
    str = formatter.format(123456.7899);
    assertEquals('YER123,456.79', str);

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getGlobalCurrencyPattern('YER'));
    str = formatter.format(123456.7899);
    assertEquals('YER 123,456.79', str);
  }

  function testCurrencyFormatCNY() {
    var formatter;
    var str;

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getLocalCurrencyPattern('CNY'));
    str = formatter.format(123456.7899);
    assertEquals('¥123,456.79', str);

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getPortableCurrencyPattern('CNY'));
    str = formatter.format(123456.7899);
    assertEquals('RMB¥123,456.79', str);

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getGlobalCurrencyPattern('CNY'));
    str = formatter.format(123456.7899);
    assertEquals('CNY ¥123,456.79', str);
  }

  function testCurrencyFormatEUR() {
    var formatter;
    var str;

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getLocalCurrencyPattern('EUR'));
    str = formatter.format(123456.7899);
    assertEquals('123,456.79€', str);

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getPortableCurrencyPattern('EUR'));
    str = formatter.format(123456.7899);
    assertEquals('123,456.79€', str);

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getGlobalCurrencyPattern('EUR'));
    str = formatter.format(123456.7899);
    assertEquals('EUR 123,456.79€', str);
  }

  function testCurrencyFormatJPY() {
    var formatter;
    var str;

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getLocalCurrencyPattern('JPY'));
    str = formatter.format(123456.7899);
    assertEquals('¥123,457', str);

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getPortableCurrencyPattern('JPY'));
    str = formatter.format(123456.7899);
    assertEquals('JP¥123,457', str);

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getGlobalCurrencyPattern('JPY'));
    str = formatter.format(123456.7899);
    assertEquals('JPY ¥123,457', str);
  }

  function testCurrencyFormatUSD() {
    var formatter;
    var str;

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getLocalCurrencyPattern('USD'));
    str = formatter.format(123456.7899);
    assertEquals('$123,456.79', str);

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getPortableCurrencyPattern('USD'));
    str = formatter.format(123456.7899);
    assertEquals('US$123,456.79', str);

    formatter = new goog.i18n.NumberFormat(
        goog.i18n.currency.getGlobalCurrencyPattern('USD'));
    str = formatter.format(123456.7899);
    assertEquals('USD $123,456.79', str);
  }

  function testIsPrefixSignPosition() {
    assertTrue(goog.i18n.currency.isPrefixSignPosition('USD'));
    assertFalse(goog.i18n.currency.isPrefixSignPosition('EUR'));
  }

  function testGetCurrencySign() {
    assertEquals('USD $', goog.i18n.currency.getGlobalCurrencySign('USD'));
    assertEquals('$', goog.i18n.currency.getLocalCurrencySign('USD'));
    assertEquals('US$', goog.i18n.currency.getPortableCurrencySign('USD'));

    assertEquals('YER', goog.i18n.currency.getGlobalCurrencySign('YER'));
    assertEquals('YER', goog.i18n.currency.getLocalCurrencySign('YER'));
    assertEquals('YER', goog.i18n.currency.getPortableCurrencySign('YER'));
  }
">n/a</td></tr>
<tr><td>mime_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="

  goog.require('goog.i18n.mime.encode');
  goog.require('goog.testing.jsunit');



function testEncodeAllAscii() {
  // A string holding all the characters that should be encoded unchanged.
  // Double-quote is doubled to avoid annoying syntax highlighting in emacs,
  // which doesn't recognize the double-quote as being in a string constant.
  var identity = '!""#$%&\'()*+,-./0123456789:;<>@ABCDEFGHIJKLMNOPQRSTUVWXYZ' +
      '[\\]^`abcdefghijklmnopqrstuvwxyz{|}~';
  assertEquals(identity, goog.i18n.mime.encode(identity));
}

function testEncodeSpecials() {
  assertEquals('=?UTF-8?Q?=3f=5f=3d_?=', goog.i18n.mime.encode('?_= '));
  assertEquals('=?UTF-8?Q?=3f=5f=3d_=22=22?=',
      goog.i18n.mime.encode('?_= ""', true));
}

function testEncodeUnicode() {
  // Two-byte UTF-8, plus a special
  assertEquals('=?UTF-8?Q?=c2=82=de=a0_dude?=',
      goog.i18n.mime.encode('\u0082\u07a0 dude'));
  // Three-byte UTF-8, plus a special
  assertEquals('=?UTF-8?Q?=e0=a0=80=ef=bf=bf=3d?=',
      goog.i18n.mime.encode('\u0800\uffff='));
}

">n/a</td></tr>
<tr><td>graphemebreak_test.html</td><td>Success</td><td> 12 passed, 0 failed.</td><td title="

  goog.require('goog.i18n.GraphemeBreak');
  goog.require('goog.testing.jsunit');


  function testBreakNormalAscii() {
    assertTrue(goog.i18n.GraphemeBreak.hasGraphemeBreak('a'.charCodeAt(0),
        'b'.charCodeAt(0), true));
  }

  function testBreakAsciiWithExtendedChar() {
    assertFalse(goog.i18n.GraphemeBreak.hasGraphemeBreak('a'.charCodeAt(0),
        0x0300, true));
  }

  function testBreakSurrogates() {
    assertFalse(goog.i18n.GraphemeBreak.hasGraphemeBreak(0xDA00, 0xDC00, true));
    assertFalse(goog.i18n.GraphemeBreak.hasGraphemeBreak(0xDBFF, 0xDFFF, true));
  }

  function testBreakHangLxL() {
    assertFalse(goog.i18n.GraphemeBreak.hasGraphemeBreak(0x1100, 0x1100, true));
  }

  function testBreakHangL_T() {
    assertTrue(goog.i18n.GraphemeBreak.hasGraphemeBreak(0x1100, 0x11A8));
  }

  function testBreakHangLVxV() {
    assertFalse(goog.i18n.GraphemeBreak.hasGraphemeBreak(0xAC00, 0x1160, true));
  }

  function testBreakHangLV_L() {
    assertTrue(goog.i18n.GraphemeBreak.hasGraphemeBreak(0xAC00, 0x1100, true));
  }

  function testBreakHangLVTxT() {
    assertFalse(goog.i18n.GraphemeBreak.hasGraphemeBreak(0xAC01, 0x11A8, true));
  }

  function testBreakThaiPrependLegacy() {
    assertTrue(goog.i18n.GraphemeBreak.hasGraphemeBreak(0x0E40, 0x0E01));
  }
  
  function testBreakThaiPrependExtended() {
    assertFalse(goog.i18n.GraphemeBreak.hasGraphemeBreak(0x0E40, 0x0E01, true));
  }
  
  function testBreakDevaSpacingMarkLegacy() {
    assertTrue(goog.i18n.GraphemeBreak.hasGraphemeBreak(0x0915, 0x093E));
  }
  
  function testBreakDevaSpacingMarkExtended() {
    assertFalse(goog.i18n.GraphemeBreak.hasGraphemeBreak(0x0915, 0x093E, true));
  }
">n/a</td></tr>
<tr><td>datetimeformat_test.html</td><td>Success</td><td> 23 passed, 0 failed.</td><td title="

  goog.require('goog.i18n.DateTimeFormat');
  goog.require('goog.i18n.TimeZone');
  goog.require('goog.i18n.DateTimePatterns');
  goog.require('goog.i18n.DateTimePatterns_de');
  goog.require('goog.i18n.DateTimeSymbols');
  goog.require('goog.i18n.DateTimeSymbols_de');
  goog.require('goog.testing.jsunit');


  // Helpers to make tests work regardless of the timeZone we're in.
  function timezoneString(date) {
    var timeZone = goog.i18n.TimeZone.createTimeZone(date.getTimezoneOffset());
    return timeZone.getShortName(date);
  }

  function timezoneId(date) {
    var timeZone = goog.i18n.TimeZone.createTimeZone(
        date.getTimezoneOffset());
    return timeZone.getTimeZoneId(date);
  }

  function timezoneStringRFC(date) {
    var timeZone = goog.i18n.TimeZone.createTimeZone(date.getTimezoneOffset());
    return timeZone.getRFCTimeZoneString(date);
  }

  // Where could such data be found
  // In js_i18n_data in http://go/i18n_dir, we have a bunch of files with names
  // like TimeZoneConstant__<locale>.js
  // We strongly discourage you to use them directly as those data can make
  // your client code bloated. You should try to provide this data from server
  // in a selective manner. In typical scenario, user's time zone is retrieved
  // and only data for that time zone should be provided.
  var americaLosAngelesData = {
    'transitions': [
      2770, 60, 7137, 0, 11506, 60, 16041, 0, 20410, 60, 24777, 0, 29146, 60,
      33513, 0, 35194, 60, 42249, 0, 45106, 60, 50985, 0, 55354, 60, 59889, 0,
      64090, 60, 68625, 0, 72994, 60, 77361, 0, 81730, 60, 86097, 0, 90466, 60,
      94833, 0, 99202, 60, 103569, 0, 107938, 60, 112473, 0, 116674, 60, 121209,
      0, 125578, 60, 129945, 0, 134314, 60, 138681, 0, 143050, 60, 147417, 0,
      151282, 60, 156153, 0, 160018, 60, 165057, 0, 168754, 60, 173793, 0,
      177490, 60, 182529, 0, 186394, 60, 191265, 0, 195130, 60, 200001, 0,
      203866, 60, 208905, 0, 212602, 60, 217641, 0, 221338, 60, 226377, 0,
      230242, 60, 235113, 0, 238978, 60, 243849, 0, 247714, 60, 252585, 0,
      256450, 60, 261489, 0, 265186, 60, 270225, 0, 273922, 60, 278961, 0,
      282826, 60, 287697, 0, 291562, 60, 296433, 0, 300298, 60, 305337, 0,
      309034, 60, 314073, 0, 317770, 60, 322809, 0, 326002, 60, 331713, 0,
      334738, 60, 340449, 0, 343474, 60, 349185, 0, 352378, 60, 358089, 0,
      361114, 60, 366825, 0, 369850, 60, 375561, 0, 378586, 60, 384297, 0,
      387322, 60, 393033, 0, 396058, 60, 401769, 0, 404962, 60, 410673, 0,
      413698, 60, 419409, 0, 422434, 60, 428145, 0, 431170, 60, 436881, 0,
      439906, 60, 445617, 0, 448810, 60, 454521, 0, 457546, 60, 463257, 0,
      466282, 60, 471993, 0, 475018, 60, 480729, 0, 483754, 60, 489465, 0,
      492490, 60, 498201, 0, 501394, 60, 507105, 0, 510130, 60, 515841, 0,
      518866, 60, 524577, 0, 527602, 60, 533313, 0, 536338, 60, 542049, 0,
      545242, 60, 550953, 0, 553978, 60, 559689, 0, 562714, 60, 568425, 0,
      571450, 60, 577161, 0, 580186, 60, 585897, 0, 588922, 60, 594633, 0
    ],
    'names': ['PST', 'Pacific Standard Time', 'PDT', 'Pacific Daylight Time'],
    'id': 'America/Los_Angeles',
    'std_offset': -480
  };

  var europeBerlinData = {
    'transitions': [
      89953, 60, 94153, 0, 98521, 60, 102889, 0, 107257, 60, 111625, 0,
      115993, 60, 120361, 0, 124729, 60, 129265, 0, 133633, 60, 138001, 0,
      142369, 60, 146737, 0, 151105, 60, 155473, 0, 159841, 60, 164209, 0,
      168577, 60, 172945, 0, 177313, 60, 181849, 0, 186217, 60, 190585, 0,
      194953, 60, 199321, 0, 203689, 60, 208057, 0, 212425, 60, 216793, 0,
      221161, 60, 225529, 0, 230065, 60, 235105, 0, 238801, 60, 243841, 0,
      247537, 60, 252577, 0, 256273, 60, 261481, 0, 265009, 60, 270217, 0,
      273745, 60, 278953, 0, 282649, 60, 287689, 0, 291385, 60, 296425, 0,
      300121, 60, 305329, 0, 308857, 60, 314065, 0, 317593, 60, 322801, 0,
      326329, 60, 331537, 0, 335233, 60, 340273, 0, 343969, 60, 349009, 0,
      352705, 60, 357913, 0, 361441, 60, 366649, 0, 370177, 60, 375385, 0,
      379081, 60, 384121, 0, 387817, 60, 392857, 0, 396553, 60, 401593, 0,
      405289, 60, 410497, 0, 414025, 60, 419233, 0, 422761, 60, 427969, 0,
      431665, 60, 436705, 0, 440401, 60, 445441, 0, 449137, 60, 454345, 0,
      457873, 60, 463081, 0, 466609, 60, 471817, 0, 475513, 60, 480553, 0,
      484249, 60, 489289, 0, 492985, 60, 498025, 0, 501721, 60, 506929, 0,
      510457, 60, 515665, 0, 519193, 60, 524401, 0, 528097, 60, 533137, 0,
      536833, 60, 541873, 0, 545569, 60, 550777, 0, 554305, 60, 559513, 0,
      563041, 60, 568249, 0, 571777, 60, 576985, 0, 580681, 60, 585721, 0,
      589417, 60, 594457, 0],
    'names': ['MEZ', 'Mitteleurop\u00e4ische Zeit',
              'MESZ', 'Mitteleurop\u00e4ische Sommerzeit'],
    'id': 'Europe/Berlin',
    'std_offset': 60
  };

  var date;
  goog.i18n.DateTimePatterns = goog.i18n.DateTimePatterns_de;
  goog.i18n.DateTimeSymbols = goog.i18n.DateTimeSymbols_de;

  function testHHmmss() {
    date = new Date(2006, 6, 27, 13, 10, 10, 250);
    var fmt = new goog.i18n.DateTimeFormat('HH:mm:ss');
    assertEquals('13:10:10', fmt.format(date));
  }

  function testhhmmssa() {
    date = new Date(2006, 6, 27, 13, 10, 10, 250);
    var fmt = new goog.i18n.DateTimeFormat('h:mm:ss a');
    assertEquals('1:10:10 nachm.', fmt.format(date));
  }

  function testEEEMMMddyy() {
    date = new Date(2006, 6, 27, 13, 10, 10, 250);
    var fmt = new goog.i18n.DateTimeFormat('EEE, MMM d, yy');
    assertEquals('Do., Jul 27, 06', fmt.format(date));
  }

  function testEEEEMMMddyy() {
    date = new Date(2006, 6, 27, 13, 10, 10, 250);
    var fmt = new goog.i18n.DateTimeFormat('EEEE,MMMM dd, yyyy');
    assertEquals('Donnerstag,Juli 27, 2006', fmt.format(date));
  }

  function testyyyyMMddG() {
    date = new Date(Date.UTC(2006, 6, 27, 13, 10, 10, 250));
    var timeZone = goog.i18n.TimeZone.createTimeZone(420,
        goog.i18n.DateTimeSymbols_de);
    var fmt = new goog.i18n.DateTimeFormat('yyyy.MM.dd G \'at\' HH:mm:ss vvvv');
    assertEquals('2006.07.27 n. Chr. at 06:10:10 Etc/GMT+7',
                 fmt.format(date, timeZone));
  }

  function testyyyyyMMMMM() {
    date = new Date(2006, 6, 27, 13, 10, 10, 250);
    var fmt = new goog.i18n.DateTimeFormat('yyyyy.MMMMM.dd GGG hh:mm aaa');
    assertEquals('2006.J.27 n. Chr. 01:10 nachm.', fmt.format(date));
  }

  function testQQQQyy() {
    date = new Date(2006, 0, 27, 13, 10, 10, 250);
    var fmt = new goog.i18n.DateTimeFormat('QQQQ yy');
    assertEquals('1. Quartal 06', fmt.format(date));
    date = new Date(2006, 1, 27, 13, 10, 10, 250);
    assertEquals('1. Quartal 06', fmt.format(date));
    date = new Date(2006, 2, 27, 13, 10, 10, 250);
    assertEquals('1. Quartal 06', fmt.format(date));
    date = new Date(2006, 3, 27, 13, 10, 10, 250);
    assertEquals('2. Quartal 06', fmt.format(date));
    date = new Date(2006, 4, 27, 13, 10, 10, 250);
    assertEquals('2. Quartal 06', fmt.format(date));
    date = new Date(2006, 5, 27, 13, 10, 10, 250);
    assertEquals('2. Quartal 06', fmt.format(date));
    date = new Date(2006, 6, 27, 13, 10, 10, 250);
    assertEquals('3. Quartal 06', fmt.format(date));
    date = new Date(2006, 7, 27, 13, 10, 10, 250);
    assertEquals('3. Quartal 06', fmt.format(date));
    date = new Date(2006, 8, 27, 13, 10, 10, 250);
    assertEquals('3. Quartal 06', fmt.format(date));
    date = new Date(2006, 9, 27, 13, 10, 10, 250);
    assertEquals('4. Quartal 06', fmt.format(date));
    date = new Date(2006, 10, 27, 13, 10, 10, 250);
    assertEquals('4. Quartal 06', fmt.format(date));
    date = new Date(2006, 11, 27, 13, 10, 10, 250);
    assertEquals('4. Quartal 06', fmt.format(date));
  }

  function testQQyyyy() {
    date = new Date(2006, 0, 27, 13, 10, 10, 250);
    var fmt = new goog.i18n.DateTimeFormat('QQ yyyy');
    assertEquals('Q1 2006', fmt.format(date));
    date = new Date(2006, 1, 27, 13, 10, 10, 250);
    assertEquals('Q1 2006', fmt.format(date));
    date = new Date(2006, 2, 27, 13, 10, 10, 250);
    assertEquals('Q1 2006', fmt.format(date));
    date = new Date(2006, 3, 27, 13, 10, 10, 250);
    assertEquals('Q2 2006', fmt.format(date));
    date = new Date(2006, 4, 27, 13, 10, 10, 250);
    assertEquals('Q2 2006', fmt.format(date));
    date = new Date(2006, 5, 27, 13, 10, 10, 250);
    assertEquals('Q2 2006', fmt.format(date));
    date = new Date(2006, 6, 27, 13, 10, 10, 250);
    assertEquals('Q3 2006', fmt.format(date));
    date = new Date(2006, 7, 27, 13, 10, 10, 250);
    assertEquals('Q3 2006', fmt.format(date));
    date = new Date(2006, 8, 27, 13, 10, 10, 250);
    assertEquals('Q3 2006', fmt.format(date));
    date = new Date(2006, 9, 27, 13, 10, 10, 250);
    assertEquals('Q4 2006', fmt.format(date));
    date = new Date(2006, 10, 27, 13, 10, 10, 250);
    assertEquals('Q4 2006', fmt.format(date));
    date = new Date(2006, 11, 27, 13, 10, 10, 250);
    assertEquals('Q4 2006', fmt.format(date));
  }

  function testMMddyyyyHHmmsszzz() {
    date = new Date(2006, 6, 27, 13, 10, 10, 250);
    var fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss zzz');
    assertEquals('07/27/2006 13:10:10 ' + timezoneString(date),
        fmt.format(date));
  }

  function testMMddyyyyHHmmssZ() {
    date = new Date(2006, 6, 27, 13, 10, 10, 250);
    var fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss Z');
    assertEquals('07/27/2006 13:10:10 ' + timezoneStringRFC(date),
        fmt.format(date));
  }

  function testPatternMonthDayMedium() {
    date = new Date(2006, 6, 27, 13, 10, 10, 250);
    var fmt = new goog.i18n.DateTimeFormat(
        goog.i18n.DateTimePatterns.MONTH_DAY_MEDIUM);
    assertEquals('27. Juli', fmt.format(date));
  }

  function testQuote() {
    date = new Date(2006, 6, 27, 13, 10, 10, 250);
    var fmt = new goog.i18n.DateTimeFormat('HH \'o\'\'clock\'');
    assertEquals('13 o\'clock', fmt.format(date));
    fmt = new goog.i18n.DateTimeFormat('HH \'oclock\'');
    assertEquals('13 oclock', fmt.format(date));
    fmt = new goog.i18n.DateTimeFormat('HH \'\'');
    assertEquals('13 \'', fmt.format(date));
  }

  function testFractionalSeconds() {
    date = new Date(2006, 6, 27, 13, 10, 10, 256);
    var fmt = new goog.i18n.DateTimeFormat('s:S');
    assertEquals('10:3', fmt.format(date));
    var fmt = new goog.i18n.DateTimeFormat('s:SS');
    assertEquals('10:26', fmt.format(date));
    var fmt = new goog.i18n.DateTimeFormat('s:SSS');
    assertEquals('10:256', fmt.format(date));
    var fmt = new goog.i18n.DateTimeFormat('s:SSSS');
    assertEquals('10:2560', fmt.format(date));
    var fmt = new goog.i18n.DateTimeFormat('s:SSSSS');
    assertEquals('10:25600', fmt.format(date));
  }

  function testPredefinedFormatter() {
    date = new Date(2006, 7, 4, 13, 49, 24, 000);
    var fmt = new goog.i18n.DateTimeFormat(goog.i18n.DateTimeFormat.Format.FULL_DATE);
    assertEquals('Freitag, 4. August 2006', fmt.format(date));
    fmt = new goog.i18n.DateTimeFormat(goog.i18n.DateTimeFormat.Format.LONG_DATE);
    assertEquals('4. August 2006', fmt.format(date));
    fmt = new goog.i18n.DateTimeFormat(goog.i18n.DateTimeFormat.Format.MEDIUM_DATE);
    assertEquals('04.08.2006', fmt.format(date));
    fmt = new goog.i18n.DateTimeFormat(goog.i18n.DateTimeFormat.Format.SHORT_DATE);
    assertEquals('04.08.06', fmt.format(date));
    fmt = new goog.i18n.DateTimeFormat(goog.i18n.DateTimeFormat.Format.FULL_TIME);
    assertEquals('13:49:24 ' + timezoneString(date), fmt.format(date));
    fmt = new goog.i18n.DateTimeFormat(goog.i18n.DateTimeFormat.Format.LONG_TIME);
    assertEquals('13:49:24 ' + timezoneString(date), fmt.format(date));
    fmt = new goog.i18n.DateTimeFormat(goog.i18n.DateTimeFormat.Format.MEDIUM_TIME);
    assertEquals('13:49:24', fmt.format(date));
    fmt = new goog.i18n.DateTimeFormat(goog.i18n.DateTimeFormat.Format.SHORT_TIME);
    assertEquals('13:49', fmt.format(date));
    fmt = new goog.i18n.DateTimeFormat(goog.i18n.DateTimeFormat.Format.FULL_DATETIME);
    assertEquals('Freitag, 4. August 2006 13:49:24 ' + timezoneString(date),
       fmt.format(date));
    fmt = new goog.i18n.DateTimeFormat(goog.i18n.DateTimeFormat.Format.LONG_DATETIME);
    assertEquals('4. August 2006 13:49:24 ' + timezoneString(date),
       fmt.format(date));
    fmt = new goog.i18n.DateTimeFormat(goog.i18n.DateTimeFormat.Format.MEDIUM_DATETIME);
    assertEquals('04.08.2006 13:49:24', fmt.format(date));
    fmt = new goog.i18n.DateTimeFormat(goog.i18n.DateTimeFormat.Format.SHORT_DATETIME);
    assertEquals('04.08.06 13:49', fmt.format(date));
  }

  function testMMddyyyyHHmmssZSimpleTimeZone() {
    var date = new Date(Date.UTC(2006, 6, 27, 13, 10, 10));
    var timeZone = goog.i18n.TimeZone.createTimeZone(480);
    var fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss Z');
    assertEquals('07/27/2006 05:10:10 -0800', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss ZZ');
    assertEquals('07/27/2006 05:10:10 -0800', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss ZZZ');
    assertEquals('07/27/2006 05:10:10 -0800', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss ZZZZ');
    assertEquals('07/27/2006 05:10:10 GMT-08:00', fmt.format(date, timeZone));
  }


  function testMMddyyyyHHmmssZCommonTimeZone() {
    var date = new Date(Date.UTC(2006, 6, 27, 13, 10, 10));
    var timeZone = goog.i18n.TimeZone.createTimeZone(americaLosAngelesData);
    var fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss Z');
    assertEquals('07/27/2006 06:10:10 -0700', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss ZZ');
    assertEquals('07/27/2006 06:10:10 -0700', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss ZZZ');
    assertEquals('07/27/2006 06:10:10 -0700', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss ZZZZ');
    assertEquals('07/27/2006 06:10:10 GMT-07:00', fmt.format(date, timeZone));
    date = new Date(Date.UTC(2006, 1, 27, 13, 10, 10));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss Z');
    assertEquals('02/27/2006 05:10:10 -0800', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss ZZ');
    assertEquals('02/27/2006 05:10:10 -0800', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss ZZZ');
    assertEquals('02/27/2006 05:10:10 -0800', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss ZZZZ');
    assertEquals('02/27/2006 05:10:10 GMT-08:00', fmt.format(date, timeZone));
  }

  function testMMddyyyyHHmmsszSimpleTimeZone() {
    var date = new Date(Date.UTC(2006, 6, 27, 13, 10, 10));
    var timeZone = goog.i18n.TimeZone.createTimeZone(420);
    var fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss z');
    assertEquals('07/27/2006 06:10:10 UTC-7', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss zz');
    assertEquals('07/27/2006 06:10:10 UTC-7', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss zzz');
    assertEquals('07/27/2006 06:10:10 UTC-7', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss zzzz');
    assertEquals('07/27/2006 06:10:10 UTC-7', fmt.format(date, timeZone));
  }


  function testMMddyyyyHHmmsszCommonTimeZone() {
    var date = new Date(Date.UTC(2006, 6, 27, 13, 10, 10));
    var timeZone = goog.i18n.TimeZone.createTimeZone(americaLosAngelesData);
    var fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss z');
    assertEquals('07/27/2006 06:10:10 PDT', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss zz');
    assertEquals('07/27/2006 06:10:10 PDT', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss zzz');
    assertEquals('07/27/2006 06:10:10 PDT', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss zzzz');
    assertEquals('07/27/2006 06:10:10 Pacific Daylight Time',
                 fmt.format(date, timeZone));
    date = new Date(Date.UTC(2006, 1, 27, 13, 10, 10));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss z');
    assertEquals('02/27/2006 05:10:10 PST', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss zz');
    assertEquals('02/27/2006 05:10:10 PST', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss zzz');
    assertEquals('02/27/2006 05:10:10 PST', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss zzzz');
    assertEquals('02/27/2006 05:10:10 Pacific Standard Time',
        fmt.format(date, timeZone));

    timeZone = goog.i18n.TimeZone.createTimeZone(europeBerlinData);
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss z');
    assertEquals('02/27/2006 14:10:10 MEZ', fmt.format(date, timeZone));
    var fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss zzzz');
    assertEquals('02/27/2006 14:10:10 Mitteleurop\u00e4ische Zeit',
        fmt.format(date, timeZone));
  }

  function testMMddyyyyHHmmssvCommonTimeZone() {
    var date = new Date(Date.UTC(2006, 6, 27, 13, 10, 10));
    var timeZone = goog.i18n.TimeZone.createTimeZone(americaLosAngelesData);
    var fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss v');
    assertEquals('07/27/2006 06:10:10 America/Los_Angeles',
                 fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss vv');
    assertEquals('07/27/2006 06:10:10 America/Los_Angeles',
                 fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss vvv');
    assertEquals('07/27/2006 06:10:10 America/Los_Angeles',
                 fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss vvvv');
    assertEquals('07/27/2006 06:10:10 America/Los_Angeles',
        fmt.format(date, timeZone));
  }

  function testMMddyyyyHHmmssvSimpleTimeZone() {
    var date = new Date(Date.UTC(2006, 6, 27, 13, 10, 10));
    var timeZone = goog.i18n.TimeZone.createTimeZone(420);
    var fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss v');
    assertEquals('07/27/2006 06:10:10 Etc/GMT+7', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss vv');
    assertEquals('07/27/2006 06:10:10 Etc/GMT+7', fmt.format(date, timeZone));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss vvv');
    assertEquals('07/27/2006 06:10:10 Etc/GMT+7', fmt.format(date, timeZone));
    var fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss vvvv');
    assertEquals('07/27/2006 06:10:10 Etc/GMT+7', fmt.format(date, timeZone));
  }


  function test_yyyyMMddG() {
    var date = new Date(Date.UTC(2006, 6, 27, 20, 10, 10));
    var timeZone = goog.i18n.TimeZone.createTimeZone(420);
    var fmt = new goog.i18n.DateTimeFormat('yyyy.MM.dd G \'at\' HH:mm:ss vvvv');
    assertEquals('2006.07.27 n. Chr. at 13:10:10 Etc/GMT+7',
                 fmt.format(date, timeZone));

    timeZone = goog.i18n.TimeZone.createTimeZone(americaLosAngelesData);
    fmt = new goog.i18n.DateTimeFormat('yyyy.MM.dd G \'at\' HH:mm:ss vvvv');
    assertEquals('2006.07.27 n. Chr. at 13:10:10 America/Los_Angeles',
        fmt.format(date, timeZone));
  }

  function test_daylightTimeTransition() {
    // US PST transition to PDT on 2006/4/2/ 2:00am, jump to 2006/4/2 3:00am,
    // That's UTC time 2006/4/2 10:00am
    var timeZone = goog.i18n.TimeZone.createTimeZone(americaLosAngelesData);
    var date = new Date(Date.UTC(2006, 4 - 1, 2, 9, 59, 0));
    var fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss z');
    assertEquals('04/02/2006 01:59:00 PST', fmt.format(date, timeZone));
    date = new Date(Date.UTC(2006, 4 - 1, 2, 10, 01, 0));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss z');
    assertEquals('04/02/2006 03:01:00 PDT', fmt.format(date, timeZone));
    date = new Date(Date.UTC(2006, 4 - 1, 2, 10, 00, 0));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss z');
    assertEquals('04/02/2006 03:00:00 PDT', fmt.format(date, timeZone));
  }

  function test_timeDisplayOnDaylighTimeTransition() {
    // US PST transition to PDT on 2006/4/2/ 2:00am, jump to 2006/4/2 3:00am,
    var date = new Date(Date.UTC(2006, 4 - 1, 2, 2, 30, 0));
    var timeZone = goog.i18n.TimeZone.createTimeZone(0);
    var fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss Z');
    assertEquals('04/02/2006 02:30:00 +0000', fmt.format(date, timeZone));

    // US PDT transition to PST on 2006/10/29/ 2:00am, jump back to PDT
    // 2006/4/2 1:00am,
    date = new Date(Date.UTC(2006, 10 - 1, 29, 1, 30, 0));
    fmt = new goog.i18n.DateTimeFormat('MM/dd/yyyy HH:mm:ss Z');
    assertEquals('10/29/2006 01:30:00 +0000', fmt.format(date, timeZone));
  }
">n/a</td></tr>
<tr><td>bidi_test.html</td><td>Success</td><td> 19 passed, 0 failed.</td><td title="

  goog.require('goog.i18n.bidi');
  goog.require('goog.testing.jsunit');


  var LRE = '\u202A';
  var RLE = '\u202B';
  var PDF = '\u202C';
  var LRM = '\u200E';
  var RLM = '\u200F';

  function testIsRtlLang() {
    assert(!goog.i18n.bidi.isRtlLanguage('en'));
    assert(!goog.i18n.bidi.isRtlLanguage('fr'));
    assert(!goog.i18n.bidi.isRtlLanguage('zh-CN'));
    assert(!goog.i18n.bidi.isRtlLanguage('fil'));
    assert(!goog.i18n.bidi.isRtlLanguage('az'));
    assert(!goog.i18n.bidi.isRtlLanguage('iw-Latn'));
    assert(goog.i18n.bidi.isRtlLanguage('ar'));
    assert(goog.i18n.bidi.isRtlLanguage('iw'));
    assert(goog.i18n.bidi.isRtlLanguage('he'));
    assert(goog.i18n.bidi.isRtlLanguage('fa'));
    assert(goog.i18n.bidi.isRtlLanguage('ar-EG'));
    assert(goog.i18n.bidi.isRtlLanguage('az-Arab'));
    assert(goog.i18n.bidi.isRtlLanguage('az-Arab-IR'));
  }

  function testIsLtrChar() {
    assert(goog.i18n.bidi.isLtrChar('a'));
    assert(!goog.i18n.bidi.isLtrChar('\u05e0'));
    var str = 'a\u05e0z';
    assert(goog.i18n.bidi.isLtrChar(str.charAt(0)));
    assert(!goog.i18n.bidi.isLtrChar(str.charAt(1)));
    assert(goog.i18n.bidi.isLtrChar(str.charAt(2)));
  }

  function testIsRtlChar() {
    assert(!goog.i18n.bidi.isRtlChar('a'));
    assert(goog.i18n.bidi.isRtlChar('\u05e0'));
    var str = 'a\u05e0z';
    assert(!goog.i18n.bidi.isRtlChar(str.charAt(0)));
    assert(goog.i18n.bidi.isRtlChar(str.charAt(1)));
    assert(!goog.i18n.bidi.isRtlChar(str.charAt(2)));
  }

  function testIsNeutralChar() {
    assert(goog.i18n.bidi.isNeutralChar('\u0000'));
    assert(goog.i18n.bidi.isNeutralChar('\u0020'));
    assert(!goog.i18n.bidi.isNeutralChar('a'));
    assert(goog.i18n.bidi.isNeutralChar('!'));
    assert(goog.i18n.bidi.isNeutralChar('@'));
    assert(goog.i18n.bidi.isNeutralChar('['));
    assert(goog.i18n.bidi.isNeutralChar('`'));
    assert(goog.i18n.bidi.isNeutralChar('0'));
    assert(!goog.i18n.bidi.isNeutralChar('\u05e0'));
  }

  function testIsNeutralText() {
    assert(goog.i18n.bidi.isNeutralText('123'));
    assert(!goog.i18n.bidi.isNeutralText('abc'));
    assert(goog.i18n.bidi.isNeutralText('http://abc'));
    assert(goog.i18n.bidi.isNeutralText(' 123-()'));
    assert(!goog.i18n.bidi.isNeutralText('123a456'));
    assert(!goog.i18n.bidi.isNeutralText('123\u05e0456'));
    assert(!goog.i18n.bidi.isNeutralText('<input value=\u05e0>123&lt;', false));
    assert(goog.i18n.bidi.isNeutralText('<input value=\u05e0>123&lt;', true));
  }

  function testHasAnyLtr() {
    assert(!goog.i18n.bidi.hasAnyLtr(''));
    assert(!goog.i18n.bidi.hasAnyLtr('\u05e0\u05e1\u05e2'));
    assert(goog.i18n.bidi.hasAnyLtr('\u05e0\u05e1z\u05e2'));
    assert(!goog.i18n.bidi.hasAnyLtr('123\t...  \n'));
    assert(goog.i18n.bidi.hasAnyLtr('<br>123&lt;', false));
    assert(!goog.i18n.bidi.hasAnyLtr('<br>123&lt;', true));
  }

  function testHasAnyRtl() {
    assert(!goog.i18n.bidi.hasAnyRtl(''));
    assert(!goog.i18n.bidi.hasAnyRtl('abc'));
    assert(goog.i18n.bidi.hasAnyRtl('ab\u05e0c'));
    assert(!goog.i18n.bidi.hasAnyRtl('123\t...  \n'));
    assert(goog.i18n.bidi.hasAnyRtl('<input value=\u05e0>123', false));
    assert(!goog.i18n.bidi.hasAnyRtl('<input value=\u05e0>123', true));
  }

  function testEndsWithLtr() {
    assert(goog.i18n.bidi.endsWithLtr('a'));
    assert(goog.i18n.bidi.endsWithLtr('abc'));
    assert(goog.i18n.bidi.endsWithLtr('a (!)'));
    assert(goog.i18n.bidi.endsWithLtr('a.1'));
    assert(goog.i18n.bidi.endsWithLtr('http://www.google.com '));
    assert(goog.i18n.bidi.endsWithLtr('\u05e0a'));
    assert(goog.i18n.bidi.endsWithLtr(' \u05e0\u05e1a\u05e2\u05e3 a (!)'));
    assert(!goog.i18n.bidi.endsWithLtr(''));
    assert(!goog.i18n.bidi.endsWithLtr(' '));
    assert(!goog.i18n.bidi.endsWithLtr('1'));
    assert(!goog.i18n.bidi.endsWithLtr('\u05e0'));
    assert(!goog.i18n.bidi.endsWithLtr('\u05e0 1(!)'));
    assert(!goog.i18n.bidi.endsWithLtr('a\u05e0'));
    assert(!goog.i18n.bidi.endsWithLtr('a abc\u05e0\u05e1def\u05e2. 1'));
    assert(!goog.i18n.bidi.endsWithLtr(' \u05e0\u05e1a\u05e2 &lt;', true));
    assert(goog.i18n.bidi.endsWithLtr(' \u05e0\u05e1a\u05e2 &lt;', false));
  }

  function testEndsWithRtl() {
    assert(goog.i18n.bidi.endsWithRtl('\u05e0'));
    assert(goog.i18n.bidi.endsWithRtl('\u05e0\u05e1\u05e2'));
    assert(goog.i18n.bidi.endsWithRtl('\u05e0 (!)'));
    assert(goog.i18n.bidi.endsWithRtl('\u05e0.1'));
    assert(goog.i18n.bidi.endsWithRtl('http://www.google.com/\u05e0 '));
    assert(goog.i18n.bidi.endsWithRtl('a\u05e0'));
    assert(goog.i18n.bidi.endsWithRtl(' a abc\u05e0def\u05e3. 1'));
    assert(!goog.i18n.bidi.endsWithRtl(''));
    assert(!goog.i18n.bidi.endsWithRtl(' '));
    assert(!goog.i18n.bidi.endsWithRtl('1'));
    assert(!goog.i18n.bidi.endsWithRtl('a'));
    assert(!goog.i18n.bidi.endsWithRtl('a 1(!)'));
    assert(!goog.i18n.bidi.endsWithRtl('\u05e0a'));
    assert(!goog.i18n.bidi.endsWithRtl('\u05e0 \u05e0\u05e1ab\u05e2 a (!)'));
    assert(goog.i18n.bidi.endsWithRtl(' \u05e0\u05e1a\u05e2 &lt;', true));
    assert(!goog.i18n.bidi.endsWithRtl(' \u05e0\u05e1a\u05e2 &lt;', false));
  }

  function testGuardBracketInHtml() {
    var strWithRtl = "asc \u05d0 (\u05d0\u05d0\u05d0)";
    assertEquals("asc \u05d0 <span dir=rtl>(\u05d0\u05d0\u05d0)</span>",
        goog.i18n.bidi.guardBracketInHtml(strWithRtl));
    assertEquals("asc \u05d0 <span dir=rtl>(\u05d0\u05d0\u05d0)</span>",
        goog.i18n.bidi.guardBracketInHtml(strWithRtl, true));
    assertEquals("asc \u05d0 <span dir=ltr>(\u05d0\u05d0\u05d0)</span>",
        goog.i18n.bidi.guardBracketInHtml(strWithRtl, false));

    var strWithRtl2 = "\u05d0 a (asc:))";
    assertEquals("\u05d0 a <span dir=rtl>(asc:))</span>",
        goog.i18n.bidi.guardBracketInHtml(strWithRtl2));
    assertEquals("\u05d0 a <span dir=rtl>(asc:))</span>",
        goog.i18n.bidi.guardBracketInHtml(strWithRtl2, true));
    assertEquals("\u05d0 a <span dir=ltr>(asc:))</span>",
        goog.i18n.bidi.guardBracketInHtml(strWithRtl2, false));

    var strWithoutRtl = "a (asc) {{123}}";
        assertEquals("a <span dir=ltr>(asc)</span> <span dir=ltr>{{123}}</span>",
    goog.i18n.bidi.guardBracketInHtml(strWithoutRtl));
        assertEquals("a <span dir=rtl>(asc)</span> <span dir=rtl>{{123}}</span>",
    goog.i18n.bidi.guardBracketInHtml(strWithoutRtl, true));
    assertEquals("a <span dir=ltr>(asc)</span> <span dir=ltr>{{123}}</span>",
          goog.i18n.bidi.guardBracketInHtml(strWithoutRtl, false));

  }

  function testGuardBracketInText() {
    var strWithRtl = "asc \u05d0 (\u05d0\u05d0\u05d0)";
    assertEquals("asc \u05d0 \u200f(\u05d0\u05d0\u05d0)\u200f",
        goog.i18n.bidi.guardBracketInText(strWithRtl));
    assertEquals("asc \u05d0 \u200f(\u05d0\u05d0\u05d0)\u200f",
        goog.i18n.bidi.guardBracketInText(strWithRtl, true));
    assertEquals("asc \u05d0 \u200e(\u05d0\u05d0\u05d0)\u200e",
        goog.i18n.bidi.guardBracketInText(strWithRtl, false));

    var strWithRtl2 = "\u05d0 a (asc:))";
    assertEquals("\u05d0 a \u200f(asc:))\u200f",
        goog.i18n.bidi.guardBracketInText(strWithRtl2));
    assertEquals("\u05d0 a \u200f(asc:))\u200f",
        goog.i18n.bidi.guardBracketInText(strWithRtl2, true));
    assertEquals("\u05d0 a \u200e(asc:))\u200e",
        goog.i18n.bidi.guardBracketInText(strWithRtl2, false));

    var strWithoutRtl = "a (asc) {{123}}";
    assertEquals("a \u200e(asc)\u200e \u200e{{123}}\u200e",
        goog.i18n.bidi.guardBracketInText(strWithoutRtl));
    assertEquals("a \u200f(asc)\u200f \u200f{{123}}\u200f",
        goog.i18n.bidi.guardBracketInText(strWithoutRtl, true));
    assertEquals("a \u200e(asc)\u200e \u200e{{123}}\u200e",
        goog.i18n.bidi.guardBracketInText(strWithoutRtl, false));

  }

  function testEnforceRtlInHtml() {
    var str = '<div> first <br> second </div>';
    assertEquals('<div dir=rtl> first <br> second </div>',
                 goog.i18n.bidi.enforceRtlInHtml(str));
    str = 'first second';
    assertEquals('\n<span dir=rtl>first second</span>',
                 goog.i18n.bidi.enforceRtlInHtml(str));
  }

  function testEnforceRtlInText() {
    var str = 'first second';
    assertEquals(RLE + 'first second' + PDF,
                 goog.i18n.bidi.enforceRtlInText(str));
  }

  function testEnforceLtrInHtml() {
    var str = '<div> first <br> second </div>';
    assertEquals('<div dir=ltr> first <br> second </div>',
                 goog.i18n.bidi.enforceLtrInHtml(str));
    str = 'first second';
    assertEquals('\n<span dir=ltr>first second</span>',
                 goog.i18n.bidi.enforceLtrInHtml(str));
  }

  function testEnforceLtrInText() {
    var str = 'first second';
    assertEquals(LRE + 'first second' + PDF,
                 goog.i18n.bidi.enforceLtrInText(str));
  }

  function testNormalizeHebrewQuote() {
    assertEquals('\u05d0\u05f4', goog.i18n.bidi.normalizeHebrewQuote('\u05d0"'));
    assertEquals('\u05d0\u05f3', goog.i18n.bidi.normalizeHebrewQuote('\u05d0\''));
    assertEquals('\u05d0\u05f4\u05d0\u05f3',
                 goog.i18n.bidi.normalizeHebrewQuote('\u05d0"\u05d0\''));
  }

  function testMirrorCSS() {
    var str = 'left:10px;right:20px';
    assertEquals('right:10px;left:20px',
                 goog.i18n.bidi.mirrorCSS(str));
    str = 'border:10px 20px 30px 40px';
    assertEquals('border:10px 40px 30px 20px',
                 goog.i18n.bidi.mirrorCSS(str));
  }

  function testEstimateDirection() {
    assertEquals(goog.i18n.bidi.Dir.UNKNOWN,
                 goog.i18n.bidi.estimateDirection('', false));
    assertEquals(goog.i18n.bidi.Dir.UNKNOWN,
                 goog.i18n.bidi.estimateDirection(' ', false));
    assertEquals(goog.i18n.bidi.Dir.UNKNOWN,
                 goog.i18n.bidi.estimateDirection('! (...)', false));
    assertEquals(goog.i18n.bidi.Dir.LTR,
                 goog.i18n.bidi.estimateDirection('All-Ascii content', false));
    assertEquals(goog.i18n.bidi.Dir.LTR,
                 goog.i18n.bidi.estimateDirection('-17.0%', false));
    assertEquals(goog.i18n.bidi.Dir.LTR,
                 goog.i18n.bidi.estimateDirection('http://foo/bar/', false));
    assertEquals(goog.i18n.bidi.Dir.LTR,
                 goog.i18n.bidi.estimateDirection(
                     'http://foo/bar/?s=\u05d0\u05d0\u05d0\u05d0\u05d0\u05d0' +
                     '\u05d0\u05d0\u05d0\u05d0\u05d0\u05d0\u05d0\u05d0\u05d0' +
                     '\u05d0\u05d0\u05d0\u05d0\u05d0\u05d0\u05d0\u05d0\u05d0',
                     false));
    assertEquals(goog.i18n.bidi.Dir.RTL,
                 goog.i18n.bidi.estimateDirection('\u05d0', false));
    assertEquals(goog.i18n.bidi.Dir.RTL,
                 goog.i18n.bidi.estimateDirection(
                     '9 \u05d0 -> 17.5, 23, 45, 19', false));
    assertEquals(goog.i18n.bidi.Dir.RTL,
                 goog.i18n.bidi.estimateDirection(
                     'http://foo/bar/ \u05d0 http://foo2/bar2/ ' +
                     'http://foo3/bar3/', false));
    assertEquals(goog.i18n.bidi.Dir.RTL,
                 goog.i18n.bidi.estimateDirection(
                     '\u05d0\u05d9\u05df \u05de\u05de\u05e9 ' +
                     '\u05de\u05d4 \u05dc\u05e8\u05d0\u05d5\u05ea: ' +
                     '\u05dc\u05d0 \u05e6\u05d9\u05dc\u05de\u05ea\u05d9 ' +
                     '\u05d4\u05e8\u05d1\u05d4 \u05d5\u05d2\u05dd \u05d0' +
                     '\u05dd \u05d4\u05d9\u05d9\u05ea\u05d9 \u05de\u05e6' +
                     '\u05dc\u05dd, \u05d4\u05d9\u05d4 \u05e9\u05dd', false));
    assertEquals(goog.i18n.bidi.Dir.RTL,
                 goog.i18n.bidi.estimateDirection(
                     '\u05db\u05d0 - http://geek.co.il/gallery/v/2007-06' +
                     ' - \u05d0\u05d9\u05df \u05de\u05de\u05e9 \u05de\u05d4 ' +
                     '\u05dc\u05e8\u05d0\u05d5\u05ea: \u05dc\u05d0 \u05e6' +
                     '\u05d9\u05dc\u05de\u05ea\u05d9 \u05d4\u05e8\u05d1 ' +
                     '\u05d5\u05d2\u05dd \u05d0\u05dd \u05d4\u05d9\u05d9' +
                     '\u05d9 \u05de\u05e6\u05dc\u05dd, \u05d4\u05d9\u05d4 ' +
                     '\u05e9\u05dd \u05d1\u05e2\u05d9\u05e7 \u05d4\u05e8' +
                     '\u05d1\u05d4 \u05d0\u05e0\u05e9\u05d9\u05dd. \u05de' +
                     '\u05d4 \u05e9\u05db\u05df - \u05d0\u05e4\u05e9\u05e8 ' +
                     '\u05dc\u05e0\u05e6\u05dc \u05d0\u05ea \u05d4\u05d4 ' +
                     '\u05d3\u05d6\u05de\u05e0\u05d5 \u05dc\u05d4\u05e1' +
                     '\u05ea\u05db\u05dc \u05e2\u05dc \u05db\u05de\u05d4 ' +
                     '\u05ea\u05de\u05d5\u05e0\u05d5\u05ea \u05de\u05e9' +
                     '\u05e9\u05e2\u05d5\u05ea \u05d9\u05e9\u05e0\u05d5 ' +
                     '\u05d9\u05d5\u05ea\u05e8 \u05e9\u05d9\u05e9 \u05dc' +
                     '\u05d9 \u05d1\u05d0\u05ea\u05e8', false));
    assertEquals(goog.i18n.bidi.Dir.RTL,
                 goog.i18n.bidi.estimateDirection(
                     'CAPTCHA \u05de\u05e9\u05d5\u05db\u05dc\u05dc ' +
                     '\u05de\u05d3\u05d9?', false));
    assertEquals(goog.i18n.bidi.Dir.RTL,
                 goog.i18n.bidi.estimateDirection(
                     'Yes Prime Minister \u05e2\u05d3\u05db\u05d5\u05df. ' +
                     '\u05e9\u05d0\u05dc\u05d5 \u05d0\u05d5\u05ea\u05d9 ' +
                     '\u05de\u05d4 \u05d0\u05e0\u05d9 \u05e8\u05d5\u05e6' +
                     '\u05d4 \u05de\u05ea\u05e0\u05d4 \u05dc\u05d7\u05d2',
                     false));
    assertEquals(goog.i18n.bidi.Dir.RTL,
                 goog.i18n.bidi.estimateDirection(
                     '17.4.02 \u05e9\u05e2\u05d4:13-20 .15-00 .\u05dc\u05d0 ' +
                     '\u05d4\u05d9\u05d9\u05ea\u05d9 \u05db\u05d0\u05df.',
                     false));
    assertEquals(goog.i18n.bidi.Dir.RTL,
                 goog.i18n.bidi.estimateDirection(
                     '5710 5720 5730. \u05d4\u05d3\u05dc\u05ea. ' +
                     '\u05d4\u05e0\u05e9\u05d9\u05e7\u05d4', false));
    assertEquals(goog.i18n.bidi.Dir.RTL,
                 goog.i18n.bidi.estimateDirection(
                     '\u05d4\u05d3\u05dc\u05ea http://www.google.com ' +
                     'http://www.gmail.com', false));
    assertEquals(goog.i18n.bidi.Dir.LTR,
                 goog.i18n.bidi.estimateDirection(
                     '\u05d4\u05d3\u05dc <some quite nasty html mark up>',
                     false));
    assertEquals(goog.i18n.bidi.Dir.RTL,
                 goog.i18n.bidi.estimateDirection(
                     '\u05d4\u05d3\u05dc <some quite nasty html mark up>',
                     true));
    assertEquals(goog.i18n.bidi.Dir.LTR,
                 goog.i18n.bidi.estimateDirection(
                     '\u05d4\u05d3\u05dc\u05ea &amp; &lt; &gt;', false));
    assertEquals(goog.i18n.bidi.Dir.RTL,
                 goog.i18n.bidi.estimateDirection(
                     '\u05d4\u05d3\u05dc\u05ea &amp; &lt; &gt;', true));
  }

  var bidi_text = [];

  function testDetectRtlDirectionality() {
    InitializeSamples();
  for (var i = 0; i < bidi_text.length; i++) {
    //alert(bidi_text[i].text);
      var is_rtl = goog.i18n.bidi.detectRtlDirectionality(bidi_text[i].text,
                                                          bidi_text[i].isHtml);
    if (is_rtl != bidi_text[i].isRtl) {
        var str = '"' + bidi_text[i].text + '" should be ' +
                  (bidi_text[i].isRtl ? 'rtl' : 'ltr') + ' but detected as ' +
                  (is_rtl ? 'rtl' : 'ltr');
    alert(str);
      }
    assertEquals(bidi_text[i].isRtl, is_rtl);
    }
  }


  function SampleItem() {
    this.text = '';
    this.isRtl = false;
  }

  function InitializeSamples() {
    var item = new SampleItem;
    item.text = 'Pure Ascii content';
    item.isRtl = false;
    bidi_text.push(item);

    item = new SampleItem;
    item.text = '\u05d0\u05d9\u05df \u05de\u05de\u05e9 \u05de\u05d4 \u05dc\u05e8\u05d0\u05d5\u05ea: \u05dc\u05d0 \u05e6\u05d9\u05dc\u05de\u05ea\u05d9 \u05d4\u05e8\u05d1\u05d4 \u05d5\u05d2\u05dd \u05d0\u05dd \u05d4\u05d9\u05d9\u05ea\u05d9 \u05de\u05e6\u05dc\u05dd, \u05d4\u05d9\u05d4 \u05e9\u05dd';
    item.isRtl = true;
    bidi_text.push(item);

    item = new SampleItem;
    item.text = '\u05db\u05d0\u05df - http://geek.co.il/gallery/v/2007-06 - \u05d0\u05d9\u05df \u05de\u05de\u05e9 \u05de\u05d4 \u05dc\u05e8\u05d0\u05d5\u05ea: \u05dc\u05d0 \u05e6\u05d9\u05dc\u05de\u05ea\u05d9 \u05d4\u05e8\u05d1\u05d4 \u05d5\u05d2\u05dd \u05d0\u05dd \u05d4\u05d9\u05d9\u05ea\u05d9 \u05de\u05e6\u05dc\u05dd, \u05d4\u05d9\u05d4 \u05e9\u05dd \u05d1\u05e2\u05d9\u05e7\u05e8 \u05d4\u05e8\u05d1\u05d4 \u05d0\u05e0\u05e9\u05d9\u05dd. \u05de\u05d4 \u05e9\u05db\u05df - \u05d0\u05e4\u05e9\u05e8 \u05dc\u05e0\u05e6\u05dc \u05d0\u05ea \u05d4\u05d4\u05d3\u05d6\u05de\u05e0\u05d5\u05ea \u05dc\u05d4\u05e1\u05ea\u05db\u05dc \u05e2\u05dc \u05db\u05de\u05d4 \u05ea\u05de\u05d5\u05e0\u05d5\u05ea \u05de\u05e9\u05e2\u05e9\u05e2\u05d5\u05ea \u05d9\u05e9\u05e0\u05d5\u05ea \u05d9\u05d5\u05ea\u05e8 \u05e9\u05d9\u05e9 \u05dc\u05d9 \u05d1\u05d0\u05ea\u05e8';
    item.isRtl = true;
    bidi_text.push(item);

    item = new SampleItem;
    item.text = 'CAPTCHA \u05de\u05e9\u05d5\u05db\u05dc\u05dc \u05de\u05d3\u05d9?';
    item.isRtl = true;
    bidi_text.push(item);


    item = new SampleItem;
    item.text = 'Yes Prime Minister \u05e2\u05d3\u05db\u05d5\u05df. \u05e9\u05d0\u05dc\u05d5 \u05d0\u05d5\u05ea\u05d9 \u05de\u05d4 \u05d0\u05e0\u05d9 \u05e8\u05d5\u05e6\u05d4 \u05de\u05ea\u05e0\u05d4 \u05dc\u05d7\u05d2';
    item.isRtl = true;
    bidi_text.push(item);

    item = new SampleItem;
    item.text = '17.4.02 \u05e9\u05e2\u05d4:13-20 .15-00 .\u05dc\u05d0 \u05d4\u05d9\u05d9\u05ea\u05d9 \u05db\u05d0\u05df.';
    item.isRtl = true;
    bidi_text.push(item);

    item = new SampleItem;
    item.text = '5710 5720 5730. \u05d4\u05d3\u05dc\u05ea. \u05d4\u05e0\u05e9\u05d9\u05e7\u05d4';
    item.isRtl = true;
    bidi_text.push(item);

    item = new SampleItem;
    item.text = '\u05d4\u05d3\u05dc\u05ea http://www.google.com http://www.gmail.com';
    item.isRtl = true;
    bidi_text.push(item);

    item = new SampleItem;
    item.text = '&gt;\u05d4&lt;';
    item.isHtml = true;
    item.isRtl = true;
    bidi_text.push(item);

    item = new SampleItem;
    item.text = '&gt;\u05d4&lt;';
    item.isHtml = false;
    item.isRtl = false;
    bidi_text.push(item);

  }
">n/a</td></tr>
<tr><td>charlistdecompressor_test.html</td><td>Success</td><td> 6 passed, 0 failed.</td><td title="

  goog.require('goog.i18n.CharListDecompressor');
  goog.require('goog.testing.jsunit');


var decompressor = new goog.i18n.CharListDecompressor();

function testBuildCharMap() {
  assertEquals(0, decompressor.charMap_['0']);
  assertEquals(10, decompressor.charMap_['A']);
  assertEquals(87, decompressor.charMap_['}']);
}

function testGetCodeAt() {
  var code = decompressor.getCodeAt_('321', 1, 2);
  assertEquals(90, code);
}

function testAddCharsForType0() {
  var list = ['a'];
  var lastcode = decompressor.addChars_(list, 97, 0, 0);
  assertArrayEquals(['a', 'b'], list);
  assertEquals(98, lastcode);
}

function testAddCharsForType1() {
  var list = ['a'];
  var lastcode = decompressor.addChars_(list, 98, 0, 1);
  assertArrayEquals(['a', 'a'], list);
  assertEquals(97, lastcode);
}

function testAddCharsForType2() {
  var list = ['a'];
  var lastcode = decompressor.addChars_(list, 97, 1, 2);
  assertArrayEquals(['a', 'b', 'c'], list);
  assertEquals(99, lastcode);
}

function testToCharList() {
  var list = decompressor.toCharList('%812E<E'); // a, x-z, p-r
  assertArrayEquals(['a', 'x', 'y', 'z', 'p', 'q', 'r'], list);
}
">n/a</td></tr>
<tr><td>bidiformatter_test.html</td><td>Success</td><td> 13 passed, 0 failed.</td><td title="

  goog.require('goog.i18n.BidiFormatter');
  goog.require('goog.testing.jsunit');


  var LRM = goog.i18n.bidi.Format.LRM;
  var RLM = goog.i18n.bidi.Format.RLM;
  var LRE = goog.i18n.bidi.Format.LRE;
  var RLE = goog.i18n.bidi.Format.RLE;
  var PDF = goog.i18n.bidi.Format.PDF;
  var LTR = goog.i18n.bidi.Dir.LTR;
  var RTL = goog.i18n.bidi.Dir.RTL;
  var UNKNOWN = goog.i18n.bidi.Dir.UNKNOWN;
  var he = '\u05e0\u05e1';
  var en = 'abba';
  var html = '&lt;';
  var longEn = 'abba sabba gabba ';
  var longHe = '\u05e0 \u05e1 \u05e0 ';
  var ltrFmt = new goog.i18n.BidiFormatter(LTR,  false);  // LTR context
  var rtlFmt = new goog.i18n.BidiFormatter(RTL, false);  // RTL context
  var unkFmt = new goog.i18n.BidiFormatter(UNKNOWN,  false);  // unknown context

  function testEstimateDirection() {
    assertEquals(UNKNOWN, ltrFmt.estimateDirection(''));
    assertEquals(UNKNOWN, rtlFmt.estimateDirection(''));
    assertEquals(UNKNOWN, unkFmt.estimateDirection(''));
    assertEquals(LTR, ltrFmt.estimateDirection(en));
    assertEquals(LTR, rtlFmt.estimateDirection(en));
    assertEquals(LTR, unkFmt.estimateDirection(en));
    assertEquals(RTL, ltrFmt.estimateDirection(he));
    assertEquals(RTL, rtlFmt.estimateDirection(he));
    assertEquals(RTL, unkFmt.estimateDirection(he));

    // Text contains HTML or HTML-escaping.
    assertEquals(LTR, ltrFmt.estimateDirection(
        '<some sort of tag/>' + he + ' &amp;', false));
    assertEquals(RTL, ltrFmt.estimateDirection(
        '<some sort of tag/>' + he + ' &amp;', true));
  }

  function testDirAttrValue() {
    assertEquals('overall dir is RTL, context dir is LTR',
        'rtl', ltrFmt.dirAttrValue(he, true));
    assertEquals('overall dir and context dir are RTL',
        'rtl', rtlFmt.dirAttrValue(he, true));
    assertEquals('overall dir is LTR, context dir is RTL',
        'ltr', rtlFmt.dirAttrValue(en, true));
    assertEquals('overall dir and context dir are LTR',
        'ltr', ltrFmt.dirAttrValue(en, true));

    // Input's directionality is unknown.
    assertEquals('ltr', ltrFmt.dirAttrValue('', true));
    assertEquals('rtl', rtlFmt.dirAttrValue('', true));
    assertEquals('ltr', unkFmt.dirAttrValue('', true));

    // Text contains HTML or HTML-escaping:
    assertEquals('rtl',
        ltrFmt.dirAttrValue(he + "<some sort of an HTML tag>", true));
    assertEquals('ltr',
        ltrFmt.dirAttrValue(he + "<some sort of an HTML tag>", false));
  }

  function testKnownDirAttrValue() {
    assertEquals('rtl', ltrFmt.knownDirAttrValue(RTL));
    assertEquals('rtl', rtlFmt.knownDirAttrValue(RTL));
    assertEquals('ltr', rtlFmt.knownDirAttrValue(LTR));
    assertEquals('ltr', ltrFmt.knownDirAttrValue(LTR));

    // Input directionality is unknown.
    assertEquals('ltr', ltrFmt.knownDirAttrValue(UNKNOWN));
    assertEquals('rtl', rtlFmt.knownDirAttrValue(UNKNOWN));
    assertEquals('ltr', unkFmt.knownDirAttrValue(UNKNOWN));
  }

  function testDirAttr() {
    assertEquals('overall dir (RTL) doesnt match context dir (LTR)',
        'dir=rtl', ltrFmt.dirAttr(he, true));
    assertEquals('overall dir matches context dir (RTL)',
        '', rtlFmt.dirAttr(he, true));
    assertEquals('overall dir (LTR) doesnt match context dir (RTL)',
        'dir=ltr', rtlFmt.dirAttr(en, true));
    assertEquals('overall dir matches context dir (LTR)',
        '', ltrFmt.dirAttr(en, true));

    // Text contains HTML or HTML-escaping:
    assertEquals('dir=rtl',
        ltrFmt.dirAttr(he + "<some sort of an HTML tag>", true));
    assertEquals('',
        ltrFmt.dirAttr(he + "<some sort of an HTML tag>", false));
  }

  function testKnownDirAttr() {
    assertEquals('overall dir (RTL) doesnt match context dir (LTR)',
        'dir=rtl', ltrFmt.knownDirAttr(goog.i18n.bidi.Dir.RTL));
    assertEquals('overall dir matches context dir (RTL)',
        '', rtlFmt.knownDirAttr(goog.i18n.bidi.Dir.RTL));
    assertEquals('overall dir (LTR) doesnt match context dir (RTL)',
        'dir=ltr', rtlFmt.knownDirAttr(goog.i18n.bidi.Dir.LTR));
    assertEquals('overall dir matches context dir (LTR)',
        '', ltrFmt.knownDirAttr(goog.i18n.bidi.Dir.LTR));
  }

  function testSpanWrap() {
    // alwaysSpan is false and opt_isHtml is true, unless specified otherwise.
    assertEquals('overall dir matches context dir (LTR), no dirReset',
        en, ltrFmt.spanWrap(en, true, false));
    assertEquals('overall dir matches context dir (LTR), dirReset',
        en, ltrFmt.spanWrap(en, true, true));
    assertEquals('overall dir matches context dir (RTL), no dirReset',
        he, rtlFmt.spanWrap(he, true, false));
    assertEquals('overall dir matches context dir (RTL), dirReset',
        he, rtlFmt.spanWrap(he, true, true));

    assertEquals('overall dir (RTL) doesnt match context dir (LTR), ' +
        'no dirReset',
        '<span dir=rtl>' + he + '</span>', ltrFmt.spanWrap(he, true, false));
    assertEquals('overall dir (RTL) doesnt match context dir (LTR), dirReset',
        '<span dir=rtl>' + he + '</span>' + LRM,
        ltrFmt.spanWrap(he, true, true));
    assertEquals('overall dir (LTR) doesnt match context dir (RTL), ' +
        'no dirReset',
        '<span dir=ltr>' + en + '</span>', rtlFmt.spanWrap(en, true, false));
    assertEquals('overall dir (LTR) doesnt match context dir (RTL), dirReset',
        '<span dir=ltr>' + en + '</span>' + RLM,
        rtlFmt.spanWrap(en, true, true));
    assertEquals('overall dir (LTR) doesnt match context dir (unknown), ' +
        'no dirReset',
        '<span dir=ltr>' + en + '</span>', unkFmt.spanWrap(en, true, false));
    assertEquals('overall dir (RTL) doesnt match context dir (unknown), ' +
        'dirReset',
        '<span dir=rtl>' + he + '</span>', unkFmt.spanWrap(he, true, true));
    assertEquals('overall dir (neutral) doesnt match context dir (LTR), ' +
        'dirReset',
        '',
        ltrFmt.spanWrap('', true, true));

    assertEquals('exit dir (but not overall dir) is opposite to context dir, ' +
        'dirReset',
        longEn + he + html + LRM,
        ltrFmt.spanWrap(longEn + he + html, true, true));
    assertEquals('overall dir (but not exit dir) is opposite to context dir, ' +
        'dirReset',
        '<span dir=ltr>' + longEn + he + '</span>' + RLM,
        rtlFmt.spanWrap(longEn + he, true, true));

    assertEquals('input is plain text (not escaped)',
        '&lt;br&gt;' + en,
        ltrFmt.spanWrap('<br>' + en, false, false));

    var ltrAlwaysSpanFmt = new goog.i18n.BidiFormatter(LTR,  true);
    var rtlAlwaysSpanFmt = new goog.i18n.BidiFormatter(RTL, true);
    var unkAlwaysSpanFmt = new goog.i18n.BidiFormatter(UNKNOWN,  true);

    assertEquals('alwaysSpan, overall dir matches context dir (LTR), ' +
        'no dirReset',
        '<span>' + en + '</span>', ltrAlwaysSpanFmt.spanWrap(en, true, false));
    assertEquals('alwaysSpan, overall dir matches context dir (LTR), dirReset',
        '<span>' + en + '</span>', ltrAlwaysSpanFmt.spanWrap(en, true, true));
    assertEquals('alwaysSpan, overall dir matches context dir (RTL), ' +
        'no dirReset',
        '<span>' + he + '</span>', rtlAlwaysSpanFmt.spanWrap(he, true, false));
    assertEquals('alwaysSpan, overall dir matches context dir (RTL), dirReset',
        '<span>' + he + '</span>', rtlAlwaysSpanFmt.spanWrap(he, true, true));

    assertEquals('alwaysSpan, overall dir (RTL) doesnt match ' +
        'context dir (LTR), no dirReset',
        '<span dir=rtl>' + he + '</span>',
        ltrAlwaysSpanFmt.spanWrap(he, true, false));
    assertEquals('alwaysSpan, overall dir (RTL) doesnt match ' +
        'context dir (LTR), dirReset',
        '<span dir=rtl>' + he + '</span>' + LRM,
        ltrAlwaysSpanFmt.spanWrap(he, true, true));
    assertEquals('alwaysSpan, overall dir (neutral) doesnt match ' +
        'context dir (LTR), dirReset',
        '<span></span>',
        ltrAlwaysSpanFmt.spanWrap('', true, true));
  }

  function testSpanWrapWithKnownDir() {
    assertEquals('overall dir matches context dir (LTR)',
        en, ltrFmt.spanWrapWithKnownDir(goog.i18n.bidi.Dir.LTR, en));
    assertEquals(
        'overall dir (but not exit dir) supposedly matches context dir (LTR)',
        he + LRM, ltrFmt.spanWrapWithKnownDir(goog.i18n.bidi.Dir.LTR, he));
    assertEquals('overall dir matches context dir (RTL)',
        he, rtlFmt.spanWrapWithKnownDir(goog.i18n.bidi.Dir.RTL, he));
    assertEquals(
        'overall dir (but not exit dir) supposedly matches context dir (RTL)',
        en + RLM, rtlFmt.spanWrapWithKnownDir(goog.i18n.bidi.Dir.RTL, en));

    assertEquals('overall dir (RTL) doesnt match context dir (LTR)',
        '<span dir=rtl>' + he + '</span>' + LRM,
        ltrFmt.spanWrapWithKnownDir(goog.i18n.bidi.Dir.RTL, he));
    assertEquals('supposed overall dir (RTL) doesnt match context dir (LTR)',
        '<span dir=rtl>' + en + '</span>' + LRM,
        ltrFmt.spanWrapWithKnownDir(goog.i18n.bidi.Dir.RTL, en));
    assertEquals('overall dir (LTR) doesnt match context dir (RTL)',
        '<span dir=ltr>' + en + '</span>' + RLM,
        rtlFmt.spanWrapWithKnownDir(goog.i18n.bidi.Dir.LTR, en));
    assertEquals('supposed overall dir (LTR) doesnt match context dir (RTL)',
        '<span dir=ltr>' + he + '</span>' + RLM,
        rtlFmt.spanWrapWithKnownDir(goog.i18n.bidi.Dir.LTR, he));
    assertEquals(
        'supposed overall dir (LTR) doesnt match context dir (unknown)',
        '<span dir=ltr>' + he + '</span>',
        unkFmt.spanWrapWithKnownDir(goog.i18n.bidi.Dir.LTR, he));
    assertEquals(
        'supposed overall dir (neutral) doesnt match context dir (LTR)',
        he + LRM,
        ltrFmt.spanWrapWithKnownDir(goog.i18n.bidi.Dir.UNKNOWN, he));
  }

  function testUnicodeWrap() {
    // opt_isHtml is true, unless specified otherwise.
    assertEquals('overall dir matches context dir (LTR), no dirReset',
        en, ltrFmt.unicodeWrap(en, true, false));
    assertEquals('overall dir matches context dir (LTR), dirReset',
        en, ltrFmt.unicodeWrap(en, true, true));
    assertEquals('overall dir matches context dir (RTL), no dirReset',
        he, rtlFmt.unicodeWrap(he, true, false));
    assertEquals('overall dir matches context dir (RTL), dirReset',
        he, rtlFmt.unicodeWrap(he, true, true));

    assertEquals('overall dir (RTL) doesnt match context dir (LTR), ' +
        'no dirReset',
        RLE + he + PDF, ltrFmt.unicodeWrap(he, true, false));
    assertEquals('overall dir (RTL) doesnt match context dir (LTR), dirReset',
        RLE + he + PDF + LRM, ltrFmt.unicodeWrap(he, true, true));
    assertEquals('overall dir (LTR) doesnt match context dir (RTL), ' +
        'no dirReset',
        LRE + en + PDF, rtlFmt.unicodeWrap(en, true, false));
    assertEquals('overall dir (LTR) doesnt match context dir (RTL), dirReset',
        LRE + en + PDF + RLM, rtlFmt.unicodeWrap(en, true, true));
    assertEquals('overall dir (LTR) doesnt match context dir (unknown), ' +
        'no dirReset',
        LRE + en + PDF, unkFmt.unicodeWrap(en, true, false));
    assertEquals('overall dir (RTL) doesnt match context dir (unknown), ' +
        'dirReset',
        RLE + he + PDF, unkFmt.unicodeWrap(he, true, true));
    assertEquals('overall dir (neutral) doesnt match context dir (LTR), ' +
        'dirReset',
        '',
        ltrFmt.unicodeWrap('', true, true));

    assertEquals('exit dir (but not overall dir) is opposite to context dir, ' +
        'dirReset',
        longEn + he + html + LRM,
        ltrFmt.unicodeWrap(longEn + he + html, true, true));
    assertEquals('overall dir (but not exit dir) is opposite to context dir, ' +
        'dirReset',
        LRE + longEn + he + PDF + RLM,
        rtlFmt.unicodeWrap(longEn + he, true, true));
  }

  function testUnicodeWrapWithKnownDir() {
    assertEquals('overall dir matches context dir (LTR)',
        en, ltrFmt.unicodeWrapWithKnownDir(goog.i18n.bidi.Dir.LTR, en));
    assertEquals(
        'overall dir (but not exit dir) supposedly matches context dir (LTR)',
        he + LRM, ltrFmt.unicodeWrapWithKnownDir(goog.i18n.bidi.Dir.LTR, he));
    assertEquals('overall dir matches context dir (RTL)',
        he, rtlFmt.unicodeWrapWithKnownDir(goog.i18n.bidi.Dir.RTL, he));
    assertEquals(
        'overall dir (but not exit dir) supposedly matches context dir (RTL)',
        en + RLM, rtlFmt.unicodeWrapWithKnownDir(goog.i18n.bidi.Dir.RTL, en));

    assertEquals('overall dir (RTL) doesnt match context dir (LTR)',
        RLE + he + PDF + LRM,
        ltrFmt.unicodeWrapWithKnownDir(goog.i18n.bidi.Dir.RTL, he));
    assertEquals('supposed overall dir (RTL) doesnt match context dir (LTR)',
        RLE + en + PDF + LRM,
        ltrFmt.unicodeWrapWithKnownDir(goog.i18n.bidi.Dir.RTL, en));
    assertEquals('overall dir (LTR) doesnt match context dir (RTL)',
        LRE + en + PDF + RLM,
        rtlFmt.unicodeWrapWithKnownDir(goog.i18n.bidi.Dir.LTR, en));
    assertEquals('supposed overall dir (LTR) doesnt match context dir (RTL)',
        LRE + he + PDF + RLM,
        rtlFmt.unicodeWrapWithKnownDir(goog.i18n.bidi.Dir.LTR, he));
    assertEquals(
        'supposed overall dir (LTR) doesnt match context dir (unknown)',
        LRE + he + PDF,
        unkFmt.unicodeWrapWithKnownDir(goog.i18n.bidi.Dir.LTR, he));
    assertEquals(
        'supposed overall dir (neutral) doesnt match context dir (LTR)',
        he + LRM,
        ltrFmt.unicodeWrapWithKnownDir(goog.i18n.bidi.Dir.UNKNOWN, he));
  }

  function testMarkAfter() {
    assertEquals('exit dir (RTL) is opposite to context dir (LTR)',
        LRM, ltrFmt.markAfter(longEn + he + html, true));
    assertEquals('exit dir (LTR) is opposite to context dir (RTL)',
        RLM, rtlFmt.markAfter(longHe + en, true));
    assertEquals('exit dir (LTR) doesnt match context dir (unknown)',
        '', unkFmt.markAfter(longEn + en, true));
    assertEquals('overall dir (RTL) is opposite to context dir (LTR)',
        LRM, ltrFmt.markAfter(longHe + en, true));
    assertEquals('overall dir (LTR) is opposite to context dir (RTL)',
        RLM, rtlFmt.markAfter(longEn + he, true));
    assertEquals('exit dir and overall dir match context dir (LTR)',
        '', ltrFmt.markAfter(longEn + he + html, false));
    assertEquals('exit dir and overall dir matches context dir (RTL)',
        '', rtlFmt.markAfter(longHe + he, true));
  }

  function testMark() {
    // Implicitly, also tests the constructor.
    assertEquals(LRM, (new goog.i18n.BidiFormatter(LTR)).mark());
    assertEquals('',  (new goog.i18n.BidiFormatter(UNKNOWN)).mark());
    assertEquals(RLM, (new goog.i18n.BidiFormatter(RTL)).mark());
    assertEquals(RLM, (new goog.i18n.BidiFormatter(true)).mark());
    assertEquals(LRM, (new goog.i18n.BidiFormatter(false)).mark());
  }

  function testStartEdge() {
    assertEquals('left', ltrFmt.startEdge());
    assertEquals('left',  unkFmt.startEdge());
    assertEquals('right', rtlFmt.startEdge());
  }

  function testEndEdge() {
    assertEquals('right', ltrFmt.endEdge());
    assertEquals('right',  unkFmt.endEdge());
    assertEquals('left', rtlFmt.endEdge());
  }

">n/a</td></tr>
<tr><td>timezone_test.html</td><td>Success</td><td> 6 passed, 0 failed.</td><td title="

  goog.require('goog.i18n.TimeZone');
  goog.require('goog.testing.jsunit');


  // Where could such data be found
  // In js_i18n_data in http://go/i18n_dir, we have a bunch of files with names
  // like TimeZoneConstant__<locale>.js
  // We strongly discourage you to use them directly as those data can make
  // your client code bloated. You should try to provide this data from server
  // in a selective manner. In typical scenario, user's time zone is retrieved
  // and only data for that time zone should be provided.
  // This piece of data is in JSON format. It requires double quote.
  var americaLosAngelesData = {
    'transitions': [
      2770, 60, 7137, 0, 11506, 60, 16041, 0, 20410, 60, 24777, 0, 29146, 60,
      33513, 0, 35194, 60, 42249, 0, 45106, 60, 50985, 0, 55354, 60, 59889, 0,
      64090, 60, 68625, 0, 72994, 60, 77361, 0, 81730, 60, 86097, 0, 90466, 60,
      94833, 0, 99202, 60, 103569, 0, 107938, 60, 112473, 0, 116674, 60, 121209,
      0, 125578, 60, 129945, 0, 134314, 60, 138681, 0, 143050, 60, 147417, 0,
      151282, 60, 156153, 0, 160018, 60, 165057, 0, 168754, 60, 173793, 0,
      177490, 60, 182529, 0, 186394, 60, 191265, 0, 195130, 60, 200001, 0,
      203866, 60, 208905, 0, 212602, 60, 217641, 0, 221338, 60, 226377, 0,
      230242, 60, 235113, 0, 238978, 60, 243849, 0, 247714, 60, 252585, 0,
      256450, 60, 261489, 0, 265186, 60, 270225, 0, 273922, 60, 278961, 0,
      282826, 60, 287697, 0, 291562, 60, 296433, 0, 300298, 60, 305337, 0,
      309034, 60, 314073, 0, 317770, 60, 322809, 0, 326002, 60, 331713, 0,
      334738, 60, 340449, 0, 343474, 60, 349185, 0, 352378, 60, 358089, 0,
      361114, 60, 366825, 0, 369850, 60, 375561, 0, 378586, 60, 384297, 0,
      387322, 60, 393033, 0, 396058, 60, 401769, 0, 404962, 60, 410673, 0,
      413698, 60, 419409, 0, 422434, 60, 428145, 0, 431170, 60, 436881, 0,
      439906, 60, 445617, 0, 448810, 60, 454521, 0, 457546, 60, 463257, 0,
      466282, 60, 471993, 0, 475018, 60, 480729, 0, 483754, 60, 489465, 0,
      492490, 60, 498201, 0, 501394, 60, 507105, 0, 510130, 60, 515841, 0,
      518866, 60, 524577, 0, 527602, 60, 533313, 0, 536338, 60, 542049, 0,
      545242, 60, 550953, 0, 553978, 60, 559689, 0, 562714, 60, 568425, 0,
      571450, 60, 577161, 0, 580186, 60, 585897, 0, 588922, 60, 594633, 0
    ],
    'names': ['PST', 'Pacific Standard Time', 'PDT', 'Pacific Daylight Time'],
    'id': 'America/Los_Angeles',
    'std_offset': -480
  };

  function testIsDaylightTime() {
    var usPacific = goog.i18n.TimeZone.createTimeZone(americaLosAngelesData);
    var dt = new Date(2007, 7 - 1, 1);
    assertTrue(usPacific.isDaylightTime(dt));
    // 2007/03/11 2:00am has daylight change. We set time through UTC so that
    // this test won't be affected by browser's local time handling.
    dt = new Date(2007, 3 - 1, 11);
    // The date above is created with a timezone of the computer it is run on.
    // Therefore the UTC day has to be set explicitly to be sure that the date
    // is correct for timezones east of Greenwich  where 2007/3/11 0:00 is still
    // 2007/03/10 in UTC.
    dt.setUTCDate(11);
    dt.setUTCHours(2 + 8);
    dt.setMinutes(1);
    assertTrue(usPacific.isDaylightTime(dt));
    dt.setUTCHours(1 + 8);
    dt.setMinutes(59)
    assertTrue(!usPacific.isDaylightTime(dt));

    dt = new Date(2007, 11 - 1, 4);
    // Set the UTC day explicitly to make it work in timezones east of
    // Greenwich.
    dt.setUTCDate(4);
    dt.setUTCHours(2+7);
    dt.setMinutes(1);
    assertTrue(!usPacific.isDaylightTime(dt));

    // there seems to be a browser bug. local time 1:59am should still be PDT.
    dt.setUTCHours(0 + 7);
    dt.setMinutes(59)
    assertTrue(usPacific.isDaylightTime(dt));
  }

  function testGetters() {
    var date = new Date();
    var usPacific = goog.i18n.TimeZone.createTimeZone(americaLosAngelesData);
    if (usPacific.isDaylightTime(date)) {
      assertEquals(420, usPacific.getOffset(date));
    } else {
      assertEquals(480, usPacific.getOffset(date));
    }
    assertEquals('America/Los_Angeles', usPacific.getTimeZoneId());
    assertObjectEquals(americaLosAngelesData, usPacific.getTimeZoneData());
  }

  function testNames() {
    var usPacific = goog.i18n.TimeZone.createTimeZone(americaLosAngelesData);
    var dt = new Date(2007, 7 - 1, 1);
    assertTrue(usPacific.isDaylightTime(dt));
    assertEquals('PDT', usPacific.getShortName(dt));
    assertEquals('Pacific Daylight Time', usPacific.getLongName(dt));

    dt = new Date(2007, 12 - 1, 1);
    assertTrue(!usPacific.isDaylightTime(dt));
    assertEquals('PST', usPacific.getShortName(dt));
    assertEquals('Pacific Standard Time', usPacific.getLongName(dt));
  }

  function testSimpleTimeZonePositive() {
    var date = new Date();
    var simpleTimeZone = goog.i18n.TimeZone.createTimeZone(480);
    assertEquals(480, simpleTimeZone.getOffset(date));
    assertEquals('GMT-08:00', simpleTimeZone.getGMTString(date));
    assertEquals('Etc/GMT+8', simpleTimeZone.getTimeZoneId());
    assertEquals('UTC-8', simpleTimeZone.getLongName(date));
    assertEquals('UTC-8', simpleTimeZone.getShortName(date));
    assertEquals('-0800', simpleTimeZone.getRFCTimeZoneString(date));
    assertEquals(false, simpleTimeZone.isDaylightTime(date));

    simpleTimeZone = goog.i18n.TimeZone.createTimeZone(630);
    assertEquals(630, simpleTimeZone.getOffset(date));
    assertEquals('GMT-10:30', simpleTimeZone.getGMTString(date));
    assertEquals('Etc/GMT+10:30', simpleTimeZone.getTimeZoneId());
    assertEquals('UTC-10:30', simpleTimeZone.getLongName(date));
    assertEquals('UTC-10:30', simpleTimeZone.getShortName(date));
    assertEquals('-1030', simpleTimeZone.getRFCTimeZoneString(date));
    assertEquals(false, simpleTimeZone.isDaylightTime(date));
  }

  function testSimpleTimeZoneNegative() {
    var date = new Date();
    var simpleTimeZone = goog.i18n.TimeZone.createTimeZone(-480);
    assertEquals(-480, simpleTimeZone.getOffset(date));
    assertEquals('GMT+08:00', simpleTimeZone.getGMTString(date));
    assertEquals('Etc/GMT-8', simpleTimeZone.getTimeZoneId());
    assertEquals('UTC+8', simpleTimeZone.getLongName(date));
    assertEquals('UTC+8', simpleTimeZone.getShortName(date));
    assertEquals('+0800', simpleTimeZone.getRFCTimeZoneString(date));
    assertEquals(false, simpleTimeZone.isDaylightTime(date));
  }

  function testSimpleTimeZoneZero() {
    var date = new Date();
    var simpleTimeZone = goog.i18n.TimeZone.createTimeZone(0);
    assertEquals(0, simpleTimeZone.getOffset(date));
    assertEquals('GMT+00:00', simpleTimeZone.getGMTString(date));
    assertEquals('Etc/GMT', simpleTimeZone.getTimeZoneId());
    assertEquals('UTC', simpleTimeZone.getLongName(date));
    assertEquals('UTC', simpleTimeZone.getShortName(date));
    assertEquals('+0000', simpleTimeZone.getRFCTimeZoneString(date));
    assertEquals(false, simpleTimeZone.isDaylightTime(date));
  }

">n/a</td></tr>
<tr><td>numberformat_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.i18n.NumberFormat');
  goog.require('goog.i18n.NumberFormatSymbols');
  goog.require('goog.i18n.NumberFormatSymbols_fr');
  goog.require('goog.testing.ExpectedFailures');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');
  goog.require('goog.userAgent.product');
  goog.require('goog.userAgent.product.isVersion');



var expectedFailures = new goog.testing.ExpectedFailures();

function tearDown() {
  expectedFailures.handleTearDown();
}

function veryBigNumberCompare(str1, str2) {
  return str1.length == str2.length &&
         str1.substring(0, 8) == str2.substring(0, 8);
}

function testVeryBigNumber() {
  var str;
  var fmt = new goog.i18n.NumberFormat(goog.i18n.NumberFormat.Format.CURRENCY);
  str = fmt.format(1785599999999999888888888888888);
  // when comparing big number, various platform have small different in
  // precision. We have to tolerate that using veryBigNumberCompare.
  var expected = '$1,785,599,999,999,999,400,000,000,000,000.00';
  assertTrue(veryBigNumberCompare(
      '$1,785,599,999,999,999,400,000,000,000,000.00', str));
  str = fmt.format(1.7856E30);
  assertTrue(veryBigNumberCompare(
      '$1,785,599,999,999,999,400,000,000,000,000.00', str));
  str = fmt.format(1.3456E20);
  assertTrue(veryBigNumberCompare('$134,560,000,000,000,000,000.00', str));

  fmt = new goog.i18n.NumberFormat(goog.i18n.NumberFormat.Format.DECIMAL);
  str = fmt.format(1.3456E20);
  assertTrue(veryBigNumberCompare('134,559,999,999,999,980,000', str));


  fmt = new goog.i18n.NumberFormat(goog.i18n.NumberFormat.Format.PERCENT);
  str = fmt.format(1.3456E20);
  assertTrue(veryBigNumberCompare('13,456,000,000,000,000,000,000%', str));

  fmt = new goog.i18n.NumberFormat(
      goog.i18n.NumberFormat.Format.SCIENTIFIC);
  str = fmt.format(1.3456E20);
  assertEquals('1E20', str);
}

function testStandardFormat() {
  var str;
  var fmt = new goog.i18n.NumberFormat(
      goog.i18n.NumberFormat.Format.CURRENCY);
  str = fmt.format(1234.579);
  assertEquals('$1,234.58', str);
  fmt = new goog.i18n.NumberFormat(goog.i18n.NumberFormat.Format.DECIMAL);
  str = fmt.format(1234.579);
  assertEquals('1,234.579', str);
  fmt = new goog.i18n.NumberFormat(goog.i18n.NumberFormat.Format.PERCENT);
  str = fmt.format(1234.579);
  assertEquals('123,458%', str);
  fmt = new goog.i18n.NumberFormat(goog.i18n.NumberFormat.Format.SCIENTIFIC);
  str = fmt.format(1234.579);
  assertEquals('1E3', str);
}

function testNegativePercentage() {
  var str;
  var fmt = new goog.i18n.NumberFormat('#,##0.00%');
  str = fmt.format(-1234.56);
  assertEquals('-123,456.00%', str);

  fmt = new goog.i18n.NumberFormat(goog.i18n.NumberFormat.Format.PERCENT);
  str = fmt.format(-1234.579);
  assertEquals('-123,458%', str);
}

function testBasicParse() {
  var value;

  var fmt = new goog.i18n.NumberFormat('0.0000');
  value = fmt.parse('123.4579');
  assertEquals(123.4579, value);

  value = fmt.parse('+123.4579');
  assertEquals(123.4579, value);

  value = fmt.parse('-123.4579');
  assertEquals(-123.4579, value);
}

function testPrefixParse() {
  var value;

  var fmt = new goog.i18n.NumberFormat('0.0;(0.0)');
  value = fmt.parse('123.4579');
  assertEquals(123.4579, value);

  value = fmt.parse('(123.4579)');
  assertEquals(-123.4579, value);
}

function testPrecentParse() {
  var value;

  var fmt = new goog.i18n.NumberFormat('0.0;(0.0)');
  value = fmt.parse('123.4579%');
  assertEquals((123.4579/100), value);

  value = fmt.parse('(%123.4579)');
  assertEquals((-123.4579/100), value);

  value = fmt.parse('123.4579\u2030');
  assertEquals((123.4579/1000), value);

  value = fmt.parse('(\u2030123.4579)');
  assertEquals((-123.4579/1000), value);
}

function testPercentAndPerMillAdvance() {
  var value;
  var pos = [0];
  var fmt = new goog.i18n.NumberFormat('0');
  value = fmt.parse('120%', pos);
  assertEquals(1.2, value);
  assertEquals(4, pos[0]);
  pos[0] = 0;
  value = fmt.parse('120\u2030', pos);
  assertEquals(0.12, value);
  assertEquals(4, pos[0]);
}

function testInfinityParse() {
  var value;
  var fmt = new goog.i18n.NumberFormat('0.0;(0.0)');

  // gwt need to add those symbols first
  value = fmt.parse('\u221e');
  assertEquals(Number.POSITIVE_INFINITY, value);

  value = fmt.parse('(\u221e)');
  assertEquals(Number.NEGATIVE_INFINITY, value);
}
function testExponentParse() {
  var value;
  var fmt;

  fmt = new goog.i18n.NumberFormat('#E0');
  value = fmt.parse('1.234E3');
  assertEquals(1.234E+3, value);

  fmt = new goog.i18n.NumberFormat('0.###E0');
  value = fmt.parse('1.234E3');
  assertEquals(1.234E+3, value);

  fmt = new goog.i18n.NumberFormat('#E0');
  value = fmt.parse('1.2345E4');
  assertEquals(12345.0, value);

  value = fmt.parse('1.2345E4');
  assertEquals(12345.0, value);

  value = fmt.parse('1.2345E+4');
  assertEquals(12345.0, value);
}

function testGroupingParse() {
  var value;

  var fmt = new goog.i18n.NumberFormat('#,###');
  value = fmt.parse('1,234,567,890');
  assertEquals(1234567890, value);
  value = fmt.parse('12,3456,7890');
  assertEquals(1234567890, value);

  fmt = new goog.i18n.NumberFormat('#');
  value = fmt.parse('1234567890');
  assertEquals(1234567890, value);
}

function testBasicFormat() {
  var fmt = new goog.i18n.NumberFormat('0.0000');
  var str = fmt.format(123.45789179565757);
  assertEquals('123.4579', str);
}

function testGrouping() {
  var str;

  var fmt = new goog.i18n.NumberFormat('#,###');
  str = fmt.format(1234567890);
  assertEquals('1,234,567,890', str);
  fmt = new goog.i18n.NumberFormat('#,####');
  str = fmt.format(1234567890);
  assertEquals('12,3456,7890', str);

  fmt = new goog.i18n.NumberFormat('#');
  str = fmt.format(1234567890);
  assertEquals('1234567890', str);
}

function testPerMill() {
  var str;

  var fmt = new goog.i18n.NumberFormat('###.###\u2030');
  str = fmt.format(0.4857);
  assertEquals('485.7\u2030', str);
}

function testCurrency() {
  var str;

  var fmt = new goog.i18n.NumberFormat('\u00a4#,##0.00;-\u00a4#,##0.00');
  str = fmt.format(1234.56);
  assertEquals('$1,234.56', str);
  str = fmt.format(-1234.56);
  assertEquals('-$1,234.56', str);

  fmt = new goog.i18n.NumberFormat(
      '\u00a4\u00a4 #,##0.00;-\u00a4\u00a4 #,##0.00');
  str = fmt.format(1234.56);
  assertEquals('USD 1,234.56', str);
  fmt = new goog.i18n.NumberFormat(
      '\u00a4\u00a4 #,##0.00;\u00a4\u00a4 -#,##0.00');
  str = fmt.format(-1234.56);
  assertEquals('USD -1,234.56', str);

  fmt = new goog.i18n.NumberFormat('\u00a4#,##0.00;-\u00a4#,##0.00', 'BRL');
  str = fmt.format(1234.56);
  assertEquals('R$1,234.56', str);
  str = fmt.format(-1234.56);
  assertEquals('-R$1,234.56', str);

  fmt = new goog.i18n.NumberFormat(
      '\u00a4\u00a4 #,##0.00;(\u00a4\u00a4 #,##0.00)', 'BRL');
  str = fmt.format(1234.56);
  assertEquals('BRL 1,234.56', str);
  str = fmt.format(-1234.56);
  assertEquals('(BRL 1,234.56)', str);
}

function testQuotes() {
  var str;

  var fmt = new goog.i18n.NumberFormat('a\'fo\'\'o\'b#');
  str = fmt.format(123);
  assertEquals('afo\'ob123', str);

  fmt = new goog.i18n.NumberFormat('a\'\'b#');
  str = fmt.format(123);
  assertEquals('a\'b123', str);

  fmt = new goog.i18n.NumberFormat('a\'fo\'\'o\'b#');
  str = fmt.format(-123);
  assertEquals('afo\'ob-123', str);

  fmt = new goog.i18n.NumberFormat('a\'\'b#');
  str = fmt.format(-123);
  assertEquals('a\'b-123', str);
}

function testZeros() {
  var str;
  var fmt;

  fmt = new goog.i18n.NumberFormat('#.#');
  str = fmt.format(0);
  assertEquals('0', str);
  fmt = new goog.i18n.NumberFormat('#.');
  str = fmt.format(0);
  assertEquals('0.', str);
  fmt = new goog.i18n.NumberFormat('.#');
  str = fmt.format(0);
  assertEquals('.0', str);
  fmt = new goog.i18n.NumberFormat('#');
  str = fmt.format(0);
  assertEquals('0', str);

  fmt = new goog.i18n.NumberFormat('#0.#');
  str = fmt.format(0);
  assertEquals('0', str);
  fmt = new goog.i18n.NumberFormat('#0.');
  str = fmt.format(0);
  assertEquals('0.', str);
  fmt = new goog.i18n.NumberFormat('#.0');
  str = fmt.format(0);
  assertEquals('.0', str);
  fmt = new goog.i18n.NumberFormat('#');
  str = fmt.format(0);
  assertEquals('0', str);
  fmt = new goog.i18n.NumberFormat('000');
  str = fmt.format(0);
  assertEquals('000', str);
}

function testExponential() {
  var str;
  var fmt;

  fmt = new goog.i18n.NumberFormat('0.####E0');
  str = fmt.format(0.01234);
  assertEquals('1.234E-2', str);
  fmt = new goog.i18n.NumberFormat('00.000E00');
  str = fmt.format(0.01234);
  assertEquals('12.340E-03', str);
  fmt = new goog.i18n.NumberFormat('##0.######E000');
  str = fmt.format(0.01234);
  assertEquals('12.34E-003', str);
  fmt = new goog.i18n.NumberFormat('0.###E0;[0.###E0]');
  str = fmt.format(0.01234);
  assertEquals('1.234E-2', str);

  fmt = new goog.i18n.NumberFormat('0.####E0');
  str = fmt.format(123456789);
  assertEquals('1.2346E8', str);
  fmt = new goog.i18n.NumberFormat('00.000E00');
  str = fmt.format(123456789);
  assertEquals('12.346E07', str);
  fmt = new goog.i18n.NumberFormat('##0.######E000');
  str = fmt.format(123456789);
  assertEquals('123.456789E006', str);
  fmt = new goog.i18n.NumberFormat('0.###E0;[0.###E0]');
  str = fmt.format(123456789);
  assertEquals('1.235E8', str);

  fmt = new goog.i18n.NumberFormat('0.####E0');
  str = fmt.format(1.23e300);
  assertEquals('1.23E300', str);
  fmt = new goog.i18n.NumberFormat('00.000E00');
  str = fmt.format(1.23e300);
  assertEquals('12.300E299', str);
  fmt = new goog.i18n.NumberFormat('##0.######E000');
  str = fmt.format(1.23e300);
  assertEquals('1.23E300', str);
  fmt = new goog.i18n.NumberFormat('0.###E0;[0.###E0]');
  str = fmt.format(1.23e300);
  assertEquals('1.23E300', str);

  fmt = new goog.i18n.NumberFormat('0.####E0');
  str = fmt.format(-3.141592653e-271);
  assertEquals('-3.1416E-271', str);
  fmt = new goog.i18n.NumberFormat('00.000E00');
  str = fmt.format(-3.141592653e-271);
  assertEquals('-31.416E-272', str);
  fmt = new goog.i18n.NumberFormat('##0.######E000');
  str = fmt.format(-3.141592653e-271);
  assertEquals('-314.159265E-273', str);
  fmt = new goog.i18n.NumberFormat('0.###E0;[0.###E0]');
  str = fmt.format(-3.141592653e-271);
  assertEquals('[3.142E-271]', str);

  fmt = new goog.i18n.NumberFormat('0.####E0');
  str = fmt.format(0);
  assertEquals('0E0', str);
  fmt = new goog.i18n.NumberFormat('00.000E00');
  str = fmt.format(0);
  assertEquals('00.000E00', str);
  fmt = new goog.i18n.NumberFormat('##0.######E000');
  str = fmt.format(0);
  assertEquals('0E000', str);
  fmt = new goog.i18n.NumberFormat('0.###E0;[0.###E0]');
  str = fmt.format(0);
  assertEquals('0E0', str);

  fmt = new goog.i18n.NumberFormat('0.####E0');
  str = fmt.format(-1);
  assertEquals('-1E0', str);
  fmt = new goog.i18n.NumberFormat('00.000E00');
  str = fmt.format(-1);
  assertEquals('-10.000E-01', str);
  fmt = new goog.i18n.NumberFormat('##0.######E000');
  str = fmt.format(-1);
  assertEquals('-1E000', str);
  fmt = new goog.i18n.NumberFormat('0.###E0;[0.###E0]');
  str = fmt.format(-1);
  assertEquals('[1E0]', str);

  fmt = new goog.i18n.NumberFormat('0.####E0');
  str = fmt.format(1);
  assertEquals('1E0', str);
  fmt = new goog.i18n.NumberFormat('00.000E00');
  str = fmt.format(1);
  assertEquals('10.000E-01', str);
  fmt = new goog.i18n.NumberFormat('##0.######E000');
  str = fmt.format(1);
  assertEquals('1E000', str);
  fmt = new goog.i18n.NumberFormat('0.###E0;[0.###E0]');
  str = fmt.format(1);
  assertEquals('1E0', str);

  fmt = new goog.i18n.NumberFormat('#E0');
  str = fmt.format(12345.0);
  assertEquals('1E4', str);
  fmt = new goog.i18n.NumberFormat('0E0');
  str = fmt.format(12345.0);
  assertEquals('1E4', str);
  fmt = new goog.i18n.NumberFormat('##0.###E0');
  str = fmt.format(12345.0);
  assertEquals('12.345E3', str);
  fmt = new goog.i18n.NumberFormat('##0.###E0');
  str = fmt.format(12345.00001);
  assertEquals('12.345E3', str);
  fmt = new goog.i18n.NumberFormat('##0.###E0');
  str = fmt.format(12345);
  assertEquals('12.345E3', str);

  fmt = new goog.i18n.NumberFormat('##0.####E0');
  str = fmt.format(789.12345e-9);
  // Firefox 3.6.3 Linux is known to fail here with a rounding error.
  // fmt.format will return '789.1234E-9'.
  expectedFailures.expectFailureFor(isFirefox363Linux());
  try {
    assertEquals('789.1235E-9', str);
  } catch (e) {
    expectedFailures.handleException(e);
  }
  fmt = new goog.i18n.NumberFormat('##0.####E0');
  str = fmt.format(780.e-9);
  assertEquals('780E-9', str);
  fmt = new goog.i18n.NumberFormat('.###E0');
  str = fmt.format(45678.0);
  assertEquals('.457E5', str);
  fmt = new goog.i18n.NumberFormat('.###E0');
  str = fmt.format(0);
  assertEquals('.0E0', str);

  fmt = new goog.i18n.NumberFormat('#E0');
  str = fmt.format(45678000);
  assertEquals('5E7', str);
  fmt = new goog.i18n.NumberFormat('##E0');
  str = fmt.format(45678000);
  assertEquals('46E6', str);
  fmt = new goog.i18n.NumberFormat('####E0');
  str = fmt.format(45678000);
  assertEquals('4568E4', str);
  fmt = new goog.i18n.NumberFormat('0E0');
  str = fmt.format(45678000);
  assertEquals('5E7', str);
  fmt = new goog.i18n.NumberFormat('00E0');
  str = fmt.format(45678000);
  assertEquals('46E6', str);
  fmt = new goog.i18n.NumberFormat('000E0');
  str = fmt.format(45678000);
  assertEquals('457E5', str);
  fmt = new goog.i18n.NumberFormat('###E0');
  str = fmt.format(0.0000123);
  assertEquals('12E-6', str);
  fmt = new goog.i18n.NumberFormat('###E0');
  str = fmt.format(0.000123);
  assertEquals('123E-6', str);
  fmt = new goog.i18n.NumberFormat('###E0');
  str = fmt.format(0.00123);
  assertEquals('1E-3', str);
  fmt = new goog.i18n.NumberFormat('###E0');
  str = fmt.format(0.0123);
  assertEquals('12E-3', str);
  fmt = new goog.i18n.NumberFormat('###E0');
  str = fmt.format(0.123);
  assertEquals('123E-3', str);
  fmt = new goog.i18n.NumberFormat('###E0');
  str = fmt.format(1.23);
  assertEquals('1E0', str);
  fmt = new goog.i18n.NumberFormat('###E0');
  str = fmt.format(12.3);
  assertEquals('12E0', str);
  fmt = new goog.i18n.NumberFormat('###E0');
  str = fmt.format(123.0);
  assertEquals('123E0', str);
  fmt = new goog.i18n.NumberFormat('###E0');
  str = fmt.format(1230.0);
  assertEquals('1E3', str);
}

function testGroupingParse2() {
  var value;
  var fmt;

  fmt = new goog.i18n.NumberFormat('#,###');
  value = fmt.parse('1,234,567,890');
  assertEquals(1234567890, value);
  fmt = new goog.i18n.NumberFormat('#,###');
  value = fmt.parse('12,3456,7890');
  assertEquals(1234567890, value);

  fmt = new goog.i18n.NumberFormat('#');
  value = fmt.parse('1234567890');
  assertEquals(1234567890, value);
}

function testApis() {
  var fmt;
  var str;

  fmt = new goog.i18n.NumberFormat('#,###');
  str = fmt.format(1234567890);
  assertEquals('1,234,567,890', str);

  fmt = new goog.i18n.NumberFormat('\u00a4#,##0.00;-\u00a4#,##0.00');
  str = fmt.format(1234.56);
  assertEquals('$1,234.56', str);
  fmt = new goog.i18n.NumberFormat('\u00a4#,##0.00;(\u00a4#,##0.00)');
  str = fmt.format(-1234.56);
  assertEquals('($1,234.56)', str);

  fmt = new goog.i18n.NumberFormat('\u00a4#,##0.00;-\u00a4#,##0.00', 'SEK');
  str = fmt.format(1234.56);
  assertEquals('kr1,234.56', str);
  fmt = new goog.i18n.NumberFormat('\u00a4#,##0.00;(\u00a4#,##0.00)', 'SEK');
  str = fmt.format(-1234.56);
  assertEquals('(kr1,234.56)', str);
}

function testLocaleSwitch() {
  goog.i18n.NumberFormatSymbols = goog.i18n.NumberFormatSymbols_fr;

  var fmt = new goog.i18n.NumberFormat('#,###');
  var str = fmt.format(1234567890);
  assertEquals('1\u00a0234\u00a0567\u00a0890', str);

  fmt = new goog.i18n.NumberFormat('\u00a4#,##0.00;-\u00a4#,##0.00');
  str = fmt.format(1234.56);
  assertEquals('\u20AC1\u00a0234,56', str);
  fmt = new goog.i18n.NumberFormat('\u00a4#,##0.00;(\u00a4#,##0.00)');
  str = fmt.format(-1234.56);
  assertEquals('(\u20AC1\u00a0234,56)', str);

  fmt = new goog.i18n.NumberFormat('\u00a4#,##0.00;-\u00a4#,##0.00', 'SEK');
  str = fmt.format(1234.56);
  assertEquals('kr1\u00a0234,56', str);
  fmt = new goog.i18n.NumberFormat('\u00a4#,##0.00;(\u00a4#,##0.00)', 'SEK');
  str = fmt.format(-1234.56);
  assertEquals('(kr1\u00a0234,56)', str);
  goog.i18n.NumberFormatSymbols = goog.i18n.NumberFormatSymbols_en;
}

function testFrenchParse() {
  goog.i18n.NumberFormatSymbols = goog.i18n.NumberFormatSymbols_fr;
  var fmt = new goog.i18n.NumberFormat('0.0000');
  var value = fmt.parse('0,30');
  assertEquals(0.30, value);

  fmt = new goog.i18n.NumberFormat(goog.i18n.NumberFormat.Format.CURRENCY);
  value = fmt.parse('0,30 \u20AC');
  assertEquals(0.30, value);
  fmt = new goog.i18n.NumberFormat('#,##0.00');
  value = fmt.parse('123 456,99');
  assertEquals(123456.99, value);

  fmt = new goog.i18n.NumberFormat('#,##0.00');
  value = fmt.parse('123\u00a0456,99');
  assertEquals(123456.99, value);

  fmt = new goog.i18n.NumberFormat('#,##0.00');
  value = fmt.parse('8 123\u00a0456,99');
  assertEquals(8123456.99, value);
  goog.i18n.NumberFormatSymbols = goog.i18n.NumberFormatSymbols_en;
}

function testFailParseShouldThrow() {
  goog.i18n.NumberFormatSymbols = goog.i18n.NumberFormatSymbols_en;

  var fmt = new goog.i18n.NumberFormat('0.0000');
  var value = fmt.parse('x');
  assertNaN(value);

  fmt = new goog.i18n.NumberFormat('0.000x');
  value = fmt.parse('3y');
  assertNaN(value);

  fmt = new goog.i18n.NumberFormat('x0.000');
  value = fmt.parse('y3');
  assertNaN(value);
}

/**
 * @return {boolean} Whether we're on Linux Firefox 3.6.3.
 */
function isFirefox363Linux() {
  return goog.userAgent.product.FIREFOX && goog.userAgent.LINUX &&
      goog.userAgent.product.isVersion('3.6.3') &&
      !goog.userAgent.product.isVersion('3.6.4');
}

">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:14:24
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>messageformat_test.html</td><td>Success</td><td> 20 passed, 0 failed.</td><td title="

  goog.require('goog.i18n.MessageFormat');
  goog.require('goog.i18n.NumberFormatSymbols');
  goog.require('goog.i18n.NumberFormatSymbols_en');
  goog.require('goog.i18n.NumberFormatSymbols_hr');
  goog.require('goog.i18n.pluralRules');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.testing.jsunit');



// Testing stubs that autoreset after each test run.
var stubs = new goog.testing.PropertyReplacer();

function tearDown() {
  stubs.reset();
}

function testEmptyPattern() {
  var fmt = new goog.i18n.MessageFormat('');
  assertEquals('', fmt.format({}));
}

function testMissingLeftCurlyBrace() {
  var err = assertThrows(function() {
    new goog.i18n.MessageFormat('\'\'{}}');
  });
  assertEquals('Assertion failed: No matching { for }.', err.message);
}

function testTooManyLeftCurlyBraces() {
  var err = assertThrows(function() {
    new goog.i18n.MessageFormat('{} {');
  });
  assertEquals('Assertion failed: There are mismatched { or } in the pattern.',
      err.message);
}

function testSimpleReplacement() {
  var fmt = new goog.i18n.MessageFormat('New York in {SEASON} is nice.');
  assertEquals('New York in the Summer is nice.',
               fmt.format({'SEASON': 'the Summer'}));
}

function testSimpleSelect() {
  var fmt = new goog.i18n.MessageFormat('{GENDER, select,' +
      'male {His} ' +
      'female {Her} ' +
      'other {Its}}' +
      ' bicycle is {GENDER, select, male {blue} female {red} other {green}}.');

  assertEquals('His bicycle is blue.', fmt.format({'GENDER': 'male'}));
  assertEquals('Her bicycle is red.', fmt.format({'GENDER': 'female'}));
  assertEquals('Its bicycle is green.', fmt.format({'GENDER': 'other'}));
  assertEquals('Its bicycle is green.', fmt.format({'GENDER': 'whatever'}));
}

function testSimplePlural() {
  var fmt = new goog.i18n.MessageFormat('I see {NUM_PEOPLE, plural, offset:1 ' +
      '=0 {no one at all in {PLACE}.} ' +
      '=1 {{PERSON} in {PLACE}.} ' +
      'one {{PERSON} and one other person in {PLACE}.} ' +
      'other {{PERSON} and # other people in {PLACE}.}}');

  assertEquals('I see no one at all in Belgrade.',
               fmt.format({'NUM_PEOPLE': 0,
                           'PLACE': 'Belgrade'}));
  assertEquals('I see Markus in Berlin.',
               fmt.format({'NUM_PEOPLE': 1,
                           'PERSON': 'Markus',
                           'PLACE': 'Berlin'}));
  assertEquals('I see Mark and one other person in Athens.',
               fmt.format({'NUM_PEOPLE': 2,
                           'PERSON': 'Mark',
                           'PLACE': 'Athens'}));
  assertEquals('I see Cibu and 99 other people in the cubes.',
               fmt.format({'NUM_PEOPLE': 100,
                           'PERSON': 'Cibu',
                           'PLACE': 'the cubes'}));
}

function testSimplePluralNoOffset() {
  var fmt = new goog.i18n.MessageFormat('I see {NUM_PEOPLE, plural, ' +
      '=0 {no one at all} ' +
      '=1 {{PERSON}} ' +
      'one {{PERSON} and one other person} ' +
      'other {{PERSON} and # other people}} in {PLACE}.');

  assertEquals('I see no one at all in Belgrade.',
               fmt.format({'NUM_PEOPLE': 0,
                           'PLACE': 'Belgrade'}));
  assertEquals('I see Markus in Berlin.',
               fmt.format({'NUM_PEOPLE': 1,
                           'PERSON': 'Markus',
                           'PLACE': 'Berlin'}));
  assertEquals('I see Mark and 2 other people in Athens.',
               fmt.format({'NUM_PEOPLE': 2,
                           'PERSON': 'Mark',
                           'PLACE': 'Athens'}));
  assertEquals('I see Cibu and 100 other people in the cubes.',
               fmt.format({'NUM_PEOPLE': 100,
                           'PERSON': 'Cibu',
                           'PLACE': 'the cubes'}));
}

function testSelectNestedInPlural() {
  var fmt = new goog.i18n.MessageFormat('{CIRCLES, plural, ' +
      'one {{GENDER, select, ' +
      '  female {{WHO} added you to her circle} ' +
      '  other  {{WHO} added you to his circle}}} ' +
      'other {{GENDER, select, ' +
      '  female {{WHO} added you to her # circles} ' +
      '  other  {{WHO} added you to his # circles}}}}');

  assertEquals('Jelena added you to her circle',
               fmt.format({'GENDER': 'female',
                           'WHO': 'Jelena',
                           'CIRCLES': 1}));
  assertEquals('Milan added you to his 1,234 circles',
               fmt.format({'GENDER': 'male',
                           'WHO': 'Milan',
                           'CIRCLES': 1234}));
}

function testPluralNestedInSelect() {
  // Added offset just for testing purposes. It doesn't make sense
  // to have it otherwise.
  var fmt = new goog.i18n.MessageFormat('{GENDER, select, ' +
      'female {{NUM_GROUPS, plural, ' +
      '  one {{WHO} added you to her group} ' +
      '  other {{WHO} added you to her # groups}}} ' +
      'other {{NUM_GROUPS, plural, offset:1' +
      '  one {{WHO} added you to his group} ' +
      '  other {{WHO} added you to his # groups}}}}');

  assertEquals('Jelena added you to her group',
               fmt.format({'GENDER': 'female',
                           'WHO': 'Jelena',
                           'NUM_GROUPS': 1}));
  assertEquals('Milan added you to his 1,233 groups',
               fmt.format({'GENDER': 'male',
                           'WHO': 'Milan',
                           'NUM_GROUPS': 1234}));
}

function testLiteralOpenCurlyBrace() {
  var fmt = new goog.i18n.MessageFormat("Anna's house" +
      " has '{0} and # in the roof' and {NUM_COWS} cows.");
  assertEquals("Anna's house has {0} and # in the roof and 5 cows.",
               fmt.format({'NUM_COWS': '5'}));
}

function testLiteralClosedCurlyBrace() {
  var fmt = new goog.i18n.MessageFormat("Anna's house" +
      " has '{'0'} and # in the roof' and {NUM_COWS} cows.");
  assertEquals("Anna's house has {0} and # in the roof and 5 cows.",
               fmt.format({'NUM_COWS': '5'}));
}

function testLiteralPoundSign() {
  var fmt = new goog.i18n.MessageFormat("Anna's house" +
      " has '{0}' and '# in the roof' and {NUM_COWS} cows.");
  assertEquals("Anna's house has {0} and # in the roof and 5 cows.",
               fmt.format({'NUM_COWS': '5'}));
}

function testNoLiteralsForSingleQuotes() {
  var fmt = new goog.i18n.MessageFormat("Anna's house" +
      " 'has {NUM_COWS} cows'.");
  assertEquals("Anna's house 'has 5 cows'.", fmt.format({'NUM_COWS': '5'}));
}

function testConsecutiveSingleQuotesAreReplacedWithOneSingleQuote() {
  var fmt = new goog.i18n.MessageFormat("Anna''s house a'{''''b'");
  assertEquals("Anna's house a{''b", fmt.format({}));
}

function testConsecutiveSingleQuotesBeforeSpecialCharDontCreateLiteral() {
  var fmt = new goog.i18n.MessageFormat("a''{NUM_COWS}'b");
  assertEquals("a'5'b", fmt.format({'NUM_COWS': '5'}));
}

function testSerbianSimpleSelect() {
  stubs.set(goog.i18n.pluralRules, 'select', goog.i18n.pluralRules.hrSelect_);

  var fmt = new goog.i18n.MessageFormat('{GENDER, select, ' +
      'female {Njen} other {Njegov}} bicikl je ' +
      '{GENDER, select, female {crven} other {plav}}.');

  assertEquals('Njegov bicikl je plav.', fmt.format({'GENDER': 'male'}));
  assertEquals('Njen bicikl je crven.', fmt.format({'GENDER': 'female'}));
}

function testSerbianSimplePlural() {
  stubs.set(goog.i18n.pluralRules, 'select', goog.i18n.pluralRules.hrSelect_);

  var fmt = new goog.i18n.MessageFormat('Ja {NUM_PEOPLE, plural, offset:1 ' +
      '=0 {ne vidim nikoga} ' +
      '=1 {vidim {PERSON}} ' +
      'one {vidim {PERSON} i jos # osobu} ' +
      'few {vidim {PERSON} i jos # osobe} ' +
      'many {vidim {PERSON} i jos # osoba} ' +
      'other {{PERSON} i jos # osoba}} ' +
      'u {PLACE}.');

  assertEquals('Ja ne vidim nikoga u Beogradu.',
               fmt.format({'NUM_PEOPLE': 0,
                           'PLACE': 'Beogradu'}));
  assertEquals('Ja vidim Markusa u Berlinu.',
               fmt.format({'NUM_PEOPLE': 1,
                           'PERSON': 'Markusa',
                           'PLACE': 'Berlinu'}));
  assertEquals('Ja vidim Marka i jos 1 osobu u Atini.',
               fmt.format({'NUM_PEOPLE': 2,
                           'PERSON': 'Marka',
                           'PLACE': 'Atini'}));
  assertEquals('Ja vidim Petra i jos 3 osobe u muzeju.',
               fmt.format({'NUM_PEOPLE': 4,
                           'PERSON': 'Petra',
                           'PLACE': 'muzeju'}));
  assertEquals('Ja vidim Cibua i jos 99 osoba u bazenu.',
               fmt.format({'NUM_PEOPLE': 100,
                           'PERSON': 'Cibua',
                           'PLACE': 'bazenu'}));
}

function testSerbianSimplePluralNoOffset() {
  stubs.set(goog.i18n.pluralRules, 'select', goog.i18n.pluralRules.hrSelect_);

  var fmt = new goog.i18n.MessageFormat('Ja {NUM_PEOPLE, plural, ' +
      '=0 {ne vidim nikoga} ' +
      '=1 {vidim {PERSON}} ' +
      'one {vidim {PERSON} i jos # osobu} ' +
      'few {vidim {PERSON} i jos # osobe} ' +
      'many {vidim {PERSON} i jos # osoba} ' +
      'other {{PERSON} i jos # osoba}} ' +
      'u {PLACE}.');

  assertEquals('Ja ne vidim nikoga u Beogradu.',
               fmt.format({'NUM_PEOPLE': 0,
                           'PLACE': 'Beogradu'}));
  assertEquals('Ja vidim Markusa u Berlinu.',
               fmt.format({'NUM_PEOPLE': 1,
                           'PERSON': 'Markusa',
                           'PLACE': 'Berlinu'}));
  assertEquals('Ja vidim Marka i jos 21 osobu u Atini.',
               fmt.format({'NUM_PEOPLE': 21,
                           'PERSON': 'Marka',
                           'PLACE': 'Atini'}));
  assertEquals('Ja vidim Petra i jos 3 osobe u muzeju.',
               fmt.format({'NUM_PEOPLE': 3,
                           'PERSON': 'Petra',
                           'PLACE': 'muzeju'}));
  assertEquals('Ja vidim Cibua i jos 100 osoba u bazenu.',
               fmt.format({'NUM_PEOPLE': 100,
                           'PERSON': 'Cibua',
                           'PLACE': 'bazenu'}));
}

function testSerbianSelectNestedInPlural() {
  stubs.set(goog.i18n.pluralRules, 'select', goog.i18n.pluralRules.hrSelect_);
  stubs.set(goog.i18n, 'NumberFormatSymbols', goog.i18n.NumberFormatSymbols_hr);

  var fmt = new goog.i18n.MessageFormat('{CIRCLES, plural, ' +
      'one {{GENDER, select, ' +
      '  female {{WHO} vas je dodala u njen # kruzok} ' +
      '  other  {{WHO} vas je dodao u njegov # kruzok}}} ' +
      'few {{GENDER, select, ' +
      '  female {{WHO} vas je dodala u njena # kruzoka} ' +
      '  other  {{WHO} vas je dodao u njegova # kruzoka}}} ' +
      'many {{GENDER, select, ' +
      '  female {{WHO} vas je dodala u njenih # kruzoka} ' +
      '  other  {{WHO} vas je dodao u njegovih # kruzoka}}} ' +
      'other {{GENDER, select, ' +
      '  female {{WHO} vas je dodala u njenih # kruzoka} ' +
      '  other  {{WHO} vas je dodao u njegovih # kruzoka}}}}');

  assertEquals('Jelena vas je dodala u njen 21 kruzok',
               fmt.format({'GENDER': 'female',
                           'WHO': 'Jelena',
                           'CIRCLES': 21}));
  assertEquals('Jelena vas je dodala u njena 3 kruzoka',
               fmt.format({'GENDER': 'female',
                           'WHO': 'Jelena',
                           'CIRCLES': 3}));
  assertEquals('Jelena vas je dodala u njenih 5 kruzoka',
               fmt.format({'GENDER': 'female',
                           'WHO': 'Jelena',
                           'CIRCLES': 5}));
  assertEquals('Milan vas je dodao u njegovih 1.235 kruzoka',
               fmt.format({'GENDER': 'male',
                           'WHO': 'Milan',
                           'CIRCLES': 1235}));
}

function testPoundShowsNumberMinusOffsetInAllCases() {
  var fmt = new goog.i18n.MessageFormat('{SOME_NUM, plural, offset:1 ' +
      '=0 {#} =1 {#} =2 {#}one {#} other {#}}');

  assertEquals('-1', fmt.format({'SOME_NUM': '0'}));
  assertEquals('0', fmt.format({'SOME_NUM': '1'}));
  assertEquals('1', fmt.format({'SOME_NUM': '2'}));
  assertEquals('20', fmt.format({'SOME_NUM': '21'}));
}

">n/a</td></tr>
<tr><td>datetimeparse_test.html</td><td>Success</td><td> 19 passed, 0 failed.</td><td title="

  goog.require('goog.i18n.DateTimeFormat');
  goog.require('goog.i18n.DateTimeParse');
  goog.require('goog.i18n.DateTimeSymbols');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');



/**
 * Date/time formatting symbols for locale en.
 * @enum {Array.<string|number>|number}
 */
goog.i18n.DateTimeSymbols_en = {
  ERAS: ['BC', 'AD'],
  ERANAMES: ['Before Christ', 'Anno Domini'],
  NARROWMONTHS: ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'],
  STANDALONENARROWMONTHS: ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O',
      'N', 'D'],
  MONTHS: ['January', 'February', 'March', 'April', 'May', 'June', 'July',
      'August', 'September', 'October', 'November', 'December'],
  STANDALONEMONTHS: ['January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'],
  SHORTMONTHS: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep',
      'Oct', 'Nov', 'Dec'],
  STANDALONESHORTMONTHS: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul',
      'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
  WEEKDAYS: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday',
      'Saturday'],
  STANDALONEWEEKDAYS: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday',
      'Friday', 'Saturday'],
  SHORTWEEKDAYS: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
  STANDALONESHORTWEEKDAYS: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
  NARROWWEEKDAYS: ['S', 'M', 'T', 'W', 'T', 'F', 'S'],
  STANDALONENARROWWEEKDAYS: ['S', 'M', 'T', 'W', 'T', 'F', 'S'],
  SHORTQUARTERS: ['Q1', 'Q2', 'Q3', 'Q4'],
  QUARTERS: ['1st quarter', '2nd quarter', '3rd quarter', '4th quarter'],
  AMPMS: ['AM', 'PM'],
  DATEFORMATS: ['EEEE, MMMM d, yyyy', 'MMMM d, yyyy', 'MMM d, yyyy', 'M/d/yy'],
  TIMEFORMATS: ['h:mm:ss a v', 'h:mm:ss a z', 'h:mm:ss a', 'h:mm a'],
  FIRSTDAYOFWEEK: 6,
  WEEKENDRANGE: [5, 6],
  FIRSTWEEKCUTOFFDAY: 5
};


/**
 * Date/time formatting symbols for locale fr.
 * @enum {Array.<string|number>|number}
 */
goog.i18n.DateTimeSymbols_fr = {
  ERAS: ['av. J.-C.', 'ap. J.-C.'],
  ERANAMES: ['avant Jésus-Christ', 'après Jésus-Christ'],
  NARROWMONTHS: ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'],
  STANDALONENARROWMONTHS: ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O',
      'N', 'D'],
  MONTHS: ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet',
      'août', 'septembre', 'octobre', 'novembre', 'décembre'],
  STANDALONEMONTHS: ['janvier', 'février', 'mars', 'avril', 'mai', 'juin',
      'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'],
  SHORTMONTHS: ['janv.', 'févr.', 'mars', 'avr.', 'mai', 'juin', 'juil.',
      'août', 'sept.', 'oct.', 'nov.', 'déc.'],
  STANDALONESHORTMONTHS: ['janv.', 'févr.', 'mars', 'avr.', 'mai', 'juin',
      'juil.', 'août', 'sept.', 'oct.', 'nov.', 'déc]'],
  WEEKDAYS: ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi',
      'samedi'],
  STANDALONEWEEKDAYS: ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi',
      'vendredi', 'samedi'],
  SHORTWEEKDAYS: ['dim.', 'lun.', 'mar.', 'mer.', 'jeu.', 'ven.', 'sam.'],
  STANDALONESHORTWEEKDAYS: ['dim.', 'lun.', 'mar.', 'mer.', 'jeu.', 'ven.',
      'sam.'],
  NARROWWEEKDAYS: ['D', 'L', 'M', 'M', 'J', 'V', 'S'],
  STANDALONENARROWWEEKDAYS: ['D', 'L', 'M', 'M', 'J', 'V', 'S'],
  SHORTQUARTERS: ['T1', 'T2', 'T3', 'T4'],
  QUARTERS: ['1er trimestre', '2e trimestre', '3e trimestre', '4e trimestre'],
  AMPMS: ['AM', 'PM'],
  DATEFORMATS: ['EEEE d MMMM yyyy', 'd MMMM yyyy', 'd MMM yyyy', 'dd/MM/yy'],
  TIMEFORMATS: ['HH:mm:ss v', 'HH:mm:ss z', 'HH:mm:ss', 'HH:mm'],
  FIRSTDAYOFWEEK: 0,
  WEEKENDRANGE: [5, 6],
  FIRSTWEEKCUTOFFDAY: 3
};


/**
 * Date/time formatting symbols for locale zh.
 * @enum {Array.<string|number>|number}
 */
goog.i18n.DateTimeSymbols_zh = {
  ERAS: ['公元前', '公元'],
  ERANAMES: ['公元前', '公元'],
  NARROWMONTHS: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月',
      '9月', '10月', '11月', '12月'],
  STANDALONENARROWMONTHS: ['1月', '2月', '3月', '4月', '5月', '6月',
      '7月', '8月', '9月', '10月', '11月', '12月'],
  MONTHS: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月',
      '9月', '10月', '11月', '12月'],
  STANDALONEMONTHS: ['一月', '二月', '三月', '四月', '五月', '六月',
      '七月', '八月', '九月', '十月', '十一月', '十二月'],
  SHORTMONTHS: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月',
      '9月', '10月', '11月', '12月'],
  STANDALONESHORTMONTHS: ['一月', '二月', '三月', '四月', '五月',
      '六月', '七月', '八月', '九月', '十月', '十一月',
      '十二月'],
  WEEKDAYS: ['星期日', '星期一', '星期二', '星期三', '星期四',
      '星期五', '星期六'],
  STANDALONEWEEKDAYS: ['星期日', '星期一', '星期二', '星期三',
      '星期四', '星期五', '星期六'],
  SHORTWEEKDAYS: ['周日', '周一', '周二', '周三', '周四', '周五',
      '周六'],
  STANDALONESHORTWEEKDAYS: ['周日', '周一', '周二', '周三', '周四',
      '周五', '周六'],
  NARROWWEEKDAYS: ['日', '一', '二', '三', '四', '五', '六'],
  STANDALONENARROWWEEKDAYS: ['日', '一', '二', '三', '四', '五', '六'],
  SHORTQUARTERS: ['1季', '2季', '3季', '4季'],
  QUARTERS: ['第1季度', '第2季度', '第3季度', '第4季度'],
  AMPMS: ['上午', '下午'],
  DATEFORMATS: ['yyyy年M月d日EEEE', 'yyyy年M月d日', 'yyyy-M-d', 'yy-M-d'],
  TIMEFORMATS: ['ahh时mm分ss秒v', 'ahh时mm分ss秒z', 'ahh:mm:ss', 'ah:mm'],
  FIRSTDAYOFWEEK: 6,
  WEEKENDRANGE: [5, 6],
  FIRSTWEEKCUTOFFDAY: 5
};

goog.i18n.DateTimeSymbols = goog.i18n.DateTimeSymbols_en;

function testNegativeYear() {
  var date = new Date();

  var parser = new goog.i18n.DateTimeParse('MM/dd, yyyy');
  assertTrue(parser.parse('11/22, 1999', date) > 0);
  assertEquals(1999, date.getFullYear());
  assertEquals(11 - 1, date.getMonth());
  assertEquals(22, date.getDate());

  assertTrue(parser.parse('11/22, -1999', date) > 0);
  assertEquals(-1999, date.getFullYear());
  assertEquals(11 - 1, date.getMonth());
  assertEquals(22, date.getDate());
}

function testEra() {
  // Bug 2350397
  if (goog.userAgent.WEBKIT) {
  // Bug 2350397 Test seems to be very flaky on Chrome. Disabling it
    return;
  }

  var date = new Date();
  var parser = new goog.i18n.DateTimeParse('MM/dd, yyyyG');
  assertTrue(parser.parse('11/22, 1999BC', date) > 0);
  assertEquals(-1998, date.getFullYear());
  assertEquals(11 - 1, date.getMonth());
  assertEquals(22, date.getDate());

  assertTrue(parser.parse('11/22, 1BC', date) > 0);
  assertEquals(0, date.getFullYear());
  assertEquals(11 - 1, date.getMonth());
  assertEquals(22, date.getDate());

  assertTrue(parser.parse('11/22, 1999AD', date) > 0);
  assertEquals(1999, date.getFullYear());
  assertEquals(11 - 1, date.getMonth());
  assertEquals(22, date.getDate());
}

function testFractionalSeconds() {
  var date = new Date();

  var parser = new goog.i18n.DateTimeParse('hh:mm:ss.SSS');
  assertTrue(parser.parse('11:12:13.956', date) > 0);
  assertEquals(11, date.getHours());
  assertEquals(12, date.getMinutes());
  assertEquals(13, date.getSeconds());
  assertEquals(956, date.getTime() % 1000);

  assertTrue(parser.parse('11:12:13.95', date) > 0);
  assertEquals(11, date.getHours());
  assertEquals(12, date.getMinutes());
  assertEquals(13, date.getSeconds());
  assertEquals(950, date.getTime() % 1000);

  assertTrue(parser.parse('11:12:13.9', date) > 0);
  assertEquals(11, date.getHours());
  assertEquals(12, date.getMinutes());
  assertEquals(13, date.getSeconds());
  assertEquals(900, date.getTime() % 1000);
}

function testAmbiguousYear() {
  // Bug 2350397 Test seems to fail on all browsers. Disabling it.
    return;

  var date = new Date();

  // assume this year is 2006, year 27 to 99 will be interpret as 1927 to 1999
  // year 00 to 25 will be 2000 to 2025. Year 26 can be either 1926 or 2026
  // depend on the exact time.
  var orgDate = new Date();
  orgDate.setFullYear(orgDate.getFullYear() + 20);

  // following 2 lines only works in 2006. Keep them here as they explained
  // our intention better.
  //assertTrue(DateTimeParse.parse('01/01/26', 0, 'MM/dd/yy', date) > 0);
  //assertTrue(date.getYear() == 2026 - 1900);

  // rewrite so that it works in any year.
  orgDate.setMonth(0);
  orgDate.setDate(1);
  orgDate.setHours(0);
  orgDate.setMinutes(0);
  orgDate.setSeconds(0);
  orgDate.setMilliseconds(1);
  var str = '01/01/' + (orgDate.getFullYear() % 100);
  var parser = new goog.i18n.DateTimeParse('MM/dd/yy');
  assertTrue(parser.parse(str, date) > 0);
  assertEquals(orgDate.getFullYear(), date.getFullYear());

  // following 2 lines only works in 2006. Keep them here as they explained
  // our intention better.
  //assertTrue(DateTimeParse.parse('MM/dd/yy', '12/30/26', date) > 0);
  //assertTrue(date.getYear() == 1926 - 1900);

  // rewrite so that it works in any year.
  orgDate.setMonth(11);
  orgDate.setDate(31);
  orgDate.setHours(23);
  orgDate.setMinutes(59);
  orgDate.setSeconds(59);
  orgDate.setMilliseconds(999);
  str = '12/31/' + (orgDate.getFullYear() % 100);
  var parser1 = new goog.i18n.DateTimeParse('MM/dd/yy');
  assertTrue(parser1.parse(str, date) > 0);
  assertEquals(orgDate.getFullYear(), date.getFullYear()+100);

  var parser2 = new goog.i18n.DateTimeParse('yy,MM,dd');
  assertTrue(parser2.parse('2097,07,21', date) > 0);
  assertEquals(2097, date.getFullYear());

  // Test the ability to move the disambiguation century
  goog.i18n.DateTimeParse.ambiguousYearCenturyStart = 60;

  orgDate.setMonth(0);
  orgDate.setDate(1);
  orgDate.setHours(0);
  orgDate.setMinutes(0);
  orgDate.setSeconds(0);
  orgDate.setMilliseconds(1);
  str = '01/01/' + (orgDate.getFullYear() % 100);
  assertTrue(parser1.parse(str, date) > 0);
  assertEquals(orgDate.getFullYear(), date.getFullYear());

  // Increment orgDate 20 more years
  orgDate.setFullYear(date.getFullYear() + 20);
  str = '01/01/' + (orgDate.getFullYear() % 100);
  assertTrue(parser1.parse(str, date) > 0);
  assertEquals(orgDate.getFullYear(), date.getFullYear());

  orgDate.setFullYear(date.getFullYear() + 21);
  str = '01/01/' + (orgDate.getFullYear() % 100);
  assertTrue(parser1.parse(str, date) > 0);
  assertEquals(orgDate.getFullYear(), date.getFullYear()+100);

  // Reset parameter for other test cases
  goog.i18n.DateTimeParse.ambiguousYearCenturyStart = 80;
}

function testLeapYear() {
  var date = new Date();

  var parser = new goog.i18n.DateTimeParse('MMdd, yyyy');
  assertTrue(parser.parse('0229, 2001', date) > 0);
  assertEquals(3 - 1, date.getMonth());
  assertEquals(1, date.getDate());

  assertTrue(parser.parse('0229, 2000', date) > 0);
  assertEquals(2 - 1, date.getMonth());
  assertEquals(29, date.getDate());
}

function testAbutField() {
  var date = new Date();

  var parser = new goog.i18n.DateTimeParse('hhmm');
  assertTrue(parser.parse('1122', date) > 0);
  assertEquals(11, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('122', date) > 0);
  assertEquals(1, date.getHours());
  assertEquals(22, date.getMinutes());

  var parser2 = new goog.i18n.DateTimeParse('hhmmss');
  assertTrue(parser2.parse('112233', date) > 0);
  assertEquals(11, date.getHours());
  assertEquals(22, date.getMinutes());
  assertEquals(33, date.getSeconds());

  assertTrue(parser2.parse('12233', date) > 0);
  assertEquals(1, date.getHours());
  assertEquals(22, date.getMinutes());
  assertEquals(33, date.getSeconds());

  var parser3 = new goog.i18n.DateTimeParse('yyyyMMdd');
  assertTrue(parser3.parse('19991202', date) > 0);
  assertEquals(1999, date.getFullYear());
  assertEquals(12 - 1, date.getMonth());
  assertEquals(02, date.getDate());

  assertTrue(parser3.parse('9991202', date) > 0);
  assertTrue(date.getFullYear() == 999);
  assertEquals(12 - 1, date.getMonth());
  assertEquals(02, date.getDate());

  assertTrue(parser3.parse('991202', date) > 0);
  assertEquals(99, date.getFullYear());
  assertEquals(12 - 1, date.getMonth());
  assertEquals(02, date.getDate());

  assertTrue(parser3.parse('91202', date) > 0);
  assertEquals(9, date.getFullYear());
  assertEquals(12 - 1, date.getMonth());
  assertEquals(02, date.getDate());
}

function testYearParsing() {
  var date = new Date();

  var parser = new goog.i18n.DateTimeParse('yyMMdd');
  assertTrue(parser.parse('991202', date) > 0);
  assertEquals(1999, date.getFullYear());
  assertEquals(12 - 1, date.getMonth());
  assertEquals(02, date.getDate());

  var parser2 = new goog.i18n.DateTimeParse('yyyyMMdd');
  assertTrue(parser2.parse('20051202', date) > 0);
  assertEquals(2005, date.getFullYear());
  assertEquals(12 - 1, date.getMonth());
  assertEquals(02, date.getDate());
}

function testHourParsing_hh() {
  var date = new Date();

  var parser = new goog.i18n.DateTimeParse('hhmm');
  assertTrue(parser.parse('0022', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('1122', date) > 0);
  assertEquals(11, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('1222', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('2322', date) > 0);
  assertEquals(23, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('2422', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  var parser2 = new goog.i18n.DateTimeParse('hhmma');
  assertTrue(parser2.parse('0022am', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('1122am', date) > 0);
  assertEquals(11, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('1222am', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('2322am', date) > 0);
  assertEquals(23, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('2422am', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('0022pm', date) > 0);
  assertEquals(12, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('1122pm', date) > 0);
  assertEquals(23, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('1222pm', date) > 0);
  assertEquals(12, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('2322pm', date) > 0);
  assertEquals(23, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('2422pm', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());
}

function testHourParsing_KK() {
  var date = new Date();

  var parser = new goog.i18n.DateTimeParse('KKmm');
  assertTrue(parser.parse('0022', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('1122', date) > 0);
  assertEquals(11, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('1222', date) > 0);
  assertEquals(12, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('2322', date) > 0);
  assertEquals(23, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('2422', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());


  var parser2 = new goog.i18n.DateTimeParse('KKmma');
  assertTrue(parser2.parse('0022am', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('1122am', date) > 0);
  assertEquals(11, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('1222am', date) > 0);
  assertEquals(12, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('2322am', date) > 0);
  assertEquals(23, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('2422am', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('0022pm', date) > 0);
  assertEquals(12, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('1122pm', date) > 0);
  assertEquals(23, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('1222pm', date) > 0);
  assertEquals(12, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('2322pm', date) > 0);
  assertEquals(23, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('2422pm', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());
}

function testHourParsing_kk() {
  var date = new Date();

  var parser = new goog.i18n.DateTimeParse('kkmm');
  assertTrue(parser.parse('0022', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('1122', date) > 0);
  assertEquals(11, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('1222', date) > 0);
  assertEquals(12, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('2322', date) > 0);
  assertEquals(23, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('2422', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  var parser2 = new goog.i18n.DateTimeParse('kkmma');
  assertTrue(parser2.parse('0022am', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('1122am', date) > 0);
  assertEquals(11, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('1222am', date) > 0);
  assertEquals(12, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('2322am', date) > 0);
  assertEquals(23, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('2422am', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('0022pm', date) > 0);
  assertEquals(12, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('1122pm', date) > 0);
  assertEquals(23, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('1222pm', date) > 0);
  assertEquals(12, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('2322pm', date) > 0);
  assertEquals(23, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('2422pm', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());
}

function testHourParsing_HH() {
  var date = new Date();

  var parser = new goog.i18n.DateTimeParse('HHmm');
  assertTrue(parser.parse('0022', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('1122', date) > 0);
  assertEquals(11, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('1222', date) > 0);
  assertEquals(12, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('2322', date) > 0);
  assertEquals(23, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser.parse('2422', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  var parser2 = new goog.i18n.DateTimeParse('HHmma');
  assertTrue(parser2.parse('0022am', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('1122am', date) > 0);
  assertEquals(11, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('1222am', date) > 0);
  assertEquals(12, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('2322am', date) > 0);
  assertEquals(23, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('2422am', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('0022pm', date) > 0);
  assertEquals(12, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('1122pm', date) > 0);
  assertEquals(23, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('1222pm', date) > 0);
  assertEquals(12, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('2322pm', date) > 0);
  assertEquals(23, date.getHours());
  assertEquals(22, date.getMinutes());

  assertTrue(parser2.parse('2422pm', date) > 0);
  assertEquals(00, date.getHours());
  assertEquals(22, date.getMinutes());
}

function testEnglishDate() {
  var date = new Date();

  var parser = new goog.i18n.DateTimeParse('yyyy MMM dd hh:mm');
  assertTrue(parser.parse('2006 Jul 10 15:44', date) > 0);
  assertEquals(2006, date.getFullYear());
  assertEquals(7 - 1, date.getMonth());
  assertEquals(10, date.getDate());
  assertEquals(15, date.getHours());
  assertEquals(44, date.getMinutes());
}

function testChineseDate() {
  goog.i18n.DateTimeSymbols = goog.i18n.DateTimeSymbols_zh;

  var date = new Date();
  var parser = new goog.i18n.DateTimeParse(
      goog.i18n.DateTimeFormat.Format.FULL_DATE);
  parser.parse('2006\u5E747\u670824\u65E5\u661F\u671F\u4E00', date);
  assertEquals(2006, date.getFullYear());
  assertEquals(7 - 1, date.getMonth());
  assertEquals(24, date.getDate());

  parser = new goog.i18n.DateTimeParse(
      goog.i18n.DateTimeFormat.Format.LONG_DATE);
  parser.parse('2006\u5E747\u670824\u65E5', date);
  assertEquals(2006, date.getFullYear());
  assertEquals(7 - 1, date.getMonth());
  assertEquals(24, date.getDate());

  parser = new goog.i18n.DateTimeParse(
      goog.i18n.DateTimeFormat.Format.FULL_TIME);
  parser.parse('\u4E0B\u534803\u65F626\u520628\u79D2 GMT-07:00', date);
  assertEquals((24 + date.getHours() + date.getTimezoneOffset()/60) % 24, 22);
  assertEquals(26, date.getMinutes());
  assertEquals(28, date.getSeconds());

  goog.i18n.DateTimeSymbols = goog.i18n.DateTimeSymbols_en;
}

function testTimeZone() {
  var date = new Date();

  var parser = new goog.i18n.DateTimeParse('MM/dd/yyyy, hh:mm:ss zzz');
  assertTrue(parser.parse('07/21/2003, 11:22:33 GMT-0700', date) > 0);
  var hourGmtMinus07 = date.getHours();

  assertTrue(parser.parse('07/21/2003, 11:22:33 GMT-0600', date) > 0);
  var hourGmtMinus06 = date.getHours();
  assertEquals(1, (hourGmtMinus07 + 24 - hourGmtMinus06) % 24);

  assertTrue(parser.parse('07/21/2003, 11:22:33 GMT-0800', date) > 0);
  var hourGmtMinus08 = date.getHours();
  assertEquals(1, (hourGmtMinus08 + 24 - hourGmtMinus07) % 24);

  assertTrue(parser.parse('07/21/2003, 23:22:33 GMT-0800', date) > 0);
  assertEquals((date.getHours() + 24 - hourGmtMinus07) % 24, 13);

  assertTrue(parser.parse('07/21/2003, 11:22:33 GMT+0800', date) > 0);
  var hourGmt08 = date.getHours();
  assertEquals(16, (hourGmtMinus08 + 24 - hourGmt08) % 24);

  assertTrue(parser.parse('07/21/2003, 11:22:33 GMT0800', date) > 0);
  assertEquals(hourGmt08, date.getHours());
}

function testWeekDay() {
  var date = new Date();
  var parser = new goog.i18n.DateTimeParse('EEEE, MM/dd/yyyy');

  assertTrue(parser.parse('Wednesday, 08/16/2006', date) > 0);
  assertEquals(2006, date.getFullYear());
  assertEquals(8 - 1, date.getMonth());
  assertEquals(16, date.getDate());
  assertTrue(parser.parse('Tuesday, 08/16/2006', date) == 0);
  assertTrue(parser.parse('Thursday, 08/16/2006', date) == 0);
  assertTrue(parser.parse('Wed, 08/16/2006', date) > 0);
  assertTrue(parser.parse('Wasdfed, 08/16/2006', date) == 0);

  date.setDate(25);
  parser = new goog.i18n.DateTimeParse('EEEE, MM/yyyy');
  assertTrue(parser.parse('Wed, 09/2006', date) > 0);
  assertEquals(27, date.getDate());

  date.setDate(30);
  assertTrue(parser.parse('Wed, 09/2006', date) > 0);
  assertEquals(27, date.getDate());
  date.setDate(30);
  assertTrue(parser.parse('Mon, 09/2006', date) > 0);
  assertEquals(25, date.getDate());
}

function testStrictParse() {
  var date = new Date();

  var parser = new goog.i18n.DateTimeParse('yyyy/MM/dd');
  assertTrue(parser.strictParse('2000/13/10', date) == 0);
  assertTrue(parser.strictParse('2000/13/40', date) == 0);
  assertTrue(parser.strictParse('2000/11/10', date) > 0);
  assertEquals(2000, date.getFullYear());
  assertEquals(11 - 1, date.getMonth());
  assertEquals(10, date.getDate());

  parser = new goog.i18n.DateTimeParse('yy/MM/dd');
  assertTrue(parser.strictParse('00/11/10', date) > 0);
  assertTrue(parser.strictParse('99/11/10', date) > 0);
  assertTrue(parser.strictParse('00/13/10', date) == 0);
  assertTrue(parser.strictParse('00/11/32', date) == 0);
  assertTrue(parser.strictParse('1900/11/2', date) > 0);


  parser = new goog.i18n.DateTimeParse('hh:mm');
  assertTrue(parser.strictParse('15:44', date) > 0);
  assertTrue(parser.strictParse('25:44', date) == 0);
  assertTrue(parser.strictParse('15:64', date) == 0);

  // leap year
  parser = new goog.i18n.DateTimeParse('yy/MM/dd');
  assertTrue(parser.strictParse('00/02/29', date) > 0);
  assertTrue(parser.strictParse('01/02/29', date) == 0);
}

function testEnglishQuarter() {
  var date = new Date();
  var parser = new goog.i18n.DateTimeParse('QQQQ yyyy');
  assertTrue(parser.parse('1st quarter 2009', date) > 0);
  assertEquals(2009, date.getFullYear());
  assertEquals(0, date.getMonth());
  assertEquals(1, date.getDate());
}

function testEnglishShortQuarter() {
  var date = new Date();
  var parser = new goog.i18n.DateTimeParse('yyyyQQ');
  assertTrue(parser.parse('2006Q2', date) > 0);
  assertEquals(2006, date.getFullYear());
  assertEquals(4 - 1, date.getMonth());
  assertEquals(1, date.getDate());
}

function testFrenchShortQuarter() {
  goog.i18n.DateTimeSymbols = goog.i18n.DateTimeSymbols_fr;

  var date = new Date();
  try {
    var parser = new goog.i18n.DateTimeParse('yyyyQQ');
    assertTrue(parser.parse('2009T3', date) > 0);
    assertEquals(2009, date.getFullYear());
    assertEquals(7 - 1, date.getMonth());
    assertEquals(1, date.getDate());
  } catch (e) {
    goog.i18n.DateTimeSymbols = goog.i18n.DateTimeSymbols_en;
    throw e;
  }
  goog.i18n.DateTimeSymbols = goog.i18n.DateTimeSymbols_en;
}


">n/a</td></tr>
<tr><td>uchar_test.html</td><td>Success</td><td> 9 passed, 0 failed.</td><td title="

  goog.require('goog.i18n.uChar');
  goog.require('goog.testing.jsunit');


function testToHexString() {
  var result = goog.i18n.uChar.toHexString('\uD869\uDED6');
  assertEquals('U+2A6D6', result);
}

function testPadString() {
  var result = goog.i18n.uChar.padString_('abc', 4, '0');
  assertEquals('0abc', result);
}

function testToCharCode() {
  var result = goog.i18n.uChar.toCharCode('\uD869\uDED6');
  assertEquals(0x2A6D6, result);
}

function testFromCharCode() {
  var result = goog.i18n.uChar.fromCharCode(0x2A6D6);
  assertEquals('\uD869\uDED6', result);
}

function testToName() {
  var result = goog.i18n.uChar.toName(' ');
  assertEquals('Space', result);
}

function testToNameForNumberKey() {
  var result = goog.i18n.uChar.toName('\u2028');
  assertEquals('Line Separator', result);
}

function testToNameForVariationSelector() {
  var result = goog.i18n.uChar.toName('\ufe00');
  assertEquals('Variation Selector - 1', result);
}

function testToNameForVariationSelectorSupp() {
  var result = goog.i18n.uChar.toName('\uDB40\uDD00');
  assertEquals('Variation Selector - 17', result);
}

function testToNameForNull() {
  var result = goog.i18n.uChar.toName('a');
  assertNull(result);
}

">n/a</td></tr>
<tr><td>pastehandler_test.html</td><td>Success</td><td> 16 passed, 0 failed.</td><td title="

  goog.require('goog.events.PasteHandler');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.MockUserAgent');
  goog.require('goog.testing.jsunit');
  goog.require('goog.events.EventTarget');
  goog.require('goog.events.EventType');
  goog.require('goog.dom');



function setUp() {
  // TODO(user): fix {@code goog.testing.MockUserAgent} to do the right thing.
  // the code doesn't seem to be updating the variables with
  // goog.userAgent.init_(), which means it is not allowing me to mock the
  // user agent variables.
  goog.userAgent.GECKO = true;
  goog.userAgent.IE = false;
  goog.userAgent.WEBKIT = false;
  goog.userAgent.VERSION = '1.8';

  textarea = new goog.events.EventTarget();
  textarea.value = '';
  clock = new goog.testing.MockClock(true);
  mockUserAgent = new goog.testing.MockUserAgent();
  handler = new goog.events.PasteHandler(textarea);
  pasted = false;
  goog.events.listen(handler, goog.events.PasteHandler.EventType.PASTE,
      function() {
        pasted = true;
      });
}

function tearDown() {
  textarea.dispose();
  handler.dispose();
  clock.dispose();
  mockUserAgent.dispose();
}

function newBrowserEvent(type) {
  if (goog.isString(type)) {
    return new goog.events.BrowserEvent({type: type});
  } else {
    return new goog.events.BrowserEvent(type);
  }
}

function testDispatchingPasteEventSupportedByAFewBrowsersWork() {
  goog.userAgent.IE = true;
  var handlerThatSupportsPasteEvents =
      new goog.events.PasteHandler(textarea);
  // user clicks on the textarea and give it focus
  goog.events.listen(handlerThatSupportsPasteEvents,
      goog.events.PasteHandler.EventType.PASTE,
      function() {
        pasted = true;
      });
  textarea.dispatchEvent(newBrowserEvent('paste'));
  assertTrue(pasted);
}

function testJustTypingDoesntFirePasteEvent() {
  // user clicks on the textarea and give it focus
  textarea.dispatchEvent(newBrowserEvent(goog.events.EventType.FOCUS));
  assertFalse(pasted);
  // user starts typing
  textarea.dispatchEvent(newBrowserEvent({
    type: goog.events.EventType.KEYDOWN,
    keyCode: goog.events.KeyCodes.A
  }));
  textarea.value = 'a';
  assertFalse(pasted);

  // still typing
  textarea.dispatchEvent({
    type: goog.events.EventType.KEYDOWN,
    keyCode: goog.events.KeyCodes.B
  });
  textarea.value = 'ab';
  assertFalse(pasted);

  // ends typing
  textarea.dispatchEvent({
    type: goog.events.EventType.KEYDOWN,
    keyCode: goog.events.KeyCodes.C
  });
  textarea.value = 'abc';
  assertFalse(pasted);
}

function testStartsOnInitialState() {
  assertTrue(handler.getState() == goog.events.PasteHandler.State.INIT);
  assertFalse(pasted);
}

function testBlurOnInit() {
  textarea.dispatchEvent(goog.events.EventType.BLUR);
  assertTrue(handler.getState() == goog.events.PasteHandler.State.INIT);
  assertFalse(pasted);
}

function testFocusOnInit() {
  textarea.dispatchEvent(goog.events.EventType.FOCUS);
  assertTrue(handler.getState() == goog.events.PasteHandler.State.FOCUSED);
  assertFalse(pasted);
}

function testInputOnFocus() {
  // user clicks on the textarea
  textarea.dispatchEvent(newBrowserEvent(goog.events.EventType.FOCUS));
  clock.tick(
      goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER +
      1);
  // and right click -> paste a text!
  textarea.dispatchEvent(newBrowserEvent('input'));
  assertTrue(handler.getState() == goog.events.PasteHandler.State.FOCUSED);
  // make sure we detected it
  assertTrue(pasted);
}

function testKeyPressOnFocus() {
  // user clicks on the textarea
  textarea.dispatchEvent(newBrowserEvent(goog.events.EventType.FOCUS));

  // starts typing something
  textarea.dispatchEvent(newBrowserEvent({
    type: goog.events.EventType.KEYDOWN,
    keyCode: goog.events.KeyCodes.A
  }));
  assertTrue(handler.getState() == goog.events.PasteHandler.State.TYPING);
  assertFalse(pasted);

  // and then presses ctrl+v
  textarea.dispatchEvent(newBrowserEvent({
    type: goog.events.EventType.KEYDOWN,
    keyCode: goog.events.KeyCodes.V,
    ctrlKey: true
  }));
  assertTrue(handler.getState() == goog.events.PasteHandler.State.TYPING);

  // makes sure we detected it
  assertTrue(pasted);
}

function testMouseOverOnInit() {
  // user has something on the events
  textarea.value = 'pasted string';
  // and right click -> paste it on the textarea, WITHOUT giving focus
  textarea.dispatchEvent(newBrowserEvent(goog.events.EventType.MOUSEOVER));
  assertTrue(handler.getState() == goog.events.PasteHandler.State.INIT);
  // makes sure we detect it
  assertTrue(pasted);

  pasted = false;

  // user normaly mouseovers the textarea, with no text change
  textarea.dispatchEvent(goog.events.EventType.MOUSEOVER);
  assertTrue(handler.getState() == goog.events.PasteHandler.State.INIT);
  // text area value doesnt change
  assertFalse(pasted);
}

function testMouseOverAfterTyping() {
  textarea.dispatchEvent(goog.events.EventType.FOCUS);
  assertFalse(pasted);
  textarea.dispatchEvent(
      {type: goog.events.EventType.KEYDOWN, keyCode: goog.events.KeyCodes.A});
  assertFalse(pasted);
  textarea.value = 'a';
  textarea.dispatchEvent('input');
  assertFalse(pasted);
  assertEquals('a', handler.oldValue_);
  textarea.dispatchEvent(goog.events.EventType.MOUSEOVER);
  assertFalse(pasted);
}

function testTypingAndThenRightClickPaste() {
  textarea.dispatchEvent(goog.events.EventType.FOCUS);

  textarea.dispatchEvent(
      {type: goog.events.EventType.KEYDOWN, keyCode: goog.events.KeyCodes.A});
  assertFalse(pasted);
  textarea.value = 'a';
  clock.tick(
      goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER +
      1);
  textarea.dispatchEvent('input');
  assertFalse(pasted);

  assertEquals('a', handler.oldValue_);

  textarea.value = 'ab';
  clock.tick(
      goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER +
      1);
  textarea.dispatchEvent(newBrowserEvent('input'));
  assertTrue(pasted);
}

function testTypingReallyFastDispatchesTwoInputEventsBeforeTheKeyDownEvent() {
  textarea.dispatchEvent(goog.events.EventType.FOCUS);

  // keydown and input events seems to be fired indepently: even though input
  // should happen after the key event, it doens't if the user types fast
  // enough. FF2 + linux doesn't fire keydown events for every key pressed when
  // you type fast enough. if one of the keydown events gets swallowed, two
  // input events are fired consecutively. notice that there is a similar
  // scenario, that actually does produce a valid paste action.
  // {@see testRightClickRightClickAlsoDispatchesTwoConsecutiveInputEvents}

  textarea.dispatchEvent(
      {type: goog.events.EventType.KEYDOWN, keyCode: goog.events.KeyCodes.A});
  assertFalse(pasted);
  textarea.value = 'a';
  clock.tick(
      goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER -
      1);
  textarea.dispatchEvent('input');
  assertFalse(pasted);

  // second key down events gets fired on a different order
  textarea.value = 'ab';
  clock.tick(
      goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER -
      1);
  textarea.dispatchEvent('input');
  assertFalse(pasted);
}

function testRightClickRightClickAlsoDispatchesTwoConsecutiveInputEvents() {
  textarea.dispatchEvent(goog.events.EventType.FOCUS);

  // there is also another case that two consecutive INPUT events are fired,
  // but in a valid paste action: if the user edit -> paste -> edit -> paste,
  // it is a valid paste action.

  textarea.value = 'a';
  clock.tick(
      goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER +
      1);
  textarea.dispatchEvent(newBrowserEvent('input'));
  assertTrue(pasted);

  // second key down events gets fired on a different order
  textarea.value = 'ab';
  clock.tick(
      goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER +
      1);
  textarea.dispatchEvent(newBrowserEvent('input'));
  assertTrue(pasted);
}

function testMiddleClickWithoutFocusTriggersPasteEvent() {
  // if the textarea is NOT selected, and then we use the middle button,
  // FF2+linux pastes what was last highlighted, causing a paste action.
  textarea.dispatchEvent(goog.events.EventType.FOCUS);
  textarea.dispatchEvent(newBrowserEvent('input'));
  assertTrue(pasted);
}


function testMacRightClickPasteRequiresToPressCtrlBecauseItDoesntHaveTwoMouseButtons() {
  // Macs don't have two buttons mouse: this means that you need to press
  // ctrl + click to get to the menu, and then you can click paste.
  // The sequences of events fired on Opera are:
  // focus -> keydown (keyCode == 0, not e.ctrlKey) -> input
  goog.userAgent.OPERA = true;
  goog.userAgent.MAC = true;
  var handler = new goog.events.PasteHandler(textarea);
  // user clicks on the textarea and give it focus
  goog.events.listen(handler,
      goog.events.PasteHandler.EventType.PASTE,
      function() {
        pasted = true;
      });
  textarea.dispatchEvent(goog.events.EventType.FOCUS);
  assertFalse(pasted);
  textarea.dispatchEvent({type: goog.events.EventType.KEYDOWN, keyCode: 0});
  assertFalse(pasted);
  clock.tick(
      goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER +
      1);
  textarea.dispatchEvent(newBrowserEvent('input'));
  assertTrue(pasted);
}

function testOperaOnMacFiresKeyCode17WhenAppleKeyIsPressedButDoesNotFireAnKeyDownOnVLater() {
  // Opera on Macs fires keycode 17 when apple key is pressed, and then it does
  // not fire a keydown event when the V is pressed.
  goog.userAgent.OPERA = true;
  goog.userAgent.MAC = true;
  var handler = new goog.events.PasteHandler(textarea);
  // user clicks on the textarea and give it focus
  goog.events.listen(handler,
      goog.events.PasteHandler.EventType.PASTE,
      function() {
        pasted = true;
      });
  textarea.dispatchEvent(goog.events.EventType.FOCUS);
  assertFalse(pasted);
  // apple key is pressed, generating a keydown event
  textarea.dispatchEvent({type: goog.events.EventType.KEYDOWN, keyCode: 17});
  assertFalse(pasted);
  clock.tick(
      goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER +
      1);
  // and then text is added magically without any extra keydown events.
  textarea.dispatchEvent(newBrowserEvent('input'));
  assertTrue(pasted);
}

function testScriptingDoesntTriggerPasteEvents() {
  var handlerUsedToListenForScriptingChanges =
      new goog.events.PasteHandler(textarea);
  pasted = false;
  // user clicks on the textarea and give it focus
  goog.events.listen(handlerUsedToListenForScriptingChanges,
      goog.events.PasteHandler.EventType.PASTE,
      function() {
        pasted = true;
      });
  goog.dom.getElement('foo').value = 'dear paste handler,';
  assertFalse(pasted);
  goog.dom.getElement('foo').value = 'please dont misunderstand script changes';
  assertFalse(pasted);
  goog.dom.getElement('foo').value = 'with user generated paste events';
  assertFalse(pasted);
  goog.dom.getElement('foo').value = 'thanks!';
  assertFalse(pasted);
}

">n/a</td></tr>
<tr><td>onlinelistener_test.html</td><td>Fail</td><td> 3 passed, 1 failed.</td><td title="


goog.require('goog.events.OnlineHandler');
goog.require('goog.userAgent');
goog.require('goog.testing.jsunit');
goog.require('goog.testing.MockClock');




var IE = goog.userAgent.IE;
var GECKO = goog.userAgent.GECKO;
var OPERA = goog.userAgent.OPERA;
var VERSION = goog.userAgent.VERSION;

var browserNames = ['OPERA', 'IE', 'GECKO', 'CAMINO', 'WEBKIT'];
var orgFlags = [];
var orgVersion;

function saveUserAgent() {
  for (var i = 0; i < browserNames.length; i++) {
    orgFlags[i] = goog.userAgent[browserNames[i]];
  }
  orgVersion = goog.userAgent.VERSION;
}

function setUserAgent(s, v) {
  for (var i = 0; i < browserNames.length; i++) {
    goog.userAgent[browserNames[i]] = browserNames[i] == s;
  }
  goog.userAgent.VERSION = v;
  goog.userAgent.isVersionCache_ = {};
}

function restoreUserAgent() {
  for (var i = 0; i < browserNames.length; i++) {
    goog.userAgent[browserNames[i]] = orgFlags[i];
  }
  goog.userAgent.VERSION = orgVersion;
  goog.userAgent.isVersionCache_ = {};

}

function setUpPage() {
  saveUserAgent();
}

// Store original isOnline method since some tests override this and we want to
// restore it after each test.
var orgIsOnline = goog.events.OnlineHandler.prototype.isOnline;

function tearDown() {
  restoreUserAgent();
  // Restore isOnline method.
  goog.events.OnlineHandler.prototype.isOnline = orgIsOnline;
}

function testSupportsHtml5Events_() {
  // Firefox 3+
  setUserAgent('GECKO', '1.9b');
  assertTrue(goog.events.OnlineHandler.supportsHtml5Events_());
  setUserAgent('GECKO', '1.9');
  assertTrue(goog.events.OnlineHandler.supportsHtml5Events_());
  setUserAgent('GECKO', '2');
  assertTrue(goog.events.OnlineHandler.supportsHtml5Events_());

  // Firefox 2-
  setUserAgent('GECKO', '1.8');
  assertFalse(goog.events.OnlineHandler.supportsHtml5Events_());
  setUserAgent('GECKO', '1.5');
  assertFalse(goog.events.OnlineHandler.supportsHtml5Events_());

  // IE8+
  setUserAgent('IE', '8');
  assertTrue(goog.events.OnlineHandler.supportsHtml5Events_());
  setUserAgent('IE', '9');
  assertTrue(goog.events.OnlineHandler.supportsHtml5Events_());

  // IE7-
  setUserAgent('IE', '7');
  assertFalse(goog.events.OnlineHandler.supportsHtml5Events_());
  setUserAgent('IE', '6');
  assertFalse(goog.events.OnlineHandler.supportsHtml5Events_());

  // Opera 9.5+
  setUserAgent('OPERA', '9.5');
  assertTrue(goog.events.OnlineHandler.supportsHtml5Events_());
  setUserAgent('OPERA', '10');
  assertTrue(goog.events.OnlineHandler.supportsHtml5Events_());

  // Opera 9-
  setUserAgent('OPERA', '9');
  assertFalse(goog.events.OnlineHandler.supportsHtml5Events_());
  setUserAgent('OPERA', '8');
  assertFalse(goog.events.OnlineHandler.supportsHtml5Events_());


  // WebKit
  setUserAgent('WEBKIT', '522');
  assertFalse(goog.events.OnlineHandler.supportsHtml5Events_());
  setUserAgent('WEBKIT', '528');
  assertTrue(goog.events.OnlineHandler.supportsHtml5Events_());
}

function testConstructAndDispose() {
  var oh = new goog.events.OnlineHandler;
  oh.dispose();
}

function testNonHtml5() {
  var clock = new goog.testing.MockClock(true);
  setUserAgent('IE', '7');

  // Override isOnline to let us control it.
  var online = true;
  goog.events.OnlineHandler.prototype.isOnline = function() {
    return online;
  };
  var onlineCount = 0;
  var offlineCount = 0;

  var oh = new goog.events.OnlineHandler;
  goog.events.listen(oh, goog.events.OnlineHandler.EventType.ONLINE,
                     function(e) {
                       assertTrue(oh.isOnline());
                       onlineCount++;
                     });
  goog.events.listen(oh, goog.events.OnlineHandler.EventType.OFFLINE,
                     function(e) {
                       assertFalse(oh.isOnline());
                       offlineCount++;
                     });

  clock.tick(500);
  online = false;
  clock.tick(500);

  assertEquals(0, onlineCount);
  assertEquals(1, offlineCount);

  online = true;
  clock.tick(500);

  assertEquals(1, onlineCount);
  assertEquals(1, offlineCount);

  oh.dispose();
  clock.dispose();
}

function testHtml5() {
  setUserAgent('GECKO', '1.9');

  // Override isOnline to let us control it.
  var online = true;
  goog.events.OnlineHandler.prototype.isOnline = function() {
    return online;
  };
  var onlineCount = 0;
  var offlineCount = 0;

  var oh = new goog.events.OnlineHandler;
  goog.events.listen(oh, goog.events.OnlineHandler.EventType.ONLINE,
                     function(e) {
                       assertEquals(goog.events.OnlineHandler.EventType.ONLINE,
                                    e.type);
                       assertTrue(oh.isOnline());
                       onlineCount++;
                     });

  goog.events.listen(oh, goog.events.OnlineHandler.EventType.OFFLINE,
                     function(e) {
                       assertEquals(goog.events.OnlineHandler.EventType.OFFLINE,
                                    e.type);
                       assertFalse(oh.isOnline());
                       offlineCount++;
                     });

  online = false;
  var e = new goog.events.Event('offline');
  goog.events.fireListeners(document.body, e.type, false, e);

  assertEquals(0, onlineCount);
  assertEquals(1, offlineCount);

  online = true;
  e = new goog.events.Event('online');
  goog.events.fireListeners(document.body, e.type, false, e);

  assertEquals(1, onlineCount);
  assertEquals(1, offlineCount);

  oh.dispose();
}

">4 of 4 tests run in 9ms.<br />3 passed, 1 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testHtml5<br />Cannot read property 'closure_uid_uvi9kb' of undefined<br /></td></tr>
<tr><td>browserevent_test.html</td><td>Success</td><td> 4 passed, 0 failed.</td><td title="


goog.require('goog.events.BrowserEvent');
goog.require('goog.testing.PropertyReplacer');
goog.require('goog.testing.jsunit');
goog.require('goog.userAgent');





var stubs = new goog.testing.PropertyReplacer();
var Button = goog.events.BrowserEvent.MouseButton;

function setUp() {
  stubs.reset();
}


/**
 * @see https://bugzilla.mozilla.org/show_bug.cgi?id=497780
 */
function testInvalidNodeBug() {
  if (!goog.userAgent.GECKO) return;

  var event = {};
  event.relatedTarget = {};
  event.relatedTarget.__defineGetter__(
      'nodeName',
      function() {
        throw Error('https://bugzilla.mozilla.org/show_bug.cgi?id=497780');
      });
  assertThrows(function() { return event.relatedTarget.nodeName; });

  var bEvent = new goog.events.BrowserEvent(event);
  assertEquals(event, bEvent.event_);
  assertNull(bEvent.relatedTarget);
}

function testIsButtonIe() {
  stubs.set(goog.events.BrowserFeature, 'HAS_W3C_BUTTON', false);
  assertIsButton(
      createBrowserEvent('mousedown', 1),
      Button.LEFT,
      true);
  assertIsButton(
      createBrowserEvent('click', 0),
      Button.LEFT,
      true);
  assertIsButton(
      createBrowserEvent('mousedown', 2),
      Button.RIGHT,
      false);
  assertIsButton(
      createBrowserEvent('mousedown', 4),
      Button.MIDDLE,
      false);
}

function testIsButtonWebkitMac() {
  stubs.set(goog.events.BrowserFeature, 'HAS_W3C_BUTTON', true);
  stubs.set(goog.userAgent, 'WEBKIT', true);
  stubs.set(goog.userAgent, 'MAC', true);
  assertIsButton(
      createBrowserEvent('mousedown', 0),
      Button.LEFT,
      true);
  assertIsButton(
      createBrowserEvent('mousedown', 0, true),
      Button.LEFT,
      false);
  assertIsButton(
      createBrowserEvent('mousedown', 2),
      Button.RIGHT,
      false);
  assertIsButton(
      createBrowserEvent('mousedown', 2, true),
      Button.RIGHT,
      false);
  assertIsButton(
      createBrowserEvent('mousedown', 1),
      Button.MIDDLE,
      false);
  assertIsButton(
      createBrowserEvent('mousedown', 1, true),
      Button.MIDDLE,
      false);
}

function testIsButtonGecko() {
  stubs.set(goog.events.BrowserFeature, 'HAS_W3C_BUTTON', true);
  stubs.set(goog.userAgent, 'GECKO', true);
  stubs.set(goog.userAgent, 'MAC', true);
  assertIsButton(
      createBrowserEvent('mousedown', 0),
      Button.LEFT,
      true);
  assertIsButton(
      createBrowserEvent('mousedown', 2, true),
      Button.RIGHT,
      false);
}

function createBrowserEvent(type, button, opt_ctrlKey) {
  return new goog.events.BrowserEvent({
    type: type,
    button: button,
    ctrlKey: !!opt_ctrlKey
  });
}

function assertIsButton(event, button, isActionButton) {
  for (var key in Button) {
    assertEquals(
        'Testing isButton(' + key + ') against ' +
        button + ' and type ' + event.type,
        Button[key] == button, event.isButton(Button[key]));
  }

  assertEquals(isActionButton, event.isMouseActionButton());
}

">n/a</td></tr>
<tr><td>eventtarget_test.html</td><td>Success</td><td> 14 passed, 0 failed.</td><td title="

  goog.require('goog.events.Event');
  goog.require('goog.events.EventTarget');
  goog.require('goog.testing.jsunit');



  /**
   * Class that implements EventTarget and dispatches a custom event 'count'
   */
  function TargetClass() {
    this.count = 0;
  };
  goog.inherits(TargetClass, goog.events.EventTarget);

  TargetClass.prototype.increment = function() {
    this.count++;
    return this.dispatchEvent(new MyEvent());
  };

  TargetClass.prototype.reset = function() {
    this.count = 0;
  };


  /**
   * Class that is set up to listen to the target
   */
  function ListenerClass() {
    this.count = 0;
  };

  ListenerClass.prototype.reset = function() {
    this.count = 0;
  };

  ListenerClass.prototype.justListen1 = function(e) {
    this.count++;
  };

  ListenerClass.prototype.justListen2 = function(e) {
    this.count++;
  };

  ListenerClass.prototype.justListen3 = function(e) {
    this.count++;
  };

  ListenerClass.prototype.preventDefault = function(e) {
    this.count++;
    e.preventDefault();
  };

  ListenerClass.prototype.stopPropagation = function(e) {
    this.count++;
    e.stopPropagation();
  };

  ListenerClass.prototype.returnFalse = function(e) {
    this.count++;
    return false;
  };

  ListenerClass.prototype.handleEvent = function(e) {
    if (e.type == 'count') {
      this.count++;
    }
  };

  function MyEvent(obj) {
    this.type = 'count';
  }
  goog.inherits(MyEvent, goog.events.Event);

  /**
   * No listeners
   */
  function testNoListeners() {
    var target = new TargetClass();
    var listener = new ListenerClass();

    var result = target.increment();

    assertEquals(0, listener.count);
    assertTrue(result);

    assertEquals('0 listeners should be removed',
                 0, goog.events.removeAll(target));
  }


  /**
   * Basic test of listeners
   */
  function testBasicEventTarget() {
    var target = new TargetClass();
    var listener = new ListenerClass();

    goog.events.listen(target, 'count', listener.justListen1, false, listener);
    goog.events.listen(target, 'count', listener.justListen2, false, listener);
    goog.events.listen(target, 'count', listener.justListen3, false, listener);

    var result = target.increment();

    assertEquals(3, listener.count);
    assertTrue(result);

    assertEquals('3 listeners should be removed',
                 3, goog.events.removeAll(target));
  }

  /**
   * Just Capture
   */
  function testJustCapture() {
    var target = new TargetClass();
    var listener = new ListenerClass();

    goog.events.listen(target, 'count', listener.justListen1, true, listener);

    var result = target.increment();

    assertEquals(1, listener.count);
    assertTrue(result);

    assertEquals('1 listeners should be removed',
                 1, goog.events.removeAll(target));
  }

  /**
   * Just Bubble
   */
  function testJustBubble() {
    var target = new TargetClass();
    var listener = new ListenerClass();

    goog.events.listen(target, 'count', listener.justListen1, false, listener);

    var result = target.increment();

    assertEquals(1, listener.count);
    assertTrue(result);

    assertEquals('1 listeners should be removed',
                 1, goog.events.removeAll(target));
  }

  /**
   * Basic test of listeners
   */
  function testCaptureAndBubble() {
    var target = new TargetClass();
    var listener = new ListenerClass();

    goog.events.listen(target, 'count', listener.justListen1, true, listener);
    goog.events.listen(target, 'count', listener.justListen2, true, listener);
    goog.events.listen(target, 'count', listener.justListen3, true, listener);
    goog.events.listen(target, 'count', listener.justListen1, false, listener);
    goog.events.listen(target, 'count', listener.justListen2, false, listener);
    goog.events.listen(target, 'count', listener.justListen3, false, listener);

    var result = target.increment();

    assertEquals(6, listener.count);
    assertTrue(result);

    assertEquals('6 listeners should be removed',
                 6, goog.events.removeAll(target));
  }


  /**
   * Test of prevent default
   */
  function testPreventDefault() {
    var target = new TargetClass();
    var listener = new ListenerClass();

    goog.events.listen(target, 'count', listener.justListen1, false, listener);
    goog.events.listen(target, 'count', listener.justListen2, false, listener);
    goog.events.listen(target, 'count', listener.preventDefault, false,
                       listener);

    var result = target.increment();

    assertEquals(3, listener.count);
    assertFalse(result);

    assertEquals('3 listeners should be removed',
                 3, goog.events.removeAll(target));
  }


  /**
   * Test of stop propagation
   */
  function testStopPropagation() {
    var target = new TargetClass();
    var listener = new ListenerClass();

    goog.events.listen(target, 'count', listener.justListen1, true, listener);
    goog.events.listen(target, 'count', listener.stopPropagation, true,
                       listener);
    goog.events.listen(target, 'count', listener.justListen1, false, listener);
    goog.events.listen(target, 'count', listener.justListen2, false, listener);

    var result = target.increment();

    assertEquals(2, listener.count);
    assertTrue(result);

    assertEquals('4 listeners should be removed',
                 4, goog.events.removeAll(target));
  }


  /**
   * Test of stop propagation and prevent default
   */
  function testStopPropagationAndPreventDefaultAtCapture() {
    var target = new TargetClass();
    var listener = new ListenerClass();

    goog.events.listen(target, 'count', listener.preventDefault, true,
                       listener);
    goog.events.listen(target, 'count', listener.stopPropagation, true,
                       listener);
    goog.events.listen(target, 'count', listener.justListen1, false, listener);
    goog.events.listen(target, 'count', listener.justListen2, false, listener);

    var result = target.increment();

    assertEquals(2, listener.count);
    assertFalse(result);

    assertEquals('4 listeners should be removed',
                 4, goog.events.removeAll(target));
  }


  /**
   * Test of stop propagation and prevent default
   */
  function testStopPropagationAndPreventDefaultAtBubble() {
    var target = new TargetClass();
    var listener = new ListenerClass();

    goog.events.listen(target, 'count', listener.justListen2, true, listener);
    goog.events.listen(target, 'count', listener.stopPropagation, true,
                       listener);
    goog.events.listen(target, 'count', listener.justListen1, false, listener);
    goog.events.listen(target, 'count', listener.preventDefault, false,
                       listener);

    var result = target.increment();

    assertEquals(2, listener.count);

    // Should be true because stop propagation cancelled the listener that
    // prevented default
    assertTrue(result);

    assertEquals('4 listeners should be removed',
                 4, goog.events.removeAll(target));
  }


  /**
   * Test return false
   */
  function testReturnFalse() {
    var target = new TargetClass();
    var listener = new ListenerClass();

    goog.events.listen(target, 'count', listener.justListen1, false, listener);
    goog.events.listen(target, 'count', listener.returnFalse, false, listener);
    goog.events.listen(target, 'count', listener.justListen3, false, listener);

    var result = target.increment();
    assertEquals(3, listener.count);
    assertFalse(result);

    assertEquals('3 listeners should be removed',
                 3, goog.events.removeAll(target));
  }

  function testHandleEvent() {
    var target = new TargetClass();
    var listener1 = new ListenerClass();
    var listener2 = new ListenerClass();
    var listener3 = new ListenerClass();

    goog.events.listen(target, 'count', listener1, false);
    goog.events.listen(target, 'count', listener2, false);
    goog.events.listen(target, 'count', listener3, false);

    target.increment();
    target.increment();
    var result = target.increment();
    assertEquals(3, listener1.count);
    assertEquals(3, listener2.count);
    assertEquals(3, listener3.count);
    assertTrue(result);

    assertEquals('3 listeners should be removed',
                 3, goog.events.removeAll(target));

  }


  function testListenOnce() {
    var target = new TargetClass();
    var listener = new ListenerClass();

    goog.events.listenOnce(target, 'count', listener.justListen1, false,
                           listener);
    goog.events.listenOnce(target, 'count', listener.justListen2, false,
                           listener);
    goog.events.listenOnce(target, 'count', listener.justListen3, false,
                           listener);

    var result = target.increment();

    assertEquals('listener count', 3, listener.count);
    assertTrue(result);

    // Increment again. This time all the listeners should have been removed
    result = target.increment();

    assertEquals(3, listener.count);
    assertTrue(result);
    assertEquals('0 listeners should be removed',
                 0, goog.events.removeAll(target));

    // Increment again to make sure that unlisten works
    goog.events.listenOnce(target, 'count', listener.justListen1, false,
                           listener);
    goog.events.unlisten(target, 'count', listener.justListen1, false,
                         listener);

    result = target.increment();
    assertEquals(3, listener.count);
    assertTrue(result);
    assertEquals('0 listeners should be removed',
                 0, goog.events.removeAll(target));

    // We now test that we can unlisten in the listener without breaking things
    var f = function(e) {
      goog.events.unlisten(target, 'count', f, false);
      return listener.justListen1(e);
    };
    goog.events.listenOnce(target, 'count', f, false);

    result = target.increment();
    assertEquals(4, listener.count);
    assertTrue(result);
    assertEquals('0 listeners should be removed',
                 0, goog.events.removeAll(target));
  }

  function testUnlistenInListen() {
    var target = new TargetClass();
    var listener = new ListenerClass();

    var f = function(e) {
      goog.events.unlisten(target, 'count', listener.justListen1, false,
                           listener);
      goog.events.unlisten(target, 'count', f, false);
      goog.events.unlisten(target, 'count', listener.justListen3, false,
                           listener);
      listener.justListen2(e);
    };

    goog.events.listen(target, 'count', listener.justListen1, false, listener);
    goog.events.listen(target, 'count', f, false);
    goog.events.listen(target, 'count', listener.justListen3, false, listener);

    var result = target.increment();

    assertEquals('justListen3 should not be called', 2, listener.count);
    assertTrue(result);

    assertEquals('0 listeners should be removed',
                 0, goog.events.removeAll(target));
  }

  function testParentEventTarget() {
    var child = new TargetClass();
    var parent = new TargetClass();

    assertNull('Parent event target should default to null',
        child.getParentEventTarget());

    child.setParentEventTarget(parent);

    assertEquals('Parent event target should be set', parent,
        child.getParentEventTarget());

    var listener = new ListenerClass();
    goog.events.listen(parent, 'count', listener.justListen1, false, listener);
    child.increment();

    assertEquals('Event should have bubbled to the parent', 1,
        listener.count);
  }

">n/a</td></tr>
<tr><td>imehandler_test.html</td><td>Fail</td><td> undefined</td><td title="


goog.require('goog.array');
goog.require('goog.dom');
goog.require('goog.events.ImeHandler');
goog.require('goog.object');
goog.require('goog.testing.PropertyReplacer');
goog.require('goog.testing.events');
goog.require('goog.testing.jsunit');





var sandbox = goog.dom.getElement('sandbox');
var imeHandler;
var eventsFired;
var stubs = new goog.testing.PropertyReplacer();
var eventTypes = goog.events.ImeHandler.EventType;

function setUp() {
}

function initImeHandler() {
  goog.events.ImeHandler.USES_COMPOSITION_EVENTS =
      goog.userAgent.GECKO || goog.userAgent.product.CHROME;
  imeHandler = new goog.events.ImeHandler(sandbox);
  eventsFired = [];
  goog.events.listen(
      imeHandler,
      goog.object.getValues(goog.events.ImeHandler.EventType),
      function(e) {
        eventsFired.push(e.type);
      });
}

function tearDown() {
  imeHandler.dispose();
  imeHandler = null;

  stubs.reset();
}

function tearDownPage() {
  // Set up a test bed.
  sandbox.innerHTML = '<div contentEditable="true">hello world</div>';
  initImeHandler();

  function unshiftEvent(e) {
    last10Events.unshift(e.type + ':' + e.keyCode + ':' +
        goog.string.htmlEscape(goog.dom.getTextContent(sandbox)));
    last10Events.length = Math.min(last10Events.length, 10);
    goog.dom.getElement('logger').innerHTML = last10Events.join('<br/>');
  }

  var last10Events = [];
  goog.events.listen(
      imeHandler,
      goog.object.getValues(goog.events.ImeHandler.EventType),
      unshiftEvent);
  goog.events.listen(
      sandbox,
      ['keydown', 'textInput'],
      unshiftEvent);
}

function assertEventsFired(var_args) {
  assertArrayEquals(
      goog.array.clone(arguments), eventsFired);
}

function fireInputEvent(type) {
  return goog.testing.events.fireBrowserEvent(
      new goog.testing.events.Event(type, sandbox));
}

function fireImeKeySequence() {
  return fireKeySequence(goog.events.KeyCodes.WIN_IME);
}

function fireKeySequence(keyCode) {
  return (
      goog.testing.events.fireBrowserEvent(
          new goog.testing.events.Event('textInput', sandbox)) &
      goog.testing.events.fireKeySequence(
          sandbox, keyCode));
}

function testHandleKeyDown_GeckoCompositionEvents() {
  // This test verifies that our IME functions can dispatch IME events to
  // InputHandler in the expected order on Gecko.

  // Set the userAgent used for this test to Firefox.
  setUserAgent('GECKO');
  setProduct(null);
  stubs.set(goog.userAgent, 'MAC', false);
  initImeHandler();

  fireInputEvent('compositionstart');
  assertImeMode();

  fireInputEvent('compositionupdate');
  fireInputEvent('compositionupdate');

  fireInputEvent('compositionend');

  assertEventsFired(
      eventTypes.START, eventTypes.UPDATE, eventTypes.UPDATE, eventTypes.END);
  assertNotImeMode();
}

/**
 * Verifies that our IME functions can dispatch IME events to the input handler
 * in the expected order on Chrome. jsUnitFarm does not have Linux Chrome or
 * Mac Chrome. So, we manually change the platform and run this test three
 * times.
 */
function testChromeCompositionEventsLinux() {
  runChromeCompositionEvents('LINUX');
}

function testChromeCompositionEventsMac() {
  runChromeCompositionEvents('MAC');
}

function testChromeCompositionEventsWindows() {
  runChromeCompositionEvents('WINDOWS');
}

function runChromeCompositionEvents(platform) {
  setUserAgent('WEBKIT');
  setProduct('CHROME');
  stubs.set(goog.userAgent, platform, true);
  initImeHandler();

  fireImeKeySequence();

  fireInputEvent('compositionstart');
  assertImeMode();

  fireInputEvent('compositionupdate');
  fireInputEvent('compositionupdate');

  fireInputEvent('compositionend');
  assertEventsFired(
      eventTypes.START, eventTypes.UPDATE, eventTypes.UPDATE, eventTypes.END);
  assertNotImeMode();
}

/**
 * Ensures that the IME mode turn on/off correctly.
 */
function testHandlerKeyDownForIme_imeOnOff() {
  setUserAgent('IE');
  setProduct(null);
  initImeHandler();

  // Send a WIN_IME keyDown event and see whether IME mode turns on.
  fireImeKeySequence();
  assertImeMode();

  // Send keyDown events which should not turn off IME mode and see whether
  // IME mode holds on.
  fireKeySequence(goog.events.KeyCodes.SHIFT);
  assertImeMode();

  fireKeySequence(goog.events.KeyCodes.CTRL);
  assertImeMode();

  // Send a keyDown event with keyCode = ENTER and see whether IME mode
  // turns off.
  fireKeySequence(goog.events.KeyCodes.ENTER);
  assertNotImeMode();

  assertEventsFired(
      eventTypes.START, eventTypes.END);
}

/**
 * Ensures that IME mode turns off when keyup events which are involved
 * in commiting IME text occurred in Safari.
 */
function testHandleKeyUpForSafari() {
  setUserAgent('WEBKIT');
  setProduct('SAFARI');
  initImeHandler();

  fireImeKeySequence();
  assertImeMode();

  fireKeySequence(goog.events.KeyCodes.ENTER);
  assertNotImeMode();
}

/**
 * SCIM on Linux will fire WIN_IME keycodes for random characters.
 * Fortunately, all Linux-based browsers use composition events.
 * This test just verifies that we ignore the WIN_IME keycodes.
 */
function testScimFiresWinImeKeycodesGeckoLinux() {
  setUserAgent('GECKO');
  assertScimInputIgnored();
}

function testScimFiresWinImeKeycodesChromeLinux() {
  setUserAgent('WEBKIT');
  setProduct('CHROME');
  assertScimInputIgnored();
}

function assertScimInputIgnored() {
  initImeHandler();

  fireImeKeySequence();
  assertNotImeMode();

  fireInputEvent('compositionstart');
  assertImeMode();

  fireImeKeySequence();
  assertImeMode();

  fireInputEvent('compositionend');
  assertNotImeMode();
}

var userAgents = ['IE', 'GECKO', 'WEBKIT'];
var products = ['SAFARI', 'CHROME'];

function setUserAgent(userAgent) {
  for (var i = 0; i < userAgents.length; i++) {
    stubs.set(goog.userAgent, userAgents[i], userAgents[i] == userAgent);
  }
}

function setProduct(product) {
  for (var i = 0; i < products.length; i++) {
    stubs.set(goog.userAgent.product, products[i], products[i] == product);
  }
}

function assertImeMode() {
  assertTrue('Should be in IME mode.', imeHandler.isImeMode());
}

function assertNotImeMode() {
  assertFalse('Should not be in IME mode.', imeHandler.isImeMode());
}

">TypeError: Object #<Object> has no method 'attachEvent'
    at Object.listen (events/events.js:232:11)
    at [object Object].listen (events/eventhandler.js:163:21)
    at new <anonymous> (events/imehandler.js:89:9)
    at initImeHandler (_tmpclosuretest.js:28:16)
    at [object Object].tearDownPage (_tmpclosuretest.js:48:3)
    at [object Object].finalize (testing/testcase.js:356:8)
    at [object Object].cycleTests (testing/testcase.js:718:8)
    at [object Object].execute (testing/testcase.js:346:8)
    at [object Object].runTests (testing/testcase.js:488:8)
    at [object Object].execute (testing/testrunner.js:266:17)
</td></tr>
<tr><td>keyhandler_test.html</td><td>Fail</td><td> 6 passed, 3 failed.</td><td title="

  goog.require('goog.dom')
  goog.require('goog.events.KeyEvent');
  goog.require('goog.events.EventType');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');



  /**
   * Tests the key handler for the IE behavior.
   */
  function testIeStyleKeyHandling() {
    goog.userAgent.OPERA = false;
    goog.userAgent.IE = true;
    goog.userAgent.GECKO = false;
    goog.userAgent.CAMINO = false;
    goog.userAgent.WEBKIT = false;
    goog.userAgent.MAC = false;
    goog.userAgent.WINDOWS = true;
    goog.userAgent.LINUX = false;
    goog.events.KeyHandler.USES_KEYDOWN_ = true;

    var keyEvent, keyHandler = new goog.events.KeyHandler();
    goog.events.listen(keyHandler, goog.events.KeyHandler.EventType.KEY,
        function(e) { keyEvent = e; });

    fireKeyDown(keyHandler, goog.events.KeyCodes.ENTER);
    fireKeyPress(keyHandler, goog.events.KeyCodes.ENTER);
    assertEquals('Enter should fire a key event with the keycode 13',
                 goog.events.KeyCodes.ENTER,
                 keyEvent.keyCode);
    assertEquals('Enter should fire a key event with the charcode 0',
                 0,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.ESC);
    fireKeyPress(keyHandler, goog.events.KeyCodes.ESC);
    assertEquals('Esc should fire a key event with the keycode 27',
                 goog.events.KeyCodes.ESC,
                 keyEvent.keyCode);
    assertEquals('Esc should fire a key event with the charcode 0',
                 0,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.UP);
    assertEquals('Up should fire a key event with the keycode 38',
                 goog.events.KeyCodes.UP,
                 keyEvent.keyCode);
    assertEquals('Up should fire a key event with the charcode 0',
                 0,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.SEVEN, undefined, undefined,
        undefined, undefined, true);
    fireKeyPress(keyHandler, 38, undefined, undefined, undefined, undefined,
        true);
    assertEquals('Shift+7 should fire a key event with the keycode 55',
                 goog.events.KeyCodes.SEVEN,
                 keyEvent.keyCode);
    assertEquals('Shift+7 should fire a key event with the charcode 38',
                 38,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.A);
    fireKeyPress(keyHandler, 97);
    assertEquals('Lower case a should fire a key event with the keycode 65',
                 goog.events.KeyCodes.A,
                 keyEvent.keyCode);
    assertEquals('Lower case a should fire a key event with the charcode 97',
                 97,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.A);
    fireKeyPress(keyHandler, 65);
    assertEquals('Upper case A should fire a key event with the keycode 65',
                 goog.events.KeyCodes.A,
                 keyEvent.keyCode);
    assertEquals('Upper case A should fire a key event with the charcode 65',
                 65,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.DELETE);
    assertEquals('Delete should fire a key event with the keycode 46',
                 goog.events.KeyCodes.DELETE,
                 keyEvent.keyCode);
    assertEquals('Delete should fire a key event with the charcode 0',
                 0,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.PERIOD);
    fireKeyPress(keyHandler, 46);
    assertEquals('Period should fire a key event with the keycode 190',
                 goog.events.KeyCodes.PERIOD,
                 keyEvent.keyCode);
    assertEquals('Period should fire a key event with the charcode 46',
                 46,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.CTRL);
    fireKeyDown(keyHandler, goog.events.KeyCodes.A);
    assertEquals('A with control down should fire a key event',
                 goog.events.KeyCodes.A,
                 keyEvent.keyCode);

    // On IE, when Ctrl+<key> is held down, there is a KEYDOWN, a KEYPRESS, and
    // then a series of KEYDOWN events for each repeat.
    fireKeyDown(keyHandler, goog.events.KeyCodes.B, undefined, undefined, true);
    fireKeyPress(keyHandler, goog.events.KeyCodes.B, undefined, undefined,
        true);
    assertEquals('B with control down should fire a key event',
                 goog.events.KeyCodes.B,
                 keyEvent.keyCode);
    assertTrue('Ctrl should be down.', keyEvent.ctrlKey);
    assertFalse('Should not have repeat=true on the first key press.',
        keyEvent.repeat);
    // Fire one repeated keydown event.
    fireKeyDown(keyHandler, goog.events.KeyCodes.B, undefined, undefined, true);
    assertEquals('A with control down should fire a key event',
                 goog.events.KeyCodes.B,
                 keyEvent.keyCode);
    assertTrue('Should have repeat=true on key repeat.',
        keyEvent.repeat);
    assertTrue('Ctrl should be down.', keyEvent.ctrlKey);
  }


  /**
   * Tests the key handler for the Gecko behavior.
   */
  function testGeckoStyleKeyHandling() {
    goog.userAgent.OPERA = false;
    goog.userAgent.IE = false;
    goog.userAgent.GECKO = true;
    goog.userAgent.CAMINO = false;
    goog.userAgent.WEBKIT = false;
    goog.userAgent.MAC = false;
    goog.userAgent.WINDOWS = true;
    goog.userAgent.LINUX = false;
    goog.events.KeyHandler.USES_KEYDOWN_ = false;

    var keyEvent, keyHandler = new goog.events.KeyHandler();
    goog.events.listen(keyHandler, goog.events.KeyHandler.EventType.KEY,
        function(e) { keyEvent = e; });

    fireKeyDown(keyHandler, goog.events.KeyCodes.ENTER);
    fireKeyPress(keyHandler, goog.events.KeyCodes.ENTER);
    assertEquals('Enter should fire a key event with the keycode 13',
                 goog.events.KeyCodes.ENTER,
                 keyEvent.keyCode);
    assertEquals('Enter should fire a key event with the charcode 0',
                 0,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.ESC);
    fireKeyPress(keyHandler, goog.events.KeyCodes.ESC);
    assertEquals('Esc should fire a key event with the keycode 27',
                 goog.events.KeyCodes.ESC,
                 keyEvent.keyCode);
    assertEquals('Esc should fire a key event with the charcode 0',
                 0,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.UP);
    fireKeyPress(keyHandler, goog.events.KeyCodes.UP);
    assertEquals('Up should fire a key event with the keycode 38',
                 goog.events.KeyCodes.UP,
                 keyEvent.keyCode);
    assertEquals('Up should fire a key event with the charcode 0',
                 0,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.SEVEN, undefined, undefined,
        undefined, undefined, true);
    fireKeyPress(keyHandler, undefined, 38, undefined, undefined, undefined,
        true);
    assertEquals('Shift+7 should fire a key event with the keycode 55',
                 goog.events.KeyCodes.SEVEN,
                 keyEvent.keyCode);
    assertEquals('Shift+7 should fire a key event with the charcode 38',
                 38,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.A);
    fireKeyPress(keyHandler, undefined, 97);
    assertEquals('Lower case a should fire a key event with the keycode 65',
                 goog.events.KeyCodes.A,
                 keyEvent.keyCode);
    assertEquals('Lower case a should fire a key event with the charcode 97',
                 97,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.A);
    fireKeyPress(keyHandler, undefined, 65);
    assertEquals('Upper case A should fire a key event with the keycode 65',
                 goog.events.KeyCodes.A,
                 keyEvent.keyCode);
    assertEquals('Upper case A should fire a key event with the charcode 65',
                 65,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.DELETE);
    fireKeyPress(keyHandler, goog.events.KeyCodes.DELETE);
    assertEquals('Delete should fire a key event with the keycode 46',
                 goog.events.KeyCodes.DELETE,
                 keyEvent.keyCode);
    assertEquals('Delete should fire a key event with the charcode 0',
                 0,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.PERIOD);
    fireKeyPress(keyHandler, undefined, 46);
    assertEquals('Period should fire a key event with the keycode 190',
                 goog.events.KeyCodes.PERIOD,
                 keyEvent.keyCode);
    assertEquals('Period should fire a key event with the charcode 46',
                 46,
                 keyEvent.charCode);
  }


  /**
   * Tests the key handler for the Safari 3 behavior.
   */
  function testSafari3StyleKeyHandling() {
    goog.userAgent.OPERA = false;
    goog.userAgent.IE = false;
    goog.userAgent.GECKO = false;
    goog.userAgent.CAMINO = false;
    goog.userAgent.WEBKIT = true;
    goog.userAgent.MAC = true;
    goog.userAgent.WINDOWS = false;
    goog.userAgent.LINUX = false;
    goog.events.KeyHandler.USES_KEYDOWN_ = true;
    goog.userAgent.VERSION = 525.3;

    var keyEvent, keyHandler = new goog.events.KeyHandler();
    // Make sure all events are caught while testing
    goog.events.listen(keyHandler, goog.events.KeyHandler.EventType.KEY,
        function(e) { keyEvent = e; });

    fireKeyDown(keyHandler, goog.events.KeyCodes.ENTER);
    fireKeyPress(keyHandler, goog.events.KeyCodes.ENTER);
    assertEquals('Enter should fire a key event with the keycode 13',
                 goog.events.KeyCodes.ENTER,
                 keyEvent.keyCode);
    assertEquals('Enter should fire a key event with the charcode 0',
                 0,
                 keyEvent.charCode);
    fireKeyUp(keyHandler, goog.events.KeyCodes.ENTER);

    // Add a listener to ensure that an extra ENTER event is not dispatched
    // by a subsequent keypress.
    var enterCheck = goog.events.listen(keyHandler,
        goog.events.KeyHandler.EventType.KEY,
        function(e) {
          assertNotEquals('Unexpected ENTER keypress dispatched',
            e.keyCode, goog.events.KeyCodes.ENTER)
        });

    fireKeyDown(keyHandler, goog.events.KeyCodes.ESC);
    assertEquals('Esc should fire a key event with the keycode 27',
                 goog.events.KeyCodes.ESC,
                 keyEvent.keyCode);
    assertEquals('Esc should fire a key event with the charcode 0',
                 0,
                 keyEvent.charCode);
    fireKeyPress(keyHandler, goog.events.KeyCodes.ESC);
    goog.events.unlistenByKey(enterCheck);

    fireKeyDown(keyHandler, goog.events.KeyCodes.UP);
    assertEquals('Up should fire a key event with the keycode 38',
                 goog.events.KeyCodes.UP,
                 keyEvent.keyCode);
    assertEquals('Up should fire a key event with the charcode 0',
                 0,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.SEVEN, undefined, undefined,
        undefined, undefined, true);
    fireKeyPress(keyHandler, 38, 38, undefined, undefined, undefined, true);
    assertEquals('Shift+7 should fire a key event with the keycode 55',
                 goog.events.KeyCodes.SEVEN,
                 keyEvent.keyCode);
    assertEquals('Shift+7 should fire a key event with the charcode 38',
                 38,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.A);
    fireKeyPress(keyHandler, 97, 97);
    assertEquals('Lower case a should fire a key event with the keycode 65',
                 goog.events.KeyCodes.A,
                 keyEvent.keyCode);
    assertEquals('Lower case a should fire a key event with the charcode 97',
                 97,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.A);
    fireKeyPress(keyHandler, 65, 65);
    assertEquals('Upper case A should fire a key event with the keycode 65',
                 goog.events.KeyCodes.A,
                 keyEvent.keyCode);
    assertEquals('Upper case A should fire a key event with the charcode 65',
                 65,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.CTRL);
    fireKeyDown(keyHandler, goog.events.KeyCodes.A, null, null, true /*ctrl*/);
    assertEquals('A with control down should fire a key event',
                 goog.events.KeyCodes.A,
                 keyEvent.keyCode);

    // Test that Alt-Tab outside the window doesn't break things.
    fireKeyDown(keyHandler, goog.events.KeyCodes.ALT);
    keyEvent.keyCode = -1;  // Reset the event.
    fireKeyDown(keyHandler, goog.events.KeyCodes.A);
    assertEquals('Should not have dispatched an Alt-A', -1, keyEvent.keyCode);
    fireKeyPress(keyHandler, 65, 65);
    assertEquals('Alt should be ignored since it isn\'t currently depressed',
                 goog.events.KeyCodes.A,
                 keyEvent.keyCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.DELETE);
    assertEquals('Delete should fire a key event with the keycode 46',
                 goog.events.KeyCodes.DELETE,
                 keyEvent.keyCode);
    assertEquals('Delete should fire a key event with the charcode 0',
                 0,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.PERIOD);
    fireKeyPress(keyHandler, 46, 46);
    assertEquals('Period should fire a key event with the keycode 190',
                 goog.events.KeyCodes.PERIOD,
                 keyEvent.keyCode);
    assertEquals('Period should fire a key event with the charcode 46',
                 46,
                 keyEvent.charCode);

    // Safari sends zero key code for non-latin characters.
    fireKeyDown(keyHandler, 0, 0);
    fireKeyPress(keyHandler, 1092, 1092);
    assertEquals('Cyrillic small letter "Ef" should fire a key event with ' +
                     'the keycode 0',
                 0,
                 keyEvent.keyCode);
    assertEquals('Cyrillic small letter "Ef" should fire a key event with ' +
                     'the charcode 1092',
                 1092,
                 keyEvent.charCode);
  }


  /**
   * Tests the key handler for the Opera behavior.
   */
  function testOperaStyleKeyHandling() {
    goog.userAgent.OPERA = true;
    goog.userAgent.IE = false;
    goog.userAgent.GECKO = false;
    goog.userAgent.CAMINO = false;
    goog.userAgent.WEBKIT = false;
    goog.userAgent.MAC = false;
    goog.userAgent.WINDOWS = true;
    goog.userAgent.LINUX = false;
    goog.events.KeyHandler.USES_KEYDOWN_ = false;

    var keyEvent, keyHandler = new goog.events.KeyHandler();
    goog.events.listen(keyHandler, goog.events.KeyHandler.EventType.KEY,
        function(e) { keyEvent = e; });

    fireKeyDown(keyHandler, goog.events.KeyCodes.ENTER);
    fireKeyPress(keyHandler, goog.events.KeyCodes.ENTER);
    assertEquals('Enter should fire a key event with the keycode 13',
                 goog.events.KeyCodes.ENTER,
                 keyEvent.keyCode);
    assertEquals('Enter should fire a key event with the charcode 0',
                 0,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.ESC);
    fireKeyPress(keyHandler, goog.events.KeyCodes.ESC);
    assertEquals('Esc should fire a key event with the keycode 27',
                 goog.events.KeyCodes.ESC,
                 keyEvent.keyCode);
    assertEquals('Esc should fire a key event with the charcode 0',
                 0,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.UP);
    fireKeyPress(keyHandler, goog.events.KeyCodes.UP);
    assertEquals('Up should fire a key event with the keycode 38',
                 goog.events.KeyCodes.UP,
                 keyEvent.keyCode);
    assertEquals('Up should fire a key event with the charcode 0',
                 0,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.SEVEN, undefined, undefined,
        undefined, undefined, true);
    fireKeyPress(keyHandler, 38, undefined, undefined, undefined, undefined,
        true);
    assertEquals('Shift+7 should fire a key event with the keycode 55',
                 goog.events.KeyCodes.SEVEN,
                 keyEvent.keyCode);
    assertEquals('Shift+7 should fire a key event with the charcode 38',
                 38,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.A);
    fireKeyPress(keyHandler, 97);
    assertEquals('Lower case a should fire a key event with the keycode 65',
                 goog.events.KeyCodes.A,
                 keyEvent.keyCode);
    assertEquals('Lower case a should fire a key event with the charcode 97',
                 97,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.A);
    fireKeyPress(keyHandler, 65);
    assertEquals('Upper case A should fire a key event with the keycode 65',
                 goog.events.KeyCodes.A,
                 keyEvent.keyCode);
    assertEquals('Upper case A should fire a key event with the charcode 65',
                 65,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.DELETE);
    fireKeyPress(keyHandler, goog.events.KeyCodes.DELETE);
    assertEquals('Delete should fire a key event with the keycode 46',
                 goog.events.KeyCodes.DELETE,
                 keyEvent.keyCode);
    assertEquals('Delete should fire a key event with the charcode 0',
                 0,
                 keyEvent.charCode);

    fireKeyDown(keyHandler, goog.events.KeyCodes.PERIOD);
    fireKeyPress(keyHandler, 46);
    assertEquals('Period should fire a key event with the keycode 190',
                 goog.events.KeyCodes.PERIOD,
                 keyEvent.keyCode);
    assertEquals('Period should fire a key event with the charcode 46',
                 46,
                 keyEvent.charCode);
  }

  function testGeckoEqualSign() {
    goog.userAgent.OPERA = false;
    goog.userAgent.IE = false;
    goog.userAgent.GECKO = true;
    goog.userAgent.CAMINO = false;
    goog.userAgent.WEBKIT = false;
    goog.userAgent.MAC = false;
    goog.userAgent.WINDOWS = true;
    goog.userAgent.LINUX = false;
    goog.events.KeyHandler.USES_KEYDOWN_ = false;

    var keyEvent, keyHandler = new goog.events.KeyHandler();
    goog.events.listen(keyHandler, goog.events.KeyHandler.EventType.KEY,
        function(e) { keyEvent = e; });

    fireKeyDown(keyHandler, 61, 0);
    fireKeyPress(keyHandler, 0, 61);
    assertEquals('= should fire should fire a key event with the keyCode 187',
                 goog.events.KeyCodes.EQUALS,
                 keyEvent.keyCode);
    assertEquals('= should fire a key event with the charCode 61',
                 61,
                 keyEvent.charCode);
  }

  function testMacGeckoSlash() {
    goog.userAgent.OPERA = false;
    goog.userAgent.IE = false;
    goog.userAgent.GECKO = true;
    goog.userAgent.CAMINO = false;
    goog.userAgent.WEBKIT = false;
    goog.userAgent.MAC = true;
    goog.userAgent.WINDOWS = false;
    goog.userAgent.LINUX = false;
    goog.events.KeyHandler.USES_KEYDOWN_ = false;

    var keyEvent, keyHandler = new goog.events.KeyHandler();
    goog.events.listen(keyHandler, goog.events.KeyHandler.EventType.KEY,
        function(e) { keyEvent = e; });

    fireKeyDown(keyHandler, 0, 63, null, false, false, true);
    fireKeyPress(keyHandler, 0, 63, null, false, false, true);
    assertEquals('= should fire should fire a key event with the keyCode 191',
                 goog.events.KeyCodes.SLASH,
                 keyEvent.keyCode);
    assertEquals('= should fire a key event with the charCode 63',
                 goog.events.KeyCodes.QUESTION_MARK,
                 keyEvent.charCode);
  }

  function testGetElement() {
    var target = goog.dom.createDom('div');
    var target2 = goog.dom.createDom('div');
    var keyHandler = new goog.events.KeyHandler();
    assertNull(keyHandler.getElement());

    keyHandler.attach(target);
    assertEquals(target, keyHandler.getElement());

    keyHandler.attach(target2);
    assertNotEquals(target, keyHandler.getElement());
    assertEquals(target2, keyHandler.getElement());

    var doc = goog.dom.getDocument();
    keyHandler.attach(doc);
    assertEquals(doc, keyHandler.getElement());

    keyHandler = new goog.events.KeyHandler(doc);
    assertEquals(doc, keyHandler.getElement());

    keyHandler = new goog.events.KeyHandler(target);
    assertEquals(target, keyHandler.getElement());
  }

  function testDetach() {
    var target = goog.dom.createDom('div');
    var keyHandler = new goog.events.KeyHandler(target);
    assertEquals(target, keyHandler.getElement());

    fireKeyDown(keyHandler, 0, 63, null, false, false, true);
    fireKeyPress(keyHandler, 0, 63, null, false, false, true);
    keyHandler.detach();

    assertNull(keyHandler.getElement());
    // All listeners should be cleared.
    assertNull(keyHandler.keyDownKey_);
    assertNull(keyHandler.keyPressKey_);
    assertNull(keyHandler.keyUpKey_);
    // All key related state should be cleared.
    assertEquals('Last key should be -1', -1, keyHandler.lastKey_);
    assertEquals('keycode should be -1', -1, keyHandler.keyCode_);
  }

  function testCapturePhase() {
    var gotInCapturePhase;
    var gotInBubblePhase;

    var target = goog.dom.createDom('div');
    goog.events.listen(
        new goog.events.KeyHandler(target, false /* bubble */),
        goog.events.KeyHandler.EventType.KEY,
        function() {
          gotInBubblePhase = true;
          assertTrue(gotInCapturePhase);
        });
    goog.events.listen(
        new goog.events.KeyHandler(target, true /* capture */),
        goog.events.KeyHandler.EventType.KEY,
        function() {
          gotInCapturePhase = true;
        });

    goog.testing.events.fireKeySequence(target, goog.events.KeyCodes.ESC);
    assertTrue(gotInBubblePhase);
  }

  function fireKeyDown(keyHandler, keyCode, opt_charCode, opt_keyIdentifier,
      opt_ctrlKey, opt_altKey, opt_shiftKey) {
    var fakeEvent = createFakeKeyEvent(
        goog.events.EventType.KEYDOWN, keyCode, opt_charCode, opt_keyIdentifier,
        opt_ctrlKey, opt_altKey, opt_shiftKey);
    keyHandler.handleKeyDown_(fakeEvent);
    return fakeEvent.returnValue_;
  }

  function fireKeyPress(keyHandler, keyCode, opt_charCode, opt_keyIdentifier,
      opt_ctrlKey, opt_altKey, opt_shiftKey) {
    var fakeEvent = createFakeKeyEvent(
        goog.events.EventType.KEYPRESS, keyCode, opt_charCode,
        opt_keyIdentifier, opt_ctrlKey, opt_altKey, opt_shiftKey);
    keyHandler.handleEvent(fakeEvent);
    return fakeEvent.returnValue_;
  }

  function fireKeyUp(keyHandler, keyCode, opt_charCode, opt_keyIdentifier,
      opt_ctrlKey, opt_altKey, opt_shiftKey) {
    var fakeEvent = createFakeKeyEvent(
        goog.events.EventType.KEYUP, keyCode, opt_charCode,
        opt_keyIdentifier, opt_ctrlKey, opt_altKey, opt_shiftKey);
    keyHandler.handleKeyup_(fakeEvent);
    return fakeEvent.returnValue_;
  }

  function createFakeKeyEvent(type, keyCode, opt_charCode, opt_keyIdentifier,
      opt_ctrlKey, opt_altKey, opt_shiftKey) {
    var event = {
      type: type,
      keyCode: keyCode,
      charCode: opt_charCode || undefined,
      keyIdentifier: opt_keyIdentifier || undefined,
      ctrlKey: opt_ctrlKey || false,
      altKey: opt_altKey || false,
      shiftKey: opt_shiftKey || false,
      timeStamp: goog.now()
    };
    return new goog.events.BrowserEvent(event);
  }

">9 of 9 tests run in 14ms.<br />6 passed, 3 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testCapturePhase<br />Object #<Object> has no method 'createElement'<br />ERROR in testDetach<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetElement<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>keycodes_test.html</td><td>Success</td><td> 2 passed, 0 failed.</td><td title="


goog.require('goog.events.BrowserEvent');
goog.require('goog.events.KeyCodes');
goog.require('goog.object');
goog.require('goog.testing.jsunit');





var KeyCodes = goog.events.KeyCodes;

function testTextModifyingKeys() {
  var specialTextModifiers = goog.object.createSet(
      KeyCodes.BACKSPACE,
      KeyCodes.DELETE,
      KeyCodes.ENTER,
      KeyCodes.MAC_ENTER,
      KeyCodes.TAB,
      KeyCodes.WIN_IME);

  for (var keyId in KeyCodes) {
    var key = KeyCodes[keyId];
    if (goog.isFunction(key)) {
      // skip static methods
      continue;
    }

    var fakeEvent = new goog.events.BrowserEvent('keydown');
    fakeEvent.keyCode = key;

    if (KeyCodes.isCharacterKey(key) || (key in specialTextModifiers)) {
      assertTrue('Expected key to modify text: ' + keyId,
          KeyCodes.isTextModifyingKeyEvent(fakeEvent));
    } else {
      assertFalse('Expected key to not modify text: ' + keyId,
          KeyCodes.isTextModifyingKeyEvent(fakeEvent));
    }
  }
}

function testPhantomKey() {
  // KeyCode 255 deserves its own test to make sure this does not regress,
  // because it's so weird. See the comments in the KeyCode enum.
  var fakeEvent = new goog.events.BrowserEvent('keydown');
  fakeEvent.keyCode = goog.events.KeyCodes.PHANTOM;
  assertFalse('Expected phantom key to not modify text',
      KeyCodes.isTextModifyingKeyEvent(fakeEvent));
  assertFalse(KeyCodes.isCharacterKey(fakeEvent));
}

">n/a</td></tr>
<tr><td>filedrophandler_test.html</td><td>Success</td><td> 5 passed, 0 failed.</td><td title="

  goog.require('goog.events.FileDropHandler');
  goog.require('goog.events.FileDropHandler.EventType');
  goog.require('goog.events');
  goog.require('goog.events.BrowserEvent');
  goog.require('goog.events.EventTarget');
  goog.require('goog.events.EventType');
  goog.require('goog.testing.jsunit');



var textarea;
var doc;
var handler;
var dnd;
var files;

function setUp() {
  textarea = new goog.events.EventTarget();
  doc = new goog.events.EventTarget();
  textarea.ownerDocument = doc;
  handler = new goog.events.FileDropHandler(textarea);
  dnd = false;
  files = null;
  goog.events.listen(handler, goog.events.FileDropHandler.EventType.DROP,
      function(e) {
        dnd = true;
        files =
            e.getBrowserEvent().dataTransfer.files;
      });
}

function tearDown() {
  textarea.dispose();
  doc.dispose();
  handler.dispose();
}

function testOneFile() {
  var preventDefault = false;
  var expectedfiles = [{ fileName: 'file1.jpg' }];
  var dt = { types: ['Files'], files : expectedfiles };

  // Assert that default actions are prevented on dragenter.
  textarea.dispatchEvent(new goog.events.BrowserEvent({
      preventDefault : function() { preventDefault = true; },
      type : goog.events.EventType.DRAGENTER,
      dataTransfer : dt
  }));
  assertTrue(preventDefault);
  preventDefault = false;

  // Assert that default actions are prevented on dragover.
  textarea.dispatchEvent(new goog.events.BrowserEvent({
      preventDefault : function() { preventDefault = true; },
      type : goog.events.EventType.DRAGOVER,
      dataTransfer : dt
  }));
  assertTrue(preventDefault);
  preventDefault = false;
  // Assert that the drop effect is set to 'copy'.
  assertEquals('copy', dt.dropEffect);

  // Assert that default actions are prevented on drop.
  textarea.dispatchEvent(new goog.events.BrowserEvent({
      preventDefault : function() { preventDefault = true; },
      type : goog.events.EventType.DROP,
      dataTransfer : dt
  }));
  assertTrue(preventDefault);

  // Assert that DROP has been fired.
  assertTrue(dnd);
  assertEquals(1, files.length);
  assertEquals(expectedfiles[0].fileName, files[0].fileName);
}

function testMultipleFiles() {
  var preventDefault = false;
  var expectedfiles = [{ fileName: 'file1.jpg' }, { fileName: 'file2.jpg' }];
  var dt = { types: ['Files', 'text'], files : expectedfiles };

  // Assert that default actions are prevented on dragenter.
  textarea.dispatchEvent(new goog.events.BrowserEvent({
      preventDefault : function() { preventDefault = true; },
      type : goog.events.EventType.DRAGENTER,
      dataTransfer : dt
  }));
  assertTrue(preventDefault);
  preventDefault = false;

  // Assert that default actions are prevented on dragover.
  textarea.dispatchEvent(new goog.events.BrowserEvent({
      preventDefault : function() { preventDefault = true; },
      type : goog.events.EventType.DRAGOVER,
      dataTransfer : dt
  }));
  assertTrue(preventDefault);
  preventDefault = false;
  // Assert that the drop effect is set to 'copy'.
  assertEquals('copy', dt.dropEffect);

  // Assert that default actions are prevented on drop.
  textarea.dispatchEvent(new goog.events.BrowserEvent({
      preventDefault : function() { preventDefault = true; },
      type : goog.events.EventType.DROP,
      dataTransfer : dt
  }));
  assertTrue(preventDefault);

  // Assert that DROP has been fired.
  assertTrue(dnd);
  assertEquals(2, files.length);
  assertEquals(expectedfiles[0].fileName, files[0].fileName);
  assertEquals(expectedfiles[1].fileName, files[1].fileName);
}

function testNoFiles() {
  var preventDefault = false;
  var dt = { types: ['text'] };

  // Assert that default actions are not prevented on dragenter.
  textarea.dispatchEvent(new goog.events.BrowserEvent({
      preventDefault : function() { preventDefault = true; },
      type : goog.events.EventType.DRAGENTER,
      dataTransfer : dt
  }));
  assertFalse(preventDefault);
  preventDefault = false;

  // Assert that default actions are not prevented on dragover.
  textarea.dispatchEvent(new goog.events.BrowserEvent({
      preventDefault : function() { preventDefault = true; },
      type : goog.events.EventType.DRAGOVER,
      dataTransfer : dt
  }));
  assertFalse(preventDefault);
  preventDefault = false;

  // Assert that default actions are not prevented on drop.
  textarea.dispatchEvent(new goog.events.BrowserEvent({
      preventDefault : function() { preventDefault = true; },
      type : goog.events.EventType.DROP,
      dataTransfer : dt
  }));
  assertFalse(preventDefault);

  // Assert that DROP has not been fired.
  assertFalse(dnd);
  assertNull(files);
}

function testDragEnter() {
  var preventDefault = false;

  // Assert that default actions are prevented on dragenter.
  // In Chrome the dragenter event has an empty file list and the types is
  // set to 'Files'.
  textarea.dispatchEvent(new goog.events.BrowserEvent({
      preventDefault : function() { preventDefault = true; },
      type : goog.events.EventType.DRAGENTER,
      dataTransfer : { types: ['Files'], files : [] }
  }));
  assertTrue(preventDefault);
  preventDefault = false;

  // Assert that default actions are prevented on dragenter.
  // In Safari 4 the dragenter event has an empty file list and the types is
  // set to 'public.file-url'.
  textarea.dispatchEvent(new goog.events.BrowserEvent({
      preventDefault : function() { preventDefault = true; },
      type : goog.events.EventType.DRAGENTER,
      dataTransfer : { types: ['public.file-url'], files : [] }
  }));
  assertTrue(preventDefault);
  preventDefault = false;

  // Assert that default actions are not prevented on dragenter
  // when the drag contains no files.
  textarea.dispatchEvent(new goog.events.BrowserEvent({
      preventDefault : function() { preventDefault = true; },
      type : goog.events.EventType.DRAGENTER,
      dataTransfer : { types: ['text'], files : [] }
  }));
  assertFalse(preventDefault);
}

function testPreventDropOutside() {
  var preventDefault = false;
  var dt = { types: ['Files'], files : [{ fileName: 'file1.jpg' }] };

  // Assert that default actions are not prevented on dragenter on the
  // document outside the text area.
  doc.dispatchEvent(new goog.events.BrowserEvent({
      preventDefault : function() { preventDefault = true; },
      type : goog.events.EventType.DRAGENTER,
      dataTransfer : dt
  }));
  assertFalse(preventDefault);
  preventDefault = false;

  // Assert that default actions are not prevented on dragover on the
  // document outside the text area.
  doc.dispatchEvent(new goog.events.BrowserEvent({
      preventDefault : function() { preventDefault = true; },
      type : goog.events.EventType.DRAGOVER,
      dataTransfer : dt
  }));
  assertFalse(preventDefault);
  preventDefault = false;

  handler.dispose();
  // Create a new FileDropHandler that prevents drops outside the text area.
  handler = new goog.events.FileDropHandler(textarea, true);

  // Assert that default actions are now prevented on dragenter on the
  // document outside the text area.
  doc.dispatchEvent(new goog.events.BrowserEvent({
      preventDefault : function() { preventDefault = true; },
      type : goog.events.EventType.DRAGENTER,
      dataTransfer : dt
  }));
  assertTrue(preventDefault);
  preventDefault = false;

  // Assert that default actions are now prevented on dragover on the
  // document outside the text area.
  doc.dispatchEvent(new goog.events.BrowserEvent({
      preventDefault : function() { preventDefault = true; },
      type : goog.events.EventType.DRAGOVER,
      dataTransfer : dt
  }));
  assertTrue(preventDefault);
  preventDefault = false;
  // Assert also that the drop effect is set to 'none'.
  assertEquals('none', dt.dropEffect);
}

">n/a</td></tr>
<tr><td>event_test.html</td><td>Success</td><td> 4 passed, 0 failed.</td><td title="

    goog.require('goog.events.Event');
    goog.require('goog.events.EventTarget');
    goog.require('goog.testing.jsunit');
  

    var e, target;

    function setUp() {
      target = new goog.events.EventTarget();
      e = new goog.events.Event('eventType', target);
    }

    function tearDown() {
      target.dispose();
      e.dispose();
    }

    function testConstructor() {
      assertNotNull('Event must not be null', e);
      assertEquals('Event type must be as expected', 'eventType', e.type);
      assertEquals('Event target must be as expected', target, e.target);
      assertEquals('Current target must be as expected', target,
          e.currentTarget);
    }

    function testDispose() {
      assertFalse('Event must not have been disposed of', e.isDisposed());
      e.dispose();
      assertTrue('Event must have been disposed of', e.isDisposed());
      assertUndefined('Event type must have been deleted', e.type);
      assertUndefined('Event target reference must have been deleted',
          e.target);
      assertUndefined('Current target reference must have been deleted',
          e.currentTarget);
    }

    function testStopPropagation() {
      // This test breaks encapsulation because thre is no public getter for
      // propagationStopped_.
      assertFalse('Propagation must not have been stopped',
          e.propagationStopped_);
      e.stopPropagation();
      assertTrue('Propagation must have been stopped', e.propagationStopped_);
    }

    function testPreventDefault() {
      // This test breaks encapsulation because thre is no public getter for
      // returnValue_.
      assertTrue('Return value must be true', e.returnValue_);
      e.preventDefault();
      assertFalse('Return value must be false', e.returnValue_);
    }
  ">n/a</td></tr>
<tr><td>actionhandler_test.html</td><td>Fail</td><td> 0 passed, 3 failed.</td><td title="

  goog.require('goog.events.ActionHandler');
  goog.require('goog.dom');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');


  var actionHandler;
  function setUp() {
    actionHandler = new goog.events.ActionHandler(
        goog.dom.getElement('actionDiv'));
  }
  function tearDown() {
    actionHandler.dispose();
  }

  // Tests to see that both the BEFOREACTION and ACTION events are fired
  function testActionHandlerWithBeforeActionHandler() {
    var actionEventFired = false;
    var beforeActionFired = false;
    goog.events.listen(actionHandler, 
        goog.events.ActionHandler.EventType.ACTION, 
        function(e) {
          actionEventFired = true;
        });
    goog.events.listen(actionHandler, 
        goog.events.ActionHandler.EventType.BEFOREACTION, 
        function(e) {
          beforeActionFired = true;
        });
    goog.testing.events.fireClickSequence(goog.dom.getElement('actionDiv'));
    assertTrue("BEFOREACTION event was not fired", beforeActionFired);
    assertTrue("ACTION event was not fired", actionEventFired);
  }

  // Tests to see that the ACTION event is fired, even if there is no
  // BEFOREACTION handler.
  function testActionHandlerWithoutBeforeActionHandler() {
    var actionEventFired = false;
    goog.events.listen(actionHandler, 
        goog.events.ActionHandler.EventType.ACTION, 
        function(e) {actionEventFired = true;});
    goog.testing.events.fireClickSequence(goog.dom.getElement('actionDiv'));
    assertTrue("ACTION event was not fired", actionEventFired);
  }

  // If the BEFOREACTION listener swallows the event, it should cancel the
  // ACTION event.
  function testBeforeActionCancel() {
    var actionEventFired = false;
    var beforeActionFired = false;
    goog.events.listen(actionHandler, 
        goog.events.ActionHandler.EventType.ACTION, 
        function(e) {actionEvent = e;});
    goog.events.listen(actionHandler, 
        goog.events.ActionHandler.EventType.BEFOREACTION, 
        function(e) {
          beforeActionFired = true;
          e.preventDefault();
        });
    goog.testing.events.fireClickSequence(goog.dom.getElement('actionDiv'));
    assertTrue(beforeActionFired);
    assertFalse(actionEventFired);
  }
">3 of 3 tests run in 6ms.<br />0 passed, 3 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testActionHandlerWithBeforeActionHandler<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testActionHandlerWithoutBeforeActionHandler<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testBeforeActionCancel<br />Object #<Object> has no method 'attachEvent'<br /></td></tr>
<tr><td>actioneventwrapper_test.html</td><td>Fail</td><td> 0 passed, 4 failed.</td><td title="

  goog.require('goog.events');
  goog.require('goog.events.EventHandler');
  goog.require('goog.events.actionEventWrapper');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');



  var a = document.getElementById('a');
  var eh, events;

  function setUp() {
    events = [];
    eh = new goog.events.EventHandler();
  }


  function tearDown() {
    eh.dispose();
  }

  var Foo = function() {};
  Foo.prototype.test = function(e) {
    events.push(e);
  };

  function testAddActionListener() {
    assertEquals('No listeners registered yet', 0,
        goog.object.getCount(goog.events.listeners_));

    var listener = function(e) { events.push(e); }
    goog.events.listenWithWrapper(a, goog.events.actionEventWrapper, listener);

    assertEquals('2 listeners should be registered', 2,
        goog.object.getCount(goog.events.listeners_));

    goog.testing.events.fireClickSequence(a);
    assertEquals('1 event should have been dispatched', 1, events.length);
    assertEquals('Should be an click event', 'click', events[0].type)

    goog.testing.events.fireKeySequence(a, goog.events.KeyCodes.ENTER);
    assertEquals('2 events should have been dispatched', 2, events.length);
    assertEquals('Should be an keypress event', 'keypress', events[1].type)

    goog.testing.events.fireKeySequence(a, goog.events.KeyCodes.SPACE);
    assertEquals('2 events should have been dispatched', 2, events.length);

    goog.testing.events.fireKeySequence(a, goog.events.KeyCodes.ESC);
    assertEquals('2 events should have been dispatched', 2, events.length);

    goog.events.unlistenWithWrapper(a, goog.events.actionEventWrapper,
        listener);
    assertEquals('no listeners should be registered', 0,
        goog.object.getCount(goog.events.listeners_));
  }


  function testRemoveActionListener() {
    assertEquals('No listeners registered yet', 0,
        goog.object.getCount(goog.events.listeners_));

    var listener1 = function(e) { events.push(e); };
    var listener2 = function(e) { events.push({type: 'err'}); }

    goog.events.listenWithWrapper(a, goog.events.actionEventWrapper, listener1);
    assertEquals('2 listeners should be registered', 2,
        goog.object.getCount(goog.events.listeners_));

    goog.events.listenWithWrapper(a, goog.events.actionEventWrapper, listener2);
    assertEquals('4 listeners should be registered', 4,
        goog.object.getCount(goog.events.listeners_));

    goog.testing.events.fireKeySequence(a, goog.events.KeyCodes.ENTER);
    assertEquals('2 events should have been dispatched', 2, events.length);
    assertEquals('Should be an keypress event', 'keypress', events[0].type);
    assertEquals('Should be an err event', 'err', events[1].type);

    goog.events.unlistenWithWrapper(a, goog.events.actionEventWrapper,
        listener2);
    assertEquals('2 listeners should be registered', 2,
        goog.object.getCount(goog.events.listeners_));

    events = [];
    goog.testing.events.fireKeySequence(a, goog.events.KeyCodes.ENTER);
    assertEquals('1 event should have been dispatched', 1, events.length);
    assertEquals('Should be an keypress event', 'keypress', events[0].type);

    goog.events.unlistenWithWrapper(a, goog.events.actionEventWrapper,
        listener1);
    assertEquals('0 listeners should be registered', 0,
        goog.object.getCount(goog.events.listeners_));
  }


  function testEventHandlerActionListener() {
    assertEquals('No listeners registered yet', 0,
        goog.object.getCount(goog.events.listeners_));

    var listener = function(e) { events.push(e); }
    eh.listenWithWrapper(a, goog.events.actionEventWrapper, listener);

    assertEquals('2 listeners should be registered', 2,
        goog.object.getCount(goog.events.listeners_));

    goog.testing.events.fireClickSequence(a);
    assertEquals('1 event should have been dispatched', 1, events.length);
    assertEquals('Should be an click event', 'click', events[0].type)

    goog.testing.events.fireKeySequence(a, goog.events.KeyCodes.ENTER);
    assertEquals('2 events should have been dispatched', 2, events.length);
    assertEquals('Should be an keypress event', 'keypress', events[1].type)

    goog.testing.events.fireKeySequence(a, goog.events.KeyCodes.SPACE);
    assertEquals('2 events should have been dispatched', 2, events.length);

    goog.testing.events.fireKeySequence(a, goog.events.KeyCodes.ESC);
    assertEquals('2 events should have been dispatched', 2, events.length);

    eh.unlistenWithWrapper(a, goog.events.actionEventWrapper,
        listener);
    assertEquals('no listeners should be registered', 0,
        goog.object.getCount(goog.events.listeners_));
  }


  function testEventHandlerActionListenerWithScope() {
    assertEquals('No listeners registered yet', 0,
        goog.object.getCount(goog.events.listeners_));

    var foo = new Foo();
    var eh2 = new goog.events.EventHandler(foo);

    eh2.listenWithWrapper(a, goog.events.actionEventWrapper, foo.test);

    assertEquals('2 listeners should be registered', 2,
        goog.object.getCount(goog.events.listeners_));

    goog.testing.events.fireClickSequence(a);
    assertEquals('1 event should have been dispatched', 1, events.length);
    assertEquals('Should be an click event', 'click', events[0].type)

    goog.testing.events.fireKeySequence(a, goog.events.KeyCodes.ENTER);
    assertEquals('2 events should have been dispatched', 2, events.length);
    assertEquals('Should be an keypress event', 'keypress', events[1].type)

    goog.testing.events.fireKeySequence(a, goog.events.KeyCodes.SPACE);
    assertEquals('2 events should have been dispatched', 2, events.length);

    goog.testing.events.fireKeySequence(a, goog.events.KeyCodes.ESC);
    assertEquals('2 events should have been dispatched', 2, events.length);

    eh2.dispose();
    assertEquals('no listeners should be registered', 0,
        goog.object.getCount(goog.events.listeners_));
    delete foo;
  }

">4 of 4 tests run in 7ms.<br />0 passed, 4 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testAddActionListener<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testEventHandlerActionListener<br />No listeners registered yet<br />Expected <0> (Number) but was <1> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testEventHandlerActionListener at _tmpclosuretest.js:98:5<br />ERROR in testEventHandlerActionListenerWithScope<br />No listeners registered yet<br />Expected <0> (Number) but was <1> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testEventHandlerActionListenerWithScope at _tmpclosuretest.js:129:5<br />ERROR in testRemoveActionListener<br />No listeners registered yet<br />Expected <0> (Number) but was <1> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testRemoveActionListener at _tmpclosuretest.js:61:5<br /></td></tr>
<tr><td>events_test.html</td><td>Fail</td><td> undefined</td><td title="

    goog.require('goog.array');
    goog.require('goog.dom');
    goog.require('goog.math.Coordinate');
    goog.require('goog.string');
    goog.require('goog.testing.PropertyReplacer');
    goog.require('goog.testing.events');
    goog.require('goog.testing.jsunit');
    goog.require('goog.userAgent');


  

  var firedEventTypes;
  var firedEventCoordinates;
  var firedScreenCoordinates;
  var firedShiftKeys;
  var firedKeyCodes;
  var root = goog.dom.getElement('root');
  var log = goog.dom.getElement('log');
  var input = goog.dom.getElement('input');
  var testButton = goog.dom.getElement('testButton');
  var coordinate = new goog.math.Coordinate(123, 456);
  var stubs = new goog.testing.PropertyReplacer();

  function setUp() {
    stubs.reset();
    goog.events.removeAll();
    root.innerHTML = '';
    firedEventTypes = [];
    firedEventCoordinates = [];
    firedScreenCoordinates = [];
    firedShiftKeys = [];
    firedKeyCodes = [];

    for (var key in goog.events.EventType) {
      goog.events.listen(root, goog.events.EventType[key], function(e) {
        firedEventTypes.push(e.type);
        var coord = new goog.math.Coordinate(e.clientX, e.clientY);
        firedEventCoordinates.push(coord);

        firedScreenCoordinates.push(
            new goog.math.Coordinate(e.screenX, e.screenY));

        firedShiftKeys.push(!!e.shiftKey);
        firedKeyCodes.push(e.keyCode);
      });
    }
  }

  function tearDownPage() {
    for (var key in goog.events.EventType) {
      var type = goog.events.EventType[key];
      if (type == 'mousemove' || type == 'mouseout' || type == 'mouseover') {
        continue;
      }
      goog.dom.appendChild(input,
          goog.dom.createDom('label', null,
              goog.dom.createDom('input',
                  {'id': type, 'type': 'checkbox'}),
              type,
              goog.dom.createDom('br')));
      goog.events.listen(testButton, type, function(e) {
        if (goog.dom.getElement(e.type).checked) {
          e.preventDefault();
        }

        log.innerHTML += goog.string.subs('<br/>%s (%s, %s)',
            e.type, e.clientX, e.clientY);
      });
    }
  }

  function testMouseOver() {
    goog.testing.events.fireMouseOverEvent(root, null);
    goog.testing.events.fireMouseOverEvent(root, null, coordinate);
    assertEventTypes(['mouseover', 'mouseover']);
    assertCoordinates([goog.style.getClientPosition(root), coordinate]);
  }

  function testMouseOut() {
    goog.testing.events.fireMouseOutEvent(root, null);
    goog.testing.events.fireMouseOutEvent(root, null, coordinate);
    assertEventTypes(['mouseout', 'mouseout']);
    assertCoordinates([goog.style.getClientPosition(root), coordinate]);
  }

  function testClickSequence() {
    assertTrue(goog.testing.events.fireClickSequence(root));
    assertEventTypes(['mousedown', 'mouseup', 'click']);
    var rootPosition = goog.style.getClientPosition(root);
    assertCoordinates([rootPosition, rootPosition, rootPosition]);
  }

  function testClickSequenceWithCoordinate() {
    assertTrue(goog.testing.events.fireClickSequence(root, null, coordinate));
    assertCoordinates([coordinate, coordinate, coordinate]);
    assertArrayEquals([false, false, false], firedShiftKeys);
  }

  function testClickSequenceWithEventProperty() {
    assertTrue(goog.testing.events.fireClickSequence(
          root, null, undefined, { shiftKey: true }));
    assertArrayEquals([true, true, true], firedShiftKeys);
  }

  function testClickSequenceCancellingMousedown() {
    preventDefaultEventType('mousedown');
    assertFalse(goog.testing.events.fireClickSequence(root));
    assertEventTypes(['mousedown', 'mouseup', 'click']);
  }

  function testClickSequenceCancellingMousedownWithCoordinate() {
    preventDefaultEventType('mousedown');
    assertFalse(goog.testing.events.fireClickSequence(root, null, coordinate));
    assertCoordinates([coordinate, coordinate, coordinate]);
  }

  function testClickSequenceCancellingMouseup() {
    preventDefaultEventType('mouseup');
    assertFalse(goog.testing.events.fireClickSequence(root));
    assertEventTypes(['mousedown', 'mouseup', 'click']);
  }

  function testClickSequenceCancellingMouseupWithCoordinate() {
    preventDefaultEventType('mouseup');
    assertFalse(goog.testing.events.fireClickSequence(root, null, coordinate));
    assertCoordinates([coordinate, coordinate, coordinate]);
  }

  function testClickSequenceCancellingClick() {
    preventDefaultEventType('click');
    assertFalse(goog.testing.events.fireClickSequence(root));
    assertEventTypes(['mousedown', 'mouseup', 'click']);
  }

  function testClickSequenceCancellingClickWithCoordinate() {
    preventDefaultEventType('click');
    assertFalse(goog.testing.events.fireClickSequence(root, null, coordinate));
    assertCoordinates([coordinate, coordinate, coordinate]);
  }

  // For a double click, IE fires selectstart instead of the second mousedown,
  // but we don't simulate selectstart. Also, IE doesn't fire the second click.
  var DBLCLICK_SEQ = (goog.userAgent.IE ?
                      ['mousedown',
                       'mouseup',
                       'click',
                       'mouseup',
                       'dblclick'] :
                      ['mousedown',
                       'mouseup',
                       'click',
                       'mousedown',
                       'mouseup',
                       'click',
                       'dblclick']);


  var DBLCLICK_SEQ_COORDS = goog.array.repeat(coordinate, DBLCLICK_SEQ.length);

  function testDoubleClickSequence() {
    assertTrue(goog.testing.events.fireDoubleClickSequence(root));
    assertEventTypes(DBLCLICK_SEQ);
  }

  function testDoubleClickSequenceWithCoordinate() {
    assertTrue(goog.testing.events.fireDoubleClickSequence(root, coordinate));
    assertCoordinates(DBLCLICK_SEQ_COORDS);
  }

  function testDoubleClickSequenceCancellingMousedown() {
    preventDefaultEventType('mousedown');
    assertFalse(goog.testing.events.fireDoubleClickSequence(root));
    assertEventTypes(DBLCLICK_SEQ);
  }

  function testDoubleClickSequenceCancellingMousedownWithCoordinate() {
    preventDefaultEventType('mousedown');
    assertFalse(goog.testing.events.fireDoubleClickSequence(root, coordinate));
    assertCoordinates(DBLCLICK_SEQ_COORDS);
  }

  function testDoubleClickSequenceCancellingMouseup() {
    preventDefaultEventType('mouseup');
    assertFalse(goog.testing.events.fireDoubleClickSequence(root));
    assertEventTypes(DBLCLICK_SEQ);
  }

  function testDoubleClickSequenceCancellingMouseupWithCoordinate() {
    preventDefaultEventType('mouseup');
    assertFalse(goog.testing.events.fireDoubleClickSequence(root, coordinate));
    assertCoordinates(DBLCLICK_SEQ_COORDS);
  }

  function testDoubleClickSequenceCancellingClick() {
    preventDefaultEventType('click');
    assertFalse(goog.testing.events.fireDoubleClickSequence(root));
    assertEventTypes(DBLCLICK_SEQ);
  }

  function testDoubleClickSequenceCancellingClickWithCoordinate() {
    preventDefaultEventType('click');
    assertFalse(goog.testing.events.fireDoubleClickSequence(root, coordinate));
    assertCoordinates(DBLCLICK_SEQ_COORDS);
  }

  function testDoubleClickSequenceCancellingDoubleClick() {
    preventDefaultEventType('dblclick');
    assertFalse(goog.testing.events.fireDoubleClickSequence(root));
    assertEventTypes(DBLCLICK_SEQ);
  }

  function testDoubleClickSequenceCancellingDoubleClickWithCoordinate() {
    preventDefaultEventType('dblclick');
    assertFalse(goog.testing.events.fireDoubleClickSequence(root, coordinate));
    assertCoordinates(DBLCLICK_SEQ_COORDS);
  }

  function testKeySequence() {
    assertTrue(goog.testing.events.fireKeySequence(
        root, goog.events.KeyCodes.ZERO));
    assertEventTypes(['keydown', 'keypress', 'keyup']);
  }

  function testKeySequenceCancellingKeydown() {
    preventDefaultEventType('keydown');
    assertFalse(goog.testing.events.fireKeySequence(
        root, goog.events.KeyCodes.ZERO));
    if (goog.userAgent.IE) {
      assertEventTypes(['keydown', 'keyup']);
    } else {
      assertEventTypes(['keydown', 'keypress', 'keyup']);
    }
  }

  function testKeySequenceCancellingKeypress() {
    preventDefaultEventType('keypress');
    assertFalse(goog.testing.events.fireKeySequence(
        root, goog.events.KeyCodes.ZERO));
    assertEventTypes(['keydown', 'keypress', 'keyup']);
  }

  function testKeySequenceCancellingKeyup() {
    preventDefaultEventType('keyup');
    assertFalse(goog.testing.events.fireKeySequence(
        root, goog.events.KeyCodes.ZERO));
    assertEventTypes(['keydown', 'keypress', 'keyup']);
  }

  function testKeySequenceWithEscapeKey() {
    assertTrue(goog.testing.events.fireKeySequence(
        root, goog.events.KeyCodes.ESC));
    if (goog.userAgent.WEBKIT && goog.userAgent.isVersion('525')) {
      assertEventTypes(['keydown', 'keyup']);
    } else {
      assertEventTypes(['keydown', 'keypress', 'keyup']);
    }
  }

  function testKeySequenceForMacActionKeysNegative() {
    stubs.set(goog.userAgent, 'GECKO', false);
    goog.testing.events.fireKeySequence(
        root, goog.events.KeyCodes.C, {'metaKey': true});
    assertEventTypes(['keydown', 'keypress', 'keyup']);
  }

  function testKeySequenceForMacActionKeysPositive() {
    stubs.set(goog.userAgent, 'GECKO', true);
    stubs.set(goog.userAgent, 'MAC', true);
    goog.testing.events.fireKeySequence(
        root, goog.events.KeyCodes.C, {'metaKey': true});
    assertEventTypes(['keypress', 'keyup']);
  }

  function testKeySequenceForOptionKeysOnMac() {
    // Mac uses an option (or alt) key to type non-ASCII characters. This test
    // verifies we can emulate key events sent when typing such non-ASCII
    // characters.
    stubs.set(goog.userAgent, 'WEBKIT', true);
    stubs.set(goog.userAgent, 'MAC', true);

    var optionKeyCodes = [
      [0xc0, 0x00e6],  // option+'
      [0xbc, 0x2264],  // option+,
      [0xbd, 0x2013],  // option+-
      [0xbe, 0x2265],  // option+.
      [0xbf, 0x00f7],  // option+/
      [0x30, 0x00ba],  // option+0
      [0x31, 0x00a1],  // option+1
      [0x32, 0x2122],  // option+2
      [0x33, 0x00a3],  // option+3
      [0x34, 0x00a2],  // option+4
      [0x35, 0x221e],  // option+5
      [0x36, 0x00a7],  // option+6
      [0x37, 0x00b6],  // option+7
      [0x38, 0x2022],  // option+8
      [0x39, 0x00aa],  // option+9
      [0xba, 0x2026],  // option+;
      [0xbb, 0x2260],  // option+=
      [0xdb, 0x201c],  // option+[
      [0xdc, 0x00ab],  // option+\
      [0xdd, 0x2018],  // option+]
      [0x41, 0x00e5],  // option+a
      [0x42, 0x222b],  // option+b
      [0x43, 0x00e7],  // option+c
      [0x44, 0x2202],  // option+d
      [0x45, 0x00b4],  // option+e
      [0x46, 0x0192],  // option+f
      [0x47, 0x00a9],  // option+g
      [0x48, 0x02d9],  // option+h
      [0x49, 0x02c6],  // option+i
      [0x4a, 0x2206],  // option+j
      [0x4b, 0x02da],  // option+k
      [0x4c, 0x00ac],  // option+l
      [0x4d, 0x00b5],  // option+m
      [0x4e, 0x02dc],  // option+n
      [0x4f, 0x00f8],  // option+o
      [0x50, 0x03c0],  // option+p
      [0x51, 0x0153],  // option+q
      [0x52, 0x00ae],  // option+r
      [0x53, 0x00df],  // option+s
      [0x54, 0x2020],  // option+t
      [0x56, 0x221a],  // option+v
      [0x57, 0x2211],  // option+w
      [0x58, 0x2248],  // option+x
      [0x59, 0x00a5],  // option+y
      [0x5a, 0x03a9]   // option+z
    ];

    for (var i = 0; i < optionKeyCodes.length; ++i) {
      firedEventTypes = [];
      firedKeyCodes = [];
      var keyCode = optionKeyCodes[i][0];
      var keyPressKeyCode = optionKeyCodes[i][1];
      goog.testing.events.fireNonAsciiKeySequence(
          root, keyCode, keyPressKeyCode, {'altKey': true});
      assertEventTypes(['keydown', 'keypress', 'keyup']);
      assertArrayEquals([keyCode, keyPressKeyCode, keyCode], firedKeyCodes);
    }
  }

  var CONTEXTMENU_SEQ =
      goog.userAgent.WINDOWS ? ['mousedown', 'mouseup', 'contextmenu'] :
      goog.userAgent.GECKO ? ['mousedown', 'contextmenu', 'mouseup'] :
      goog.userAgent.WEBKIT && goog.userAgent.MAC ?
          ['mousedown', 'contextmenu', 'mouseup', 'click'] :
      ['mousedown', 'contextmenu', 'mouseup'];

  function testContextMenuSequence() {
    assertTrue(goog.testing.events.fireContextMenuSequence(root));
    assertEventTypes(CONTEXTMENU_SEQ);
  }

  function testContextMenuSequenceWithCoordinate() {
    assertTrue(goog.testing.events.fireContextMenuSequence(root, coordinate));
    assertEventTypes(CONTEXTMENU_SEQ);
    assertCoordinates(goog.array.repeat(coordinate, CONTEXTMENU_SEQ.length));
  }

  function testContextMenuSequenceCancellingMousedown() {
    preventDefaultEventType('mousedown');
    assertFalse(goog.testing.events.fireContextMenuSequence(root));
    assertEventTypes(CONTEXTMENU_SEQ);
  }

  function testContextMenuSequenceCancellingMouseup() {
    preventDefaultEventType('mouseup');
    assertFalse(goog.testing.events.fireContextMenuSequence(root));
    assertEventTypes(CONTEXTMENU_SEQ);
  }

  function testContextMenuSequenceCancellingContextMenu() {
    preventDefaultEventType('contextmenu');
    assertFalse(goog.testing.events.fireContextMenuSequence(root));
    assertEventTypes(CONTEXTMENU_SEQ);
  }

  function testContextMenuSequenceFakeMacWebkit() {
    stubs.set(goog.userAgent, 'WINDOWS', false);
    stubs.set(goog.userAgent, 'MAC', true);
    stubs.set(goog.userAgent, 'WEBKIT', true);
    assertTrue(goog.testing.events.fireContextMenuSequence(root));
    assertEventTypes(['mousedown', 'contextmenu', 'mouseup', 'click']);
  }

  /**
   * Assert that the list of events given was fired, in that order.
   */
  function assertEventTypes(list) {
    assertArrayEquals(list, firedEventTypes);
  }

  /**
   * Assert that the list of event coordinates given was caught, in that order.
   */
  function assertCoordinates(list) {
    assertArrayEquals(list, firedEventCoordinates);
    assertArrayEquals(list, firedScreenCoordinates);
  }

  /** Prevent default the event of the given type on the root element. */
  function preventDefaultEventType(type) {
    goog.events.listen(root, type, preventDefault);
  }

  function preventDefault(e) {
    e.preventDefault();
  }
">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at [object Object].tearDownPage (_tmpclosuretest.js:60:24)
    at [object Object].finalize (testing/testcase.js:356:8)
    at [object Object].cycleTests (testing/testcase.js:718:8)
    at [object Object].execute (testing/testcase.js:346:8)
    at [object Object].runTests (testing/testcase.js:488:8)
    at [object Object].execute (testing/testrunner.js:266:17)
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:429:6)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
</td></tr>
<tr><td>mousewheelhandler_test.html</td><td>Fail</td><td> 0 passed, 7 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.events.MouseWheelHandler');
  goog.require('goog.functions');
  goog.require('goog.object');
  goog.require('goog.testing.jsunit');



  var DEFAULT_TYPE = 'mousewheel';
  var GECKO_TYPE = 'DOMMouseScroll';

  var HORIZONTAL = 'h';
  var VERTICAL = 'v';

  var mouseWheelEvent;
  var mouseWheelHandler;

  function tearDown() {
    goog.userAgent = null;
    mouseWheelHandler.dispose();
    mouseWheelHandler = null;
    mouseWheelEvent = null;
  }

  function testIeStyleMouseWheel() {
    goog.userAgent = {
        OPERA: false,
        IE: true,
        GECKO: false,
        CAMINO: false,
        WEBKIT: false
    };

    createHandlerAndListen();

    // Non-gecko, non-webkit events get wheelDelta divided by -40 to get detail.
    mouseWheelHandler.handleEvent(
        createFakeMouseWheelEvent(DEFAULT_TYPE, 120));
    assertMouseWheelEvent(-3, 0, -3);

    mouseWheelHandler.handleEvent(
        createFakeMouseWheelEvent(DEFAULT_TYPE, -120));
    assertMouseWheelEvent(3, 0, 3);

    mouseWheelHandler.handleEvent(
        createFakeMouseWheelEvent(DEFAULT_TYPE, 1200));
    assertMouseWheelEvent(-30, 0, -30);
  }

  function testGeckoStyleMouseWheel() {
    goog.userAgent = {
        OPERA: false,
        IE: false,
        GECKO: true,
        CAMINO: false,
        WEBKIT: false
    };

    createHandlerAndListen();

    mouseWheelHandler.handleEvent(
        createFakeMouseWheelEvent(GECKO_TYPE, null, 3));
    assertMouseWheelEvent(3, 0, 3);

    mouseWheelHandler.handleEvent(
        createFakeMouseWheelEvent(GECKO_TYPE, null, -12));
    assertMouseWheelEvent(-12, 0, -12);

    // Really big values should get truncated to +-3.
    mouseWheelHandler.handleEvent(
        createFakeMouseWheelEvent(GECKO_TYPE, null, 1200));
    assertMouseWheelEvent(3, 0, 3);

    mouseWheelHandler.handleEvent(
        createFakeMouseWheelEvent(GECKO_TYPE, null, -1200));
    assertMouseWheelEvent(-3, 0, -3);

    // Test scrolling with the additional axis property.
    mouseWheelHandler.handleEvent(
        createFakeMouseWheelEvent(GECKO_TYPE, null, 3, VERTICAL));
    assertMouseWheelEvent(3, 0, 3);

    mouseWheelHandler.handleEvent(
        createFakeMouseWheelEvent(GECKO_TYPE, null, 3, HORIZONTAL));
    assertMouseWheelEvent(3, 3, 0);

    mouseWheelHandler.handleEvent(
        createFakeMouseWheelEvent(GECKO_TYPE, null, -3, HORIZONTAL));
    assertMouseWheelEvent(-3, -3, 0);
  }

  function testWebkitStyleMouseWheel_ieStyle() {
    goog.userAgent = {
        OPERA: false,
        IE: false,
        GECKO: false,
        CAMINO: false,
        WEBKIT: true,
        WINDOWS: true
    };

    createHandlerAndListen();

    // IE-style Webkit events get wheelDelta divided by -40 to get detail.
    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(-40, 0));
    assertMouseWheelEvent(1, 1, 0);

    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(120, 0));
    assertMouseWheelEvent(-3, -3, 0);

    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(0, 120));
    assertMouseWheelEvent(-3, 0, -3);

    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(0, -40));
    assertMouseWheelEvent(1, 0, 1);

    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(80, -40));
    assertMouseWheelEvent(-2, -2, 1);
  }

  function testWebkitStyleMouseWheel_ieStyleOnMac() {
    goog.userAgent = {
        OPERA: false,
        IE: false,
        GECKO: false,
        CAMINO: false,
        WEBKIT: true,
        WINDOWS: false,
        MAC: true
    };

    goog.userAgent.isVersion = goog.functions.TRUE;

    createHandlerAndListen();

    // IE-style wheel events.
    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(0, -40));
    assertMouseWheelEvent(1, 0, 1);

    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(80, -40));
    assertMouseWheelEvent(-2, -2, 1);

    // Even in Webkit versions that usually behave in IE style, sometimes wheel
    // events don't behave; this has been observed for instance with Macbook
    // touchpads in Webkit 534.10+.
    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(-3, 5));
    assertMouseWheelEvent(-5, 3, -5);

    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(4, -7));
    assertMouseWheelEvent(7, -4, 7);
  }

  function testWebkitStyleMouseWheel_nonIeStyle() {
    goog.userAgent = {
        OPERA: false,
        IE: false,
        GECKO: false,
        CAMINO: false,
        WEBKIT: true,
        WINDOWS: false
    };

    goog.userAgent.isVersion = goog.functions.FALSE;

    createHandlerAndListen();

    // non-IE-style Webkit events do not get wheelDelta scaled
    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(-1, 0));
    assertMouseWheelEvent(1, 1, 0);

    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(3, 0));
    assertMouseWheelEvent(-3, -3, 0);

    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(0, 3));
    assertMouseWheelEvent(-3, 0, -3);

    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(0, -1));
    assertMouseWheelEvent(1, 0, 1);

    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(2, -1));
    assertMouseWheelEvent(-2, -2, 1);
  }

  function testMaxDeltaX() {
    goog.userAgent = {
        OPERA: false,
        IE: false,
        GECKO: false,
        CAMINO: false,
        WEBKIT: true,
        WINDOWS: true
    };

    createHandlerAndListen();

    // IE-style Webkit events get wheelDelta divided by -40 to get detail.
    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(-120, 0));
    assertMouseWheelEvent(3, 3, 0);

    mouseWheelHandler.setMaxDeltaX(3);
    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(-120, 0));
    assertMouseWheelEvent(3, 3, 0);

    mouseWheelHandler.setMaxDeltaX(2);
    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(-120, 0));
    assertMouseWheelEvent(3, 2, 0);

    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(0, -120));
    assertMouseWheelEvent(3, 0, 3);
  }

  function testMaxDeltaY() {
    goog.userAgent = {
        OPERA: false,
        IE: false,
        GECKO: false,
        CAMINO: false,
        WEBKIT: true,
        WINDOWS: true
    };

    createHandlerAndListen();

    // IE-style Webkit events get wheelDelta divided by -40 to get detail.
    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(0, -120));
    assertMouseWheelEvent(3, 0, 3);

    mouseWheelHandler.setMaxDeltaY(3);
    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(0, -120));
    assertMouseWheelEvent(3, 0, 3);

    mouseWheelHandler.setMaxDeltaY(2);
    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(0, -120));
    assertMouseWheelEvent(3, 0, 2);

    mouseWheelHandler.handleEvent(
        createFakeWebkitMouseWheelEvent(-120, 0));
    assertMouseWheelEvent(3, 3, 0);
  }

  // Be sure to call this after setting up goog.userAgent mock and not before.
  function createHandlerAndListen() {
    mouseWheelHandler = new goog.events.MouseWheelHandler(
        goog.dom.getElement('foo'));

    goog.events.listen(mouseWheelHandler,
        goog.events.MouseWheelHandler.EventType.MOUSEWHEEL,
        function(e) { mouseWheelEvent = e; });
  }

  function assertMouseWheelEvent(expectedDetail, expectedDeltaX,
      expectedDeltaY) {
    assertTrue("event should be non-null", !!mouseWheelEvent);
    assertTrue("event should have correct JS type",
        mouseWheelEvent instanceof goog.events.MouseWheelEvent);
    assertEquals("event should have correct detail property",
        expectedDetail, mouseWheelEvent.detail);
    assertEquals("event should have correct deltaX property",
        expectedDeltaX, mouseWheelEvent.deltaX);
    assertEquals("event should have correct deltaY property",
        expectedDeltaY, mouseWheelEvent.deltaY);
  }

  function createFakeMouseWheelEvent(type, opt_wheelDelta, opt_detail,
      opt_axis, opt_wheelDeltaX, opt_wheelDeltaY) {
    var event = {
      type: type,
      wheelDelta: goog.isDef(opt_wheelDelta) ? opt_wheelDelta : undefined,
      detail: goog.isDef(opt_detail) ? opt_detail : undefined,
      axis: opt_axis || undefined,
      wheelDeltaX: goog.isDef(opt_wheelDeltaX) ? opt_wheelDeltaX : undefined,
      wheelDeltaY: goog.isDef(opt_wheelDeltaY) ? opt_wheelDeltaY : undefined,

      // These two are constants defined on the event in FF3.1 and later.
      // It doesn't matter exactly what they are, and it doesn't affect
      // our simulations of other browsers.
      HORIZONTAL_AXIS: HORIZONTAL,
      VERTICAL_AXIS: VERTICAL
    };
    return new goog.events.BrowserEvent(event);
  }

  function createFakeWebkitMouseWheelEvent(wheelDeltaX, wheelDeltaY) {
    return createFakeMouseWheelEvent(DEFAULT_TYPE,
        Math.abs(wheelDeltaX) > Math.abs(wheelDeltaY) ?
            wheelDeltaX : wheelDeltaY,
        undefined, undefined, wheelDeltaX, wheelDeltaY);
  }

">7 of 7 tests run in 10ms.<br />0 passed, 7 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testGeckoStyleMouseWheel<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testIeStyleMouseWheel<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testMaxDeltaX<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testMaxDeltaY<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testWebkitStyleMouseWheel_ieStyle<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testWebkitStyleMouseWheel_ieStyleOnMac<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testWebkitStyleMouseWheel_nonIeStyle<br />Object #<Object> has no method 'attachEvent'<br /></td></tr>
<tr><td>eventhandler_test.html</td><td>Fail</td><td> 1 passed, 7 failed.</td><td title="

  goog.require('goog.events');
  goog.require('goog.events.EventHandler');
  goog.require('goog.events.EventTarget');
  goog.require('goog.testing.jsunit');



  var a = document.getElementById('a');
  var b = document.getElementById('b');
  var c = document.getElementById('c');
  var d = document.getElementById('d');


  function testEventHandlerClearsListeners() {
    assertEquals('No event listeners should be registered at the start', 0,
        goog.object.getCount(goog.events.listeners_));

    function tmp() {}

    goog.events.listen(a, 'click', tmp);

    assertEquals('1 listener should be registered now', 1,
        goog.object.getCount(goog.events.listeners_));

    var eh = new goog.events.EventHandler();
    eh.listen(a, 'click');
    eh.listen(a, 'keypress');
    eh.listen(b, 'mouseover');
    eh.listen(c, 'mousedown');
    eh.listen(d, 'click');
    eh.listen(d, 'mousedown');

    assertEquals('7 listeners should be registered now', 7,
        goog.object.getCount(goog.events.listeners_));

    eh.unlisten(d, 'mousedown');

    assertEquals('6 listeners should be registered now', 6,
        goog.object.getCount(goog.events.listeners_));

    eh.dispose();

    assertEquals('1 listener should be left', 1,
        goog.object.getCount(goog.events.listeners_));

    goog.events.unlisten(a, 'click', tmp);

    assertEquals('No event listeners should be registered at the end', 0,
        goog.object.getCount(goog.events.listeners_));
  }

  function testListenArray() {
    var eh = new goog.events.EventHandler();

    eh.listen(a, ['click', 'mousedown', 'mouseup']);

    assertEquals('3 listeners should be registered', 3,
        goog.object.getCount(goog.events.listeners_));

    eh.unlisten(a, ['click', 'mousedown', 'mouseup']);

    assertEquals('no listeners should be registered', 0,
        goog.object.getCount(goog.events.listeners_));

    eh.listen(a, ['click', 'mousedown', 'mouseup']);

    assertEquals('3 listeners should be registered', 3,
        goog.object.getCount(goog.events.listeners_));

    eh.removeAll();

    assertEquals('no listeners should be registered', 0,
        goog.object.getCount(goog.events.listeners_));
  }

  function testListenOnceRemovesListenerWhenFired() {
    var events = [];
    assertEquals('No listeners registered yet', 0,
        goog.object.getCount(goog.events.listeners_));
    var target = new goog.events.EventTarget();
    var eh = new goog.events.EventHandler();
    eh.listenOnce(target, 'click', function(e) { events.push(e); });
    assertEquals('1 listener should be registered', 1,
        goog.object.getCount(goog.events.listeners_));
    target.dispatchEvent('click');
    assertEquals('One event should have been dispatched', 1, events.length);
    assertEquals('no listeners should be registered', 0,
        goog.object.getCount(goog.events.listeners_));
    target.dispatchEvent('click');
    assertEquals('No event should have been dispatched', 1, events.length);

  }

  function testListenOnceListenerIsCleanedUp() {
    var events = [];
    assertEquals('No listeners registered yet', 0,
        goog.object.getCount(goog.events.listeners_));
    var target = new goog.events.EventTarget();
    var eh = new goog.events.EventHandler();
    eh.listenOnce(target, 'click', function(e) { events.push(e); });
    assertEquals('1 listener should be registered', 1,
        goog.object.getCount(goog.events.listeners_));
    eh.removeAll();
    assertEquals('no listeners should be registered', 0,
        goog.object.getCount(goog.events.listeners_));
    target.dispatchEvent('click');
    assertEquals('No event should have been dispatched', 0, events.length);
  }

  function testClearListenersWithListenOnceListenerRemoved() {
    var events = [];
    assertEquals('No listeners registered yet', 0,
        goog.object.getCount(goog.events.listeners_));
    var target = new goog.events.EventTarget();
    var eh = new goog.events.EventHandler();
    eh.listenOnce(target, 'click', function(e) { events.push(e); });
    assertEquals('1 listener should be registered', 1,
        goog.object.getCount(goog.events.listeners_));
    target.dispatchEvent('click');
    assertEquals('One event should have been dispatched', 1, events.length);
    assertEquals('no listeners should be registered', 0,
        goog.object.getCount(goog.events.listeners_));
    eh.removeAll();
    assertEquals('no listeners should be registered', 0,
        goog.object.getCount(goog.events.listeners_));
    target.dispatchEvent('click');
    assertEquals('No event should have been dispatched', 1, events.length);
  }

  function testListenOnceArray() {
    var events = [];
    assertEquals('No listeners registered yet', 0,
        goog.object.getCount(goog.events.listeners_));
    var target = new goog.events.EventTarget();
    var eh = new goog.events.EventHandler();
    eh.listenOnce(target, ['click', 'mousedown', 'mouseup'],
    function(e) { events.push(e); });
    assertEquals('3 listeners should be registered', 3,
        goog.object.getCount(goog.events.listeners_));
    target.dispatchEvent('click');
    assertEquals('1 event should have been dispatched', 1, events.length);
    assertEquals('Should be a click event', 'click', events[0].type)
    assertEquals('2 listeners should be registered', 2,
        goog.object.getCount(goog.events.listeners_));
    target.dispatchEvent('mouseup');
    assertEquals('1 event should have been dispatched', 2, events.length);
    assertEquals('Should be a click event', 'mouseup', events[1].type)
    assertEquals('1 listeners should be registered', 1,
        goog.object.getCount(goog.events.listeners_));
    target.dispatchEvent('mousedown');
    assertEquals('1 event should have been dispatched', 3, events.length);
    assertEquals('Should be a click event', 'mousedown', events[2].type)
    assertEquals('no listeners should be registered', 0,
        goog.object.getCount(goog.events.listeners_));
    target.dispatchEvent('click');
    assertEquals('No events should have been dispatched', 3, events.length);
  }

  function testListenUnlistenWithObjectHandler() {
    var events = [];
    assertEquals('No listeners registered yet', 0,
        goog.object.getCount(goog.events.listeners_));
    var target = new goog.events.EventTarget();
    var eh = new goog.events.EventHandler();
    var handlerObj = {
      handleEvent: function(e) {
        events.push(e);
      }
    };
    eh.listen(target, 'click', handlerObj);
    assertEquals('1 listener should be registered', 1,
        goog.object.getCount(goog.events.listeners_));
    target.dispatchEvent('click');
    assertEquals('1 listener should be registered', 1,
        goog.object.getCount(goog.events.listeners_));
    assertEquals('One event should have been dispatched', 1, events.length);
    eh.unlisten(target, 'click', handlerObj);
    assertEquals('no listeners should be registered', 0,
        goog.object.getCount(goog.events.listeners_));
    target.dispatchEvent('click');
    assertEquals('No event should have been dispatched', 1, events.length);
  }

  function testListenOnceWithObjectHandler() {
    var events = [];
    assertEquals('No listeners registered yet', 0,
        goog.object.getCount(goog.events.listeners_));
    var target = new goog.events.EventTarget();
    var eh = new goog.events.EventHandler();
    var handlerObj = {
      handleEvent: function(e) {
        events.push(e);
      }
    };
    eh.listenOnce(target, 'click', handlerObj);
    assertEquals('1 listener should be registered', 1,
        goog.object.getCount(goog.events.listeners_));
    target.dispatchEvent('click');
    assertEquals('One event should have been dispatched', 1, events.length);
    assertEquals('no listeners should be registered', 0,
        goog.object.getCount(goog.events.listeners_));
    target.dispatchEvent('click');
    assertEquals('No event should have been dispatched', 1, events.length);
  }


">8 of 8 tests run in 9ms.<br />1 passed, 7 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testEventHandlerClearsListeners<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testListenArray<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testListenOnceArray<br />No listeners registered yet<br />Expected <0> (Number) but was <2> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testListenOnceArray at _tmpclosuretest.js:134:5<br />ERROR in testListenOnceListenerIsCleanedUp<br />No listeners registered yet<br />Expected <0> (Number) but was <2> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testListenOnceListenerIsCleanedUp at _tmpclosuretest.js:98:5<br />ERROR in testListenOnceRemovesListenerWhenFired<br />No listeners registered yet<br />Expected <0> (Number) but was <2> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testListenOnceRemovesListenerWhenFired at _tmpclosuretest.js:80:5<br />ERROR in testListenOnceWithObjectHandler<br />No listeners registered yet<br />Expected <0> (Number) but was <2> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testListenOnceWithObjectHandler at _tmpclosuretest.js:188:5<br />ERROR in testListenUnlistenWithObjectHandler<br />No listeners registered yet<br />Expected <0> (Number) but was <2> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testListenUnlistenWithObjectHandler at _tmpclosuretest.js:163:5<br /></td></tr>
<tr><td>serializer_test.html</td><td>Success</td><td> 1 passed, 0 failed.</td><td title="

  goog.require('goog.proto');
  goog.require('goog.testing.jsunit');



var serialize = goog.proto.serialize;

function testArraySerialize() {

  assertEquals('Empty array', serialize([]), '[]');

  assertEquals('Normal array', serialize([0,1,2]), '[0,1,2]');
  assertEquals('Empty start', serialize([,1,2]), '[,1,2]');
  assertEquals('Empty start', serialize([,,,3,4]), '[,,,3,4]');
  assertEquals('Empty middle', serialize([0,,2]), '[0,,2]');
  assertEquals('Empty middle', serialize([0,,,3]), '[0,,,3]');
  assertEquals('Empty end', serialize([0,1,2,]), '[0,1,2]');
  assertEquals('Empty end', serialize([0,1,2,,,]), '[0,1,2]');
  assertEquals('Empty start and end', serialize([,,2,,4]), '[,,2,,4]');
  assertEquals('All elements empty', serialize([,,,,]), '[]');

  assertEquals('Nested', serialize([,1,[,1,[,1],],]), '[,1,[,1,[,1]]]');
}


">n/a</td></tr>
<tr><td>asserts_test.html</td><td>Fail</td><td> 47 passed, 1 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.iter.Iterator');
  goog.require('goog.iter.StopIteration');
  goog.require('goog.structs.Map');
  goog.require('goog.structs.Set');
  goog.require('goog.testing.asserts');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');



  function testAssertTrue() {
    assertTrue(true);
    assertTrue('Good assertion', true);
    assertThrowsJsUnitException(
        function() { assertTrue(false); },
        'Call to assertTrue(boolean) with false');
    assertThrowsJsUnitException(
        function() { assertTrue('Should be true', false); },
        'Should be true\nCall to assertTrue(boolean) with false');
    assertThrowsJsUnitException(
        function() { assertTrue(null); },
        'Bad argument to assertTrue(boolean)');
    assertThrowsJsUnitException(
        function() { assertTrue(undefined); },
        'Bad argument to assertTrue(boolean)');
  }

  function testAssertFalse() {
    assertFalse(false);
    assertFalse('Good assertion', false);
    assertThrowsJsUnitException(
        function() { assertFalse(true); },
        'Call to assertFalse(boolean) with true');
    assertThrowsJsUnitException(
        function() { assertFalse('Should be false', true); },
        'Should be false\nCall to assertFalse(boolean) with true');
    assertThrowsJsUnitException(
        function() { assertFalse(null); },
        'Bad argument to assertFalse(boolean)');
    assertThrowsJsUnitException(
        function() { assertFalse(undefined); },
        'Bad argument to assertFalse(boolean)');
  }

  function testAssertEqualsWithString() {
    assertEquals('a', 'a');
    assertEquals('Good assertion', 'a', 'a');
    assertThrowsJsUnitException(
        function() { assertEquals('a', 'b'); },
        'Expected <a> (String) but was <b> (String)');
    assertThrowsJsUnitException(
        function() { assertEquals('Bad assertion', 'a', 'b'); },
        'Bad assertion\nExpected <a> (String) but was <b> (String)');
  }

  function testAssertEqualsWithInteger() {
    assertEquals(1, 1);
    assertEquals('Good assertion', 1, 1);
    assertThrowsJsUnitException(
        function() { assertEquals(1, 2); },
        'Expected <1> (Number) but was <2> (Number)');
    assertThrowsJsUnitException(
        function() { assertEquals('Bad assertion', 1, 2); },
        'Bad assertion\nExpected <1> (Number) but was <2> (Number)');
  }

  function testAssertNotEquals() {
    assertNotEquals('a', 'b');
    assertNotEquals('a', 'a', 'b');
    assertThrowsJsUnitException(
        function() { assertNotEquals('a', 'a'); },
        'Expected not to be <a> (String)');
    assertThrowsJsUnitException(
        function() { assertNotEquals('a', 'a', 'a'); },
        'a\nExpected not to be <a> (String)');
  }

  function testAssertNull() {
    assertNull(null);
    assertNull('Good assertion', null);
    assertThrowsJsUnitException(
        function() { assertNull(true); },
        'Expected <null> but was <true> (Boolean)');
    assertThrowsJsUnitException(
        function() { assertNull('Should be null', false); },
        'Should be null\nExpected <null> but was <false> (Boolean)');
    assertThrowsJsUnitException(
        function() { assertNull(undefined); },
        'Expected <null> but was <undefined>');
    assertThrowsJsUnitException(
        function() { assertNull(1); },
        'Expected <null> but was <1> (Number)');
  }

  function testAssertNotNull() {
    assertNotNull(true);
    assertNotNull('Good assertion', true);
    assertNotNull(false);
    assertNotNull(undefined);
    assertNotNull(1);
    assertNotNull('a');
    assertThrowsJsUnitException(
        function() { assertNotNull(null); },
        'Expected not to be <null>');
    assertThrowsJsUnitException(
        function() { assertNotNull('Should not be null', null); },
        'Should not be null\nExpected not to be <null>');
  }

  function testAssertUndefined() {
    assertUndefined(undefined);
    assertUndefined('Good assertion', undefined);
    assertThrowsJsUnitException(
        function() { assertUndefined(true); },
        'Expected <undefined> but was <true> (Boolean)');
    assertThrowsJsUnitException(
        function() { assertUndefined('Should be undefined', false); },
        'Should be undefined\nExpected <undefined> but was <false> (Boolean)');
    assertThrowsJsUnitException(
        function() { assertUndefined(null); },
        'Expected <undefined> but was <null>');
    assertThrowsJsUnitException(
        function() { assertUndefined(1); },
        'Expected <undefined> but was <1> (Number)');
  }

  function testAssertNotUndefined() {
    assertNotUndefined(true);
    assertNotUndefined('Good assertion', true);
    assertNotUndefined(false);
    assertNotUndefined(null);
    assertNotUndefined(1);
    assertNotUndefined('a');
    assertThrowsJsUnitException(
        function() { assertNotUndefined(undefined); },
                  'Expected not to be <undefined>');
    assertThrowsJsUnitException(
        function() { assertNotUndefined('Should not be undefined', undefined); },
        'Should not be undefined\nExpected not to be <undefined>');
  }

  function testAssertNotNullNorUndefined() {
    assertNotNullNorUndefined(true);
    assertNotNullNorUndefined('Good assertion', true);
    assertNotNullNorUndefined(false);
    assertNotNullNorUndefined(1);
    assertNotNullNorUndefined(0);
    assertNotNullNorUndefined('a');
    assertThrowsJsUnitException(function() {
      assertNotNullNorUndefined(undefined);
    }, 'Expected not to be <undefined>');
    assertThrowsJsUnitException(function() {
      assertNotNullNorUndefined('Should not be undefined', undefined);
    }, 'Should not be undefined\nExpected not to be <undefined>');
    assertThrowsJsUnitException(function() {
      assertNotNullNorUndefined(null);
    }, 'Expected not to be <null>');
    assertThrowsJsUnitException(function() {
      assertNotNullNorUndefined('Should not be null', null);
    }, 'Should not be null\nExpected not to be <null>');
  }

  function testAssertNonEmptyString() {
    assertNonEmptyString('hello');
    assertNonEmptyString('Good assertion', 'hello');
    assertNonEmptyString('true');
    assertNonEmptyString('false');
    assertNonEmptyString('1');
    assertNonEmptyString('null');
    assertNonEmptyString('undefined');
    assertNonEmptyString('\n');
    assertNonEmptyString(' ');
    assertThrowsJsUnitException(
        function() { assertNonEmptyString(''); },
        'Expected non-empty string but was <> (String)');
    assertThrowsJsUnitException(
        function() { assertNonEmptyString('Should be non-empty string', ''); },
        'Should be non-empty string\n' +
          'Expected non-empty string but was <> (String)');
    assertThrowsJsUnitException(
        function() { assertNonEmptyString(true); },
        'Expected non-empty string but was <true> (Boolean)');
    assertThrowsJsUnitException(
        function() { assertNonEmptyString(false); },
        'Expected non-empty string but was <false> (Boolean)');
    assertThrowsJsUnitException(
        function() { assertNonEmptyString(1); },
        'Expected non-empty string but was <1> (Number)');
    assertThrowsJsUnitException(
        function() { assertNonEmptyString(null); },
        'Expected non-empty string but was <null>');
    assertThrowsJsUnitException(
        function() { assertNonEmptyString(undefined); },
        'Expected non-empty string but was <undefined>');
    assertThrowsJsUnitException(
        function() { assertNonEmptyString(['hello']); },
        'Expected non-empty string but was <hello> (Array)');
    // Different browsers return different values/types in the failure message
    // so don't bother checking if the message is exactly as expected.
    assertThrowsJsUnitException(
        function() { assertNonEmptyString(goog.dom.createTextNode('hello')); });
  }

  function testAssertNaN() {
    assertNaN(NaN);
    assertNaN('Good assertion', NaN);
    assertThrowsJsUnitException(
        function() { assertNaN(1); }, 'Expected NaN');
    assertThrowsJsUnitException(
        function() { assertNaN('Should be NaN', 1); },
        'Should be NaN\nExpected NaN');
    assertThrowsJsUnitException(
        function() { assertNaN(true); }, 'Expected NaN');
    assertThrowsJsUnitException(
        function() { assertNaN(false); }, 'Expected NaN');
    assertThrowsJsUnitException(
        function() { assertNaN(null); }, 'Expected NaN');
    assertThrowsJsUnitException(
        function() { assertNaN(''); }, 'Expected NaN');

    // TODO(user): These assertions fail. We should decide on the
    // semantics of assertNaN
    //assertThrowsJsUnitException(function() { assertNaN(undefined); },
    //    'Expected NaN');
    //assertThrowsJsUnitException(function() { assertNaN('a'); },
    //    'Expected NaN');
  }

  function testAssertNotNaN() {
    assertNotNaN(1);
    assertNotNaN('Good assertion', 1);
    assertNotNaN(true);
    assertNotNaN(false);
    assertNotNaN('');
    assertNotNaN(null);

    // TODO(user): These assertions fail. We should decide on the
    // semantics of assertNotNaN
    //assertNotNaN(undefined);
    //assertNotNaN('a');

    assertThrowsJsUnitException(
        function() { assertNotNaN(Number.NaN); },
        'Expected not NaN');
    assertThrowsJsUnitException(
        function() { assertNotNaN('Should not be NaN', Number.NaN); },
        'Should not be NaN\nExpected not NaN');
  }

  function testAssertObjectEquals() {
    var obj1 = [{'a': 'hello', 'b': 'world'}];
    var obj2 = [{'a': 'hello', 'c': 'dear', 'b' : 'world'}];

    // Check with obj1 and obj2 as first and second arguments respectively.
    assertThrows('Objects should not be equal', function() {
      assertObjectEquals(obj1, obj2);
    });

    // Check with obj1 and obj2 as second and first arguments respectively.
    assertThrows('Objects should not be equal', function() {
      assertObjectEquals(obj2, obj1);
    });

    // Test if equal objects are considered equal.
    var obj3 = [{'b': 'world', 'a': 'hello'}];
    assertObjectEquals(obj1, obj3);
    assertObjectEquals(obj3, obj1);

    // Test with a case where one of the members has an undefined value.
    var obj4 = [{'a': 'hello', 'b': undefined}];
    var obj5 = [{'a': 'hello'}];

    // Check with obj4 and obj5 as first and second arguments respectively.
    assertThrows('Objects should not be equal', function() {
      assertObjectEquals(obj4, obj5);
    });

    // Check with obj5 and obj4 as first and second arguments respectively.
    assertThrows('Objects should not be equal', function() {
      assertObjectEquals(obj5, obj4);
    });

  }

  function testAssertObjectEquals2() {
    // NOTE: (0 in [undefined]) is true on FF but false on IE.
    // (0 in {'0': undefined}) is true on both.
    // grrr.
    assertObjectEquals('arrays should be equal', [undefined], [undefined]);
    assertThrows('arrays should not be equal', function() {
      assertObjectEquals([undefined, undefined], [undefined]);
    });
    assertThrows('arrays should not be equal', function() {
      assertObjectEquals([undefined], [undefined, undefined]);
    });
  }

  function testAssertObjectEquals3() {
    // Check that objects that contain identical Map objects compare
    // as equals. We can't do a negative test because on browsers that
    // implement __iterator__ we can't check the values of the iterated
    // properties.
    var obj1 = [{'a': 'hi',
                 'b': new goog.structs.Map('hola', 'amigo',
                                           'como', 'estas?')},
                14,
                'yes',
                true];
    var obj2 = [{'a': 'hi',
                 'b': new goog.structs.Map('hola', 'amigo',
                                           'como', 'estas?')},
                14,
                'yes',
                true];
    assertObjectEquals('Objects should be equal', obj1, obj2);

    var obj3 = {'a': [1, 2]};
    var obj4 = {'a': [1, 2, 3]};
    assertThrows('inner arrays should not be equal', function() {
      assertObjectEquals(obj3, obj4);
    });
    assertThrows('inner arrays should not be equal', function() {
      assertObjectEquals(obj4, obj3);
    });
  }

  function testAssertObjectEqualsSet() {
    // verify that Sets compare equal, when run in an environment that
    // supports iterators
    var set1 = new goog.structs.Set();
    var set2 = new goog.structs.Set();

    set1.add('a');
    set1.add('b');
    set1.add(13);

    set2.add('a');
    set2.add('b');
    set2.add(13);

    assertObjectEquals('sets should be equal', set1, set2);

    set2.add('hey');
    assertThrows('sets should not be equal', function() {
      assertObjectEquals(set1, set2);
    });
  }

  function testAssertObjectEqualsIterNoEquals() {
    // an object with an iterator but no equals() and no map_ cannot
    // be compared
    function Thing() {
      this.what = [];
    }
    Thing.prototype.add = function(n, v) {
      this.what.push(n + '@' + v);
    };
    Thing.prototype.get = function(n) {
      var m = new RegExp('^' + n + '@(.*)$', '');
      for (var i = 0; i < this.what.length; ++i) {
        var match = this.what[i].match(m);
        if (match) {
          return match[1];
        }
      }
      return null;
    };
    Thing.prototype.__iterator__ = function() {
      var iter = new goog.iter.Iterator;
      iter.index = 0;
      iter.thing = this;
      iter.next = function() {
        if (this.index < this.thing.what.length) {
          return this.thing.what[this.index++].split('@')[0];
        } else {
          throw goog.iter.StopIteration;
        }
      };
      return iter;
    };

    var thing1 = new Thing(); thing1.name = 'thing1';
    var thing2 = new Thing(); thing2.name = 'thing2';
    thing1.add('red', 'fish');
    thing1.add('blue', 'fish');

    thing2.add('red', 'fish');
    thing2.add('blue', 'fish');

    assertThrows('things should not be equal', function() {
      assertObjectEquals(thing1, thing2);
    });
  }

  function testAssertObjectEqualsWithDates() {
    var date = new Date(2010, 0, 1);
    var dateWithMilliseconds = new Date(2010, 0, 1, 0, 0, 0, 1);
    assertObjectEquals(new Date(2010, 0, 1), date);
    assertThrows(goog.partial(assertObjectEquals, date, dateWithMilliseconds));
  }

  function testAssertObjectEqualsSparseArrays() {
    var arr1 = [,2,,4,,];
    var arr2 = [1,2,3,4,5];

    assertThrows('Sparse arrays should not be equal', function() {
      assertObjectEquals(arr1, arr2);
    });

    assertThrows('Sparse arrays should not be equal', function() {
      assertObjectEquals(arr2, arr1);
    });
  }

  function testAssertObjectEqualsSparseArrays2() {
    // On IE6-8, the expression "1 in [4,undefined]" evaluates to false,
    // but true on other browsers. FML. This test verifies a regression
    // where IE reported that arr4 was not equal to arr1 or arr2.
    var arr1 = [1,,3];
    var arr2 = [1,undefined,3];
    var arr3 = goog.array.clone(arr1);
    var arr4 = [];
    arr4.push(1, undefined, 3);

    // Assert that all those arrays are equivalent pairwise.
    var arrays = [arr1, arr2, arr3, arr4];
    for (var i = 0; i < arrays.length; i++) {
      for (var j = 0; j < arrays.length; j++) {
        assertArrayEquals(arrays[i], arrays[j]);
      }
    }
  }

  function testAssertObjectEqualsArraysWithExtraProps() {
    var arr1 = [1];
    var arr2 = [1];
    arr2.foo = 3;

    assertThrows('Aarrays should not be equal', function() {
      assertObjectEquals(arr1, arr2);
    });

    assertThrows('Arrays should not be equal', function() {
      assertObjectEquals(arr2, arr1);
    });
  }

  function testAssertSameElementsOnArray() {
    assertSameElements([1, 2], [2, 1]);
    assertSameElements('Good assertion', [1, 2], [2, 1]);
    assertSameElements('Good assertion with duplicates', [1, 1, 2], [2, 1, 1]);
    assertThrowsJsUnitException(
        function() {
          assertSameElements([1, 2], [1]);
        },
        'Expected 2 elements: [1,2], got 1 elements: [1]');
    assertThrowsJsUnitException(
        function() {
          assertSameElements('Should match', [1, 2], [1]);
        },
        'Should match\nExpected 2 elements: [1,2], got 1 elements: [1]');
    assertThrowsJsUnitException(
        function() {
          assertSameElements([1, 2], [1, 3]);
        },
        'Expected [1,2], got [1,3]');
    assertThrowsJsUnitException(
        function() {
          assertSameElements('Should match', [1, 2], [1, 3]);
        },
        'Should match\nExpected [1,2], got [1,3]');
    assertThrowsJsUnitException(
        function() {
          assertSameElements([1, 1, 2], [2, 2, 1]);
        },
        'Expected [1,1,2], got [2,2,1]');
  }

  function testAssertSameElementsOnArrayLike() {
    assertSameElements({0: 0, 1: 1, length: 2}, {length: 2, 1: 1, 0: 0});
    assertThrowsJsUnitException(
        function() {
          assertSameElements({0: 0, 1: 1, length: 2}, {0: 0, length: 1});
        },
        'Expected 2 elements: [0,1], got 1 elements: [0]');
  }

  function testAssertSameElementsWithBadArguments() {
    assertThrowsJsUnitException(
        function() {
          assertSameElements([], new goog.structs.Set());
        },
        'Bad arguments to assertSameElements(opt_message, expected: ' +
        'ArrayLike, actual: ArrayLike)\n' +
        'Call to assertTrue(boolean) with false');
  }

  var implicitlyTrue = [
    true,
    1,
    -1,
    ' ',
    'string',
    Infinity,
    new Object()
  ];

  var implicitlyFalse = [
    false,
    0,
    '',
    null,
    undefined,
    NaN
  ];

  function testAssertEvaluatesToTrue() {
    assertEvaluatesToTrue(true);
    assertEvaluatesToTrue('', true);
    assertEvaluatesToTrue('Good assertion', true);
    assertThrowsJsUnitException(
        function() { assertEvaluatesToTrue(false); },
        'Expected to evaluate to true');
    assertThrowsJsUnitException(
        function() {assertEvaluatesToTrue('Should be true', false); },
        'Should be true\nExpected to evaluate to true');
    for (var i = 0; i < implicitlyTrue.length; i++) {
      assertEvaluatesToTrue(String('Test ' + implicitlyTrue[i] +
          ' [' + i + ']'), implicitlyTrue[i]);
    }
    for (var i = 0; i < implicitlyFalse.length; i++) {
      assertThrowsJsUnitException(
          function() { assertEvaluatesToTrue(implicitlyFalse[i]); },
          'Expected to evaluate to true');
    }
  }

  function testAssertEvaluatesToFalse() {
    assertEvaluatesToFalse(false);
    assertEvaluatesToFalse('Good assertion', false);
    assertThrowsJsUnitException(
        function() { assertEvaluatesToFalse(true); },
        'Expected to evaluate to false');
    assertThrowsJsUnitException(
        function() { assertEvaluatesToFalse('Should be false', true); },
        'Should be false\nExpected to evaluate to false');
    for (var i = 0; i < implicitlyFalse.length; i++) {
      assertEvaluatesToFalse(String('Test ' + implicitlyFalse[i] +
          ' [' + i + ']'), implicitlyFalse[i]);
    }
    for (var i = 0; i < implicitlyTrue.length; i++) {
      assertThrowsJsUnitException(
          function() { assertEvaluatesToFalse(implicitlyTrue[i]); },
          'Expected to evaluate to false');
    }
  }

  function testAssertHTMLEquals() {
    // TODO
  }

  function testAssertHashEquals() {
    assertHashEquals({a: 1, b: 2}, {b: 2, a: 1});
    assertHashEquals('Good assertion', {a: 1, b: 2}, {b: 2, a: 1});
    assertHashEquals({a: undefined}, {a: undefined});
    // Missing key.
    assertThrowsJsUnitException(
        function() { assertHashEquals({a: 1, b: 2}, {a: 1}); },
        'Expected hash had key b that was not found');
    assertThrowsJsUnitException(
        function() { assertHashEquals('Should match', {a: 1, b: 2}, {a: 1}); },
        'Should match\nExpected hash had key b that was not found');
    assertThrowsJsUnitException(
        function() { assertHashEquals({a: undefined}, {}); },
        'Expected hash had key a that was not found');
    // Not equal key.
    assertThrowsJsUnitException(
        function() { assertHashEquals({a: 1}, {a: 5}); },
        'Value for key a mismatch - expected = 1, actual = 5');
    assertThrowsJsUnitException(
        function() { assertHashEquals('Should match', {a: 1}, {a: 5}); },
        'Should match\nValue for key a mismatch - expected = 1, actual = 5');
    assertThrowsJsUnitException(
        function() { assertHashEquals({a: undefined}, {a: 1})},
        'Value for key a mismatch - expected = undefined, actual = 1');
    // Extra key.
    assertThrowsJsUnitException(
        function() { assertHashEquals({a: 1}, {a: 1, b: 1}); },
        'Actual hash had key b that was not expected');
    assertThrowsJsUnitException(
        function() { assertHashEquals('Should match', {a: 1}, {a: 1, b: 1}); },
        'Should match\nActual hash had key b that was not expected');
  }

  function testAssertRoughlyEquals() {
    assertRoughlyEquals(1, 1, 0);
    assertRoughlyEquals('Good assertion', 1, 1, 0);
    assertRoughlyEquals(1, 1.1, 0.11);
    assertRoughlyEquals(1.1, 1, 0.11);
    assertThrowsJsUnitException(
        function() { assertRoughlyEquals(1, 1.1, 0.05); },
        'Expected 1, but got 1.1 which was more than 0.05 away');
    assertThrowsJsUnitException(
        function() { assertRoughlyEquals('Close enough', 1, 1.1, 0.05); },
        'Close enough\nExpected 1, but got 1.1 which was more than 0.05 away');
  }

  function testAssertContains() {
    var a = [1, 2, 3];
    assertContains(1, [1, 2, 3]);
    assertContains('Should contain', 1, [1, 2, 3]);
    assertThrowsJsUnitException(
        function() { assertContains(4, [1, 2, 3]); },
        'Expected \'1,2,3\' to contain \'4\'');
    assertThrowsJsUnitException(
        function() { assertContains('Should contain', 4, [1, 2, 3]); },
        'Should contain\nExpected \'1,2,3\' to contain \'4\'');
    // assertContains uses ===.
    var o = new Object();
    assertContains(o, [o, 2, 3]);
    assertThrowsJsUnitException(
        function() { assertContains(o, [1, 2, 3]); },
        'Expected \'1,2,3\' to contain \'[object Object]\'');
  }

  function testAssertNotContains() {
    var a = [1, 2, 3];
    assertNotContains(4, [1, 2, 3]);
    assertNotContains('Should not contain', 4, [1, 2, 3]);
    assertThrowsJsUnitException(
        function() { assertNotContains(1, [1, 2, 3]); },
        'Expected \'1,2,3\' not to contain \'1\'');
    assertThrowsJsUnitException(
        function() { assertNotContains('Should not contain', 1, [1, 2, 3]); },
        "Should not contain\nExpected '1,2,3' not to contain '1'");
    // assertNotContains uses ===.
    var o = new Object();
    assertNotContains({}, [o, 2, 3]);
    assertThrowsJsUnitException(
        function() { assertNotContains(o, [o, 2, 3]); },
        'Expected \'[object Object],2,3\' not to contain \'[object Object]\'');
  }

  function testAssertThrows() {
    var fail = false;
    try {
      assertThrows('assertThrows should not pass with null param', null);
      fail = true;
    } catch (e) {
    }
    assertFalse('Fail should not get set to true', fail);

    try {
      assertThrows(
          'assertThrows should not pass with undefined param',
          undefined);
      fail = true;
    } catch (e) {
    }
    assertFalse('Fail should not get set to true', fail);

    try {
      assertThrows('assertThrows should not pass with number param', 1);
      fail = true;
    } catch (e) {
    }
    assertFalse('Fail should not get set to true', fail);

    try {
      assertThrows('assertThrows should not pass with string param', 'string');
      fail = true;
    } catch (e) {
    }
    assertFalse('Fail should not get set to true', fail);

    try {
      assertThrows('assertThrows should not pass with object param', {});
      fail = true;
    } catch (e) {
    }
    assertFalse('Fail should not get set to true', fail);

    try {
      var error = assertThrows('valid function throws Error', function() {
        throw new Error('test');
      });
    } catch (e) {
      fail('assertThrows incorrectly doesn\'t detect a thrown exception');
    }
    assertEquals('error message', 'test', error.message);

    try {
      var stringError = assertThrows('valid function throws string error',
          function() {
            throw 'string error test';
          });
    } catch (e) {
      fail('assertThrows doesn\'t detect a thrown string exception');
    }
    assertEquals('string error', 'string error test', stringError);
  }

  function testAssertNotThrows() {
    var fail = false;
    try {
      assertNotThrows('assertNotThrows should not pass with null param', null);
      fail = true;
    } catch (e) {
    }
    assertFalse('Fail should not get set to true', fail);

    try {
      assertNotThrows(
          'assertNotThrows should not pass with undefined param', undefined);
      fail = true;
    } catch (e) {
    }
    assertFalse('Fail should not get set to true', fail);

    try {
      assertNotThrows('assertNotThrows should not pass with number param', 1);
      fail = true;
    } catch (e) {
    }
    assertFalse('Fail should not get set to true', fail);

    try {
      assertNotThrows('assertNotThrows should not pass with string param',
          'string');
      assertNotThrows('assertNotThrows should not pass with string param',
          'string');
      fail = true;
    } catch (e) {
    }
    assertFalse('Fail should not get set to true', fail);


    try {
      assertNotThrows('assertNotThrows should not pass with object param', {});
      fail = true;
    } catch (e) {
    }
    assertFalse('Fail should not get set to true', fail);


    try {
      assertNotThrows('valid function',
          function() {
            //do nothing;
          });
    } catch (e) {
      // Shouldn't be here: throw exception.
      assertTrue('assertNotThrows returned failure on a valid function', false);
    }

    try {
      assertNotThrows('non valid error throwing function',
          function() {
            throw new Error('test');
          });
      fail = true;
    } catch (e) {
    }
    assertFalse('assertNotThrows did not fail on a a thrown exception',
        fail);
  }

  function testAssertArrayEquals() {
    var a1 = [0, 1, 2];
    var a2 = [0, 1, 2];
    assertArrayEquals('Arrays should be equal', a1, a2);

    assertThrows('Should have thrown because args are not arrays', function() {
      var b1 = true;
      var b2 = true;
      assertArrayEquals(b1, b2);
    });
  }

  function testAssertObjectsEqualsDifferentArrays() {
    assertThrows('Should have thrown because args are different', function() {
      var a1 = ['className1'];
      var a2 = ['className2'];
      assertArrayEquals(a1, a2);
      assertObjectEquals(a1, a2);
    });
  }

  function testAssertObjectsEqualsDifferentTypeSameToString() {
    assertThrows('Should have thrown because args are different', function() {
      var a1 = 'className1';
      var a2 = ['className1'];
      assertObjectEquals(a1, a2);
    });

    assertThrows('Should have thrown because args are different', function() {
      var a1 = ['className1'];
      var a2 = {'0': 'className1'};
      assertObjectEquals(a1, a2);
    });

    assertThrows('Should have thrown because args are different', function() {
      var a1 = ['className1'];
      var a2 = [['className1']];
      assertObjectEquals(a1, a2);
    });
  }

  function testFindDifferences_equal() {
    assertNull(goog.testing.asserts.findDifferences(true, true));
    assertNull(goog.testing.asserts.findDifferences(null, null));
    assertNull(goog.testing.asserts.findDifferences(undefined, undefined));
    assertNull(goog.testing.asserts.findDifferences(1, 1));
    assertNull(goog.testing.asserts.findDifferences([1, 'a'], [1, 'a']));
    assertNull(goog.testing.asserts.findDifferences(
        [[1, 2], [3, 4]], [[1, 2], [3, 4]]));
    assertNull(goog.testing.asserts.findDifferences(
        [{a: 1, b: 2}], [{b: 2, a: 1}]));
    assertNull(goog.testing.asserts.findDifferences(null, null));
    assertNull(goog.testing.asserts.findDifferences(undefined, undefined));
  }

  function testFindDifferences_unequal() {
    assertNotNull(goog.testing.asserts.findDifferences(true, false));
    assertNotNull(goog.testing.asserts.findDifferences(
        [{a: 1, b: 2}], [{a: 2, b: 1}]));
    assertNotNull(goog.testing.asserts.findDifferences(
        [{a: 1}], [{a: 1, b: [2]}]));
    assertNotNull(goog.testing.asserts.findDifferences(
        [{a: 1, b: [2]}], [{a: 1}]));
  }

  function testFindDifferences_objectsAndNull() {
    assertNotNull(goog.testing.asserts.findDifferences({a: 1}, null));
    assertNotNull(goog.testing.asserts.findDifferences(null, {a: 1}));
    assertNotNull(goog.testing.asserts.findDifferences(null, []));
    assertNotNull(goog.testing.asserts.findDifferences([], null));
    assertNotNull(goog.testing.asserts.findDifferences([], undefined));
  }

  function testFindDifferences_basicCycle() {
    var a = {};
    var b = {};
    a.self = a;
    b.self = b;
    assertNull(goog.testing.asserts.findDifferences(a, b));

    a.unique = 1;
    assertNotNull(goog.testing.asserts.findDifferences(a, b));
  }

  function testFindDifferences_crossedCycle() {
    var a = {};
    var b = {};
    a.self = b;
    b.self = a;
    assertNull(goog.testing.asserts.findDifferences(a, b));

    a.unique = 1;
    assertNotNull(goog.testing.asserts.findDifferences(a, b));
  }

  function testFindDifferences_asymmetricCycle() {
    var a = {};
    var b = {};
    var c = {};
    var d = {};
    var e = {};
    a.self = b;
    b.self = a;
    c.self = d;
    d.self = e;
    e.self = c;
    assertNotNull(goog.testing.asserts.findDifferences(a, c));
  }

  function testFindDifferences_basicCycleArray() {
    var a = [];
    var b = [];
    a[0] = a;
    b[0] = b;
    assertNull(goog.testing.asserts.findDifferences(a, b));

    a[1] = 1;
    assertNotNull(goog.testing.asserts.findDifferences(a, b));
  }

  function testFindDifferences_crossedCycleArray() {
    var a = [];
    var b = [];
    a[0] = b;
    b[0] = a;
    assertNull(goog.testing.asserts.findDifferences(a, b));

    a[1] = 1;
    assertNotNull(goog.testing.asserts.findDifferences(a, b));
  }

  function testFindDifferences_asymmetricCycleArray() {
    var a = [];
    var b = [];
    var c = [];
    var d = [];
    var e = [];
    a[0] = b;
    b[0] = a;
    c[0] = d;
    d[0] = e;
    e[0] = c;
    assertNotNull(goog.testing.asserts.findDifferences(a, c));
  }

  function testFindDifferences_binaryTree() {
    function createBinTree(depth, root) {
      if (depth == 0) {
        return {root: root};
      } else {
        var node = {};
        node.left = createBinTree(depth-1, root || node);
        node.right = createBinTree(depth-1, root || node);
        return node;
      }
    }

    // TODO(user,user): This test does not terminate with the current
    // algorithm. Can be enabled when (if) the algorithm is improved.
    //assertNull(goog.testing.asserts.findDifferences(
    //    createBinTree(5, null), createBinTree(5, null)));
    assertNotNull(goog.testing.asserts.findDifferences(
        createBinTree(4, null), createBinTree(5, null)));
  }

  function testStringForWindowIE() {
    if (goog.userAgent.IE && !goog.userAgent.isVersion('8')) {
      // NOTE(user): This test sees of we are being affected by a JScript bug
      // in try/finally handling. This bug only affects the lowest try/finally
      // block in the stack. Calling this function via VBScript allows
      // us to run the test synchronously in an empty JS stack.
      window.execScript('stringForWindowIEHelper()', 'vbscript');
      assertEquals('<[object]> (Object)', window.stringForWindowIEResult);
    }
  }

  function stringForWindowIEHelper() {
    window.stringForWindowIEResult = _displayStringForValue(window);
  }

">48 of 48 tests run in 60ms.<br />47 passed, 1 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testAssertNonEmptyString<br />Call to fail()<br />Expected a JsUnitException<br /></td></tr>
<tr><td>dragger_test.html</td><td>Fail</td><td> 0 passed, 10 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.events.BrowserEvent');
  goog.require('goog.events.BrowserEvent.MouseButton');
  goog.require('goog.events.Event');
  goog.require('goog.events.EventType');
  goog.require('goog.fx.Dragger');
  goog.require('goog.testing.events');
  goog.require('goog.testing.StrictMock');
  goog.require('goog.testing.jsunit');



var HAS_SET_CAPTURE = goog.fx.Dragger.HAS_SET_CAPTURE_;

var target;
function setUp() {
  var sandbox = goog.dom.getElement('sandbox');
  target = goog.dom.createDom('div', {
    'id': 'target',
    'style': 'display:none;position:absolute;top:15px;left:10px'
  });
  sandbox.appendChild(target);
  sandbox.appendChild(goog.dom.createDom('div', {'id': 'handle'}));
}

function tearDown() {
  goog.dom.getElement('sandbox').innerHTML = '';
  goog.events.removeAll();
}

function testStartDrag() {
  var dragger = new goog.fx.Dragger(target, goog.dom.getElement('handle'));

  var e = new goog.testing.StrictMock(goog.events.BrowserEvent);
  e.type = goog.events.EventType.MOUSEDOWN;
  e.clientX = 1;
  e.clientY = 2;
  e.isMouseActionButton().$returns(true);
  e.preventDefault();
  e.isMouseActionButton().$returns(true);
  e.preventDefault();
  e.$replay();

  goog.events.listen(dragger, goog.fx.Dragger.EventType.START, function() {
    target.style.display = 'block';
  });

  dragger.startDrag(e);

  assertTrue('Start drag with no hysteresis must actually start the drag.',
      dragger.dragging_);

  assertEquals('Dragger startX must match event\'s clientX.',
      1, dragger.startX);
  assertEquals('Dragger clientX must match event\'s clientX',
      1, dragger.clientX);
  assertEquals('Dragger startY must match event\'s clientY.',
      2, dragger.startY);
  assertEquals('Dragger clientY must match event\'s clientY',
      2, dragger.clientY);
  assertEquals('Dragger deltaX must match target\'s offsetLeft',
      10, dragger.deltaX);
  assertEquals('Dragger deltaY must match target\'s offsetTop',
      15, dragger.deltaY);

  dragger = new goog.fx.Dragger(target, goog.dom.getElement('handle'));
  dragger.setHysteresis(1);
  dragger.startDrag(e);
  assertFalse('Start drag with a valid non-zero hysteresis should not start ' +
      'the drag.', dragger.dragging_);
  e.$verify();
}

/**
 * @bug 1381317 Cancelling start drag didn't end the attempt to drag.
 */
function testStartDrag_Cancel() {
  var dragger = new goog.fx.Dragger(target);

  var e = new goog.testing.StrictMock(goog.events.BrowserEvent);
  e.type = goog.events.EventType.MOUSEDOWN;
  e.clientX = 1;
  e.clientY = 2;
  e.isMouseActionButton().$returns(true);
  e.$replay();

  goog.events.listen(dragger, goog.fx.Dragger.EventType.START, function(e) {
    // Cancel drag.
    e.preventDefault();
  });

  dragger.startDrag(e);

  assertFalse('Start drag must have been cancelled.',
      dragger.dragging_);
  assertFalse('Dragger must not have registered mousemove handlers.',
      goog.events.hasListener(dragger.document_,
          goog.events.EventType.MOUSEMOVE, !HAS_SET_CAPTURE));
  assertFalse('Dragger must not have registered mouseup handlers.',
      goog.events.hasListener(dragger.document_, goog.events.EventType.MOUSEUP,
          !HAS_SET_CAPTURE));
  e.$verify();
}

/**
 * Tests that start drag happens on left mousedown.
 */
function testStartDrag_LeftMouseDownOnly() {
  var dragger = new goog.fx.Dragger(target);

  var e = new goog.testing.StrictMock(goog.events.BrowserEvent);
  e.type = goog.events.EventType.MOUSEDOWN;
  e.clientX = 1;
  e.clientY = 2;
  e.isMouseActionButton().$returns(false);
  e.$replay();

  goog.events.listen(dragger, goog.fx.Dragger.EventType.START, function(e) {
    fail("No drag START event should have been dispatched");
  });

  dragger.startDrag(e);

  assertFalse('Start drag must have been cancelled.',
      dragger.dragging_);
  assertFalse('Dragger must not have registered mousemove handlers.',
      goog.events.hasListener(dragger.document_,
          goog.events.EventType.MOUSEMOVE, true));
  assertFalse('Dragger must not have registered mouseup handlers.',
      goog.events.hasListener(dragger.document_, goog.events.EventType.MOUSEUP,
          true));
  e.$verify();
}

/**
 * Tests that start drag happens on other event type than MOUSEDOWN.
 */
function testStartDrag_MouseMove() {
  var dragger = new goog.fx.Dragger(target);

  var e = new goog.testing.StrictMock(goog.events.BrowserEvent);
  e.type = goog.events.EventType.MOUSEMOVE;
  e.clientX = 1;
  e.clientY = 2;
  e.preventDefault();
  e.$replay();

  var startDragFired = false;
  goog.events.listen(dragger, goog.fx.Dragger.EventType.START, function(e) {
    startDragFired = true;
  });

  dragger.startDrag(e);

  assertTrue('Dragging should be in progress.', dragger.dragging_);
  assertTrue('Start drag event should have fired.', startDragFired);
  assertTrue('Dragger must have registered mousemove handlers.',
      goog.events.hasListener(dragger.document_,
          goog.events.EventType.MOUSEMOVE, !HAS_SET_CAPTURE));
  assertTrue('Dragger must have registered mouseup handlers.',
      goog.events.hasListener(dragger.document_, goog.events.EventType.MOUSEUP,
          !HAS_SET_CAPTURE));
  e.$verify();
}

/**
 * @bug 1381317 Cancelling start drag didn't end the attempt to drag.
 */
function testHandleMove_Cancel() {
  var dragger = new goog.fx.Dragger(target);
  dragger.setHysteresis(5);

  goog.events.listen(dragger, goog.fx.Dragger.EventType.START, function(e) {
    // Cancel drag.
    e.preventDefault();
  });

  var e = new goog.testing.StrictMock(goog.events.BrowserEvent);
  e.clientX = 1;
  e.clientY = 2;
  e.isMouseActionButton().$returns(true).
      $anyTimes();
  e.preventDefault();
  e.$replay();
  dragger.startDrag(e);
  assertFalse('Start drag must not start drag because of hysterisis.',
      dragger.dragging_);
  assertTrue('Dragger must have registered mousemove handlers.',
      goog.events.hasListener(dragger.document_,
          goog.events.EventType.MOUSEMOVE, !HAS_SET_CAPTURE));
  assertTrue('Dragger must have registered mouseup handlers.',
      goog.events.hasListener(dragger.document_, goog.events.EventType.MOUSEUP,
          !HAS_SET_CAPTURE));

  e.clientX = 10;
  e.clientY = 10;
  dragger.handleMove_(e);
  assertFalse('Drag must be cancelled.', dragger.dragging_);
  assertFalse('Dragger must unregistered mousemove handlers.',
      goog.events.hasListener(dragger.document_,
          goog.events.EventType.MOUSEMOVE, true));
  assertFalse('Dragger must unregistered mouseup handlers.',
      goog.events.hasListener(dragger.document_, goog.events.EventType.MOUSEUP,
          true));
  e.$verify();
}

/**
 * @bug 1714667 IE built in drag and drop handling stops dragging.
 */
function testIeDragStartCancelling() {
  // Testing only IE.
  if (!goog.userAgent.IE) {
    return;
  }

  // Built in 'dragstart' cancelling not enabled.
  var dragger = new goog.fx.Dragger(target);

  var e = new goog.events.Event(goog.events.EventType.MOUSEDOWN);
  e.clientX = 1;
  e.clientY = 2;
  e.button = 1; // IE only constant for left button.
  var be = new goog.events.BrowserEvent(e);
  dragger.startDrag(be);
  assertTrue('The drag should have started.', dragger.dragging_);

  e = new goog.events.Event(goog.events.EventType.DRAGSTART);
  e.target = dragger.document_.documentElement;
  assertTrue('The event should not be canceled.',
      goog.testing.events.fireBrowserEvent(e));

  dragger.dispose();

  // Built in 'dragstart' cancelling enabled.
  dragger = new goog.fx.Dragger(target);
  dragger.setCancelIeDragStart(true);

  e = new goog.events.Event(goog.events.EventType.MOUSEDOWN);
  e.clientX = 1;
  e.clientY = 2;
  e.button = 1; // IE only constant for left button.
  be = new goog.events.BrowserEvent(e);
  dragger.startDrag(be);
  assertTrue('The drag should have started.', dragger.dragging_);

  e = new goog.events.Event(goog.events.EventType.DRAGSTART);
  e.target = dragger.document_.documentElement;
  assertFalse('The event should be canceled.',
      goog.testing.events.fireBrowserEvent(e));

  dragger.dispose();
}


/** @bug 1680770 */
function testOnWindowMouseOut() {
  // Test older Gecko browsers - FireFox 2.
  if (goog.userAgent.GECKO && !goog.userAgent.isVersion('1.9a')) {
    var dragger = new goog.fx.Dragger(target);

    var dragCanceled = false;
    goog.events.listen(dragger, goog.fx.Dragger.EventType.END, function(e) {
      dragCanceled = e.dragCanceled;
    });

    var e = new goog.testing.StrictMock(goog.events.BrowserEvent);
    e.type = goog.events.EventType.MOUSEDOWN;
    e.clientX = 1;
    e.clientY = 2;
    e.isMouseActionButton().$returns(true);
    e.preventDefault();
    e.$replay();
    dragger.startDrag(e);
    e.$verify();

    assertTrue(dragger.dragging_);

    e = new goog.events.BrowserEvent();
    e.type = goog.events.EventType.MOUSEOUT;
    e.target = goog.dom.getElement('sandbox');
    e.currentTarget = window.top;
    e.relatedTarget = target;
    dragger.onWindowMouseOut_(e);

    assertFalse('Drag is not canceled for normal in-window mouseout.',
        dragCanceled);
    assertTrue('Must not stop dragging for normal in-window mouseout.',
        dragger.dragging_);

    dragCanceled = false;
    delete e.relatedTarget;
    e.target = goog.dom.createDom('iframe');
    dragger.onWindowMouseOut_(e);
    assertFalse('Drag is not canceled for mousing into iframe.',
        dragCanceled);
    assertTrue('Must not stop dragging for mousing into iframe.',
        dragger.dragging_);

    dragCanceled = false;
    e.target = target;
    dragger.onWindowMouseOut_(e);
    assertTrue('Drag is canceled for real mouse out of top window.',
        dragCanceled);
    assertFalse('Must stop dragging for real mouse out of top window.',
        dragger.dragging_);
  }
}

function testLimits() {
  var dragger = new goog.fx.Dragger(target);

  assertEquals(100, dragger.limitX(100));
  assertEquals(100, dragger.limitY(100));

  dragger.setLimits(new goog.math.Rect(10, 20, 30, 40));

  assertEquals(10, dragger.limitX(0));
  assertEquals(40, dragger.limitX(100));
  assertEquals(20, dragger.limitY(0));
  assertEquals(60, dragger.limitY(100));
}

function testWindowBlur() {
  if (!goog.fx.Dragger.HAS_SET_CAPTURE_) {
    var dragger = new goog.fx.Dragger(target);

    var dragEnded = false;
    goog.events.listen(dragger, goog.fx.Dragger.EventType.END, function(e) {
      dragEnded = true;
    });

    var e = new goog.testing.StrictMock(goog.events.BrowserEvent);
    e.type = goog.events.EventType.MOUSEDOWN;
    e.clientX = 1;
    e.clientY = 2;
    e.isMouseActionButton().$returns(true);
    e.preventDefault();
    e.$replay();
    dragger.startDrag(e);
    e.$verify();

    assertTrue(dragger.dragging_);

    e = new goog.events.BrowserEvent();
    e.type = goog.events.EventType.BLUR;
    e.target = window;
    e.currentTarget = window;
    goog.testing.events.fireBrowserEvent(e);

    assertTrue(dragEnded);
  }
}

function testBlur() {
  if (!goog.fx.Dragger.HAS_SET_CAPTURE_) {
    var dragger = new goog.fx.Dragger(target);

    var dragEnded = false;
    goog.events.listen(dragger, goog.fx.Dragger.EventType.END, function(e) {
      dragEnded = true;
    });

    var e = new goog.testing.StrictMock(goog.events.BrowserEvent);
    e.type = goog.events.EventType.MOUSEDOWN;
    e.clientX = 1;
    e.clientY = 2;
    e.isMouseActionButton().$returns(true);
    e.preventDefault();
    e.$replay();
    dragger.startDrag(e);
    e.$verify();

    assertTrue(dragger.dragging_);

    e = new goog.events.BrowserEvent();
    e.type = goog.events.EventType.BLUR;
    e.target = document.body;
    e.currentTarget = document.body;
    // Blur events do not bubble but the test event system does not emulate that
    // part so we add a capturing listener on the target and stops the
    // propagation at the target, preventing any event from bubbling.
    goog.events.listen(document.body, goog.events.EventType.BLUR, function(e) {
      e.propagationStopped_ = true;
    }, true);
    goog.testing.events.fireBrowserEvent(e);

    assertFalse(dragEnded);
  }
}

">10 of 10 tests run in 11ms.<br />0 passed, 10 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testBlur<br />Object #<Object> has no method 'createElement'<br />ERROR in testHandleMove_Cancel<br />Object #<Object> has no method 'createElement'<br />ERROR in testIeDragStartCancelling<br />Object #<Object> has no method 'createElement'<br />ERROR in testLimits<br />Object #<Object> has no method 'createElement'<br />ERROR in testOnWindowMouseOut<br />Object #<Object> has no method 'createElement'<br />ERROR in testStartDrag<br />Object #<Object> has no method 'createElement'<br />ERROR in testStartDrag_Cancel<br />Object #<Object> has no method 'createElement'<br />ERROR in testStartDrag_LeftMouseDownOnly<br />Object #<Object> has no method 'createElement'<br />ERROR in testStartDrag_MouseMove<br />Object #<Object> has no method 'createElement'<br />ERROR in testWindowBlur<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>fx_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="

  goog.require('goog.Timer');
  goog.require('goog.fx');
  goog.require('goog.fx.Animation');
  goog.require('goog.object');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.testing.jsunit');



// TODO(user): Add tests for the event dispatches.
// TODO(user): Add tests for the calculation of the coordinates.

var clock, replacer, anim, anim2;
var Animation = goog.fx.Animation;

function setUpPage() {
  clock = new goog.testing.MockClock(true);
}

function tearDownPage() {
  clock.dispose();
}

function setUp() {
  replacer = new goog.testing.PropertyReplacer();
}

function tearDown() {
  replacer.reset();

  if (anim && anim.dispose) {
    anim.dispose();
  }

  if (anim2 && anim2.dispose) {
    anim2.dispose();
  }
}

function testAnimationConstructor() {
  assertThrows('Should throw since first arg is not an array', function() {
    new Animation(1, [2], 3);
  });
  assertThrows('Should throw since second arg is not an array', function() {
    new Animation([1], 2, 3);
  });
  assertThrows('Should throw since the length are different', function() {
    new Animation([0, 1], [2], 3);
  });
}

function testRegisterAndUnregisterAnimation() {
  var setTimoutCount = 0;
  var setIntervalCount = 0;
  var timerIdCounter = 1;

  replacer.set(goog.Timer.defaultTimerObject, 'setTimeout', function() {
    setTimoutCount++;
    return timerIdCounter++;
  });
  replacer.set(goog.Timer.defaultTimerObject, 'setInterval', function() {
    setIntervalCount++;
    return timerIdCounter++;
  });
  replacer.set(goog.Timer.defaultTimerObject, 'clearTimeout', function() {
    setTimoutCount--;
  });
  replacer.set(Animation, 'globalTimer_', null);


  anim = new Animation([0], [1], 1000);
  anim2 = new Animation([0], [1], 1000);

  Animation.registerAnimation(anim);

  assertTrue('Should contain the animation',
             goog.object.containsValue(Animation.activeAnimations_,
                                       anim));
  assertEquals('Should have called setTimout once', 1, setTimoutCount);
  assertEquals('setInterval should not be called', 0, setIntervalCount);
  Animation.registerAnimation(anim2);
  assertEquals('Should not have called setTimout again', 1, setTimoutCount);
  assertEquals('setInterval should not be called', 0, setIntervalCount);

  // Add anim again.
  Animation.registerAnimation(anim);
  assertTrue('Should contain the animation',
             goog.object.containsValue(Animation.activeAnimations_,
                                       anim));
  assertEquals('Should not have called setTimout again', 1, setTimoutCount);
  assertEquals('setInterval should not be called', 0, setIntervalCount);

  Animation.unregisterAnimation(anim);
  assertFalse('Should not contain the animation',
              goog.object.containsValue(Animation.activeAnimations_,
                                        anim));
  assertEquals('clearTimeout should not have been called', 1, setTimoutCount);
  assertEquals('setInterval should not be called', 0, setIntervalCount);

  Animation.unregisterAnimation(anim2);
  assertEquals('There should be no remaining timers', 0, setTimoutCount);
  assertEquals('setInterval should not be called', 0, setIntervalCount);

  // Make sure we don't trigger setTimeout or setInterval.
  clock.tick(1000);
  assertEquals('There should be no remaining timers', 0, setTimoutCount);
  assertEquals('setInterval should not be called', 0, setIntervalCount);
}

function testPlayAndStopDoesNotLeaveAnyActiveAnimations() {
  anim = new Animation([0], [1], 1000);

  assertTrue('There should be no active animations',
             goog.object.isEmpty(Animation.activeAnimations_));

  anim.play();
  assertEquals('There should be one active animations',
               1, goog.object.getCount(Animation.activeAnimations_));

  anim.stop();
  assertTrue('There should be no active animations',
             goog.object.isEmpty(Animation.activeAnimations_));

  anim.play();
  assertEquals('There should be one active animations',
               1, goog.object.getCount(Animation.activeAnimations_));

  anim.pause();
  assertTrue('There should be no active animations',
             goog.object.isEmpty(Animation.activeAnimations_));
}


">n/a</td></tr>
<tr><td>cssspriteanimation_test.html</td><td>Fail</td><td> 0 passed, 2 failed.</td><td title="

  goog.require('goog.fx.CssSpriteAnimation');
  goog.require('goog.math.Box');
  goog.require('goog.math.Size');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.jsunit');



var el = document.getElementById('test');
var size = new goog.math.Size(10, 10);
var box = new goog.math.Box(0, 10, 100, 0);
var time = 1000;
var anim, clock;

function setUpPage() {
  clock = new goog.testing.MockClock(true);
}

function tearDownPage() {
  clock.dispose();
}

function setUp() {
  anim = new goog.fx.CssSpriteAnimation(el, size, box, time);
  anim.play();
}

function tearDown() {
  anim.clearSpritePosition();
  anim.dispose();
}

function assertBackgroundPosition(x, y) {
  if (typeof el.style.backgroundPositionX != 'undefined') {
    assertEquals(x + 'px', el.style.backgroundPositionX);
    assertEquals(y + 'px', el.style.backgroundPositionY);
  } else {
    var bgPos = el.style.backgroundPosition;
    var message = 'Expected <' + x + 'px ' + y + 'px>, found <' + bgPos + '>';
    if (x == y) {
      // when x and y are the same the browser sometimes collapse the prop
      assertTrue(message,
                 bgPos == x || // in case of 0 without a unit
                 bgPos == x + 'px' ||
                 bgPos == x + ' ' + y ||
                 bgPos == x + 'px ' + y + 'px');
    } else {
      assertTrue(message,
                 bgPos == x + ' ' + y ||
                 bgPos == x + 'px ' + y ||
                 bgPos == x + ' ' + y + 'px' ||
                 bgPos == x + 'px ' + y + 'px');
    }
  }
}

function testAnimation() {
  assertBackgroundPosition(0, 0);

  clock.tick(5);
  assertBackgroundPosition(0, 0);

  clock.tick(95);
  assertBackgroundPosition(0, -10);

  clock.tick(100);
  assertBackgroundPosition(0, -20);

  clock.tick(300);
  assertBackgroundPosition(0, -50);

  clock.tick(400);
  assertBackgroundPosition(0, -90);

  // loop around
  clock.tick(100);
  assertBackgroundPosition(0, 0);
}

function testClearSpritePosition() {
  assertBackgroundPosition(0, 0);

  clock.tick(100);
  assertBackgroundPosition(0, -10);
  anim.clearSpritePosition();

  if (typeof el.style.backgroundPositionX != 'undefined') {
    assertEquals('', el.style.backgroundPositionX);
    assertEquals('', el.style.backgroundPositionY);
  }

  assertEquals('', el.style.backgroundPosition);
}

">2 of 2 tests run in 7ms.<br />0 passed, 2 failed.<br />4 ms/test. 1 files loaded.<br />ERROR in testAnimation<br />Cannot set property 'backgroundPosition' of undefined<br />ERROR in testClearSpritePosition<br />Cannot set property 'backgroundPosition' of undefined<br /></td></tr>
<tr><td>dragscrollsupport_test.html</td><td>Fail</td><td> 0 passed, 3 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.events.Event');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');

  goog.require('goog.fx.DragScrollSupport');



var containerDiv = document.getElementById('containerDiv');
var contentDiv = document.getElementById('contentDiv');
var clock;

function setUp() {
  clock = new goog.testing.MockClock(true);
}


function tearDown() {
  clock.dispose();
}


function testDragZeroMarginDivContainer() {
  var dsc = new goog.fx.DragScrollSupport(containerDiv);

  // Set initial scroll state.
  var scrollTop = 50;
  containerDiv.scrollTop = scrollTop;

  goog.testing.events.fireMouseMoveEvent(containerDiv,
      new goog.math.Coordinate(50, 20 + 50));
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertEquals('Mousing inside the container should not trigger scrolling.',
      scrollTop, containerDiv.scrollTop);
  assertEquals('Scroll timer should not tick yet', 0, clock.getTimeoutsMade());

  scrollTop = containerDiv.scrollTop;
  goog.testing.events.fireMouseMoveEvent(containerDiv,
      new goog.math.Coordinate(50, 10));
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertTrue('Mousing above the container should trigger scrolling up.',
      scrollTop > containerDiv.scrollTop);
  scrollTop = containerDiv.scrollTop;
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertTrue('Mousing above the container should trigger scrolling up.',
      scrollTop > containerDiv.scrollTop);

  scrollTop = containerDiv.scrollTop;
  goog.testing.events.fireMouseMoveEvent(containerDiv,
      new goog.math.Coordinate(50, 20 + 110));
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertTrue('Mousing below the container should trigger scrolling down.',
      scrollTop < containerDiv.scrollTop);
  scrollTop = containerDiv.scrollTop;
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertTrue('Mousing below the container should trigger scrolling down.',
      scrollTop < containerDiv.scrollTop);

  scrollTop = containerDiv.scrollTop;
  goog.testing.events.fireMouseMoveEvent(containerDiv,
      new goog.math.Coordinate(50, 20 + 50));
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertEquals('Mousing inside the container should stop scrolling.',
      scrollTop, containerDiv.scrollTop);

  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);

  dsc.dispose();
}


function testDragMarginDivContainer() {
  var dsc = new goog.fx.DragScrollSupport(containerDiv, 20);

  // Set initial scroll state.
  var scrollTop = 50;
  containerDiv.scrollTop = scrollTop;

  goog.testing.events.fireMouseMoveEvent(containerDiv,
      new goog.math.Coordinate(50, 20 + 50));
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertEquals('Mousing inside the container should not trigger scrolling.',
      scrollTop, containerDiv.scrollTop);
  assertEquals('Scroll timer should not tick yet', 0, clock.getTimeoutsMade());

  scrollTop = containerDiv.scrollTop;
  goog.testing.events.fireMouseMoveEvent(containerDiv,
      new goog.math.Coordinate(50, 30));
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertTrue('Mousing above the margin should trigger scrolling up.',
      scrollTop > containerDiv.scrollTop);
  scrollTop = containerDiv.scrollTop;
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertTrue('Mousing above the margin should trigger scrolling up.',
      scrollTop > containerDiv.scrollTop);

  scrollTop = containerDiv.scrollTop;
  goog.testing.events.fireMouseMoveEvent(containerDiv,
      new goog.math.Coordinate(50, 20 + 90));
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertTrue('Mousing below the margin should trigger scrolling down.',
      scrollTop < containerDiv.scrollTop);
  scrollTop = containerDiv.scrollTop;
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertTrue('Mousing above the margin should trigger scrolling down.',
      scrollTop < containerDiv.scrollTop);

  scrollTop = containerDiv.scrollTop;
  goog.testing.events.fireMouseMoveEvent(containerDiv,
      new goog.math.Coordinate(50, 20 + 50));
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertEquals('Mousing inside the margin should stop scrolling.',
      scrollTop, containerDiv.scrollTop);

  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);

  assertEquals('Scroll timer should have ticked 5 times',
      5, clock.getTimeoutsMade());

  dsc.dispose();
}


function testDragMarginScrollConstrainedDivContainer() {
  var dsc = new goog.fx.DragScrollSupport(containerDiv, 20);
  dsc.setConstrainScroll(true);

  // Set initial scroll state.
  var scrollTop = 50;
  containerDiv.scrollTop = scrollTop;

  goog.testing.events.fireMouseMoveEvent(containerDiv,
      new goog.math.Coordinate(50, 20 + 50));
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertEquals('Mousing inside the container should not trigger scrolling.',
      scrollTop, containerDiv.scrollTop);
  assertEquals('Scroll timer should not tick yet', 0, clock.getTimeoutsMade());

  scrollTop = containerDiv.scrollTop;
  goog.testing.events.fireMouseMoveEvent(containerDiv,
      new goog.math.Coordinate(50, 30));
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertTrue('Mousing above the margin should trigger scrolling up.',
      scrollTop > containerDiv.scrollTop);
  scrollTop = containerDiv.scrollTop;
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertTrue('Mousing above the margin should trigger scrolling up.',
      scrollTop > containerDiv.scrollTop);

  scrollTop = containerDiv.scrollTop;
  goog.testing.events.fireMouseMoveEvent(containerDiv,
      new goog.math.Coordinate(50, 20 + 90));
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertTrue('Mousing below the margin should trigger scrolling down.',
      scrollTop < containerDiv.scrollTop);
  scrollTop = containerDiv.scrollTop;
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertTrue('Mousing above the margin should trigger scrolling down.',
      scrollTop < containerDiv.scrollTop);

  scrollTop = containerDiv.scrollTop;
  goog.testing.events.fireMouseMoveEvent(containerDiv,
      new goog.math.Coordinate(50, 20 + 50));
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertEquals('Mousing inside the margin should stop scrolling.',
      scrollTop, containerDiv.scrollTop);

  scrollTop = containerDiv.scrollTop;
  goog.testing.events.fireMouseMoveEvent(containerDiv,
      new goog.math.Coordinate(50, 10));
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertEquals('Mousing above the container should not trigger scrolling up.',
      scrollTop, containerDiv.scrollTop);
  scrollTop = containerDiv.scrollTop;
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertEquals('Mousing above the container should not trigger scrolling up.',
      scrollTop, containerDiv.scrollTop);

  scrollTop = containerDiv.scrollTop;
  goog.testing.events.fireMouseMoveEvent(containerDiv,
      new goog.math.Coordinate(50, 20 + 110));
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertEquals('Mousing below the container should not trigger scrolling down.',
      scrollTop, containerDiv.scrollTop);
  scrollTop = containerDiv.scrollTop;
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertEquals('Mousing below the container should not trigger scrolling down.',
      scrollTop, containerDiv.scrollTop);

  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);

  scrollTop = containerDiv.scrollTop;
  goog.testing.events.fireMouseMoveEvent(containerDiv,
      new goog.math.Coordinate(150, 20 + 90));
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertEquals('Mousing to the right of the container should not trigger ' +
      'scrolling up.', scrollTop, containerDiv.scrollTop);
  scrollTop = containerDiv.scrollTop;
  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);
  assertEquals('Mousing to the right of the container should not trigger ' +
      'scrolling up.', scrollTop, containerDiv.scrollTop);

  clock.tick(goog.fx.DragScrollSupport.TIMER_STEP_ + 1);

  assertEquals('Scroll timer should have ticked 5 times',
      5, clock.getTimeoutsMade());

  dsc.dispose();
}

">3 of 3 tests run in 10ms.<br />0 passed, 3 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testDragMarginDivContainer<br />Cannot read property 'defaultView' of undefined<br />ERROR in testDragMarginScrollConstrainedDivContainer<br />Cannot read property 'defaultView' of undefined<br />ERROR in testDragZeroMarginDivContainer<br />Cannot read property 'defaultView' of undefined<br /></td></tr>
<tr><td>dragdropgroup_test.html</td><td>Fail</td><td> 0 passed, 7 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.events');
  goog.require('goog.fx.DragDropGroup');
  goog.require('goog.testing.jsunit');


var s1 = document.getElementById('s1');
var s2 = document.getElementById('s2');
var t1 = document.getElementById('t1');
var t2 = document.getElementById('t2');

var source = null;
var target = null;


function setUp() {
  source = new goog.fx.DragDropGroup();
  source.setSourceClass('ss');
  source.setTargetClass('st');

  target = new goog.fx.DragDropGroup();
  target.setSourceClass('ts');
  target.setTargetClass('tt');

  source.addTarget(target);
}


function tearDown() {
  source.removeItems();
  target.removeItems();
}


function addElementsToGroups() {
  source.addItem(s1);
  source.addItem(s2);
  target.addItem(t1);
  target.addItem(t2);
}


function testAddItemsBeforeInit() {
  addElementsToGroups();
  source.init();
  target.init();

  assertEquals(2, source.items_.length);
  assertEquals(2, target.items_.length);

  assertEquals('s ss', s1.className);
  assertEquals('s ss', s2.className);
  assertEquals('t tt', t1.className);
  assertEquals('t tt', t2.className);

  assertTrue(goog.events.hasListener(s1));
  assertTrue(goog.events.hasListener(s2));
  assertFalse(goog.events.hasListener(t1));
  assertFalse(goog.events.hasListener(t2));
}

function testAddItemsAfterInit() {
  source.init();
  target.init();
  addElementsToGroups();

  assertEquals(2, source.items_.length);
  assertEquals(2, target.items_.length);

  assertEquals('s ss', s1.className);
  assertEquals('s ss', s2.className);
  assertEquals('t tt', t1.className);
  assertEquals('t tt', t2.className);

  assertTrue(goog.events.hasListener(s1));
  assertTrue(goog.events.hasListener(s2));
  assertFalse(goog.events.hasListener(t1));
  assertFalse(goog.events.hasListener(t2));
}


function testRemoveItems() {
  source.init();
  target.init();
  addElementsToGroups();

  assertEquals(2, source.items_.length);
  assertEquals(s1, source.items_[0].element);
  assertEquals(s2, source.items_[1].element);

  assertEquals('s ss', s1.className);
  assertEquals('s ss', s2.className);
  assertTrue(goog.events.hasListener(s1));
  assertTrue(goog.events.hasListener(s2));

  source.removeItems();

  assertEquals(0, source.items_.length);

  assertEquals('s', s1.className);
  assertEquals('s', s2.className);
  assertFalse(goog.events.hasListener(s1));
  assertFalse(goog.events.hasListener(s2));
}

function testRemoveSourceItem1() {
  source.init();
  target.init();
  addElementsToGroups();

  assertEquals(2, source.items_.length);
  assertEquals(s1, source.items_[0].element);
  assertEquals(s2, source.items_[1].element);

  assertEquals('s ss', s1.className);
  assertEquals('s ss', s2.className);
  assertTrue(goog.events.hasListener(s1));
  assertTrue(goog.events.hasListener(s2));

  source.removeItem(s1);

  assertEquals(1, source.items_.length);
  assertEquals(s2, source.items_[0].element);

  assertEquals('s', s1.className);
  assertEquals('s ss', s2.className);
  assertFalse(goog.events.hasListener(s1));
  assertTrue(goog.events.hasListener(s2));
}


function testRemoveSourceItem2() {
  source.init();
  target.init();
  addElementsToGroups();

  assertEquals(2, source.items_.length);
  assertEquals(s1, source.items_[0].element);
  assertEquals(s2, source.items_[1].element);

  assertEquals('s ss', s1.className);
  assertEquals('s ss', s2.className);
  assertTrue(goog.events.hasListener(s1));
  assertTrue(goog.events.hasListener(s2));

  source.removeItem(s2);

  assertEquals(1, source.items_.length);
  assertEquals(s1, source.items_[0].element);

  assertEquals('s ss', s1.className);
  assertEquals('s', s2.className);
  assertTrue(goog.events.hasListener(s1));
  assertFalse(goog.events.hasListener(s2));
}


function testRemoveTargetItem1() {
  source.init();
  target.init();
  addElementsToGroups();

  assertEquals(2, target.items_.length);
  assertEquals(t1, target.items_[0].element);
  assertEquals(t2, target.items_[1].element);

  assertEquals('t tt', t1.className);
  assertEquals('t tt', t2.className);
  assertFalse(goog.events.hasListener(t1));
  assertFalse(goog.events.hasListener(t2));

  target.removeItem(t1);

  assertEquals(1, target.items_.length);
  assertEquals(t2, target.items_[0].element);

  assertEquals('t', t1.className);
  assertEquals('t tt', t2.className);
  assertFalse(goog.events.hasListener(t1));
  assertFalse(goog.events.hasListener(t2));
}


function testRemoveTargetItem2() {
  source.init();
  target.init();
  addElementsToGroups();

  assertEquals(2, target.items_.length);
  assertEquals(t1, target.items_[0].element);
  assertEquals(t2, target.items_[1].element);

  assertEquals('t tt', t1.className);
  assertEquals('t tt', t2.className);
  assertFalse(goog.events.hasListener(t1));
  assertFalse(goog.events.hasListener(t2));

  target.removeItem(t2);

  assertEquals(1, target.items_.length);
  assertEquals(t1, target.items_[0].element);

  assertEquals('t tt', t1.className);
  assertEquals('t', t2.className);
  assertFalse(goog.events.hasListener(t1));
  assertFalse(goog.events.hasListener(t2));
}

">7 of 7 tests run in 10ms.<br />0 passed, 7 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testAddItemsAfterInit<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testAddItemsBeforeInit<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testRemoveItems<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testRemoveSourceItem1<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testRemoveSourceItem2<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testRemoveTargetItem1<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testRemoveTargetItem2<br />Object #<Object> has no method 'attachEvent'<br /></td></tr>
<tr><td>draglistgroup_test.html</td><td>Fail</td><td> 0 passed, 7 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.fx.DragListGroup');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.StrictMock');


  var $ = goog.dom.getElement;
  var classes = goog.dom.classes;
  /** @type {goog.fx.DragListGroup} */
  var dlg;
  /** @type {goog.dom.Element} */
  var list;
  /** @type {goog.events.BrowserEvent} */
  var event;

  function setUp() {
    var sandbox = $('sandbox');
    list = goog.dom.createDom('div', {'id':'horiz_div'});
    list.appendChild(
        goog.dom.createDom('div', null, goog.dom.createTextNode('1')));
    list.appendChild(
        goog.dom.createDom('div', null, goog.dom.createTextNode('2')));
    list.appendChild(
        goog.dom.createDom('div', null, goog.dom.createTextNode('3')));
    sandbox.appendChild(list);

    dlg = new goog.fx.DragListGroup();
    dlg.setDragItemHoverClass('opacity_40', 'cursor_move');
    dlg.setDragItemHandleHoverClass('opacity_40', 'cursor_pointer');
    dlg.setCurrDragItemClass('blue_bg', 'opacity_40');
    dlg.setDraggerElClass('cursor_move', 'blue_bg');
    dlg.addDragList(list, goog.fx.DragListDirection.RIGHT);
    dlg.init();

    event = new goog.events.BrowserEvent();
    event.currentTarget = list.getElementsByTagName('div')[0];
  }

  function tearDown() {
    dlg.dispose();
    $('sandbox').innerHTML = '';
    goog.events.removeAll();
  }

  /**
   * Test the initial assumptions.
   *
   * Verify that the setter methods work properly, i.e., the CSS classes are
   * stored in the private arrays after init() but are not added yet to target.
   * (Since initially, we are not yet hovering over any list, in particular,
   * over this target.)
   */
  function testSettersAfterInit() {
    assertTrue(goog.array.equals(dlg.dragItemHoverClasses_,
        ['opacity_40', 'cursor_move']));
    assertTrue(goog.array.equals(dlg.dragItemHandleHoverClasses_,
        ['opacity_40', 'cursor_pointer']));
    assertTrue(goog.array.equals(dlg.currDragItemClasses_,
        ['blue_bg', 'opacity_40']));

    assertFalse('Should have no cursor_move class after init',
        classes.has(event.currentTarget, 'cursor_move'));
    assertFalse('Should have no cursor_pointer class after init',
        classes.has(event.currentTarget, 'cursor_pointer'));
    assertFalse('Should have no opacity_40 class after init',
        classes.has(event.currentTarget, 'opacity_40'));
    assertFalse('Should not have blue_bg class after init',
        classes.has(event.currentTarget, 'blue_bg'));
  }

  /**
   * Test the effect of hovering over a list.
   *
   * Check that after the MOUSEOVER browser event these classes are added to
   * the current target of the event.
   */
  function testAddDragItemHoverClasses() {
    dlg.handleDragItemMouseover_(event);

    assertTrue('Should have cursor_move class after MOUSEOVER',
        classes.has(event.currentTarget, 'cursor_move'));
    assertTrue('Should have opacity_40 class after MOUSEOVER',
        classes.has(event.currentTarget, 'opacity_40'));
    assertFalse('Should not have cursor_pointer class after MOUSEOVER',
        classes.has(event.currentTarget, 'cursor_pointer'));
    assertFalse('Should not have blue_bg class after MOUSEOVER',
        classes.has(event.currentTarget, 'blue_bg'));
  }

  function testAddDragItemHandleHoverClasses() {
    dlg.handleDragItemHandleMouseover_(event);

    assertFalse('Should not have cursor_move class after MOUSEOVER',
        classes.has(event.currentTarget, 'cursor_move'));
    assertTrue('Should have opacity_40 class after MOUSEOVER',
        classes.has(event.currentTarget, 'opacity_40'));
    assertTrue('Should have cursor_pointer class after MOUSEOVER',
        classes.has(event.currentTarget, 'cursor_pointer'));
    assertFalse('Should not have blue_bg class after MOUSEOVER',
        classes.has(event.currentTarget, 'blue_bg'));
  }

  /**
   * Test the effect of stopping hovering over a list.
   *
   * Check that after the MOUSEOUT browser event all CSS classes are removed
   * from the target (as we are no longer hovering over the it).
   */
  function testRemoveDragItemHoverClasses() {
    dlg.handleDragItemMouseover_(event);
    dlg.handleDragItemMouseout_(event);

    assertFalse('Should have no cursor_move class after MOUSEOUT',
        classes.has(event.currentTarget, 'cursor_move'));
    assertFalse('Should have no cursor_pointer class after MOUSEOUT',
        classes.has(event.currentTarget, 'cursor_pointer'));
    assertFalse('Should have no opacity_40 class after MOUSEOUT',
        classes.has(event.currentTarget, 'opacity_40'));
    assertFalse('Should have no blue_bg class after MOUSEOUT',
        classes.has(event.currentTarget, 'blue_bg'));
  }

  function testRemoveDragItemHandleHoverClasses() {
    dlg.handleDragItemHandleMouseover_(event);
    dlg.handleDragItemHandleMouseout_(event);

    assertFalse('Should have no cursor_move class after MOUSEOUT',
        classes.has(event.currentTarget, 'cursor_move'));
    assertFalse('Should have no cursor_pointer class after MOUSEOUT',
        classes.has(event.currentTarget, 'cursor_pointer'));
    assertFalse('Should have no opacity_40 class after MOUSEOUT',
        classes.has(event.currentTarget, 'opacity_40'));
    assertFalse('Should have no blue_bg class after MOUSEOUT',
        classes.has(event.currentTarget, 'blue_bg'));
  }

  /**
   * Test the effect of dragging an item. (DRAGSTART event.)
   *
   * Check that after the MOUSEDOWN browser event is handled by the
   * handleDragStart_() method the currDragItem has the CSS classes set by
   * the setter method.
   */
  function testAddCurrentDragItemClasses() {
    var be = new goog.testing.StrictMock(goog.events.BrowserEvent);
    be.type = goog.events.EventType.MOUSEDOWN;
    event.event_ = be;

    dlg.handleDragStart_(event);

    assertFalse('Should have no cursor_move class after MOUSEDOWN',
        classes.has(dlg.currDragItem_, 'cursor_move'));
    assertFalse('Should have no cursor_pointer class after MOUSEDOWN',
        classes.has(dlg.currDragItem_, 'cursor_pointer'));
    assertTrue('Should have opacity_40 class after MOUSEDOWN',
        classes.has(dlg.currDragItem_, 'opacity_40'));
    assertTrue('Should have blue_bg class after MOUSEDOWN',
        classes.has(dlg.currDragItem_, 'blue_bg'));
   }

  /**
   * Test the effect of dragging an item. (DRAGEND event.)
   *
   * Check that after the MOUSEUP browser event handled by the handleDragEnd_()
   * method the currDragItem has no CSS classes set in the dispatched event.
   */
  function testRemoveCurrentDragItemClasses() {
    var be = new goog.testing.StrictMock(goog.events.BrowserEvent);
    be.type = goog.events.EventType.MOUSEDOWN;
    event.event_ = be;
    dlg.handleDragStart_(event);

    // Need to catch the dispatched event because the temporary fields
    // including dlg.currentDragItem_ are cleared after the dragging has ended.
    var currDragItem = goog.dom.createDom(
        'div', ['cursor_move','blue_bg'], goog.dom.createTextNode('4'));
    goog.events.listen(dlg, goog.fx.DragListGroup.EventType.DRAGEND,
        function(e) {currDragItem = dlg.currDragItem_;});

    var dragger = new goog.fx.Dragger(event.currentTarget);
    be.type = goog.events.EventType.MOUSEUP;
    be.clientX = 1;
    be.clientY = 2;
    var dragEvent = new goog.fx.DragEvent(
        goog.fx.Dragger.EventType.END, dragger, be.clientX, be.clientY, be);
    dlg.handleDragEnd_(dragEvent); // this method dispatches the DRAGEND event

    assertFalse('Should have no cursor_move class after MOUSEUP',
        classes.has(currDragItem, 'cursor_move'));
    assertFalse('Should have no cursor_pointer class after MOUSEUP',
        classes.has(currDragItem, 'cursor_pointer'));
    assertFalse('Should have no opacity_40 class after MOUSEUP',
        classes.has(currDragItem, 'opacity_40'));
    assertFalse('Should have no blue_bg class after MOUSEUP',
        classes.has(currDragItem, 'blue_bg'));
   }
">7 of 7 tests run in 11ms.<br />0 passed, 7 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testAddCurrentDragItemClasses<br />Object #<Object> has no method 'createElement'<br />ERROR in testAddDragItemHandleHoverClasses<br />Object #<Object> has no method 'createElement'<br />ERROR in testAddDragItemHoverClasses<br />Object #<Object> has no method 'createElement'<br />ERROR in testRemoveCurrentDragItemClasses<br />Object #<Object> has no method 'createElement'<br />ERROR in testRemoveDragItemHandleHoverClasses<br />Object #<Object> has no method 'createElement'<br />ERROR in testRemoveDragItemHoverClasses<br />Object #<Object> has no method 'createElement'<br />ERROR in testSettersAfterInit<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>abstractdragdrop_test.html</td><td>Success</td><td> 8 passed, 0 failed.</td><td title="

  goog.require('goog.fx.AbstractDragDrop');
  goog.require('goog.math.Box');
  goog.require('goog.testing.jsunit');



var targets = [
  { box_: new goog.math.Box(0, 3,  1, 1) },
  { box_: new goog.math.Box(0, 7,  2, 6) },
  { box_: new goog.math.Box(2, 2,  3, 1) },
  { box_: new goog.math.Box(4, 1,  6, 1) },
  { box_: new goog.math.Box(4, 9,  7, 6) },
  { box_: new goog.math.Box(9, 9, 10, 1) }
];

var targets2 = [
  { box_: new goog.math.Box(10, 50,  20, 10) },
  { box_: new goog.math.Box(20, 50,  30, 10) },
  { box_: new goog.math.Box(60, 50,  70, 10) },
  { box_: new goog.math.Box(70, 50,  80, 10) }
];

var targets3 = [
  { box_: new goog.math.Box(0, 4,  1, 1) },
  { box_: new goog.math.Box(1, 6,  4, 5) },
  { box_: new goog.math.Box(5, 5,  6, 2) },
  { box_: new goog.math.Box(2, 1,  5, 0) }
];


/**
 * Test the utility function which tells how two one dimensional ranges
 * overlap.
 */
function testRangeOverlap() {
  assertEquals(RangeOverlap.LEFT, rangeOverlap(1, 2, 3, 4));
  assertEquals(RangeOverlap.LEFT, rangeOverlap(2, 3, 3, 4));
  assertEquals(RangeOverlap.LEFT_IN, rangeOverlap(1, 3, 2, 4));
  assertEquals(RangeOverlap.IN, rangeOverlap(1, 3, 1, 4));
  assertEquals(RangeOverlap.IN, rangeOverlap(2, 3, 1, 4));
  assertEquals(RangeOverlap.IN, rangeOverlap(3, 4, 1, 4));
  assertEquals(RangeOverlap.RIGHT_IN, rangeOverlap(2, 4, 1, 3));
  assertEquals(RangeOverlap.RIGHT, rangeOverlap(2, 3, 1, 2));
  assertEquals(RangeOverlap.RIGHT, rangeOverlap(3, 4, 1, 2));
  assertEquals(RangeOverlap.CONTAINS, rangeOverlap(1, 4, 2, 3));
}


/**
 * An enum describing how two ranges overlap (non-symmetrical relation).
 * @enum {number}
 */
RangeOverlap = {
  LEFT: 1,      // First range is placed to the left of the second.
  LEFT_IN: 2,   // First range overlaps on the left side of the second.
  IN: 3,        // First range is completely contained in the second.
  RIGHT_IN: 4,  // First range overlaps on the right side of the second.
  RIGHT: 5,     // First range is placed to the right side of the second.
  CONTAINS: 6   // First range contains the second.
};


/**
 * Computes how two one dimentional ranges overlap.
 *
 * @param {number} left1 Left inclusive bound of the first range.
 * @param {number} right1 Right exclusive bound of the first range.
 * @param {number} left2 Left inclusive bound of the second range.
 * @param {number} right2 Right exclusive bound of the second range.
 * @return {RangeOverlap} The enum value describing the type of the overlap.
 */
function rangeOverlap(left1, right1, left2, right2) {
  if (right1 <= left2) return RangeOverlap.LEFT;
  if (left1 >= right2) return RangeOverlap.RIGHT;
  var leftIn = left1 >= left2;
  var rightIn = right1 <= right2;
  if (leftIn && rightIn) return RangeOverlap.IN;
  if (leftIn) return RangeOverlap.RIGHT_IN;
  if (rightIn) return RangeOverlap.LEFT_IN;
  return RangeOverlap.CONTAINS;
}


/**
 * Tells whether two boxes overlap.
 *
 * @param {goog.math.Box} box1 First box in question.
 * @param {goog.math.Box} box2 Second box in question.
 * @return {boolean} Whether boxes overlap in any way.
 */
function boxOverlaps(box1, box2) {
  var horizontalOverlap = rangeOverlap(
      box1.left, box1.right, box2.left, box2.right);
  var verticalOverlap = rangeOverlap(
      box1.top, box1.bottom, box2.top, box2.bottom);
  return horizontalOverlap != RangeOverlap.LEFT &&
      horizontalOverlap != RangeOverlap.RIGHT &&
      verticalOverlap != RangeOverlap.LEFT &&
      verticalOverlap != RangeOverlap.RIGHT;
}


/**
 * Tests if the utility function to compute box overlapping functions properly.
 */
function testBoxOverlaps() {
  // Overlapping tests.
  var box2 = new goog.math.Box(1, 4, 4, 1);

  // Corner overlaps.
  assertTrue('NW overlap', boxOverlaps(new goog.math.Box(0, 2, 2, 0), box2));
  assertTrue('NE overlap', boxOverlaps(new goog.math.Box(0, 5, 2, 3), box2));
  assertTrue('SE overlap', boxOverlaps(new goog.math.Box(3, 5, 5, 3), box2));
  assertTrue('SW overlap', boxOverlaps(new goog.math.Box(3, 2, 5, 0), box2));

  // Inside.
  assertTrue('Inside overlap',
      boxOverlaps(new goog.math.Box(2, 3, 3, 2), box2));

  // Around.
  assertTrue('Outside overlap',
      boxOverlaps(new goog.math.Box(0, 5, 5, 0), box2));

  // Edge overlaps.
  assertTrue('N overlap', boxOverlaps(new goog.math.Box(0, 3, 2, 2), box2));
  assertTrue('E overlap', boxOverlaps(new goog.math.Box(2, 5, 3, 3), box2));
  assertTrue('S overlap', boxOverlaps(new goog.math.Box(3, 3, 5, 2), box2));
  assertTrue('W overlap', boxOverlaps(new goog.math.Box(2, 2, 3, 0), box2));

  assertTrue('N-in overlap', boxOverlaps(new goog.math.Box(0, 5, 2, 0), box2));
  assertTrue('E-in overlap', boxOverlaps(new goog.math.Box(0, 5, 5, 3), box2));
  assertTrue('S-in overlap', boxOverlaps(new goog.math.Box(3, 5, 5, 0), box2));
  assertTrue('W-in overlap', boxOverlaps(new goog.math.Box(0, 2, 5, 0), box2));

  // Does not overlap.
  var box2 = new goog.math.Box(3, 6, 6, 3);

  // Along the edge - shorter.
  assertFalse('N-in no overlap',
      boxOverlaps(new goog.math.Box(1, 5, 2, 4), box2));
  assertFalse('E-in no overlap',
      boxOverlaps(new goog.math.Box(4, 8, 5, 7), box2));
  assertFalse('S-in no overlap',
      boxOverlaps(new goog.math.Box(7, 5, 8, 4), box2));
  assertFalse('N-in no overlap',
      boxOverlaps(new goog.math.Box(4, 2, 5, 1), box2));

  // By the corner.
  assertFalse('NE no overlap',
      boxOverlaps(new goog.math.Box(1, 8, 2, 7), box2));
  assertFalse('SE no overlap',
      boxOverlaps(new goog.math.Box(7, 8, 8, 7), box2));
  assertFalse('SW no overlap',
      boxOverlaps(new goog.math.Box(7, 2, 8, 1), box2));
  assertFalse('NW no overlap',
      boxOverlaps(new goog.math.Box(1, 2, 2, 1), box2));

  // Perpendicular to an edge.
  assertFalse('NNE no overlap',
      boxOverlaps(new goog.math.Box(1, 7, 2, 5), box2));
  assertFalse('NEE no overlap',
      boxOverlaps(new goog.math.Box(2, 8, 4, 7), box2));
  assertFalse('SEE no overlap',
      boxOverlaps(new goog.math.Box(5, 8, 7, 7), box2));
  assertFalse('SSE no overlap',
      boxOverlaps(new goog.math.Box(7, 7, 8, 5), box2));
  assertFalse('SSW no overlap',
      boxOverlaps(new goog.math.Box(7, 4, 8, 2), box2));
  assertFalse('SWW no overlap',
      boxOverlaps(new goog.math.Box(5, 2, 7, 1), box2));
  assertFalse('NWW no overlap',
      boxOverlaps(new goog.math.Box(2, 2, 4, 1), box2));
  assertFalse('NNW no overlap',
      boxOverlaps(new goog.math.Box(1, 4, 2, 2), box2));

  // Along the edge - longer.
  assertFalse('N no overlap',
      boxOverlaps(new goog.math.Box(0, 7, 1, 2), box2));
  assertFalse('E no overlap',
      boxOverlaps(new goog.math.Box(2, 9, 7, 8), box2));
  assertFalse('S no overlap',
      boxOverlaps(new goog.math.Box(8, 7, 9, 2), box2));
  assertFalse('W no overlap',
      boxOverlaps(new goog.math.Box(2, 1, 7, 0), box2));
}


/**
 * Checks whether a given box overlaps any of given DnD target boxes.
 *
 * @param {goog.math.Box} box The box to check.
 * @param {Array.<Object>} targets The array of targets with boxes to check
 *     if they overlap with the given box.
 * @return {boolean} Whether the box overlaps any of the target boxes.
 */
function boxOverlapsTargets(box, targets) {
  return goog.array.some(targets, function(target) {
    return boxOverlaps(box, target.box_);
  });
}


function testMaybeCreateDummyTargetForPosition() {
  var testGroup = new goog.fx.AbstractDragDrop();
  testGroup.targetList_ = targets;
  testGroup.targetBox_ = new goog.math.Box(0, 9, 10, 1);

  var target = testGroup.maybeCreateDummyTargetForPosition_(3, 3);
  assertFalse(boxOverlapsTargets(target.box_, testGroup.targetList_));
  assertTrue(testGroup.isInside_(3, 3, target.box_));

  target = testGroup.maybeCreateDummyTargetForPosition_(2, 4);
  assertFalse(boxOverlapsTargets(target.box_, testGroup.targetList_));
  assertTrue(testGroup.isInside_(2, 4, target.box_));

  target = testGroup.maybeCreateDummyTargetForPosition_(2, 7);
  assertFalse(boxOverlapsTargets(target.box_, testGroup.targetList_));
  assertTrue(testGroup.isInside_(2, 7, target.box_));

  testGroup.targetList_.push({ box_: new goog.math.Box(5, 6, 6, 0) });

  target = testGroup.maybeCreateDummyTargetForPosition_(3, 3);
  assertFalse(boxOverlapsTargets(target.box_, testGroup.targetList_));
  assertTrue(testGroup.isInside_(3, 3, target.box_));

  target = testGroup.maybeCreateDummyTargetForPosition_(2, 7);
  assertFalse(boxOverlapsTargets(target.box_, testGroup.targetList_));
  assertTrue(testGroup.isInside_(2, 7, target.box_));

  target = testGroup.maybeCreateDummyTargetForPosition_(6, 3);
  assertFalse(boxOverlapsTargets(target.box_, testGroup.targetList_));
  assertTrue(testGroup.isInside_(6, 3, target.box_));

  target = testGroup.maybeCreateDummyTargetForPosition_(0, 3);
  assertNull(target);
  target = testGroup.maybeCreateDummyTargetForPosition_(9, 0);
  assertNull(target);
}


function testMaybeCreateDummyTargetForPosition2() {
  var testGroup = new goog.fx.AbstractDragDrop();
  testGroup.targetList_ = targets2;
  testGroup.targetBox_ = new goog.math.Box(10, 50, 80, 10);

  var target = testGroup.maybeCreateDummyTargetForPosition_(30, 40);
  assertFalse(boxOverlapsTargets(target.box_, testGroup.targetList_));
  assertTrue(testGroup.isInside_(30, 40, target.box_));

  target = testGroup.maybeCreateDummyTargetForPosition_(45, 40);
  assertFalse(boxOverlapsTargets(target.box_, testGroup.targetList_));
  assertTrue(testGroup.isInside_(45, 40, target.box_));

  testGroup.targetList_.push({ box_: new goog.math.Box(40, 50, 50, 40) });

  target = testGroup.maybeCreateDummyTargetForPosition_(30, 40);
  assertFalse(boxOverlapsTargets(target.box_, testGroup.targetList_));
  target = testGroup.maybeCreateDummyTargetForPosition_(45, 35);
  assertFalse(boxOverlapsTargets(target.box_, testGroup.targetList_));
}


function testMaybeCreateDummyTargetForPosition3BoxHasDecentSize() {
  var testGroup = new goog.fx.AbstractDragDrop();
  testGroup.targetList_ = targets3;
  testGroup.targetBox_ = new goog.math.Box(0, 6, 6, 0);

  var target = testGroup.maybeCreateDummyTargetForPosition_(3, 3);
  assertFalse(boxOverlapsTargets(target.box_, testGroup.targetList_));
  assertTrue(testGroup.isInside_(3, 3, target.box_));
  assertEquals('(1t, 5r, 5b, 1l)', target.box_.toString());
}


function testMaybeCreateDummyTargetForPosition4() {
  var testGroup = new goog.fx.AbstractDragDrop();
  testGroup.targetList_ = targets;
  testGroup.targetBox_ = new goog.math.Box(0, 9, 10, 1);

  for (var x = testGroup.targetBox_.left;
       x < testGroup.targetBox_.right;
       x++) {
    for (var y = testGroup.targetBox_.top;
        y < testGroup.targetBox_.bottom;
        y++) {
      var inRealTarget = false;
      for (var i = 0; i < testGroup.targetList_.length; i++) {
        if (testGroup.isInside_(x, y, testGroup.targetList_[i].box_)) {
          inRealTarget = true;
          break;
        }
      }
      if (!inRealTarget) {
        var target = testGroup.maybeCreateDummyTargetForPosition_(x, y);
        if (target) {
          assertFalse('Fake target for point(' + x + ',' + y + ') should ' +
              'not overlap any real targets.',
             boxOverlapsTargets(target.box_, testGroup.targetList_));
          assertTrue(testGroup.isInside_(x, y, target.box_));
        }
      }
    }
  }
}


function testCalculateTargetBox() {
  var testGroup = new goog.fx.AbstractDragDrop();
  testGroup.targetList_ = [];
  goog.array.forEach(targets, function(target) {
    testGroup.targetList_.push(target);
    testGroup.calculateTargetBox_(target.box_);
  });
  assertTrue(goog.math.Box.equals(testGroup.targetBox_,
             new goog.math.Box(0, 9, 10, 1)));

  testGroup = new goog.fx.AbstractDragDrop();
  testGroup.targetList_ = [];
  goog.array.forEach(targets2, function(target) {
    testGroup.targetList_.push(target);
    testGroup.calculateTargetBox_(target.box_);
  });
  assertTrue(goog.math.Box.equals(testGroup.targetBox_,
             new goog.math.Box(10, 50, 80, 10)));

  testGroup = new goog.fx.AbstractDragDrop();
  testGroup.targetList_ = [];
  goog.array.forEach(targets3, function(target) {
    testGroup.targetList_.push(target);
    testGroup.calculateTargetBox_(target.box_);
  });
  assertTrue(goog.math.Box.equals(testGroup.targetBox_,
             new goog.math.Box(0, 6, 6, 0)));
}


function testIsInside() {
  var add = new goog.fx.AbstractDragDrop();
  // The box in question.
  // 10,20+++++20,20
  //   +         |
  // 10,30-----20,30
  var box = new goog.math.Box(20, 20, 30, 10);

  assertTrue('A point somewhere in the middle of the box should be inside.',
      add.isInside_(15, 25, box));

  assertTrue('A point in top-left corner should be inside the box.',
      add.isInside_(10, 20, box));

  assertTrue('A point on top border should be inside the box.',
      add.isInside_(15, 20, box));

  assertFalse('A point in top-right corner should be outside the box.',
      add.isInside_(20, 20, box));

  assertFalse('A point on right border should be outside the box.',
      add.isInside_(20, 25, box));

  assertFalse('A point in bottom-right corner should be outside the box.',
      add.isInside_(20, 30, box));

  assertFalse('A point on bottom border should be outside the box.',
      add.isInside_(15, 30, box));

  assertFalse('A point in bottom-left corner should be outside the box.',
      add.isInside_(10, 30, box));

  assertTrue('A point on left border should be inside the box.',
      add.isInside_(10, 25, box));

  add.dispose();
}


// Helper function for manual debugging.
function drawTargets(targets, multiplier) {
  var colors = ['green', 'blue', 'red', 'lime', 'pink', 'silver', 'orange'];
  var cont = document.getElementById('cont');
  cont.innerHTML = '';
  for (var i = 0; i < targets.length; i++) {
    var box = targets[i].box_;
    var el = document.createElement('div');
    el.style.top = (box.top * multiplier) + 'px';
    el.style.left = (box.left * multiplier) + 'px';
    el.style.width = ((box.right - box.left) * multiplier) + 'px';
    el.style.height = ((box.bottom - box.top) * multiplier) + 'px';
    el.style.backgroundColor = colors[i];
    cont.appendChild(el);
  }
}

">n/a</td></tr>
<tr><td>timezonedetection_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="
  

  goog.require('goog.locale.TimeZoneFingerprint');
  goog.require('goog.locale.timeZoneDetection');
  goog.require('goog.testing.jsunit');
  


  /**
   * Mock date class with simplified properties of Date class for testing.
   * @constructor
   */
  function MockDate() {
    /**
     * Time zone offset. For time zones with daylight saving, the different
     * offsets are represented as array of offsets.
     * @type {Array.<number>}
     * @private
     */
    this.timezoneOffset_ = [];
    /**
     * Counter storing the index of next offset value to be returned from the
     * array of offset values. 
     * @type {number}
     * @private
     */
    this.offsetArrayCounter_ = 0;
  }

  /**
   * Does nothing because setting the time to calculate offset is not needed
   * in the mock class.
   * @param {number} ms Ignored.
   */
  MockDate.prototype.setTime = function(ms) {
    // Do nothing.
  };

  /**
   * Sets the time zone offset.
   * @param {Array.<number>} offset Time zone offset.
   */
  MockDate.prototype.setTimezoneOffset = function(offset) {
    this.timezoneOffset_ = offset;
  };

  /**
   * Returns consecutive offsets from array of time zone offsets on each call.
   * @return {number} Time zone offset.
   */
  MockDate.prototype.getTimezoneOffset = function() {
    return this.timezoneOffset_.length > 1 ?
        this.timezoneOffset_[this.offsetArrayCounter_++] :
        this.timezoneOffset_[0];
  };

  function testGetFingerprint() {
    var mockDate = new MockDate();
    mockDate.setTimezoneOffset([-480]);
    var fingerprint = goog.locale.timeZoneDetection.getFingerprint(mockDate);
    assertEquals(32, fingerprint);

    mockDate = new MockDate();
    mockDate.setTimezoneOffset(
        [480, 420, 420, 480, 480, 420, 420, 420, 420, 420, 420, 420, 420]);
    fingerprint = goog.locale.timeZoneDetection.getFingerprint(mockDate);
    assertEquals(1294772902, fingerprint);
  }

  function testDetectTimeZone() {
    var mockDate = new MockDate();
    mockDate.setTimezoneOffset([-480]);
    var timeZoneId =
        goog.locale.timeZoneDetection.detectTimeZone(undefined, mockDate);
    assertEquals('Asia/Hong_Kong', timeZoneId);

    mockDate = new MockDate();
    mockDate.setTimezoneOffset(
        [480, 420, 420, 480, 480, 420, 420, 420, 420, 420, 420, 420, 420]);
    timeZoneId = goog.locale.timeZoneDetection.detectTimeZone('US', mockDate);
    assertEquals('America/Los_Angeles', timeZoneId);

    mockDate = new MockDate();
    mockDate.setTimezoneOffset(
        [480, 420, 420, 480, 480, 420, 420, 420, 420, 420, 420, 420, 420]);
    timeZoneId = goog.locale.timeZoneDetection.detectTimeZone('CA', mockDate);
    assertEquals('America/Dawson', timeZoneId);
  }

  function testGetTimeZoneList() {
    var mockDate = new MockDate();
    mockDate.setTimezoneOffset(
        [480, 420, 420, 480, 480, 420, 420, 420, 420, 420, 420, 420, 420]);
    var timeZoneList =
         goog.locale.timeZoneDetection.getTimeZoneList(undefined, mockDate);
    assertEquals('America/Los_Angeles', timeZoneList[0]);
    assertEquals('America/Whitehorse', timeZoneList[4]);
    assertEquals(5, timeZoneList.length);

    mockDate = new MockDate();
    mockDate.setTimezoneOffset([-480]);
    timeZoneList =
        goog.locale.timeZoneDetection.getTimeZoneList(undefined, mockDate);
    assertEquals('Asia/Hong_Kong', timeZoneList[0]);
    assertEquals('Asia/Chongqing', timeZoneList[7]);
    assertEquals(16, timeZoneList.length);

    timeZoneList =
        goog.locale.timeZoneDetection.getTimeZoneList('AU', mockDate);
    assertEquals(1, timeZoneList.length);
    assertEquals('Australia/Perth', timeZoneList[0]);
  }

">n/a</td></tr>
<tr><td>timezonelist_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="

    goog.require('goog.locale.TimeZoneList');
    goog.require('goog.locale');
    goog.require('goog.testing.jsunit');
  


  // Test data files are in in http://go/js_locale_data

  // Test data from TimeZoneSelectedIds__FR.js
  var TimeZoneSelectedIds__FR = [
    'Etc/GMT+12',
    'Pacific/Midway',
    'America/Adak',
    'Pacific/Honolulu'
  ];
  goog.locale.registerTimeZoneSelectedIds(TimeZoneSelectedIds__FR, 'FR');

  // Test data from TimeZoneSelectedShortNames__de_DE.js
  var TimeZoneSelectedShortNames__de_DE = {
    'Etc/GMT+12': 'GMT-12:00',
    'Etc/GMT+11': 'GMT-11:00',
    'Pacific/Pago_Pago': 'Amerikanisch-Samoa',
    'Pacific/Midway': 'Midway (Amerikanisch-Ozeanien)',
    'Pacific/Honolulu': 'Honolulu (Vereinigte Staaten)',
    'Etc/GMT+10': 'GMT-10:00',
    'America/Adak': 'Adak (Vereinigte Staaten)'
  };
  goog.locale.registerTimeZoneSelectedShortNames(
      TimeZoneSelectedShortNames__de_DE, 'de_DE');

  // Test data from TimeZoneSelectedLongNames__de_DE.js
  var TimeZoneSelectedLongNames__de_DE = {
    'Etc/GMT+12': 'GMT-12:00',
    'Etc/GMT+11': 'GMT-11:00',
    'Pacific/Pago_Pago': 'GMT-11:00 Amerikanisch-Samoa',
    'Pacific/Midway': 'GMT-11:00 Midway (Amerikanisch-Ozeanien)',
    'Pacific/Honolulu': 'GMT-10:00 Honolulu (Vereinigte Staaten)',
    'Etc/GMT+10': 'GMT-10:00',
    'America/Adak': 'GMT-10:00 Adak (Vereinigte Staaten)'
   };
   goog.locale.registerTimeZoneSelectedLongNames(
       TimeZoneSelectedLongNames__de_DE, 'de_DE');

  // Test data from TimeZoneSelectedIds__en.js
  var TimeZoneSelectedIds__en = [
    'Etc/GMT+12',
    'Pacific/Midway',
    'America/Adak',
    'Pacific/Honolulu',
  ];
  goog.locale.registerTimeZoneSelectedIds(TimeZoneSelectedIds__en, 'en');

  // Test data from TimeZoneSelectedIds__DE.js
  var TimeZoneSelectedIds__DE = [
    'Etc/GMT+12',
    'Pacific/Midway',
    'America/Adak',
    'Pacific/Honolulu',
  ];
  goog.locale.registerTimeZoneSelectedIds(TimeZoneSelectedIds__DE, 'DE');

  // Test data from TimeZoneAllLongNames__de_DE.js
  var TimeZoneAllLongNames__de_DE = [
    {id: 'Etc/GMT+12', name: 'GMT-12:00'},
    {id: 'Pacific/Apia', name: 'GMT-11:00 Samoa'},
    {id: 'Pacific/Midway', name: 'GMT-11:00 Midway (Amerikanisch-Ozeanien)'},
    {id: 'Pacific/Niue', name: 'GMT-11:00 Niue'},
    {id: 'Pacific/Pago_Pago', name: 'GMT-11:00 Amerikanisch-Samoa'},
    {id: 'Etc/GMT+11', name: 'GMT-11:00'},
    {id: 'America/Adak', name: 'GMT-10:00 Adak (Vereinigte Staaten)'},
    {id: 'Pacific/Fakaofo', name: 'GMT-10:00 Tokelau'}
  ];
  goog.locale.registerTimeZoneAllLongNames(TimeZoneAllLongNames__de_DE,
      'de_DE');

  goog.locale.setLocale('de_DE');

  /* Uncomment to display complete listing in the unit tested invocations.

  document.write('Shortnames in German for France:<br>');

  var idlist = goog.locale.getTimeZoneSelectedShortNames('FR');

  for (var i = 0; i < idlist.length; i++) {
    document.write(i + ') ' + idlist[i].id + ' = ' + idlist[i].name + '<br>');
  }

  document.write('<hr>');

  document.write('long names in German for all en speakers:<br>');
  var idlist = goog.locale.getTimeZoneSelectedLongNames('en');

  for (var i = 0; i < idlist.length; i++) {
    document.write(i + ') ' + idlist[i].id + ' = ' + idlist[i].name + '<br>');
  }

  document.write('<hr>');

  document.write('Longnames in German for germans:<br>');
  var idlist = goog.locale.getTimeZoneSelectedLongNames();

  for (var i = 0; i < idlist.length; i++) {
    document.write(i + ') ' + idlist[i].id + ' = ' + idlist[i].name + '<br>');
  }

  document.write('<hr>');

  document.write('All longnames in German:<br>');
  var idlist = goog.locale.getTimeZoneAllLongNames();

  for (var i = 0; i < idlist.length; i++) {
    var pair = idlist[i];
    document.write(i + ') ' + pair.id + ' = ' + pair.name + '<br>');
  }

  document.write('<hr>');
  */

  // Test cases.
  function testTimeZoneSelectedShortNames() {
    // Shortnames in German for France.
    var result = goog.locale.getTimeZoneSelectedShortNames('FR');
    assertEquals('Honolulu (Vereinigte Staaten)', result[3].name);
  }

  function testTimeZoneSelectedLongNames() {
    // Long names in German for all English speaking regions.
    var result = goog.locale.getTimeZoneSelectedLongNames('en');
    assertEquals('GMT-11:00 Midway (Amerikanisch-Ozeanien)', result[1].name);

    // Long names in German for germans.
    var result = goog.locale.getTimeZoneSelectedLongNames();
    assertEquals('GMT-10:00 Adak (Vereinigte Staaten)', result[2].name);
  }

  function testTimeZoneAllLongNames() {
    // All longnames in German
    var result = goog.locale.getTimeZoneAllLongNames();
    assertEquals('GMT-10:00 Tokelau', result[7].name);
  }

">n/a</td></tr>
<tr><td>genericfontnames_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="

  goog.require('goog.locale.genericFontNames');
  goog.require('goog.testing.jsunit');


goog.locale.genericFontNames.data_['zh_TW'] = [
  {
    'caption': '\u5fae\u8edf\u6b63\u9ed1\u9ad4',
    'value': 'Microsoft JhengHei,\u5fae\u8edf\u6b63\u9ed1\u9ad4,SimHei,\u9ed1\u4f53,MS' +
    ' Hei,STHeiti,\u534e\u6587\u9ed1\u4f53,Apple LiGothic Medium,\u860b' +
    '\u679c\u5137\u4e2d\u9ed1,LiHei Pro Medium,\u5137\u9ed1 Pro,STHeiti Ligh' +
    't,\u534e\u6587\u7ec6\u9ed1,AR PL ZenKai Uni,\u6587\u9f0ePL\u4e2d\u6977U' +
    'ni,FreeSans,sans-serif'
  },
  {
    'caption': '\u5fae\u8f6f\u96c5\u9ed1\u5b57\u4f53',
    'value': 'Microsoft YaHei,\u5fae\u8f6f\u96c5\u9ed1\u5b57\u4f53,FreeSans,sans-serif'
  },
  {
    'caption': '\u65b0\u7d30\u660e\u9ad4',
    'value': 'SimSun,\u5b8b\u4f53,MS Song,STSong,\u534e\u6587\u5b8b\u4f53,Apple LiSung' +
    ' Light,\u860b\u679c\u5137\u7d30\u5b8b,LiSong Pro Light,\u5137\u5b8b Pro' +
    ',STFangSong,\u534e\u6587\u4eff\u5b8b,AR PL ShanHeiSun Uni,\u6587\u9f0eP' +
    'L\u7ec6\u4e0a\u6d77\u5b8bUni,AR PL New Sung,\u6587\u9f0e PL \u65b0' +
    '\u5b8b,FreeSerif,serif'
  },
  {
    'caption': '\u7d30\u660e\u9ad4',
    'value': 'NSimsun,\u65b0\u5b8b\u4f53,FreeMono,monospace'
  }
];

function testNormalize() {
  var result = goog.locale.genericFontNames.normalize_('zh');
  assertEquals('zh', result);
  var result = goog.locale.genericFontNames.normalize_('zh-hant');
  assertEquals('zh_Hant', result);
  var result = goog.locale.genericFontNames.normalize_('zh-hant-tw');
  assertEquals('zh_Hant_TW', result);
}

function testInvalid() {
  var result = goog.locale.genericFontNames.getList('invalid');
  assertArrayEquals([], result);
}

function testZhHant() {
  var result = goog.locale.genericFontNames.getList('zh-tw');
  assertObjectEquals([
      {
        'caption': '\u5fae\u8edf\u6b63\u9ed1\u9ad4',
        'value': 'Microsoft JhengHei,\u5fae\u8edf\u6b63\u9ed1\u9ad4,SimHei,\u9ed1\u4f53,MS' +
        ' Hei,STHeiti,\u534e\u6587\u9ed1\u4f53,Apple LiGothic Medium,\u860b' +
        '\u679c\u5137\u4e2d\u9ed1,LiHei Pro Medium,\u5137\u9ed1 Pro,STHeiti Ligh' +
        't,\u534e\u6587\u7ec6\u9ed1,AR PL ZenKai Uni,\u6587\u9f0ePL\u4e2d\u6977U' +
        'ni,FreeSans,sans-serif'
      },
      {
        'caption': '\u5fae\u8f6f\u96c5\u9ed1\u5b57\u4f53',
        'value': 'Microsoft YaHei,\u5fae\u8f6f\u96c5\u9ed1\u5b57\u4f53,FreeSans,sans-serif'
      },
      {
        'caption': '\u65b0\u7d30\u660e\u9ad4',
        'value': 'SimSun,\u5b8b\u4f53,MS Song,STSong,\u534e\u6587\u5b8b\u4f53,Apple LiSung' +
        ' Light,\u860b\u679c\u5137\u7d30\u5b8b,LiSong Pro Light,\u5137\u5b8b Pro' +
        ',STFangSong,\u534e\u6587\u4eff\u5b8b,AR PL ShanHeiSun Uni,\u6587\u9f0eP' +
        'L\u7ec6\u4e0a\u6d77\u5b8bUni,AR PL New Sung,\u6587\u9f0e PL \u65b0' +
        '\u5b8b,FreeSerif,serif'
      },
      {
        'caption': '\u7d30\u660e\u9ad4',
        'value': 'NSimsun,\u65b0\u5b8b\u4f53,FreeMono,monospace'
      }],
      result);
}
">n/a</td></tr>
<tr><td>countrylanguagenames_test.html</td><td>Success</td><td> 9 passed, 0 failed.</td><td title="

  goog.require('goog.locale');
  goog.require('goog.locale.nativeNameConstants');
  goog.require('goog.testing.jsunit');



// Test data from //googledata/i18n/js_locale_data/LocaleNameConstants__de.js
var LocaleNameConstants_de = {
  LANGUAGE: {
    'cad': 'Caddo',
    'fr': 'Franz\u00f6sisch',
    'fr_CA': 'Canadian French',
    'fr_CH': 'Swiss French',    'zh': 'Chinesisch',
    'zh_Hans': 'Chinesisch (vereinfacht)',
    'zh_Hant': 'Chinesisch (traditionell)'
  },
  COUNTRY: {
    'CN': 'China',
    'ES': 'Spanien',
    'FR': 'Frankreich'
  }
};
registerLocalNameConstants(LocaleNameConstants_de, 'de');

// Test data from //googledata/i18n/js_locale_data/LocaleNameConstants__en.js
var LocaleNameConstants_en = {
  LANGUAGE: {
    'cad': 'Caddo',
    'fr': 'French',
    'fr_CA': 'Canadian French',
    'fr_CH': 'Swiss French',
    'zh': 'Chinese',
    'zh_Hans': 'Simplified Chinese',
    'zh_Hant': 'Traditional Chinese'
  },
  COUNTRY: {
    'CN': 'China',
    'ES': 'Spain',
    'FR': 'France'
  }
};
registerLocalNameConstants(LocaleNameConstants_en, 'en');

goog.locale.setLocale('de');

function testLoadLoacleSymbols() {
  var result = goog.locale.getLocalizedCountryName('fr-FR');
  assertEquals('Frankreich', result);
}

function testGetNativeCountryName() {
  var result = goog.locale.getNativeCountryName('de-DE');
  assertEquals('Deutschland', result);

  result = goog.locale.getNativeCountryName('de_DE');
  assertEquals('Deutschland', result);

  result = goog.locale.getNativeCountryName('und');
  assertEquals('und', result);

  result = goog.locale.getNativeCountryName('de-CH');
  assertEquals('Schweiz', result);

  result = goog.locale.getNativeCountryName('fr-CH');
  assertEquals('Suisse', result);

  result = goog.locale.getNativeCountryName('it-CH');
  assertEquals('Svizzera', result);
}

function testGetLocalizedCountryName() {
  var result = goog.locale.getLocalizedCountryName('es-ES');
  assertEquals('Spanien', result);

  result = goog.locale.getLocalizedCountryName('es-ES', LocaleNameConstants_en);
  assertEquals('Spain', result);

  result = goog.locale.getLocalizedCountryName('zh-CN-cmn');
  assertEquals('China', result);

  result = goog.locale.getLocalizedCountryName('zh_CN_cmn');
  assertEquals('China', result);

  // 'und' is a non-existing locale, default behavior is to
  // return the locale name itself if no mapping is found.
  result = goog.locale.getLocalizedCountryName('und');
  assertEquals('und', result);
}

function testGetNativeLanguageName() {
  var result = goog.locale.getNativeLanguageName('fr');
  assertEquals('fran\u00E7ais', result);

  result = goog.locale.getNativeLanguageName('fr-latn-FR');
  assertEquals('fran\u00E7ais', result);

  result = goog.locale.getNativeLanguageName('fr_FR');
  assertEquals('fran\u00E7ais', result);

  result = goog.locale.getNativeLanguageName('error');
  assertEquals('error', result);
}

function testGetLocalizedLanguageName() {
  var result = goog.locale.getLocalizedLanguageName('fr');
  assertEquals('Franz\u00F6sisch', result);

  result = goog.locale.getLocalizedLanguageName('fr',
                 LocaleNameConstants_en);
  assertEquals('French', result);

  result = goog.locale.getLocalizedLanguageName('fr-latn-FR');
  assertEquals('Franz\u00F6sisch', result);

  result = goog.locale.getLocalizedLanguageName('fr_FR');
  assertEquals('Franz\u00F6sisch', result);

  result = goog.locale.getLocalizedLanguageName('cad');
  assertEquals('Caddo', result);

  result = goog.locale.getLocalizedLanguageName('error');
  assertEquals('error', result);
}


function testGetLocalizedLanguageNameForGivenSymbolset() {
  var result = goog.locale.getLocalizedCountryName('fr-FR');
  assertEquals('Frankreich', result);

  result = goog.locale.getLocalizedCountryName(
      'fr-FR',
      LocaleNameConstants_en);
  assertEquals('France', result);

  result = goog.locale.getLocalizedCountryName('fr-FR');
  assertEquals('Frankreich', result);
}

/**
 * Valid combination of sub tags:
 *  1)  LanguageSubtag'-'RegionSubtag
 *  2)  LanguageSubtag'-'ScriptSubtag'-'RegionSubtag
 *  3)  LanguageSubtag'-'RegionSubtag'-'VariantSubtag
 *  4)  LanguageSubtag'-'ScriptSubTag'-'RegionSubtag'-'VariantSubtag
 */

function testGetRegionSubTag() {

  var result = goog.locale.getRegionSubTag('de-CH');
  assertEquals('CH',result);

  result = goog.locale.getRegionSubTag('de-latn-CH');
  assertEquals('CH',result);

  result = goog.locale.getRegionSubTag('de_latn_CH');
  assertEquals('CH',result);

  result = goog.locale.getRegionSubTag('de-CH-xxx');
  assertEquals('CH',result);

  result = goog.locale.getRegionSubTag('de-latn-CH-xxx');
  assertEquals('CH',result);

  result = goog.locale.getRegionSubTag('es-latn-419-xxx');
  assertEquals('419',result);

  result = goog.locale.getRegionSubTag('es_latn_419_xxx');
  assertEquals('419',result);

  // No region sub tag present
  result = goog.locale.getRegionSubTag('de');
  assertEquals('',result);
}

function testGetLanguageSubTag() {

  var result = goog.locale.getLanguageSubTag('de');
  assertEquals('de', result);

  result = goog.locale.getLanguageSubTag('de-DE');
  assertEquals('de', result);

  result = goog.locale.getLanguageSubTag('de-latn-DE-xxx');
  assertEquals('de', result);

  result = goog.locale.getLanguageSubTag('nds');
  assertEquals('nds', result);

  result = goog.locale.getLanguageSubTag('nds-DE');
  assertEquals('nds', result);
}

function testGetScriptSubTag() {

  var result = goog.locale.getScriptSubTag('fr');
  assertEquals('', result);

  result = goog.locale.getScriptSubTag('fr-Latn');
  assertEquals('Latn', result);

  result = goog.locale.getScriptSubTag('fr-Arab-AA');
  assertEquals('Arab', result);

  result = goog.locale.getScriptSubTag('de-Latin-DE');
  assertEquals('', result);

  result = goog.locale.getScriptSubTag('srn-Ar-DE');
  assertEquals('', result);
}

">n/a</td></tr>
<tr><td>basestore_test.html</td><td>Success</td><td> 4 passed, 0 failed.</td><td title="

  goog.require('goog.gears.BaseStore');
  goog.require('goog.gears.Database');
  goog.require('goog.testing.jsunit');



function isGearsAllowed() {
  return goog.gears.hasFactory() && goog.gears.getFactory().hasPermission;
}

var database;
var baseStore;

function setUpPage() {
  if (isGearsAllowed()) {
    // Remove table if already there
    try {
      database = new goog.gears.Database(
          'tester', 'basestore-common-test', '');
      database.execute('DROP TABLE IF EXISTS StoreVersionInfo');
    } catch (ex) {
      debug('Could not create the database');
    }
  }
  setUpPageStatus = 'complete';
}

function setUp() {
  if (isGearsAllowed()) {
    baseStore = new goog.gears.BaseStore(database);
    baseStore.removeStore();
    baseStore.ensureStoreExists();
  }
}

function tearDown() {
  if (baseStore) {
    baseStore.removeStore();
  }
}

function testStoreVersion() {
  if (!isGearsAllowed()) {
    return;
  }
  assertEquals(
     'Bad initial store version', 1, baseStore.getStoreVersion());

  baseStore.setStoreVersion_(2);

  var version = baseStore.getStoreVersion();
  assertEquals('Bad store version', 2, version);

  baseStore.setStoreVersion_(3);

  version = baseStore.getStoreVersion();
  assertEquals('Bad store version', 3, version);
  baseStore.removeStoreVersion();
  version = baseStore.getStoreVersion();
  assertEquals('Bad removed store version', 0, version);
}

function testUpdateStore() {
  if (!isGearsAllowed()) {
    return;
  }
  var additionalTable = {
      type:  goog.gears.BaseStore.SchemaType.TABLE,
      name: 'GoogleIsCool',
      columns: [
        'OhYesItIs TEXT NOT NULL PRIMARY KEY'
      ]};

  // We need to append this table to the schema, so that it is cleaned up during
  // the tear down.
  baseStore.schema.push(additionalTable);

  baseStore.updateStore = function(version) {
    this.createSchema([additionalTable], true);
  };
  baseStore.version = 2;
  baseStore.ensureStoreExists();
  assertEquals('Bad store version', 2, baseStore.getStoreVersion());
  assertTrue('No test table', baseStore.hasTable('GoogleIsCool'));
}

function testSchema() {
  if (!isGearsAllowed()) {
    return;
  }
  var schema = [
    {type: goog.gears.BaseStore.SchemaType.TABLE,
     name: "Things",
     columns: [
      "ThingId INTEGER PRIMARY KEY AUTOINCREMENT",
      "Name TEXT NOT NULL",
      "Description TEXT",
      "Value INTEGER DEFAULT 42",
      "Year INTEGER"]},
    {type: goog.gears.BaseStore.SchemaType.INDEX,
     name: "ThingsNameIndex",
     isUnique: true,
     tableName: "Things",
     columns: ["Name"]},
    {type: goog.gears.BaseStore.SchemaType.INDEX,
     name: "ThingsYearIndex",
     isUnique: false,
     tableName: "Things",
     columns: ["Year DESC"]},
    {type: goog.gears.BaseStore.SchemaType.VIRTUAL_TABLE,
     name: "Virt",
     columns: [
      "Foo",
      "Bar"]}
  ];

  baseStore.dropSchema(schema);
  assertFalse('Things table still exists', baseStore.hasTable('Things'));
  assertFalse('Virt table still exists', baseStore.hasTable('Virt'));
  assertFalse('ThingsNameIndex index still exists',
              baseStore.hasIndex('ThingsNameIndex'));
  assertFalse('ThingsYearIndex index still exists',
               baseStore.hasIndex('ThingsYearIndex'));
  baseStore.createSchema(schema);
  assertTrue('Missing Things table', baseStore.hasTable('Things'));
  assertTrue('Missing Virt table', baseStore.hasTable('Virt'));
  assertTrue('Missing ThingsNameIndex index',
             baseStore.hasIndex('ThingsNameIndex'));
  assertTrue('Missing ThingsYearIndex index',
             baseStore.hasIndex('ThingsYearIndex'));

  database.execute('INSERT INTO Things (Name, Description, Year) ' +
                   'VALUES (?, ?, ?)',
                   'George Washington',
                   '1st President',
                   1792);

  var obj = database.queryObject('SELECT * FROM Things');
  assertNotNull('Could not retrieve record', obj);
  assertEquals('Incorrect auto id', 1, obj['ThingId']);
  assertEquals('Incorrect name', 'George Washington', obj['Name']);
  assertEquals('Incorrect description', '1st President', obj['Description']);
  assertEquals('Incorrect default value', 42, obj['Value']);
  assertEquals('Incorrect default year', 1792, obj['Year']);

  var insertFailed = false;
  try {
    // this should fail.
    database.execute('INSERT INTO Things (Name, Description, Year) ' +
                     'VALUES (?, ?, ?)',
                     'George Washington',
                     '1st President',
                     1792);
  } catch (e) {
    insertFailed = true;
  }

  assertTrue('Insertion of duplicated record did not fail', insertFailed);

  database.execute('INSERT INTO Virt (Foo, Bar) ' +
                   'VALUES (?, ?)',
                   'alpha',
                   'beta');

  obj = database.queryObject('SELECT Foo, Bar FROM Virt');
  assertNotNull('Could not retrieve record', obj);
  assertEquals('Incorrect Foo', 'alpha', obj['Foo']);
  assertEquals('Incorrect Bar', 'beta', obj['Bar']);

  baseStore.dropSchema(schema);
  assertFalse('Things table still exists', baseStore.hasTable('Things'));
  assertFalse('Virt table still exists', baseStore.hasTable('Virt'));
  assertFalse('ThingsNameIndex index still exists',
              baseStore.hasIndex('ThingsNameIndex'));
  assertFalse('ThingsYearIndex index still exists',
              baseStore.hasIndex('ThingsYearIndex'));

}

function testCreateTriggers() {
  if (!isGearsAllowed()) {
    return;
  }
  var oldSchema = [
    {type: goog.gears.BaseStore.SchemaType.TABLE,
     name: 'SampleTable',
     columns: [
       'Column1 INTEGER NOT NULL',
       'Column2 TEXT'
     ]},
    {type: goog.gears.BaseStore.SchemaType.AFTER_INSERT_TRIGGER,
     name: 'SomeTrigger',
     tableName: 'SampleTable',
     when: 'NEW.Column1=4',
     actions: ['UPDATE SampleTable SET Column2="four" WHERE Column1=4']}
  ];
  baseStore.createSchema(oldSchema);
  baseStore.schema = oldSchema; // so that it gets dropped after test
  database.execute('INSERT INTO SampleTable (Column1) VALUES (4)');
  assertEquals('Should execute trigger', 'four', database.queryValue(
      'SELECT Column2 FROM SampleTable WHERE Column1=4'));
  var newSchema = [
    {type: goog.gears.BaseStore.SchemaType.TABLE,
     name: 'SampleTable',
     columns: [
       'Column1 INTEGER NOT NULL',
       'Column2 TEXT'
     ]},
    {type: goog.gears.BaseStore.SchemaType.AFTER_INSERT_TRIGGER,
     name: 'SomeTrigger',
     tableName: 'SampleTable',
     when: 'NEW.Column1=5',
     actions: ['UPDATE SampleTable SET Column2="five" WHERE Column1=5']}
  ];
  baseStore.createTriggers(newSchema);
  baseStore.schema = newSchema;
  assertTrue(baseStore.hasTable('SampleTable'));
  assertTrue(baseStore.hasTrigger('SomeTrigger'));
  database.execute('DELETE FROM SampleTable');
  database.execute('INSERT INTO SampleTable (Column1) VALUES (4)');
  database.execute('INSERT INTO SampleTable (Column1) VALUES (5)');
  assertNull('Should no longer have old trigger', database.queryValue(
      'SELECT Column2 FROM SampleTable WHERE Column1=4'));
  assertEquals('Should have new trigger', 'five', database.queryValue(
      'SELECT Column2 FROM SampleTable WHERE Column1=5'));
}

">n/a</td></tr>
<tr><td>loggerserver_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="

goog.require('goog.debug.Logger');
goog.require('goog.debug.Logger.Level');
goog.require('goog.messaging.LoggerServer');
goog.require('goog.testing.MockControl');
goog.require('goog.testing.PropertyReplacer');
goog.require('goog.testing.jsunit');
goog.require('goog.testing.messaging.MockMessageChannel');



var mockControl;
var channel;

var stubs = new goog.testing.PropertyReplacer();

function setUp() {
  mockControl = new goog.testing.MockControl();
  channel = new goog.testing.messaging.MockMessageChannel(mockControl);
  stubs.set(goog.debug.Logger, 'getLogger',
            mockControl.createFunctionMock('goog.debug.Logger.getLogger'));
}

function tearDown() {
  channel.dispose();
  stubs.reset();
}

function testCommandWithoutChannelName() {
  var mockLogger = mockControl.createStrictMock(goog.debug.Logger);
  goog.debug.Logger.getLogger('test.object.Name').$returns(mockLogger);
  mockLogger.log(
      goog.debug.Logger.Level.SEVERE, '[remote logger] foo bar', null);
  mockControl.$replayAll();

  var server = new goog.messaging.LoggerServer(channel, 'log');
  channel.receive('log', {
    name: 'test.object.Name',
    level: goog.debug.Logger.Level.SEVERE.value,
    message: 'foo bar',
    exception: null
  });
  mockControl.$verifyAll();
  server.dispose();
}

function testCommandWithChannelName() {
  var mockLogger = mockControl.createStrictMock(goog.debug.Logger);
  goog.debug.Logger.getLogger('test.object.Name').$returns(mockLogger);
  mockLogger.log(
      goog.debug.Logger.Level.SEVERE, '[some channel] foo bar', null);
  mockControl.$replayAll();

  var server = new goog.messaging.LoggerServer(channel, 'log', 'some channel');
  channel.receive('log', {
    name: 'test.object.Name',
    level: goog.debug.Logger.Level.SEVERE.value,
    message: 'foo bar',
    exception: null
  });
  mockControl.$verifyAll();
  server.dispose();
}

function testCommandWithException() {
  var mockLogger = mockControl.createStrictMock(goog.debug.Logger);
  goog.debug.Logger.getLogger('test.object.Name').$returns(mockLogger);
  mockLogger.log(
      goog.debug.Logger.Level.SEVERE, '[some channel] foo bar',
      {message: 'Bad things', stack: ['foo', 'bar']});
  mockControl.$replayAll();

  var server = new goog.messaging.LoggerServer(channel, 'log', 'some channel');
  channel.receive('log', {
    name: 'test.object.Name',
    level: goog.debug.Logger.Level.SEVERE.value,
    message: 'foo bar',
    exception: {message: 'Bad things', stack: ['foo', 'bar']}
  });
  mockControl.$verifyAll();
  server.dispose();
}

">n/a</td></tr>
<tr><td>logstore_test.html</td><td>Success</td><td> 13 passed, 0 failed.</td><td title="

  goog.require('goog.debug.Logger');
  goog.require('goog.debug.LogManager');
  goog.require('goog.gears.LogStore');
  goog.require('goog.gears.Database');
  goog.require('goog.testing.asserts');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.MockClock');



function isGearsAllowed() {
  return goog.gears.hasFactory() && goog.gears.getFactory().hasPermission;
}

var TEST_DB_NAME = 'my_test_db';
var TEST_TABLE_NAME = 'my_test_log_table';

var database_;
var logStore_;
var mockClock_ = new goog.testing.MockClock();

function setUpPage() {
  if (isGearsAllowed()) {
    // Remove table if already there
    try {
      database_ = new goog.gears.Database(
          'me@mydomain.com', TEST_DB_NAME);
      database_.execute('DROP TABLE IF EXISTS ' + TEST_TABLE_NAME);
    } catch (ex) {
      debug('Could not create the database');
    }
  }
  setUpPageStatus = 'complete';
}

function setUp() {
  if (isGearsAllowed()) {
    logStore_ = new goog.gears.LogStore(database_, TEST_TABLE_NAME);
    logStore_.removeStore();
    logStore_.ensureStoreExists();
  }
  mockClock_.install();
  mockClock_.tick(1);
}

function tearDown() {
  if (logStore_) {
    logStore_.removeStore();
  }
  mockClock_.reset();
  mockClock_.uninstall();
}

function testStoreVersion() {
  if (!isGearsAllowed()) {
    return;
  }
  assertEquals(
     'Bad initial store version', 1, logStore_.getStoreVersion());
}

function testSchema() {
  if (!isGearsAllowed()) {
    return;
  }
  assertTrue('Missing ' + TEST_TABLE_NAME, logStore_.hasTable(TEST_TABLE_NAME));
}

function testDefaultDbName() {
  if (!isGearsAllowed()) {
    return;
  }
  var aLogStore = new goog.gears.LogStore(database_);
  aLogStore.removeStore();
  aLogStore.ensureStoreExists();
  assertTrue('Missing ' + goog.gears.LogStore.DEFAULT_TABLE_NAME_,
      aLogStore.hasTable(goog.gears.LogStore.DEFAULT_TABLE_NAME_));
  aLogStore.removeStore();
}

function assertLogRecord(actualRecord, expectedMinMillis,
    expectedMaxMillis, expectedLevel, expectedMessage, expectedLoggerName,
    expectedException) {
  assertTrue('wrong millis: ' + actualRecord.getMillis(),
      expectedMinMillis <= actualRecord.getMillis() &&
      actualRecord.getMillis() <= expectedMaxMillis);
  assertEquals('wrong level', expectedLevel, actualRecord.getLevel());
  assertEquals('wrong message', expectedMessage, actualRecord.getMessage());
  assertEquals('wrong logger', expectedLoggerName,
      actualRecord.getLoggerName());

  // Exception.
  if (expectedException) {
    assertObjectEquals('wrong exception', expectedException,
        actualRecord.getException());
    assertTrue('missing exception text', !!actualRecord.getExceptionText());
  } else {
    assertNull('unexpected exception', actualRecord.getException());
    assertNull('unexpected exception text', actualRecord.getExceptionText());
  }
}

function assertSequence(records) {
  var lastSequenceNumber = -1;
  var lastMillis = -1;
  for (var i = records.length - 1; i >= 0; i--) {
    var thisSequenceNumber = records[i].getSequenceNumber();
    var thisMillis = records[i].getMillis();
    assertTrue('not descending sequence numbers',
        thisSequenceNumber > lastSequenceNumber);
    assertTrue('not descending millis', thisMillis >= lastMillis);
    lastSequenceNumber = thisSequenceNumber;
    lastMillis = thisMillis;
  }
}

function testSetCapturing() {
  if (!isGearsAllowed()) {
    return;
  }

  goog.debug.LogManager.getRoot().setLevel(goog.debug.Logger.Level.ALL);

  // Create logger object.
  var loggerName = 'my-logger';
  var logger = goog.debug.Logger.getLogger(loggerName);

  // Disabled capturing. Select by logger to avoid other records.
  assertFalse('capturing', logStore_.isCapturing());
  logger.severe('not capturing');
  var query = new goog.gears.LogStore.Query();
  query.loggerLike = loggerName;
  assertEquals('records found while not capturing',
      0, logStore_.select(query).length);

  // Enable capturing.
  logStore_.setCapturing(true);
  assertTrue('not capturing', logStore_.isCapturing());
  logger.severe('capturing');
  var count = logStore_.select(query).length;
  assertTrue('no records found while capturing', count > 0);

  // Disable capturing.
  logStore_.setCapturing(false);
  assertFalse('capturing', logStore_.isCapturing());
  logger.severe('not capturing');
  assertEquals('records found while not capturing',
      count, logStore_.select(query).length);
}

function testLogException() {
  if (!isGearsAllowed()) {
    return;
  }

  goog.debug.LogManager.getRoot().setLevel(goog.debug.Logger.Level.ALL);

  logStore_.setCapturing(true);

  // Create logger object.
  var loggerName = 'my-logger';
  var logger = goog.debug.Logger.getLogger(loggerName);

  // Log message.
  var beforeMillis = goog.now();
  var msgs = ['my-message-0', 'my-message-1'];
  var err = {
    message: 'my-error-msg',
    name: 'my-error',
    lineNumber: 10,
    fileName: 'my-file',
    stack: 'my-stack'
  };
  logger.info(msgs[0]);
  logger.severe(msgs[1], err);
  var afterMillis = goog.now();

  // Select by logger to avoid other records.
  var query = new goog.gears.LogStore.Query();
  query.loggerLike = loggerName;
  var records = logStore_.select(query);

  // Validate records.
  assertEquals('wrong # records', 2, records.length);
  assertLogRecord(records[0], beforeMillis, afterMillis,
      goog.debug.Logger.Level.SEVERE, msgs[1], loggerName, err);
  assertLogRecord(records[1], beforeMillis, afterMillis,
      goog.debug.Logger.Level.INFO, msgs[0], loggerName);
  assertSequence(records);
}

function testSelectByLevel() {
  if (!isGearsAllowed()) {
    return;
  }

  goog.debug.LogManager.getRoot().setLevel(goog.debug.Logger.Level.ALL);

  logStore_.setCapturing(true);

  // Create logger object.
  var loggerName = 'my-logger';
  var logger = goog.debug.Logger.getLogger(loggerName);
  logger.setLevel(goog.debug.Logger.Level.FINE);

  // Log messages.
  var msg = 'my-message';
  var beforeMillis = goog.now();
  logger.finest(msg + 'FINEST');
  logger.finer(msg + 'FINER');
  logger.fine(msg + 'FINE');
  logger.config(msg + 'CONFIG');
  logger.info(msg + 'INFO');
  logger.warning(msg + 'WARNING');
  logger.severe(msg + 'SEVERE');
  var afterMillis = goog.now();

  // Select FINE+ records. Select by logger to avoid other records.
  var query = new goog.gears.LogStore.Query();
  query.level = goog.debug.Logger.Level.ALL;
  query.loggerLike = loggerName;
  var records = logStore_.select(query);
  var expectedLevels = [
    goog.debug.Logger.Level.SEVERE,
    goog.debug.Logger.Level.WARNING,
    goog.debug.Logger.Level.INFO,
    goog.debug.Logger.Level.CONFIG,
    goog.debug.Logger.Level.FINE
  ];
  assertEquals('wrong # records', 5, records.length);
  for (var i = 0; i < records.length; i++) {
    assertLogRecord(records[i], beforeMillis, afterMillis,
        expectedLevels[i], msg + expectedLevels[i].name, loggerName);
  }
  assertSequence(records);

  // Select INFO+ records.
  query.level = goog.debug.Logger.Level.INFO;
  var records = logStore_.select(query);
  expectedLevels = [
    goog.debug.Logger.Level.SEVERE,
    goog.debug.Logger.Level.WARNING,
    goog.debug.Logger.Level.INFO
  ];
  assertEquals('wrong # records', 3, records.length);
  for (var i = 0; i < records.length; i++) {
    assertLogRecord(records[i], beforeMillis, afterMillis,
      expectedLevels[i], msg + expectedLevels[i].name, loggerName);
  }
  assertSequence(records);
}

/**
 * This tests selecting by clock time, and also tests log records added by
 * logStore.
 */
function testSelectByMillis() {
  if (!isGearsAllowed()) {
    return;
  }

  goog.debug.LogManager.getRoot().setLevel(goog.debug.Logger.Level.ALL);

  logStore_.setCapturing(true);

  // Create logger object.
  var loggerName = 'my-logger';
  var logger = goog.debug.Logger.getLogger(loggerName);

  // Log messages.
  var msg = 'my-message';
  var millis0 = mockClock_.tick(100000);
  logger.info(msg + 0);
  var millis1 = mockClock_.tick(100000);
  logger.info(msg + 1);
  var millis2 = mockClock_.tick(100000);
  logger.info(msg + 2);
  var millis3 = mockClock_.tick(0xfffffffffffffffffffffffff);
  logger.info(msg + 3);
  var millis4 = mockClock_.tick(100000);

  // Select before records. Select by logger to avoid other records.
  var query = new goog.gears.LogStore.Query();
  query.maxMillis = millis1;
  query.loggerLike = loggerName;
  var records = logStore_.select(query);
  assertEquals('wrong # records', 2, records.length);
  assertLogRecord(records[0], millis0, millis1,
      goog.debug.Logger.Level.INFO, msg + 1, loggerName);
  assertLogRecord(records[1], millis0, millis1,
      goog.debug.Logger.Level.INFO, msg + 0, loggerName);
  assertSequence(records);

  // Select between records.
  query.minMillis = millis2;
  query.maxMillis = millis3;
  records = logStore_.select(query);
  assertEquals('wrong # records', 2, records.length);
  assertLogRecord(records[0], millis2, millis3,
      goog.debug.Logger.Level.INFO, msg + 3, loggerName);
  assertLogRecord(records[1], millis2, millis3,
      goog.debug.Logger.Level.INFO, msg + 2, loggerName);
  assertSequence(records);

  // Select after records.
  query.minMillis = millis3;
  query.maxMillis = Infinity;
  records = logStore_.select(query);
  assertEquals('wrong # records', 1, records.length);
  assertLogRecord(records[0], millis3, millis4,
      goog.debug.Logger.Level.INFO, msg + 3, loggerName);
  assertSequence(records);
}

function testSelectByMessage() {
  if (!isGearsAllowed()) {
    return;
  }

  goog.debug.LogManager.getRoot().setLevel(goog.debug.Logger.Level.ALL);

  logStore_.setCapturing(true);

  // Create logger object.
  var loggerName = 'my-logger';
  var logger = goog.debug.Logger.getLogger(loggerName);

  // Log messages.
  var msg = 'my-message';
  var beforeMillis = goog.now();
  logger.info(msg + '1');
  logger.info(msg + '20');
  logger.info(msg + '21');
  logger.info(msg + '3');
  var afterMillis = goog.now();

  // Select 2 records.
  var query = new goog.gears.LogStore.Query();
  query.msgLike = '%2%';
  var records = logStore_.select(query);
  assertEquals('wrong # records', 2, records.length);
  assertLogRecord(records[0], beforeMillis, afterMillis,
      goog.debug.Logger.Level.INFO, msg + '21', loggerName);
  assertLogRecord(records[1], beforeMillis, afterMillis,
      goog.debug.Logger.Level.INFO, msg + '20', loggerName);
  assertSequence(records);
}

function testSelectByLogger() {
  if (!isGearsAllowed()) {
    return;
  }

  goog.debug.LogManager.getRoot().setLevel(goog.debug.Logger.Level.ALL);

  logStore_.setCapturing(true);

  // Create logger object.
  var loggerName = 'my-logger';
  var logger1 = goog.debug.Logger.getLogger(loggerName + 1);
  var logger2 = goog.debug.Logger.getLogger(loggerName + 2);
  var logger3 = goog.debug.Logger.getLogger(loggerName + 3);

  // Log messages.
  var msg = 'my-message';
  var beforeMillis = goog.now();
  logger1.info(msg + '1');
  mockClock_.tick();
  logger2.info(msg + '2');
  mockClock_.tick();
  logger3.info(msg + '3');
  mockClock_.tick();
  var afterMillis = goog.now();

  // Select 1 records.
  var query = new goog.gears.LogStore.Query();
  query.loggerLike = '%2%';
  var records = logStore_.select(query);
  assertEquals('wrong # records', 1, records.length);
  assertLogRecord(records[0], beforeMillis, afterMillis,
      goog.debug.Logger.Level.INFO, msg + '2', loggerName + 2);
  assertSequence(records);
}

function testSelectLimit() {
  if (!isGearsAllowed()) {
    return;
  }

  goog.debug.LogManager.getRoot().setLevel(goog.debug.Logger.Level.ALL);

  logStore_.setCapturing(true);

  // Create logger object.
  var loggerName = 'my-logger';
  var logger = goog.debug.Logger.getLogger(loggerName);

  // Log messages.
  var msg = 'my-message';
  var beforeMillis = goog.now();
  logger.info(msg + '1');
  mockClock_.tick();
  logger.info(msg + '2');
  mockClock_.tick();
  logger.info(msg + '3');
  mockClock_.tick();
  logger.info(msg + '4');
  mockClock_.tick();
  logger.info(msg + '5');
  mockClock_.tick();
  var afterMillis = goog.now();

  // Select 5 records.
  var query = new goog.gears.LogStore.Query();
  query.loggerLike = loggerName;
  records = logStore_.select(query);
  assertEquals('wrong # records', 5, records.length);
  assertSequence(records);

  // Select last 3 records.
  query.limit = 3;
  records = logStore_.select(query);
  assertEquals('wrong # records', 3, records.length);
  assertLogRecord(records[0], beforeMillis, afterMillis,
      goog.debug.Logger.Level.INFO, msg + '5', loggerName);
  assertLogRecord(records[1], beforeMillis, afterMillis,
      goog.debug.Logger.Level.INFO, msg + '4', loggerName);
  assertLogRecord(records[2], beforeMillis, afterMillis,
      goog.debug.Logger.Level.INFO, msg + '3', loggerName);
  assertSequence(records);
}

function testPruneBeforeCount() {
  if (!isGearsAllowed()) {
    return;
  }
  logStore_.setCapturing(true);

  // Set to WARNING to avoid database and other logging.
  goog.debug.LogManager.getRoot().setLevel(goog.debug.Logger.Level.WARNING);

  // Create logger object.
  var loggerName = 'my-logger';
  var logger = goog.debug.Logger.getLogger(loggerName);

  // Log messages.
  var msg = 'my-message';
  logger.severe(msg + '1!');
  mockClock_.tick();
  logger.warning(msg + '2');
  mockClock_.tick();
  logger.severe(msg + '3!');
  var betweenMillis = mockClock_.tick();
  logger.warning(msg + '4');
  mockClock_.tick();
  logger.severe(msg + '5!');
  mockClock_.tick();
  logger.warning(msg + '6');
  mockClock_.tick();

  // Select by logger to avoid other records.
  var query = new goog.gears.LogStore.Query();
  query.loggerLike = loggerName;
  assertEquals('wrong # records', 6, logStore_.select(query).length);
  logStore_.pruneBeforeCount(3);
  assertEquals('wrong # records', 3, logStore_.select(query).length);
}

function testPruneBeforeSequenceNumber() {
  if (!isGearsAllowed()) {
    return;
  }
  logStore_.setCapturing(true);

  // Set to WARNING to avoid database and other logging.
  goog.debug.LogManager.getRoot().setLevel(goog.debug.Logger.Level.WARNING);

  // Create logger object.
  var loggerName = 'my-logger';
  var logger = goog.debug.Logger.getLogger(loggerName);

  // Log messages.
  var msg = 'my-message';
  logger.severe(msg + '1!');
  mockClock_.tick();
  logger.warning(msg + '2');
  mockClock_.tick();
  logger.severe(msg + '3!');
  var betweenMillis = mockClock_.tick();
  logger.warning(msg + '4');
  mockClock_.tick();
  logger.severe(msg + '5!');
  mockClock_.tick();
  logger.warning(msg + '6');
  mockClock_.tick();

  // Select by logger to avoid other records.
  var query = new goog.gears.LogStore.Query();
  query.loggerLike = loggerName;
  var records = logStore_.select(query);
  assertEquals('wrong # records', 6, records.length);
  logStore_.pruneBeforeSequenceNumber(records[3].getSequenceNumber());
  assertEquals('wrong # records', 3, logStore_.select(query).length);
}

function testAutoPrune() {
  if (!isGearsAllowed()) {
    return;
  }
  logStore_.setCapturing(true);

  // Set to WARNING to avoid database and other logging.
  goog.debug.LogManager.getRoot().setLevel(goog.debug.Logger.Level.WARNING);

  // Create logger object.
  var loggerName = 'my-logger';
  var logger = goog.debug.Logger.getLogger(loggerName);

  // Log messages.
  var msg = 'my-message';
  mockClock_.tick(100);
  logger.severe(msg + '1!');
  mockClock_.tick(100);
  logger.warning(msg + '2');
  mockClock_.tick(100);
  logger.severe(msg + '3!');
  mockClock_.tick(100);
  logger.warning(msg + '4');
  mockClock_.tick(100);
  logger.severe(msg + '5!');
  mockClock_.tick(100);
  logger.warning(msg + '6');
  mockClock_.tick(100);

  // Auto-prune specified interval (100).
  assertFalse('auto prune should not be active', logStore_.isAutoPruneActive());
  var query = new goog.gears.LogStore.Query();
  query.loggerLike = loggerName;
  assertEquals('wrong # records', 6,
      logStore_.select(query).length);
  logStore_.createAutoPruneDelay(3, 100);
  logStore_.startAutoPrune();
  assertTrue('auto prune should be active', logStore_.isAutoPruneActive());
  assertEquals('wrong # records', 3, logStore_.select(query).length);
  logger.warning(msg + '7');
  mockClock_.tick(50);
  assertEquals('wrong # records', 4, logStore_.select(query).length);
  mockClock_.tick(50);
  assertEquals('wrong # records', 3, logStore_.select(query).length);

  // Stop autoprune.
  logStore_.stopAutoPrune();
  assertFalse('auto prune should not be active', logStore_.isAutoPruneActive());
  logger.warning(msg + '8');
  mockClock_.tick(200);
  assertEquals('wrong # records', 4, logStore_.select(query).length);

  // Auto-prune default interval (600000).
  logStore_.createAutoPruneDelay(3);
  logStore_.startAutoPrune(3);
  assertTrue('auto prune should be active', logStore_.isAutoPruneActive());
  assertEquals('wrong # records', 3, logStore_.select(query).length);
  logger.warning(msg + '7');
  logger.severe(msg + '8!');
  logger.warning(msg + '9');
  mockClock_.tick(50);
  assertEquals('wrong # records', 6, logStore_.select(query).length);
  mockClock_.tick(50);
  assertEquals('wrong # records', 6, logStore_.select(query).length);
  mockClock_.tick(599900);
  assertEquals('wrong # records', 3, logStore_.select(query).length);
  logger.warning(msg + '10');
  mockClock_.tick(100);
  assertEquals('wrong # records', 4, logStore_.select(query).length);

  // Stop autoprune.
  logStore_.stopAutoPrune();
  assertFalse('auto prune should not be active', logStore_.isAutoPruneActive());
}

">n/a</td></tr>
<tr><td>urlcapture_test.html</td><td>Success</td><td> 10 passed, 0 failed.</td><td title="

  goog.require('goog.gears.UrlCapture');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.LooseMock');



/**
 * @return {GearsLocalServer} Stub local server.
 */
function newStubLocalServer() {
  return {
    createStore: function() {},
    openStore: function() {},
    removeStore: function() {}
  };
}

/**
 * @return {GearsResourceStore} Stub resource store.
 */
function newStubResourceStore() {
  var nextCaptureId = 0;
  var capturedUrls = [];

  var result = {};
  result.callbacks = {};

  result.capture = function(urls, callback) {
    var id = nextCaptureId++;
    this.callbacks[id] = function(url, success, captureId) {
      if (url && success) {
        capturedUrls.push(url);
      }
      callback(url, success, captureId);
    }
    return id;
  };

  result.rename = function(oldUrl, newUrl) {
    goog.array.remove(capturedUrls, oldUrl);
    capturedUrls.push(newUrl);
  };

  result.copy = function(oldUrl, newUrl) {
    capturedUrls.push(newUrl);
  };

  result.remove = function(url) {
    goog.array.remove(capturedUrls, url);
  };

  result.isCaptured = function(url) {
    return goog.array.contains(capturedUrls, url);
  };

  result.abortCapture = function(id) {
    delete this.callbacks[id];
  };

  return result;
}

/**
 * @param {GearsResourceStore} ResourceStore to be returned by #createStore.
 * @return {Mock.<GearsLocalServer>} Mock local server expecting a single call
 *     to #createStore returning #stubResourceStore.
 */
function newMockLocalServerCreateStore(stubResourceStore) {
  var result = new goog.testing.LooseMock(newStubLocalServer());
  result.createStore(STORE_NAME, COOKIE_NAME).$returns(
      stubResourceStore);
  result.$replay();
  return result;
}

/**
 * @return {Object} Event listener for UrlCapture.
 */
function newListener(uut) {
  var result = {
      url_success: [],
      url_error: [],
      complete: [],
      abort: []
  };
  goog.events.listen(uut, goog.gears.UrlCapture.EventType.URL_SUCCESS,
      function(e) { result.url_success.push(e); });
  goog.events.listen(uut, goog.gears.UrlCapture.EventType.URL_ERROR,
      function(e) { result.url_error.push(e); });
  goog.events.listen(uut, goog.gears.UrlCapture.EventType.COMPLETE,
      function(e) { result.complete.push(e); });
  goog.events.listen(uut, goog.gears.UrlCapture.EventType.ABORT,
      function(e) { result.abort.push(e); });
  return result;
}

function assertEventEquals(expectedType, expectedCaptureId, expectedUri,
    expectedErrorUris, actualEvent) {
  assertEquals('wrong type', expectedType, actualEvent.type);
  assertEquals('wrong capture ID', expectedCaptureId, actualEvent.captureId);
  assertEquals('wrong URL', expectedUri, actualEvent.uri);
  assertArrayEquals('wrong error URIs', expectedErrorUris,
      actualEvent.errorUris);
}

function assertIsCaptured(expectedCapturedUrls, expectedUncapturedUrls, uut) {
  for (var i = 0; i < expectedCapturedUrls.length; ++i) {
    var url = expectedCapturedUrls[i];
    assertTrue('not captured: ' + url, uut.isCaptured(url));
  }
  for (var i = 0; i < expectedUncapturedUrls.length; ++i) {
    var url = expectedUncapturedUrls[i];
    assertFalse('captured: ' + url, uut.isCaptured(url));
  }
}

var STORE_NAME = 'TestCapture';
var COOKIE_NAME = 'TestCookie';

/**
 * Tests resource store exists.
 */
function testExists() {
  var mockLocalServer = new goog.testing.LooseMock(newStubLocalServer());
  mockLocalServer.openStore(STORE_NAME, COOKIE_NAME).$returns(true);
  mockLocalServer.$replay();

  var uut = new goog.gears.UrlCapture(STORE_NAME, COOKIE_NAME, mockLocalServer);
  assertTrue('exists failed for ' + STORE_NAME, uut.exists());
  mockLocalServer.$verify();
}

/**
 * Tests resource store does not exist.
 */
function testNotExists() {
  var mockLocalServer = new goog.testing.LooseMock(newStubLocalServer());
  mockLocalServer.openStore(STORE_NAME, COOKIE_NAME).$returns(false);
  mockLocalServer.$replay();

  var uut = new goog.gears.UrlCapture(STORE_NAME, COOKIE_NAME, mockLocalServer);
  assertFalse('exists succeeded for ' + STORE_NAME, uut.exists());
  mockLocalServer.$verify();
}

/**
 * Test remove resource store.
 */
function testRemoveStore() {
  var mockLocalServer = new goog.testing.LooseMock(newStubLocalServer());
  mockLocalServer.removeStore(STORE_NAME, COOKIE_NAME);
  mockLocalServer.$replay();

  var uut = new goog.gears.UrlCapture(STORE_NAME, COOKIE_NAME, mockLocalServer);
  uut.removeStore();
  mockLocalServer.$verify();
}

/**
 * Test empty capture request.
 */
function testEmptyCapture() {
  var uut = new goog.gears.UrlCapture(STORE_NAME, COOKIE_NAME,
      newStubLocalServer());
  assertThrows('should fail for null uris', function() { uut.capture(); });
  assertThrows('should fail for 0 uris', function() { uut.capture([]); });
}

/**
 * Test successful capture.
 */
function testCaptureUrlSuccess() {
  // Create stubs and mocks.
  var stubResourceStore = newStubResourceStore();
  var mockLocalServer = newMockLocalServerCreateStore(stubResourceStore);

  // Create url capturer and event listener.
  var uut = new goog.gears.UrlCapture(STORE_NAME, COOKIE_NAME, mockLocalServer);
  var listener = newListener(uut);

  // Start capture.
  var url = '/foo.html';
  var id = uut.capture([url]);
  mockLocalServer.$verify();
  assertEquals('wrong capture ID', 0, id);
  var callback = stubResourceStore.callbacks[id];
  assertEquals('missing callback', 'function', typeof callback);

  // Callback capture success.
  var uncapturedUrl = '/uncaptured.html';
  assertIsCaptured([], [url, uncapturedUrl], uut);
  callback(url, true, id);
  assertIsCaptured([url], [uncapturedUrl], uut);

  // Assert events.
  assertEquals('url error', 0, listener.url_error.length);
  assertEquals('abort', 0, listener.abort.length);
  assertEquals('url success', 1, listener.url_success.length);
  assertEventEquals(goog.gears.UrlCapture.EventType.URL_SUCCESS, id, url, [],
      listener.url_success[0]);
  assertEquals('url complete', 1, listener.complete.length);
  assertEventEquals(goog.gears.UrlCapture.EventType.COMPLETE, id, null, [],
      listener.complete[0]);
}

/**
 * Test unsuccessful capture.
 */
function testCaptureUrlFail() {
  // Create stubs and mocks.
  var stubResourceStore = newStubResourceStore();
  var mockLocalServer = newMockLocalServerCreateStore(stubResourceStore);

  // Create url capturer and event listener.
  var uut = new goog.gears.UrlCapture(STORE_NAME, COOKIE_NAME, mockLocalServer);
  var listener = newListener(uut);

  // Start capture.
  var url = '/foo.html';
  var id = uut.capture([url]);
  mockLocalServer.$verify();
  assertEquals('wrong capture ID', 0, id);
  var callback = stubResourceStore.callbacks[id];
  assertEquals('missing callback', 'function', typeof callback);

  // Callback capture success.
  assertIsCaptured([], [url], uut);
  callback(url, false, id);
  assertIsCaptured([], [url], uut);

  // Assert events.
  assertEquals('url error', 1, listener.url_error.length);
  assertEventEquals(goog.gears.UrlCapture.EventType.URL_ERROR, id, url, [],
      listener.url_error[0]);
  assertEquals('abort', 0, listener.abort.length);
  assertEquals('url success', 0, listener.url_success.length);
  assertEquals('url complete', 1, listener.complete.length);
  assertEventEquals(goog.gears.UrlCapture.EventType.COMPLETE, id, null, [url],
      listener.complete[0]);
}

/**
 * Test abort capture.
 */
function testAbortCapture() {
  // Create stubs and mocks.
  var stubResourceStore = newStubResourceStore();
  var mockLocalServer = newMockLocalServerCreateStore(stubResourceStore);

  // Create url capturer and event listener.
  var uut = new goog.gears.UrlCapture(STORE_NAME, COOKIE_NAME, mockLocalServer);
  var listener = newListener(uut);

  // Throw exception for aborting with no ID.
  assertThrows('should fail for no ID', function() { uut.abort(); });
  assertThrows('should fail for null ID', function() { uut.abort(null); });

  // Start capture.
  var url = '/foo.html';
  var id = uut.capture([url]);
  mockLocalServer.$verify();
  var callback = stubResourceStore.callbacks[id];
  assertEquals('missing callback', 'function', typeof callback);

  // Abort capture.
  assertIsCaptured([], [url], uut);
  uut.abort(id);
  assertEquals('abort', 1, listener.abort.length);
  assertFalse('found aborted callback', !!stubResourceStore.callbacks[id]);
  assertIsCaptured([], [url], uut);

  // Callback after abort captures URL but dispatches no events.
  callback(url, true, id);
  assertIsCaptured([url], [], uut);

  // Assert events.
  assertEquals('url error', 0, listener.url_error.length);
  assertEquals('url success', 0, listener.url_success.length);
  assertEquals('url complete', 0, listener.complete.length);
}

/**
 * Test removing captured URL.
 */
function testRemoveUrl() {
  // Create stubs and mocks.
  var stubResourceStore = newStubResourceStore();
  var mockLocalServer = newMockLocalServerCreateStore(stubResourceStore);

  // Create url capturer.
  var uut = new goog.gears.UrlCapture(STORE_NAME, COOKIE_NAME, mockLocalServer);

  // Throw exception for removing with no URL.
  assertThrows('should fail for no URL', function() { uut.remove(); });
  assertThrows('should fail for null URL', function() { uut.remove(null); });

  // Start capture.
  var url = '/foo.html';
  var id = uut.capture([url]);
  mockLocalServer.$verify();
  assertIsCaptured([], [url], uut);

  // Capture callback success.
  stubResourceStore.callbacks[id](url, true, id);
  assertIsCaptured([url], [], uut);

  // Remove URL.
  uut.remove(url);
  assertIsCaptured([], [url], uut);
}

/**
 * Test renaming captured URL.
 */
function testRenameUrl() {
  // Create stubs and mocks.
  var stubResourceStore = newStubResourceStore();
  var mockLocalServer = newMockLocalServerCreateStore(stubResourceStore);

  // Create url capturer.
  var uut = new goog.gears.UrlCapture(STORE_NAME, COOKIE_NAME, mockLocalServer);

  // Throw exception for removing with no URL.
  assertThrows('should fail for no URL', function() { uut.rename(); });
  assertThrows('should fail for null URL', function() { uut.rename(null); });

  // Start capture.
  var url = '/foo.html';
  var renamedUrl = '/renamed.html';
  var id = uut.capture([url]);
  mockLocalServer.$verify();
  assertIsCaptured([], [url, renamedUrl], uut);

  // Callback capture success.
  stubResourceStore.callbacks[id](url, true, id);
  assertIsCaptured([url], [renamedUrl], uut);

  // Rename URL.
  uut.rename(url, renamedUrl);
  assertIsCaptured([renamedUrl], [url], uut);
}

/**
 * Test copying captured URL.
 */
function testCopyUrl() {
  // Create stubs and mocks.
  var stubResourceStore = newStubResourceStore();
  var mockLocalServer = newMockLocalServerCreateStore(stubResourceStore);

  // Create url capturer.
  var uut = new goog.gears.UrlCapture(STORE_NAME, COOKIE_NAME, mockLocalServer);

  // Throw exception for removing with no URL.
  assertThrows('should fail for no URL', function() { uut.copy(); });
  assertThrows('should fail for null URL', function() { uut.copy(null); });

  // Start capture.
  var url = '/foo.html';
  var copiedUrl = '/renamed.html';
  var id = uut.capture([url]);
  mockLocalServer.$verify();
  assertIsCaptured([], [url, copiedUrl], uut);

  // Callback capture success.
  stubResourceStore.callbacks[id](url, true, id);
  assertIsCaptured([url], [copiedUrl], uut);

  // Copy URL.
  uut.copy(url, copiedUrl);
  assertIsCaptured([url, copiedUrl], [], uut);
}

">n/a</td></tr>
<tr><td>gears_test.html</td><td>Success</td><td> 4 passed, 0 failed.</td><td title="

  goog.require('goog.gears');
  goog.require('goog.string');
  goog.require('goog.testing.jsunit');



function assertInvalidFileName(original) {
  try {
    goog.gears.makeSafeFileName(original);
    fail('expect exception for file name: ' + original);
  } catch (ex) {
    // success
  }
}

function assertSafeFileName(expected, original) {
  var actual = goog.gears.makeSafeFileName(original);
  assertTrue('safe file name too short: ' + actual, actual.length > 0);
  assertTrue('safe file name too long: ' + actual, actual.length <= 64);
  assertEquals('unexpected value for safe file name', expected, actual);
}

function testSafeFileNameInvalid() {
  assertInvalidFileName(null);
  assertInvalidFileName('');
  assertInvalidFileName('\t');
}

function testSafeFileNameTypical() {
  var fileName = 'foo@foo.com-MyAppname-d';
  assertSafeFileName(fileName, fileName);
}

function testSafeFileNameLength() {
  // Just under limit.
  var fileName = goog.string.repeat('a', 64);
  assertSafeFileName(fileName, fileName);

  // Just over limit.
  fileName = goog.string.repeat('a', 65);
  var hashedSuffix = String(goog.string.hashCode(fileName));
  assertSafeFileName(fileName.substring(0, 54) + hashedSuffix, fileName);

  // Way over limit.
  fileName = goog.string.repeat('a', 1024);
  hashedSuffix = String(goog.string.hashCode(fileName));
  assertSafeFileName(fileName.substring(0, 54) + hashedSuffix, fileName);
}

function testSafeFileNameInvalidChar() {
  assertSafeFileName(goog.string.repeat('a', 44),
      goog.string.repeat('a', 22) + '\t' + goog.string.repeat('a', 22));
  assertSafeFileName('b', 'b' + goog.string.repeat('\t', 20));
  assertSafeFileName('b', 'b' + goog.string.repeat('\t', 200));
}

">n/a</td></tr>
<tr><td>multipartformdata_test.html</td><td>Success</td><td> 11 passed, 0 failed.</td><td title="


goog.require('goog.gears.MultipartFormData');
goog.require('goog.testing.MockControl');
goog.require('goog.testing.jsunit');




var mockControl = new goog.testing.MockControl;
var propertyReplacer = new goog.testing.PropertyReplacer;
var mockFactory;
var mockBlobBuilder = {
  sb: [],
  append: function(s) {
    this.sb.push(s);
  },
  getAsBlob: function() {
    return this.sb.join('');
  },
  reset: function() {
    this.sb.length = 0;
  }
};
var RANDOM = '123abc'

function setUp() {
  mockFactory = {
    create: function(id) {
      assertEquals('beta.blobbuilder', id);
      return mockBlobBuilder;
    }
  };
  propertyReplacer.set(goog.string, 'getRandomString',
                       mockControl.createFunctionMock());
  propertyReplacer.set(goog.gears, 'getFactory', function() {
    return mockFactory;
  });

  goog.string.getRandomString().$returns(RANDOM);

  mockControl.$replayAll();
};

function tearDown() {
  mockControl.$verifyAll();

  mockControl.$resetAll();
  mockBlobBuilder.reset();
  propertyReplacer.reset();
}

function testConstruct() {
  assertEquals('object', typeof new goog.gears.MultipartFormData());
}

function testNoAddsShouldResultInEmptyBlob() {
  var data = new goog.gears.MultipartFormData();
  assertEquals('', data.getAsBlob());
}

function testAddText() {
  var data = new goog.gears.MultipartFormData();
  data.addText('name1', 'value1');
  var expected = '------123abc\r\n' +
      'Content-Disposition: form-data; name="name1"\r\n' +
      'Content-Type: text/plain; charset=UTF-8\r\n' +
      '\r\n' +
      'value1\r\n' +
      '------123abc--\r\n';

  assertEquals(expected, data.getAsBlob());
}

function testAddTextWithNumber() {
  var data = new goog.gears.MultipartFormData();
  data.addText('name1', 123);
  var expected = '------123abc\r\n' +
      'Content-Disposition: form-data; name="name1"\r\n' +
      'Content-Type: text/plain; charset=UTF-8\r\n' +
      '\r\n' +
      '123\r\n' +
      '------123abc--\r\n';

  assertEquals(expected, data.getAsBlob());
}

function testAddTextMultiple() {
  var data = new goog.gears.MultipartFormData();
  data.addText('name1', 'value1');
  data.addText('name2', 'value2');
  var expected = '------123abc\r\n' +
      'Content-Disposition: form-data; name="name1"\r\n' +
      'Content-Type: text/plain; charset=UTF-8\r\n' +
      '\r\n' +
      'value1\r\n' +
      '------123abc\r\n' +
      'Content-Disposition: form-data; name="name2"\r\n' +
      'Content-Type: text/plain; charset=UTF-8\r\n' +
      '\r\n' +
      'value2\r\n' +
      '------123abc--\r\n';

  assertEquals(expected, data.getAsBlob());
}

function testAddFile() {
  var gearsFile = {
    name: 'FILENAME',
    blob: 'BLOB'
  };

  var data = new goog.gears.MultipartFormData();
  data.addFile('name1', gearsFile);
  var expected = '------123abc\r\n' +
      'Content-Disposition: form-data; name="name1"; filename="FILENAME"\r\n' +
      'Content-Type: application/octet-stream\r\n' +
      '\r\n' +
      'BLOB\r\n' +
      '------123abc--\r\n';

  assertEquals(expected, data.getAsBlob());
}

function testAddBlob() {
  var data = new goog.gears.MultipartFormData();
  data.addBlob('name1', 'FILENAME', 'BLOB');
  var expected = '------123abc\r\n' +
      'Content-Disposition: form-data; name="name1"; filename="FILENAME"\r\n' +
      'Content-Type: application/octet-stream\r\n' +
      '\r\n' +
      'BLOB\r\n' +
      '------123abc--\r\n';

  assertEquals(expected, data.getAsBlob());
}

function testAddMultiple() {
  var gearsFile = {
    name: 'FILENAME2',
    blob: 'BLOB2'
  }
  var data = new goog.gears.MultipartFormData();
  data.addText('name1', 'value1');
  data.addFile('name2', gearsFile);
  data.addBlob('name3', 'FILENAME3', 'BLOB3');

  var expected = '------123abc\r\n' +
      'Content-Disposition: form-data; name="name1"\r\n' +
      'Content-Type: text/plain; charset=UTF-8\r\n' +
      '\r\n' +
      'value1\r\n' +
      '------123abc\r\n' +
      'Content-Disposition: form-data; name="name2"; filename="FILENAME2"\r\n' +
      'Content-Type: application/octet-stream\r\n' +
      '\r\n' +
      'BLOB2\r\n' +
      '------123abc\r\n' +
      'Content-Disposition: form-data; name="name3"; filename="FILENAME3"\r\n' +
      'Content-Type: application/octet-stream\r\n' +
      '\r\n' +
      'BLOB3\r\n' +
      '------123abc--\r\n';

  assertEquals(expected, data.getAsBlob());
}

function testGetContentType() {
  var data = new goog.gears.MultipartFormData();
  assertEquals('multipart/form-data; boundary=' +
               '----' + RANDOM,
               data.getContentType());
}

function testAddAfterClose() {
  var data = new goog.gears.MultipartFormData();
  data.addText('name1', 'value1');
  var expected = '------123abc\r\n' +
      'Content-Disposition: form-data; name="name1"\r\n' +
      'Content-Type: text/plain; charset=UTF-8\r\n' +
      '\r\n' +
      'value1\r\n' +
      '------123abc--\r\n';

  assertEquals(expected, data.getAsBlob());

  assertThrows(function() {
    data.addText('name2', 'value2');
  });
}

function testInvalidValue() {
  var data = new goog.gears.MultipartFormData();
  assertThrows(function() {
    data.addText('name1', data.boundary_);
  });
}


">n/a</td></tr>
<tr><td>database_test.html</td><td>Success</td><td> 22 passed, 0 failed.</td><td title="

  goog.require('goog.gears.Database');
  goog.require('goog.testing.jsunit');



function isGearsAllowed() {
  return goog.gears.hasFactory() && goog.gears.getFactory().hasPermission;
}

var database;

function setUpPage() {
  if (isGearsAllowed()) {
    try {
      database = new goog.gears.Database('tester', 'database-test');
    } catch (e) {
      debug('Could not create the database');
    }
  }
  setUpPageStatus = 'complete'; // jsunit magic
}

function setUp() {
  if (!database) {
    return;
  }
  database.execute('DROP TABLE IF EXISTS Test');
  database.execute('CREATE TABLE IF NOT EXISTS Test (x TEXT, y TEXT)');

  database.execute('INSERT INTO Test VALUES (?, ?)', 'a', 'alpha');
  database.execute('INSERT INTO Test VALUES (?, ?)', 'b', 'beta');
  database.execute('INSERT INTO Test VALUES (?, ?)', 'g', 'gamma');
}

function tearDown() {
  if (database) {
    goog.events.removeAll(database);

    // Rollback to clean up transaction state.
    while (database.isInTransaction()) {
      database.rollback();
    }
  }
}

function testCreateDatabase() {
  if (!database) {
    return;
  }
  assertNotNull('Could not create the database', database);
}

function testCreateTable() {
  if (!database) {
    return;
  }

  var created = database.queryValue('SELECT 1 FROM SQLITE_MASTER ' +
      'WHERE TYPE=? AND NAME=?',
      'table',
      'Test') != null;
  assertTrue('Test table could not be created', created);
  assertEquals('Wrong number of rows after more insertions', 3,
               database.queryValue('SELECT COUNT(*) FROM Test'));
}

function testQueryValue() {
  if (!database) {
    return;
  }
  // testing retrieving a single value
  var val = database.queryValue('SELECT y FROM Test WHERE x=?', 'b');
  assertEquals('Wrong value returned by query', 'beta', val);

  // testing a query that returns nothing
  val = database.queryValue('SELECT y FROM Test WHERE x=?', 'd');
  assertNull('Should not have returned a value for the query', val);

  // testing that the query returns the first row of the query
  val = database.queryValue('SELECT y FROM Test');
  assertEquals('Wrong value returned by query', 'alpha', val);

  // testing that the query returns the first element of the row of the query
  val = database.queryValue('SELECT * FROM Test');
  assertEquals('Wrong value returned by query', 'a', val);

  // And the same with an array.

  // testing retrieving a single value
  val = database.queryValue('SELECT y FROM Test WHERE x=?', ['b']);
  assertEquals('Wrong value returned by query', 'beta', val);

  // testing a query that returns nothing
  val = database.queryValue('SELECT y FROM Test WHERE x=?', ['d']);
  assertNull('Should not have returned a value for the query', val);
}

function testQueryObject() {
  if (!database) {
    return;
  }
  // testing that the query returns the correct object
  var obj = database.queryObject('SELECT * FROM Test WHERE x=?', 'b');
  assertNotNull('Should have returned a value for the query', obj);
  assertEquals('Wrong value returned by query', 'b', obj['x']);
  assertEquals('Wrong value returned by query', 'beta', obj['y']);

  // testing that the query returns null when there is no match
  obj = database.queryValue('SELECT * FROM Test WHERE x=?', 'd');
  assertNull('Should not have returned a value for the query', obj);

  // testing that the query returns the first row when there are multiple
  // rows returned.
  obj = database.queryObject('SELECT * FROM Test');
  assertNotNull('Should have returned a value for the query', obj);
  assertEquals('Wrong value returned by query', 'a', obj['x']);
  assertEquals('Wrong value returned by query', 'alpha', obj['y']);

  // And the same with an array.

  // testing that the query returns the correct object
  obj = database.queryObject('SELECT * FROM Test WHERE x=?', ['b']);
  assertNotNull('Should have returned a value for the query', obj);
  assertEquals('Wrong value returned by query', 'b', obj['x']);
  assertEquals('Wrong value returned by query', 'beta', obj['y']);

  // testing that the query returns null when there is no match
  obj = database.queryValue('SELECT * FROM Test WHERE x=?', ['d']);
  assertNull('Should not have returned a value for the query', obj);
}

function testQueryValueArray() {
  if (!database) {
    return;
  }
  // testing selecting returning of multiple single values
  var arr = database.queryValueArray('SELECT y FROM Test');
  assertNotNull('Should have returned a value for the query', arr);
  assertEquals('Wrong value returned by query', 3, arr.length);
  assertEquals('Wrong value returned by query', 'alpha', arr[0]);
  assertEquals('Wrong value returned by query', 'beta', arr[1]);
  assertEquals('Wrong value returned by query', 'gamma', arr[2]);

  // testing selecting returning of multiple single values when there
  // are no matches.
  arr = database.queryValueArray('SELECT y FROM Test WHERE x=?', 'd');
  assertNotNull('Should have returned a value for the query', arr);
  assertEquals('Wrong value returned by query', 0, arr.length);

  // testing selecting returning of multiple single values even when
  // selecting multiple columns - should return the first column
  arr = database.queryValueArray('SELECT * FROM Test');
  assertNotNull('Should have returned a value for the query', arr);
  assertEquals('Wrong value returned by query', 3, arr.length);
  assertEquals('Wrong value returned by query', 'a', arr[0]);
  assertEquals('Wrong value returned by query', 'b', arr[1]);
  assertEquals('Wrong value returned by query', 'g', arr[2]);

  // And the same with an array.

  // testing selecting returning of multiple single values when there
  // are no matches.
  arr = database.queryValueArray('SELECT y FROM Test WHERE x=?', ['d']);
  assertNotNull('Should have returned a value for the query', arr);
  assertEquals('Wrong value returned by query', 0, arr.length);

}

function testQueryObjectArray() {
  if (!database) {
    return;
  }
  // testing selecting returning of array of objects
  var arr = database.queryObjectArray('SELECT * FROM Test');
  assertNotNull('Should have returned a value for the query', arr);
  assertEquals('Wrong value returned by query', 3, arr.length);
  assertEquals('Wrong value returned by query', 'a', arr[0]['x']);
  assertEquals('Wrong value returned by query', 'alpha', arr[0]['y']);
  assertEquals('Wrong value returned by query', 'b', arr[1]['x']);
  assertEquals('Wrong value returned by query', 'beta', arr[1]['y']);
  assertEquals('Wrong value returned by query', 'g', arr[2]['x']);
  assertEquals('Wrong value returned by query', 'gamma', arr[2]['y']);

  // testing selecting returning of multiple objects when there
  // are no matches.
  arr = database.queryObjectArray('SELECT y FROM Test WHERE x=?', 'd');
  assertNotNull('Should have returned a value for the query', arr);
  assertEquals('Wrong value returned by query', 0, arr.length);

  // And the same with an array.

  // testing selecting returning of multiple objects when there
  // are no matches.
  arr = database.queryObjectArray('SELECT y FROM Test WHERE x=?', ['d']);
  assertNotNull('Should have returned a value for the query', arr);
  assertEquals('Wrong value returned by query', 0, arr.length);

}

function testQueryToArrays() {
  if (!database) {
    return;
  }
  // testing selecting returning of array of arrays
  var arr = database.queryArrays('SELECT * FROM Test');
  assertNotNull('Should have returned a value for the query', arr);
  assertEquals('Wrong value returned by query', 3, arr.length);
  assertEquals('Wrong value returned by query', 'a', arr[0][0]);
  assertEquals('Wrong value returned by query', 'alpha', arr[0][1]);
  assertEquals('Wrong value returned by query', 'b', arr[1][0]);
  assertEquals('Wrong value returned by query', 'beta', arr[1][1]);
  assertEquals('Wrong value returned by query', 'g', arr[2][0]);
  assertEquals('Wrong value returned by query', 'gamma', arr[2][1]);

  arr = database.queryArrays('SELECT * FROM Test WHERE x=?', 'd');
  assertNotNull('Should have returned a value for the query', arr);
  assertEquals('Wrong value returned by query', 0, arr.length);

  // And the same with an array.

  arr = database.queryArrays('SELECT * FROM Test WHERE x=?', ['d']);
  assertNotNull('Should have returned a value for the query', arr);
  assertEquals('Wrong value returned by query', 0, arr.length);
}

function testForEachValue() {
  if (!database) {
    return;
  }
  // testing the foreach value when there are matching values
  var vals = [];
  database.forEachValue('SELECT * FROM Test',
                        function(val, row, col, name) {
                          vals.push({val: val, row: row, col: col, name: name});
                          return true;
                        },
                        null);
  assertEquals('Wrong value returned by query', 6, vals.length);
  assertEquals('Wrong value returned by query', 'a', vals[0].val);
  assertEquals('Wrong value returned by query', 0, vals[0].row);
  assertEquals('Wrong value returned by query', 0, vals[0].col);
  assertEquals('Wrong value returned by query', 'x', vals[0].name);
  assertEquals('Wrong value returned by query', 'alpha', vals[1].val);
  assertEquals('Wrong value returned by query', 0, vals[1].row);
  assertEquals('Wrong value returned by query', 1, vals[1].col);
  assertEquals('Wrong value returned by query', 'y', vals[1].name);
  assertEquals('Wrong value returned by query', 'b', vals[2].val);
  assertEquals('Wrong value returned by query', 1, vals[2].row);
  assertEquals('Wrong value returned by query', 0, vals[2].col);
  assertEquals('Wrong value returned by query', 'x', vals[2].name);
  assertEquals('Wrong value returned by query', 'beta', vals[3].val);
  assertEquals('Wrong value returned by query', 1, vals[3].row);
  assertEquals('Wrong value returned by query', 1, vals[3].col);
  assertEquals('Wrong value returned by query', 'y', vals[3].name);
  assertEquals('Wrong value returned by query', 'g', vals[4].val);
  assertEquals('Wrong value returned by query', 2, vals[4].row);
  assertEquals('Wrong value returned by query', 0, vals[4].col);
  assertEquals('Wrong value returned by query', 'x', vals[4].name);
  assertEquals('Wrong value returned by query', 'gamma', vals[5].val);
  assertEquals('Wrong value returned by query', 2, vals[5].row);
  assertEquals('Wrong value returned by query', 1, vals[5].col);
  assertEquals('Wrong value returned by query', 'y', vals[5].name);

  vals = [];
  database.forEachValue('SELECT * FROM Test WHERE x=?',
                        function(val, row, col, name) {
                          vals.push({val: val, row: row, col: col, name: name});
                        },
                        null,
                        'd');
  assertEquals('Wrong value returned by query', 0, vals.length);

  // And the same with an array.

  vals = [];
  database.forEachValue('SELECT * FROM Test WHERE x=?',
                        function(val, row, col, name) {
                          vals.push({val: val, row: row, col: col, name: name});
                        },
                        null,
                        ['d']);
  assertEquals('Wrong value returned by query', 0, vals.length);

}

function testForEachRow() {
  if (!database) {
    return;
  }
  var vals = [];
  database.forEachRow('SELECT * FROM Test',
                      function(arr, row) {
                        vals.push({arr: arr, row: row});
                        return true;
                      },
                      null);
  assertEquals('Wrong value returned by query', 3, vals.length);
  assertEquals('Wrong value returned by query', 'a', vals[0].arr[0]);
  assertEquals('Wrong value returned by query', 'alpha', vals[0].arr[1]);
  assertEquals('Wrong value returned by query', 0, vals[0].row);
  assertEquals('Wrong value returned by query', 'b', vals[1].arr[0]);
  assertEquals('Wrong value returned by query', 'beta', vals[1].arr[1]);
  assertEquals('Wrong value returned by query', 1, vals[1].row);
  assertEquals('Wrong value returned by query', 'g', vals[2].arr[0]);
  assertEquals('Wrong value returned by query', 'gamma', vals[2].arr[1]);
  assertEquals('Wrong value returned by query', 2, vals[2].row);

  vals = [];
  database.forEachRow('SELECT * FROM Test WHERE x=?',
                      function(arr, row) {
                        vals.push({arr: arr, row: row});
                        return true;
                      },
                      null,
                      'd');
  assertEquals('Wrong value returned by query', 0, vals.length);

  // And the same with an array.

  vals = [];
  database.forEachRow('SELECT * FROM Test WHERE x=?',
                      function(arr, row) {
                        vals.push({arr: arr, row: row});
                        return true;
                      },
                      null,
                      ['d']);
  assertEquals('Wrong value returned by query', 0, vals.length);

}

function testMultipleBegins() {
  if (!database) {
    return;
  }
  var db1;
  var db2;
  try {
    db1 = new goog.gears.Database('tester', 'database-test');
    db2 = new goog.gears.Database('tester', 'database-test');
  } catch (e) {
    fail('Could not create the databases');
  }

  db1.begin();
  try {
    // This should time out as being locked.
    db2.begin();
    fail('Should not have been able to get past second begin transaction.');
  } catch (e) {
    assertFalse(
        'Second begin should have failed, but claims to be in a transaction.',
        db2.isInTransaction());
    assertTrue(
        'Second begin not reported as being locked',
        goog.gears.Database.isLockedException(e));
  }
  db1.commit();
  db2.begin();
  assertTrue('New second begin failed', db2.isInTransaction());
  db2.commit();
};


function testIsLockedExceptionMessage() {
  if (!database) {
    return;
  }

  var lockedExStr = 'Database operation failed. ERROR: database is locked ' +
      'DETAILS: database is locked';

  assertTrue(goog.gears.Database.isLockedException(lockedExStr));
  assertFalse(goog.gears.Database.isLockedException(
      'Database operation failed. ERROR: invalid SQL operation'));

  assertTrue(goog.gears.Database.isLockedException(Error(lockedExStr)));
}

function testNestedBegins() {
  if (!database) {
    return;
  }

  // Try normal nested begins.
  database.begin();
  try {
    database.begin();
    database.commit();
    database.commit();
  } catch (e) {
    fail('Could not run nested transactions');
  }

  // Now try nested begins with lower begin levels
  database.begin();
  try {
    database.beginDeferred();
    database.commit();
    database.commit();
  } catch (e) {
    fail('Could not run nested transactions');
  }

  // Now try begins with increasing begin levels. This should throw
  // an error.
  database.beginDeferred();
  try {
    database.beginImmediate();
    fail('Could not run nested transactions');
    database.commit();
    database.commit();
  } catch (e) {
    database.rollback(e);
  }
}


function testCommit() {
  if (!database) {
    return;
  }
  var db;
  try {
    db = new goog.gears.Database('tester', 'database-test');
  } catch (e) {
    debug('Could not create the database');
  }

  var committed = false;
  var rollbacked = false;

  database.begin();
  goog.events.listen(database, 'commit', function(e) {committed = true;});
  goog.events.listen(database, 'rollback', function(e) {rollbacked = true;});
  assertTrue('Incorrect reporting of being in a transaction',
             database.isInTransaction());
  database.execute('INSERT INTO Test VALUES(?, ?)', 'o', 'omega');
  var cnt = database.queryValue('SELECT COUNT(*) FROM Test');
  assertEquals('Found wrong number of rows', 4, cnt);
  cnt = db.queryValue('SELECT COUNT(*) FROM Test');
  assertEquals('Found wrong number of rows', 3, cnt);
  database.commit();
  cnt = db.queryValue('SELECT COUNT(*) FROM Test');
  assertEquals('Found wrong number of rows', 4, cnt);

  assertFalse('Incorrect reporting of being in a transaction',
              database.isInTransaction());

  assertTrue('Commit event not dispatched', committed);
  assertFalse('Rollback event wrongly dispatched', rollbacked);
}

function testCommit2() {
  if (!database) {
    return;
  }
  var db;
  try {
    db = new goog.gears.Database('tester', 'database-test');
  } catch (e) {
    debug('Could not create the database');
  }

  var committed = false;
  var rollbacked = false;

  database.begin();
  goog.events.listen(database, 'commit', function(e) {committed = true;});
  goog.events.listen(database, 'rollback', function(e) {rollbacked = true;});
  database.execute('INSERT INTO Test VALUES(?, ?)', 's', 'sigma');
  assertTrue('Incorrect reporting of being in a transaction',
             database.isInTransaction());
  database.begin();
  assertTrue('Incorrect reporting of being in a transaction',
             database.isInTransaction());
  database.execute('INSERT INTO Test VALUES(?, ?)', 's', 'sigma');
  database.commit();

  assertFalse('Commit event wrongly dispatched', committed);
  assertFalse('Rollback event wrongly dispatched', rollbacked);

  assertTrue('Incorrect reporting of being in a transaction',
             database.isInTransaction());
  // the values should not be committed at this point.
  cnt = database.queryValue('SELECT COUNT(*) FROM Test');
  assertEquals('Found wrong number of rows', 5, cnt);
  cnt = db.queryValue('SELECT COUNT(*) FROM Test');
  assertEquals('Found wrong number of rows', 3, cnt);
  database.commit();
  cnt = db.queryValue('SELECT COUNT(*) FROM Test');
  assertEquals('Found wrong number of rows', 5, cnt);
  assertFalse('Incorrect reporting of being in a transaction',
              database.isInTransaction());
  assertTrue('Commit function not called', committed);
  assertFalse('Rollback function wrongly called', rollbacked);
}

function testRollback() {
  if (!database) {
    return;
  }

  var begun = false;
  var committed = false;
  var rollbacked = false;

  goog.events.listen(database, 'begin', function(e) {begun = true;});
  database.begin();
  assertTrue('Begin event not dispatched', begun);
  goog.events.listen(database, 'commit', function(e) {committed = true;});
  goog.events.listen(database, 'rollback', function(e) {rollbacked = true;});
  database.execute('INSERT INTO Test VALUES(?, ?)', 'o', 'omega');
  var cnt = database.queryValue('SELECT COUNT(*) FROM Test');
  assertEquals('Found wrong number of rows', 4, cnt);
  database.rollback();
  cnt = database.queryValue('SELECT COUNT(*) FROM Test');
  assertEquals('Found wrong number of rows', 3, cnt);
  assertFalse('Incorrect reporting of being in a transaction',
              database.isInTransaction());
  assertFalse('Commit event wrongly dispatched', committed);
  assertTrue('Rollback event not dispatched', rollbacked);
}

function testRollback2() {
  if (!database) {
    return;
  }

  var begun = false;
  var committed = false;
  var rollbacked = false;

  database.begin();
  goog.events.listen(database, 'commit', function(e) {committed = true;});
  goog.events.listen(database, 'rollback', function(e) {rollbacked = true;});
  database.execute('INSERT INTO Test VALUES(?, ?)', 's', 'sigma');
  database.begin();
  database.execute('INSERT INTO Test VALUES(?, ?)', 's', 'sigma');
  database.rollback();
  // the values should not be rolledback at this point.
  cnt = database.queryValue('SELECT COUNT(*) FROM Test');
  assertEquals('Found wrong number of rows', 5, cnt);
  assertFalse('Commit event wrongly dispatched', committed);
  assertFalse('Rollback event wrongly dispatched', rollbacked);

  database.rollback();
  cnt = database.queryValue('SELECT COUNT(*) FROM Test');
  assertEquals('Found wrong number of rows', 3, cnt);
  assertFalse('Incorrect reporting of being in a transaction',
              database.isInTransaction());
  assertFalse('Commit event wrongly dispatched', committed);
  assertTrue('Rollback event not dispatched', rollbacked);
}

function testPreventDefault() {
  if (!database) {
    return;
  }

  var committed = false;
  database.begin();
  goog.events.listen(database, 'beforecommit', function(e) {
    e.preventDefault();
  });
  goog.events.listen(database, 'commit', function(e) {committed = true;});
  database.execute('INSERT INTO Test VALUES(?, ?)', 'd', 'delta');
  database.commit();
  assertFalse('Commit ignored beforecommit preventDefault()', committed);
  database.rollback();
}

function testPreventDefault2() {
  if (!database) {
    return;
  }

  var rollbacked = false;
  database.begin();
  goog.events.listen(database, 'beforerollback', function(e) {
    e.preventDefault();
  });
  goog.events.listen(database, 'rollback', function(e) {
    rollbacked = true;
  });
  database.execute('INSERT INTO Test VALUES(?, ?)', 'd', 'delta');
  database.rollback();
  assertFalse('Rollback ignored beforerollback preventDefault()', rollbacked);
  goog.events.removeAll(database);
  database.rollback();
}

function testLastInsertId() {
  if (!database) {
    return;
  }
  database.execute('INSERT INTO Test VALUES (?, ?)', 'a', 'alpha');
  var id = database.getLastInsertRowId();
  database.execute('INSERT INTO Test VALUES (?, ?)', 'b', 'beta');
  assertEquals('Incorrect last insert id',
               id + 1, database.getLastInsertRowId());
}

function testError() {
  if (!database) {
    return;
  }

  var sql = 'INSERT INTO Unknown VALUES(?, ?)';

  try {
    database.execute('INSERT INTO Unknown VALUES(?, ?)', 'alpha', 1);
    fail('Should not have gotten here');
  } catch (e) {
    assertEquals('Wrong sql information', sql + ': ["alpha",1]', e.message0);
  }
}

function testThrowInBeforeSubmit() {
  if (!database) {
    return;
  }

  var errorSentinel = Error();

  var committed = false;
  database.begin();
  goog.events.listen(database, 'beforecommit', function(e) {
    throw errorSentinel;
  });
  goog.events.listen(database, 'commit', function(e) {
    committed = true;
  });
  database.execute('INSERT INTO Test VALUES(?, ?)', 'd', 'delta');
  try {
    database.commit();
    fail('Should have thrown an error');
  } catch (ex) {
    assertEquals(errorSentinel, ex);
    assertTrue('Should still be in the transaction',
               database.isInTransaction());
  }

  assertFalse('Should not have been commited since we threw an error ' +
              'in beforecommit', committed);
  database.rollback();
}

function testThrowInBeforeRollback() {
  if (!database) {
    return;
  }

  var errorSentinel = Error();

  var rollbacked = false;
  database.begin();
  goog.events.listen(database, 'beforerollback', function(e) {
    throw errorSentinel;
  });
  goog.events.listen(database, 'rollback', function(e) {
    rollbacked = true;
  });
  database.execute('INSERT INTO Test VALUES(?, ?)', 'd', 'delta');

  try {
    database.rollback();
    fail('Should have thrown an error');
  } catch (ex) {
    assertEquals(errorSentinel, ex);
    assertTrue('Should still be in the transaction',
               database.isInTransaction());
  }
  assertFalse('Should not have been rolled back since we threw an error ' +
              'in beforerollback', rollbacked);
  goog.events.removeAll(database);
  database.rollback();
}

">n/a</td></tr>
<tr><td>loggerclient_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="

goog.require('goog.debug.Logger');
goog.require('goog.debug.Logger.Level');
goog.require('goog.messaging.LoggerClient');
goog.require('goog.testing.MockControl');
goog.require('goog.testing.jsunit');
goog.require('goog.testing.messaging.MockMessageChannel');



var mockControl;
var channel;
var client;
var logger;

function setUp() {
  mockControl = new goog.testing.MockControl();
  channel = new goog.testing.messaging.MockMessageChannel(mockControl);
  client = new goog.messaging.LoggerClient(channel, 'log');
  logger = goog.debug.Logger.getLogger('test.logging.Object');
}

function tearDown() {
  channel.dispose();
  client.dispose();
}

function testCommand() {
  channel.send('log', {
    name: 'test.logging.Object',
    level: goog.debug.Logger.Level.WARNING.value,
    message: 'foo bar',
    exception: undefined
  });
  mockControl.$replayAll();
  logger.warning('foo bar');
  mockControl.$verifyAll();
}

function testCommandWithException() {
  var ex = Error('oh no');
  ex.stack = ['one', 'two'];
  ex.message0 = 'message 0';
  ex.message1 = 'message 1';
  ex.ignoredProperty = 'ignored';

  channel.send('log', {
    name: 'test.logging.Object',
    level: goog.debug.Logger.Level.WARNING.value,
    message: 'foo bar',
    exception: {
      name: 'Error',
      message: ex.message,
      stack: ex.stack,
      lineNumber: ex.lineNumber || 'Not available',
      fileName: ex.fileName || window.location.href,
      message0: ex.message0,
      message1: ex.message1
    }
  });
  mockControl.$replayAll();
  logger.warning('foo bar', ex);
  mockControl.$verifyAll();
}

function testCommandWithStringException() {
  channel.send('log', {
    name: 'test.logging.Object',
    level: goog.debug.Logger.Level.WARNING.value,
    message: 'foo bar',
    exception: {
      name: 'Unknown error',
      message: 'oh no',
      stack: '[Anonymous](object, foo bar, oh no)\n' +
          '[Anonymous](foo bar, oh no)\n' + goog.debug.getStacktrace(),
      lineNumber: 'Not available',
      fileName: window.location.href
    }
  });
  mockControl.$replayAll();
  logger.warning('foo bar', 'oh no');
  mockControl.$verifyAll();
}

">n/a</td></tr>
<tr><td>managedresourcestore_test.html</td><td>Success</td><td> 6 passed, 0 failed.</td><td title="

  goog.require('goog.gears.ManagedResourceStore');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.MockClock');



var clock;
var HAS_PROGRESS_EVENTS_VERSION = '0.3.6';
var shouldFail;


function setUp() {
  clock = new goog.testing.MockClock(true);
  shouldFail = false;
}


function tearDown() {
  clock.dispose();
}


// Create mocks


goog.gears.hasFactory = function() {
  return true;
};


var mockFactory = {
  create: function(classId) {
    if (classId == 'beta.timer') {
      // window implements the timer interface
      return window;
    } else if (classId == 'beta.localserver') {
      return mockLocalServer;
    }
  }
};


// Use this to change the mock gears factory as needed
function setGearsHasProgressEvents(gearsHasProgressEvents) {
  mockFactory.version = gearsHasProgressEvents ?
      HAS_PROGRESS_EVENTS_VERSION : '0.1';
}
setGearsHasProgressEvents(false);


goog.gears.getFactory = function() {
  return mockFactory;
};


var mockLocalServer = {
  openManagedStore: function(name, requiredCookie) {
    return new MockManagedResourceStore;
  },
  createManagedStore: function(name, requiredCookie) {
    return new MockManagedResourceStore;
  },
  removeManagedStore: function(name, requiredCookie) {

  }
};


function MockManagedResourceStore() {}


MockManagedResourceStore.prototype = {
  manifestUrl: '',
  currentVersion: '',
  updateStatus: 0,
  enabled: true,
  lastErrorMessage: '',
  checkForUpdate: function() {
    // Define some functions that will be used to trigger fake callbacks at
    // certain times
    var self = this;
    function setUpdateStatus(n, t) {
      window.setTimeout(function() {
        self.updateStatus = n;
      }, t);
    }
    function callOnProgress(complete, total, t) {
      window.setTimeout(function() {
        self.onprogress({filesComplete: complete, filesTotal: total});
      }, t);
    }
    function callOnComplete(version, t) {
      window.setTimeout(function() {
        self.oncomplete({newVersion: version});
      }, t);
    }
    function callOnError(message, t) {
      window.setTimeout(function() {
        self.lastErrorMessage = message;
        self.onerror({message: message});
      }, t);
    }

    var OK = goog.gears.ManagedResourceStore.UpdateStatus.OK;
    var CHECKING = goog.gears.ManagedResourceStore.UpdateStatus.CHECKING;
    var DOWNLOADING = goog.gears.ManagedResourceStore.UpdateStatus.DOWNLOADING;
    var FAILURE = goog.gears.ManagedResourceStore.UpdateStatus.FAILURE;

    this.updateStatus = CHECKING;

    if (goog.gears.getFactory().version == HAS_PROGRESS_EVENTS_VERSION) {
      callOnProgress(0, 0, 0);
      setUpdateStatus(DOWNLOADING, 1000);
      callOnProgress(0, 3, 1000);
      callOnProgress(1, 3, 2000);
      callOnProgress(2, 3, 2500);
      if (shouldFail) {
        setUpdateStatus(FAILURE, 3000);
        callOnError('ERROR', 3000);
      } else {
        callOnProgress(3, 3, 3000);
        setUpdateStatus(OK, 3000);
        callOnComplete('NEW_VERSION', 3000);
      }
    } else {
      // Use n * 1000 + 1 to make sure this happens just after a tick
      setUpdateStatus(DOWNLOADING, 1001);
      if (shouldFail) {
        self.lastErrorMessage = 'ERROR';
        setUpdateStatus(FAILURE, 2001);
      } else {
        setUpdateStatus(OK, 2001);
      }
    }

  }
};


// Start the real testing


var MANIFEST_NAME = 'testName';


function testManagedResourceStore() {
  var store = new goog.gears.ManagedResourceStore('tester',
      'managed-resource-store-test');
  store.create(MANIFEST_NAME);
  assertNotNull('No managed resource store object', store);
  assertTrue('Managed resource store not created', store.exists());
}


function testDoubleCreate() {
  var store = new goog.gears.ManagedResourceStore('tester',
      'managed-resource-store-test');
  store.create(MANIFEST_NAME);

  assertTrue('Managed resource store not created', store.exists());
  store.create(MANIFEST_NAME);
  assertTrue('Managed resource store no longer exists', store.exists());
}


function testUpdateOldSuccess() {
  setGearsHasProgressEvents(false);
  var progressCount = 0;
  var errorCount = 0;
  var completeCount = 0;
  var successCount = 0;
  var store = new goog.gears.ManagedResourceStore('tester',
      'managed-resource-store-test');

  store.create(MANIFEST_NAME);

  goog.events.listen(store, goog.gears.ManagedResourceStore.EventType.PROGRESS,
      function(e) {
        progressCount++;
        if (clock.getCurrentTime() == 0) {
          assertEquals('Should be 0 complete files',
                       0, store.getFilesComplete());
          assertEquals('Should be 1 total files',
                       1, store.getFilesTotal());
        }
        if (clock.getCurrentTime() == 2000) {
          assertEquals('Should be 1 complete files',
                       1, store.getFilesComplete());
          assertEquals('Should be 1 total files',
                       1, store.getFilesTotal());
        }
      });
  goog.events.listen(store, goog.gears.ManagedResourceStore.EventType.COMPLETE,
      function(e) {
        completeCount++;
        assertEquals('We should be complete at 2500ms', 2500,
                     clock.getCurrentTime());
        assertTrue('Should be successful', store.isSuccess());
      });
  goog.events.listen(store, goog.gears.ManagedResourceStore.EventType.ERROR,
      function(e) {
        errorCount++;
        assertEquals('ERROR', e.errorMessage);
      });
  goog.events.listen(store, goog.gears.ManagedResourceStore.EventType.SUCCESS,
      function(e) {
        successCount++;
      });

  store.update();

  clock.tick(500);
  clock.tick(500);
  clock.tick(500);
  clock.tick(500);
  clock.tick(500);
  clock.tick(500);
  clock.tick(500);

  assertEquals('Should have gotten 2 progress events', 2, progressCount);
  assertEquals('Should have gotten 1 complete events', 1, completeCount);
  assertEquals('Should have gotten 0 error events', 0, errorCount);
  assertEquals('Should have gotten 1 success events', 1, successCount);
}


function testUpdateOldFailure() {
  shouldFail = true;
  setGearsHasProgressEvents(false);
  var progressCount = 0;
  var errorCount = 0;
  var completeCount = 0;
  var successCount = 0;
  var store = new goog.gears.ManagedResourceStore('tester',
      'managed-resource-store-test');

  store.create(MANIFEST_NAME);

  goog.events.listen(store, goog.gears.ManagedResourceStore.EventType.PROGRESS,
      function(e) {
        progressCount++;
        if (clock.getCurrentTime() == 0) {
          assertEquals('Should be 0 complete files',
                       0, store.getFilesComplete());
          assertEquals('Should be 1 total files',
                       1, store.getFilesTotal());
        }
        if (clock.getCurrentTime() == 2000) {
          assertEquals('Should be 1 complete files',
                       1, store.getFilesComplete());
          assertEquals('Should be 1 total files',
                       1, store.getFilesTotal());
        }
      });
  goog.events.listen(store, goog.gears.ManagedResourceStore.EventType.COMPLETE,
      function(e) {
        completeCount++;
        assertEquals('We should be complete at 2500ms', 2500,
                     clock.getCurrentTime());
        assertFalse('Should not be successful', store.isSuccess());
      });
  goog.events.listen(store, goog.gears.ManagedResourceStore.EventType.ERROR,
      function(e) {
        errorCount++;
        assertEquals('ERROR', e.errorMessage);
      });

  store.update();

  clock.tick(500);
  clock.tick(500);
  clock.tick(500);
  clock.tick(500);
  clock.tick(500);
  clock.tick(500);
  clock.tick(500);

  assertEquals('Should have gotten 1 progress events', 1, progressCount);
  assertEquals('Should have gotten 1 complete events', 1, completeCount);
  assertEquals('Should have gotten 1 error events', 1, errorCount);
  assertEquals('Should have gotten 0 success events', 0, successCount);
}


function testUpdateNewSuccess() {
  setGearsHasProgressEvents(true);
  var progressCount = 0;
  var errorCount = 0;
  var completeCount = 0;
  var successCount = 0;
  var store = new goog.gears.ManagedResourceStore('tester',
      'managed-resource-store-test');

  store.create(MANIFEST_NAME);

  goog.events.listen(store, goog.gears.ManagedResourceStore.EventType.PROGRESS,
      function(e) {
        progressCount++;
        if (clock.getCurrentTime() == 0) {
          assertEquals('Should be 1 total files',
                       1, store.getFilesTotal());
          assertEquals('Should be 0 complete files',
                       0, store.getFilesComplete());
        } else {
          assertEquals('Should be 3 total files',
                       3, store.getFilesTotal());
        }

        if (clock.getCurrentTime() == 2000) {
          assertEquals('Should be 1 complete files',
                       1, store.getFilesComplete());
        } else if (clock.getCurrentTime() == 2500) {
          assertEquals('Should be 2 complete files',
                       2, store.getFilesComplete());
        } else if (clock.getCurrentTime() == 3000) {
          assertEquals('Should be 2 complete files',
                       3, store.getFilesComplete());
        }
      });
  goog.events.listen(store, goog.gears.ManagedResourceStore.EventType.COMPLETE,
      function(e) {
        completeCount++;
        assertEquals('We should be complete at 3000ms', 3000,
                     clock.getCurrentTime());
        assertTrue('Should be successful', store.isSuccess());
      });
  goog.events.listen(store, goog.gears.ManagedResourceStore.EventType.ERROR,
      function(e) {
        errorCount++;
        assertEquals('ERROR', e.errorMessage);
      });
  goog.events.listen(store, goog.gears.ManagedResourceStore.EventType.SUCCESS,
      function(e) {
        assertEquals('success at 3000ms', 3000,
                     clock.getCurrentTime());
        successCount++;
      });

  store.update();

  clock.tick(500);
  clock.tick(500);
  clock.tick(500);
  clock.tick(500);
  clock.tick(500);
  clock.tick(500);
  clock.tick(500);

  // Starts at 0/0 so we don't get progress for that
  // 0/3, 1/3, 2/3, 3/3
  assertEquals('Should have gotten 4 progress events', 4, progressCount);
  assertEquals('Should have gotten 1 complete events', 1, completeCount);
  assertEquals('Should have gotten 0 error events', 0, errorCount);
  assertEquals('Should have gotten 1 success events', 1, successCount);
}


function testUpdateNewFailure() {
  shouldFail = true;
  setGearsHasProgressEvents(true);
  var progressCount = 0;
  var errorCount = 0;
  var completeCount = 0;
  var successCount = 0;
  var store = new goog.gears.ManagedResourceStore('tester',
      'managed-resource-store-test');

  store.create(MANIFEST_NAME);

  goog.events.listen(store, goog.gears.ManagedResourceStore.EventType.PROGRESS,
      function(e) {
        progressCount++;
        if (clock.getCurrentTime() == 0) {
          assertEquals('Should be 1 total files',
                       1, store.getFilesTotal());
          assertEquals('Should be 0 complete files',
                       0, store.getFilesComplete());
        } else {
          assertEquals('Should be 3 total files',
                       3, store.getFilesTotal());
        }

        if (clock.getCurrentTime() == 2000) {
          assertEquals('Should be 1 complete files',
                       1, store.getFilesComplete());
        } else if (clock.getCurrentTime() == 2500) {
          assertEquals('Should be 2 complete files',
                       2, store.getFilesComplete());
        } else if (clock.getCurrentTime() == 3000) {
          assertEquals('Should be 2 complete files',
                       3, store.getFilesComplete());
        }
      });
  goog.events.listen(store, goog.gears.ManagedResourceStore.EventType.COMPLETE,
      function(e) {
        completeCount++;
        assertEquals('We should be complete at 3000ms', 3000,
                     clock.getCurrentTime());
        assertFalse('Should not be successful', store.isSuccess());
      });
  goog.events.listen(store, goog.gears.ManagedResourceStore.EventType.ERROR,
      function(e) {
        errorCount++;
        assertEquals('ERROR', e.errorMessage);
      });
  goog.events.listen(store, goog.gears.ManagedResourceStore.EventType.SUCCESS,
      function(e) {
        assertEquals('success at 3000ms', 3000,
                     clock.getCurrentTime());
        successCount++;
      });

  store.update();

  clock.tick(500);
  clock.tick(500);
  clock.tick(500);
  clock.tick(500);
  clock.tick(500);
  clock.tick(500);
  clock.tick(500);

  // When we fail we don't get the third file

  // Starts at 0/0 so we don't get progress for that
  // 0/3, 1/3, 2/3
  assertEquals('Should have gotten 3 progress events', 3, progressCount);
  assertEquals('Should have gotten 1 complete events', 1, completeCount);
  assertEquals('Should have gotten 1 error events', 1, errorCount);
  assertEquals('Should have gotten 0 success events', 0, successCount);
}


">n/a</td></tr>
<tr><td>workerpool_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.gears.Worker.EventType');
  goog.require('goog.gears.WorkerPool');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.TestCase');



var ONE = 1
var TWO = 2
var THREE = 3;

/**
 * Every message should be a JSON string.
 */
google.gears.workerPool.onmessage = function(message, sender, messageObject) {
  function sendMessage(m) {
    google.gears.workerPool.sendMessage(m, sender);
  }

  var obj = messageObject.body;

  if (typeof obj == 'object' && obj != null) {
    var commandId = obj[0];
    var params = obj[1];
    if (commandId == ONE) {
      sendMessage([1, ['one', params.toUpperCase()]]);
    } else if (commandId == TWO) {
      sendMessage([2, ['two', params.toUpperCase()]]);
    } else if (commandId == THREE) {
      sendMessage([3, ['three', params.toUpperCase()]]);
    } else {
      // {a: null} case
      sendMessage(obj);
    }
  } else {
    sendMessage(obj);
  }
};




function isGearsAllowed() {
  return goog.gears.hasFactory() && goog.gears.getFactory().hasPermission;
}

var ONE = 1
var TWO = 2
var THREE = 3;

// Create a new test case.
var workerTestCase = new goog.testing.TestCase(document.title);

/** True once the test environment is set up. */
workerTestCase.isSetUp = false;

/** True once the page is ready for the test to be run. */
workerTestCase.isReady = false;

/** The number of tests recieved from the worker pool. */
workerTestCase.resultCount = 0;

/** Array of test results */
workerTestCase.results = [];

/** Array of tests */
workerTestCase.tests = [
  [ONE, 'one', 'ONE'],
  [TWO, 'two', 'TWO'],
  [THREE, 'three', 'THREE'],
  {a: null},
  'JSON string',
  '',
  1,
  0,
  false,
  true
];

/** Sets up the test environment, adds tests and sets up the worker pools. */
workerTestCase.setUpTests = function() {
  this.log('Setting tests up');

  this.add(new goog.testing.TestCase.Test(
      'test worker results', this.testResults, this));

  this.isSetUp = true;

  // Can't test if gears isn't installed.
  if (!isGearsAllowed()) {
    setUpPageStatus = 'complete';
    this.isReady = true;
    return;
  }

  var workerPool = new goog.gears.WorkerPool;

  var worker = workerPool.createWorker(this.getWorkerCode());
  goog.events.listen(worker, goog.gears.Worker.EventType.MESSAGE, this);

  for (var i = 0; i < 3; i++) {
    worker.sendMessage([this.tests[i][0], this.tests[i][1]]);
  }

  for (var i = 3; i < this.tests.length; i++) {
    worker.sendMessage(this.tests[i]);
  }
};

/** Gets the worker code. */
workerTestCase.getWorkerCode = function() {
  return document.getElementById('workercode').innerHTML;
};

/** Handles the worker's MESSAGE event . */
workerTestCase.handleEvent = function(e) {
  this.log('handleEvent, type: ' + e.type + ', message: ' + e.message);
  if (e.type == goog.gears.Worker.EventType.MESSAGE) {
    if (goog.isArray(e.message)) {
      var commandId = e.message[0];
      var params = e.message[1];

      this.results.push([commandId, params[0], params[1]]);
    } else {
      this.results.push(e.message);
    }
    this.resultCount++;
    if (this.resultCount >= this.tests.length) {
      this.isReady = true;
      // Backwards compatability for JsUnit to start tests
      setUpPageStatus = 'complete';
    }
  }
};

/** Tests that the results were correct. */
workerTestCase.testResults = function() {
  this.log('testing results');
  // Can't test if gears isn't installed.
  if (!isGearsAllowed()) {
    return;
  }

  for (var i = 0; i < this.tests.length; i++) {
    if (goog.isArray(this.tests[i])) {
      assertArrayEquals(this.tests[i], this.results[i]);
    } else if (goog.isObject(this.tests[i])) {
      assertObjectEquals(this.tests[i], this.results[i]);
    } else {
      assertEquals(this.tests[i], this.results[i]);
    }
  }
};

/** Waits until the tests are ready to begin, before running them. */
workerTestCase.runTests = function() {
  if (!this.isSetUp) {
    this.setUpTests();
  }
  if (this.isReady) {
    this.execute();
  } else {
    this.log('Not ready, waiting');
    // Try again in 100ms
    setTimeout('workerTestCase.runTests()', 100);
  }
};

/** Used by the JsUnit test runner. */
function testResults() {
  workerTestCase.testResults();
}

/** Used by the JsUnit test runner. */
function setUpPage() {
  workerTestCase.runTests();
}

/** Standalone Closure Test Runner. */
if (typeof G_testRunner != 'undefined') {
  G_testRunner.initialize(workerTestCase);
}

">ReferenceError: google is not defined
    at _tmpclosuretest.js:17:1
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
    at Module.load (module.js:219:31)
    at Function._load (module.js:186:10)
</td></tr>
<tr><td>workerchannel_test.html</td><td>Success</td><td> 17 passed, 0 failed.</td><td title="

goog.require('goog.events.EventTarget');
goog.require('goog.gears.Worker.EventType');
goog.require('goog.gears.WorkerChannel');
goog.require('goog.gears.WorkerEvent');
goog.require('goog.json');
goog.require('goog.testing.MockControl');
goog.require('goog.testing.jsunit');
goog.require('goog.testing.mockmatchers.IgnoreArgument');



var mockControl;
var mockWorker;
var workerChannel;

function setUp() {
  mockControl = new goog.testing.MockControl();
  mockWorker = new goog.events.EventTarget();
  mockWorker.sendMessage = mockControl.createFunctionMock('sendMessage');
  workerChannel = new goog.gears.WorkerChannel(mockWorker);
}

function tearDown() {
  workerChannel.dispose();
  mockControl.$verifyAll();
}

function makeMessage(serviceName, payload) {
  var msg = {serviceName: serviceName, payload: payload};
  msg[goog.gears.WorkerChannel.FLAG] = true;
  return msg;
}

function expectedFn(name, callback) {
  var ignored = new goog.testing.mockmatchers.IgnoreArgument();
  var fn = mockControl.createFunctionMock(name);
  fn(ignored).$does(function(args) {
    callback.apply(this, args);
  });
  return function() { fn(arguments); };
}

function assertEqualsFn() {
  var expectedArgs = Array.prototype.slice.call(arguments);
  return expectedFn('assertEqualsFn', function() {
    assertObjectEquals(expectedArgs, Array.prototype.slice.call(arguments));
  });
}

function expectNoMessage() {
  workerChannel.registerDefaultService(
    mockControl.createFunctionMock('expectNoMessage'));
}

function receiveMessage(serviceName, payload, opt_origin) {
  var msgObject = {body: makeMessage(serviceName, payload)};
  msgObject.origin = opt_origin || 'http://google.com';
  mockWorker.dispatchEvent(
    new goog.gears.WorkerEvent(goog.gears.Worker.EventType.MESSAGE, msgObject));
}

function receiveNonChannelMessage(body) {
  var msgObject = {body: body, origin: 'http://google.com'};
  mockWorker.dispatchEvent(
    new goog.gears.WorkerEvent(goog.gears.Worker.EventType.MESSAGE, msgObject));
}

function testSendMessage() {
  mockWorker.sendMessage(makeMessage('foobar', 'This is a value'));
  mockControl.$replayAll();
  workerChannel.send('foobar', 'This is a value');
}

function testMessageStringToString() {
  var payload = 'This is a string';
  workerChannel.registerService('foobar', assertEqualsFn(payload));
  mockControl.$replayAll();
  receiveMessage('foobar', 'This is a string');
}

function testMessageObjectToObject() {
  var payload = {key: 'value'};
  workerChannel.registerService('foobar', assertEqualsFn(payload), true);
  mockControl.$replayAll();
  receiveMessage('foobar', payload);
}

function testMessageStringToObject() {
  workerChannel.registerService('foobar', assertEqualsFn({key: 'value'}), true);
  mockControl.$replayAll();
  receiveMessage('foobar', '{"key":"value"}');
}

function testMessageObjectToString() {
  workerChannel.registerService('foobar', assertEqualsFn('{"key":"value"}'));
  mockControl.$replayAll();
  receiveMessage('foobar', {key: 'value'});
}

function testNonChannelMessageWithStringBody() {
  expectNoMessage();
  mockControl.$replayAll();
  receiveNonChannelMessage('Foo bar');
}

function testNonChannelMessageWithArrayBody() {
  expectNoMessage();
  mockControl.$replayAll();
  receiveNonChannelMessage([5, 'Foo bar']);
}

function testNonChannelMessageWithNoFlag() {
  expectNoMessage();
  mockControl.$replayAll();
  receiveNonChannelMessage({
    serviceName: 'foobar',
    payload: 'this is a payload'
  });
}

function testNonChannelMessageWithFalseFlag() {
  expectNoMessage();
  mockControl.$replayAll();
  var body = {
    serviceName: 'foobar',
    payload: 'this is a payload'
  };
  body[goog.gears.WorkerChannel.FLAG] = false;
  receiveNonChannelMessage(body);
}

function testMessageWithWrongOriginDomain() {
  workerChannel.peerOrigin = 'http://mail.google.com';
  expectNoMessage();
  mockControl.$replayAll();
  receiveMessage('foobar', 'Foo bar');
}

function testMessageWithWrongOriginPort() {
  workerChannel.peerOrigin = 'http://google.com:123';
  expectNoMessage();
  mockControl.$replayAll();
  receiveMessage('foobar', 'Foo bar');
}

function testMessageWithWrongOriginProtocol() {
  workerChannel.peerOrigin = 'https://google.com';
  expectNoMessage();
  mockControl.$replayAll();
  receiveMessage('foobar', 'Foo bar');
}

function testMessageWithRightOrigin() {
  workerChannel.peerOrigin = 'http://google.com';
  workerChannel.registerService('foobar', assertEqualsFn('Foo bar'));
  mockControl.$replayAll();
  receiveMessage('foobar', 'Foo bar');
}

function testMessageWithRightOriginPort80() {
  workerChannel.peerOrigin = 'http://google.com:80';
  workerChannel.registerService('foobar', assertEqualsFn('Foo bar'));
  mockControl.$replayAll();
  receiveMessage('foobar', 'Foo bar');
}

function testMessageWithRightOriginPort443() {
  workerChannel.peerOrigin = 'https://google.com:443';
  workerChannel.registerService('foobar', assertEqualsFn('Foo bar'));
  mockControl.$replayAll();
  receiveMessage('foobar', 'Foo bar', 'https://google.com');
}

function testDefaultServiceWithString() {
  workerChannel.registerDefaultService(assertEqualsFn('foobar', 'Foo bar'));
  mockControl.$replayAll();
  receiveMessage('foobar', 'Foo bar');
}

function testDefaultServiceWithObject() {
  var payload = {key: 'value'};
  workerChannel.registerDefaultService(assertEqualsFn('foobar', payload));
  mockControl.$replayAll();
  receiveMessage('foobar', payload);
}

">n/a</td></tr>
<tr><td>fakeworkerpool_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.gears.FakeWorkerPool');
  goog.require('goog.gears.Worker.EventType');
  goog.require('goog.net.XmlHttp');
  goog.require('goog.testing.jsunit');



var ONE = 1
var TWO = 2
var THREE = 3;

/*
 * Every message should be a JSON string
 */
google.gears.workerPool.onmessage = function(message, sender,
                                             opt_messageObject) {
  var obj;
  if (opt_messageObject && 'body' in opt_messageObject) {
    obj = opt_messageObject['body'];
  } else {
    obj = eval('(' + message + ')');
  }
  var commandId = obj[0];
  var params = obj[1];
  if (commandId == ONE) {
    google.gears.workerPool.sendMessage([1, ['one', params.toUpperCase()]],
                                        sender);
  } else if (commandId == TWO) {
    google.gears.workerPool.sendMessage([2, ['two', params.toUpperCase()]],
                                        sender);
  } else if (commandId == THREE) {
    google.gears.workerPool.sendMessage([3, ['three', params.toUpperCase()]],
                                        sender);
  }
};




var ONE = 1
var TWO = 2
var THREE = 3;

// Mock out XHR for createWorkerFromUrl().
goog.net.XmlHttp = function() {};
goog.net.XmlHttp.prototype.open = function(method, url, async) {};
goog.net.XmlHttp.prototype.send = function(data) {
  this.responseText = workerTestCase.getWorkerCode();
};

// Create a new test case.
var workerTestCase = new goog.testing.TestCase(document.title);

/** True once the test environment is set up. */
workerTestCase.isSetUp = false;

/** True once the page is ready for the test to be run. */
workerTestCase.isReady = false;

/** The number of tests recieved from the worker pool. */
workerTestCase.resultCount = 0;

/** Array of test results */
workerTestCase.results = [];

/** Array of tests */
workerTestCase.tests = [
  [ONE, 'one', 'ONE'],
  [TWO, 'two', 'TWO'],
  [THREE, 'three', 'THREE']
];

/** Sets up the test environment, adds tests and sets up the worker pools. */
workerTestCase.setUpTests = function() {
  this.log('Setting tests up');

  this.add(new goog.testing.TestCase.Test(
      'test worker results', this.testResults, this));

  this.isSetUp = true;

  var workerPool = new goog.gears.FakeWorkerPool;

  var worker = workerPool.createWorker(this.getWorkerCode());
  goog.events.listen(worker, goog.gears.Worker.EventType.MESSAGE, this);

  var workerFromUrl = workerPool.createWorkerFromUrl('dummyUrl');
  goog.events.listen(workerFromUrl, goog.gears.Worker.EventType.MESSAGE, this);

  var workers = [worker, worker, workerFromUrl];

  for (var i = 0; i < this.tests.length; i++) {
    workers[i].sendMessage([this.tests[i][0], this.tests[i][1]]);
  }
};

/** Gets the worker code. */
workerTestCase.getWorkerCode = function() {
  return document.getElementById('workercode').innerHTML;
};


/** Handles the worker's MESSAGE event . */
workerTestCase.handleEvent = function(e) {
  this.log('HandleEvent, type: ' + e.type + ', message: ' + e.message);
  if (e.type == goog.gears.Worker.EventType.MESSAGE) {
    var commandId = e.message[0];
    var params = e.message[1];
    this.handleCommand(commandId, params);
  }
};

/** Handles a command . */
workerTestCase.handleCommand = function(commandId, params) {
  //debug('receiving command: commandId=' + commandId + ', params=' + params);
  this.results.push([commandId, params[0], params[1]]);
  this.resultCount++;
  if (this.resultCount >= this.tests.length) {
    // Backwards compatability for JsUnit to start tests
    setUpPageStatus = 'complete';
    this.isReady = true;
  }
};

/** Tests the results. */
workerTestCase.testResults = function() {
  this.log('Starting testResults');

  // TODO(user): This test is intermitently failing in IE7.
  return;

  for (var i = 0; i < this.tests.length; i++) {
    for (var j = 0; j < this.tests[i].length; j++) {
      assertEquals(this.tests[i][j], this.results[i][j]);
    }
  }
};

/** Waits until the tests are ready to begin, before running them. */
workerTestCase.runTests = function() {
  if (!this.isSetUp) {
    this.setUpTests();
  }
  if (this.isReady) {
    this.execute();
  } else {
    this.log('Not ready, waiting');
    // Try again in 100ms
    setTimeout('workerTestCase.runTests()', 100);
  }
};

/** Used by the JsUnit test runner. */
function testResults() {
  workerTestCase.testResults();
}

/** Used by the JsUnit test runner. */
function setUpPage() {
  workerTestCase.runTests();
}

/** Standalone Closure Test Runner. */
if (typeof G_testRunner != 'undefined') {
  G_testRunner.initialize(workerTestCase);
}


">ReferenceError: google is not defined
    at _tmpclosuretest.js:17:1
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
    at Module.load (module.js:219:31)
    at Function._load (module.js:186:10)
</td></tr>
<tr><td>multichannel_test.html</td><td>Success</td><td> 8 passed, 0 failed.</td><td title="

  goog.require('goog.testing.MockControl');
  goog.require('goog.testing.messaging.MockMessageChannel');
  goog.require('goog.testing.mockmatchers.IgnoreArgument');
  goog.require('goog.testing.jsunit');
  goog.require('goog.messaging.MultiChannel');



var mockControl;
var mockChannel;
var multiChannel;
var channel1;
var channel2;

function setUp() {
  mockControl = new goog.testing.MockControl();
  mockChannel = new goog.testing.messaging.MockMessageChannel(mockControl);
  multiChannel = new goog.messaging.MultiChannel(mockChannel);
  channel0 = multiChannel.createVirtualChannel('foo');
  channel1 = multiChannel.createVirtualChannel('bar');
}

function expectedFn(name, callback) {
  var ignored = new goog.testing.mockmatchers.IgnoreArgument();
  var fn = mockControl.createFunctionMock(name);
  fn(ignored).$does(function(args) {
    callback.apply(this, args);
  });
  return function() { fn(arguments); };
}

function notExpectedFn() {
  return mockControl.createFunctionMock('notExpectedFn');
}

function assertEqualsFn() {
  var expectedArgs = Array.prototype.slice.call(arguments);
  return expectedFn('assertEqualsFn', function() {
    assertObjectEquals(expectedArgs, Array.prototype.slice.call(arguments));
  });
}

function tearDown() {
  multiChannel.dispose();
  mockControl.$verifyAll();
  assertTrue(mockChannel.disposed);
}

function testSend0() {
  mockChannel.send('foo:fooBar', {foo: 'bar'});
  mockControl.$replayAll();
  channel0.send('fooBar', {foo: 'bar'});
}

function testSend1() {
  mockChannel.send('bar:fooBar', {foo: 'bar'});
  mockControl.$replayAll();
  channel1.send('fooBar', {foo: 'bar'});
}

function testReceive0() {
  channel0.registerService('fooBar', assertEqualsFn('Baz bang'));
  channel1.registerService('fooBar', notExpectedFn());
  mockControl.$replayAll();
  mockChannel.receive('foo:fooBar', 'Baz bang');
}

function testReceive1() {
  channel1.registerService('fooBar', assertEqualsFn('Baz bang'));
  channel0.registerService('fooBar', notExpectedFn());
  mockControl.$replayAll();
  mockChannel.receive('bar:fooBar', 'Baz bang');
}

function testDefaultReceive0() {
  channel0.registerDefaultService(assertEqualsFn('fooBar', 'Baz bang'));
  channel1.registerDefaultService(notExpectedFn());
  mockControl.$replayAll();
  mockChannel.receive('foo:fooBar', 'Baz bang');
}

function testDefaultReceive1() {
  channel1.registerDefaultService(assertEqualsFn('fooBar', 'Baz bang'));
  channel0.registerDefaultService(notExpectedFn());
  mockControl.$replayAll();
  mockChannel.receive('bar:fooBar', 'Baz bang');
}

function testReceiveAfterDisposed() {
  channel0.registerService('fooBar', notExpectedFn());
  mockControl.$replayAll();
  channel0.dispose();
  mockChannel.receive('foo:fooBar', 'Baz bang');
}

function testReceiveAfterParentDisposed() {
  channel0.registerService('fooBar', notExpectedFn());
  mockControl.$replayAll();
  multiChannel.dispose();
  mockChannel.receive('foo:fooBar', 'Baz bang');
}
">n/a</td></tr>
<tr><td>messaging_test.html</td><td>Success</td><td> 1 passed, 0 failed.</td><td title="

  goog.require('goog.messaging');
  goog.require('goog.testing.MockControl');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.messaging.MockMessageChannel');



function testPipe() {
  var mockControl = new goog.testing.MockControl();
  var ch1 = new goog.testing.messaging.MockMessageChannel(mockControl);
  var ch2 = new goog.testing.messaging.MockMessageChannel(mockControl);
  ch1.send('ping', 'HELLO');
  ch2.send('pong', {key: 'value'});
  goog.messaging.pipe(ch1, ch2);

  mockControl.$replayAll();
  ch2.receive('ping', 'HELLO');
  ch1.receive('pong', {key: 'value'});
  mockControl.$verifyAll();
}

">n/a</td></tr>
<tr><td>portchannel_test.html</td><td>Success</td><td> 17 passed, 0 failed.</td><td title="


goog.require('goog.dom');
goog.require('goog.events.EventTarget');
goog.require('goog.messaging.PortChannel');
goog.require('goog.testing.AsyncTestCase');
goog.require('goog.testing.MockControl');
goog.require('goog.testing.async.MockControl');
goog.require('goog.testing.jsunit');
goog.require('goog.testing.messaging.MockMessageEvent');



var mockControl;
var asyncMockControl;
var mockPort;
var portChannel;

var workerChannel;
var asyncTestCase = goog.testing.AsyncTestCase.createAndInstall();

// Use a relatively long timeout because workers can take a while to start up.
asyncTestCase.stepTimeout = 3 * 1000;

function setUpPage() {
  workerChannel = new goog.messaging.PortChannel(
      new Worker('testdata/portchannel_worker.js'));
}

function tearDownPage() {
  goog.dispose(workerChannel);
}

function setUp() {
  mockControl = new goog.testing.MockControl();
  asyncMockControl = new goog.testing.async.MockControl(mockControl);
  mockPort = new goog.events.EventTarget();
  mockPort.postMessage = mockControl.createFunctionMock('postMessage');
  portChannel = new goog.messaging.PortChannel(mockPort);
}

function tearDown() {
  portChannel.dispose();
  mockControl.$verifyAll();
}

function makeMessage(serviceName, payload) {
  var msg = {'serviceName': serviceName, 'payload': payload};
  msg[goog.messaging.PortChannel.FLAG] = true;
  return msg;
}

function expectNoMessage() {
  portChannel.registerDefaultService(
    mockControl.createFunctionMock('expectNoMessage'));
}

function receiveMessage(serviceName, payload, opt_origin, opt_ports) {
  mockPort.dispatchEvent(
      goog.testing.messaging.MockMessageEvent.wrap(
          makeMessage(serviceName, payload),
          opt_origin || 'http://google.com',
          undefined, undefined, opt_ports));
}

function receiveNonChannelMessage(data) {
  mockPort.dispatchEvent(
      goog.testing.messaging.MockMessageEvent.wrap(
          data, 'http://google.com'));
}

function testPostMessage() {
  mockPort.postMessage(makeMessage('foobar', 'This is a value'), [], null);
  mockControl.$replayAll();
  portChannel.send('foobar', 'This is a value');
}

function testPostMessageWithPorts() {
  if (!('MessageChannel' in goog.global)) {
    return;
  }
  var channel = new MessageChannel();
  var port1 = channel.port1;
  var port2 = channel.port2;
  mockPort.postMessage(makeMessage('foobar', {'val': [
    {'_port': {'type': 'real', 'index': 0}},
    {'_port': {'type': 'real', 'index': 1}}
  ]}), [port1, port2], null);
  mockControl.$replayAll();
  portChannel.send('foobar', {'val': [port1, port2]});
}

function testReceiveMessage() {
  portChannel.registerService(
      'foobar', asyncMockControl.asyncAssertEquals(
          'testReceiveMessage', 'This is a string'));
  mockControl.$replayAll();
  receiveMessage('foobar', 'This is a string');
}

function testReceiveMessageWithPorts() {
  if (!('MessageChannel' in goog.global)) {
    return;
  }
  var channel = new MessageChannel();
  var port1 = channel.port1;
  var port2 = channel.port2;
  portChannel.registerService(
      'foobar', asyncMockControl.asyncAssertEquals(
          'testReceiveMessage', {'val': [port1, port2]}),
      true);
  mockControl.$replayAll();
  receiveMessage('foobar', {'val': [
    {'_port': {'type': 'real', 'index': 0}},
    {'_port': {'type': 'real', 'index': 1}}
  ]}, null, [port1, port2]);
}

function testReceiveNonChannelMessageWithStringBody() {
  expectNoMessage();
  mockControl.$replayAll();
  receiveNonChannelMessage('Foo bar');
}

function testReceiveNonChannelMessageWithArrayBody() {
  expectNoMessage();
  mockControl.$replayAll();
  receiveNonChannelMessage([5, 'Foo bar']);
}

function testReceiveNonChannelMessageWithNoFlag() {
  expectNoMessage();
  mockControl.$replayAll();
  receiveNonChannelMessage({
    serviceName: 'foobar',
    payload: 'this is a payload'
  });
}

function testReceiveNonChannelMessageWithFalseFlag() {
  expectNoMessage();
  mockControl.$replayAll();
  var body = {
    serviceName: 'foobar',
    payload: 'this is a payload'
  };
  body[goog.messaging.PortChannel.FLAG] = false;
  receiveNonChannelMessage(body);
}

function testReceiveMessageWithWrongOrigin() {
  goog.dispose(portChannel);
  portChannel =
      new goog.messaging.PortChannel(mockPort, 'http://mail.google.com');
  expectNoMessage();
  mockControl.$replayAll();
  receiveMessage('foobar', 'Foo bar');
}

function testReceiveMessageWithAnyExpectedOrigin() {
  goog.dispose(portChannel);
  portChannel = new goog.messaging.PortChannel(mockPort, '*');
  portChannel.registerService(
      'foobar', asyncMockControl.asyncAssertEquals(
          'testReceiveMessage', 'Foo bar'));
  mockControl.$replayAll();
  receiveMessage('foobar', 'Foo bar');
}

// Integration tests

function testWorker() {
  if (!('Worker' in goog.global)) {
    return;
  }
  workerChannel.registerService('pong', function(msg) {
    assertObjectEquals({'val': 'fizzbang'}, msg);
    asyncTestCase.continueTesting();
  }, true);
  workerChannel.send('ping', {'val': 'fizzbang'});
  asyncTestCase.waitForAsync('worker response');
}

function testWorkerWithPorts() {
  if (!('Worker' in goog.global) || !('MessageChannel' in goog.global)) {
    return;
  }
  var messageChannel = new MessageChannel();
  workerChannel.registerService('pong', function(msg) {
    assertPortsEntangled(msg['port'], messageChannel.port2, function() {
      asyncTestCase.continueTesting();
    });
  }, true);
  workerChannel.send('ping', {'port': messageChannel.port1});
  asyncTestCase.waitForAsync('worker response');
}

function testPort() {
  if (!('Worker' in goog.global) || !('MessageChannel' in goog.global)) {
    return;
  }
  var messageChannel = new MessageChannel();
  workerChannel.send('addPort', messageChannel.port1);
  messageChannel.port2.start();
  var realPortChannel = new goog.messaging.PortChannel(messageChannel.port2);
  realPortChannel.registerService('pong', function(msg) {
    assertObjectEquals({'val': 'fizzbang'}, msg);

    messageChannel.port2.close();
    realPortChannel.dispose();
    asyncTestCase.continueTesting();
  }, true);
  realPortChannel.send('ping', {'val': 'fizzbang'});
  asyncTestCase.waitForAsync('port response');
}

function testPortIgnoresOrigin() {
  if (!('Worker' in goog.global) || !('MessageChannel' in goog.global)) {
    return;
  }
  var messageChannel = new MessageChannel();
  workerChannel.send('addPort', messageChannel.port1);
  messageChannel.port2.start();
  var realPortChannel = new goog.messaging.PortChannel(
      messageChannel.port2, 'http://somewhere-else.com');
  realPortChannel.registerService('pong', function(msg) {
    assertObjectEquals({'val': 'fizzbang'}, msg);

    messageChannel.port2.close();
    realPortChannel.dispose();
    asyncTestCase.continueTesting();
  }, true);
  realPortChannel.send('ping', {'val': 'fizzbang'});
  asyncTestCase.waitForAsync('port response');
}

function testWindow() {
  if (!('Worker' in goog.global)) {
    return;
  }
  withIframe(function() {
    var iframeChannel =
        new goog.messaging.PortChannel(window.frames['inner'], '*');
    iframeChannel.registerService('pong', function(msg) {
      assertEquals('fizzbang', msg);

      iframeChannel.dispose();
      asyncTestCase.continueTesting();
    });
    iframeChannel.send('ping', 'fizzbang');
    asyncTestCase.waitForAsync('window response');
  });
}

function testWindowWontSendToWrongOrigin() {
  if (!('Worker' in goog.global)) {
    return;
  }
  withIframe(function() {
    var iframeChannel = new goog.messaging.PortChannel(
        window.frames['inner'], 'http://somewhere-else.com');
    iframeChannel.registerService('pong', function(msg) {
      fail('Should not receive pong from unexpected origin');
      iframeChannel.dispose();
      asyncTestCase.continueTesting();
    });
    iframeChannel.send('ping', 'fizzbang');

    setTimeout(function() {
      asyncTestCase.continueTesting();
    }, asyncTestCase.stepTimeout - 500);
    asyncTestCase.waitForAsync('window response');
  });
}

function testWindowWontReceiveFromWrongOrigin() {
  if (!('Worker' in goog.global)) {
    return;
  }
  withIframe(function() {
    var iframeChannel =
        new goog.messaging.PortChannel(window.frames['inner'], '*');
    iframeChannel.registerService('pong', function(msg) {
      fail('Should not receive pong from unexpected origin');
      iframeChannel.dispose();
      asyncTestCase.continueTesting();
    });
    iframeChannel.send('ping', 'fizzbang');
    iframeChannel.peerOrigin = 'http://somewhere-else.com';

    setTimeout(function() {
      asyncTestCase.continueTesting();
    }, asyncTestCase.stepTimeout - 500);
    asyncTestCase.waitForAsync('window response');
  });
}

/**
 * Assert that two HTML5 MessagePorts are entangled by posting messages from
 * each to the other.
 *
 * @param {!MessagePort} port1
 * @param {!MessagePort} port2
 * @param {function()} callback Called when the assertion is finished.
 */
function assertPortsEntangled(port1, port2, callback) {
  port1.onmessage = function(e) {
    assertEquals('port 2 should send messages to port 1',
                 'port2 to port1', e.data);
    callback();
  };

  port2.onmessage = function(e) {
    assertEquals('port 1 should send messages to port 2',
                 'port1 to port2', e.data);
    port2.postMessage('port2 to port1');
    asyncTestCase.waitForAsync('port 1 receiving message');
  };

  port1.postMessage('port1 to port2');
  asyncTestCase.waitForAsync('port 2 receiving message');
}

function withIframe(callback) {
  var frameDiv = goog.dom.$('frame');
  goog.dom.removeChildren(frameDiv);
  goog.dom.appendChild(frameDiv, goog.dom.createDom('iframe', {
    style: 'display: none',
    name: 'inner',
    id: 'inner',
    src: 'testdata/portchannel_inner.html'
  }));

  // We need to pass control back to the event loop to give the iframe a chance
  // to load.
  setTimeout(callback, 0);
}

">n/a</td></tr>
<tr><td>deferredchannel_test.html</td><td>Success</td><td> 8 passed, 0 failed.</td><td title="


goog.require('goog.async.Deferred');
goog.require('goog.messaging.DeferredChannel');
goog.require('goog.testing.MockControl');
goog.require('goog.testing.async.MockControl');
goog.require('goog.testing.jsunit');
goog.require('goog.testing.messaging.MockMessageChannel');



var mockControl, asyncMockControl;
var mockChannel, deferredChannel;
var deferred;

function setUp() {
  mockControl = new goog.testing.MockControl();
  asyncMockControl = new goog.testing.async.MockControl(mockControl);
  mockChannel = new goog.testing.messaging.MockMessageChannel(mockControl);
  deferred = new goog.async.Deferred();
  deferredChannel = new goog.messaging.DeferredChannel(deferred);
}

function tearDown() {
  mockControl.$verifyAll();
}

function testDeferredResolvedBeforeSend() {
  mockChannel.send('test', 'val');
  mockControl.$replayAll();
  deferred.callback(mockChannel);
  deferredChannel.send('test', 'val');
}

function testDeferredResolvedBeforeRegister() {
  deferred.callback(mockChannel);
  deferredChannel.registerService(
      'test', asyncMockControl.asyncAssertEquals('passes on register', 'val'));
  mockChannel.receive('test', 'val');
}

function testDeferredResolvedBeforeRegisterObject() {
  deferred.callback(mockChannel);
  deferredChannel.registerService(
      'test',
      asyncMockControl.asyncAssertEquals('passes on register', {'key': 'val'}),
      true);
  mockChannel.receive('test', {'key': 'val'});
}

function testDeferredResolvedBeforeRegisterDefault() {
  deferred.callback(mockChannel);
  deferredChannel.registerDefaultService(
      asyncMockControl.asyncAssertEquals('passes on register', 'test', 'val'));
  mockChannel.receive('test', 'val');
}

function testDeferredResolvedAfterSend() {
  mockChannel.send('test', 'val');
  mockControl.$replayAll();
  deferredChannel.send('test', 'val');
  deferred.callback(mockChannel);
}

function testDeferredResolvedAfterRegister() {
  deferredChannel.registerService(
      'test', asyncMockControl.asyncAssertEquals('passes on register', 'val'));
  deferred.callback(mockChannel);
  mockChannel.receive('test', 'val');
}

function testDeferredResolvedAfterRegisterObject() {
  deferredChannel.registerService(
      'test',
      asyncMockControl.asyncAssertEquals('passes on register', {'key': 'val'}),
      true);
  deferred.callback(mockChannel);
  mockChannel.receive('test', {'key': 'val'});
}

function testDeferredResolvedAfterRegisterDefault() {
  deferredChannel.registerDefaultService(
      asyncMockControl.asyncAssertEquals('passes on register', 'test', 'val'));
  deferred.callback(mockChannel);
  mockChannel.receive('test', 'val');
}

">n/a</td></tr>
<tr><td>bufferedchannel_test.html</td><td>Fail</td><td> 1 passed, 4 failed.</td><td title="


  goog.require('goog.debug.Console');
  goog.require('goog.debug.Logger');
  goog.require('goog.dom');
  goog.require('goog.events.Event');
  goog.require('goog.messaging.BufferedChannel');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.MockControl');
  goog.require('goog.testing.async.MockControl');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.messaging.MockMessageChannel');



if (goog.global.console) new goog.debug.Console().setCapturing(true);

var clock = new goog.testing.MockClock();
var messages = [
  {serviceName: 'firstService', payload: 'firstPayload'},
  {serviceName: 'secondService', payload: 'secondPayload'}
];
var mockControl = new goog.testing.MockControl();
var asyncMockControl = new goog.testing.async.MockControl(mockControl);


function setUpPage() {
  var logger = goog.debug.Logger.getLogger('goog.messaging');
  logger.setLevel(goog.debug.Logger.Level.ALL);
  logger.addHandler(function(logRecord) {
    var msg = goog.dom.createDom('div');
    msg.innerHTML = logRecord.getMessage();
    goog.dom.appendChild(goog.dom.getElement('debug-div'), msg);
  });
}


function setUp() {
  clock.install();
}


function tearDown() {
  clock.uninstall();
  mockControl.$tearDown();
}


function assertMessageArraysEqual(ma1, ma2) {
  assertEquals('message array lengths differ', ma1.length, ma2.length);
  for (var i = 0; i < ma1.length; i++) {
    assertEquals(
        'message array serviceNames differ',
        ma1[i].serviceName, ma2[i].serviceName);
    assertEquals(
        'message array payloads differ',
        ma1[i].payload, ma2[i].payload);
  }
}


function testDelegationToWrappedChannel() {
  var mockChannel = new goog.testing.messaging.MockMessageChannel(mockControl);
  var channel = new goog.messaging.BufferedChannel(mockChannel);

  channel.registerDefaultService(
      asyncMockControl.asyncAssertEquals(
          'default service should be delegated',
          'defaultServiceName', 'default service payload'));
  channel.registerService(
      'normalServiceName',
      asyncMockControl.asyncAssertEquals(
          'normal service should be delegated',
          'normal service payload'));
  mockChannel.send(
      goog.messaging.BufferedChannel.USER_CHANNEL_NAME_ + ':message',
      'payload');

  mockControl.$replayAll();
  channel.peerReady_ = true;  // Prevent buffering so we delegate send calls.
  mockChannel.receive(
      goog.messaging.BufferedChannel.USER_CHANNEL_NAME_ + ':defaultServiceName',
      'default service payload');
  mockChannel.receive(
      goog.messaging.BufferedChannel.USER_CHANNEL_NAME_ + ':normalServiceName',
      'normal service payload');
  channel.send('message', 'payload');
  mockControl.$verifyAll();
}


function testOptionalConnectCallbackExecutes() {
  var mockChannel = new goog.testing.messaging.MockMessageChannel(mockControl);
  var channel = new goog.messaging.BufferedChannel(mockChannel);
  var mockConnectCb = mockControl.createFunctionMock('mockConnectCb');
  mockConnectCb();

  mockControl.$replayAll();
  channel.connect(mockConnectCb);
  mockControl.$verifyAll();
}


function testSendExceptionsInOnTickStopsTimerAndReraises() {
  var mockChannel = new goog.testing.messaging.MockMessageChannel(mockControl);
  var channel = new goog.messaging.BufferedChannel(mockChannel);

  var errorMessage = 'errorMessage';
  mockChannel.send(
      goog.messaging.BufferedChannel.CONTROL_CHANNEL_NAME_ + ':' +
        goog.messaging.BufferedChannel.PEER_READY_SERVICE_NAME_,
      /* payload */ '').$throws(Error(errorMessage));
  channel.timer_.enabled = true;

  mockControl.$replayAll();
  var exception = assertThrows(function() {
    channel.onTick_(goog.events.Event('unusedEvent'));
  });
  assertContains(errorMessage, exception.message);
  assertFalse(channel.timer_.enabled);
  mockControl.$verifyAll();
}


function testPollingIntervalDefaultAndOverride() {
  var mockChannel = new goog.testing.messaging.MockMessageChannel(mockControl);
  var channel = new goog.messaging.BufferedChannel(mockChannel);

  assertEquals(
      goog.messaging.BufferedChannel.DEFAULT_INTERVAL_MILLIS_,
      channel.timer_.getInterval());
  var interval = 100;
  var longIntervalChannel = new goog.messaging.BufferedChannel(
      new goog.testing.messaging.MockMessageChannel(mockControl), interval);
  assertEquals(interval, longIntervalChannel.timer_.getInterval());
}


function testBidirectionalCommunicationBuffersUntilReadyPingsSucceed() {
  var mockChannel1 = new goog.testing.messaging.MockMessageChannel(mockControl);
  var mockChannel2 = new goog.testing.messaging.MockMessageChannel(mockControl);
  var bufferedChannel1 = new goog.messaging.BufferedChannel(mockChannel1);
  var bufferedChannel2 = new goog.messaging.BufferedChannel(mockChannel2);
  mockChannel1.send(
      goog.messaging.BufferedChannel.CONTROL_CHANNEL_NAME_ + ':setPeerReady_',
      '').$does(function() {
    bufferedChannel1.setPeerReady_();
  });
  mockChannel2.send(
      goog.messaging.BufferedChannel.CONTROL_CHANNEL_NAME_ + ':setPeerReady_',
      '').$does(function() {
    bufferedChannel2.setPeerReady_();
  });
  mockChannel1.send(goog.messaging.BufferedChannel.USER_CHANNEL_NAME_ + ':' +
                    messages[0].serviceName,
                    messages[0].payload);
  mockChannel2.send(goog.messaging.BufferedChannel.USER_CHANNEL_NAME_ + ':' +
                    messages[1].serviceName,
                    messages[1].payload);

  mockControl.$replayAll();
  bufferedChannel1.send(messages[0].serviceName, messages[0].payload);
  bufferedChannel2.send(messages[1].serviceName, messages[1].payload);
  assertMessageArraysEqual([messages[0]], bufferedChannel1.buffer_);
  assertMessageArraysEqual([messages[1]], bufferedChannel2.buffer_);
  // First tick causes setPeerReady_ to fire, which in turn flushes the buffers.
  clock.tick(goog.messaging.BufferedChannel.DEFAULT_INTERVAL_MILLIS_);
  assertEquals(bufferedChannel1.buffer_, null);
  assertEquals(bufferedChannel2.buffer_, null);
  // Now that peers are ready, a second tick causes no more sends.
  clock.tick(goog.messaging.BufferedChannel.DEFAULT_INTERVAL_MILLIS_);
  mockControl.$verifyAll();
}


">5 of 5 tests run in 14ms.<br />1 passed, 4 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testBidirectionalCommunicationBuffersUntilReadyPingsSucceed<br />Object #<Object> has no method 'createElement'<br />ERROR in testDelegationToWrappedChannel<br />Missing a call to send<br />Expected: 1 but was: 0<br />ERROR in testOptionalConnectCallbackExecutes<br />Missing a call to send<br />Expected: 1 but was: 0<br />ERROR in testSendExceptionsInOnTickStopsTimerAndReraises<br />Missing a call to send<br />Expected: 1 but was: 0<br /></td></tr>
<tr><td>abstractchannel_test.html</td><td>Success</td><td> 6 passed, 0 failed.</td><td title="


goog.require('goog.testing.MockControl');
goog.require('goog.testing.async.MockControl');
goog.require('goog.messaging.AbstractChannel');
goog.require('goog.testing.jsunit');



var mockControl;
var mockWorker;
var asyncMockControl;
var channel;

function setUp() {
  mockControl = new goog.testing.MockControl();
  asyncMockControl = new goog.testing.async.MockControl(mockControl);
  channel = new goog.messaging.AbstractChannel();
}

function tearDown() {
  channel.dispose();
  mockControl.$verifyAll();
}

function testConnect() {
  channel.connect(
      asyncMockControl.createCallbackMock('connectCallback', function() {}));
}

function testIsConnected() {
  assertTrue('Channel should be connected by default', channel.isConnected());
}

function testDeliverString() {
  channel.registerService(
      'foo',
      asyncMockControl.asyncAssertEquals(
          'should pass string to service', 'bar'),
      false /* opt_json */);
  channel.deliver('foo', 'bar');
}

function testDeliverDeserializedString() {
  channel.registerService(
      'foo',
      asyncMockControl.asyncAssertEquals(
          'should pass string to service', '{"bar":"baz"}'),
      false /* opt_json */);
  channel.deliver('foo', {bar: 'baz'});
}

function testDeliverObject() {
  channel.registerService(
      'foo',
      asyncMockControl.asyncAssertEquals(
          'should pass string to service', {bar: 'baz'}),
      true /* opt_json */);
  channel.deliver('foo', {bar: 'baz'});
}

function testDeliverSerializedObject() {
  channel.registerService(
      'foo',
      asyncMockControl.asyncAssertEquals(
          'should pass string to service', {bar: 'baz'}),
      true /* opt_json */);
  channel.deliver('foo', '{"bar":"baz"}');
}

">n/a</td></tr>
<tr><td>message_test.html</td><td>Success</td><td> 17 passed, 0 failed.</td><td title="

  goog.require('goog.proto2.Message');
  goog.require('goog.testing.jsunit');
  goog.require('proto2.TestAllTypes');
  goog.require('proto2.TestAllTypes.NestedEnum');
  goog.require('proto2.TestAllTypes.NestedMessage');
  goog.require('proto2.TestAllTypes.OptionalGroup');
  goog.require('proto2.TestAllTypes.RepeatedGroup');



function testEqualsWithEmptyMessages() {
  var message1 = new proto2.TestAllTypes();
  assertTrue('same message object', message1.equals(message1));
  assertFalse('comparison with null', message1.equals(null));
  assertFalse('comparison with undefined', message1.equals(undefined));

  var message2 = new proto2.TestAllTypes();
  assertTrue('two empty message objects', message1.equals(message2));

  var message3 = new proto2.TestAllTypes.NestedMessage()
  assertFalse('different message types', message3.equals(message1));
}

function testEqualsWithSingleInt32Field() {
  var message1 = new proto2.TestAllTypes();
  var message2 = new proto2.TestAllTypes();

  message1.setOptionalInt32(1);
  assertFalse('message1 has an extra int32 field', message1.equals(message2));

  message2.setOptionalInt32(1);
  assertTrue('same int32 field in both messages', message1.equals(message2));

  message2.setOptionalInt32(2);
  assertFalse('different int32 field', message1.equals(message2));

  message1.clearOptionalInt32();
  assertFalse('message2 has an extra int32 field', message1.equals(message2));
}

function testEqualsWithRepeatedInt32Fields() {
  var message1 = new proto2.TestAllTypes();
  var message2 = new proto2.TestAllTypes();

  message1.addRepeatedInt32(0);
  message2.addRepeatedInt32(0);
  assertTrue('equal repeated int32 field', message1.equals(message2));

  message1.addRepeatedInt32(1);
  assertFalse('message1 has more items', message1.equals(message2));

  message2.addRepeatedInt32(1);
  message2.addRepeatedInt32(1);
  assertFalse('message2 has more items', message1.equals(message2));

  message1.addRepeatedInt32(2);
  assertFalse('different int32 items', message1.equals(message2));
}

function testEqualsWithDefaultValue() {
  var message1 = new proto2.TestAllTypes();
  var message2 = new proto2.TestAllTypes();
  message1.setOptionalInt64('1');

  assertEquals('message1.getOptionalInt64OrDefault should return 1',
      '1', message1.getOptionalInt64OrDefault());
  assertEquals('message2.getOptionalInt64OrDefault should return 1 too',
      '1', message2.getOptionalInt64OrDefault());
  assertTrue('message1.hasOptionalInt64() should be true',
      message1.hasOptionalInt64());
  assertFalse('message2.hasOptionalInt64() should be false',
      message2.hasOptionalInt64());
  assertFalse('as a result they are not equal', message1.equals(message2));
}

function testEqualsWithOptionalGroup() {
  var message1 = new proto2.TestAllTypes();
  var message2 = new proto2.TestAllTypes();
  var group1 = new proto2.TestAllTypes.OptionalGroup();
  var group2 = new proto2.TestAllTypes.OptionalGroup();

  message1.setOptionalgroup(group1);
  assertFalse('only message1 has OptionalGroup field',
      message1.equals(message2));

  message2.setOptionalgroup(group2);
  assertTrue('both messages have OptionalGroup field',
      message1.equals(message2));

  group1.setA(0);
  group2.setA(1);
  assertFalse('different value in the optional group',
      message1.equals(message2));

  message1.clearOptionalgroup();
  assertFalse('only message2 has OptionalGroup field',
      message1.equals(message2));
}

function testEqualsWithRepeatedGroup() {
  var message1 = new proto2.TestAllTypes();
  var message2 = new proto2.TestAllTypes();
  var group1 = new proto2.TestAllTypes.RepeatedGroup();
  var group2 = new proto2.TestAllTypes.RepeatedGroup();

  message1.addRepeatedgroup(group1);
  assertFalse('message1 has more RepeatedGroups',
      message1.equals(message2));

  message2.addRepeatedgroup(group2);
  assertTrue('both messages have one RepeatedGroup',
      message1.equals(message2));

  group1.addA(1);
  assertFalse('message1 has more int32s in RepeatedGroup',
      message1.equals(message2));

  group2.addA(1);
  assertTrue('both messages have one int32 in RepeatedGroup',
      message1.equals(message2));

  group1.addA(1);
  group2.addA(2);
  assertFalse('the messages have different int32s in RepeatedGroup',
      message1.equals(message2));
}

function testEqualsWithNestedMessage() {
  var message1 = new proto2.TestAllTypes();
  var message2 = new proto2.TestAllTypes();
  var nested1 = new proto2.TestAllTypes.NestedMessage();
  var nested2 = new proto2.TestAllTypes.NestedMessage();

  message1.setOptionalNestedMessage(nested1);
  assertFalse('only message1 has nested message', message1.equals(message2));

  message2.setOptionalNestedMessage(nested2);
  assertTrue('both messages have nested message', message1.equals(message2));

  nested1.setB(1);
  assertFalse('different int32 in the nested messages',
      message1.equals(message2));

  message1.clearOptionalNestedMessage();
  assertFalse('only message2 has nested message', message1.equals(message2));
}

function testEqualsWithNestedEnum() {
  var message1 = new proto2.TestAllTypes();
  var message2 = new proto2.TestAllTypes();

  message1.setOptionalNestedEnum(proto2.TestAllTypes.NestedEnum.FOO);
  assertFalse('only message1 has nested enum', message1.equals(message2));

  message2.setOptionalNestedEnum(proto2.TestAllTypes.NestedEnum.FOO);
  assertTrue('both messages have nested enum', message1.equals(message2));

  message2.setOptionalNestedEnum(proto2.TestAllTypes.NestedEnum.BAR);
  assertFalse('different enum value', message1.equals(message2));

  message1.clearOptionalNestedEnum();
  assertFalse('only message2 has nested enum', message1.equals(message2));
}

function testEqualsWithUnknownFields() {
  var message1 = new proto2.TestAllTypes();
  var message2 = new proto2.TestAllTypes();
  message1.setUnknown(999, 'foo');
  message1.setUnknown(999, 'bar');
  assertTrue('unknown fields are ignored', message1.equals(message2));
}

function testCloneEmptyMessage() {
  var message = new proto2.TestAllTypes();
  var clone = message.clone();
  assertObjectEquals('cloned empty message', message, clone);
}

function testCloneMessageWithSeveralFields() {
  var message = new proto2.TestAllTypes();
  message.setOptionalInt32(1);
  message.addRepeatedInt32(2);
  var optionalGroup = new proto2.TestAllTypes.OptionalGroup();
  optionalGroup.setA(3);
  message.setOptionalgroup(optionalGroup);
  var repeatedGroup = new proto2.TestAllTypes.RepeatedGroup();
  repeatedGroup.addA(4);
  message.addRepeatedgroup(repeatedGroup);
  var nestedMessage = new proto2.TestAllTypes.NestedMessage();
  nestedMessage.setB(5);
  message.setOptionalNestedMessage(nestedMessage);
  message.setOptionalNestedEnum(proto2.TestAllTypes.NestedEnum.FOO);
  message.setUnknown(999, 'foo');

  var clone = message.clone();
  assertNotEquals('different OptionalGroup instance',
      message.getOptionalgroup(), clone.getOptionalgroup());
  assertNotEquals('different RepeatedGroup array instance',
      message.repeatedgroupArray(), clone.repeatedgroupArray());
  assertNotEquals('different RepeatedGroup array item instance',
      message.getRepeatedgroup(0), clone.getRepeatedgroup(0));
  assertNotEquals('different NestedMessage instance',
      message.getOptionalNestedMessage(), clone.getOptionalNestedMessage());
}

function testCloneWithUnknownFields() {
  var message = new proto2.TestAllTypes();
  message.setUnknown(999, 'foo');

  var clone = message.clone();
  assertTrue('clone.equals(message) returns true', clone.equals(message));
  clone.forEachUnknown(function(tag, value) {
    fail('the unknown fields should not have been cloned');
  });

  clone.setUnknown(999, 'foo');
  assertObjectEquals('the original and the cloned message are equal except ' +
      'for the unknown fields', message, clone);
}

function testCopyFromFlatMessage() {
  // Recursive copying is implicitly tested in the testClone... methods.

  var source = new proto2.TestAllTypes();
  source.setOptionalInt32(32);
  source.setOptionalInt64('64');
  source.addRepeatedInt32(32);

  var target = new proto2.TestAllTypes();
  target.setOptionalInt32(33);
  target.setOptionalUint32(33);
  target.addRepeatedInt32(33);

  target.copyFrom(source);
  assertObjectEquals('source and target are equal after copyFrom', source,
      target);

  target.copyFrom(source);
  assertObjectEquals('second copyFrom call has no effect', source, target);

  source.setUnknown(999, 'foo');
  target.setUnknown(999, 'bar');
  target.copyFrom(source);
  assertThrows('unknown fields are not copied',
      goog.partial(assertObjectEquals, source, target));
}

function testInitDefaultsWithEmptyMessage() {
  var message = new proto2.TestAllTypes();
  message.initDefaults(false);

  assertFalse('int32 field is not set', message.hasOptionalInt32());
  assertFalse('int64 [default=1] field is not set', message.hasOptionalInt64());
  assertTrue('optional group field is set', message.hasOptionalgroup());
  assertFalse('int32 inside the group is not set',
      message.getOptionalgroup().hasA());
  assertObjectEquals('value of the optional group',
      new proto2.TestAllTypes.OptionalGroup(), message.getOptionalgroup());
  assertTrue('nested message is set', message.hasOptionalNestedMessage());
  assertObjectEquals('value of the nested message',
      new proto2.TestAllTypes.NestedMessage(),
      message.getOptionalNestedMessage());
  assertFalse('nested enum is not set', message.hasOptionalNestedEnum());
  assertFalse('repeated int32 is not set', message.hasRepeatedInt32());
  assertFalse('repeated nested message is not set',
      message.hasRepeatedNestedMessage());

  message = new proto2.TestAllTypes();
  message.initDefaults(true);

  assertTrue('int32 field is set', message.hasOptionalInt32());
  assertEquals('value of the int32 field', 0, message.getOptionalInt32());
  assertTrue('int64 [default=1] field is set', message.hasOptionalInt64());
  assertEquals('value of the int64 field', '1', message.getOptionalInt64());
  assertTrue('int32 inside nested message is set',
      message.getOptionalNestedMessage().hasB());
  assertEquals('value of the int32 field inside the nested message', 0,
      message.getOptionalNestedMessage().getB());
}

function testInitDefaultsWithNonEmptyMessage() {
  var message = new proto2.TestAllTypes();
  message.setOptionalInt32(32);
  message.setOptionalInt64('64');
  message.setOptionalgroup(new proto2.TestAllTypes.OptionalGroup());
  var nested1 = new proto2.TestAllTypes.NestedMessage();
  nested1.setB(66);
  message.setOptionalNestedMessage(nested1);
  var nested2 = new proto2.TestAllTypes.NestedMessage();
  message.addRepeatedNestedMessage(nested2);
  var nested3 = new proto2.TestAllTypes.NestedMessage();
  nested3.setB(66);
  message.addRepeatedNestedMessage(nested3);

  message.initDefaults(true);
  assertEquals('int32 field is unchanged', 32, message.getOptionalInt32());
  assertEquals('int64 [default=1] field is unchanged', '64',
      message.getOptionalInt64());
  assertTrue('bool field is initialized', message.hasOptionalBool());
  assertFalse('value of the bool field', message.getOptionalBool());
  assertTrue('int32 inside the optional group is initialized',
      message.getOptionalgroup().hasA());
  assertEquals('value of the int32 inside the optional group', 0,
      message.getOptionalgroup().getA());
  assertEquals('int32 inside nested message is unchanged', 66,
      message.getOptionalNestedMessage().getB());
  assertTrue('int32 at index 0 of the repeated nested message is initialized',
      message.getRepeatedNestedMessage(0).hasB());
  assertEquals('value of int32 at index 0 of the repeated nested message', 0,
      message.getRepeatedNestedMessage(0).getB());
  assertEquals('int32 at index 1 of the repeated nested message is unchanged',
      66, message.getRepeatedNestedMessage(1).getB());
}

function testInitDefaultsTwice() {
  var message = new proto2.TestAllTypes();
  message.initDefaults(false);
  var clone = message.clone();
  clone.initDefaults(false);
  assertObjectEquals('second call of initDefaults(false) has no effect',
      message, clone);

  message = new proto2.TestAllTypes();
  message.initDefaults(true);
  clone = message.clone();
  clone.initDefaults(true);
  assertObjectEquals('second call of initDefaults(true) has no effect',
      message, clone);
}

function testInitDefaultsThenClone() {
  var message = new proto2.TestAllTypes();
  message.initDefaults(true);
  assertObjectEquals('message is cloned properly', message, message.clone());
}

">n/a</td></tr>
<tr><td>descriptor_test.html</td><td>Success</td><td> 2 passed, 0 failed.</td><td title="

  goog.require('goog.proto2.Descriptor');
  goog.require('goog.testing.jsunit');



function testDescriptorConstruction() {
  var messageType = {};
  var descriptor = new goog.proto2.Descriptor(messageType, {
    name: 'test',
    fullName: 'this.is.a.test'
  }, []);

  assertEquals('test', descriptor.getName());
  assertEquals('this.is.a.test', descriptor.getFullName());
  assertEquals(null, descriptor.getContainingType());
}

function testParentDescriptor() {
  var parentType = {};
  var messageType = {};

  var parentDescriptor = new goog.proto2.Descriptor(parentType, {
    name: 'parent',
    fullName: 'this.is.a.parent'
  }, []);

  parentType.getDescriptor = function() {
    return parentDescriptor;
  };

  var descriptor = new goog.proto2.Descriptor(messageType, {
    name: 'test',
    fullName: 'this.is.a.test',
    containingType: parentType
  }, []);

  assertEquals(parentDescriptor, descriptor.getContainingType());
}


">n/a</td></tr>
<tr><td>objectserializer_test.html</td><td>Success</td><td> 8 passed, 0 failed.</td><td title="

  goog.require('goog.proto2.ObjectSerializer');
  goog.require('goog.testing.jsunit');
  goog.require('proto2.TestAllTypes');



function testSerialization() {
  var message = new proto2.TestAllTypes();

  // Set the fields.
  // Singular.
  message.setOptionalInt32(101);
  message.setOptionalInt64('102');
  message.setOptionalUint32(103);
  message.setOptionalUint64('104');
  message.setOptionalSint32(105);
  message.setOptionalSint64('106');
  message.setOptionalFixed32(107);
  message.setOptionalFixed64('108');
  message.setOptionalSfixed32(109);
  message.setOptionalSfixed64('110');
  message.setOptionalFloat(111.5);
  message.setOptionalDouble(112.5);
  message.setOptionalBool(true);
  message.setOptionalString('test');
  message.setOptionalBytes('abcd');

  var group = new proto2.TestAllTypes.OptionalGroup();
  group.setA(111);

  message.setOptionalgroup(group);

  var nestedMessage = new proto2.TestAllTypes.NestedMessage();
  nestedMessage.setB(112);

  message.setOptionalNestedMessage(nestedMessage);

  message.setOptionalNestedEnum(proto2.TestAllTypes.NestedEnum.FOO);

  // Repeated.
  message.addRepeatedInt32(201);
  message.addRepeatedInt32(202);

  // Serialize to a simplified object.
  var simplified = new goog.proto2.ObjectSerializer().serialize(message);

  // Assert that everything serialized properly.
  assertEquals(101, simplified[1]);
  assertEquals('102', simplified[2]);
  assertEquals(103, simplified[3]);
  assertEquals('104', simplified[4]);
  assertEquals(105, simplified[5]);
  assertEquals('106', simplified[6]);
  assertEquals(107, simplified[7]);
  assertEquals('108', simplified[8]);
  assertEquals(109, simplified[9]);
  assertEquals('110', simplified[10]);
  assertEquals(111.5, simplified[11]);
  assertEquals(112.5, simplified[12]);
  assertEquals(true, simplified[13]);
  assertEquals('test', simplified[14]);
  assertEquals('abcd', simplified[15]);

  assertEquals(111, simplified[16][17]);
  assertEquals(112, simplified[18][1]);
  assertEquals(proto2.TestAllTypes.NestedEnum.FOO, simplified[21]);

  assertEquals(201, simplified[31][0]);
  assertEquals(202, simplified[31][1]);

  // Serialize to a simplified object (with key as name).
  simplified = new goog.proto2.ObjectSerializer(
      goog.proto2.ObjectSerializer.KeyOption.NAME).serialize(message);

  // Assert that everything serialized properly.
  assertEquals(101, simplified['optional_int32']);
  assertEquals('102', simplified['optional_int64']);
  assertEquals(103, simplified['optional_uint32']);
  assertEquals('104', simplified['optional_uint64']);
  assertEquals(105, simplified['optional_sint32']);
  assertEquals('106', simplified['optional_sint64']);
  assertEquals(107, simplified['optional_fixed32']);
  assertEquals('108', simplified['optional_fixed64']);
  assertEquals(109, simplified['optional_sfixed32']);
  assertEquals('110', simplified['optional_sfixed64']);
  assertEquals(111.5, simplified['optional_float']);
  assertEquals(112.5, simplified['optional_double']);
  assertEquals(true, simplified['optional_bool']);
  assertEquals('test', simplified['optional_string']);
  assertEquals('abcd', simplified['optional_bytes']);

  assertEquals(111, simplified['optionalgroup']['a']);
  assertEquals(112, simplified['optional_nested_message']['b']);

  assertEquals(proto2.TestAllTypes.NestedEnum.FOO,
    simplified['optional_nested_enum']);

  assertEquals(201, simplified['repeated_int32'][0]);
  assertEquals(202, simplified['repeated_int32'][1]);
}


function testSerializationOfUnknown() {
 var message = new proto2.TestAllTypes();

  // Set the fields.
  // Known.
  message.setOptionalInt32(101);
  message.setOptionalInt64('102');
  message.addRepeatedInt32(201);
  message.addRepeatedInt32(202);

  // Unknown.
  message.setUnknown(1000, 301);
  message.setUnknown(1001, 302);

  // Serialize.
  var simplified = new goog.proto2.ObjectSerializer().serialize(message);

  assertEquals(101, simplified['1']);
  assertEquals('102', simplified['2']);

  assertEquals(201, simplified['31'][0]);
  assertEquals(202, simplified['31'][1]);

  assertEquals(301, simplified['1000']);
  assertEquals(302, simplified['1001']);
}

function testDeserializationOfUnknown() {
  var simplified = {
    1: 101,
    2: '102',
    1000: 103,
    1001: 104
  };

  var serializer = new goog.proto2.ObjectSerializer();

  var message = serializer.deserialize(
    proto2.TestAllTypes.getDescriptor(), simplified);

  assertNotNull(message);
  assertTrue(message.hasOptionalInt32());
  assertTrue(message.hasOptionalInt64());

  assertEquals(101, message.getOptionalInt32());
  assertEquals('102', message.getOptionalInt64());

  var count = 0;

  message.forEachUnknown(function(tag, value) {
    if (tag == 1000) {
      assertEquals(103, value);
    }

    if (tag == 1001) {
      assertEquals(104, value);
    }

    ++count;
  });

  assertEquals(2, count);
};

function testDeserializationRepeated() {
 var simplified = {
    31: [101, 102],
    41: [201.5, 202.5, 203.5],
    42: [],
    43: [ true, false ],
    44: [ 'he', 'llo' ],
    46: [ { 47: [101] } , { 47: [102] } ],
    48: [ { 1: 201 }, { 1: 202 } ]
 }

  var serializer = new goog.proto2.ObjectSerializer();

  var message = serializer.deserialize(
    proto2.TestAllTypes.getDescriptor(), simplified);

  assertNotNull(message);

  // Ensure the fields are set as expected.
  assertTrue(message.hasRepeatedInt32());
  assertTrue(message.hasRepeatedFloat());

  assertFalse(message.hasRepeatedDouble());

  assertTrue(message.hasRepeatedBool());
  assertTrue(message.hasRepeatedgroup());
  assertTrue(message.hasRepeatedNestedMessage());

  // Ensure the counts match.
  assertEquals(2, message.repeatedInt32Count());
  assertEquals(3, message.repeatedFloatCount());

  assertEquals(0, message.repeatedDoubleCount());

  assertEquals(2, message.repeatedBoolCount());
  assertEquals(2, message.repeatedStringCount());
  assertEquals(2, message.repeatedgroupCount());
  assertEquals(2, message.repeatedNestedMessageCount());

  // Ensure the values match.
  assertEquals(101, message.getRepeatedInt32(0));
  assertEquals(102, message.getRepeatedInt32(1));

  assertEquals(201.5, message.getRepeatedFloat(0));
  assertEquals(202.5, message.getRepeatedFloat(1));
  assertEquals(203.5, message.getRepeatedFloat(2));

  assertEquals(true, message.getRepeatedBool(0));
  assertEquals(false, message.getRepeatedBool(1));

  assertEquals('he', message.getRepeatedString(0));
  assertEquals('llo', message.getRepeatedString(1));

  assertEquals(101, message.getRepeatedgroup(0).getA(0));
  assertEquals(102, message.getRepeatedgroup(1).getA(0));

  assertEquals(201, message.getRepeatedNestedMessage(0).getB());
  assertEquals(202, message.getRepeatedNestedMessage(1).getB());
}

function testDeserialization() {
  var simplified = {
    1: 101,
    2: '102',
    3: 103,
    4: '104',
    5: 105,
    6: '106',
    7: 107,
    8: '108',
    9: 109,
    10: '110',
    11: 111.5,
    12: 112.5,
    13: true,
    14: 'test',
    15: 'abcd',
    16: { 17 : 113 },
    18: { 1 : 114 },
    21: proto2.TestAllTypes.NestedEnum.FOO
  };

  var serializer = new goog.proto2.ObjectSerializer();

  var message = serializer.deserialize(
    proto2.TestAllTypes.getDescriptor(), simplified);

  assertNotNull(message);

  assertTrue(message.hasOptionalInt32());
  assertTrue(message.hasOptionalInt64());
  assertTrue(message.hasOptionalUint32());
  assertTrue(message.hasOptionalUint64());
  assertTrue(message.hasOptionalSint32());
  assertTrue(message.hasOptionalSint64());
  assertTrue(message.hasOptionalFixed32());
  assertTrue(message.hasOptionalFixed64());
  assertTrue(message.hasOptionalSfixed32());
  assertTrue(message.hasOptionalSfixed64());
  assertTrue(message.hasOptionalFloat());
  assertTrue(message.hasOptionalDouble());
  assertTrue(message.hasOptionalBool());
  assertTrue(message.hasOptionalString());
  assertTrue(message.hasOptionalBytes());
  assertTrue(message.hasOptionalgroup());
  assertTrue(message.hasOptionalNestedMessage());
  assertTrue(message.hasOptionalNestedEnum());

  assertEquals(1, message.optionalInt32Count());
  assertEquals(1, message.optionalInt64Count());
  assertEquals(1, message.optionalUint32Count());
  assertEquals(1, message.optionalUint64Count());
  assertEquals(1, message.optionalSint32Count());
  assertEquals(1, message.optionalSint64Count());
  assertEquals(1, message.optionalFixed32Count());
  assertEquals(1, message.optionalFixed64Count());
  assertEquals(1, message.optionalSfixed32Count());
  assertEquals(1, message.optionalSfixed64Count());
  assertEquals(1, message.optionalFloatCount());
  assertEquals(1, message.optionalDoubleCount());
  assertEquals(1, message.optionalBoolCount());
  assertEquals(1, message.optionalStringCount());
  assertEquals(1, message.optionalBytesCount());
  assertEquals(1, message.optionalgroupCount());
  assertEquals(1, message.optionalNestedMessageCount());
  assertEquals(1, message.optionalNestedEnumCount());

  assertEquals(101, message.getOptionalInt32());
  assertEquals('102', message.getOptionalInt64());
  assertEquals(103, message.getOptionalUint32());
  assertEquals('104', message.getOptionalUint64());
  assertEquals(105, message.getOptionalSint32());
  assertEquals('106', message.getOptionalSint64());
  assertEquals(107, message.getOptionalFixed32());
  assertEquals('108', message.getOptionalFixed64());
  assertEquals(109, message.getOptionalSfixed32());
  assertEquals('110', message.getOptionalSfixed64());
  assertEquals(111.5, message.getOptionalFloat());
  assertEquals(112.5, message.getOptionalDouble());
  assertEquals(true, message.getOptionalBool());
  assertEquals('test', message.getOptionalString());
  assertEquals('abcd', message.getOptionalBytes());
  assertEquals(113, message.getOptionalgroup().getA());
  assertEquals(114, message.getOptionalNestedMessage().getB());

  assertEquals(proto2.TestAllTypes.NestedEnum.FOO,
    message.getOptionalNestedEnum());
}

function testDeserializationNumbersOrStrings() {
  // 64-bit types may have been serialized as numbers or strings.
  // Deserialization should be able to handle either.

  var simplifiedWithNumbers = {
    50: 5000,
    51: 5100,
    52: [ 5200, 5201 ],
    53: [ 5300, 5301 ]
  };

  var simplifiedWithStrings = {
    50: '5000',
    51: '5100',
    52: [ '5200', '5201' ],
    53: [ '5300', '5301' ]
  };

  var serializer = new goog.proto2.ObjectSerializer();

  var message = serializer.deserialize(
    proto2.TestAllTypes.getDescriptor(), simplifiedWithNumbers);

  assertNotNull(message);

  assertEquals(5000, message.getOptionalInt64Number());
  assertEquals('5100', message.getOptionalInt64String());
  assertEquals(5200, message.getRepeatedInt64Number(0));
  assertEquals(5201, message.getRepeatedInt64Number(1));
  assertEquals('5300', message.getRepeatedInt64String(0));
  assertEquals('5301', message.getRepeatedInt64String(1));

  assertArrayEquals([5200, 5201], message.repeatedInt64NumberArray());
  assertArrayEquals(['5300', '5301'], message.repeatedInt64StringArray());

  message = serializer.deserialize(
    proto2.TestAllTypes.getDescriptor(), simplifiedWithStrings);

  assertNotNull(message);

  assertEquals(5000, message.getOptionalInt64Number());
  assertEquals('5100', message.getOptionalInt64String());
  assertEquals(5200, message.getRepeatedInt64Number(0));
  assertEquals(5201, message.getRepeatedInt64Number(1));
  assertEquals('5300', message.getRepeatedInt64String(0));
  assertEquals('5301', message.getRepeatedInt64String(1));

  assertArrayEquals([5200, 5201], message.repeatedInt64NumberArray());
  assertArrayEquals(['5300', '5301'], message.repeatedInt64StringArray());
}

function testDeserializationConversionProhibited() {
  // 64-bit types may have been serialized as numbers or strings.
  // But 32-bit types must be serialized as numbers.
  // Test deserialization fails on 32-bit numbers as strings.

  var simplified = {
    1: '1000'   // optionalInt32
  };
  var serializer = new goog.proto2.ObjectSerializer();

  assertThrows('Should have an assertion failure in deserialization',
      function() {
        serializer.deserialize(proto2.TestAllTypes.getDescriptor(), simplified);
      });
}

function testDefaultValueNumbersOrStrings() {
  // 64-bit types may have been serialized as numbers or strings.
  // The default values should have the correct type.

  var serializer = new goog.proto2.ObjectSerializer();
  var message = serializer.deserialize(proto2.TestAllTypes.getDescriptor(), {});

  assertNotNull(message);

  // Default when using Number is a number, and precision is lost.
  var value = message.getOptionalInt64NumberOrDefault();
  assertTrue('Expecting a number', typeof value === 'number');
  assertEquals(1000000000000000000, value);
  assertEquals(1000000000000000001, value);
  assertEquals(1000000000000000002, value);
  assertEquals('1000000000000000000', String(value));  // Value is rounded!

  // When using a String, the value is preserved.
  assertEquals('1000000000000000001',
               message.getOptionalInt64StringOrDefault());
}
">n/a</td></tr>
<tr><td>fielddescriptor_test.html</td><td>Success</td><td> 7 passed, 0 failed.</td><td title="

  goog.require('goog.proto2.Descriptor');
  goog.require('goog.proto2.FieldDescriptor');
  goog.require('goog.testing.jsunit');



function testFieldDescriptorConstruction() {
  var messageType = {};
  var fieldDescriptor = new goog.proto2.FieldDescriptor(messageType, 10, {
    name: 'test',
    repeated: true,
    fieldType: 7,
    type: Number
  });

  assertEquals(10, fieldDescriptor.getTag());
  assertEquals('test', fieldDescriptor.getName());

  assertEquals(true, fieldDescriptor.isRepeated());

  assertEquals(7, fieldDescriptor.getFieldType());
  assertEquals(Number, fieldDescriptor.getNativeType());
  assertEquals(0, fieldDescriptor.getDefaultValue());
}

function testFieldDescriptorConstruction2() {
  var fieldDescriptor = new goog.proto2.FieldDescriptor({}, 10, {
    name: 'test',
    fieldType: 7,
    type: String
  });

  assertEquals('', fieldDescriptor.getDefaultValue());
}

function testFieldDescriptorConstruction3() {
  var fieldDescriptor = new goog.proto2.FieldDescriptor({}, 10, {
    name: 'test',
    fieldType: 7,
    type: Boolean
  });

  assertEquals(false, fieldDescriptor.getDefaultValue());
}

function testRepeatedField() {
  var messageType = {};
  var fieldDescriptor = new goog.proto2.FieldDescriptor(messageType, 10, {
    name: 'test',
    repeated: true,
    fieldType: 7,
    type: Number
  });

  assertEquals(true, fieldDescriptor.isRepeated());
  assertEquals(false, fieldDescriptor.isRequired());
  assertEquals(false, fieldDescriptor.isOptional());
}

function testRequiredField() {
  var messageType = {};
  var fieldDescriptor = new goog.proto2.FieldDescriptor(messageType, 10, {
    name: 'test',
    required: true,
    fieldType: 7,
    type: Number
  });

  assertEquals(false, fieldDescriptor.isRepeated());
  assertEquals(true, fieldDescriptor.isRequired());
  assertEquals(false, fieldDescriptor.isOptional());
}

function testOptionalField() {
  var messageType = {};
  var fieldDescriptor = new goog.proto2.FieldDescriptor(messageType, 10, {
    name: 'test',
    fieldType: 7,
    type: Number
  });

  assertEquals(false, fieldDescriptor.isRepeated());
  assertEquals(false, fieldDescriptor.isRequired());
  assertEquals(true, fieldDescriptor.isOptional());
}

function testContaingType() {
  var messageType = {};
  var fieldDescriptor = new goog.proto2.FieldDescriptor(messageType, 10, {
    name: 'test',
    fieldType: 7,
    type: Number
  });

  var descriptor = new goog.proto2.Descriptor(messageType, {
    name: 'test_message',
    fullName: 'this.is.a.test_message'
  }, [fieldDescriptor]);

  messageType.descriptor_ = descriptor;

  assertEquals(descriptor, fieldDescriptor.getContainingType());
}

">n/a</td></tr>
<tr><td>proto_test.html</td><td>Success</td><td> 7 passed, 0 failed.</td><td title="

  goog.require('someprotopackage.TestPackageTypes');
  goog.require('proto2.TestAllTypes');
  goog.require('goog.testing.jsunit');



function testPackage() {
  var message = new someprotopackage.TestPackageTypes();
  message.setOptionalInt32(45);
  message.setOtherAll(new proto2.TestAllTypes());
}

function testFields() {
  var message = new proto2.TestAllTypes();

  // Ensure that the fields are not set.
  assertFalse(message.hasOptionalInt32());
  assertFalse(message.hasOptionalInt64());
  assertFalse(message.hasOptionalUint32());
  assertFalse(message.hasOptionalUint64());
  assertFalse(message.hasOptionalSint32());
  assertFalse(message.hasOptionalSint64());
  assertFalse(message.hasOptionalFixed32());
  assertFalse(message.hasOptionalFixed64());
  assertFalse(message.hasOptionalSfixed32());
  assertFalse(message.hasOptionalSfixed64());
  assertFalse(message.hasOptionalFloat());
  assertFalse(message.hasOptionalDouble());
  assertFalse(message.hasOptionalBool());
  assertFalse(message.hasOptionalString());
  assertFalse(message.hasOptionalBytes());
  assertFalse(message.hasOptionalgroup());
  assertFalse(message.hasOptionalNestedMessage());
  assertFalse(message.hasOptionalNestedEnum());

  // Check non-set values.
  assertUndefined(message.getOptionalInt32());
  assertUndefined(message.getOptionalInt64());
  assertUndefined(message.getOptionalFloat());
  assertUndefined(message.getOptionalString());
  assertUndefined(message.getOptionalBytes());
  assertUndefined(message.getOptionalNestedMessage());
  assertUndefined(message.getOptionalNestedEnum());

  // Check default values.
  assertTrue(0 == message.getOptionalInt32OrDefault());
  assertTrue('1' == message.getOptionalInt64OrDefault());
  assertTrue(1.5 == message.getOptionalFloatOrDefault());
  assertTrue("" == message.getOptionalStringOrDefault());
  assertTrue("moo" == message.getOptionalBytesOrDefault());

  // Set the fields.
  message.setOptionalInt32(101);
  message.setOptionalInt64('102');
  message.setOptionalUint32(103);
  message.setOptionalUint64('104');
  message.setOptionalSint32(105);
  message.setOptionalSint64('106');
  message.setOptionalFixed32(107);
  message.setOptionalFixed64('108');
  message.setOptionalSfixed32(109);
  message.setOptionalSfixed64('110');
  message.setOptionalFloat(111.5);
  message.setOptionalDouble(112.5);
  message.setOptionalBool(true);
  message.setOptionalString('test');
  message.setOptionalBytes('abcd');

  var group = new proto2.TestAllTypes.OptionalGroup();
  group.setA(111);

  message.setOptionalgroup(group);

  var nestedMessage = new proto2.TestAllTypes.NestedMessage();
  nestedMessage.setB(112);

  message.setOptionalNestedMessage(nestedMessage);

  message.setOptionalNestedEnum(proto2.TestAllTypes.NestedEnum.FOO);

  // Ensure that the fields are set.
  assertTrue(message.hasOptionalInt32());
  assertTrue(message.hasOptionalInt64());
  assertTrue(message.hasOptionalUint32());
  assertTrue(message.hasOptionalUint64());
  assertTrue(message.hasOptionalSint32());
  assertTrue(message.hasOptionalSint64());
  assertTrue(message.hasOptionalFixed32());
  assertTrue(message.hasOptionalFixed64());
  assertTrue(message.hasOptionalSfixed32());
  assertTrue(message.hasOptionalSfixed64());
  assertTrue(message.hasOptionalFloat());
  assertTrue(message.hasOptionalDouble());
  assertTrue(message.hasOptionalBool());
  assertTrue(message.hasOptionalString());
  assertTrue(message.hasOptionalBytes());
  assertTrue(message.hasOptionalgroup());
  assertTrue(message.hasOptionalNestedMessage());
  assertTrue(message.hasOptionalNestedEnum());

  // Ensure that there is a count of 1 for each of the fields.
  assertEquals(1, message.optionalInt32Count());
  assertEquals(1, message.optionalInt64Count());
  assertEquals(1, message.optionalUint32Count());
  assertEquals(1, message.optionalUint64Count());
  assertEquals(1, message.optionalSint32Count());
  assertEquals(1, message.optionalSint64Count());
  assertEquals(1, message.optionalFixed32Count());
  assertEquals(1, message.optionalFixed64Count());
  assertEquals(1, message.optionalSfixed32Count());
  assertEquals(1, message.optionalSfixed64Count());
  assertEquals(1, message.optionalFloatCount());
  assertEquals(1, message.optionalDoubleCount());
  assertEquals(1, message.optionalBoolCount());
  assertEquals(1, message.optionalStringCount());
  assertEquals(1, message.optionalBytesCount());
  assertEquals(1, message.optionalgroupCount());
  assertEquals(1, message.optionalNestedMessageCount());
  assertEquals(1, message.optionalNestedEnumCount());

  // Ensure that the fields have the values expected.
  assertEquals(101, message.getOptionalInt32());
  assertEquals('102', message.getOptionalInt64());
  assertEquals(103, message.getOptionalUint32());
  assertEquals('104', message.getOptionalUint64());
  assertEquals(105, message.getOptionalSint32());
  assertEquals('106', message.getOptionalSint64());
  assertEquals(107, message.getOptionalFixed32());
  assertEquals('108', message.getOptionalFixed64());
  assertEquals(109, message.getOptionalSfixed32());
  assertEquals('110', message.getOptionalSfixed64());
  assertEquals(111.5, message.getOptionalFloat());
  assertEquals(112.5, message.getOptionalDouble());
  assertEquals(true, message.getOptionalBool());
  assertEquals('test', message.getOptionalString());
  assertEquals('abcd', message.getOptionalBytes());
  assertEquals(group, message.getOptionalgroup());
  assertEquals(nestedMessage, message.getOptionalNestedMessage());
  assertEquals(proto2.TestAllTypes.NestedEnum.FOO,
               message.getOptionalNestedEnum());
}

function testRepeated() {
  var message = new proto2.TestAllTypes();

  // Ensure that the fields are not set.
  assertFalse(message.hasRepeatedInt32());
  assertFalse(message.hasRepeatedInt64());
  assertFalse(message.hasRepeatedUint32());
  assertFalse(message.hasRepeatedUint64());
  assertFalse(message.hasRepeatedSint32());
  assertFalse(message.hasRepeatedSint64());
  assertFalse(message.hasRepeatedFixed32());
  assertFalse(message.hasRepeatedFixed64());
  assertFalse(message.hasRepeatedSfixed32());
  assertFalse(message.hasRepeatedSfixed64());
  assertFalse(message.hasRepeatedFloat());
  assertFalse(message.hasRepeatedDouble());
  assertFalse(message.hasRepeatedBool());
  assertFalse(message.hasRepeatedString());
  assertFalse(message.hasRepeatedBytes());
  assertFalse(message.hasRepeatedgroup());
  assertFalse(message.hasRepeatedNestedMessage());
  assertFalse(message.hasRepeatedNestedEnum());

  // Expect the arrays to be empty.
  assertEquals(0, message.repeatedInt32Array().length);
  assertEquals(0, message.repeatedInt64Array().length);
  assertEquals(0, message.repeatedUint32Array().length);
  assertEquals(0, message.repeatedUint64Array().length);
  assertEquals(0, message.repeatedSint32Array().length);
  assertEquals(0, message.repeatedSint64Array().length);
  assertEquals(0, message.repeatedFixed32Array().length);
  assertEquals(0, message.repeatedFixed64Array().length);
  assertEquals(0, message.repeatedSfixed32Array().length);
  assertEquals(0, message.repeatedSfixed64Array().length);
  assertEquals(0, message.repeatedFloatArray().length);
  assertEquals(0, message.repeatedDoubleArray().length);
  assertEquals(0, message.repeatedBoolArray().length);
  assertEquals(0, message.repeatedStringArray().length);
  assertEquals(0, message.repeatedBytesArray().length);
  assertEquals(0, message.repeatedgroupArray().length);
  assertEquals(0, message.repeatedNestedMessageArray().length);
  assertEquals(0, message.repeatedNestedEnumArray().length);

  // Set the fields.
  message.addRepeatedInt32(101);
  message.addRepeatedInt64('102');
  message.addRepeatedUint32(103);
  message.addRepeatedUint64('104');
  message.addRepeatedSint32(105);
  message.addRepeatedSint64('106');
  message.addRepeatedFixed32(107);
  message.addRepeatedFixed64('108');
  message.addRepeatedSfixed32(109);
  message.addRepeatedSfixed64('110');
  message.addRepeatedFloat(111.5);
  message.addRepeatedDouble(112.5);
  message.addRepeatedBool(true);
  message.addRepeatedString('test');
  message.addRepeatedBytes('abcd');

  message.addRepeatedInt32(201);
  message.addRepeatedInt64('202');
  message.addRepeatedUint32(203);
  message.addRepeatedUint64('204');
  message.addRepeatedSint32(205);
  message.addRepeatedSint64('206');
  message.addRepeatedFixed32(207);
  message.addRepeatedFixed64('208');
  message.addRepeatedSfixed32(209);
  message.addRepeatedSfixed64('210');
  message.addRepeatedFloat(211.5);
  message.addRepeatedDouble(212.5);
  message.addRepeatedBool(true);
  message.addRepeatedString('test#2');
  message.addRepeatedBytes('efgh');


  var group1 = new proto2.TestAllTypes.RepeatedGroup();
  group1.addA(111);

  message.addRepeatedgroup(group1);

  var group2 = new proto2.TestAllTypes.RepeatedGroup();
  group2.addA(211);

  message.addRepeatedgroup(group2);

  var nestedMessage1 = new proto2.TestAllTypes.NestedMessage();
  nestedMessage1.setB(112);
  message.addRepeatedNestedMessage(nestedMessage1);

  var nestedMessage2 = new proto2.TestAllTypes.NestedMessage();
  nestedMessage2.setB(212);
  message.addRepeatedNestedMessage(nestedMessage2);

  message.addRepeatedNestedEnum(proto2.TestAllTypes.NestedEnum.FOO);
  message.addRepeatedNestedEnum(proto2.TestAllTypes.NestedEnum.BAR);

  // Ensure that the fields are set.
  assertTrue(message.hasRepeatedInt32());
  assertTrue(message.hasRepeatedInt64());
  assertTrue(message.hasRepeatedUint32());
  assertTrue(message.hasRepeatedUint64());
  assertTrue(message.hasRepeatedSint32());
  assertTrue(message.hasRepeatedSint64());
  assertTrue(message.hasRepeatedFixed32());
  assertTrue(message.hasRepeatedFixed64());
  assertTrue(message.hasRepeatedSfixed32());
  assertTrue(message.hasRepeatedSfixed64());
  assertTrue(message.hasRepeatedFloat());
  assertTrue(message.hasRepeatedDouble());
  assertTrue(message.hasRepeatedBool());
  assertTrue(message.hasRepeatedString());
  assertTrue(message.hasRepeatedBytes());
  assertTrue(message.hasRepeatedgroup());
  assertTrue(message.hasRepeatedNestedMessage());
  assertTrue(message.hasRepeatedNestedEnum());

  // Ensure that there is a count of 2 for each of the fields.
  assertEquals(2, message.repeatedInt32Count());
  assertEquals(2, message.repeatedInt64Count());
  assertEquals(2, message.repeatedUint32Count());
  assertEquals(2, message.repeatedUint64Count());
  assertEquals(2, message.repeatedSint32Count());
  assertEquals(2, message.repeatedSint64Count());
  assertEquals(2, message.repeatedFixed32Count());
  assertEquals(2, message.repeatedFixed64Count());
  assertEquals(2, message.repeatedSfixed32Count());
  assertEquals(2, message.repeatedSfixed64Count());
  assertEquals(2, message.repeatedFloatCount());
  assertEquals(2, message.repeatedDoubleCount());
  assertEquals(2, message.repeatedBoolCount());
  assertEquals(2, message.repeatedStringCount());
  assertEquals(2, message.repeatedBytesCount());
  assertEquals(2, message.repeatedgroupCount());
  assertEquals(2, message.repeatedNestedMessageCount());
  assertEquals(2, message.repeatedNestedEnumCount());

  // Ensure that the fields have the values expected.
  assertEquals(101, message.getRepeatedInt32(0));
  assertEquals('102', message.getRepeatedInt64(0));
  assertEquals(103, message.getRepeatedUint32(0));
  assertEquals('104', message.getRepeatedUint64(0));
  assertEquals(105, message.getRepeatedSint32(0));
  assertEquals('106', message.getRepeatedSint64(0));
  assertEquals(107, message.getRepeatedFixed32(0));
  assertEquals('108', message.getRepeatedFixed64(0));
  assertEquals(109, message.getRepeatedSfixed32(0));
  assertEquals('110', message.getRepeatedSfixed64(0));
  assertEquals(111.5, message.getRepeatedFloat(0));
  assertEquals(112.5, message.getRepeatedDouble(0));
  assertEquals(true, message.getRepeatedBool(0));
  assertEquals('test', message.getRepeatedString(0));
  assertEquals('abcd', message.getRepeatedBytes(0));
  assertEquals(group1, message.getRepeatedgroup(0));
  assertEquals(nestedMessage1, message.getRepeatedNestedMessage(0));
  assertEquals(proto2.TestAllTypes.NestedEnum.FOO,
               message.getRepeatedNestedEnum(0));

  assertEquals(201, message.getRepeatedInt32(1));
  assertEquals('202', message.getRepeatedInt64(1));
  assertEquals(203, message.getRepeatedUint32(1));
  assertEquals('204', message.getRepeatedUint64(1));
  assertEquals(205, message.getRepeatedSint32(1));
  assertEquals('206', message.getRepeatedSint64(1));
  assertEquals(207, message.getRepeatedFixed32(1));
  assertEquals('208', message.getRepeatedFixed64(1));
  assertEquals(209, message.getRepeatedSfixed32(1));
  assertEquals('210', message.getRepeatedSfixed64(1));
  assertEquals(211.5, message.getRepeatedFloat(1));
  assertEquals(212.5, message.getRepeatedDouble(1));
  assertEquals(true, message.getRepeatedBool(1));
  assertEquals('test#2', message.getRepeatedString(1));
  assertEquals('efgh', message.getRepeatedBytes(1));
  assertEquals(group2, message.getRepeatedgroup(1));
  assertEquals(nestedMessage2, message.getRepeatedNestedMessage(1));
  assertEquals(proto2.TestAllTypes.NestedEnum.BAR,
               message.getRepeatedNestedEnum(1));

  // Check the array lengths.
  assertEquals(2, message.repeatedInt32Array().length);
  assertEquals(2, message.repeatedInt64Array().length);
  assertEquals(2, message.repeatedUint32Array().length);
  assertEquals(2, message.repeatedUint64Array().length);
  assertEquals(2, message.repeatedSint32Array().length);
  assertEquals(2, message.repeatedSint64Array().length);
  assertEquals(2, message.repeatedFixed32Array().length);
  assertEquals(2, message.repeatedFixed64Array().length);
  assertEquals(2, message.repeatedSfixed32Array().length);
  assertEquals(2, message.repeatedSfixed64Array().length);
  assertEquals(2, message.repeatedFloatArray().length);
  assertEquals(2, message.repeatedDoubleArray().length);
  assertEquals(2, message.repeatedBoolArray().length);
  assertEquals(2, message.repeatedStringArray().length);
  assertEquals(2, message.repeatedBytesArray().length);
  assertEquals(2, message.repeatedgroupArray().length);
  assertEquals(2, message.repeatedNestedMessageArray().length);
  assertEquals(2, message.repeatedNestedEnumArray().length);

  // Check the array values.
  assertEquals(message.getRepeatedInt32(0), message.repeatedInt32Array()[0]);
  assertEquals(message.getRepeatedInt64(0), message.repeatedInt64Array()[0]);
  assertEquals(message.getRepeatedUint32(0), message.repeatedUint32Array()[0]);
  assertEquals(message.getRepeatedUint64(0), message.repeatedUint64Array()[0]);
  assertEquals(message.getRepeatedSint32(0), message.repeatedSint32Array()[0]);
  assertEquals(message.getRepeatedSint64(0), message.repeatedSint64Array()[0]);
  assertEquals(message.getRepeatedFixed32(0),
               message.repeatedFixed32Array()[0]);
  assertEquals(message.getRepeatedFixed64(0),
               message.repeatedFixed64Array()[0]);
  assertEquals(message.getRepeatedSfixed32(0),
               message.repeatedSfixed32Array()[0]);
  assertEquals(message.getRepeatedSfixed64(0),
               message.repeatedSfixed64Array()[0]);
  assertEquals(message.getRepeatedFloat(0), message.repeatedFloatArray()[0]);
  assertEquals(message.getRepeatedDouble(0), message.repeatedDoubleArray()[0]);
  assertEquals(message.getRepeatedBool(0), message.repeatedBoolArray()[0]);
  assertEquals(message.getRepeatedString(0), message.repeatedStringArray()[0]);
  assertEquals(message.getRepeatedBytes(0), message.repeatedBytesArray()[0]);
  assertEquals(message.getRepeatedgroup(0), message.repeatedgroupArray()[0]);
  assertEquals(message.getRepeatedNestedMessage(0),
               message.repeatedNestedMessageArray()[0]);
  assertEquals(message.getRepeatedNestedEnum(0),
               message.repeatedNestedEnumArray()[0]);

  assertEquals(message.getRepeatedInt32(1), message.repeatedInt32Array()[1]);
  assertEquals(message.getRepeatedInt64(1), message.repeatedInt64Array()[1]);
  assertEquals(message.getRepeatedUint32(1), message.repeatedUint32Array()[1]);
  assertEquals(message.getRepeatedUint64(1), message.repeatedUint64Array()[1]);
  assertEquals(message.getRepeatedSint32(1), message.repeatedSint32Array()[1]);
  assertEquals(message.getRepeatedSint64(1), message.repeatedSint64Array()[1]);
  assertEquals(message.getRepeatedFixed32(1),
               message.repeatedFixed32Array()[1]);
  assertEquals(message.getRepeatedFixed64(1),
               message.repeatedFixed64Array()[1]);
  assertEquals(message.getRepeatedSfixed32(1),
               message.repeatedSfixed32Array()[1]);
  assertEquals(message.getRepeatedSfixed64(1),
               message.repeatedSfixed64Array()[1]);
  assertEquals(message.getRepeatedFloat(1), message.repeatedFloatArray()[1]);
  assertEquals(message.getRepeatedDouble(1), message.repeatedDoubleArray()[1]);
  assertEquals(message.getRepeatedBool(1), message.repeatedBoolArray()[1]);
  assertEquals(message.getRepeatedString(1), message.repeatedStringArray()[1]);
  assertEquals(message.getRepeatedBytes(1), message.repeatedBytesArray()[1]);
  assertEquals(message.getRepeatedgroup(1), message.repeatedgroupArray()[1]);
  assertEquals(message.getRepeatedNestedMessage(1),
               message.repeatedNestedMessageArray()[1]);
  assertEquals(message.getRepeatedNestedEnum(1),
               message.repeatedNestedEnumArray()[1]);
}

function testDescriptor() {
  var message = new proto2.TestAllTypes();
  var descriptor = message.getDescriptor();

  assertEquals('TestAllTypes', descriptor.getName());
  assertEquals('TestAllTypes', descriptor.getFullName());
  assertEquals(null, descriptor.getContainingType());

  var nestedMessage = new proto2.TestAllTypes.NestedMessage();
  var nestedDescriptor = nestedMessage.getDescriptor();

  assertEquals('NestedMessage', nestedDescriptor.getName());
  assertEquals('TestAllTypes.NestedMessage',
               nestedDescriptor.getFullName());
  assertEquals(descriptor, nestedDescriptor.getContainingType());
}

function testFieldDescriptor() {
  var message = new proto2.TestAllTypes();
  var descriptor = message.getDescriptor();
  var fields = descriptor.getFields();

  assertEquals(40, fields.length);

  // Check the containing types.
  for (var i = 0; i < fields.length; ++i) {
    assertEquals(descriptor, fields[i].getContainingType());
  }

  // Check the field names.
  assertEquals('optional_int32', fields[0].getName());
  assertEquals('optional_int64', fields[1].getName());
  assertEquals('optional_uint32', fields[2].getName());
  assertEquals('optional_uint64', fields[3].getName());
  assertEquals('optional_sint32', fields[4].getName());
  assertEquals('optional_sint64', fields[5].getName());
  assertEquals('optional_fixed32', fields[6].getName());
  assertEquals('optional_fixed64', fields[7].getName());
  assertEquals('optional_sfixed32', fields[8].getName());
  assertEquals('optional_sfixed64', fields[9].getName());
  assertEquals('optional_float', fields[10].getName());
  assertEquals('optional_double', fields[11].getName());
  assertEquals('optional_bool', fields[12].getName());
  assertEquals('optional_string', fields[13].getName());
  assertEquals('optional_bytes', fields[14].getName());
  assertEquals('optionalgroup', fields[15].getName());
  assertEquals('optional_nested_message', fields[16].getName());
  assertEquals('optional_nested_enum', fields[17].getName());

  assertEquals('repeated_int32', fields[18].getName());
  assertEquals('repeated_int64', fields[19].getName());
  assertEquals('repeated_uint32', fields[20].getName());
  assertEquals('repeated_uint64', fields[21].getName());
  assertEquals('repeated_sint32', fields[22].getName());
  assertEquals('repeated_sint64', fields[23].getName());
  assertEquals('repeated_fixed32', fields[24].getName());
  assertEquals('repeated_fixed64', fields[25].getName());
  assertEquals('repeated_sfixed32', fields[26].getName());
  assertEquals('repeated_sfixed64', fields[27].getName());
  assertEquals('repeated_float', fields[28].getName());
  assertEquals('repeated_double', fields[29].getName());
  assertEquals('repeated_bool', fields[30].getName());
  assertEquals('repeated_string', fields[31].getName());
  assertEquals('repeated_bytes', fields[32].getName());
  assertEquals('repeatedgroup', fields[33].getName());
  assertEquals('repeated_nested_message', fields[34].getName());
  assertEquals('repeated_nested_enum', fields[35].getName());

  assertEquals('optional_int64_number', fields[36].getName());
  assertEquals('optional_int64_string', fields[37].getName());
  assertEquals('repeated_int64_number', fields[38].getName());
  assertEquals('repeated_int64_string', fields[39].getName());

  // Check the field types.
  var FieldType = goog.proto2.FieldDescriptor.FieldType;
  assertEquals(FieldType.INT32, fields[0].getFieldType());
  assertEquals(FieldType.INT64, fields[1].getFieldType());
  assertEquals(FieldType.UINT32, fields[2].getFieldType());
  assertEquals(FieldType.UINT64, fields[3].getFieldType());
  assertEquals(FieldType.SINT32, fields[4].getFieldType());
  assertEquals(FieldType.SINT64, fields[5].getFieldType());
  assertEquals(FieldType.FIXED32, fields[6].getFieldType());
  assertEquals(FieldType.FIXED64, fields[7].getFieldType());
  assertEquals(FieldType.SFIXED32, fields[8].getFieldType());
  assertEquals(FieldType.SFIXED64, fields[9].getFieldType());
  assertEquals(FieldType.FLOAT, fields[10].getFieldType());
  assertEquals(FieldType.DOUBLE, fields[11].getFieldType());
  assertEquals(FieldType.BOOL, fields[12].getFieldType());
  assertEquals(FieldType.STRING, fields[13].getFieldType());
  assertEquals(FieldType.BYTES, fields[14].getFieldType());
  assertEquals(FieldType.GROUP, fields[15].getFieldType());
  assertEquals(FieldType.MESSAGE, fields[16].getFieldType());
  assertEquals(FieldType.ENUM, fields[17].getFieldType());

  assertEquals(FieldType.INT32, fields[18].getFieldType());
  assertEquals(FieldType.INT64, fields[19].getFieldType());
  assertEquals(FieldType.UINT32, fields[20].getFieldType());
  assertEquals(FieldType.UINT64, fields[21].getFieldType());
  assertEquals(FieldType.SINT32, fields[22].getFieldType());
  assertEquals(FieldType.SINT64, fields[23].getFieldType());
  assertEquals(FieldType.FIXED32, fields[24].getFieldType());
  assertEquals(FieldType.FIXED64, fields[25].getFieldType());
  assertEquals(FieldType.SFIXED32, fields[26].getFieldType());
  assertEquals(FieldType.SFIXED64, fields[27].getFieldType());
  assertEquals(FieldType.FLOAT, fields[28].getFieldType());
  assertEquals(FieldType.DOUBLE, fields[29].getFieldType());
  assertEquals(FieldType.BOOL, fields[30].getFieldType());
  assertEquals(FieldType.STRING, fields[31].getFieldType());
  assertEquals(FieldType.BYTES, fields[32].getFieldType());
  assertEquals(FieldType.GROUP, fields[33].getFieldType());
  assertEquals(FieldType.MESSAGE, fields[34].getFieldType());
  assertEquals(FieldType.ENUM, fields[35].getFieldType());

  assertEquals(FieldType.INT64, fields[36].getFieldType());
  assertEquals(FieldType.INT64, fields[37].getFieldType());
  assertEquals(FieldType.INT64, fields[38].getFieldType());
  assertEquals(FieldType.INT64, fields[39].getFieldType());

  // Check the field native types.
  // Singular.
  assertEquals(Number, fields[0].getNativeType());
  assertEquals(String, fields[1].getNativeType()); // 64 bit values are strings.
  assertEquals(Number, fields[2].getNativeType());
  assertEquals(String, fields[3].getNativeType());
  assertEquals(Number, fields[4].getNativeType());
  assertEquals(String, fields[5].getNativeType());
  assertEquals(Number, fields[6].getNativeType());
  assertEquals(String, fields[7].getNativeType());
  assertEquals(Number, fields[8].getNativeType());
  assertEquals(String, fields[9].getNativeType());
  assertEquals(Number, fields[10].getNativeType());
  assertEquals(Number, fields[11].getNativeType());

  assertEquals(Boolean, fields[12].getNativeType());

  assertEquals(String, fields[13].getNativeType());
  assertEquals(String, fields[14].getNativeType());

  assertEquals(proto2.TestAllTypes.OptionalGroup, fields[15].getNativeType());
  assertEquals(proto2.TestAllTypes.NestedMessage, fields[16].getNativeType());
  assertEquals(proto2.TestAllTypes.NestedEnum, fields[17].getNativeType());

  assertEquals(Number, fields[36].getNativeType());  // [jstype="number"]
  assertEquals(String, fields[37].getNativeType());

  // Repeated.
  assertEquals(Number, fields[18].getNativeType());
  assertEquals(String, fields[19].getNativeType());
  assertEquals(Number, fields[20].getNativeType());
  assertEquals(String, fields[21].getNativeType());
  assertEquals(Number, fields[22].getNativeType());
  assertEquals(String, fields[23].getNativeType());
  assertEquals(Number, fields[24].getNativeType());
  assertEquals(String, fields[25].getNativeType());
  assertEquals(Number, fields[26].getNativeType());
  assertEquals(String, fields[27].getNativeType());
  assertEquals(Number, fields[28].getNativeType());
  assertEquals(Number, fields[29].getNativeType());

  assertEquals(Boolean, fields[30].getNativeType());

  assertEquals(String, fields[31].getNativeType());
  assertEquals(String, fields[32].getNativeType());

  assertEquals(proto2.TestAllTypes.RepeatedGroup, fields[33].getNativeType());
  assertEquals(proto2.TestAllTypes.NestedMessage, fields[34].getNativeType());
  assertEquals(proto2.TestAllTypes.NestedEnum, fields[35].getNativeType());

  assertEquals(Number, fields[38].getNativeType());  // [jstype="number"]
  assertEquals(String, fields[39].getNativeType());
}

function testUnknown() {
  var message = new proto2.TestAllTypes();

  // Set some unknown fields.
  message.setUnknown(1000, 101);
  message.setUnknown(1001, -102);
  message.setUnknown(1002, true);
  message.setUnknown(1003, 'abcd');
  message.setUnknown(1004, [ 'he', 'llo']);

  // Ensure we find them all.
  var count = 0;

  message.forEachUnknown(function(tag, value) {
    if (tag == 1000) {
      assertEquals(101, value);
    }

    if (tag == 1001) {
      assertEquals(-102, value);
    }

    if (tag == 1002) {
      assertEquals(true, value);
    }

    if (tag == 1003) {
      assertEquals('abcd', value);
    }

    if (tag == 1004) {
      assertEquals('he', value[0]);
      assertEquals('llo', value[1]);
    }

    count++;
  });

  assertEquals(5, count);
}

function testReflection() {
  var message = new proto2.TestAllTypes();
  var descriptor = message.getDescriptor();
  var optionalInt = descriptor.findFieldByName('optional_int32');
  var optionalString = descriptor.findFieldByName('optional_string');
  var repeatedInt64 = descriptor.findFieldByName('repeated_int64');
  var optionalWrong = descriptor.findFieldByName('foo_bar');

  assertFalse(optionalInt == null);
  assertFalse(optionalString == null);
  assertFalse(repeatedInt64 == null);
  assertTrue(optionalWrong == null);

  // Check to ensure the fields are empty.
  assertFalse(message.has(optionalInt));
  assertFalse(message.has(optionalString));
  assertFalse(message.has(repeatedInt64));

  assertEquals(0, message.arrayOf(repeatedInt64).length);

  // Check default values.
  assertEquals(0, message.getOrDefault(optionalInt));
  assertEquals('', message.getOrDefault(optionalString));

  // Set some of the fields.
  message.set(optionalString, 'hello!');

  message.add(repeatedInt64, '101');
  message.add(repeatedInt64, '102');

  // Check the fields.
  assertFalse(message.has(optionalInt));

  assertTrue(message.has(optionalString));
  assertTrue(message.hasOptionalString());

  assertTrue(message.has(repeatedInt64));
  assertTrue(message.hasRepeatedInt64());

  // Check the values.
  assertEquals('hello!', message.get(optionalString));
  assertEquals('hello!', message.getOptionalString());

  assertEquals('101', message.get(repeatedInt64, 0));
  assertEquals('102', message.get(repeatedInt64, 1));

  assertEquals('101', message.getRepeatedInt64(0));
  assertEquals('102', message.getRepeatedInt64(1));

  // Check the count.
  assertEquals(0, message.countOf(optionalInt));

  assertEquals(1, message.countOf(optionalString));
  assertEquals(1, message.optionalStringCount());

  assertEquals(2, message.countOf(repeatedInt64));
  assertEquals(2, message.repeatedInt64Count());

  // Check the array.
  assertEquals(2, message.arrayOf(repeatedInt64).length);

  assertEquals(message.get(repeatedInt64, 0),
      message.arrayOf(repeatedInt64)[0]);

  assertEquals(message.get(repeatedInt64, 1),
      message.arrayOf(repeatedInt64)[1]);
}
">n/a</td></tr>
<tr><td>pbliteserializer_test.html</td><td>Success</td><td> 2 passed, 0 failed.</td><td title="

  goog.require('goog.proto2.PbLiteSerializer');
  goog.require('goog.testing.jsunit');
  goog.require('proto2.TestAllTypes');



function testSerializationAndDeserialization() {
  var message = new proto2.TestAllTypes();

  // Set the fields.
  // Singular.
  message.setOptionalInt32(101);
  message.setOptionalInt64('102');
  message.setOptionalUint32(103);
  message.setOptionalUint64('104');
  message.setOptionalSint32(105);
  message.setOptionalSint64('106');
  message.setOptionalFixed32(107);
  message.setOptionalFixed64('108');
  message.setOptionalSfixed32(109);
  message.setOptionalSfixed64('110');
  message.setOptionalFloat(111.5);
  message.setOptionalDouble(112.5);
  message.setOptionalBool(true);
  message.setOptionalString('test');
  message.setOptionalBytes('abcd');

  var group = new proto2.TestAllTypes.OptionalGroup();
  group.setA(111);

  message.setOptionalgroup(group);

  var nestedMessage = new proto2.TestAllTypes.NestedMessage();
  nestedMessage.setB(112);

  message.setOptionalNestedMessage(nestedMessage);

  message.setOptionalNestedEnum(proto2.TestAllTypes.NestedEnum.FOO);

  // Repeated.
  message.addRepeatedInt32(201);
  message.addRepeatedInt32(202);

  // Skip a few repeated fields so we can test how null array values are
  // handled.
  message.addRepeatedString('foo');
  message.addRepeatedString('bar');

  // Serialize.
  var serializer = new goog.proto2.PbLiteSerializer();
  var pblite = serializer.serialize(message);

  assertTrue(goog.isArray(pblite));

  // Assert that everything serialized properly.
  assertEquals(101, pblite[1]);
  assertEquals('102', pblite[2]);
  assertEquals(103, pblite[3]);
  assertEquals('104', pblite[4]);
  assertEquals(105, pblite[5]);
  assertEquals('106', pblite[6]);
  assertEquals(107, pblite[7]);
  assertEquals('108', pblite[8]);
  assertEquals(109, pblite[9]);
  assertEquals('110', pblite[10]);
  assertEquals(111.5, pblite[11]);
  assertEquals(112.5, pblite[12]);
  assertEquals(1, pblite[13]); // true is serialized as 1
  assertEquals('test', pblite[14]);
  assertEquals('abcd', pblite[15]);

  assertEquals(111, pblite[16][17]);
  assertEquals(112, pblite[18][1]);

  assertTrue(pblite[19] === undefined);
  assertTrue(pblite[20] === undefined);

  assertEquals(proto2.TestAllTypes.NestedEnum.FOO, pblite[21]);

  assertEquals(201, pblite[31][0]);
  assertEquals(202, pblite[31][1]);
  assertEquals('foo', pblite[44][0]);
  assertEquals('bar', pblite[44][1]);

  var serializer = new goog.proto2.PbLiteSerializer();
  // Deserialize.
  var messageCopy =
    serializer.deserialize(proto2.TestAllTypes.getDescriptor(), pblite);

  assertNotEquals(messageCopy, message);

  assertDeserializationMatches(messageCopy);
}

function testDeserializationFromExternalSource() {
  // Test deserialization where the JSON array is initialized from something
  // outside the Closure proto2 library, such as the JsPbLite library, or
  // manually as in this test.
  var pblite = [
    , // 0
    101, // 1
    '102', // 2
    103, // 3
    '104', // 4
    105, // 5
    '106', // 6
    107, // 7
    '108', // 8
    109, // 9
    '110', // 10
    111.5, // 11
    112.5, // 12
    1, // 13
    'test', // 14
    'abcd', // 15
    [,,,,,,,,,,,,,,,,,111], // 16, note the 17 commas so value is index 17
    , // 17
    [,112], // 18
    ,, // 19-20
    proto2.TestAllTypes.NestedEnum.FOO, // 21
    ,,,,,,,,, // 22-30
    [201, 202], // 31
    ,,,,,,,,,,,, // 32-43
    ['foo', 'bar'], // 44
    ,,,, // 45-49
  ];

  var serializer = new goog.proto2.PbLiteSerializer();
  // Deserialize.
  var messageCopy =
    serializer.deserialize(proto2.TestAllTypes.getDescriptor(), pblite);

  assertDeserializationMatches(messageCopy);

  // http://b/issue?id=2928075
  assertFalse(messageCopy.hasRepeatedInt64());
  assertEquals(0, messageCopy.repeatedInt64Count());
  messageCopy.repeatedInt64Array();
  assertFalse(messageCopy.hasRepeatedInt64());
  assertEquals(0, messageCopy.repeatedInt64Count());
}

function assertDeserializationMatches(messageCopy) {
  assertNotNull(messageCopy);

  assertTrue(messageCopy.hasOptionalInt32());
  assertTrue(messageCopy.hasOptionalInt64());
  assertTrue(messageCopy.hasOptionalUint32());
  assertTrue(messageCopy.hasOptionalUint64());
  assertTrue(messageCopy.hasOptionalSint32());
  assertTrue(messageCopy.hasOptionalSint64());
  assertTrue(messageCopy.hasOptionalFixed32());
  assertTrue(messageCopy.hasOptionalFixed64());
  assertTrue(messageCopy.hasOptionalSfixed32());
  assertTrue(messageCopy.hasOptionalSfixed64());
  assertTrue(messageCopy.hasOptionalFloat());
  assertTrue(messageCopy.hasOptionalDouble());
  assertTrue(messageCopy.hasOptionalBool());
  assertTrue(messageCopy.hasOptionalString());
  assertTrue(messageCopy.hasOptionalBytes());
  assertTrue(messageCopy.hasOptionalgroup());
  assertTrue(messageCopy.hasOptionalNestedMessage());
  assertTrue(messageCopy.hasOptionalNestedEnum());

  assertTrue(messageCopy.hasRepeatedInt32());
  assertFalse(messageCopy.hasRepeatedInt64());
  assertFalse(messageCopy.hasRepeatedUint32());
  assertFalse(messageCopy.hasRepeatedUint64());
  assertFalse(messageCopy.hasRepeatedSint32());
  assertFalse(messageCopy.hasRepeatedSint64());
  assertFalse(messageCopy.hasRepeatedFixed32());
  assertFalse(messageCopy.hasRepeatedFixed64());
  assertFalse(messageCopy.hasRepeatedSfixed32());
  assertFalse(messageCopy.hasRepeatedSfixed64());
  assertFalse(messageCopy.hasRepeatedFloat());
  assertFalse(messageCopy.hasRepeatedDouble());
  assertFalse(messageCopy.hasRepeatedBool());
  assertTrue(messageCopy.hasRepeatedString());
  assertFalse(messageCopy.hasRepeatedBytes());
  assertFalse(messageCopy.hasRepeatedgroup());
  assertFalse(messageCopy.hasRepeatedNestedMessage());
  assertFalse(messageCopy.hasRepeatedNestedEnum());

  assertEquals(1, messageCopy.optionalInt32Count());
  assertEquals(1, messageCopy.optionalInt64Count());
  assertEquals(1, messageCopy.optionalUint32Count());
  assertEquals(1, messageCopy.optionalUint64Count());
  assertEquals(1, messageCopy.optionalSint32Count());
  assertEquals(1, messageCopy.optionalSint64Count());
  assertEquals(1, messageCopy.optionalFixed32Count());
  assertEquals(1, messageCopy.optionalFixed64Count());
  assertEquals(1, messageCopy.optionalSfixed32Count());
  assertEquals(1, messageCopy.optionalSfixed64Count());
  assertEquals(1, messageCopy.optionalFloatCount());
  assertEquals(1, messageCopy.optionalDoubleCount());
  assertEquals(1, messageCopy.optionalBoolCount());
  assertEquals(1, messageCopy.optionalStringCount());
  assertEquals(1, messageCopy.optionalBytesCount());
  assertEquals(1, messageCopy.optionalgroupCount());
  assertEquals(1, messageCopy.optionalNestedMessageCount());
  assertEquals(1, messageCopy.optionalNestedEnumCount());

  assertEquals(2, messageCopy.repeatedInt32Count());
  assertEquals(0, messageCopy.repeatedInt64Count());
  assertEquals(0, messageCopy.repeatedUint32Count());
  assertEquals(0, messageCopy.repeatedUint64Count());
  assertEquals(0, messageCopy.repeatedSint32Count());
  assertEquals(0, messageCopy.repeatedSint64Count());
  assertEquals(0, messageCopy.repeatedFixed32Count());
  assertEquals(0, messageCopy.repeatedFixed64Count());
  assertEquals(0, messageCopy.repeatedSfixed32Count());
  assertEquals(0, messageCopy.repeatedSfixed64Count());
  assertEquals(0, messageCopy.repeatedFloatCount());
  assertEquals(0, messageCopy.repeatedDoubleCount());
  assertEquals(0, messageCopy.repeatedBoolCount());
  assertEquals(2, messageCopy.repeatedStringCount());
  assertEquals(0, messageCopy.repeatedBytesCount());
  assertEquals(0, messageCopy.repeatedgroupCount());
  assertEquals(0, messageCopy.repeatedNestedMessageCount());
  assertEquals(0, messageCopy.repeatedNestedEnumCount());

  assertEquals(101, messageCopy.getOptionalInt32());
  assertEquals('102', messageCopy.getOptionalInt64());
  assertEquals(103, messageCopy.getOptionalUint32());
  assertEquals('104', messageCopy.getOptionalUint64());
  assertEquals(105, messageCopy.getOptionalSint32());
  assertEquals('106', messageCopy.getOptionalSint64());
  assertEquals(107, messageCopy.getOptionalFixed32());
  assertEquals('108', messageCopy.getOptionalFixed64());
  assertEquals(109, messageCopy.getOptionalSfixed32());
  assertEquals('110', messageCopy.getOptionalSfixed64());
  assertEquals(111.5, messageCopy.getOptionalFloat());
  assertEquals(112.5, messageCopy.getOptionalDouble());
  assertEquals(true, messageCopy.getOptionalBool());
  assertEquals('test', messageCopy.getOptionalString());
  assertEquals('abcd', messageCopy.getOptionalBytes());
  assertEquals(111, messageCopy.getOptionalgroup().getA());

  assertEquals(112, messageCopy.getOptionalNestedMessage().getB());

  assertEquals(proto2.TestAllTypes.NestedEnum.FOO,
    messageCopy.getOptionalNestedEnum());

  assertEquals(201, messageCopy.getRepeatedInt32(0));
  assertEquals(202, messageCopy.getRepeatedInt32(1));
}

">n/a</td></tr>
<tr><td>iter_test.html</td><td>Fail</td><td> 0 passed, 11 failed.</td><td title="

  goog.require('goog.dom.iter.AncestorIterator');
  goog.require('goog.dom.iter.ChildIterator');
  goog.require('goog.dom.iter.SiblingIterator');
  goog.require('goog.dom.NodeType');
  goog.require('goog.testing.dom');
  goog.require('goog.testing.jsunit');


var test = goog.dom.getElement('test');
var br = goog.dom.getElement('br');

function testNextSibling() {
  goog.testing.dom.assertNodesMatch(
      new goog.dom.iter.SiblingIterator(test.firstChild),
      ['#br', 'def']);
}

function testNextSiblingInclusive() {
  goog.testing.dom.assertNodesMatch(
      new goog.dom.iter.SiblingIterator(test.firstChild, true),
      ['abc', '#br', 'def']);
}

function testPreviousSibling() {
  goog.testing.dom.assertNodesMatch(
      new goog.dom.iter.SiblingIterator(test.lastChild, false, true),
      ['#br', 'abc']);
}

function testPreviousSiblingInclusive() {
  goog.testing.dom.assertNodesMatch(
      new goog.dom.iter.SiblingIterator(test.lastChild, true, true),
      ['def', '#br', 'abc']);
}

function testChildIterator() {
  goog.testing.dom.assertNodesMatch(
      new goog.dom.iter.ChildIterator(test),
      ['abc', '#br', 'def']);
}

function testChildIteratorIndex() {
  goog.testing.dom.assertNodesMatch(
      new goog.dom.iter.ChildIterator(test, false, 1),
      ['#br', 'def']);
}

function testChildIteratorReverse() {
  goog.testing.dom.assertNodesMatch(
      new goog.dom.iter.ChildIterator(test, true),
      ['def', '#br', 'abc']);
}

function testEmptyChildIteratorReverse() {
  goog.testing.dom.assertNodesMatch(
      new goog.dom.iter.ChildIterator(br, true), []);
}

function testChildIteratorIndexReverse() {
  goog.testing.dom.assertNodesMatch(
      new goog.dom.iter.ChildIterator(test, true, 1),
      ['#br', 'abc']);
}

function testAncestorIterator() {
  goog.testing.dom.assertNodesMatch(
      new goog.dom.iter.AncestorIterator(br),
      ['#test', '#body', '#html', goog.dom.NodeType.DOCUMENT]);
}

function testAncestorIteratorInclusive() {
  goog.testing.dom.assertNodesMatch(
      new goog.dom.iter.AncestorIterator(br, true),
      ['#br', '#test', '#body', '#html', goog.dom.NodeType.DOCUMENT]);
};

">11 of 11 tests run in 8ms.<br />0 passed, 11 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testAncestorIterator<br />Used entire match array<br />Expected <4> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> Object.assertNodesMatch at testing/dom.js:88:3<br />> testAncestorIterator at _tmpclosuretest.js:68:20<br />ERROR in testAncestorIteratorInclusive<br />Expected element at position 0<br />Expected <1> (Number) but was <undefined><br />> assertEquals at testing/asserts.js:289:3<br />> anonymous at testing/dom.js:72:<br />> Object.forEach at iter/iter.js:164:11<br />> Object.assertNodesMatch at testing/dom.js:59:13<br />> testAncestorIteratorInclusive at _tmpclosuretest.js:74:20<br />ERROR in testChildIterator<br />Cannot read property '0' of undefined<br />ERROR in testChildIteratorIndex<br />Cannot read property '1' of undefined<br />ERROR in testChildIteratorIndexReverse<br />Cannot read property '1' of undefined<br />ERROR in testChildIteratorReverse<br />Cannot read property 'length' of undefined<br />ERROR in testEmptyChildIteratorReverse<br />Cannot read property 'length' of undefined<br />ERROR in testNextSibling<br />Used entire match array<br />Expected <2> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> Object.assertNodesMatch at testing/dom.js:88:3<br />> testNextSibling at _tmpclosuretest.js:15:20<br />ERROR in testNextSiblingInclusive<br />Used entire match array<br />Expected <3> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> Object.assertNodesMatch at testing/dom.js:88:3<br />> testNextSiblingInclusive at _tmpclosuretest.js:21:20<br />ERROR in testPreviousSibling<br />Used entire match array<br />Expected <2> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> Object.assertNodesMatch at testing/dom.js:88:3<br />> testPreviousSibling at _tmpclosuretest.js:27:20<br />ERROR in testPreviousSiblingInclusive<br />Used entire match array<br />Expected <3> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> Object.assertNodesMatch at testing/dom.js:88:3<br />> testPreviousSiblingInclusive at _tmpclosuretest.js:33:20<br /></td></tr>
<tr><td>memoize_test.html</td><td>Success</td><td> 6 passed, 0 failed.</td><td title="

  goog.require('goog.memoize');
  goog.require('goog.testing.jsunit');



function testNoArgs() {
  var called = 0;
  var f = goog.memoize(function() {
    called++;
    return 10;
  });

  assertEquals('f() 1st call', 10, f());
  assertEquals('f() 2nd call', 10, f());
  assertEquals('f() 3rd call', 10, f.call());
  assertEquals('f() called once', 1, called);
}

function testOneOptionalArgSimple() {
  var called = 0;
  var f = goog.memoize(function(opt_x) {
    called++;
    return arguments.length == 0 ? "no args" : opt_x;
  });

  assertEquals('f() 1st call', "no args", f());
  assertEquals('f() 2nd call', "no args", f());
  assertEquals('f(0) 1st call', 0, f(0));
  assertEquals('f(0) 2nd call', 0, f(0));
  assertEquals('f("") 1st call', '', f(''));
  assertEquals('f("") 2nd call', '', f(''));
  assertEquals('f("0") 1st call', '0', f('0'));
  assertEquals('f("0") 1st call', '0', f('0'));
  assertEquals('f(null) 1st call', null, f(null));
  assertEquals('f(null) 2nd call', null, f(null));
  assertEquals('f(undefined) 1st call', undefined, f(undefined));
  assertEquals('f(undefined) 2nd call', undefined, f(undefined));

  assertEquals('f(opt_x) called 6 times', 6, called);
}

function testProtoFunctions() {
  var fcalled = 0;
  var gcalled = 0;
  var Class = function(x) {
    this.x = x;
    this.f = goog.memoize(function(y) {
      fcalled++;
      return this.x + y;
    });
  };
  Class.prototype.g = goog.memoize(function(z) {
    gcalled++;
    return this.x - z;
  });

  var obj1 = new Class(10);
  var obj2 = new Class(20);

  assertEquals('10+1', 11, obj1.f(1));
  assertEquals('10+2', 12, obj1.f(2));
  assertEquals('10+2 again', 12, obj1.f(2));
  assertEquals('f called twice', 2, fcalled);

  assertEquals('10-1', 9, obj1.g(1));
  assertEquals('10-2', 8, obj1.g(2));
  assertEquals('10-2 again', 8, obj1.g(2));
  assertEquals('g called twice', 2, gcalled);

  assertEquals('20+1', 21, obj2.f(1));
  assertEquals('20+2', 22, obj2.f(2));
  assertEquals('20+2 again', 22, obj2.f(2));
  assertEquals('f called 4 times', 4, fcalled);

  assertEquals('20-1', 19, obj2.g(1));
  assertEquals('20-2', 18, obj2.g(2));
  assertEquals('20-2 again', 18, obj2.g(2));
  assertEquals('g called 4 times', 4, gcalled);
}

function testCustomSerializer() {
  var called = 0;
  var serializer = function(this_context, args) {
    return String(args[0].getTime());
  }
  var getYear = goog.memoize(function(date) {
    called++;
    return date.getFullYear();
  }, serializer);

  assertEquals('getYear(2008, 0, 1), 1st', 2008, getYear(new Date(2008, 0, 1)));
  assertEquals('getYear(2008, 0, 1), 2nd', 2008, getYear(new Date(2008, 0, 1)));
  assertEquals('getYear called once', 1, called);

  assertEquals('getYear(2007, 0, 1)', 2007, getYear(new Date(2007, 0, 1)));
  assertEquals('getYear called twice', 2, called);
}

function testClearCache() {
  var computed = 0;
  var identity = goog.memoize(function(x) {
    computed++;
    return x;
  });
  assertEquals('identity(1)==1', 1, identity(1));
  assertEquals('identity(1)==1', 1, identity(1));
  assertEquals('identity(1)==1', 1, identity(1));
  assertEquals('Expected memozation', 1, computed);

  goog.memoize.clearCache(goog.global);
  assertEquals('identity(1)==1', 1, identity(1));
  assertEquals('identity(1)==1', 1, identity(1));
  assertEquals('Expected cleared memoization cache', 2, computed);
}

function testDisableMemoize() {
  var computed = 0;
  var identity = goog.memoize(function(x) {
    computed++;
    return x;
  });

  assertEquals('return value on first call', 1, identity(1));
  assertEquals('return value on second call (memoized)', 1, identity(1));
  assertEquals('computed once', 1, computed);

  goog.memoize.ENABLE_MEMOIZE = false;

  try {
    assertEquals('return value after disabled memoization', 1, identity(1));
    assertEquals('computed again', 2, computed);
  } finally {
    goog.memoize.ENABLE_MEMOIZE = true;
  }

  assertEquals('return value after reenabled memoization', 1, identity(1));
  assertEquals('not computed again', 2, computed);
}

">n/a</td></tr>
<tr><td>field_test.html</td><td>Fail</td><td> 20 passed, 12 failed.</td><td title="

  goog.require('goog.dom.Range');
  goog.require('goog.editor.Field');
  goog.require('goog.editor.Plugin');
  goog.require('goog.editor.Command');
  goog.require('goog.events');
  goog.require('goog.events.KeyCodes');
  goog.require('goog.functions');
  goog.require('goog.testing.LooseMock');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.dom');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.recordFunction');
  goog.require('goog.userAgent');



var HTML;

function setUp() {
  HTML = goog.dom.getElement('parent').innerHTML;
}

function tearDown() {
  goog.dom.getElement('parent').innerHTML = HTML;

  // NOTE(nicksantos): I think IE is blowing up on this call because
  // it is lame. It manifests its lameness by throwing an exception.
  // Kudos to XT for helping me to figure this out.
  try {
    goog.events.removeAll();
  } catch (e) {}
}

// Tests for the plugin interface.

/**
 * Dummy plugin for test usage.
 * @constructor
 * @extends {goog.editor.Plugin}
 */
function TestPlugin () {
  this.getTrogClassId = function() {
    return 'TestPlugin';
  };

  this.handleKeyDown = goog.nullFunction;
  this.handleKeyPress = goog.nullFunction;
  this.handleKeyUp = goog.nullFunction;
  this.handleKeyboardShortcut = goog.nullFunction;
  this.isSupportedCommand = goog.nullFunction;
  this.execCommandInternal = goog.nullFunction;
  this.queryCommandValue = goog.nullFunction;
  this.activeOnUneditableFields = goog.nullFunction;
  this.handleSelectionChange = goog.nullFunction;
}
goog.inherits(TestPlugin, goog.editor.Plugin);


/**
 * Tests that calling registerPlugin will add the plugin to the
 * plugin map.
 */
function testRegisterPlugin() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();

  editableField.registerPlugin(plugin);

  assertEquals('Registered plugin must be in protected plugin map.',
      plugin, editableField.plugins_[plugin.getTrogClassId()]);
  assertEquals('Plugin has a keydown handler, should be in keydown map',
      plugin,
      editableField.indexedPlugins_[goog.editor.Plugin.Op.KEYDOWN][0]);
  assertEquals('Plugin has a keypress handler, should be in keypress map',
      plugin,
      editableField.indexedPlugins_[goog.editor.Plugin.Op.KEYPRESS][0]);
  assertEquals('Plugin has a keyup handler, should be in keuup map',
      plugin,
      editableField.indexedPlugins_[goog.editor.Plugin.Op.KEYUP][0]);
  assertEquals(
      'Plugin has a selectionchange handler, should be in selectionchange map',
      plugin,
      editableField.indexedPlugins_[goog.editor.Plugin.Op.SELECTION][0]);
  assertEquals('Plugin has a shortcut handler, should be in shortcut map',
      plugin,
      editableField.indexedPlugins_[goog.editor.Plugin.Op.SHORTCUT][0]);
  assertEquals('Plugin has a execCommand, should be in execCommand map',
      plugin,
      editableField.indexedPlugins_[goog.editor.Plugin.Op.EXEC_COMMAND][0]);
  assertEquals('Plugin has a queryCommand, should be in queryCommand map',
      plugin,
      editableField.indexedPlugins_[goog.editor.Plugin.Op.QUERY_COMMAND][0]);
  assertEquals('Plugin does not have a prepareContentsHtml,' +
      'should not be in prepareContentsHtml map',
      undefined,
      editableField.indexedPlugins_[
          goog.editor.Plugin.Op.PREPARE_CONTENTS_HTML][0]);
  assertEquals('Plugin does not have a cleanContentsDom,' +
      'should not be in cleanContentsDom map',
      undefined,
      editableField.indexedPlugins_[
          goog.editor.Plugin.Op.CLEAN_CONTENTS_DOM][0]);
  assertEquals('Plugin does not have a cleanContentsHtml,' +
      'should not be in cleanContentsHtml map',
      undefined,
      editableField.indexedPlugins_[
          goog.editor.Plugin.Op.CLEAN_CONTENTS_HTML][0]);

  editableField.dispose();
}

/**
 * Tests that calling unregisterPlugin will remove the plugin from
 * the map.
 */
function testUnregisterPlugin() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();

  editableField.registerPlugin(plugin);
  editableField.unregisterPlugin(plugin);

  assertUndefined('Unregistered plugin must not be in protected plugin map.',
      editableField.plugins_[plugin.getTrogClassId()]);

  editableField.dispose();
}

/**
 * Tests that registered plugins can be fetched by their id.
 */
function testGetPluginByClassId() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();

  assertUndefined('Must not be able to get unregistered plugins by class id.',
      editableField.getPluginByClassId(plugin.getTrogClassId()));

  editableField.registerPlugin(plugin);
  assertEquals('Must be able to get registered plugins by class id.',
      plugin, editableField.getPluginByClassId(plugin.getTrogClassId()));
  editableField.dispose();
}

/**
 * Tests that plugins get auto disposed by default when the field is disposed.
 * Tests that plugins with setAutoDispose(false) do not get disposed when the
 * field is disposed.
 */
function testDisposed_PluginAutoDispose() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();

  var noDisposePlugin = new goog.editor.Plugin();
  noDisposePlugin.getTrogClassId = function() {
    return 'noDisposeId';
  };
  noDisposePlugin.setAutoDispose(false);

  editableField.registerPlugin(plugin);
  editableField.registerPlugin(noDisposePlugin);
  editableField.dispose();
  assert(editableField.isDisposed());
  assertTrue(plugin.isDisposed());
  assertFalse(noDisposePlugin.isDisposed());
}

var STRING_KEY = String.fromCharCode(goog.events.KeyCodes.A).toLowerCase();

/**
 * @return {goog.events.Event} Returns an event for a keyboard shortcut
 * for the letter 'a'
 */
function getBrowserEvent() {
  var e = new goog.events.BrowserEvent();
  e.ctrlKey = true;
  e.metaKey = true;
  e.charCode = goog.events.KeyCodes.A;
  return e;
}

/**
 * Tests that plugins are disabled when the field is made uneditable.
 */

function testMakeUneditableDisablesPlugins() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();

  var calls = 0;
  plugin.disable = function(field) {
    assertEquals(editableField, field);
    assertTrue(field.isUneditable());
    calls++;
  };

  editableField.registerPlugin(plugin);
  editableField.makeEditable();

  assertEquals(0, calls);
  editableField.makeUneditable();

  assertEquals(1, calls);

  editableField.dispose();
}

/**
 * Test that if a plugin registers keyup, it gets called.
 */
function testPluginKeyUp() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();
  var e = getBrowserEvent();

  var mockPlugin = new goog.testing.LooseMock(plugin);
  mockPlugin.getTrogClassId().$returns('mockPlugin');
  mockPlugin.registerFieldObject(editableField);
  mockPlugin.isEnabled(editableField).$anyTimes().$returns(true);
  mockPlugin.handleKeyUp(e);
  mockPlugin.$replay();

  editableField.registerPlugin(mockPlugin);

  editableField.handleKeyUp_(e);

  mockPlugin.$verify();
}

/**
 * Test that if a plugin registers keydown, it gets called.
 */
function testPluginKeyDown() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();
  var e = getBrowserEvent();

  var mockPlugin = new goog.testing.LooseMock(plugin);
  mockPlugin.getTrogClassId().$returns('mockPlugin');
  mockPlugin.registerFieldObject(editableField);
  mockPlugin.isEnabled(editableField).$anyTimes().$returns(true);
  mockPlugin.handleKeyDown(e).$returns(true);
  mockPlugin.$replay();

  editableField.registerPlugin(mockPlugin);

  editableField.handleKeyDown_(e);

  mockPlugin.$verify();
}

/**
 * Test that if a plugin registers keypress, it gets called.
 */
function testPluginKeyPress() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();
  var e = getBrowserEvent();

  var mockPlugin = new goog.testing.LooseMock(plugin);
  mockPlugin.getTrogClassId().$returns('mockPlugin');
  mockPlugin.registerFieldObject(editableField);
  mockPlugin.isEnabled(editableField).$anyTimes().$returns(true);
  mockPlugin.handleKeyPress(e).$returns(true);
  mockPlugin.$replay();

  editableField.registerPlugin(mockPlugin);

  editableField.handleKeyPress_(e);

  mockPlugin.$verify();
}

/**
 * If one plugin handles a key event, the rest of the plugins do not get their
 * key handlers invoked.
 */
function testHandledKeyEvent() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();
  var e = getBrowserEvent();

  var mockPlugin1 = new goog.testing.LooseMock(plugin);
  mockPlugin1.getTrogClassId().$returns('mockPlugin1');
  mockPlugin1.registerFieldObject(editableField);
  mockPlugin1.isEnabled(editableField).$anyTimes().$returns(true);
  if (goog.editor.BrowserFeature.USES_KEYDOWN) {
    mockPlugin1.handleKeyDown(e).$returns(true);
  } else {
    mockPlugin1.handleKeyPress(e).$returns(true);
  }
  mockPlugin1.handleKeyUp(e).$returns(true);
  mockPlugin1.$replay();

  var mockPlugin2 = new goog.testing.LooseMock(plugin);
  mockPlugin2.getTrogClassId().$returns('mockPlugin2');
  mockPlugin2.registerFieldObject(editableField);
  mockPlugin2.isEnabled(editableField).$anyTimes().$returns(true);
  mockPlugin2.$replay();

  editableField.registerPlugin(mockPlugin1);
  editableField.registerPlugin(mockPlugin2);

  editableField.handleKeyUp_(e);
  if (goog.editor.BrowserFeature.USES_KEYDOWN) {
    editableField.handleKeyDown_(e);
  } else {
    editableField.handleKeyPress_(e);
  }

  mockPlugin1.$verify();
  mockPlugin2.$verify();
}

/**
 * If the first plugin does not handle the key event, the next plugin gets
 * a chance to handle it.
 */
function testNotHandledKeyEvent() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();
  var e = getBrowserEvent();

  var mockPlugin1 = new goog.testing.LooseMock(plugin);
  mockPlugin1.getTrogClassId().$returns('mockPlugin1');
  mockPlugin1.registerFieldObject(editableField);
  mockPlugin1.isEnabled(editableField).$anyTimes().$returns(true);
  if (goog.editor.BrowserFeature.USES_KEYDOWN) {
    mockPlugin1.handleKeyDown(e).$returns(false);
  } else {
    mockPlugin1.handleKeyPress(e).$returns(false);
  }
  mockPlugin1.handleKeyUp(e).$returns(false);
  mockPlugin1.$replay();

  var mockPlugin2 = new goog.testing.LooseMock(plugin);
  mockPlugin2.getTrogClassId().$returns('mockPlugin2');
  mockPlugin2.registerFieldObject(editableField);
  mockPlugin2.isEnabled(editableField).$anyTimes().$returns(true);
  if (goog.editor.BrowserFeature.USES_KEYDOWN) {
    mockPlugin2.handleKeyDown(e).$returns(true);
  } else {
    mockPlugin2.handleKeyPress(e).$returns(true);
  }
  mockPlugin2.handleKeyUp(e).$returns(true);
  mockPlugin2.$replay();

  editableField.registerPlugin(mockPlugin1);
  editableField.registerPlugin(mockPlugin2);

  editableField.handleKeyUp_(e);
  if (goog.editor.BrowserFeature.USES_KEYDOWN) {
    editableField.handleKeyDown_(e);
  } else {
    editableField.handleKeyPress_(e);
  }

  mockPlugin1.$verify();
  mockPlugin2.$verify();
}

/**
 * Make sure that handleKeyboardShortcut is called if other key handlers
 * return false.
 */
function testKeyboardShortcutCalled() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();
  var e = getBrowserEvent();

  var mockPlugin = new goog.testing.LooseMock(plugin);
  mockPlugin.getTrogClassId().$returns('mockPlugin');
  mockPlugin.registerFieldObject(editableField);
  mockPlugin.isEnabled(editableField).$anyTimes().$returns(true);
  if (goog.editor.BrowserFeature.USES_KEYDOWN) {
    mockPlugin.handleKeyDown(e).$returns(false);
  } else {
    mockPlugin.handleKeyPress(e).$returns(false);
  }
  mockPlugin.handleKeyboardShortcut(e, STRING_KEY, true).$returns(false);
  mockPlugin.$replay();

  editableField.registerPlugin(mockPlugin);

  if (goog.editor.BrowserFeature.USES_KEYDOWN) {
    editableField.handleKeyDown_(e);
  } else {
    editableField.handleKeyPress_(e);
  }

  mockPlugin.$verify();
}

/**
 * Make sure that handleKeyboardShortcut is not called if other key handlers
 * return true.
 */
function testKeyboardShortcutNotCalled() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();
  var e = getBrowserEvent();

  var mockPlugin = new goog.testing.LooseMock(plugin);
  mockPlugin.getTrogClassId().$returns('mockPlugin');
  mockPlugin.registerFieldObject(editableField);
  mockPlugin.isEnabled(editableField).$anyTimes().$returns(true);
  if (goog.editor.BrowserFeature.USES_KEYDOWN) {
    mockPlugin.handleKeyDown(e).$returns(true);
  } else {
    mockPlugin.handleKeyPress(e).$returns(true);
  }
  mockPlugin.$replay();

  editableField.registerPlugin(mockPlugin);

  if (goog.editor.BrowserFeature.USES_KEYDOWN) {
    editableField.handleKeyDown_(e);
  } else {
    editableField.handleKeyPress_(e);
  }

  mockPlugin.$verify();
}

/**
 * Make sure that handleKeyboardShortcut is not called if alt is pressed.
 * @bug 1363959
 */
function testKeyHandlingAlt() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();
  var e = getBrowserEvent();
  e.altKey = true;

  var mockPlugin = new goog.testing.LooseMock(plugin);
  mockPlugin.getTrogClassId().$returns('mockPlugin');
  mockPlugin.registerFieldObject(editableField);
  mockPlugin.isEnabled(editableField).$anyTimes().$returns(true);
  if (goog.editor.BrowserFeature.USES_KEYDOWN) {
    mockPlugin.handleKeyDown(e).$returns(false);
  } else {
    mockPlugin.handleKeyPress(e).$returns(false);
  }
  mockPlugin.$replay();

  editableField.registerPlugin(mockPlugin);

  if (goog.editor.BrowserFeature.USES_KEYDOWN) {
    editableField.handleKeyDown_(e);
  } else {
    editableField.handleKeyPress_(e);
  }

  mockPlugin.$verify();
}

/**
 * Test that if a plugin has an execCommand function, it gets called
 * but only for supported commands.
 */
function testPluginExecCommand() {
  var plugin = new TestPlugin();
  var passedCommand, passedArg;
  plugin.execCommand = function(command, arg) {
    passedCommand = command;
    passedArg = arg;
  }

  var editableField = new goog.editor.Field('testField');
  editableField.registerPlugin(plugin);
  plugin.enable(editableField);
  plugin.isSupportedCommand = goog.functions.constant(true);

  editableField.execCommand('+indent', true);
  // Verify that the plugin's execCommand was called with the correct
  // args.
  assertEquals('+indent', passedCommand);
  assertTrue(passedArg);

  passedCommand = null;
  passedArg = null;
  plugin.isSupportedCommand = goog.functions.constant(false);

  editableField.execCommand('+outdent', false);
  // Verify that a plugin's execCommand is not called if it isn't a supported
  // command.
  assertNull(passedCommand);
  assertNull(passedArg);

  editableField.dispose();
  plugin.dispose();
}

/**
 * Test that if one plugin supports execCommand, no other plugins
 * get a chance to handle the execComand.
 */
function testSupportedExecCommand() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();

  var mockPlugin1 = new goog.testing.LooseMock(plugin);
  mockPlugin1.getTrogClassId().$returns('mockPlugin1');
  mockPlugin1.registerFieldObject(editableField);
  mockPlugin1.isEnabled(editableField).$anyTimes().$returns(true);
  mockPlugin1.isSupportedCommand('+indent').$returns(true);
  mockPlugin1.execCommandInternal('+indent').$returns(true);
  mockPlugin1.execCommand('+indent').$does(
      function() { mockPlugin1.execCommandInternal('+indent'); });
  mockPlugin1.$replay();

  var mockPlugin2 = new goog.testing.LooseMock(plugin);
  mockPlugin2.getTrogClassId().$returns('mockPlugin2');
  mockPlugin2.registerFieldObject(editableField);
  mockPlugin2.isEnabled(editableField).$anyTimes().$returns(true);
  mockPlugin2.$replay();

  editableField.registerPlugin(mockPlugin1);
  editableField.registerPlugin(mockPlugin2);

  editableField.execCommand('+indent');

  mockPlugin1.$verify();
  mockPlugin2.$verify();
}

/**
 * Test that if the first plugin does not support execCommand, the other
 * plugins get a chance to handle the execCommand.
 */
function testNotSupportedExecCommand() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();

  var mockPlugin1 = new goog.testing.LooseMock(plugin);
  mockPlugin1.getTrogClassId().$returns('mockPlugin1');
  mockPlugin1.registerFieldObject(editableField);
  mockPlugin1.isEnabled(editableField).$anyTimes().$returns(true);
  mockPlugin1.isSupportedCommand('+indent').$returns(false);
  mockPlugin1.$replay();

  var mockPlugin2 = new goog.testing.LooseMock(plugin);
  mockPlugin2.getTrogClassId().$returns('mockPlugin2');
  mockPlugin2.registerFieldObject(editableField);
  mockPlugin2.isEnabled(editableField).$anyTimes().$returns(true);
  mockPlugin2.isSupportedCommand('+indent').$returns(true);
  mockPlugin2.execCommandInternal('+indent').$returns(true);
  mockPlugin2.execCommand('+indent').$does(
      function() { mockPlugin2.execCommandInternal('+indent'); });
  mockPlugin2.$replay();

  editableField.registerPlugin(mockPlugin1);
  editableField.registerPlugin(mockPlugin2);

  editableField.execCommand('+indent');

  mockPlugin1.$verify();
  mockPlugin2.$verify();
}

/**
 * Tests that if a plugin supports a command that its queryCommandValue
 * gets called and no further plugins can handle the queryCommandValue.
 */
function testSupportedQueryCommand() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();

  var mockPlugin1 = new goog.testing.LooseMock(plugin);
  mockPlugin1.getTrogClassId().$returns('mockPlugin1');
  mockPlugin1.registerFieldObject(editableField);
  mockPlugin1.isEnabled(editableField).$anyTimes().$returns(true);
  mockPlugin1.isSupportedCommand('+indent').$returns(true);
  mockPlugin1.queryCommandValue('+indent').$returns(true);
  mockPlugin1.activeOnUneditableFields().$returns(true);
  mockPlugin1.$replay();

  var mockPlugin2 = new goog.testing.LooseMock(plugin);
  mockPlugin2.getTrogClassId().$returns('mockPlugin2');
  mockPlugin2.registerFieldObject(editableField);
  mockPlugin2.isEnabled(editableField).$anyTimes().$returns(true);
  mockPlugin2.$replay();

  editableField.registerPlugin(mockPlugin1);
  editableField.registerPlugin(mockPlugin2);

  editableField.queryCommandValue('+indent');

  mockPlugin1.$verify();
  mockPlugin2.$verify();
}

/**
 * Tests that if the first plugin does not support a command that its
 * queryCommandValue do not get called and the next plugin can handle the
 * queryCommandValue.
 */
function testNotSupportedQueryCommand() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();

  var mockPlugin1 = new goog.testing.LooseMock(plugin);
  mockPlugin1.getTrogClassId().$returns('mockPlugin1');
  mockPlugin1.registerFieldObject(editableField);
  mockPlugin1.isEnabled(editableField).$anyTimes().$returns(true);
  mockPlugin1.isSupportedCommand('+indent').$returns(false);
  mockPlugin1.$replay();

  var mockPlugin2 = new goog.testing.LooseMock(plugin);
  mockPlugin2.getTrogClassId().$returns('mockPlugin2');
  mockPlugin2.registerFieldObject(editableField);
  mockPlugin2.isEnabled(editableField).$anyTimes().$returns(true);
  mockPlugin2.isSupportedCommand('+indent').$returns(true);
  mockPlugin2.queryCommandValue('+indent').$returns(true);
  mockPlugin2.activeOnUneditableFields().$returns(true);
  mockPlugin2.$replay();

  editableField.registerPlugin(mockPlugin1);
  editableField.registerPlugin(mockPlugin2);

  editableField.queryCommandValue('+indent');

  mockPlugin1.$verify();
  mockPlugin2.$verify();
}

/**
 * Tests that if a plugin handles selectionChange that it gets called and
 * no further plugins can handle the selectionChange.
 */
function testHandledSelectionChange() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();
  var e = getBrowserEvent();

  var mockPlugin1 = new goog.testing.LooseMock(plugin);
  mockPlugin1.getTrogClassId().$returns('mockPlugin1');
  mockPlugin1.registerFieldObject(editableField);
  mockPlugin1.isEnabled(editableField).$anyTimes().$returns(true);
  mockPlugin1.handleSelectionChange(e, undefined).$returns(true);
  mockPlugin1.$replay();

  var mockPlugin2 = new goog.testing.LooseMock(plugin);
  mockPlugin2.getTrogClassId().$returns('mockPlugin2');
  mockPlugin2.registerFieldObject(editableField);
  mockPlugin2.isEnabled(editableField).$anyTimes().$returns(true);
  mockPlugin2.$replay();

  editableField.registerPlugin(mockPlugin1);
  editableField.registerPlugin(mockPlugin2);

  editableField.dispatchSelectionChangeEvent(e);

  mockPlugin1.$verify();
  mockPlugin2.$verify();
}

/**
 * Tests that if the first plugin does not handle selectionChange that
 * the next plugin gets a chance to handle it.
 */
function testNotHandledSelectionChange() {
  var editableField = new goog.editor.Field('testField');
  var plugin = new TestPlugin();
  var e = getBrowserEvent();

  var mockPlugin1 = new goog.testing.LooseMock(plugin);
  mockPlugin1.getTrogClassId().$returns('mockPlugin1');
  mockPlugin1.registerFieldObject(editableField);
  mockPlugin1.isEnabled(editableField).$anyTimes().$returns(true);
  mockPlugin1.handleSelectionChange(e, undefined).$returns(false);
  mockPlugin1.$replay();

  var mockPlugin2 = new goog.testing.LooseMock(plugin);
  mockPlugin2.getTrogClassId().$returns('mockPlugin2');
  mockPlugin2.registerFieldObject(editableField);
  mockPlugin2.isEnabled(editableField).$anyTimes().$returns(true);
  mockPlugin2.handleSelectionChange(e, undefined).$returns(true);
  mockPlugin2.$replay();

  editableField.registerPlugin(mockPlugin1);
  editableField.registerPlugin(mockPlugin2);

  editableField.dispatchSelectionChangeEvent(e);

  mockPlugin1.$verify();
  mockPlugin2.$verify();
}


// Tests for goog.editor.Field internals.

function testSelectionChange() {
  var editableField = new goog.editor.Field('testField', document);
  var clock = new goog.testing.MockClock(true);
  var selectionChanges = goog.testing.recordFunction();
  goog.events.listen(editableField, goog.editor.Field.EventType.SELECTIONCHANGE,
      selectionChanges);

  editableField.makeEditable();

  // Emulate pressing left arrow key, this should result in SELECTIONCHANGE
  // event after a short timeout.
  editableField.handleKeyUp_({keyCode: goog.events.KeyCodes.LEFT});
  assertEquals('Selection change should be on a timer', 0,
      selectionChanges.getCallCount());
  clock.tick(1000);
  assertEquals('Selection change should fire within 1s', 1,
      selectionChanges.getCallCount());

  // Programically place cursor at start. SELECTIONCHANGE event should be fired.
  editableField.placeCursorAtStart();
  assertEquals('Selection change should fire', 2,
      selectionChanges.getCallCount());

  clock.dispose();
  editableField.dispose();
}

function testSelectionChangeOnMouseUp() {
  var fakeEvent =
      new goog.events.BrowserEvent({type: 'mouseup', target: 'fakeTarget'});
  var editableField = new goog.editor.Field('testField', document);
  var clock = new goog.testing.MockClock(true);
  var selectionChanges = goog.testing.recordFunction();
  goog.events.listen(editableField, goog.editor.Field.EventType.SELECTIONCHANGE,
      selectionChanges);

  var plugin = new TestPlugin();
  plugin.handleSelectionChange = goog.testing.recordFunction();
  editableField.registerPlugin(plugin);

  editableField.makeEditable();

  // Emulate a mouseup event, this should result in an immediate
  // SELECTIONCHANGE, plus a second one in IE after a short timeout.
  editableField.handleMouseUp_(fakeEvent);
  assertEquals('Selection change should fire immediately', 1,
      selectionChanges.getCallCount());
  assertEquals('Plugin should have handled selection change immediately', 1,
      plugin.handleSelectionChange.getCallCount());
  assertEquals('Plugin should have received original browser event to handle',
      fakeEvent, plugin.handleSelectionChange.getLastCall().getArguments()[0]);

  // Pretend another plugin fired a SELECTIONCHANGE in the meantime.
  editableField.dispatchSelectionChangeEvent();
  assertEquals('Second selection change should fire immediately', 2,
      selectionChanges.getCallCount());
  assertEquals('Plugin should have handled second selection change immediately',
       2,  plugin.handleSelectionChange.getCallCount());
  var args = plugin.handleSelectionChange.getLastCall().getArguments();
  assertTrue('Plugin should not have received data from extra firing',
      args.length == 0 ||
      !args[0] && (args.length == 1 || !args[1]));

  // Now check for the extra call in IE.
  clock.tick(1000);
  if (goog.userAgent.IE) {
    assertEquals('Additional selection change should fire within 1s', 3,
        selectionChanges.getCallCount());
    assertEquals('Plugin should have handled selection change within 1s', 3,
        plugin.handleSelectionChange.getCallCount());
    assertEquals('Plugin should have received target of original browser event',
        fakeEvent.target,
        plugin.handleSelectionChange.getLastCall().getArguments().pop());
  } else {
    assertEquals('No additional selection change should fire', 2,
        selectionChanges.getCallCount());
    assertEquals('Plugin should not have handled selection change again', 2,
        plugin.handleSelectionChange.getCallCount());
  }

  clock.dispose();
  editableField.dispose();
}

function testSelectionChangeBeforeUneditable() {
  var editableField = new goog.editor.Field('testField', document);
  var clock = new goog.testing.MockClock(true);
  var selectionChanges = goog.testing.recordFunction();
  goog.events.listen(editableField, goog.editor.Field.EventType.SELECTIONCHANGE,
      selectionChanges);

  editableField.makeEditable();
  editableField.handleKeyUp_({keyCode: goog.events.KeyCodes.LEFT});
  assertEquals('Selection change should be on a timer', 0,
      selectionChanges.getCallCount());
  editableField.makeUneditable();
  assertEquals('Selection change should fire during make uneditable', 1,
      selectionChanges.getCallCount());
  clock.tick(1000);
  assertEquals('No additional selection change should fire', 1,
      selectionChanges.getCallCount());

  clock.dispose();
  editableField.dispose();
}

function testGetEditableDomHelper() {
  var editableField = new goog.editor.Field('testField', document);
  assertNull('Before being made editable, we do not know the dom helper',
      editableField.getEditableDomHelper());
  editableField.makeEditable();
  assertNotNull('After being made editable, we know the dom helper',
      editableField.getEditableDomHelper());
  assertEquals('Document from domHelper should be the editable elements doc',
      goog.dom.getOwnerDocument(editableField.getElement()),
      editableField.getEditableDomHelper().getDocument());
  editableField.dispose();
}


function testQueryCommandValue() {
  var editableField = new goog.editor.Field('testField', document);
  assertFalse(editableField.queryCommandValue('boo'));
  assertObjectEquals({'boo': false, 'aieee': false},
      editableField.queryCommandValue(['boo', 'aieee']));

  editableField.makeEditable();
  assertFalse(editableField.queryCommandValue('boo'));

  editableField.getElement().focus();
  editableField.dispatchSelectionChangeEvent();
  assertNull(editableField.queryCommandValue('boo'));
  assertObjectEquals({'boo': null, 'aieee': null},
      editableField.queryCommandValue(['boo', 'aieee']));
}

function testSetHtml() {
  var editableField = new goog.editor.Field('testField', document);
  var clock = new goog.testing.MockClock(true);

  try {
    var delayedChangeCalled = false;
    goog.events.listen(editableField, goog.editor.Field.EventType.DELAYEDCHANGE,
        function() {
          delayedChangeCalled = true;
        });

    editableField.makeEditable();
    clock.tick(1000);
    assertFalse('Make editable must not fire delayed change.',
        delayedChangeCalled);

    editableField.setHtml(false, 'bar', true /* Don't fire delayed change */);
    goog.testing.dom.assertHtmlContentsMatch('bar', editableField.getElement());
    clock.tick(1000);
    assertFalse('setHtml must not fire delayed change if so configured.',
        delayedChangeCalled);

    editableField.setHtml(false, 'foo', false /* Fire delayed change */);
    goog.testing.dom.assertHtmlContentsMatch('foo', editableField.getElement());
    clock.tick(1000);
    assertTrue('setHtml must fire delayed change by default',
        delayedChangeCalled);
  } finally {
    clock.dispose();
    editableField.dispose();
  }
}

/**
 * Helper to test that the cursor is placed at the beginning of the editable
 * field's contents.
 * @param {string=} opt_html Html to replace the test file default field
 *     contents with.
 * @param {string=} opt_parentId Id of the parent of the node where the cursor
 *     is expected to be placed. If omitted, will expect cursor to be placed in
 *     the first child of the field element (or, if the field has no content, in
 *     the field element itself).
 */
function doTestPlaceCursorAtStart(opt_html, opt_parentId) {
  var editableField = new goog.editor.Field('testField', document);
  editableField.makeEditable();
  // Initially place selection not at the start of the editable field.
  var textNode = editableField.getElement().firstChild;
  goog.dom.Range.createFromNodes(textNode, 1, textNode, 2).select();
  if (opt_html != null) {
    editableField.getElement().innerHTML = opt_html;
  }

  editableField.placeCursorAtStart();
  var range = editableField.getRange();
  assertNotNull(
      'Placing the cursor should result in a range object being available',
      range);
  assertTrue('The range should be collapsed', range.isCollapsed());
  textNode = editableField.getElement().firstChild;
  var startNode = opt_parentId ?
      editableField.getEditableDomHelper().getElement(opt_parentId).firstChild :
      textNode ? textNode : editableField.getElement();
  if (goog.userAgent.WEBKIT && !goog.userAgent.isVersion('528')) {
    // Safari 3 seems to normalize the selection to the shallowest endpoint (in
    // this case the editable element) in all cases tested below. This is OK
    // because when you start typing it magically inserts the text at the
    // deepest endpoint, and even behaves as desired in the case tested by
    // testPlaceCursorAtStartNonImportantTextNode.
    startNode = editableField.getElement();
  }
  assertEquals('The range should start at the specified expected node',
      startNode, range.getStartNode());
  assertEquals('The range should start at the beginning of the node',
      0, range.getStartOffset());
}

function testPlaceCursorAtStart() {
  doTestPlaceCursorAtStart();
}

function testPlaceCursorAtStartEmptyField() {
  doTestPlaceCursorAtStart('');
}

function testPlaceCursorAtStartNonImportantTextNode() {
  doTestPlaceCursorAtStart(
      '\n<span id="important">important text</span>', 'important');
}

// Tests related to change/delayed change events.

function testClearDelayedChange() {
  var clock = new goog.testing.MockClock(true);
  var editableField = new goog.editor.Field('testField', document);
  editableField.makeEditable();

  var delayedChangeCalled = false;
  goog.events.listen(editableField, goog.editor.Field.EventType.DELAYEDCHANGE,
      function() {
        delayedChangeCalled = true;
      });

  // Clears delayed change timer.
  editableField.delayedChangeTimer_.start();
  editableField.clearDelayedChange();
  assertTrue(delayedChangeCalled);
  if (editableField.changeTimerGecko_) {
    assertFalse(editableField.changeTimerGecko_.isActive());
  }
  assertFalse(editableField.delayedChangeTimer_.isActive());

  // Clears delayed changes caused by changeTimerGecko_
  if (editableField.changeTimerGecko_) {
    delayedChangeCalled = false;
    editableField.changeTimerGecko_.start();
    editableField.clearDelayedChange();
    assertTrue(delayedChangeCalled);
    if (editableField.changeTimerGecko_) {
      assertFalse(editableField.changeTimerGecko_.isActive());
    }
    assertFalse(editableField.delayedChangeTimer_.isActive());
  }
  clock.dispose();
}

function testHandleChange() {
  if (goog.editor.BrowserFeature.USE_MUTATION_EVENTS) {
    var editableField = new goog.editor.Field('testField', document);
    editableField.makeEditable();

    editableField.changeTimerGecko_.start();
    editableField.handleChange();
    assertFalse(editableField.changeTimerGecko_.isActive());
  }
}

function testDispatchDelayedChange() {
  var editableField = new goog.editor.Field('testField', document);
  editableField.makeEditable();

  editableField.delayedChangeTimer_.start();
  editableField.dispatchDelayedChange_();
  assertFalse(editableField.delayedChangeTimer_.isActive());
}
">32 of 32 tests run in 46ms.<br />20 passed, 12 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testClearDelayedChange<br />Cannot read property 'cssText' of undefined<br />ERROR in testDispatchDelayedChange<br />Cannot read property 'cssText' of undefined<br />ERROR in testGetEditableDomHelper<br />Cannot read property 'cssText' of undefined<br />ERROR in testMakeUneditableDisablesPlugins<br />Cannot read property 'cssText' of undefined<br />ERROR in testPlaceCursorAtStart<br />Cannot read property 'cssText' of undefined<br />ERROR in testPlaceCursorAtStartEmptyField<br />Cannot read property 'cssText' of undefined<br />ERROR in testPlaceCursorAtStartNonImportantTextNode<br />Cannot read property 'cssText' of undefined<br />ERROR in testQueryCommandValue<br />Cannot read property 'cssText' of undefined<br />ERROR in testSelectionChange<br />Cannot read property 'cssText' of undefined<br />ERROR in testSelectionChangeBeforeUneditable<br />Cannot read property 'cssText' of undefined<br />ERROR in testSelectionChangeOnMouseUp<br />Cannot read property 'cssText' of undefined<br />ERROR in testSetHtml<br />Cannot read property 'cssText' of undefined<br />ERROR in _tmpclosuretest.js<br />ERROR: Test did not restore setTimeout<br /></td></tr>
<tr><td>abstractbubbleplugin_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.TagName');
  goog.require('goog.functions');
  goog.require('goog.editor.plugins.AbstractBubblePlugin');
  goog.require('goog.events.BrowserEvent');
  goog.require('goog.events.EventType');
  goog.require('goog.events.KeyCodes');
  goog.require('goog.style');
  goog.require('goog.testing.editor.FieldMock');
  goog.require('goog.testing.editor.TestHelper');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.LooseMock');
  goog.require('goog.userAgent');



var testHelper;
var fieldDiv = goog.dom.$('field');
var COMMAND = 'base';
var FIELDMOCK;
var bubblePlugin;
var link;
var link2;

function setUpPage() {
  var viewportSize = goog.dom.getViewportSize();
  // Some tests depends on enough size of viewport.
  if (viewportSize.width < 600 || viewportSize.height < 440) {
    window.moveTo(0, 0);
    window.resizeTo(640, 480);
  }
};

function setUp() {
  testHelper = new goog.testing.editor.TestHelper(fieldDiv);
  testHelper.setUpEditableElement();

  FIELDMOCK = new goog.testing.editor.FieldMock();

  bubblePlugin = new goog.editor.plugins.AbstractBubblePlugin(COMMAND);
  bubblePlugin.fieldObject = FIELDMOCK;

  fieldDiv.innerHTML = '<a href="http://www.google.com">Google</a>' +
      '<a href="http://www.google.com">Google2</a>';
  link = fieldDiv.firstChild;
  link2 = fieldDiv.lastChild;

  window.scrollTo(0, 0);
  goog.style.setStyle(document.body, 'direction', 'ltr');
  goog.style.setStyle(document.getElementById('field'), 'position', 'static');
}

function tearDown() {
  bubblePlugin.closeBubble();
  testHelper.tearDownEditableElement();
}

/**
 * This is a helper function for setting up the targetElement with a
 * given direction.
 *
 * @param {string} dir The direction of the targetElement, 'ltr' or 'rtl'.
 */
function prepareTargetWithGivenDirection(dir) {
  goog.style.setStyle(document.body, 'direction', dir);

  fieldDiv.style.direction = dir;
  fieldDiv.innerHTML = '<a href="http://www.google.com">Google</a>';
  link = fieldDiv.firstChild;

  FIELDMOCK.$replay();
  bubblePlugin.createBubbleContents = function(bubbleContainer) {
    bubbleContainer.innerHTML = '<div style="border:1px solid blue;">B</div>';
    goog.style.setStyle(bubbleContainer, 'border', '1px solid white');
  };
  bubblePlugin.registerFieldObject(FIELDMOCK);
  bubblePlugin.enable(FIELDMOCK);
  bubblePlugin.createBubble(link);
}

function helpTestCreateBubble(opt_fn) {
  FIELDMOCK.$replay();
  var numCalled = 0;
  bubblePlugin.createBubbleContents = function(bubbleContainer) {
    numCalled++;
    assertNotNull('bubbleContainer should not be null', bubbleContainer);
  }
  if (opt_fn) {
    opt_fn();
  }
  bubblePlugin.createBubble(link);
  assertEquals('createBubbleContents should be called', 1, numCalled);
  FIELDMOCK.$verify();
}

function testCreateBubble(opt_fn) {
  helpTestCreateBubble(opt_fn);
  assertTrue(bubblePlugin.getSharedBubble_() instanceof goog.ui.editor.Bubble);

  assertTrue('Bubble should be visible', bubblePlugin.isVisible());
}

function testOpeningBubbleCallsOnShow() {
  var numCalled = 0;
  testCreateBubble(function() {
    bubblePlugin.onShow = function() {
      numCalled++;
    };
  });

  assertEquals('onShow should be called', 1, numCalled);
  FIELDMOCK.$verify();
}

function testCloseBubble() {
  testCreateBubble();

  bubblePlugin.closeBubble();
  assertFalse('Bubble should not be visible', bubblePlugin.isVisible());
  FIELDMOCK.$verify();
}

function testZindexBehavior() {
  // Don't use the default return values.
  FIELDMOCK.$reset();
  FIELDMOCK.getAppWindow().$anyTimes().$returns(window);
  FIELDMOCK.getEditableDomHelper().$anyTimes()
      .$returns(goog.dom.getDomHelper(document));
  FIELDMOCK.getBaseZindex().$returns(2);
  bubblePlugin.createBubbleContents = goog.nullFunction;
  FIELDMOCK.$replay();

  bubblePlugin.createBubble(link);
  assertEquals('2',
      '' + bubblePlugin.getSharedBubble_().bubbleContainer_.style.zIndex);

  FIELDMOCK.$verify();
}

function testNoTwoBubblesOpenAtSameTime() {
  FIELDMOCK.$replay();
  var origClose = goog.bind(bubblePlugin.closeBubble, bubblePlugin);;
  var numTimesCloseCalled = 0;
  bubblePlugin.closeBubble = function() {
    numTimesCloseCalled++;
    origClose();
  };
  bubblePlugin.getBubbleTargetFromSelection = goog.functions.identity;
  bubblePlugin.createBubbleContents = goog.nullFunction;

  bubblePlugin.handleSelectionChangeInternal_(link);
  assertEquals(0, numTimesCloseCalled);
  assertEquals(link, bubblePlugin.targetElement_);
  FIELDMOCK.$verify();

  bubblePlugin.handleSelectionChangeInternal_(link2);
  assertEquals(1, numTimesCloseCalled);
  assertEquals(link2, bubblePlugin.targetElement_);
  FIELDMOCK.$verify();
}

function testHandleSelectionChangeWithEvent() {
  FIELDMOCK.$replay();
  var fakeEvent =
      new goog.events.BrowserEvent({type: 'mouseup', target: link});
  bubblePlugin.getBubbleTargetFromSelection = goog.functions.identity;
  bubblePlugin.createBubbleContents = goog.nullFunction;
  bubblePlugin.handleSelectionChange(fakeEvent);
  assertTrue('Bubble should have been opened', bubblePlugin.isVisible());
  assertEquals('Bubble target should be provided event\'s target',
               link, bubblePlugin.targetElement_);
}

function testHandleSelectionChangeWithTarget() {
  FIELDMOCK.$replay();
  bubblePlugin.getBubbleTargetFromSelection = goog.functions.identity;
  bubblePlugin.createBubbleContents = goog.nullFunction;
  bubblePlugin.handleSelectionChange(undefined, link2);
  assertTrue('Bubble should have been opened', bubblePlugin.isVisible());
  assertEquals('Bubble target should be provided target',
               link2, bubblePlugin.targetElement_);
}

/**
 * Regression test for @bug 2945341.
 */
function testSelectOneTextCharacterNoError() {
  FIELDMOCK.$replay();
  bubblePlugin.getBubbleTargetFromSelection = goog.functions.identity;
  bubblePlugin.createBubbleContents = goog.nullFunction;
  // Select first char of first link's text node.
  testHelper.select(link.firstChild, 0, link.firstChild, 1);
  // This should execute without js errors.
  bubblePlugin.handleSelectionChange();
  assertTrue("Bubble should have been opened", bubblePlugin.isVisible());
  FIELDMOCK.$verify();
}

">TypeError: Cannot read property 'clientWidth' of undefined
    at Object.getViewportSize_ (dom/dom.js:452:31)
    at Object.getViewportSize (dom/dom.js:411:19)
    at [object Object].setUpPage (_tmpclosuretest.js:29:31)
    at [object Object].runTests (testing/testcase.js:487:8)
    at [object Object].execute (testing/testrunner.js:266:17)
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:429:6)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>listtabhandler_test.html</td><td>Fail</td><td> 0 passed, 5 failed.</td><td title="


  goog.require('goog.dom');
  goog.require('goog.editor.BrowserFeature');
  goog.require('goog.editor.Command');
  goog.require('goog.editor.Field');
  goog.require('goog.editor.plugins.ListTabHandler');
  goog.require('goog.events.BrowserEvent');
  goog.require('goog.events.KeyCodes');
  goog.require('goog.functions');
  goog.require('goog.testing.StrictMock');
  goog.require('goog.testing.editor.TestHelper');
  goog.require('goog.testing.editor.FieldMock');
  goog.require('goog.testing.jsunit');



var field = goog.dom.getElement('field');
var editableField;
var tabHandler;
var testHelper;

function setUp() {
  editableField = new goog.testing.editor.FieldMock();
  // Modal mode behavior tested as part of AbstractTabHandler tests.
  editableField.inModalMode = goog.functions.FALSE;

  tabHandler = new goog.editor.plugins.ListTabHandler();
  tabHandler.registerFieldObject(editableField);

  testHelper = new goog.testing.editor.TestHelper(field);
  testHelper.setUpEditableElement();
}

function tearDown() {
  editableField = null;
  testHelper.tearDownEditableElement();
  tabHandler.dispose();
}

function testListIndentInLi() {
  field.innerHTML = '<ul><li>Text</li></ul>';

  var testText = field.firstChild.firstChild.firstChild; // div ul li Test
  testHelper.select(testText, 0, testText, 4);

  var event = new goog.testing.StrictMock(goog.events.BrowserEvent);
  event.keyCode = goog.events.KeyCodes.TAB;
  event.shiftKey = false;

  editableField.execCommand(goog.editor.Command.INDENT);
  event.preventDefault();

  editableField.$replay();
  event.$replay();

  assertTrue('Event must be handled',
      tabHandler.handleKeyboardShortcut(event, '', false));

  editableField.$verify();
  event.$verify();
}

function testListIndentContainLi() {
  field.innerHTML = '<ul><li>Text</li></ul>';

  var testText = field.firstChild.firstChild.firstChild; // div ul li Test
  testHelper.select(field.firstChild, 0, testText, 4);

  var event = new goog.testing.StrictMock(goog.events.BrowserEvent);
  event.keyCode = goog.events.KeyCodes.TAB;
  event.shiftKey = false;

  editableField.execCommand(goog.editor.Command.INDENT);
  event.preventDefault();

  editableField.$replay();
  event.$replay();

  assertTrue('Event must be handled',
      tabHandler.handleKeyboardShortcut(event, '', false));

  editableField.$verify();
  event.$verify();
}

function testListOutdentInLi() {
  field.innerHTML = '<ul><li>Text</li></ul>';

  var testText = field.firstChild.firstChild.firstChild; // div ul li Test
  testHelper.select(testText, 0, testText, 4);

  var event = new goog.testing.StrictMock(goog.events.BrowserEvent);
  event.keyCode = goog.events.KeyCodes.TAB;
  event.shiftKey = true;

  editableField.execCommand(goog.editor.Command.OUTDENT);
  event.preventDefault();

  editableField.$replay();
  event.$replay();

  assertTrue('Event must be handled',
      tabHandler.handleKeyboardShortcut(event, '', false));

  editableField.$verify();
  event.$verify();
}

function testListOutdentContainLi() {
  field.innerHTML = '<ul><li>Text</li></ul>';

  var testText = field.firstChild.firstChild.firstChild; // div ul li Test
  testHelper.select(field.firstChild, 0, testText, 4);

  var event = new goog.testing.StrictMock(goog.events.BrowserEvent);
  event.keyCode = goog.events.KeyCodes.TAB;
  event.shiftKey = true;

  editableField.execCommand(goog.editor.Command.OUTDENT);
  event.preventDefault();

  editableField.$replay();
  event.$replay();

  assertTrue('Event must be handled',
      tabHandler.handleKeyboardShortcut(event, '', false));

  editableField.$verify();
  event.$verify();
}


function testNoOp() {
  field.innerHTML = 'Text';

  var testText = field.firstChild;
  testHelper.select(testText, 0, testText, 4);

  var event = new goog.testing.StrictMock(goog.events.BrowserEvent);
  event.keyCode = goog.events.KeyCodes.TAB;
  event.shiftKey = true;

  editableField.$replay();
  event.$replay();

  assertFalse('Event must not be handled',
      tabHandler.handleKeyboardShortcut(event, '', false));

  editableField.$verify();
  event.$verify();
}

">5 of 5 tests run in 30ms.<br />0 passed, 5 failed.<br />6 ms/test. 1 files loaded.<br />ERROR in testListIndentContainLi<br />Cannot set property 'designMode' of undefined<br />ERROR in testListIndentInLi<br />Cannot set property 'designMode' of undefined<br />ERROR in testListOutdentContainLi<br />Cannot set property 'designMode' of undefined<br />ERROR in testListOutdentInLi<br />Cannot set property 'designMode' of undefined<br />ERROR in testNoOp<br />Cannot set property 'designMode' of undefined<br /></td></tr>
<tr><td>linkbubble_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.TagName');
  goog.require('goog.editor.Link');
  goog.require('goog.events.BrowserEvent');
  goog.require('goog.events.Event');
  goog.require('goog.events.KeyCodes');
  goog.require('goog.testing.FunctionMock');
  goog.require('goog.testing.editor.FieldMock');
  goog.require('goog.testing.editor.TestHelper');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');
  goog.require('goog.editor.plugins.LinkBubble');



var fieldDiv = goog.dom.$('field');
var FIELDMOCK;
var linkBubble;
var link;
var mockWindowOpen;
var stubs = new goog.testing.PropertyReplacer();
var testHelper = new goog.testing.editor.TestHelper(
    goog.dom.getElement('field'));

function setUp() {
  testHelper.setUpEditableElement();
  FIELDMOCK = new goog.testing.editor.FieldMock();

  linkBubble = new goog.editor.plugins.LinkBubble();
  linkBubble.fieldObject = FIELDMOCK;

  link = fieldDiv.firstChild;

  mockWindowOpen = new goog.testing.FunctionMock('open');
  stubs.set(window, 'open', mockWindowOpen);
}

function tearDown() {
  linkBubble.closeBubble();
  testHelper.tearDownEditableElement();
  stubs.reset();
}

function testLinkSelected() {
  FIELDMOCK.$replay();
  linkBubble.enable(FIELDMOCK);
  goog.dom.Range.createFromNodeContents(link).select();
  linkBubble.handleSelectionChange();
  assertBubble();
  FIELDMOCK.$verify();
}

function testLinkClicked() {
  FIELDMOCK.$replay();
  linkBubble.enable(FIELDMOCK);
  linkBubble.handleSelectionChange(createMouseEvent(link));
  assertBubble();
  FIELDMOCK.$verify();
}

function testImageLink() {
  FIELDMOCK.$replay();
  linkBubble.enable(FIELDMOCK);
  link.setAttribute('imageanchor', 1);
  linkBubble.handleSelectionChange(createMouseEvent(link));
  assertBubble();
  FIELDMOCK.$verify();
}

function closeBox() {
  var closeBox = goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.DIV,
      'tr_bubble_closebox');
  assertEquals('Should find only one close box', 1, closeBox.length);
  assertNotNull('Found close box', closeBox[0]);
  goog.testing.events.fireClickSequence(closeBox[0]);  
}

function testCloseBox() {
  testLinkClicked();
  closeBox();
  assertNoBubble();
  FIELDMOCK.$verify();
}

function testChangeClicked() {
  FIELDMOCK.execCommand(goog.editor.Command.MODAL_LINK_EDITOR,
      new goog.editor.Link(link, false));
  FIELDMOCK.$registerArgumentListVerifier('execCommand', function(arr1, arr2) {
    return arr1.length == arr2.length &&
           arr1.length == 2 &&
           arr1[0] == goog.editor.Command.MODAL_LINK_EDITOR &&
           arr2[0] == goog.editor.Command.MODAL_LINK_EDITOR &&
           arr1[1] instanceof goog.editor.Link &&
           arr2[1] instanceof goog.editor.Link;
  });
  FIELDMOCK.$times(1);
  FIELDMOCK.$returns(true);
  FIELDMOCK.$replay();
  linkBubble.enable(FIELDMOCK);

  linkBubble.handleSelectionChange(createMouseEvent(link));
  assertBubble();

  goog.testing.events.fireClickSequence(
      goog.dom.$(goog.editor.plugins.LinkBubble.CHANGE_LINK_ID_));
  assertNoBubble();
  FIELDMOCK.$verify();
}

function testDeleteClicked() {
  FIELDMOCK.dispatchBeforeChange();
  FIELDMOCK.$times(1);
  FIELDMOCK.dispatchChange();
  FIELDMOCK.$times(1);
  FIELDMOCK.$replay();
  linkBubble.enable(FIELDMOCK);

  linkBubble.handleSelectionChange(createMouseEvent(link));
  assertBubble();

  goog.testing.events.fireClickSequence(
      goog.dom.$(goog.editor.plugins.LinkBubble.DELETE_LINK_ID_));
  var element = goog.userAgent.GECKO ?  document.body : fieldDiv;
  assertNotEquals('Link removed', element.firstChild.nodeName,
      goog.dom.TagName.A);
  assertNoBubble();
  FIELDMOCK.$verify();
}

function testActionClicked() {
  var SPAN = 'actionSpanId';
  var LINK = 'actionLinkId';
  var toShowCount = 0;
  var actionCount = 0;

  var linkAction = new goog.editor.plugins.LinkBubble.Action(
      SPAN, LINK, 'message',
      function() {
        toShowCount++;
        return toShowCount == 1; // Show it the first time.
      },
      function() {
        actionCount++;
      });

  linkBubble = new goog.editor.plugins.LinkBubble(linkAction);
  linkBubble.fieldObject = FIELDMOCK;
  FIELDMOCK.$replay();
  linkBubble.enable(FIELDMOCK);

  // The first time the bubble is shown, show our custom action.
  linkBubble.handleSelectionChange(createMouseEvent(link));
  assertBubble();
  assertEquals('Should check showing the action', 1, toShowCount);
  assertEquals('Action should not have fired yet', 0, actionCount);

  assertTrue('Action should be visible 1st time', goog.style.isElementShown(
      goog.dom.$(SPAN)));
  goog.testing.events.fireClickSequence(goog.dom.$(LINK));

  assertEquals('Should not check showing again yet', 1, toShowCount);
  assertEquals('Action should be fired', 1, actionCount);

  closeBox();
  assertNoBubble();

  // The action won't be shown the second time around.
  linkBubble.handleSelectionChange(createMouseEvent(link));
  assertBubble();
  assertEquals('Should check showing again', 2, toShowCount);
  assertEquals('Action should not fire again', 1, actionCount);
  assertFalse('Action should not be shown 2nd time', goog.style.isElementShown(
      goog.dom.$(SPAN)));

  FIELDMOCK.$verify();
}

function testLinkTextClicked() {
  mockWindowOpen('http://www.google.com/', '_blank', '');
  mockWindowOpen.$replay();
  FIELDMOCK.$replay();
  linkBubble.enable(FIELDMOCK);

  linkBubble.handleSelectionChange(createMouseEvent(link));
  assertBubble();

  goog.testing.events.fireClickSequence(
      goog.dom.$(goog.editor.plugins.LinkBubble.TEST_LINK_ID_));

  assertBubble();
  mockWindowOpen.$verify();
  FIELDMOCK.$verify();
}

function testLinkTextClickedCustomUrlFn() {
  mockWindowOpen('http://images.google.com/', '_blank', '');
  mockWindowOpen.$replay();
  FIELDMOCK.$replay();
  linkBubble.enable(FIELDMOCK);

  linkBubble.setTestLinkUrlFn(function(url) {
    return url.replace('www', 'images');
  });

  linkBubble.handleSelectionChange(createMouseEvent(link));
  assertBubble();

  goog.testing.events.fireClickSequence(
      goog.dom.$(goog.editor.plugins.LinkBubble.TEST_LINK_ID_));

  assertBubble();
  mockWindowOpen.$verify();
  FIELDMOCK.$verify();
}

/**
 * @bug 763211
 * @bug 2182147
 */
function testLongUrlTestLinkAnchorTextCorrect() {
  FIELDMOCK.$replay();
  linkBubble.enable(FIELDMOCK);

  var longUrl = 'http://www.reallylonglinkthatshouldbetruncated' +
      'becauseitistoolong.com';
  var truncatedLongUrl = goog.string.truncateMiddle(longUrl, 48);

  var longLink = document.createElement('a');
  longLink.href = longUrl;
  longLink.innerHTML = 'Google';
  fieldDiv.appendChild(longLink);

  linkBubble.handleSelectionChange(createMouseEvent(longLink));
  assertBubble();

  var testLinkEl = goog.dom.$(goog.editor.plugins.LinkBubble.TEST_LINK_ID_);
  assertEquals(
      'The test link\'s anchor text should be the truncated URL.',
      truncatedLongUrl,
      testLinkEl.innerHTML);

  fieldDiv.removeChild(longLink);
  FIELDMOCK.$verify();
}

/**
 * @bug 2416024
 */
function testOverridingCreateBubbleContentsDoesntNpeGetTargetUrl() {
  FIELDMOCK.$replay();
  linkBubble.enable(FIELDMOCK);

  stubs.set(linkBubble, 'createBubbleContents',
      function(elem) {
        // getTargetUrl would cause an NPE if urlUtil_ wasn't defined yet.
        linkBubble.getTargetUrl();
      });
  assertNotThrows('Accessing this.urlUtil_ should not NPE',
                  goog.bind(linkBubble.handleSelectionChange,
                            linkBubble, createMouseEvent(link)));

  FIELDMOCK.$verify();
}

function assertBubble() {
  assertTrue('Link bubble visible', linkBubble.isVisible());
  assertNotNull('Link bubble created',
      goog.dom.$(goog.editor.plugins.LinkBubble.LINK_DIV_ID_));
}

function assertNoBubble() {
  assertFalse('Link bubble not visible', linkBubble.isVisible());
  assertNull('Link bubble not created',
      goog.dom.$(goog.editor.plugins.LinkBubble.LINK_DIV_ID_));
}

function createMouseEvent(target) {
  var eventObj = new goog.events.Event(goog.events.EventType.MOUSEUP, target);
  eventObj.button = goog.events.BrowserEvent.MouseButton.LEFT;

  return new goog.events.BrowserEvent(eventObj, target);
}
">Error: Namespace "goog.window" already declared.
    at Error (unknown source)
    at Object.provide (base.js:105:13)
    at window/window.js:20:6
    at [object Object].loadScript_ (/home/ubuntu/Dev/projects/node-goog/lib/goog.js:256:38)
    at /home/ubuntu/Dev/projects/node-goog/lib/goog.js:224:8
    at Object.importScript_ (base.js:455:45)
    at Object.writeScripts_ (base.js:536:14)
    at Object.require (base.js:280:12)
    at _tmpclosuretest.js:15:8
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
</td></tr>
<tr><td>loremipsum_test.html</td><td>Fail</td><td> 0 passed, 5 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.editor.Command');
  goog.require('goog.editor.Field');
  goog.require('goog.editor.plugins.LoremIpsum');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');



var FIELD;
var PLUGIN;
var HTML;
var UPPERCASE_CONTENTS = '<P>THE OWLS ARE NOT WHAT THEY SEEM.</P>';

function setUp() {
  HTML = goog.dom.getElement('root').innerHTML;

  FIELD = new goog.editor.Field('field');

  PLUGIN = new goog.editor.plugins.LoremIpsum(
      'The owls are not what they seem.');
  FIELD.registerPlugin(PLUGIN);
}

function tearDown() {
  FIELD.dispose();
  goog.dom.getElement('root').innerHTML = HTML;
}

function testQueryUsingLorem() {
  FIELD.makeEditable();

  assertTrue(FIELD.queryCommandValue(goog.editor.Command.USING_LOREM));
  FIELD.setHtml(true, 'fresh content', false, true);
  assertFalse(FIELD.queryCommandValue(goog.editor.Command.USING_LOREM));
}

function testUpdateLoremIpsum() {
  goog.dom.getElement('field').innerHTML = 'stuff';

  var loremPlugin = FIELD.getPluginByClassId('LoremIpsum');
  FIELD.makeEditable();
  var content = '<div>foo</div>';

  FIELD.setHtml(false, '', false, /* Don't update lorem */ false);
  assertFalse('Field started with content, lorem must not be enabled.',
      FIELD.queryCommandValue(goog.editor.Command.USING_LOREM));
  FIELD.execCommand(goog.editor.Command.UPDATE_LOREM);
  assertTrue('Field was set to empty, update must turn on lorem ipsum',
      FIELD.queryCommandValue(goog.editor.Command.USING_LOREM));

  FIELD.unregisterPlugin(loremPlugin);
  FIELD.setHtml(false, content, false,
      /* Update (turn off) lorem */ true);
  FIELD.setHtml(false, '', false, /* Don't update lorem */ false);
  FIELD.execCommand(goog.editor.Command.UPDATE_LOREM);
  assertFalse('Field with no lorem message must not use lorem ipsum',
      FIELD.queryCommandValue(goog.editor.Command.USING_LOREM));
  FIELD.registerPlugin(loremPlugin);

  FIELD.setHtml(false, content, false, true);
  FIELD.setHtml(false, '', false, false);
  goog.editor.Field.setActiveFieldId(FIELD.id);
  FIELD.execCommand(goog.editor.Command.UPDATE_LOREM);
  assertFalse('Active field must not use lorem ipsum',
      FIELD.queryCommandValue(goog.editor.Command.USING_LOREM));
  goog.editor.Field.setActiveFieldId(null);

  FIELD.setHtml(false, content, false, true);
  FIELD.setHtml(false, '', false, false);
  FIELD.setModalMode(true);
  FIELD.execCommand(goog.editor.Command.UPDATE_LOREM);
  assertFalse('Must not turn on lorem ipsum while a dialog is open.',
      FIELD.queryCommandValue(goog.editor.Command.USING_LOREM));
  FIELD.setModalMode(true);

  FIELD.dispose();
}

function testLoremIpsumAndGetCleanContents() {
  goog.dom.getElement('field').innerHTML = 'This is a field';
  FIELD.makeEditable();

  // test direct getCleanContents
  assertEquals('field reported wrong contents', 'This is a field',
      FIELD.getCleanContents());

  // test indirect getCleanContents
  var contents = FIELD.getCleanContents();
  assertEquals('field reported wrong contents', 'This is a field', contents);

  // set field html, but explicitly forbid converting to lorem ipsum text
  FIELD.setHtml(false, '&nbsp;', true, false /* no lorem */);
  assertEquals('field contains unexpected contents', getNbsp(),
      FIELD.getElement().innerHTML);
  assertEquals('field reported wrong contents', getNbsp(),
      FIELD.getCleanContents());

  // now set field html allowing lorem
  FIELD.setHtml(false, '&nbsp;', true, true /* lorem */);
  assertEquals('field reported wrong contents', goog.string.Unicode.NBSP,
      FIELD.getCleanContents());
  assertEquals('field contains unexpected contents', UPPERCASE_CONTENTS,
      FIELD.getElement().innerHTML.toUpperCase());
}

function testLoremIpsumAndGetCleanContents2() {
  // make a field blank before we make it editable, and then check
  // that making it editable activates lorem.
  assert('field is editable', FIELD.isUneditable());
  goog.dom.getElement('field').innerHTML = '   ';

  FIELD.makeEditable();
  assertEquals('field contains unexpected contents',
      UPPERCASE_CONTENTS, FIELD.getElement().innerHTML.toUpperCase());

  FIELD.makeUneditable();
  assertEquals('field contains unexpected contents',
      UPPERCASE_CONTENTS, goog.dom.getElement('field').innerHTML.toUpperCase());
}

function testLoremIpsumInClickToEditMode() {
  // in click-to-edit mode, trogedit manages the editable state of the editor,
  // so we must manage lorem ipsum in uneditable mode too.
  FIELD.makeEditable();

  assertEquals('field contains unexpected contents',
      UPPERCASE_CONTENTS, FIELD.getElement().innerHTML.toUpperCase());

  FIELD.makeUneditable();
  assertEquals('field contains unexpected contents',
      UPPERCASE_CONTENTS, goog.dom.getElement('field').innerHTML.toUpperCase());
}

function getNbsp() {
  // On WebKit (pre-528) and Opera, &nbsp; shows up as its unicode character in
  // innerHTML under some circumstances.
  return (goog.userAgent.WEBKIT && !goog.userAgent.isVersion('528')) ||
         goog.userAgent.OPERA ? '\u00a0' : '&nbsp;';
}

">5 of 5 tests run in 14ms.<br />0 passed, 5 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testLoremIpsumAndGetCleanContents<br />Cannot read property 'cssText' of undefined<br />ERROR in testLoremIpsumAndGetCleanContents2<br />Cannot read property 'cssText' of undefined<br />ERROR in testLoremIpsumInClickToEditMode<br />Cannot read property 'cssText' of undefined<br />ERROR in testQueryUsingLorem<br />Cannot read property 'cssText' of undefined<br />ERROR in testUpdateLoremIpsum<br />Cannot read property 'cssText' of undefined<br /></td></tr>
<tr><td>undoredostate_test.html</td><td>Success</td><td> 1 passed, 0 failed.</td><td title="

  goog.require('goog.testing.jsunit');
  goog.require('goog.editor.plugins.UndoRedoState');



var asyncState;
var syncState;

function setUp() {
  asyncState = new goog.editor.plugins.UndoRedoState(true);
  syncState = new goog.editor.plugins.UndoRedoState(false);
}

function testIsAsynchronous() {
  assertTrue('Must return true for asynchronous state',
      asyncState.isAsynchronous());
  assertFalse('Must return false for synchronous state',
      syncState.isAsynchronous());
}

">n/a</td></tr>
<tr><td>undoredomanager_test.html</td><td>Success</td><td> 9 passed, 0 failed.</td><td title="

  goog.require('goog.testing.StrictMock');
  goog.require('goog.testing.LooseMock');
  goog.require('goog.testing.jsunit');
  goog.require('goog.editor.plugins.UndoRedo');



var mockState1;
var mockState2;
var mockState3;
var states;
var manager;
var stateChangeCount;
var beforeUndoCount;
var beforeRedoCount;
var preventDefault;

function setUp() {
  manager = new goog.editor.plugins.UndoRedoManager();
  stateChangeCount = 0;  
  goog.events.listen(manager,
      goog.editor.plugins.UndoRedoManager.EventType.STATE_CHANGE,
      function() {
        stateChangeCount++;
      });

  beforeUndoCount = 0;
  preventDefault = false;
  goog.events.listen(manager,
      goog.editor.plugins.UndoRedoManager.EventType.BEFORE_UNDO,
      function(e) {
        beforeUndoCount++;
        if (preventDefault) {
          e.preventDefault();
        }
      });

  beforeRedoCount = 0;
  goog.events.listen(manager,
      goog.editor.plugins.UndoRedoManager.EventType.BEFORE_REDO,
      function(e) {
        beforeRedoCount++;
        if (preventDefault) {
          e.preventDefault();
        }
      });

  mockState1 = new goog.testing.StrictMock(goog.editor.plugins.UndoRedoState);
  mockState2 = new goog.testing.StrictMock(goog.editor.plugins.UndoRedoState);
  mockState3 = new goog.testing.StrictMock(goog.editor.plugins.UndoRedoState);
  states = [mockState1, mockState2, mockState3];

  mockState1.equals = mockState2.equals = mockState3.equals = function(state) {
    return this == state;
  };

  mockState1.isAsynchronous = mockState2.isAsynchronous =
      mockState3.isAsynchronous = function() {
    return false;
  };
}


function tearDown() {
  goog.events.removeAll(manager);
  manager.dispose();
}


/**
 * Adds all the mock states to the undo-redo manager.
 */
function addStatesToManager() {
  manager.addState(states[0]);

  for (var i = 1; i < states.length; i++) {
    var state = states[i];
    manager.addState(state);
  }

  stateChangeCount = 0;
}

/**
 * Resets all mock states so that they are ready for testing.
 */
function resetStates() {
  for (var i = 0; i < states.length; i++) {
    states[i].$reset();
  }
}


function testSetMaxUndoDepth() {
  manager.setMaxUndoDepth(2);
  addStatesToManager();
  assertArrayEquals('Undo stack must contain only the two most recent states.',
      [mockState2, mockState3], manager.undoStack_);
}


function testAddState() {
  var stateAddedCount = 0;
  goog.events.listen(manager,
      goog.editor.plugins.UndoRedoManager.EventType.STATE_ADDED,
      function() {
        stateAddedCount++;
      });

  manager.addState(mockState1);
  assertArrayEquals('Undo stack must contain added state.',
      [mockState1], manager.undoStack_);
  assertEquals('Manager must dispatch one state change event on ' +
      'undo stack 0->1 transition.', 1, stateChangeCount);
  assertEquals('State added must have dispatched once.', 1, stateAddedCount);
  mockState1.$reset();

  // Test adding same state twice.
  manager.addState(mockState1);
  assertArrayEquals('Undo stack must not contain two equal, sequential states.',
      [mockState1], manager.undoStack_);
  assertEquals('Manager must not dispatch state change event when nothing is ' +
      'added to the stack.', 1, stateChangeCount);
  assertEquals('State added must have dispatched once.', 1, stateAddedCount);

  // Test adding a second state.
  manager.addState(mockState2);
  assertArrayEquals('Undo stack must contain both states.',
      [mockState1, mockState2], manager.undoStack_);
  assertEquals('Manager must not dispatch state change event when second ' +
      'state is added to the stack.', 1, stateChangeCount);
  assertEquals('State added must have dispatched twice.', 2, stateAddedCount);

  // Test adding a state when there is state on the redo stack.
  manager.undo();
  assertEquals('Manager must dispatch state change when redo stack goes to 1.',
      2, stateChangeCount);

  manager.addState(mockState3);
  assertArrayEquals('Undo stack must contain states 1 and 3.',
      [mockState1, mockState3], manager.undoStack_);
  assertEquals('Manager must dispatch state change event when redo stack ' +
      'goes to zero.', 3, stateChangeCount);
  assertEquals('State added must have dispatched three times.',
      3, stateAddedCount);
}


function testHasState() {
  assertFalse('New manager must have no undo state.', manager.hasUndoState());
  assertFalse('New manager must have no redo state.', manager.hasRedoState());

  manager.addState(mockState1);
  assertTrue('Manager must have only undo state.', manager.hasUndoState());
  assertFalse('Manager must have no redo state.', manager.hasRedoState());

  manager.undo();
  assertFalse('Manager must have no undo state.', manager.hasUndoState());
  assertTrue('Manager must have only redo state.', manager.hasRedoState());
}


function testClearHistory() {
  addStatesToManager();
  manager.undo();
  stateChangeCount = 0;
  
  manager.clearHistory();
  assertFalse('Undo stack must be empty.', manager.hasUndoState());
  assertFalse('Redo stack must be empty.', manager.hasRedoState());
  assertEquals('State change count must be 1 after clear history.',
      1, stateChangeCount);

  manager.clearHistory();
  assertEquals('Repeated clearHistory must not change state change count.', 
      1, stateChangeCount);
}


function testUndo() {
  addStatesToManager();

  mockState3.undo();
  mockState3.$replay();
  manager.undo();
  assertEquals('Adding first item to redo stack must dispatch state change.',
      1, stateChangeCount);
  assertEquals('Undo must cause before action to dispatch',
      1, beforeUndoCount);
  mockState3.$verify();

  preventDefault = true;
  mockState2.$replay();
  manager.undo();
  assertEquals('No stack transitions between 0 and 1, must not dispatch ' +
      'state change.', 1, stateChangeCount);
  assertEquals('Undo must cause before action to dispatch',
      2, beforeUndoCount);
  mockState2.$verify(); // Verify that undo was prevented.

  preventDefault = false;
  mockState1.undo();
  mockState1.$replay();
  manager.undo();
  assertEquals('Doing last undo operation must dispatch state change.',
      2, stateChangeCount);
  assertEquals('Undo must cause before action to dispatch',
      3, beforeUndoCount);
  mockState1.$verify();
}


function testUndo_Asynchronous() {
  // Using a stub instead of a mock here so that the state can behave as an
  // EventTarget and dispatch events.
  var stubState = new goog.editor.plugins.UndoRedoState(true);
  var undoCalled = false;
  stubState.undo = function() {
    undoCalled = true;
  };
  stubState.redo = goog.nullFunction;
  stubState.equals = function() {
    return false;
  };

  manager.addState(mockState2);
  manager.addState(mockState1);
  manager.addState(stubState);

  manager.undo();
  assertTrue('undoCalled must be true (undo must be called).', undoCalled);
  assertEquals('Undo must cause before action to dispatch',
      1, beforeUndoCount);

  // Calling undo shouldn't actually undo since the first async undo hasn't
  // fired an event yet.
  mockState1.$replay();
  manager.undo();
  mockState1.$verify();
  assertEquals('Before action must not dispatch for pending undo.',
      1, beforeUndoCount);

  // Dispatching undo completed on first undo, should cause the second pending
  // undo to happen.
  mockState1.$reset();
  mockState1.undo();
  mockState1.$replay();
  mockState2.$replay(); // Nothing should happen to mockState2.
  stubState.dispatchEvent(goog.editor.plugins.UndoRedoState.ACTION_COMPLETED);
  mockState1.$verify();
  mockState2.$verify();
  assertEquals('Second undo must cause before action to dispatch',
      2, beforeUndoCount);

  // Test last undo.
  mockState2.$reset();
  mockState2.undo();
  mockState2.$replay();
  manager.undo();
  mockState2.$verify();
  assertEquals('Third undo must cause before action to dispatch',
      3, beforeUndoCount);
}


function testRedo() {
  addStatesToManager();
  manager.undo();
  manager.undo();
  manager.undo();
  resetStates();
  stateChangeCount = 0;

  mockState1.redo();
  mockState1.$replay();
  manager.redo();
  assertEquals('Pushing first item onto undo stack during redo must dispatch ' +
               'state change.', 1, stateChangeCount);
  assertEquals('First redo must cause before action to dispatch',
      1, beforeRedoCount);
  mockState1.$verify();

  preventDefault = true;
  mockState2.$replay();
  manager.redo();
  assertEquals('No stack transitions between 0 and 1, must not dispatch ' +
      'state change.', 1, stateChangeCount);
  assertEquals('Second redo must cause before action to dispatch',
      2, beforeRedoCount);
  mockState2.$verify(); // Verify that redo was prevented.

  preventDefault = false;
  mockState3.redo();
  mockState3.$replay();
  manager.redo();
  assertEquals('Removing last item from redo stack must dispatch state change.',
      2, stateChangeCount);
  assertEquals('Third redo must cause before action to dispatch',
      3, beforeRedoCount);
  mockState3.$verify();
  mockState3.$reset();

  mockState3.undo();
  mockState3.$replay();
  manager.undo();
  assertEquals('Putting item on redo stack must dispatch state change.',
      3, stateChangeCount);
  assertEquals('Undo must cause before action to dispatch',
      4, beforeUndoCount);
  mockState3.$verify();
}


function testRedo_Asynchronous() {
  var stubState = new goog.editor.plugins.UndoRedoState(true);
  var redoCalled = false;
  stubState.redo = function() {
    redoCalled = true;
  };
  stubState.undo = goog.nullFunction;
  stubState.equals = function() {
    return false;
  };

  manager.addState(stubState);
  manager.addState(mockState1);
  manager.addState(mockState2);

  manager.undo();
  manager.undo();
  manager.undo();
  stubState.dispatchEvent(goog.editor.plugins.UndoRedoState.ACTION_COMPLETED);
  resetStates();

  manager.redo();
  assertTrue('redoCalled must be true (redo must be called).', redoCalled);

  // Calling redo shouldn't actually redo since the first async redo hasn't
  // fired an event yet.
  mockState1.$replay();
  manager.redo();
  mockState1.$verify();

  // Dispatching redo completed on first redo, should cause the second pending
  // redo to happen.
  mockState1.$reset();
  mockState1.redo();
  mockState1.$replay();
  mockState2.$replay(); // Nothing should happen to mockState1.
  stubState.dispatchEvent(goog.editor.plugins.UndoRedoState.ACTION_COMPLETED);
  mockState1.$verify();
  mockState2.$verify();

  // Test last redo.
  mockState2.$reset();
  mockState2.redo();
  mockState2.$replay();
  manager.redo();
  mockState2.$verify();
}

function testUndoAndRedoPeek() {
  addStatesToManager();
  manager.undo();

  assertEquals('redoPeek must return the top of the redo stack.',
      manager.redoStack_[manager.redoStack_.length - 1], manager.redoPeek());
  assertEquals('undoPeek must return the top of the undo stack.',
      manager.undoStack_[manager.undoStack_.length - 1], manager.undoPeek());
}
">n/a</td></tr>
<tr><td>tagonenterhandler_test.html</td><td>Fail</td><td> 0 passed, 18 failed.</td><td title="

  goog.require('goog.dom.TagName');
  goog.require('goog.editor.Field');
  goog.require('goog.editor.plugins.TagOnEnterHandler');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.editor.TestHelper');



var savedHtml;

var editor;
var field1;

function setUp() {
  field1 = makeField('field1');
  field1.makeEditable();
}


/**
 * Tests that deleting a BR that comes right before a block element works.
 * @bug 1471096
 */
function testDeleteBrBeforeBlock() {
  // This test only works on Gecko, because it's testing for manual deletion of
  // BR tags, which is done only for Gecko. For other browsers we fall through
  // and let the browser do the delete, which can only be tested with a robot
  // test (see javascript/apps/editor/tests/delete_br_robot.html).
  if (goog.userAgent.GECKO) {

    field1.setHtml(false, 'one<br><br><div>two</div>');
    var helper = new goog.testing.editor.TestHelper(field1.getElement());
    helper.select(field1.getElement(), 2); // Between the two BR's.
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.DELETE);
    assertEquals('Should have deleted exactly one <br>',
                 'one<br><div>two</div>',
                 field1.getElement().innerHTML);

  } // End if GECKO
}


/**
 * Tests that deleting a BR is working normally (that the workaround for the
 * bug is not causing double deletes).
 * @bug 1471096
 */
function testDeleteBrNormal() {
  // This test only works on Gecko, because it's testing for manual deletion of
  // BR tags, which is done only for Gecko. For other browsers we fall through
  // and let the browser do the delete, which can only be tested with a robot
  // test (see javascript/apps/editor/tests/delete_br_robot.html).
  if (goog.userAgent.GECKO) {

    field1.setHtml(false, 'one<br><br><br>two');
    var helper = new goog.testing.editor.TestHelper(field1.getElement());
    helper.select(field1.getElement(), 2); // Between the first and second BR's.
    field1.getElement().focus();
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.DELETE);
    assertEquals('Should have deleted exactly one <br>',
                 'one<br><br>two',
                 field1.getElement().innerHTML);

  } // End if GECKO
}


/**
 * Regression test for http://b/1991234 . Tests that when you hit enter and it
 * creates a blank line with whitespace and a BR, the cursor is placed in the
 * whitespace text node instead of the BR, otherwise continuing to type will
 * create adjacent text nodes, which causes browsers to mess up some
 * execcommands. Fix is in a Gecko-only codepath, thus test runs only for Gecko.
 * A full test for the entire sequence that reproed the bug is in
 * javascript/apps/editor/tests/ponenter_robot.html .
 */
function testEnterCreatesBlankLine() {
  if (goog.userAgent.GECKO) {
    field1.setHtml(false, '<p>one <br></p>');
    var helper = new goog.testing.editor.TestHelper(field1.getElement());
    // Place caret after 'one' but keeping a space and a BR as FF does.
    helper.select('one ', 3);
    field1.getElement().focus();
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.ENTER);
    var range = field1.getRange();
    assertFalse('Selection should not be in BR tag',
                range.getStartNode().nodeType == goog.dom.NodeType.ELEMENT &&
                range.getStartNode().tagName == goog.dom.TagName.BR);
    assertEquals('Selection should be in text node to avoid creating adjacent' +
                 ' text nodes',
        goog.dom.NodeType.TEXT, range.getStartNode().nodeType);
  }
}


/**
 * Verifies
 * goog.editor.plugins.TagOnEnterHandler.prototype.handleRegularEnterGecko_
 * when we explicitly split anchor elements. This test runs only for Gecko
 * since this is a Gecko-only codepath.
 */
function testEnterAtBeginningOfLink() {
  if (goog.userAgent.GECKO) {
    field1.setHtml(false, '<a href="/">b<br></a>');
    var helper = new goog.testing.editor.TestHelper(field1.getElement());
    field1.focusAndPlaceCursorAtStart();
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.ENTER);
    helper.assertHtmlMatches(
        '<p>&nbsp;</p><p><a href="/">b<br></a></p>');
  }
}


/**
 * Verifies correct handling of pressing enter in an empty list item.
 */
function testEnterInEmptyListItemInEmptyList() {
  if (goog.userAgent.GECKO) {
    field1.setHtml(false, '<ul><li>&nbsp;</li></ul>');
    var helper = new goog.testing.editor.TestHelper(field1.getElement());
    var li = field1.getElement().getElementsByTagName(goog.dom.TagName.LI)[0];
    helper.select(li.firstChild, 0);
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.ENTER);
    helper.assertHtmlMatches('<p>&nbsp;</p>');
  }
}


function testEnterInEmptyListItemAtBeginningOfList() {
  if (goog.userAgent.GECKO) {
    field1.setHtml(false,
        '<ul style="font-weight: bold">' +
            '<li>&nbsp;</li>' +
            '<li>1</li>' +
            '<li>2</li>' +
        '</ul>');
    var helper = new goog.testing.editor.TestHelper(field1.getElement());
    var li = field1.getElement().getElementsByTagName(goog.dom.TagName.LI)[0];
    helper.select(li.firstChild, 0);
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.ENTER);
    helper.assertHtmlMatches(
        '<p>&nbsp;</p><ul style="font-weight: bold"><li>1</li><li>2</li></ul>');
  }
}


function testEnterInEmptyListItemAtEndOfList() {
  if (goog.userAgent.GECKO) {
    field1.setHtml(false,
        '<ul style="font-weight: bold">' +
            '<li>1</li>' +
            '<li>2</li>' +
            '<li>&nbsp;</li>' +
        '</ul>');
    var helper = new goog.testing.editor.TestHelper(field1.getElement());
    var li = field1.getElement().getElementsByTagName(goog.dom.TagName.LI)[2];
    helper.select(li.firstChild, 0);
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.ENTER);
    helper.assertHtmlMatches(
        '<ul style="font-weight: bold"><li>1</li><li>2</li></ul><p>&nbsp;</p>');
  }
}


function testEnterInEmptyListItemInMiddleOfList() {
  if (goog.userAgent.GECKO) {
    field1.setHtml(false,
        '<ul style="font-weight: bold">' +
            '<li>1</li>' +
            '<li>&nbsp;</li>' +
            '<li>2</li>' +
        '</ul>');
    var helper = new goog.testing.editor.TestHelper(field1.getElement());
    var li = field1.getElement().getElementsByTagName(goog.dom.TagName.LI)[1];
    helper.select(li.firstChild, 0);
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.ENTER);
    helper.assertHtmlMatches(
        '<ul style="font-weight: bold"><li>1</li></ul>' +
        '<p>&nbsp;</p>' +
        '<ul style="font-weight: bold"><li>2</li></ul>');
  }
}


function testEnterInEmptyListItemInSublist() {
  if (goog.userAgent.GECKO) {
    field1.setHtml(false,
        '<ul>' +
          '<li>A</li>' +
          '<ul style="font-weight: bold">' +
              '<li>1</li>' +
              '<li>&nbsp;</li>' +
              '<li>2</li>' +
          '</ul>' +
          '<li>B</li>' +
        '</ul>');
    var helper = new goog.testing.editor.TestHelper(field1.getElement());
    var li = field1.getElement().getElementsByTagName(goog.dom.TagName.LI)[2];
    helper.select(li.firstChild, 0);
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.ENTER);
    helper.assertHtmlMatches(
        '<ul>' +
        '<li>A</li>' +
        '<ul style="font-weight: bold"><li>1</li></ul>' +
        '<li>&nbsp;</li>' +
        '<ul style="font-weight: bold"><li>2</li></ul>' +
        '<li>B</li>' +
        '</ul>');
  }
}


function testEnterInEmptyListItemAtBeginningOfSublist() {
  if (goog.userAgent.GECKO) {
    field1.setHtml(false,
        '<ul>' +
          '<li>A</li>' +
          '<ul style="font-weight: bold">' +
              '<li>&nbsp;</li>' +
              '<li>1</li>' +
              '<li>2</li>' +
          '</ul>' +
          '<li>B</li>' +
        '</ul>');
    var helper = new goog.testing.editor.TestHelper(field1.getElement());
    var li = field1.getElement().getElementsByTagName(goog.dom.TagName.LI)[1];
    helper.select(li.firstChild, 0);
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.ENTER);
    helper.assertHtmlMatches(
        '<ul>' +
        '<li>A</li>' +
        '<li>&nbsp;</li>' +
        '<ul style="font-weight: bold"><li>1</li><li>2</li></ul>' +
        '<li>B</li>' +
        '</ul>');
  }
}


function testEnterInEmptyListItemAtEndOfSublist() {
  if (goog.userAgent.GECKO) {
    field1.setHtml(false,
        '<ul>' +
          '<li>A</li>' +
          '<ul style="font-weight: bold">' +
              '<li>1</li>' +
              '<li>2</li>' +
              '<li>&nbsp;</li>' +
          '</ul>' +
          '<li>B</li>' +
        '</ul>');
    var helper = new goog.testing.editor.TestHelper(field1.getElement());
    var li = field1.getElement().getElementsByTagName(goog.dom.TagName.LI)[3];
    helper.select(li.firstChild, 0);
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.ENTER);
    helper.assertHtmlMatches(
        '<ul>' +
        '<li>A</li>' +
        '<ul style="font-weight: bold"><li>1</li><li>2</li></ul>' +
        '<li>&nbsp;</li>' +
        '<li>B</li>' +
        '</ul>');
  }
}


function testPrepareContentForPOnEnter() {
  assertPreparedContents('hi', 'hi');
  assertPreparedContents(
      goog.editor.BrowserFeature.COLLAPSES_EMPTY_NODES ? '<p>&nbsp;</p>' : '',
      '   ');
}


function testPrepareContentForDivOnEnter() {
  assertPreparedContents('hi', 'hi', goog.dom.TagName.DIV);
  assertPreparedContents(
      goog.editor.BrowserFeature.COLLAPSES_EMPTY_NODES ? '<div><br></div>' : '',
      '   ',
      goog.dom.TagName.DIV);
}


/**
 * Assert that the prepared contents matches the expected.
 */
function assertPreparedContents(expected, original, opt_tag) {
  var field = makeField('field1', opt_tag);
  field.makeEditable();
  assertEquals(expected,
      field.reduceOp_(
          goog.editor.Plugin.Op.PREPARE_CONTENTS_HTML, original));
}


/**
 * Selects the node at the given id, and simulates an ENTER keypress.
 * @param {googe.editor.Field} field The field with the node.
 * @param {string} id A DOM id.
 * @return {boolean} Whether preventDefault was called on the event.
 */
function selectNodeAndHitEnter(field, id) {
  var cursor = field.getEditableDomHelper().getElement(id);
  goog.dom.Range.createFromNodeContents(cursor).select();
  return goog.testing.events.fireKeySequence(
      cursor, goog.events.KeyCodes.ENTER);
}


/**
 * Creates a field with only the enter handler plugged in, for testing.
 * @param {string} id A DOM id.
 * @param {boolean=} opt_tag The block tag to use.  Defaults to P.
 * @return {goog.editor.Field} A field.
 */
function makeField(id, opt_tag) {
  var field = new goog.editor.Field(id);
  field.registerPlugin(
      new goog.editor.plugins.TagOnEnterHandler(opt_tag || goog.dom.TagName.P));
  return field;
}


/**
 * Runs a test for splitting the dom.
 * @param offset Index into the text node to split.
 * @param firstHalfString What the html of the first half of the DOM should be.
 * @param secondHalfString What the html of the 2nd half of the DOM should be.
 * @param isAppend True if the second half should be appended to the DOM.
 * @param opt_goToRoot True if the root argument for splitDom should be
 *                     excluded.
 */
function helpTestSplit_(offset, firstHalfString, secondHalfString, isAppend,
    opt_goToBody) {
  var node = document.createElement('div');
  node.innerHTML = '<b>begin bold<i>italic</i>end bold</b>';
  document.body.appendChild(node);

  var italic = node.getElementsByTagName('i')[0].firstChild;

  var splitFn = isAppend ?
      goog.editor.plugins.TagOnEnterHandler.splitDomAndAppend_ :
      goog.editor.plugins.TagOnEnterHandler.splitDom_;
  var secondHalf = splitFn(italic, offset, opt_goToBody ? undefined : node);

  if (opt_goToBody) {
    secondHalfString = '<div>' + secondHalfString + '</div>';
  }

  assertEquals('original node should have first half of the html',
               firstHalfString,
               node.innerHTML.toLowerCase().
                  replace(goog.string.Unicode.NBSP, '&nbsp;'));
  assertEquals('new node should have second half of the html',
               secondHalfString,
               secondHalf.innerHTML.toLowerCase().
                   replace(goog.string.Unicode.NBSP, '&nbsp;'));

  if (isAppend) {
    assertTrue('second half of dom should be the original node\'s next' +
               'sibling', node.nextSibling == secondHalf);
    goog.dom.removeNode(secondHalf);
  }

  goog.dom.removeNode(node);
}


/**
 * Runs different cases of splitting the DOM.
 * @param testFn Function that takes an offset, firstHalfString and
 *               secondHalfString as parameters.
 */
function splitDomCases_(testFn) {
  testFn(3, '<b>begin bold<i>ita</i></b>', '<b><i>lic</i>end bold</b>');
  testFn(0, '<b>begin bold<i>&nbsp;</i></b>', '<b><i>italic</i>end bold</b>');
  testFn(6, '<b>begin bold<i>italic</i></b>', '<b><i>&nbsp;</i>end bold</b>');
}


function testSplitDom() {
  splitDomCases_(function(offset, firstHalfString, secondHalfString) {
    helpTestSplit_(offset, firstHalfString, secondHalfString, false, true);
    helpTestSplit_(offset, firstHalfString, secondHalfString, false, false);
  });
}


function testSplitDomAndAppend() {
  splitDomCases_(function(offset, firstHalfString, secondHalfString) {
    helpTestSplit_(offset, firstHalfString, secondHalfString, true, false);
  });
}


function testSplitDomAtElement() {
  var node = document.createElement('div');
  node.innerHTML = '<div>abc<br>def</div>';
  document.body.appendChild(node);

  goog.editor.plugins.TagOnEnterHandler.splitDomAndAppend_(node.firstChild, 1,
      node.firstChild);

  goog.testing.dom.assertHtmlContentsMatch('<div>abc</div><div><br>def</div>',
      node);

  goog.dom.removeNode(node);
}


function testSplitDomAtElementStart() {
  var node = document.createElement('div');
  node.innerHTML = '<div>abc<br>def</div>';
  document.body.appendChild(node);

  goog.editor.plugins.TagOnEnterHandler.splitDomAndAppend_(node.firstChild, 0,
      node.firstChild);

  goog.testing.dom.assertHtmlContentsMatch('<div></div><div>abc<br>def</div>',
      node);

  goog.dom.removeNode(node);
}


function testSplitDomAtChildlessElement() {
  var node = document.createElement('div');
  node.innerHTML = '<div>abc<br>def</div>';
  document.body.appendChild(node);

  var br = node.getElementsByTagName(goog.dom.TagName.BR)[0];
  goog.editor.plugins.TagOnEnterHandler.splitDomAndAppend_(
      br, 0, node.firstChild);

  goog.testing.dom.assertHtmlContentsMatch('<div>abc</div><div><br>def</div>',
      node);

  goog.dom.removeNode(node);
}

">18 of 18 tests run in 33ms.<br />0 passed, 18 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testDeleteBrBeforeBlock<br />Cannot read property 'cssText' of undefined<br />ERROR in testDeleteBrNormal<br />Cannot read property 'cssText' of undefined<br />ERROR in testEnterAtBeginningOfLink<br />Cannot read property 'cssText' of undefined<br />ERROR in testEnterCreatesBlankLine<br />Cannot read property 'cssText' of undefined<br />ERROR in testEnterInEmptyListItemAtBeginningOfList<br />Cannot read property 'cssText' of undefined<br />ERROR in testEnterInEmptyListItemAtBeginningOfSublist<br />Cannot read property 'cssText' of undefined<br />ERROR in testEnterInEmptyListItemAtEndOfList<br />Cannot read property 'cssText' of undefined<br />ERROR in testEnterInEmptyListItemAtEndOfSublist<br />Cannot read property 'cssText' of undefined<br />ERROR in testEnterInEmptyListItemInEmptyList<br />Cannot read property 'cssText' of undefined<br />ERROR in testEnterInEmptyListItemInMiddleOfList<br />Cannot read property 'cssText' of undefined<br />ERROR in testEnterInEmptyListItemInSublist<br />Cannot read property 'cssText' of undefined<br />ERROR in testPrepareContentForDivOnEnter<br />Cannot read property 'cssText' of undefined<br />ERROR in testPrepareContentForPOnEnter<br />Cannot read property 'cssText' of undefined<br />ERROR in testSplitDom<br />Cannot read property 'cssText' of undefined<br />ERROR in testSplitDomAndAppend<br />Cannot read property 'cssText' of undefined<br />ERROR in testSplitDomAtChildlessElement<br />Cannot read property 'cssText' of undefined<br />ERROR in testSplitDomAtElement<br />Cannot read property 'cssText' of undefined<br />ERROR in testSplitDomAtElementStart<br />Cannot read property 'cssText' of undefined<br /></td></tr>
<tr><td>abstractdialogplugin_test.html</td><td>Fail</td><td> 0 passed, 8 failed.</td><td title="

  goog.require('goog.dom.SavedRange');
  goog.require('goog.editor.Field');
  goog.require('goog.editor.Field.EventType');
  goog.require('goog.editor.plugins.AbstractDialogPlugin');
  goog.require('goog.editor.plugins.AbstractDialogPlugin.EventType');
  goog.require('goog.events.EventHandler');
  goog.require('goog.functions');
  goog.require('goog.testing.LooseMock');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.MockControl');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.testing.editor.FieldMock');
  goog.require('goog.testing.editor.TestHelper');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.editor.AbstractDialog');
  goog.require('goog.ui.editor.AbstractDialog.Builder');
  goog.require('goog.userAgent');




  var plugin;
  var mockCtrl;
  var mockField;
  var mockSavedRange;
  var mockOpenedHandler;
  var mockClosedHandler;

  var COMMAND = 'myCommand';
  var stubs = new goog.testing.PropertyReplacer();

  var mockClock;
  var fieldObj;
  var fieldElem;
  var mockHandler;

  function setUp() {
    mockCtrl = new goog.testing.MockControl();
    mockOpenedHandler = mockCtrl.createLooseMock(goog.events.EventHandler);
    mockClosedHandler = mockCtrl.createLooseMock(goog.events.EventHandler);

    mockField = new goog.testing.editor.FieldMock(undefined, undefined, {});
    mockCtrl.addMock(mockField);
    mockField.focus();

    plugin = createDialogPlugin();
  }

  function setUpMockRange() {
    mockSavedRange = mockCtrl.createLooseMock(goog.dom.SavedRange);
    mockSavedRange.restore();

    stubs.set(goog.editor.range, 'saveUsingNormalizedCarets',
        goog.functions.constant(mockSavedRange));
  }

  function tearDown() {
    stubs.reset();
    tearDownRealEditableField();
    if (mockClock) {
      // Crucial to letting time operations work normally in the rest of tests.
      mockClock.dispose();
    }
    if (plugin) {
      mockField.$setIgnoreUnexpectedCalls(true);
      plugin.dispose();
    }
  }

  /**
   * Creates a concrete instance of goog.ui.editor.AbstractDialog by adding
   * a plain implementation of createDialogControl().
   * @param {goog.dom.DomHelper} dialogDomHelper The dom helper to be used to
   *     create the dialog.
   * @return {goog.ui.editor.AbstractDialog} The created dialog.
   */
  function createDialog(domHelper) {
    var dialog = new goog.ui.editor.AbstractDialog(domHelper);
    dialog.createDialogControl = function() {
      return new goog.ui.editor.AbstractDialog.Builder(dialog).build();
    };
    return dialog;
  }

  /**
   * Creates a concrete instance of the abstract class
   * goog.editor.plugins.AbstractDialogPlugin
   * and registers it with the mock editable field being used.
   * @return {goog.editor.plugins.AbstractDialogPlugin} The created plugin.
   */
  function createDialogPlugin() {
    var plugin = new goog.editor.plugins.AbstractDialogPlugin(COMMAND);
    plugin.createDialog = createDialog;
    plugin.returnControlToEditableField = plugin.restoreOriginalSelection;
    plugin.registerFieldObject(mockField);
    plugin.addEventListener(
        goog.editor.plugins.AbstractDialogPlugin.EventType.OPENED,
        mockOpenedHandler);
    plugin.addEventListener(
        goog.editor.plugins.AbstractDialogPlugin.EventType.CLOSED,
        mockClosedHandler);
    return plugin;
  }

  /**
   * Sets up the mock event handler to expect an OPENED event.
   */
  function expectOpened(opt_times) {
    mockOpenedHandler.handleEvent(new goog.testing.mockmatchers.ArgumentMatcher(
        function(arg) {
          return arg.type ==
                 goog.editor.plugins.AbstractDialogPlugin.EventType.OPENED;
        }));
    mockField.dispatchSelectionChangeEvent();
    if (opt_times) {
      mockOpenedHandler.$times(opt_times);
      mockField.$times(opt_times);
    }
  }

  /**
   * Sets up the mock event handler to expect a CLOSED event.
   */
  function expectClosed(opt_times) {
    mockClosedHandler.handleEvent(new goog.testing.mockmatchers.ArgumentMatcher(
        function(arg) {
          return arg.type ==
                 goog.editor.plugins.AbstractDialogPlugin.EventType.CLOSED;
        }));
    mockField.dispatchSelectionChangeEvent();
    if (opt_times) {
      mockClosedHandler.$times(opt_times);
      mockField.$times(opt_times);
    }
  }


  /**
   * Tests the simple flow of calling execCommand (which opens the
   * dialog) and immediately disposing of the plugin (which closes the dialog).
   * @param {boolean=} opt_reuse Whether to set the plugin to reuse its dialog.
   */
  function testExecAndDispose(opt_reuse) {
    setUpMockRange();
    expectOpened();
    expectClosed();
    mockField.debounceEvent(goog.editor.Field.EventType.SELECTIONCHANGE);
    mockCtrl.$replayAll();
    if (opt_reuse) {
      plugin.setReuseDialog(true);
    }
    assertFalse('Dialog should not be open yet',
                !!plugin.getDialog() && plugin.getDialog().isOpen());

    plugin.execCommand(COMMAND);
    assertTrue('Dialog should be open now',
               !!plugin.getDialog() && plugin.getDialog().isOpen());

    var tempDialog = plugin.getDialog();
    plugin.dispose();
    assertFalse('Dialog should not still be open after disposal',
                tempDialog.isOpen());
    mockCtrl.$verifyAll();
  }

  /**
   * Tests execCommand and dispose while reusing the dialog.
   */
  function testExecAndDisposeReuse() {
    testExecAndDispose(true);
  }


  /**
   * Tests the flow of calling execCommand (which opens the dialog) and
   * then hiding it (simulating that a user did somthing to cause the dialog to
   * close).
   * @param {boolean} reuse Whether to set the plugin to reuse its dialog.
   */
  function testExecAndHide(opt_reuse) {
    setUpMockRange();
    expectOpened();
    expectClosed();
    mockField.debounceEvent(goog.editor.Field.EventType.SELECTIONCHANGE);
    mockCtrl.$replayAll();
    if (opt_reuse) {
      plugin.setReuseDialog(true);
    }
    assertFalse('Dialog should not be open yet',
                !!plugin.getDialog() && plugin.getDialog().isOpen());

    plugin.execCommand(COMMAND);
    assertTrue('Dialog should be open now',
               !!plugin.getDialog() && plugin.getDialog().isOpen());

    var tempDialog = plugin.getDialog();
    plugin.getDialog().hide();
    assertFalse('Dialog should not still be open after hiding',
                tempDialog.isOpen());
    if (opt_reuse) {
      assertFalse('Dialog should not be disposed after hiding (will be reused)',
                  tempDialog.isDisposed());
    } else {
      assertTrue('Dialog should be disposed after hiding',
                 tempDialog.isDisposed());
    }
    plugin.dispose();
    mockCtrl.$verifyAll();
  }

  /**
   * Tests execCommand and hide while reusing the dialog.
   */
  function testExecAndHideReuse() {
    testExecAndHide(true);
  }

  /**
   * Tests the flow of calling execCommand (which opens a dialog) and
   * then calling it again before the first dialog is closed. This is not
   * something anyone should be doing since dialogs are (usually?) modal so the
   * user can't do another execCommand before closing the first dialog. But
   * since the API makes it possible, I thought it would be good to guard
   * against and unit test.
   * @param {boolean} reuse Whether to set the plugin to reuse its dialog.
   */
  function testExecTwice(opt_reuse) {
    setUpMockRange();
    if (opt_reuse) {
      expectOpened(2); // The second exec should cause a second OPENED event.
      // But the dialog was not closed between exec calls, so only one CLOSED is
      // expected.
      expectClosed();
      plugin.setReuseDialog(true);
      mockField.debounceEvent(goog.editor.Field.EventType.SELECTIONCHANGE);
    } else {
      expectOpened(2); // The second exec should cause a second OPENED event.
      // The first dialog will be disposed so there should be two CLOSED events.
      expectClosed(2);
      mockSavedRange.restore(); // Expected 2x, once already recorded in setup.
      mockField.focus(); // Expected 2x, once already recorded in setup.
      mockField.debounceEvent(goog.editor.Field.EventType.SELECTIONCHANGE);
      mockField.$times(2);
    }
    mockCtrl.$replayAll();

    assertFalse('Dialog should not be open yet',
                !!plugin.getDialog() && plugin.getDialog().isOpen());

    plugin.execCommand(COMMAND);
    assertTrue('Dialog should be open now',
               !!plugin.getDialog() && plugin.getDialog().isOpen());

    var tempDialog = plugin.getDialog();
    plugin.execCommand(COMMAND);
    if (opt_reuse) {
      assertTrue('Reused dialog should still be open after second exec',
                 tempDialog.isOpen());
      assertFalse('Reused dialog should not be disposed after second exec',
                 tempDialog.isDisposed());
    } else {
      assertFalse('First dialog should not still be open after opening second',
                  tempDialog.isOpen());
      assertTrue('First dialog should be disposed after opening second',
                 tempDialog.isDisposed());
    }
    plugin.dispose();
    mockCtrl.$verifyAll();
  }

  /**
   * Tests execCommand twice while reusing the dialog.
   */
  function testExecTwiceReuse() {
    testExecTwice(true);
  }


  /**
   * Tests that the selection is cleared when the dialog opens and is
   * correctly restored after it closes.
   */
  function testRestoreSelection() {
    setUpRealEditableField();

    fieldObj.setHtml(false, '12345');
    var elem = fieldObj.getElement();
    var helper = new goog.testing.editor.TestHelper(elem);
    helper.select('12345', 1, '12345', 4); // Selects '234'.

    assertEquals('Incorrect text selected before dialog is opened',
                 '234',
                 fieldObj.getRange().getText());
    plugin.execCommand(COMMAND);
    if (!goog.userAgent.IE && !goog.userAgent.OPERA) {
      // IE returns some bogus range when field doesn't have selection.
      // Opera can't remove the selection from a whitebox field.
      assertNull('There should be no selection while dialog is open',
                 fieldObj.getRange());
    }
    plugin.getDialog().hide();
    assertEquals('Incorrect text selected after dialog is closed',
                 '234',
                 fieldObj.getRange().getText());
  }

  /**
   * Setup a real editable field (instead of a mock) and register the plugin to
   * it.
   */
  function setUpRealEditableField() {
    fieldElem = document.createElement('div');
    fieldElem.id = 'myField';
    document.body.appendChild(fieldElem);
    fieldObj = new goog.editor.Field('myField', document);
    fieldObj.makeEditable();
    // Register the plugin to that field.
    plugin.getTrogClassId = goog.functions.constant('myClassId');
    fieldObj.registerPlugin(plugin);
  }

  /**
   * Tear down the real editable field.
   */
  function tearDownRealEditableField() {
    if (fieldObj) {
      fieldObj.makeUneditable();
      fieldObj.dispose();
      fieldObj = null;
    }
    if (fieldElem && fieldElem.parentNode == document.body) {
      document.body.removeChild(fieldElem);
    }
  }


  /**
   * Tests that after the dialog is hidden via a keystroke, the editable field
   * doesn't fire an extra SELECTIONCHANGE event due to the keyup from that
   * keystroke.
   * There is also a robot test in dialog_robot.html to test debouncing the
   * SELECTIONCHANGE event when the dialog closes.
   */
  function testDebounceSelectionChange() {
    mockClock = new goog.testing.MockClock(true);
    // Initial time is 0 which evaluates to false in debouncing implementation.
    mockClock.tick(1);

    setUpRealEditableField();

    // Set up a mock event handler to make sure selection change isn't fired
    // more than once on close and a second time on close.
    var count = 0;
    fieldObj.addEventListener(goog.editor.Field.EventType.SELECTIONCHANGE,
                              function(e) {
                                count++;
                              });

    assertEquals(0, count);
    plugin.execCommand(COMMAND);
    assertEquals(1, count);
    plugin.getDialog().hide();
    assertEquals(2, count);

    // Fake the keyup event firing on the field after the dialog closes.
    var e = new goog.events.Event('keyup', plugin.fieldObject.getElement());
    e.keyCode = 13;
    goog.testing.events.fireBrowserEvent(e);

    // Tick the mock clock so that selection change tries to fire.
    mockClock.tick(goog.editor.Field.SELECTION_CHANGE_FREQUENCY_ + 1);

    // Ensure the handler did not fire again.
    assertEquals(2, count);
  }

">8 of 8 tests run in 20ms.<br />0 passed, 8 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testDebounceSelectionChange<br />Object #<Object> has no method 'createElement'<br />ERROR in testExecAndDispose<br />Object #<Object> has no method 'createElement'<br />ERROR in testExecAndDisposeReuse<br />Object #<Object> has no method 'createElement'<br />ERROR in testExecAndHide<br />Object #<Object> has no method 'createElement'<br />ERROR in testExecAndHideReuse<br />Object #<Object> has no method 'createElement'<br />ERROR in testExecTwice<br />Object #<Object> has no method 'createElement'<br />ERROR in testExecTwiceReuse<br />Object #<Object> has no method 'createElement'<br />ERROR in testRestoreSelection<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>enterhandler_test.html</td><td>Fail</td><td> 0 passed, 19 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.DomHelper');
  goog.require('goog.dom.Range');
  goog.require('goog.editor.BrowserFeature');
  goog.require('goog.editor.Field');
  goog.require('goog.editor.plugins.Blockquote');
  goog.require('goog.editor.plugins.EnterHandler');
  goog.require('goog.editor.range');
  goog.require('goog.testing.ExpectedFailures');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.editor.TestHelper');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');




var savedHtml;

var field1;
var field2;
var firedDelayedChange;
var firedBeforeChange;
var clock;
var container = goog.dom.getElement('container');
var EXPECTEDFAILURES;

function setUp() {
  EXPECTEDFAILURES = new goog.testing.ExpectedFailures();
  savedHtml = goog.dom.getElement('root').innerHTML;
  clock = new goog.testing.MockClock(true);
}

function setUpFields(classnameRequiredToSplitBlockquote) {
  field1 = makeField('field1', classnameRequiredToSplitBlockquote);
  field2 = makeField('field2', classnameRequiredToSplitBlockquote);

  field1.makeEditable();
  field2.makeEditable();
}

function tearDown() {
  clock.dispose();

  EXPECTEDFAILURES.handleTearDown();

  goog.dom.getElement('root').innerHTML = savedHtml;
}

function testEnterInNonSetupBlockquote() {
  setUpFields(true);
  resetChangeFlags();
  var prevented = !selectNodeAndHitEnter(field1, 'field1cursor');
  waitForChangeEvents();
  assertChangeFlags();

  // make sure there's just one blockquote, and that the text has been deleted.
  var elem = field1.getElement();
  var dom = field1.getEditableDomHelper();
  EXPECTEDFAILURES.expectFailureFor(goog.userAgent.OPERA,
      'The blockquote is overwritten with DIV due to CORE-22104 -- Opera ' +
      'overwrites the BLOCKQUOTE ancestor with DIV when doing FormatBlock ' +
      'for DIV');
  try {
    assertEquals('Blockquote should not be split',
        1, dom.getElementsByTagNameAndClass('BLOCKQUOTE', null, elem).length);
  } catch(e) {
    EXPECTEDFAILURES.handleException(e);
  }
  assert('Selection should be deleted',
      -1 == elem.innerHTML.indexOf('selection'));

  assertEquals('The event should have been prevented only on webkit',
      prevented, goog.userAgent.WEBKIT);
}

function testEnterInSetupBlockquote() {
  setUpFields(true);
  resetChangeFlags();
  var prevented = !selectNodeAndHitEnter(field2, 'field2cursor');
  waitForChangeEvents();
  assertChangeFlags();

  // make sure there are two blockquotes, and a DIV with nbsp in the middle.
  var elem = field2.getElement();
  var dom = field2.getEditableDomHelper();
  assertEquals('Blockquote should be split', 2,
      dom.getElementsByTagNameAndClass('BLOCKQUOTE', null, elem).length);
  assert('Selection should be deleted',
      -1 == elem.innerHTML.indexOf('selection'));

  assert('should have div with &nbsp;',
      -1 != elem.innerHTML.indexOf('>' + getNbsp() + '<'));
  assert('event should have been prevented', prevented);
}

function testEnterInNonSetupBlockquoteWhenClassnameIsNotRequired() {
  setUpFields(false);

  resetChangeFlags();
  var prevented = !selectNodeAndHitEnter(field1, 'field1cursor');
  waitForChangeEvents();
  assertChangeFlags();

  // make sure there are two blockquotes, and a DIV with nbsp in the middle.
  var elem = field1.getElement();
  var dom = field1.getEditableDomHelper();
  assertEquals('Blockquote should be split', 2,
      dom.getElementsByTagNameAndClass('BLOCKQUOTE', null, elem).length);
  assert('Selection should be deleted',
      -1 == elem.innerHTML.indexOf('selection'));

  assert('should have div with &nbsp;',
      -1 != elem.innerHTML.indexOf('>' + getNbsp() + '<'));
  assert('event should have been prevented', prevented);
}

function testEnterInBlockquoteCreatesDivInBrMode() {
  setUpFields(true);
  selectNodeAndHitEnter(field2, 'field2cursor');
  var elem = field2.getElement();
  var dom = field2.getEditableDomHelper();

  var firstBlockquote = dom.getElementsByTagNameAndClass('BLOCKQUOTE', null, elem)[0];
  var div = dom.getNextElementSibling(firstBlockquote);
  assertEquals('Element after blockquote should be a div', 'DIV', div.tagName);
  assertEquals('Element after div should be second blockquote',
      'BLOCKQUOTE', dom.getNextElementSibling(div).tagName);
}

/**
 * Tests that breaking after a BR doesn't result in unnecessary newlines.
 * @bug 1471047
 */
function testEnterInBlockquoteRemovesUnnecessaryBrWithCursorAfterBr() {
  setUpFields(true);

  // Assume the following HTML snippet:-
  // <blockquote>one<br>|two<br></blockquote>
  //
  // After enter on the cursor position without the fix, the resulting HTML
  // after the blockquote split was:-
  // <blockquote>one</blockquote>
  // <div>&nbsp;</div>
  // <blockquote><br>two<br></blockquote>
  //
  // This creates the impression on an unnecessary newline. The resulting HTML
  // after the fix is:-
  //
  // <blockquote>one<br></blockquote>
  // <div>&nbsp;</div>
  // <blockquote>two<br></blockquote>
  field1.setHtml(false,
      '<blockquote id="quote" class="tr_bq">one<br>' +
      'two<br></blockquote>');
  var dom = field1.getEditableDomHelper();
  goog.dom.Range.createCaret(dom.getElement('quote'), 2).select();
  goog.testing.events.fireKeySequence(field1.getElement(),
                                      goog.events.KeyCodes.ENTER);
  var elem = field1.getElement();
  var secondBlockquote = dom.getElementsByTagNameAndClass('BLOCKQUOTE', null, elem)[1];
  assertHTMLEquals('two<br>', secondBlockquote.innerHTML);

  // Verifies that a blockquote split doesn't happen if it doesn't need to.
  field1.setHtml(false,
      '<blockquote class="tr_bq">one<br id="brcursor"></blockquote>');
  selectNodeAndHitEnter(field1, 'brcursor');
  assertEquals(1, dom.getElementsByTagNameAndClass('BLOCKQUOTE', null, elem).length);
}

/**
 * Tests that breaking in a text node before a BR doesn't result in unnecessary
 * newlines.
 * @bug 1471047
 */
function testEnterInBlockquoteRemovesUnnecessaryBrWithCursorBeforeBr() {
  setUpFields(true);

  // Assume the following HTML snippet:-
  // <blockquote>one|<br>two<br></blockquote>
  //
  // After enter on the cursor position, the resulting HTML should be.
  // <blockquote>one<br></blockquote>
  // <div>&nbsp;</div>
  // <blockquote>two<br></blockquote>
  field1.setHtml(false,
      '<blockquote id="quote" class="tr_bq">one<br>' +
      'two<br></blockquote>');
  var dom = field1.getEditableDomHelper();
  var cursor = dom.getElement('quote').firstChild;
  goog.dom.Range.createCaret(cursor, 3).select();
  goog.testing.events.fireKeySequence(field1.getElement(),
                                      goog.events.KeyCodes.ENTER);
  var elem = field1.getElement();
  var secondBlockquote = dom.getElementsByTagNameAndClass('BLOCKQUOTE', null, elem)[1];
  assertHTMLEquals('two<br>', secondBlockquote.innerHTML);

  // Ensures that standard text node split works as expected with the new
  // change.
  field1.setHtml(false,
      '<blockquote id="quote" class="tr_bq">one<b>two</b><br>');
  cursor = dom.getElement('quote').firstChild;
  goog.dom.Range.createCaret(cursor, 3).select();
  goog.testing.events.fireKeySequence(field1.getElement(),
                                      goog.events.KeyCodes.ENTER);
  secondBlockquote = dom.getElementsByTagNameAndClass('BLOCKQUOTE', null, elem)[1];
  assertHTMLEquals('<b>two</b><br>', secondBlockquote.innerHTML);
}

/**
 * Tests that pressing enter in a blockquote doesn't create unnecessary
 * DOM subtrees.
 *
 * @bug 1991539
 * @bug 1991392
 */
function testEnterInBlockquoteRemovesExtraNodes() {
  setUpFields(true);

  // Let's assume we have the following DOM structure and the
  // cursor is placed after the first numbered list item "one".
  //
  // <blockquote class="tr_bq">
  //   <div><div>a</div><ol><li>one|</li></div>
  //   <div>two</div>
  // </blockquote>
  //
  // After pressing enter, we have the following structure.
  //
  // <blockquote class="tr_bq">
  //   <div><div>a</div><ol><li>one|</li></div>
  // </blockquote>
  // <div>&nbsp;</div>
  // <blockquote class="tr_bq">
  //   <div><ol><li><span id=""></span></li></ol></div>
  //   <div>two</div>
  // </blockquote>
  //
  // This appears to the user as an empty list. After the fix, the HTML
  // will be
  //
  // <blockquote class="tr_bq">
  //   <div><div>a</div><ol><li>one|</li></div>
  // </blockquote>
  // <div>&nbsp;</div>
  // <blockquote class="tr_bq">
  //   <div>two</div>
  // </blockquote>
  //
  field1.setHtml(false,
      '<blockquote class="tr_bq">' +
      '<div><div>a</div><ol><li id="cursor">one</li></div>' +
      '<div>b</div>' +
      '</blockquote>');
  var dom = field1.getEditableDomHelper();
  goog.dom.Range.createCaret(dom.getElement('cursor').firstChild, 3).select();
  goog.testing.events.fireKeySequence(field1.getElement(),
                                      goog.events.KeyCodes.ENTER);
  var elem = field1.getElement();
  var secondBlockquote = dom.getElementsByTagNameAndClass('BLOCKQUOTE', null, elem)[1];
  assertHTMLEquals('<div>b</div>', secondBlockquote.innerHTML);

  // Ensure that we remove only unnecessary subtrees.
  field1.setHtml(false,
      '<blockquote class="tr_bq">' +
      '<div><span>a</span><div id="cursor">one</div><div>two</div></div>' +
      '<div><span>c</span></div>' +
      '</blockquote>');
  goog.dom.Range.createCaret(dom.getElement('cursor').firstChild, 3).select();
  goog.testing.events.fireKeySequence(field1.getElement(),
                                      goog.events.KeyCodes.ENTER);
  secondBlockquote = dom.getElementsByTagNameAndClass('BLOCKQUOTE', null, elem)[1];
  var expectedHTML = '<div><div>two</div></div>' +
      '<div><span>c</span></div>';
  assertHTMLEquals(expectedHTML, secondBlockquote.innerHTML);

  // Place the cursor in the middle of a line.
  field1.setHtml(false,
      '<blockquote id="quote" class="tr_bq">' +
      '<div>one</div><div>two</div>' +
      '</blockquote>');
  goog.dom.Range.createCaret(
      dom.getElement('quote').firstChild.firstChild, 1).select();
  goog.testing.events.fireKeySequence(field1.getElement(),
                                      goog.events.KeyCodes.ENTER);
  var blockquotes = dom.getElementsByTagNameAndClass('BLOCKQUOTE', null, elem);
  assertEquals(2, blockquotes.length);
  assertHTMLEquals('<div>o</div>', blockquotes[0].innerHTML);
  assertHTMLEquals('<div>ne</div><div>two</div>', blockquotes[1].innerHTML);
}

function testEnterInList() {
  setUpFields(true);

  // <enter> in a list should *never* be handled by custom code. Lists are
  // just way too complicated to get right.
  field1.setHtml(false,
      '<ol><li>hi!<span id="field1cursor"></span></li></ol>');
  if (goog.userAgent.OPERA) {
    // Opera doesn't actually place the selection in the empty span
    // unless we add a text node first.
    var dom = field1.getEditableDomHelper();
    dom.getElement('field1cursor').appendChild(dom.createTextNode(''));
  }
  var prevented = !selectNodeAndHitEnter(field1, 'field1cursor');
  assertFalse('<enter> in a list should not be prevented', prevented);
}

function testEnterAtEndOfBlockInWebkit() {
  setUpFields(true);

  if (goog.userAgent.WEBKIT) {
    field1.setHtml(false,
        '<blockquote>hi!<span id="field1cursor"></span></blockquote>');

    var cursor = field1.getEditableDomHelper().getElement('field1cursor');
    goog.editor.range.placeCursorNextTo(cursor, false);
    goog.dom.removeNode(cursor);

    var prevented = !goog.testing.events.fireKeySequence(
        field1.getElement(), goog.events.KeyCodes.ENTER);
    waitForChangeEvents();
    assertChangeFlags();
    assert('event should have been prevented', prevented);

    // Make sure that the block now has two brs.
    var elem = field1.getElement();
    assertEquals('should have inserted two br tags: ' +  elem.innerHTML,
        2, goog.dom.getElementsByTagNameAndClass('BR', null, elem).length);
  }
}

/**
 * Tests that deleting a BR that comes right before a block element works.
 * @bug 1471096
 * @bug 2056376
 */
function testDeleteBrBeforeBlock() {
  setUpFields(true);

  // This test only works on Gecko, because it's testing for manual deletion of
  // BR tags, which is done only for Gecko. For other browsers we fall through
  // and let the browser do the delete, which can only be tested with a robot
  // test (see javascript/apps/editor/tests/delete_br_robot.html).
  if (goog.userAgent.GECKO) {
    field1.setHtml(false, 'one<br><br><div>two</div>');
    var helper = new goog.testing.editor.TestHelper(field1.getElement());
    helper.select(field1.getElement(), 2); // Between the two BR's.
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.DELETE);
    assertEquals('Should have deleted exactly one <br>',
                 'one<br><div>two</div>',
                 field1.getElement().innerHTML);

    // We test the case where the BR has a previous sibling which is not
    // a block level element.
    field1.setHtml(false, 'one<br><ul><li>two</li></ul>');
    helper.select(field1.getElement(), 1); // Between one and BR.
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.DELETE);
    assertEquals('Should have deleted the <br>',
                 'one<ul><li>two</li></ul>',
                 field1.getElement().innerHTML);
    // Verify that the cursor is placed at the end of the text node "one".
    var range = field1.getRange();
    var focusNode = range.getFocusNode();
    assertTrue('The selected range should be collapsed', range.isCollapsed());
    assertTrue('The focus node should be the text node "one"',
               focusNode.nodeType == goog.dom.NodeType.TEXT &&
               focusNode.data == 'one');
    assertEquals('The focus offset should be at the end of the text node "one"',
                 focusNode.length,
                 range.getFocusOffset());
    assertTrue('The next sibling of the focus node should be the UL',
               focusNode.nextSibling &&
               focusNode.nextSibling.tagName == goog.dom.TagName.UL);

    // We test the case where the previous sibling of the BR is a block
    // level element.
    field1.setHtml(false, '<div>foo</div><br><div><span>bar</span></div>');
    helper.select(field1.getElement(), 1); // Before the BR.
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.DELETE);
    assertEquals('Should have deleted the <br>',
                 '<div>foo</div><div><span>bar</span></div>',
                 field1.getElement().innerHTML);
    range = field1.getRange();
    assertEquals('The selected range should be contained within the <span>',
                 goog.dom.TagName.SPAN,
                 range.getContainerElement().tagName);
    assertTrue('The selected range should be collapsed', range.isCollapsed());
    // Verify that the cursor is placed inside the span at the beginning of bar.
    focusNode = range.getFocusNode();
    assertTrue('The focus node should be the text node "bar"',
               focusNode.nodeType == goog.dom.NodeType.TEXT &&
               focusNode.data == 'bar');
    assertEquals('The focus offset should be at the beginning ' +
                 'of the text node "bar"',
                 0,
                 range.getFocusOffset());

    // We test the case where the BR does not have a previous sibling.
    field1.setHtml(false, '<br><ul><li>one</li></ul>');
    helper.select(field1.getElement(), 0); // Before the BR.
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.DELETE);
    assertEquals('Should have deleted the <br>',
                 '<ul><li>one</li></ul>',
                 field1.getElement().innerHTML);
    range = field1.getRange();
    // Verify that the cursor is placed inside the LI at the text node "one".
    assertEquals('The selected range should be contained within the <li>',
                 goog.dom.TagName.LI,
                 range.getContainerElement().tagName);
    assertTrue('The selected range should be collapsed', range.isCollapsed());
    focusNode = range.getFocusNode();
    assertTrue('The focus node should be the text node "one"',
               (focusNode.nodeType == goog.dom.NodeType.TEXT &&
                focusNode.data == 'one'));
    assertEquals('The focus offset should be at the beginning of '+
                 'the text node "one"',
                 0,
                 range.getFocusOffset());

    // Testing deleting a BR followed by a block level element and preceded
    // by a BR.
    field1.setHtml(false, '<br><br><ul><li>one</li></ul>');
    helper.select(field1.getElement(), 1); // Between the BR's.
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.DELETE);
    assertEquals('Should have deleted the <br>',
                 '<br><ul><li>one</li></ul>',
                 field1.getElement().innerHTML);
    // Verify that the cursor is placed inside the LI at the text node "one".
    range = field1.getRange();
    assertEquals('The selected range should be contained within the <li>',
                 goog.dom.TagName.LI,
                 range.getContainerElement().tagName);
    assertTrue('The selected range should be collapsed', range.isCollapsed());
    focusNode = range.getFocusNode();
    assertTrue('The focus node should be the text node "one"',
               (focusNode.nodeType == goog.dom.NodeType.TEXT &&
                focusNode.data == 'one'));
    assertEquals('The focus offset should be at the beginning of '+
                 'the text node "one"',
                 0,
                 range.getFocusOffset());
  } // End if GECKO
}

/**
 * Tests that deleting a BR before a blockquote doesn't remove quoted text.
 * @bug 1471075
 */
function testDeleteBeforeBlockquote() {
  setUpFields(true);

  if (goog.userAgent.GECKO) {
    field1.setHtml(false,
                   '<br><br><div><br><blockquote>foo</blockquote></div>');
    var helper = new goog.testing.editor.TestHelper(field1.getElement());
    helper.select(field1.getElement(), 0); // Before the first BR.
    // Fire three deletes in quick succession.
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.DELETE);
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.DELETE);
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.DELETE);
    assertEquals('Should have deleted all the <br>\'s and the blockquote ' +
                 'isn\'t affected',
                 '<div><blockquote>foo</blockquote></div>',
                 field1.getElement().innerHTML);
    var range = field1.getRange();
    assertEquals('The selected range should be contained within the ' +
                 '<blockquote>',
                 goog.dom.TagName.BLOCKQUOTE,
                 range.getContainerElement().tagName);
    assertTrue('The selected range should be collapsed', range.isCollapsed());
    var focusNode = range.getFocusNode();
    assertTrue('The focus node should be the text node "foo"',
               (focusNode.nodeType == goog.dom.NodeType.TEXT &&
                focusNode.data == 'foo'));
    assertEquals('The focus offset should be at the ' +
                 'beginning of the text node "foo"',
                 0,
                 range.getFocusOffset());
  }
}

/**
 * Tests that deleting a BR is working normally (that the workaround for the
 * bug is not causing double deletes).
 * @bug 1471096
 */
function testDeleteBrNormal() {
  setUpFields(true);

  // This test only works on Gecko, because it's testing for manual deletion of
  // BR tags, which is done only for Gecko. For other browsers we fall through
  // and let the browser do the delete, which can only be tested with a robot
  // test (see javascript/apps/editor/tests/delete_br_robot.html).
  if (goog.userAgent.GECKO) {

    field1.setHtml(false, 'one<br><br><br>two');
    var helper = new goog.testing.editor.TestHelper(field1.getElement());
    helper.select(field1.getElement(), 2); // Between the first and second BR's.
    field1.getElement().focus();
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.DELETE);
    assertEquals('Should have deleted exactly one <br>',
                 'one<br><br>two',
                 field1.getElement().innerHTML);

  } // End if GECKO
}

/**
 * Tests that deleteCursorSelectionW3C_ correctly recognizes visually
 * collapsed selections in Opera even if they contain a <br>.
 * See the deleteCursorSelectionW3C_ comment in enterhandler.js.
 */
function testCollapsedSelectionKeepsBrOpera() {
  setUpFields(true);

  if (goog.userAgent.OPERA) {
    field1.setHtml(false, '<div><br id="pleasedontdeleteme"></div>');
    field1.focus();
    goog.testing.events.fireKeySequence(field1.getElement(),
                                        goog.events.KeyCodes.ENTER);
    assertNotNull('The <br> must not have been deleted',
                  goog.dom.getElement('pleasedontdeleteme'));
  }
}

/**
 * Selects the node at the given id, and simulates an ENTER keypress.
 * @param {goog.editor.Field} field The field with the node.
 * @param {string} id A DOM id.
 * @return {boolean} Whether preventDefault was called on the event.
 */
function selectNodeAndHitEnter(field, id) {
  var dom = field.getEditableDomHelper();
  var cursor = dom.getElement(id);
  goog.dom.Range.createFromNodeContents(cursor).select();
  return goog.testing.events.fireKeySequence(
      cursor, goog.events.KeyCodes.ENTER);
}

/**
 * Creates a field with only the enter handler plugged in, for testing.
 * @param {string} id A DOM id.
 * @return {goog.editor.Field} A field.
 */
function makeField(id, classnameRequiredToSplitBlockquote) {
  var field = new goog.editor.Field(id);
  field.registerPlugin(new goog.editor.plugins.EnterHandler());
  field.registerPlugin(new goog.editor.plugins.Blockquote(
      classnameRequiredToSplitBlockquote))

  goog.events.listen(field, goog.editor.Field.EventType.BEFORECHANGE,
      function() {
        // set the global flag that beforechange was fired.
        firedBeforeChange = true;
      });
  goog.events.listen(field, goog.editor.Field.EventType.DELAYEDCHANGE,
      function() {
        // set the global flag that delayed change was fired.
        firedDelayedChange = true;
      });

  return field;
}

/**
 * Reset all the global flags related to change events.
 */
function resetChangeFlags() {
  waitForChangeEvents();
  firedBeforeChange = firedDelayedChange = false;
}

/**
 * Asserts that both change flags were fired since the last reset.
 */
function assertChangeFlags() {
  assert('Beforechange should have fired', firedBeforeChange);
  assert('Delayedchange should have fired', firedDelayedChange);
}

/**
 * Wait for delayedchange to propagate.
 */
function waitForChangeEvents() {
  clock.tick(goog.editor.Field.DELAYED_CHANGE_FREQUENCY +
      goog.editor.Field.CHANGE_FREQUENCY);
}

function getNbsp() {
  // On WebKit (pre-528) and Opera, &nbsp; shows up as its unicode character in
  // innerHTML under some circumstances.
  return (goog.userAgent.WEBKIT && !goog.userAgent.isVersion('528')) ||
         goog.userAgent.OPERA ? '\u00a0' : '&nbsp;';
}


function testPrepareContent() {
  setUpFields(true);
  assertPreparedContents('hi', 'hi');
  assertPreparedContents(
      goog.editor.BrowserFeature.COLLAPSES_EMPTY_NODES ? '<br>' : '', '   ');
}


/**
 * Assert that the prepared contents matches the expected.
 */
function assertPreparedContents(expected, original) {
  assertEquals(expected,
      field1.reduceOp_(
          goog.editor.Plugin.Op.PREPARE_CONTENTS_HTML, original));
}

// UTILITY FUNCTION TESTS.

function testDeleteW3CSimple() {
  if (goog.editor.BrowserFeature.HAS_W3C_RANGES) {
    container.innerHTML = '<div>abcd</div>';
    var range = goog.dom.Range.createFromNodes(container.firstChild.firstChild,
        1, container.firstChild.firstChild, 3);
    range.select();
    goog.editor.plugins.EnterHandler.deleteW3cRange_(range);

    goog.testing.dom.assertHtmlContentsMatch('<div>ad</div>', container);
  }
}

function testDeleteW3CAll() {
  if (goog.editor.BrowserFeature.HAS_W3C_RANGES) {
    container.innerHTML = '<div>abcd</div>';
    var range = goog.dom.Range.createFromNodes(container.firstChild.firstChild,
        0, container.firstChild.firstChild, 4);
    range.select();
    goog.editor.plugins.EnterHandler.deleteW3cRange_(range);

    goog.testing.dom.assertHtmlContentsMatch('<div>&nbsp;</div>', container);
  }
}

function testDeleteW3CPartialEnd() {
  if (goog.editor.BrowserFeature.HAS_W3C_RANGES) {
    container.innerHTML = '<div>ab</div><div>cd</div>';
    var range = goog.dom.Range.createFromNodes(container.firstChild.firstChild,
        1, container.lastChild.firstChild, 1);
    range.select();
    goog.editor.plugins.EnterHandler.deleteW3cRange_(range);

    goog.testing.dom.assertHtmlContentsMatch('<div>ad</div>', container);
  }
}

function testDeleteW3CNonPartialEnd() {
  if (goog.editor.BrowserFeature.HAS_W3C_RANGES) {
    container.innerHTML = '<div>ab</div><div>cd</div>';
    var range = goog.dom.Range.createFromNodes(container.firstChild.firstChild,
        1, container.lastChild.firstChild, 2);
    range.select();
    goog.editor.plugins.EnterHandler.deleteW3cRange_(range);

    goog.testing.dom.assertHtmlContentsMatch('<div>a</div>', container);
  }
}

function testIsInOneContainer() {
  if (goog.editor.BrowserFeature.HAS_W3C_RANGES) {
    container.innerHTML = '<div><br></div>';
    var div = container.firstChild;
    var range = goog.dom.Range.createFromNodes(div, 0, div, 1);
    range.select();
    assertTrue('Selection must be recognized as being in one container',
        goog.editor.plugins.EnterHandler.isInOneContainerW3c_(range));
  }
}

">19 of 19 tests run in 29ms.<br />0 passed, 19 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testCollapsedSelectionKeepsBrOpera<br />Object #<Object> has no method 'createElement'<br />ERROR in testDeleteBeforeBlockquote<br />Object #<Object> has no method 'createElement'<br />ERROR in testDeleteBrBeforeBlock<br />Object #<Object> has no method 'createElement'<br />ERROR in testDeleteBrNormal<br />Object #<Object> has no method 'createElement'<br />ERROR in testDeleteW3CAll<br />Object #<Object> has no method 'createElement'<br />ERROR in testDeleteW3CNonPartialEnd<br />Object #<Object> has no method 'createElement'<br />ERROR in testDeleteW3CPartialEnd<br />Object #<Object> has no method 'createElement'<br />ERROR in testDeleteW3CSimple<br />Object #<Object> has no method 'createElement'<br />ERROR in testEnterAtEndOfBlockInWebkit<br />Object #<Object> has no method 'createElement'<br />ERROR in testEnterInBlockquoteCreatesDivInBrMode<br />Object #<Object> has no method 'createElement'<br />ERROR in testEnterInBlockquoteRemovesExtraNodes<br />Object #<Object> has no method 'createElement'<br />ERROR in testEnterInBlockquoteRemovesUnnecessaryBrWithCursorAfterBr<br />Object #<Object> has no method 'createElement'<br />ERROR in testEnterInBlockquoteRemovesUnnecessaryBrWithCursorBeforeBr<br />Object #<Object> has no method 'createElement'<br />ERROR in testEnterInList<br />Object #<Object> has no method 'createElement'<br />ERROR in testEnterInNonSetupBlockquote<br />Object #<Object> has no method 'createElement'<br />ERROR in testEnterInNonSetupBlockquoteWhenClassnameIsNotRequired<br />Object #<Object> has no method 'createElement'<br />ERROR in testEnterInSetupBlockquote<br />Object #<Object> has no method 'createElement'<br />ERROR in testIsInOneContainer<br />Object #<Object> has no method 'createElement'<br />ERROR in testPrepareContent<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>headerformatter_test.html</td><td>Fail</td><td> 0 passed, 1 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.editor.Command');
  goog.require('goog.editor.plugins.BasicTextFormatter');
  goog.require('goog.editor.plugins.HeaderFormatter');
  goog.require('goog.testing.editor.FieldMock');
  goog.require('goog.testing.editor.TestHelper');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');




  var field = goog.dom.getElement('field');
  var editableField;
  var headerFormatter;
  var btf;
  var testHelper = new goog.testing.editor.TestHelper(field);

  function setUp() {
    testHelper.setUpEditableElement();
    editableField = new goog.testing.editor.FieldMock();
    headerFormatter = new goog.editor.plugins.HeaderFormatter();
    headerFormatter.registerFieldObject(editableField);
    btf = new goog.editor.plugins.BasicTextFormatter();
    btf.registerFieldObject(editableField);
  }

  function tearDown() {
    editableField = null;
    headerFormatter.dispose();
    testHelper.tearDownEditableElement();
  }


  function testHeaderShortcuts() {
    field.innerHTML = 'myText';

    var textNode = field.firstChild;
    testHelper.select(textNode, 0, textNode, textNode.length);

    editableField.getElement();
    editableField.$anyTimes();
    editableField.$returns(field);

    editableField.getPluginByClassId("Bidi");
    editableField.$anyTimes();
    editableField.$returns(null);

    editableField.execCommand(
        goog.editor.Command.FORMAT_BLOCK,
        goog.editor.plugins.HeaderFormatter.HEADER_COMMAND.H1);
    // Bypass EditableField's execCommand and directly call
    // basicTextFormatter's.  Future version of headerformatter will include
    // that code in its own execCommand.
    editableField.$does(function() {
      btf.execCommandInternal(
          goog.editor.plugins.BasicTextFormatter.COMMAND.FORMAT_BLOCK,
          goog.editor.plugins.HeaderFormatter.HEADER_COMMAND.H1); });

    var event = new goog.testing.LooseMock(goog.events.BrowserEvent);
    if (goog.userAgent.GECKO) {
      event.stopPropagation();
    }

    editableField.$replay();
    event.$replay();

    assertTrue('Event handled',
        headerFormatter.handleKeyboardShortcut(event, '1', true));
    assertEquals('Field contains a header', 'H1', field.firstChild.nodeName);

    editableField.$verify();
    event.$verify();
  }
">1 of 1 tests run in 23ms.<br />0 passed, 1 failed.<br />23 ms/test. 1 files loaded.<br />ERROR in testHeaderShortcuts<br />Cannot set property 'designMode' of undefined<br /></td></tr>
<tr><td>blockquote_test.html</td><td>Fail</td><td> 0 passed, 6 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.editor.plugins.Blockquote');
  goog.require('goog.testing.dom');
  goog.require('goog.testing.editor.FieldMock');
  goog.require('goog.testing.editor.TestHelper');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');



var SPLIT = '<span id="split-point"></span>';
var root, helper, field, plugin;

function setUp() {
  root = goog.dom.getElement('root');
  helper = new goog.testing.editor.TestHelper(root);
  field = new goog.testing.editor.FieldMock();

  helper.setUpEditableElement();
}

function tearDown() {
  field.$verify();  
  helper.tearDownEditableElement();
}

function createPlugin(requireClassname, opt_paragraphMode) {
  field.queryCommandValue('+defaultTag').$anyTimes().$returns(
      opt_paragraphMode ? goog.dom.TagName.P : undefined);

  plugin = new goog.editor.plugins.Blockquote(requireClassname);
  plugin.registerFieldObject(field);
  plugin.enable(field);
}

function execCommand() {
  field.$replay();

  // With splitPoint we try to mimic the behavior of EnterHandler's
  // deleteCursorSelection_.
  var splitPoint = goog.dom.getElement('split-point');
  var position = goog.userAgent.IE ?
      splitPoint : {node: splitPoint.nextSibling, offset: 0};
  if (!goog.userAgent.IE) {
    goog.dom.removeNode(splitPoint);
    goog.dom.Range.createCaret(position.node, 0).select();
  } else {
    goog.dom.Range.createCaret(position, 0).select();
  }

  var result = plugin.execCommand(goog.editor.plugins.Blockquote.SPLIT_COMMAND,
      position);
  if (goog.userAgent.IE) {
    goog.dom.removeNode(splitPoint);
  }

  return result;
}

function testSplitBlockquoteDoesNothingWhenNotInBlockquote() {
  root.innerHTML = '<div>Test' + SPLIT + 'ing</div>';

  createPlugin(false);
  assertFalse(execCommand());
  helper.assertHtmlMatches('<div>Testing</div>');
}

function testSplitBlockquoteDoesNothingWhenNotInBlockquoteWithClass() {
  root.innerHTML = '<blockquote>Test' + SPLIT + 'ing</blockquote>';

  createPlugin(true);
  assertFalse(execCommand());
  helper.assertHtmlMatches('<blockquote>Testing</blockquote>');
}

function testSplitBlockquoteInBlockquoteWithoutClass() {
  root.innerHTML = '<blockquote>Test' + SPLIT + 'ing</blockquote>';

  createPlugin(false);
  assertTrue(execCommand());
  helper.assertHtmlMatches(
      '<blockquote>Test</blockquote>' +
      '<div>[[!IE]]&nbsp;</div>' +
      '<blockquote>ing</blockquote>');
}

function testSplitBlockquoteInBlockquoteWithoutClassInParagraphMode() {
  root.innerHTML = '<blockquote>Test' + SPLIT + 'ing</blockquote>';

  createPlugin(false, true);
  assertTrue(execCommand());
  helper.assertHtmlMatches(
      '<blockquote>Test</blockquote>' +
      '<p>[[!IE]]&nbsp;</p>' +
      '<blockquote>ing</blockquote>');
}

function testSplitBlockquoteInBlockquoteWithClass() {
  root.innerHTML =
      '<blockquote class="tr_bq">Test' + SPLIT + 'ing</blockquote>';

  createPlugin(true);
  assertTrue(execCommand());
  helper.assertHtmlMatches(
      '<blockquote class="tr_bq">Test</blockquote>' +
      '<div>[[!IE]]&nbsp;</div>' +
      '<blockquote class="tr_bq">ing</blockquote>');
}

function testSplitBlockquoteInBlockquoteWithClassInParagraphMode() {
  root.innerHTML =
      '<blockquote class="tr_bq">Test' + SPLIT + 'ing</blockquote>';

  createPlugin(true, true);
  assertTrue(execCommand());
  helper.assertHtmlMatches(
      '<blockquote class="tr_bq">Test</blockquote>' +
      '<p>[[!IE]]&nbsp;</p>' +
      '<blockquote class="tr_bq">ing</blockquote>');
}


">6 of 6 tests run in 33ms.<br />0 passed, 6 failed.<br />6 ms/test. 1 files loaded.<br />ERROR in testSplitBlockquoteDoesNothingWhenNotInBlockquote<br />Cannot set property 'designMode' of undefined<br />ERROR in testSplitBlockquoteDoesNothingWhenNotInBlockquoteWithClass<br />Cannot set property 'designMode' of undefined<br />ERROR in testSplitBlockquoteInBlockquoteWithClass<br />Cannot set property 'designMode' of undefined<br />ERROR in testSplitBlockquoteInBlockquoteWithClassInParagraphMode<br />Cannot set property 'designMode' of undefined<br />ERROR in testSplitBlockquoteInBlockquoteWithoutClass<br />Cannot set property 'designMode' of undefined<br />ERROR in testSplitBlockquoteInBlockquoteWithoutClassInParagraphMode<br />Cannot set property 'designMode' of undefined<br /></td></tr>
<tr><td>abstracttabhandler_test.html</td><td>Success</td><td> 1 passed, 0 failed.</td><td title="


  goog.require('goog.dom');
  goog.require('goog.editor.BrowserFeature');
  goog.require('goog.editor.plugins.AbstractTabHandler');
  goog.require('goog.events.BrowserEvent');
  goog.require('goog.events.KeyCodes');
  goog.require('goog.testing.StrictMock');
  goog.require('goog.testing.editor.FieldMock');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');



var tabHandler;
var editableField;
var handleTabKeyCalled = false;

function setUp() {
  editableField = new goog.testing.editor.FieldMock();
  editableField.inModalMode = goog.editor.Field.prototype.inModalMode;
  editableField.setModalMode = goog.editor.Field.prototype.setModalMode;

  tabHandler = new goog.editor.plugins.AbstractTabHandler();
  tabHandler.registerFieldObject(editableField);
  tabHandler.handleTabKey = function(e) {
    handleTabKeyCalled = true;
    return true;
  };
}

function tearDown() {
  tabHandler.dispose();
}

function testHandleKey() {
  var event = new goog.testing.StrictMock(goog.events.BrowserEvent);
  event.keyCode = goog.events.KeyCodes.TAB;
  event.ctrlKey = false;
  event.metaKey = false;

  assertTrue('Event must be handled when no modifier keys are pressed.',
      tabHandler.handleKeyboardShortcut(event, '', false));
  assertTrue(handleTabKeyCalled);
  handleTabKeyCalled = false;

  editableField.setModalMode(true);
  if (goog.userAgent.GECKO) {
    assertFalse('Event must not be handled when in modal mode',
        tabHandler.handleKeyboardShortcut(event, '', false));
    assertFalse(handleTabKeyCalled);
  } else {
    assertTrue('Event must be handled when in modal mode',
        tabHandler.handleKeyboardShortcut(event, '', false));
    assertTrue(handleTabKeyCalled);
    handleTabKeyCalled = false;
  }

  event.ctrlKey = true;
  assertFalse('Plugin must never handle tab key press when ctrlKey is pressed.',
      tabHandler.handleKeyboardShortcut(event, '', false));
  assertFalse(handleTabKeyCalled);

  event.ctrlKey = false;
  event.metaKey = true;
  assertFalse('Plugin must never handle tab key press when metaKey is pressed.',
      tabHandler.handleKeyboardShortcut(event, '', false));
  assertFalse(handleTabKeyCalled);
}
">n/a</td></tr>
<tr><td>undoredo_test.html</td><td>Fail</td><td> 7 passed, 6 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.dom');
  goog.require('goog.editor.Field');
  goog.require('goog.editor.Field.EventType');
  goog.require('goog.events');
  goog.require('goog.events.BrowserEvent');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.testing.StrictMock');
  goog.require('goog.testing.jsunit');
  goog.require('goog.editor.plugins.LoremIpsum');
  goog.require('goog.editor.plugins.UndoRedo');




var mockEditableField;
var editableField;
var fieldHashCode;
var undoPlugin;
var state
var mockState;
var commands;
var clock;
var stubs = new goog.testing.PropertyReplacer();


function setUp() {
  mockEditableField = new goog.testing.StrictMock(goog.editor.Field);

  // Update the arg list verifier for dispatchCommandValueChange to
  // correctly compare arguments that are arrays (or other complex objects).
  mockEditableField.$registerArgumentListVerifier('dispatchEvent',
   function(expected, args) {
       return goog.array.equals(expected, args,
           function(a, b) { assertObjectEquals(a, b); return true; });
    });
  mockEditableField.getHashCode = function() {
    return 'fieldId';
  }

  undoPlugin = new goog.editor.plugins.UndoRedo();
  undoPlugin.registerFieldObject(mockEditableField);
  mockState = new goog.testing.StrictMock(
      goog.editor.plugins.UndoRedo.UndoState_);
  mockState.fieldHashCode = 'fieldId';
  mockState.isAsynchronous = function() {
    return false;
  };
  // Don't bother mocking the inherited event target pieces of the state.
  // If we don't do this, then mocked asynchronous undos are a lot harder and
  // that behavior is tested as part of the UndoRedoManager tests.
  mockState.addEventListener = goog.nullFunction;

  commands = [
    goog.editor.plugins.UndoRedo.COMMAND.REDO,
    goog.editor.plugins.UndoRedo.COMMAND.UNDO
  ];
  state = new goog.editor.plugins.UndoRedo.UndoState_('1', '', null,
      goog.nullFunction);

  clock = new goog.testing.MockClock(true);

  editableField = new goog.editor.Field('testField');
  fieldHashCode = editableField.getHashCode();
}


function tearDown() {
  // Reset field so any attempted access during disposes don't cause errors.
  mockEditableField.$reset();
  clock.dispose();
  undoPlugin.dispose();

  // NOTE(nicksantos): I think IE is blowing up on this call because
  // it is lame. It manifests its lameness by throwing an exception.
  // Kudos to XT for helping me to figure this out.
  try {
    goog.events.removeAll();
  } catch (e) {}

  if (!editableField.isUneditable()) {
    editableField.makeUneditable();
  }
  editableField.dispose();
  goog.dom.getElement('testField').innerHTML = '';
  stubs.reset();
}


// undo-redo plugin tests


function testQueryCommandValue() {
  assertFalse('Must return false for empty undo stack.',
      undoPlugin.queryCommandValue(goog.editor.plugins.UndoRedo.COMMAND.UNDO));

  assertFalse('Must return false for empty redo stack.',
      undoPlugin.queryCommandValue(goog.editor.plugins.UndoRedo.COMMAND.REDO));

  undoPlugin.undoManager_.addState(mockState);

  assertTrue('Must return true for a non-empty undo stack.',
      undoPlugin.queryCommandValue(goog.editor.plugins.UndoRedo.COMMAND.UNDO));
}


function testExecCommand() {
  undoPlugin.undoManager_.addState(mockState);

  mockState.undo();
  mockState.$replay();

  undoPlugin.execCommand(goog.editor.plugins.UndoRedo.COMMAND.UNDO);
  // Second undo should do nothing since only one item on stack.
  undoPlugin.execCommand(goog.editor.plugins.UndoRedo.COMMAND.UNDO);
  mockState.$verify();

  mockState.$reset();
  mockState.redo();
  mockState.$replay();
  undoPlugin.execCommand(goog.editor.plugins.UndoRedo.COMMAND.REDO);
  // Second redo should do nothing since only one item on stack.
  undoPlugin.execCommand(goog.editor.plugins.UndoRedo.COMMAND.REDO);
  mockState.$verify();
}

function testHandleKeyboardShortcut_TrogStates() {
  undoPlugin.undoManager_.addState(mockState);
  undoPlugin.undoManager_.addState(state);
  undoPlugin.undoManager_.undo();
  mockEditableField.$reset();

  var stubUndoEvent = {ctrlKey: true, altKey: false, shiftKey: false};
  var stubRedoEvent = {ctrlKey: true, altKey: false, shiftKey: true};
  var stubRedoEvent2 = {ctrlKey: true, altKey: false, shiftKey: false};
  var result;

  // Test handling Trogedit undos. Should always call EditableField's
  // execCommand. Since EditableField is mocked, this will not result in a call
  // to the mockState's undo and redo methods.
  mockEditableField.execCommand(goog.editor.plugins.UndoRedo.COMMAND.UNDO);
  mockEditableField.$replay();
  result = undoPlugin.handleKeyboardShortcut(stubUndoEvent, 'z', true);
  assertTrue('Plugin must return true when it handles shortcut.', result);
  mockEditableField.$verify();
  mockEditableField.$reset();

  mockEditableField.execCommand(goog.editor.plugins.UndoRedo.COMMAND.REDO);
  mockEditableField.$replay();
  result = undoPlugin.handleKeyboardShortcut(stubRedoEvent, 'z', true);
  assertTrue('Plugin must return true when it handles shortcut.', result);
  mockEditableField.$verify();
  mockEditableField.$reset();

  mockEditableField.execCommand(goog.editor.plugins.UndoRedo.COMMAND.REDO);
  mockEditableField.$replay();
  result = undoPlugin.handleKeyboardShortcut(stubRedoEvent2, 'y', true);
  assertTrue('Plugin must return true when it handles shortcut.', result);
  mockEditableField.$verify();
  mockEditableField.$reset();

  mockEditableField.$replay();
  result = undoPlugin.handleKeyboardShortcut(stubRedoEvent2, 'y', false);
  assertFalse('Plugin must return false when modifier is not pressed.', result);
  mockEditableField.$verify();
  mockEditableField.$reset();

  mockEditableField.$replay();
  result = undoPlugin.handleKeyboardShortcut(stubUndoEvent, 'f', true);
  assertFalse('Plugin must return false when it doesn\'t handle shortcut.',
      result);
  mockEditableField.$verify();
}

function testHandleKeyboardShortcut_NotTrogStates() {
  var stubUndoEvent = {ctrlKey: true, altKey: false, shiftKey: false};

  // Trogedit undo states all have a fieldHashCode, nulling that out makes this
  // state be treated as a non-Trogedit undo-redo state.
  state.fieldHashCode = null;
  undoPlugin.undoManager_.addState(state);
  mockEditableField.$reset();

  // Non-trog state shouldn't go through EditableField.execCommand, however,
  // we still exect command value change dispatch since undo-redo plugin
  // redispatches those anytime manager's state changes.
  mockEditableField.dispatchEvent({
    type: goog.editor.Field.EventType.COMMAND_VALUE_CHANGE,
    commands: commands});
  mockEditableField.$replay();
  var result = undoPlugin.handleKeyboardShortcut(stubUndoEvent, 'z', true);
  assertTrue('Plugin must return true when it handles shortcut.' , result);
  mockEditableField.$verify();
}

function testEnable() {
  assertFalse('Plugin must start disabled.',
      undoPlugin.isEnabled(editableField));

  editableField.makeEditable(editableField);
  editableField.setHtml(false, '<div>a</div>');
  undoPlugin.enable(editableField);

  assertTrue(undoPlugin.isEnabled(editableField));
  assertNotNull('Must have an event handler for enabled field.',
      undoPlugin.eventHandlers_[fieldHashCode]);

  var currentState = undoPlugin.currentStates_[fieldHashCode];
  assertNotNull('Enabled plugin must have a current state.', currentState);
  assertEquals('After enable, undo content must match the field content.',
      editableField.getElement().innerHTML, currentState.undoContent_);

  assertTrue('After enable, undo cursorPosition must match the field cursor' +
      'position.', cursorPositionsEqual(getCurrentCursorPosition(),
          currentState.undoCursorPosition_));

  assertUndefined('Current state must never have redo content.',
      currentState.redoContent_);
  assertUndefined('Current state must never have redo cursor position.',
      currentState.redoCursorPosition_);
};

function testDisable() {
  editableField.makeEditable(editableField);
  undoPlugin.enable(editableField);
  assertTrue('Plugin must be enabled so we can test disabling.',
      undoPlugin.isEnabled(editableField));

  var delayedChangeFired = false;
  goog.events.listenOnce(editableField,
      goog.editor.Field.EventType.DELAYEDCHANGE,
      function(e) {
        delayedChangeFired = true;
      })
  editableField.setHtml(false, 'foo');

  undoPlugin.disable(editableField);
  assertTrue('disable must fire pending delayed changes.', delayedChangeFired);
  assertEquals('disable must add undo state from pending change.',
      1, undoPlugin.undoManager_.undoStack_.length);

  assertFalse(undoPlugin.isEnabled(editableField));
  assertUndefined('Disabled plugin must not have current state.',
      undoPlugin.eventHandlers_[fieldHashCode]);
  assertUndefined('Disabled plugin must not have event handlers.',
      undoPlugin.eventHandlers_[fieldHashCode]);
}

function testUpdateCurrentState_() {
  editableField.registerPlugin(new goog.editor.plugins.LoremIpsum('LOREM'));
  editableField.makeEditable(editableField);
  editableField.getPluginByClassId('LoremIpsum').usingLorem_ = true;
  undoPlugin.updateCurrentState_(editableField);
  var currentState = undoPlugin.currentStates_[fieldHashCode];
  assertNotUndefined('Must create empty states for field using lorem ipsum.',
      undoPlugin.currentStates_[fieldHashCode]);
  assertEquals('', currentState.undoContent_);
  assertNull(currentState.undoCursorPosition_);

  editableField.getPluginByClassId('LoremIpsum').usingLorem_ = false;

  // Pretend foo is the default contents to test '' == default contents
  // behavior.
  editableField.getInjectableContents = function(contents, styles) {
    return contents == '' ? 'foo' : contents;
  }
  editableField.setHtml(false, 'foo');
  undoPlugin.updateCurrentState_(editableField);
  assertEquals(currentState, undoPlugin.currentStates_[fieldHashCode]);

  // NOTE(user): Because there is already a current state, this setHtml will add
  // a state to the undo stack.
  editableField.setHtml(false, '<div>a</div>');
  // Select some text so we have a valid selection that gets saved in the
  // UndoState.
  goog.dom.browserrange.createRangeFromNodeContents(
      editableField.getElement()).select();

  undoPlugin.updateCurrentState_(editableField);
  currentState = undoPlugin.currentStates_[fieldHashCode];
  assertNotNull('Must create state for field not using lorem ipsum',
      currentState);
  assertEquals(fieldHashCode, currentState.fieldHashCode);
  var content = editableField.getElement().innerHTML;
  var cursorPosition = getCurrentCursorPosition();
  assertEquals(content, currentState.undoContent_);
  assertTrue(cursorPositionsEqual(
      cursorPosition, currentState.undoCursorPosition_));
  assertUndefined(currentState.redoContent_);
  assertUndefined(currentState.redoCursorPosition_);

  undoPlugin.updateCurrentState_(editableField);
  assertEquals('Updating state when state has not changed must not add undo ' +
      'state to stack.', 1, undoPlugin.undoManager_.undoStack_.length);
  assertEquals('Updating state when state has not changed must not create ' +
      'a new state.', currentState, undoPlugin.currentStates_[fieldHashCode])
  assertUndefined('Updating state when state has not changed must not add ' +
      'redo content.', currentState.redoContent_);
  assertUndefined('Updating state when state has not changed must not add ' +
      'redo cursor position.', currentState.redoCursorPosition_);

  editableField.setHtml(false, '<div>b</div>');
  undoPlugin.updateCurrentState_(editableField);
  currentState = undoPlugin.currentStates_[fieldHashCode];
  assertNotNull('Must create state for field not using lorem ipsum',
      currentState);
  assertEquals(fieldHashCode, currentState.fieldHashCode);
  var newContent = editableField.getElement().innerHTML;
  var newCursorPosition = getCurrentCursorPosition();
  assertEquals(newContent, currentState.undoContent_);
  assertTrue(cursorPositionsEqual(
      newCursorPosition, currentState.undoCursorPosition_));
  assertUndefined(currentState.redoContent_);
  assertUndefined(currentState.redoCursorPosition_);

  var undoState = goog.array.peek(undoPlugin.undoManager_.undoStack_);
  assertNotNull('Must create state for field not using lorem ipsum',
      currentState);
  assertEquals(fieldHashCode, currentState.fieldHashCode);
  assertEquals(content, undoState.undoContent_);
  assertTrue(cursorPositionsEqual(
      cursorPosition, undoState.undoCursorPosition_));
  assertEquals(newContent, undoState.redoContent_);
  assertTrue(cursorPositionsEqual(
      newCursorPosition, undoState.redoCursorPosition_));
}

/**
 * Tests that change events get restarted properly after an undo call despite
 * an exception being thrown in the process (see bug/1991234).
 */
function testUndoRestartsChangeEvents() {
  undoPlugin.registerFieldObject(editableField);
  editableField.makeEditable(editableField);
  editableField.setHtml(false, '<div>a</div>');
  clock.tick(1000);
  undoPlugin.enable(editableField);

  // Change content so we can undo it.
  editableField.setHtml(false, '<div>b</div>');
  clock.tick(1000);

  var currentState = undoPlugin.currentStates_[fieldHashCode];
  stubs.set(editableField, 'setCursorPosition',
      goog.functions.error('Faking exception during setCursorPosition()'));
  try {
    currentState.undo();
  } catch (e) {
    fail('Exception should not have been thrown during undo()');
  }
  assertEquals('Change events should be on', 0,
      editableField.stoppedEvents_[goog.editor.Field.EventType.CHANGE]);
  assertEquals('Delayed change events should be on', 0,
      editableField.stoppedEvents_[goog.editor.Field.EventType.DELAYEDCHANGE]);
}

function testRefreshCurrentState() {
  editableField.makeEditable(editableField);
  editableField.setHtml(false, '<div>a</div>');
  clock.tick(1000);
  undoPlugin.enable(editableField);

  // Create current state and verify it.
  var currentState = undoPlugin.currentStates_[fieldHashCode];
  assertEquals(fieldHashCode, currentState.fieldHashCode);
  var content = editableField.getElement().innerHTML;
  var cursorPosition = getCurrentCursorPosition();
  assertEquals(content, currentState.undoContent_);
  assertTrue(cursorPositionsEqual(
      cursorPosition, currentState.undoCursorPosition_));

  // Update the field w/o dispatching delayed change, and verify that the
  // current state hasn't changed to reflect new values.
  editableField.setHtml(false, '<div>b</div>', true);
  clock.tick(1000);
  currentState = undoPlugin.currentStates_[fieldHashCode];
  assertEquals('Content must match old state.',
      content, currentState.undoContent_);
  assertTrue('Cursor position must match old state.',
      cursorPositionsEqual(
      cursorPosition, currentState.undoCursorPosition_));

  undoPlugin.refreshCurrentState(editableField);
  assertFalse('Refresh must not cause states to go on the undo-redo stack.',
      undoPlugin.undoManager_.hasUndoState());
  currentState = undoPlugin.currentStates_[fieldHashCode];
  content = editableField.getElement().innerHTML;
  cursorPosition = getCurrentCursorPosition();
  assertEquals('Content must match current field state.',
      content, currentState.undoContent_);
  assertTrue('Cursor position must match current field state.',
      cursorPositionsEqual(cursorPosition, currentState.undoCursorPosition_));

  undoPlugin.disable(editableField);
  assertUndefined(undoPlugin.currentStates_[fieldHashCode]);
  undoPlugin.refreshCurrentState(editableField);
  assertUndefined('Must not refresh current state of fields that do not have ' +
      'undo-redo enabled.', undoPlugin.currentStates_[fieldHashCode]);
};

/**
 * Returns the CursorPosition for the selection currently in the Field.
 * @return {goog.editor.plugins.UndoRedo.CursorPosition_}
 */
function getCurrentCursorPosition() {
  return undoPlugin.getCursorPosition_(editableField);
}

/**
 * Compares two cursor positions and returns whether they are equal.
 * @param {goog.editor.plugins.UndoRedo.CursorPosition_} a
 *     A cursor position.
 * @param {goog.editor.plugins.UndoRedo.CursorPosition_} b
 *     A cursor position.
 * @return {boolean} Whether the positions are equal.
 */
function cursorPositionsEqual(a, b) {
  if (!a && !b) {
    return true;
  } else if (a && b){
    return a.toString() == b.toString();
  }
  // Only one cursor position is an object, can't be equal.
  return false;
}
// Undo state tests


function testSetUndoState() {
  state.setUndoState('content', 'position');
  assertEquals('Undo content incorrectly set', 'content', state.undoContent_);
  assertEquals('Undo cursor position incorrectly set', 'position',
      state.undoCursorPosition_);
}

function testSetRedoState() {
  state.setRedoState('content', 'position');
  assertEquals('Redo content incorrectly set', 'content', state.redoContent_);
  assertEquals('Redo cursor position incorrectly set', 'position',
      state.redoCursorPosition_);
}

function testEquals() {
  assertTrue('A state must equal itself', state.equals(state));

  var state2 = new goog.editor.plugins.UndoRedo.UndoState_('1', '', null);
  assertTrue('A state must equal a state with the same hash code and content.',
      state.equals(state2));

  state2 = new goog.editor.plugins.UndoRedo.UndoState_('1', '', 'foo');
  assertTrue('States with different cursor positions must be equal',
      state.equals(state2));

  state2.setRedoState('bar', null);
  assertFalse('States with different redo content must not be equal',
      state.equals(state2));

  state2 = new goog.editor.plugins.UndoRedo.UndoState_('3', '', null);
  assertFalse('States with different field hash codes must not be equal',
      state.equals(state2));

  state2 = new goog.editor.plugins.UndoRedo.UndoState_('1', 'baz', null);
  assertFalse('States with different undoContent must not be equal',
      state.equals(state2));
}

/** @bug 1359214 */
function testClearUndoHistory() {
  var undoRedoPlugin = new goog.editor.plugins.UndoRedo();
  editableField.registerPlugin(undoRedoPlugin);
  editableField.makeEditable(editableField);

  editableField.dispatchChange();
  clock.tick(10000);

  editableField.getElement().innerHTML = 'y';
  editableField.dispatchChange();
  assertFalse(undoRedoPlugin.undoManager_.hasUndoState());

  clock.tick(10000);
  assertTrue(undoRedoPlugin.undoManager_.hasUndoState());

  editableField.getElement().innerHTML = 'z';
  editableField.dispatchChange();

  var numCalls = 0;
  goog.events.listen(editableField, goog.editor.Field.EventType.DELAYEDCHANGE,
      function() {
        numCalls++;
      });
  undoRedoPlugin.clearHistory();
  // 1 call from stopChangeEvents(). 0 calls from startChangeEvents().
  assertEquals('clearHistory must not cause delayed change when none pending',
      1, numCalls);

  clock.tick(10000);
  assertFalse(undoRedoPlugin.undoManager_.hasUndoState());
}
">13 of 13 tests run in 37ms.<br />7 passed, 6 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testClearUndoHistory<br />Cannot read property 'cssText' of undefined<br />ERROR in testDisable<br />Cannot read property 'cssText' of undefined<br />ERROR in testEnable<br />Cannot read property 'cssText' of undefined<br />ERROR in testRefreshCurrentState<br />Cannot read property 'cssText' of undefined<br />ERROR in testUndoRestartsChangeEvents<br />Cannot read property 'cssText' of undefined<br />ERROR in testUpdateCurrentState_<br />Cannot read property 'cssText' of undefined<br /></td></tr>
<tr><td>removeformatting_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.dom.Range');
  goog.require('goog.editor.plugins.RemoveFormatting');
  goog.require('goog.testing.dom');
  goog.require('goog.testing.editor.FieldMock');
  goog.require('goog.testing.editor.TestHelper');
  goog.require('goog.testing.ExpectedFailures');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');


  var SAVED_HTML;
  var FIELDMOCK;
  var FORMATTER;
  var testHelper;

  // Extra html to add to test html to make sure removeformatting is actually
  // getting called when you're testing if it leaves certain styles alone
  // (instead of not even running at all due to some other bug). However, adding
  // this extra text into the node to be selected screws up IE.
  // (e.g. <a><img></a><b>t</b> --> <a></a><a><img></a>t )
  // TODO(marcosalmeida): Remove this special casing once http://b/3131117 is
  // fixed.
  var controlHtml = goog.userAgent.IE ? '' : '<u>control</u>';
  var controlCleanHtml = goog.userAgent.IE ? '' : 'control';

  var expectedFailures = new goog.testing.ExpectedFailures();

  function setUp() {
    testHelper = new goog.testing.editor.TestHelper(
        document.getElementById('html'));
    testHelper.setUpEditableElement();

    FIELDMOCK = new goog.testing.editor.FieldMock();
    FIELDMOCK.getElement();
    FIELDMOCK.$anyTimes();
    FIELDMOCK.$returns(document.getElementById('html'));

    FORMATTER = new goog.editor.plugins.RemoveFormatting();
    FORMATTER.fieldObject = FIELDMOCK;

    FIELDMOCK.$replay();
  }

  function tearDown() {
    expectedFailures.handleTearDown();
    testHelper.tearDownEditableElement();
  }

  function setUpTableTests() {
    var div = document.getElementById('html');
    div.innerHTML = '<table><tr> <th> head1</th><th id= "outerTh">' +
        '<span id="emptyTh">head2</span></th> </tr><tr> <td> one </td> <td>' +
        'two </td> </tr><tr><td> three</td><td id="outerTd"> ' +
        '<span id="emptyTd"><strong>four</strong></span></td></tr>' +
        '<tr id="outerTr"><td><span id="emptyTr"> five </span></td></tr>' +
        '<tr id="outerTr2"><td id="cell1"><b>seven</b></td><td id="cell2">' +
        '<u>eight</u><span id="cellspan2"> foo</span></td></tr></table>';
  }

  function testTableTagsAreNotRemoved() {
    setUpTableTests();
    var span;

    // TD
    span = document.getElementById('emptyTd');
    goog.dom.Range.createFromNodeContents(span).select();
    FORMATTER.removeFormatting_();

    var elem = document.getElementById('outerTd');
    assert('TD should not be removed', !!elem);
    if (!goog.userAgent.WEBKIT) {
      // webkit seems to have an Apple-style-span
      assertEquals('TD should be clean', 'four', 
          goog.string.trim(elem.innerHTML));
    }

    // TR
    span = document.getElementById('outerTr');
    goog.dom.Range.createFromNodeContents(span).select();
    FORMATTER.removeFormatting_();

    var elem = document.getElementById('outerTr');
    assert('TR should not be removed', !!elem);

    // TH
    span = document.getElementById('emptyTh');
    goog.dom.Range.createFromNodeContents(span).select();
    FORMATTER.removeFormatting_();

    var elem = document.getElementById('outerTh');
    assert('TH should not be removed', !!elem);
    if (!goog.userAgent.WEBKIT) {
      // webkit seems to have an Apple-style-span
      assertEquals('TH should be clean', 'head2', elem.innerHTML);
    }

  }

  /**
   * We select two cells from the table and then make sure that there is no
   * data loss and basic formatting is removed from each cell.
   */
  function testTableDataIsNotRemoved() {
    setUpTableTests();
    if (goog.userAgent.IE) {
      // IE returns an "unspecified error" which seems to be beyond
      // ExpectedFailures' ability to catch.
      return;
    }

    expectedFailures.expectFailureFor(goog.userAgent.WEBKIT,
        'The content moves out of the table in WEBKIT.');

    if (goog.userAgent.IE) {
      // Not used since we bail out early for IE, but this is there so that
      // developers can easily reproduce IE error.
      goog.dom.Range.createFromNodeContents(
        document.getElementById('outerTr2')).select();
    } else {
      var selection = window.getSelection();
      if (selection.rangeCount > 0) selection.removeAllRanges();
      var range = document.createRange();
      range.selectNode(document.getElementById('cell1'));
      selection.addRange(range);
      range = document.createRange();
      range.selectNode(document.getElementById('cell2'));
      selection.addRange(range);
    }

    expectedFailures.run(function() {
      FORMATTER.removeFormatting_();

      span = document.getElementById('outerTr2');
      assertEquals('Table data should not be removed',
          '<td id="cell1">seven</td><td id="cell2">eight foo</td>',
          span.innerHTML);
      });
  }

  function testLinksAreNotRemoved() {
    expectedFailures.expectFailureFor(goog.userAgent.WEBKIT,
        'WebKit\'s removeFormatting command removes links.');

    var anchor;
    var div = document.getElementById('html');
    div.innerHTML = 'Foo<span id="link">Pre<a href="http://www.google.com">' +
                     'Outside Span<span style="font-size:15pt">Inside Span' +
                     '</span></a></span>';

    anchor = document.getElementById('link');
    goog.dom.Range.createFromNodeContents(anchor).select();

    expectedFailures.run(function() {
      FORMATTER.removeFormatting_();
      assertHTMLEquals('link should not be removed',
          'FooPre<a href="http://www.google.com/">Outside SpanInside Span</a>',
          div.innerHTML);
    });
  }

  /**
   * A short formatting removal function for use with the RemoveFormatting
   * plugin. Does enough that we can tell this function was run over the
   * document.
   * @param {string} text The HTML in from the document.
   * @return {string} The "cleaned" HTML out.
   */
  function replacementFormattingFunc(text) {
    // Really basic so that we can just see this is executing.
    return text.replace(/Foo/gi,'Bar').replace(/<[\/]*span[^>]*>/gi,'');
  }

  function testAlternateRemoveFormattingFunction() {
    var div = document.getElementById('html');
    div.innerHTML = 'Start<span id="remFormat">Foo<pre>Bar</pre>Baz</span>';

    FORMATTER.setRemoveFormattingFunc(replacementFormattingFunc);
    var area = document.getElementById('remFormat');
    goog.dom.Range.createFromNodeContents(area).select();
    FORMATTER.removeFormatting_();
    // Webkit will change all tags to non-formatted ones anyway.
    // Make sure 'Foo' was changed to 'Bar'
    if (goog.userAgent.WEBKIT) {
      assertHTMLEquals('regular cleaner should not have run',
          'StartBar<br>Bar<br>Baz',
          div.innerHTML);
    } else {
      assertHTMLEquals('regular cleaner should not have run',
          'StartBar<pre>Bar</pre>Baz',
          div.innerHTML);
    }
  }

  function testGetValueForNode() {
    // Override getValueForNode to keep bold tags.
    var oldGetValue =
        goog.editor.plugins.RemoveFormatting.prototype.getValueForNode;
    goog.editor.plugins.RemoveFormatting.prototype.getValueForNode =
        function(node) {
      if (node.nodeName == goog.dom.TagName.B) {
        return '<b>' + this.removeFormattingWorker_(node.innerHTML) + '</b>';
      }
      return null;
    }

    var html = FORMATTER.removeFormattingWorker_('<div>foo<b>bar</b></div>');
    assertHTMLEquals('B tags should remain','foo<b>bar</b>', html);

    // Override getValueForNode to throw out bold tags, and their contents.
    goog.editor.plugins.RemoveFormatting.prototype.getValueForNode =
        function(node) {
      if (node.nodeName == goog.dom.TagName.B) {
        return '';
      }
      return null;
    }

    html = FORMATTER.removeFormattingWorker_('<div>foo<b>bar</b></div>');
    assertHTMLEquals('B tag and its contents should be removed', 'foo', html);

    FIELDMOCK.$verify();
    goog.editor.plugins.RemoveFormatting.prototype.getValueForNode =
        oldGetValue;
  }

  function testRemoveFormattingAddsNoNbsps() {
    var div = document.getElementById('html');
    div.innerHTML = '"<span id="toStrip">Twin <b>Cinema</b></span>"';

    var span = document.getElementById('toStrip');
    goog.dom.Range.createFromNodeContents(span).select();

    FORMATTER.removeFormatting_();

    assertEquals('Text should be the same, with no non-breaking spaces',
        '"Twin Cinema"', div.innerHTML);

    FIELDMOCK.$verify();
  }

  /**
   * @bug 992795
   */
  function testRemoveFormattingNestedDivs() {
    var html = FORMATTER.removeFormattingWorker_(
        '<div>1</div><div><div>2</div></div>');

    goog.testing.dom.assertHtmlMatches('1<br>2', html);
  }

  /**
   * Test that when we perform remove formatting on an entire table,
   * that the visual look is similiar to as if there was a table there.
   */
  function testRemoveFormattingForTableFormatting() {
    // We preserve the table formatting as much as possible.
    // Spaces separate TD's, <br>'s separate TR's.
    // <br>'s separate the start and end of a table.
    var html = '<table><tr><td>cell00</td><td>cell01</td></tr>' +
        '<tr><td>cell10</td><td>cell11</td></tr></table>';
    html = FORMATTER.removeFormattingWorker_(html)
    assertHTMLEquals("<br>cell00 cell01<br>cell10 cell11<br>", html);
  }

  /**
   * @bug 1319715
   */
  function testRemoveFormattingDoesNotShrinkSelection() {
    var div = document.getElementById('html');
    div.innerHTML = "<div>l </div><div><br><b>a</b>foo bar</div>";
    var div2 = div.lastChild;

    goog.dom.Range.createFromNodes(div2.firstChild, 0,
        div2.lastChild, 7).select();

    FORMATTER.removeFormatting_();

    var range = goog.dom.Range.createFromWindow();
    assertEquals('Correct text should be selected', 'afoo bar',
        range.getText());

    // We have to trim out the leading BR in IE due to execCommand issues,
    // so it isn't sent off to the removeFormattingWorker.
    // Workaround for broken removeFormat in old webkit added an extra
    // <br> to the end of the html.
    var html =  '<div>l </div><br class="GECKO WEBKIT">afoo bar' +
        (goog.editor.BrowserFeature.ADDS_NBSPS_IN_REMOVE_FORMAT ? '<br>' : '');

    goog.testing.dom.assertHtmlContentsMatch(html, div);
    FIELDMOCK.$verify();
  }


  /**
   *  @bug 1447374
   */
  function testInsideListRemoveFormat() {
    var div = document.getElementById('html');
    div.innerHTML = "<ul><li>one</li><li><b>two</b></li><li>three</li></ul>";

    var twoLi = div.firstChild.childNodes[1];
    goog.dom.Range.createFromNodeContents(twoLi).select();

    expectedFailures.expectFailureFor(goog.userAgent.IE,
        'IE adds the "two" to the "three" li, and leaves empty B tags.');
    expectedFailures.expectFailureFor(goog.userAgent.WEBKIT,
        'WebKit leave the "two" orphaned outside of an li but ' +
        'inside the ul (invalid HTML).');

    expectedFailures.run(function() {
      FORMATTER.removeFormatting_();
      // Test that we split the list.
      assertHTMLEquals("<ul><li>one</li></ul><br>two<ul><li>three</li></ul>",
          div.innerHTML);
      FIELDMOCK.$verify();
    });
  }

  function testFullListRemoveFormat() {
    var div = document.getElementById('html');
    div.innerHTML =
      "<ul><li>one</li><li><b>two</b></li><li>three</li></ul>after";

    goog.dom.Range.createFromNodeContents(div.firstChild).select();

    //  Note: This may just be a createFromNodeContents issue, as
    //  I can't ever make this happen with real user selection.
    expectedFailures.expectFailureFor(goog.userAgent.IE,
        'IE combines everything into a single LI and leaves the UL.');

    expectedFailures.run(function() {
      FORMATTER.removeFormatting_();
      // Test that we completely remove the list.
      assertHTMLEquals("<br>one<br>two<br>threeafter",
          div.innerHTML);
      FIELDMOCK.$verify();
    });
  }

  /**
   *  @bug 1440935
   */
  function testPartialListRemoveFormat() {
    var div = document.getElementById('html');
    div.innerHTML =
      "<ul><li>one</li><li>two</li><li>three</li></ul>after";

    // Select "two three after".
    goog.dom.Range.createFromNodes(div.firstChild.childNodes[1], 0,
        div.lastChild, 5).select();

    expectedFailures.expectFailureFor(goog.userAgent.IE,
        'IE leaves behind an empty LI.');
    expectedFailures.expectFailureFor(goog.userAgent.WEBKIT,
        'WebKit completely loses the "one".');

    expectedFailures.run(function() {
      FORMATTER.removeFormatting_();
      // Test that we leave the list start alone.
      assertHTMLEquals("<ul><li>one</li></ul><br>two<br>threeafter",
          div.innerHTML);
      FIELDMOCK.$verify();
    });
  }

  function testBasicRemoveFormatting() {
    // IE will clobber the editable div.
    // Note: I can't repro this using normal user selections.
    if (goog.userAgent.IE) {
      return;
    }
    var div =  document.getElementById('html');
    div.innerHTML = "<b>bold<i>italic</i></b>";

    goog.dom.Range.createFromNodeContents(div).select();

    expectedFailures.expectFailureFor(
         goog.editor.BrowserFeature.ADDS_NBSPS_IN_REMOVE_FORMAT,
        'The workaround for the nbsp bug adds an extra br at the end.');

    expectedFailures.run(function() {
      FORMATTER.removeFormatting_();
      assertHTMLEquals("bolditalic",
          div.innerHTML);
      FIELDMOCK.$verify();
    });
  }

  /**
   * @bug 1480260
   */
  function testPartialBasicRemoveFormatting() {
    var div = document.getElementById('html');
    div.innerHTML = "<b>bold<i>italic</i></b>";

    goog.dom.Range.createFromNodes(div.firstChild.firstChild, 2,
        div.firstChild.lastChild.firstChild, 3).select();

    expectedFailures.expectFailureFor(goog.userAgent.WEBKIT,
        'WebKit just gets this all wrong.  Everything stays bold and ' +
        '"lditalic" gets italicised.');

    expectedFailures.run(function() {
      FORMATTER.removeFormatting_();
      assertHTMLEquals("<b>bo</b>ldita<b><i>lic</i></b>",
          div.innerHTML);
      FIELDMOCK.$verify();
    });
  }

  /**
   * @bug 3075557
   */
  function testRemoveFormattingLinkedImageBorderZero() {
    var testHtml = '<a href="http://www.google.com/">' +
        '<img src="http://www.google.com/images/logo.gif" border="0"></a>';
    var div =  document.getElementById('html');
    div.innerHTML = testHtml + controlHtml;
    goog.dom.Range.createFromNodeContents(div).select();
    FORMATTER.removeFormatting_();
    
    expectedFailures.expectFailureFor(goog.userAgent.WEBKIT,
        'WebKit removes the image entirely, see ' +
        'https://bugs.webkit.org/show_bug.cgi?id=13125 .');

    expectedFailures.run(function() {
      assertHTMLEquals(
          'Image\'s border=0 should not be removed during remove formatting',
          testHtml + controlCleanHtml, div.innerHTML);
      FIELDMOCK.$verify();
    });
  }

  /**
   * @bug 3075557
   */
  function testRemoveFormattingLinkedImageBorderNonzero() {
    var testHtml = '<a href="http://www.google.com/">' +
        '<img src="http://www.google.com/images/logo.gif" border="1"></a>';
    var div =  document.getElementById('html');
    div.innerHTML = testHtml + controlHtml;
    goog.dom.Range.createFromNodeContents(div).select();
    FORMATTER.removeFormatting_();

    expectedFailures.expectFailureFor(goog.userAgent.WEBKIT,
        'WebKit removes the image entirely, see ' +
        'https://bugs.webkit.org/show_bug.cgi?id=13125 .');

    expectedFailures.run(function() {
      assertHTMLEquals(
          'Image\'s border should be removed during remove formatting' +
          ' if non-zero',
          testHtml.replace(' border="1"', '') + controlCleanHtml,
          div.innerHTML);
      FIELDMOCK.$verify();
    });
  }

  /**
   * @bug 3075557
   */
  function testRemoveFormattingUnlinkedImage() {
    var testHtml =
        '<img src="http://www.google.com/images/logo.gif" border="0">';
    var div =  document.getElementById('html');
    div.innerHTML = testHtml + controlHtml;
    goog.dom.Range.createFromNodeContents(div).select();
    FORMATTER.removeFormatting_();

    expectedFailures.expectFailureFor(goog.userAgent.WEBKIT,
        'WebKit removes the image entirely, see ' +
        'https://bugs.webkit.org/show_bug.cgi?id=13125 .');

    expectedFailures.run(function() {
      assertHTMLEquals(
          'Image\'s border=0 should not be removed during remove formatting' +
          ' even if not wrapped by a link',
          testHtml + controlCleanHtml, div.innerHTML);
      FIELDMOCK.$verify();
    });
  }

  /**
   * @bug 3075557
   */
  function testRemoveFormattingLinkedImageDeep() {
    var testHtml = '<a href="http://www.google.com/"><b>hello' +
        '<img src="http://www.google.com/images/logo.gif" border="0">' +
        'world</b></a>';
    var div =  document.getElementById('html');
    div.innerHTML = testHtml + controlHtml;
    goog.dom.Range.createFromNodeContents(div).select();
    FORMATTER.removeFormatting_();

    expectedFailures.expectFailureFor(goog.userAgent.WEBKIT,
        'WebKit removes the image entirely, see ' +
        'https://bugs.webkit.org/show_bug.cgi?id=13125 .');

    expectedFailures.run(function() {
      assertHTMLEquals(
          'Image\'s border=0 should not be removed during remove formatting' +
          ' even if deep inside anchor tag',
          testHtml.replace(/<\/?b>/g, '') + controlCleanHtml, div.innerHTML);
      FIELDMOCK.$verify();
    });
  }

  function testFullTableRemoveFormatting() {
    // Something goes horrible wrong in case 1 below.  It was crashing all
    // WebKit browsers, and now seems to be giving errors as it is trying
    // to perform remove formatting on the little expected failures window
    // instead of the dom we select.  WTF.  Since I'm gutting this code,
    // I'm not going to look into this anymore right now.  For what its worth,
    // I can't repro any issues in standalone TrogEdit.
    if (goog.userAgent.WEBKIT) {
      return;
    }

    var div = document.getElementById('html');
 
    // WebKit has an extra BR in case 2.
    expectedFailures.expectFailureFor(goog.userAgent.IE,
        'IE clobbers the editable node in case 2 (can\'t repro with real ' +
        'user selections). IE doesn\'t remove the table in case 1.');

    expectedFailures.run(function() {

      // When a full table is selected, we remove it completely.
      div.innerHTML = "foo<table><tr><td>bar</td></tr></table>baz1";
      goog.dom.Range.createFromNodeContents(div.childNodes[1]).select();
      FORMATTER.removeFormatting_();
      assertHTMLEquals("foo<br>bar<br>baz1", div.innerHTML);
      FIELDMOCK.$verify();

      // Remove the full table when it is selected with additional
      // contents too.
      div.innerHTML = "foo<table><tr><td>bar</td></tr></table>baz2";
      goog.dom.Range.createFromNodes(div.firstChild, 0,
          div.lastChild, 1).select();
      FORMATTER.removeFormatting_();
      assertHTMLEquals("foo<br>bar<br>baz2", div.innerHTML);
      FIELDMOCK.$verify();

      // We should still remove the table, even if the selection is inside the
      // table and it is fully selected.
      div.innerHTML = "foo<table><tr><td id='td'>bar</td></tr></table>baz3";
      goog.dom.Range.createFromNodeContents(
          goog.dom.getElement('td').firstChild).select();
      FORMATTER.removeFormatting_();
      assertHTMLEquals("foo<br>bar<br>baz3", div.innerHTML);
      FIELDMOCK.$verify();
    });
  }

  function testInsideTableRemoveFormatting() {
    var div = document.getElementById('html');
    div.innerHTML =
    "<table><tr><td><b id='b'>foo</b></td></tr><tr><td>ba</td></tr></table>";

    goog.dom.Range.createFromNodeContents(goog.dom.getElement('b')).select();

    // Webkit adds some apple style span crap during execCommand("removeFormat")
    // Our workaround for the nbsp bug removes these, but causes worse problems.
    // See bugs.webkit.org/show_bug.cgi?id=29164 for more details.
    expectedFailures.expectFailureFor(
         goog.userAgent.WEBKIT &&
         !goog.editor.BrowserFeature.ADDS_NBSPS_IN_REMOVE_FORMAT,
         'Extra apple-style-spans');

    expectedFailures.run(function() {
      FORMATTER.removeFormatting_();

      // Only remove styling from inside tables.
      assertHTMLEquals(
          "<table><tr><td>foo</td></tr><tr><td>ba</td></tr></table>",
          div.innerHTML);
      FIELDMOCK.$verify();
    });

  }

  function testPartialTableRemoveFormatting() {
    if (goog.userAgent.IE) {
      // IE returns an "unspecified error" which seems to be beyond
      // ExpectedFailures' ability to catch.
      return;
    }

    var div = document.getElementById('html');
    div.innerHTML = "bar<table><tr><td><b id='b'>foo</b></td></tr>" +
                    "<tr><td><i>banana</i></td></tr></table><div id='baz'>" +
                    "baz</div>";

    // Select from the "oo" inside the b tag to the end of "baz".
    goog.dom.Range.createFromNodes(goog.dom.getElement('b').firstChild, 1,
        goog.dom.getElement('baz').firstChild, 3).select();

    // All browsers currently clobber the table cells that are selected.
    expectedFailures.expectFailureFor(goog.userAgent.WEBKIT);

    expectedFailures.run(function() {
      FORMATTER.removeFormatting_();
      // Only remove styling from inside tables.
      assertHTMLEquals("bar<table><tr><td><b id='b'>f</b>oo</td></tr>" +
                       "<tr><td>banana</td></tr></table>baz", div.innerHTML);
      FIELDMOCK.$verify();
    });
  }

  // Runs tests knowing some browsers will fail, because the new
  // table functionality hasn't been implemented in them yet.
  function runExpectingFailuresForUnimplementedBrowsers(func) {
    if (goog.userAgent.IE) {
      // IE returns an "unspecified error" which seems to be beyond
      // ExpectedFailures' ability to catch.
      return;
    }

    expectedFailures.expectFailureFor(goog.userAgent.IE,
        'Proper behavior not yet implemented for IE.');
    expectedFailures.expectFailureFor(goog.userAgent.WEBKIT,
        'Proper behavior not yet implemented for WebKit.');

    expectedFailures.run(func);
  }


  function testTwoTablesSelectedFullyRemoveFormatting() {
    runExpectingFailuresForUnimplementedBrowsers(function() {
      var div = document.getElementById('html');
      // When two tables are fully selected, we remove them completely.
      div.innerHTML = '<table><tr><td>foo</td></tr></table>' +
                      '<table><tr><td>bar</td></tr></table>';
      goog.dom.Range.createFromNodes(div.firstChild, 0,
          div.lastChild, 1).select();
      FORMATTER.removeFormatting_();
      assertHTMLEquals('<br>foo<br><br>bar<br>', div.innerHTML);
      FIELDMOCK.$verify();
    });
  }

  function testTwoTablesSelectedFullyInsideRemoveFormatting() {
    if (goog.userAgent.WEBKIT) {
      // Something goes very wrong here, but it did before
      // Julie started writing v2.  Will address when converting
      // safari to v2.
      return;
    }

    runExpectingFailuresForUnimplementedBrowsers(function() {
      var div = document.getElementById('html');
      // When two tables are selected from inside but fully,
      // also remove them completely.
      div.innerHTML = '<table><tr><td id="td1">foo</td></tr></table>' +
                      '<table><tr><td id="td2">bar</td></tr></table>';
      goog.dom.Range.createFromNodes(goog.dom.getElement("td1").firstChild, 0,
          goog.dom.getElement("td2").firstChild, 3).select();
      FORMATTER.removeFormatting_();
      assertHTMLEquals('<br>foo<br><br>bar<br>', div.innerHTML);
      FIELDMOCK.$verify();
    });
  }

  function testTwoTablesSelectedFullyAndPartiallyRemoveFormatting() {
    runExpectingFailuresForUnimplementedBrowsers(function() {
      var div = document.getElementById('html');
      // Two tables selected, one fully, one partially. Remove
      // only the fully selected one and remove styles only from
      // partially selected one.
      div.innerHTML = '<table><tr><td id="td1">foo</td></tr></table>' +
                      '<table><tr><td id="td2"><b>bar<b></td></tr></table>';
      goog.dom.Range.createFromNodes(goog.dom.getElement("td1").firstChild, 0,
          goog.dom.getElement("td2").firstChild.firstChild, 2).select();
      FORMATTER.removeFormatting_();
      assertHTMLEquals('<br>foo<br>' +
                       '<table><tr><td id="td2">ba<b>r</b></td></tr></table>',
          div.innerHTML);
      FIELDMOCK.$verify();
    });
  }

  function testTwoTablesSelectedPartiallyRemoveFormatting() {
    runExpectingFailuresForUnimplementedBrowsers(function() {
      var div = document.getElementById('html');
      // Two tables selected, both partially.  Don't remove tables,
      // but remove styles.
      div.innerHTML = '<table><tr><td id="td1">f<i>o</i>o</td></tr></table>' +
                      '<table><tr><td id="td2">b<b>a</b>r</td></tr></table>';
      goog.dom.Range.createFromNodes(goog.dom.getElement("td1").firstChild, 1,
          goog.dom.getElement("td2").childNodes[1], 1).select();
      FORMATTER.removeFormatting_();
      assertHTMLEquals('<table><tr><td id="td1">foo</td></tr></table>' +
                       '<table><tr><td id="td2">bar</td></tr></table>',
                       div.innerHTML);
      FIELDMOCK.$verify();
    });
  }


 /**
  * Test a random snippet from Google News (Google News has complicated
  * dom structure, including tables, links, images, etc).
  */
function testRandomGoogleNewsSnippetRemoveFormatting() {
  if (goog.userAgent.IE) {
    // IE returns an "unspecified error" which seems to be beyond
    // ExpectedFailures' ability to catch.
    return;
  }

  var div = document.getElementById('html');
  div.innerHTML =
      '<font size="-3"><br></font><table align="right" border="0" ' +
      'cellpadding="0" cellspacing="0"><tbody><tr><td style="padding-left:' +
      '6px;" valign="top" width="80" align="center"><a href="http://www.wash' +
      'ingtonpost.com/wp-dyn/content/article/2008/11/11/AR2008111101090.htm' +
      'l" + id="s-skHRvWH7ryqkcA4caGv0QQ:u-AFQjCNG3vx1HJOxKxMQPzCvYOVRE0JUDe' +
      'Q:r-1-0i_1268233361_6_H0_MH20_PL60"><img src="http://news.google.com/' +
      'news?imgefp=4LFiNNP62TgJ&amp;imgurl=media3.washingtonpost.com/wp-dyn/' +
      'content/photo/2008/11/11/PH2008111101091.jpg" alt="" width="60" ' +
      'border="1" height="80"><br><font size="-2">Washington Post</font></a>' +
      '</td></tr></tbody></table><a href="http://www.nme.com/news/britney-' +
      'spears/40995" id="s-xZUO-t0c1IpsVjyJj0rgxw:u-AFQjCNEZAMQCseEW6uTgXI' +
      'iPvAMHe_0B4A:r-1-0_1268233361_6_H0_MH20_PL60"><b>Britney\'s son ' +
      'released from hospital</b></a><br><font size="-1"><b><font color=' +
      '"#6f6f6f">NME.com&nbsp;-</font> <nobr>53 minutes ago</nobr></b>' +
      '</font><br><font size="-1">Britney Spears� youngest son Jayden James ' +
      'has been released from hospital, having been admitted on Sunday after' +
      ' suffering a severe reaction to something he ingested.</font><br><fon' +
      'tsize="-1"><a href="http://www.celebrity-gossip.net/celebrities/holly' +
      'wood/britney-and-jamie-lynn-spears-alligator-alley-208944/" id="s-nM' +
      'PzHclcMG0J2WZkw9gnVQ:u-AFQjCNHal08usOQ5e5CAQsck2yGsTYeGVQ">Britney ' +
      'and Jamie Lynn Spears: Alligator Alley!</a> <font size="-1" color=' +
      '"#6f6f6f"><nobr>The Gossip Girls</nobr></font></font><br><font size=' +
      '"-1"><a href="http://foodconsumer.org/7777/8888/Other_N_ews_51/111101' +
      '362008_Allergy_incident_could_spell_custody_trouble_for_Britney_Spear' +
      's.shtml" id="s-2lMNDY4joOprVvkkY_b-6A:u-AFQjCNGAeFNutMEbSg5zAvrh5reBF' +
      'lqUmA">Allergy incident could spell trouble for Britney Spears</a> ' +
      '<font size="-1" color="#6f6f6f"><nobr>Food Consumer</nobr></font>' +
      '</font><br><font class="p" size="-1"><a href="http://www.people.com/' +
      'people/article/0,,20239458,00.html" id="s-x9thwVUYVET0ZJOnkkcsjw:u-A' +
      'FQjCNE99eijVIrezr9AFRjLkmo5j_Jr7A"><nobr>People Magazine</nobr></a>&nb' +
      'sp;- <a href="http://www.eonline.com/uberblog/b68226_hospital_run_cou' +
      'ld_cost_britney_custody.html" id="s-kYt5LHDhlDnhUL9kRLuuwA:u-AFQjCNF8' +
      '8eOy2utriYuF0icNrZQPzwK8gg"><nobr>E! Online</nobr></a>&nbsp;- <a href' +
      '="http://justjared.buzznet.com/2008/11/11/britney-spears-alligator-fa' +
      'rm/" id="s--VDy1fyacNvaRo_aXb02Dw:u-AFQjCNEn0Rz3wg0PMwDdzKTDug-9k5W6y' +
      'g"><nobr>Just Jared</nobr></a>&nbsp;- <a href="http://www.efluxmedia.' +
      'com/news_Britney_Spears_Son_Released_from_Hospital_28696.html" id="s-' +
      '8oX6hVDe4Qbcl1x5Rua_EA:u-AFQjCNEpn3nOHA8EB0pxJAPf6diOicMRDg"><nobr>eF' +
      'luxMedia</nobr></a></font><br><font class="p" size="-1"><a class="p" ' +
      'href="http://news.google.com/news?ncl=1268233361&amp;hl=en"><nobr><b>' +
      'all 950 news articles&nbsp;�</b></nobr></a></font>';
  // Select it all.
  goog.dom.Range.createFromNodeContents(div).select();

  expectedFailures.expectFailureFor(goog.userAgent.WEBKIT,
      'WebKit barfs apple-style-spans all over the place, and removes links.');

  expectedFailures.run(function() {
    FORMATTER.removeFormatting_();
    // Leave links and images alone, remove all other formatting.
    assertHTMLEquals('<br><br><a href="http://www.washingtonpost.com/wp-dyn/' +
        'content/article/2008/11/11/AR2008111101090.html"><img src="http://n' +
        'ews.google.com/news?imgefp=4LFiNNP62TgJ&amp;imgurl=media3.washingto' +
        'npost.com/wp-dyn/content/photo/2008/11/11/PH2008111101091.jpg"><br>' +
        'Washington Post</a><br><a href="http://www.nme.com/news/britney-spe' +
        'ars/40995">Britney\'s son released from hospital</a><br>NME.com - 5' +
        '3 minutes ago<br>Britney Spears� youngest son Jayden James has been' +
        ' released from hospital, having been admitted on Sunday after suffe' +
        'ring a severe reaction to something he ingested.<br><a href="http:/' +
        '/www.celebrity-gossip.net/celebrities/hollywood/britney-and-jamie-l' +
        'ynn-spears-alligator-alley-208944/">Britney and Jamie Lynn Spears: ' +
        'Alligator Alley!</a> The Gossip Girls<br><a href="http://foodconsum' +
        'er.org/7777/8888/Other_N_ews_51/111101362008_Allergy_incident_could' +
        '_spell_custody_trouble_for_Britney_Spears.shtml">Allergy incident c' +
        'ould spell trouble for Britney Spears</a> Food Consumer<br><a href=' +
        '"http://www.people.com/people/article/0,,20239458,00.html">People M' +
        'agazine</a> - <a href="http://www.eonline.com/uberblog/b68226_hospi' +
        'tal_run_could_cost_britney_custody.html">E! Online</a> - <a href="h' +
        'ttp://justjared.buzznet.com/2008/11/11/britney-spears-alligator-far' +
        'm/">Just Jared</a> - <a href="http://www.efluxmedia.com/news_Britne' +
        'y_Spears_Son_Released_from_Hospital_28696.html">eFluxMedia</a><br><' +
        'a href="http://news.google.com/news?ncl=1268233361&amp;hl=en">all 9' +
        '50 news articles �</a>', div.innerHTML);
    FIELDMOCK.$verify();
  });
}

function testRangeDelimitedByRanges() {
  var abcde = goog.dom.getElement('abcde').firstChild;
  var start = goog.dom.Range.createFromNodes(abcde, 1, abcde, 2);
  var end = goog.dom.Range.createFromNodes(abcde, 3, abcde, 4);
  
  goog.testing.dom.assertRangeEquals(abcde, 1, abcde, 4,
      goog.editor.plugins.RemoveFormatting.createRangeDelimitedByRanges_(
          start, end));
}

function testGetTableAncestor() {
  var div = document.getElementById('html');

  div.innerHTML = "foo<table><tr><td>foo</td></tr></table>bar";
  assertTrue('Full table is in table',
      !!goog.editor.plugins.RemoveFormatting.getTableAncestor_(
          div.childNodes[1]));

  assertFalse('Outside of table',
      !!goog.editor.plugins.RemoveFormatting.getTableAncestor_(div.firstChild));

  assertTrue('Table cell is in table',
      !!goog.editor.plugins.RemoveFormatting.getTableAncestor_(
          div.childNodes[1].firstChild.firstChild.firstChild));

}

/**
 * @bug 1272905
 */
function testHardReturnsInHeadersPreserved() {
  var div =  document.getElementById('html');
  div.innerHTML = '<h1>abcd</h1><h2>efgh</h2><h3>ijkl</h3>';

  // Select efgh.
  goog.dom.Range.createFromNodeContents(div.childNodes[1]).select();
  FORMATTER.removeFormatting_();

  expectedFailures.expectFailureFor(goog.userAgent.IE,
      'Proper behavior not yet implemented for IE.');
  expectedFailures.expectFailureFor(goog.userAgent.WEBKIT,
      'Proper behavior not yet implemented for WebKit.');
  expectedFailures.run(function() {
    assertHTMLEquals("<h1>abcd</h1><br>efgh<h3>ijkl</h3>", div.innerHTML);
  });

  // Select ijkl.
  goog.dom.Range.createFromNodeContents(div.lastChild).select();
  FORMATTER.removeFormatting_();

  expectedFailures.expectFailureFor(goog.userAgent.IE,
      'Proper behavior not yet implemented for IE.');
  expectedFailures.expectFailureFor(goog.userAgent.WEBKIT,
      'Proper behavior not yet implemented for WebKit.');
  expectedFailures.run(function() {
    assertHTMLEquals("<h1>abcd</h1><br>efgh<br>ijkl", div.innerHTML);
  });

  // Select abcd.
  goog.dom.Range.createFromNodeContents(div.firstChild).select();
  FORMATTER.removeFormatting_();

  expectedFailures.expectFailureFor(goog.userAgent.IE,
      'Proper behavior not yet implemented for IE.');
  expectedFailures.expectFailureFor(goog.userAgent.WEBKIT,
      'Proper behavior not yet implemented for WebKit.');
  expectedFailures.run(function() {
    assertHTMLEquals("<br>abcd<br>efgh<br>ijkl", div.innerHTML);
  });
}

function testKeyboardShortcut_space() {
  FIELDMOCK.$reset();

  FIELDMOCK.execCommand(
        goog.editor.plugins.RemoveFormatting.REMOVE_FORMATTING_COMMAND);

  FIELDMOCK.$replay();

  var e = {};
  var key = ' ';
  var result = FORMATTER.handleKeyboardShortcut(e, key, true);
  assertTrue(result);

  FIELDMOCK.$verify();
}

function testKeyboardShortcut_other() {
  FIELDMOCK.$reset();
  FIELDMOCK.$replay();

  var e = {};
  var key = 'a';
  var result = FORMATTER.handleKeyboardShortcut(e, key, true);
  assertFalse(result);

  FIELDMOCK.$verify();
}

">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:28:26
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>spacestabhandler_test.html</td><td>Fail</td><td> 0 passed, 5 failed.</td><td title="


  goog.require('goog.dom');
  goog.require('goog.dom.Range');
  goog.require('goog.editor.BrowserFeature');
  goog.require('goog.editor.plugins.SpacesTabHandler');
  goog.require('goog.events.BrowserEvent');
  goog.require('goog.events.KeyCodes');
  goog.require('goog.functions');
  goog.require('goog.testing.StrictMock');
  goog.require('goog.testing.editor.FieldMock');
  goog.require('goog.testing.editor.TestHelper');
  goog.require('goog.testing.jsunit');



var field = goog.dom.getElement('field');
var editableField;
var tabHandler;
var testHelper;

function setUp() {
  editableField = new goog.testing.editor.FieldMock();
  // Modal mode behavior tested in AbstractTabHandler.
  editableField.inModalMode = goog.functions.FALSE;
  testHelper = new goog.testing.editor.TestHelper(field);
  testHelper.setUpEditableElement();

  tabHandler = new goog.editor.plugins.SpacesTabHandler();
  tabHandler.registerFieldObject(editableField);
}

function tearDown() {
  editableField = null;
  testHelper.tearDownEditableElement();
  tabHandler.dispose();
}

function testSelectedTextIndent() {
  field.innerHTML = 'Test';

  var testText = field.firstChild;
  testHelper.select(testText, 0, testText, 4);

  var event = new goog.testing.StrictMock(goog.events.BrowserEvent);
  event.keyCode = goog.events.KeyCodes.TAB;
  event.shiftKey = false;

  editableField.stopChangeEvents(true, true);
  editableField.dispatchChange();
  editableField.dispatchSelectionChangeEvent();
  event.preventDefault();

  editableField.$replay();
  event.$replay();

  assertTrue('Event marked as handled',
      tabHandler.handleKeyboardShortcut(event, '', false));
  var contents = field.textContent || field.innerText;
  // Chrome doesn't treat \u00a0 as a space.
  assertTrue('Text should be replaced with 4 spaces but was: "' + 
      contents + '"',
      /^(\s|\u00a0){4}$/.test(contents));

  editableField.$verify();
  event.$verify();
}

function testCursorIndent() {
  field.innerHTML = 'Test';

  var testText = field.firstChild;
  testHelper.select(testText, 2, testText, 2);

  var event = new goog.testing.StrictMock(goog.events.BrowserEvent);
  event.keyCode = goog.events.KeyCodes.TAB;
  event.shiftKey = false;

  editableField.stopChangeEvents(true, true);
  editableField.dispatchChange();
  editableField.dispatchSelectionChangeEvent();
  event.preventDefault();

  editableField.$replay();
  event.$replay();

  assertTrue('Event marked as handled',
      tabHandler.handleKeyboardShortcut(event, '', false));
  var contents = field.textContent || field.innerText;
  assertTrue('Expected contents "Te    st" but was: "' + contents + '"',
      /Te[\s|\u00a0]{4}st/.test(contents));

  editableField.$verify();
  event.$verify();
}

function testShiftTabNoOp() {
  field.innerHTML = 'Test';

  range = goog.dom.Range.createFromNodeContents(field);
  range.collapse();
  range.select();

  var event = new goog.testing.StrictMock(goog.events.BrowserEvent);
  event.keyCode = goog.events.KeyCodes.TAB;
  event.shiftKey = true;

  event.preventDefault();
  editableField.$replay();
  event.$replay();

  assertTrue('Event marked as handled',
      tabHandler.handleKeyboardShortcut(event, '', false));
  var contents = field.textContent || field.innerText;
  assertEquals('Shift+tab should not change contents', 'Test', contents);

  editableField.$verify();
  event.$verify();
}

function testInListNoOp() {
  field.innerHTML = '<ul><li>Test</li></ul>';

  var testText = field.firstChild.firstChild.firstChild; // div ul li Test
  testHelper.select(testText, 2, testText, 2);

  var event = new goog.testing.StrictMock(goog.events.BrowserEvent);
  event.keyCode = goog.events.KeyCodes.TAB;
  event.shiftKey = false;

  editableField.$replay();
  event.$replay();

  assertFalse('Event must not be handled when selection inside list.',
      tabHandler.handleKeyboardShortcut(event, '', false));
  testHelper.assertHtmlMatches('<ul><li>Test</li></ul>')

  editableField.$verify();
  event.$verify();
}

function testContainsListNoOp() {
  field.innerHTML = '<ul><li>Test</li></ul>';

  var testText = field.firstChild.firstChild.firstChild; // div ul li Test
  testHelper.select(field.firstChild, 0, testText, 2);

  var event = new goog.testing.StrictMock(goog.events.BrowserEvent);
  event.keyCode = goog.events.KeyCodes.TAB;
  event.shiftKey = false;

  editableField.$replay();
  event.$replay();

  assertFalse('Event must not be handled when selection inside list.',
      tabHandler.handleKeyboardShortcut(event, '', false));
  testHelper.assertHtmlMatches('<ul><li>Test</li></ul>')

  editableField.$verify();
  event.$verify();
}

">5 of 5 tests run in 25ms.<br />0 passed, 5 failed.<br />5 ms/test. 1 files loaded.<br />ERROR in testContainsListNoOp<br />Cannot set property 'designMode' of undefined<br />ERROR in testCursorIndent<br />Cannot set property 'designMode' of undefined<br />ERROR in testInListNoOp<br />Cannot set property 'designMode' of undefined<br />ERROR in testSelectedTextIndent<br />Cannot set property 'designMode' of undefined<br />ERROR in testShiftTabNoOp<br />Cannot set property 'designMode' of undefined<br /></td></tr>
<tr><td>emoticons_test.html</td><td>Fail</td><td> 0 passed, 1 failed.</td><td title="

    goog.require('goog.Uri');
    goog.require('goog.editor.Field');
    goog.require('goog.editor.plugins.Emoticons');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.emoji.Emoji');
  


var HTML;

function setUp() {
  HTML = goog.dom.$('parent').innerHTML;
}

function tearDown() {
  goog.dom.$('parent').innerHTML = HTML;
}

function testEmojiWithEmoticonsPlugin() {
  runEmojiTestWithPlugin(new goog.editor.plugins.Emoticons());
}

function runEmojiTestWithPlugin(plugin) {
  var field = new goog.editor.Field('testField');
  field.registerPlugin(plugin);
  field.makeEditable();
  field.focusAndPlaceCursorAtStart();

  var src = 'testdata/emoji/4F4.gif';
  var id = '4F4';
  var emoji = new goog.ui.emoji.Emoji(src, id);
  field.execCommand(goog.editor.plugins.Emoticons.COMMAND, emoji);

  // The url may be relative or absolute.
  var imgs = field.getEditableDomHelper().
      getElementsByTagNameAndClass(goog.dom.TagName.IMG);
  assertEquals(1, imgs.length);

  var img = imgs[0];
  assertUriEquals(src, img.getAttribute('src'));
  assertEquals(id, img.getAttribute(goog.ui.emoji.Emoji.ATTRIBUTE));
}

function assertUriEquals(expected, actual) {
  var winUri = new goog.Uri(window.location);
  assertEquals(winUri.resolve(new goog.Uri(expected)).toString(),
      winUri.resolve(new goog.Uri(actual)).toString());
}

">1 of 1 tests run in 9ms.<br />0 passed, 1 failed.<br />9 ms/test. 1 files loaded.<br />ERROR in testEmojiWithEmoticonsPlugin<br />Cannot read property 'cssText' of undefined<br /></td></tr>
<tr><td>basictextformatter_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.array');
  goog.require('goog.dom');
  goog.require('goog.dom.Range');
  goog.require('goog.editor.plugins.BasicTextFormatter');
  goog.require('goog.object');
  goog.require('goog.testing.ExpectedFailures');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.testing.editor.FieldMock');
  goog.require('goog.testing.editor.TestHelper');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');


  var stubs = new goog.testing.PropertyReplacer();

  var SAVED_HTML = goog.dom.getElement('html').innerHTML;
  var FIELDMOCK;
  var FORMATTER;
  var ROOT = goog.dom.getElement('root');
  var HELPER;
  var OPEN_SUB = goog.userAgent.WEBKIT && !goog.userAgent.isVersion('530') ?
      '<span class="Apple-style-span" style="vertical-align: sub;">' :
      '<sub>';
  var CLOSE_SUB = goog.userAgent.WEBKIT && !goog.userAgent.isVersion('530') ?
                  '</span>' : '</sub>';
  var OPEN_SUPER = goog.userAgent.WEBKIT && !goog.userAgent.isVersion('530') ?
      '<span class="Apple-style-span" style="vertical-align: super;">' :
      '<sup>';
  var CLOSE_SUPER = goog.userAgent.WEBKIT && !goog.userAgent.isVersion('530') ?
                    '</span>' : '</sup>';
  var MOCK_BLOCKQUOTE_STYLE = 'border-left: 1px solid gray;';
  var MOCK_GET_BLOCKQUOTE_STYLES = function() {
    return MOCK_BLOCKQUOTE_STYLE;
  };

  var REAL_FIELD;
  var REAL_PLUGIN;

  var expectedFailures = new goog.testing.ExpectedFailures();

  function setUp() {
    FIELDMOCK = new goog.testing.editor.FieldMock();

    FORMATTER = new goog.editor.plugins.BasicTextFormatter();
    FORMATTER.fieldObject = FIELDMOCK;
  }

  function setUpRealField() {
    REAL_FIELD = new goog.editor.Field('real-field');
    REAL_PLUGIN = new goog.editor.plugins.BasicTextFormatter();
    REAL_FIELD.registerPlugin(REAL_PLUGIN);
    REAL_FIELD.makeEditable();
  }

  function setUpRealFieldIframe() {
    REAL_FIELD = new goog.editor.Field('iframe');
    FORMATTER = new goog.editor.plugins.BasicTextFormatter();
    REAL_FIELD.registerPlugin(FORMATTER);
    REAL_FIELD.makeEditable();
  }

  function selectRealField() {
    goog.dom.Range.createFromNodeContents(REAL_FIELD.getElement()).select();
    REAL_FIELD.dispatchSelectionChangeEvent();
  }

  function tearDown() {
    tearDownFontSizeTests();

    if (REAL_FIELD) {
      REAL_FIELD.makeUneditable();
      REAL_FIELD.dispose();
      REAL_FIELD = null;
    }

    expectedFailures.handleTearDown();
    stubs.reset();

    goog.dom.getElement('html').innerHTML = SAVED_HTML;
  }

  function setUpListAndBlockquoteTests() {
    var htmlDiv = document.getElementById('html');
    HELPER = new goog.testing.editor.TestHelper(htmlDiv);
    HELPER.setUpEditableElement();

    FIELDMOCK.getElement();
    FIELDMOCK.$anyTimes();
    FIELDMOCK.$returns(htmlDiv);
  }

  function tearDownHelper() {
    HELPER.tearDownEditableElement();
    HELPER.dispose();
    HELPER = null;
  }

  function tearDownListAndBlockquoteTests() {
    tearDownHelper();
  }

  function testIEList() {
    if (goog.userAgent.IE) {
      setUpListAndBlockquoteTests();

      FIELDMOCK.queryCommandValue('rtl').$returns(null);

      FIELDMOCK.$replay();
      var ul = goog.dom.getElement('outerUL');
      goog.dom.Range.createFromNodeContents(ul.firstChild.firstChild).select();
      FORMATTER.fixIELists_();
      assertFalse('Unordered list must not have ordered type', ul.type == '1');
      var ol = goog.dom.getElement('ol');
      ol.type = 'disc';
      goog.dom.Range.createFromNodeContents(ol.firstChild.firstChild).select();
      FORMATTER.fixIELists_();
      assertFalse('Ordered list must not have unordered type',
          ol.type == 'disc');
      ol.type = '1';
      goog.dom.Range.createFromNodeContents(ol.firstChild.firstChild).select();
      FORMATTER.fixIELists_();
      assertTrue('Ordered list must retain ordered list type',
          ol.type == '1');
      tearDownListAndBlockquoteTests();
    }
  }

  function testWebKitList() {
    if (goog.userAgent.WEBKIT) {
      setUpListAndBlockquoteTests();

      FIELDMOCK.queryCommandValue('rtl').$returns(null);

      FIELDMOCK.$replay();
      var ul = document.getElementById('outerUL');
      var html = ul.innerHTML;
      goog.dom.Range.createFromNodeContents(ul).select();

      FORMATTER.fixSafariLists_();
      assertEquals('Contents of UL shouldn\'t change',
              html, ul.innerHTML);

      ul = document.getElementById('outerUL2');
      goog.dom.Range.createFromNodeContents(ul).select();

      FORMATTER.fixSafariLists_();
      var childULs = ul.getElementsByTagName('ul');
      assertEquals('UL should have one child UL',
              1, childULs.length);
      tearDownListAndBlockquoteTests();
    }
  }

  function testGeckoListFont() {
    if (goog.userAgent.GECKO) {
      setUpListAndBlockquoteTests();
      FIELDMOCK.queryCommandValue(
          goog.editor.Command.DEFAULT_TAG).$returns('BR').$times(2);

      FIELDMOCK.$replay();
      var p = goog.dom.getElement('geckolist');
      var font = p.firstChild;
      goog.dom.Range.createFromNodeContents(font).select();
      retVal = FORMATTER.beforeInsertListGecko_();
      assertFalse('Workaround shouldn\'t be applied when not needed', retVal);

      font.innerHTML = '';
      goog.dom.Range.createFromNodeContents(font).select();
      var retVal = FORMATTER.beforeInsertListGecko_();
      assertTrue('Workaround should be applied when needed', retVal);
      document.execCommand('insertorderedlist', false, true);
      assertTrue('Font should be Courier',
              /courier/i.test(document.queryCommandValue('fontname')));
      tearDownListAndBlockquoteTests();
    }
  }

  function setUpSubSuperTests() {
    ROOT.innerHTML = '12345';
    HELPER = new goog.testing.editor.TestHelper(ROOT);
    HELPER.setUpEditableElement();
  }

  function tearDownSubSuperTests() {
    tearDownHelper();
  }

  function testSubscriptRemovesSuperscript() {
    setUpSubSuperTests();
    FIELDMOCK.$replay();

    HELPER.select('12345', 1, '12345', 4); // Selects '234'.
    FORMATTER.execCommandInternal(
        goog.editor.plugins.BasicTextFormatter.COMMAND.SUPERSCRIPT);
    HELPER.assertHtmlMatches('1'+OPEN_SUPER+'234'+CLOSE_SUPER+'5');
    FORMATTER.execCommandInternal(
        goog.editor.plugins.BasicTextFormatter.COMMAND.SUBSCRIPT);
    HELPER.assertHtmlMatches('1'+OPEN_SUB+'234'+CLOSE_SUB+'5');

    FIELDMOCK.$verify();
    tearDownSubSuperTests();
  }

  function testSuperscriptRemovesSubscript() {
    setUpSubSuperTests();
    FIELDMOCK.$replay();

    HELPER.select('12345', 1, '12345', 4); // Selects '234'.
    FORMATTER.execCommandInternal(
        goog.editor.plugins.BasicTextFormatter.COMMAND.SUBSCRIPT);
    HELPER.assertHtmlMatches('1'+OPEN_SUB+'234'+CLOSE_SUB+'5');
    FORMATTER.execCommandInternal(
        goog.editor.plugins.BasicTextFormatter.COMMAND.SUPERSCRIPT);
    HELPER.assertHtmlMatches('1'+OPEN_SUPER+'234'+CLOSE_SUPER+'5');

    FIELDMOCK.$verify();
    tearDownSubSuperTests();
  }

  function testSubscriptRemovesSuperscriptIntersecting() {
    // Tests: 12345 , sup(23) , sub(34) ==> 1+sup(2)+sub(34)+5
    // This is more complex because the sub and sup calls are made on separate
    // fields which intersect each other and queryCommandValue seems to return
    // false if the command is only applied to part of the field.
    setUpSubSuperTests();
    FIELDMOCK.$replay();

    HELPER.select('12345', 1, '12345', 3); // Selects '23'.
    FORMATTER.execCommandInternal(
        goog.editor.plugins.BasicTextFormatter.COMMAND.SUPERSCRIPT);
    HELPER.assertHtmlMatches('1'+OPEN_SUPER+'23'+CLOSE_SUPER+'45');
    HELPER.select('23', 1, '45', 1); // Selects '34'.
    FORMATTER.execCommandInternal(
        goog.editor.plugins.BasicTextFormatter.COMMAND.SUBSCRIPT);
    HELPER.assertHtmlMatches('1'+OPEN_SUPER+'2'+CLOSE_SUPER
                             +OPEN_SUB+'34'+CLOSE_SUB+'5');

    FIELDMOCK.$verify();
    tearDownSubSuperTests();
  }

  function testSuperscriptRemovesSubscriptIntersecting() {
    // Tests: 12345 , sub(23) , sup(34) ==> 1+sub(2)+sup(34)+5
    setUpSubSuperTests();
    FIELDMOCK.$replay();

    HELPER.select('12345', 1, '12345', 3); // Selects '23'.
    FORMATTER.execCommandInternal(
        goog.editor.plugins.BasicTextFormatter.COMMAND.SUBSCRIPT);
    HELPER.assertHtmlMatches('1'+OPEN_SUB+'23'+CLOSE_SUB+'45');
    HELPER.select('23', 1, '45', 1); // Selects '34'.
    FORMATTER.execCommandInternal(
        goog.editor.plugins.BasicTextFormatter.COMMAND.SUPERSCRIPT);
    HELPER.assertHtmlMatches('1'+OPEN_SUB+'2'+CLOSE_SUB
                             +OPEN_SUPER+'34'+CLOSE_SUPER+'5');

    FIELDMOCK.$verify();
    tearDownSubSuperTests();
  }

  function setUpLinkTests(url) {
    stubs.set(window, 'prompt', function() {
      return url;
    });

    ROOT.innerHTML = '12345';
    HELPER = new goog.testing.editor.TestHelper(ROOT);
    HELPER.setUpEditableElement();

    FIELDMOCK.getElement().$anyTimes().$returns(ROOT);

    FIELDMOCK.execCommand(goog.editor.Command.MODAL_LINK_EDITOR,
        goog.testing.mockmatchers.isObject).$returns(undefined);
    FIELDMOCK.setModalMode(true);

    FIELDMOCK.isSelectionEditable().$anyTimes().$returns(true);

    FORMATTER.focusField_ = function() {
      throw 'Field should not be re-focused';
    }
  }

  function tearDownLinkTests() {
    tearDownHelper();
  }

  function testLink() {
    setUpLinkTests('http://www.x.com/');
    FIELDMOCK.$replay();

    HELPER.select('12345', 3);
    FORMATTER.execCommandInternal(goog.editor.Command.LINK);
    HELPER.assertHtmlMatches(
        goog.editor.BrowserFeature.GETS_STUCK_IN_LINKS ?
            '123<a href="http://www.x.com/">http://www.x.com/</a>&nbsp;45' :
            '123<a href="http://www.x.com/">http://www.x.com/</a>45');

    FIELDMOCK.$verify();
    tearDownLinkTests();
  }

  function testSelectedLink() {
    setUpLinkTests('http://www.x.com/');
    FIELDMOCK.$replay();

    HELPER.select('12345', 1, '12345', 4);
    FORMATTER.execCommandInternal(goog.editor.Command.LINK);
    HELPER.assertHtmlMatches(
        goog.editor.BrowserFeature.GETS_STUCK_IN_LINKS ?
            '1<a href="http://www.x.com/">234</a>&nbsp;5' :
            '1<a href="http://www.x.com/">234</a>5');

    FIELDMOCK.$verify();
    tearDownLinkTests();
  }

  function testCanceledLink() {
    setUpLinkTests(undefined);
    FIELDMOCK.$replay();

    HELPER.select('12345', 1, '12345', 4);
    FORMATTER.execCommandInternal(goog.editor.Command.LINK);
    HELPER.assertHtmlMatches('12345');

    assertEquals('234', FIELDMOCK.getRange().getText());

    FIELDMOCK.$verify();
    tearDownLinkTests();
  }

  function setUpJustifyTests(html) {
    ROOT.innerHTML = html;
    HELPER = new goog.testing.editor.TestHelper(ROOT);
    HELPER.setUpEditableElement(ROOT);

    FIELDMOCK.getElement();
    FIELDMOCK.$anyTimes();
    FIELDMOCK.$returns(ROOT);

    FIELDMOCK.getElement();
    FIELDMOCK.$anyTimes();
    FIELDMOCK.$returns(ROOT);
  }

  function tearDownJustifyTests() {
    tearDownHelper();
  }

  function testJustify() {
    setUpJustifyTests('<div>abc</div><p>def</p><div>ghi</div>');
    FIELDMOCK.$replay();

    HELPER.select('abc', 1, 'def', 1); // Selects 'bcd'.
    FORMATTER.execCommandInternal(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_CENTER);
    HELPER.assertHtmlMatches(
        '<div style="text-align: center">abc</div>' +
        '<p style="text-align: center">def</p>' +
        '<div>ghi</div>');

    FIELDMOCK.$verify();
    tearDownJustifyTests();
  }

  function testJustifyInInline() {
    setUpJustifyTests('<div>a<i>b</i>c</div><div>d</div>');
    FIELDMOCK.$replay();

    HELPER.select('b', 0, 'b', 1); // Selects 'b'.
    FORMATTER.execCommandInternal(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_CENTER);
    HELPER.assertHtmlMatches(
        '<div style="text-align: center">a<i>b</i>c</div><div>d</div>');

    FIELDMOCK.$verify();
    tearDownJustifyTests();
  }

  function testJustifyInBlock() {
    setUpJustifyTests('<div>a<div>b</div>c</div>');
    FIELDMOCK.$replay();

    HELPER.select('b', 0, 'b', 1); // Selects 'h'.
    FORMATTER.execCommandInternal(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_CENTER);
    HELPER.assertHtmlMatches(
        '<div>a<div style="text-align: center">b</div>c</div>');

    FIELDMOCK.$verify();
    tearDownJustifyTests();
  }

  var isFontSizeTest = false;
  var defaultFontSizeMap;

  function setUpFontSizeTests() {
    isFontSizeTest = true;
    ROOT.innerHTML = '1<span style="font-size:2px">23</span>4' +
                     '<span style="font-size:5px; white-space:pre">56</span>7';
    HELPER = new goog.testing.editor.TestHelper(ROOT);
    HELPER.setUpEditableElement();
    FIELDMOCK.getElement().$returns(ROOT).$anyTimes();

    // Map representing the sizes of the text in the HTML snippet used in these
    // tests. The key is the exact text content of each text node, and the value
    // is the initial size of the font in pixels. Since tests may cause a text
    // node to be split in two, this also contains keys that initially don't
    // match any text node, but may match one later if an existing node is
    // split. The value for these keys is null, signifying no text node should
    // exist with that content.
    defaultFontSizeMap = {
      '1': 16,
      '2': null,
      '23': 2,
      '3': null,
      '4': 16,
      '5': null,
      '56': 5,
      '6': null,
      '7': 16
    };
    assertFontSizes('Assertion failed on default font sizes!', {});
  }

  function tearDownFontSizeTests() {
    if (isFontSizeTest) {
      tearDownHelper();
      isFontSizeTest = false;
    }
  }

  /**
   * Asserts that the text nodes set up by setUpFontSizeTests() have had their
   * font sizes changed as described by sizeChangesMap.
   * @param {string} msg Assertion error message.
   * @param {Object.<string, number|null>} sizeChangesMap Maps the text content
   *     of a text node to be measured to its expected font size in pixels, or
   *     null if that text node should not be present in the document (i.e.
   *     because it was split into two). Only the text nodes that have changed
   *     from their default need to be specified.
   */
  function assertFontSizes(msg, sizeChangesMap) {
    goog.object.extend(defaultFontSizeMap, sizeChangesMap);
    for (var k in defaultFontSizeMap) {
      var node = HELPER.findTextNode(k);
      var expected = defaultFontSizeMap[k];
      if (expected) {
        assertNotNull(msg + ' [couldn\'t find text node "' + k + '"]', node);
        assertEquals(msg + ' [incorrect font size for "' + k + '"]',
                     expected, goog.style.getFontSize(node.parentNode));
      } else {
        assertNull(msg + ' [unexpected text node "' + k + '"]', node);
      }
    }
  }

  /**
   * Regression test for {@bug 1286408}. Tests that when you change the font
   * size of a selection, any font size styles that were nested inside are
   * removed.
   */
  function testFontSizeOverridesStyleAttr() {
    setUpFontSizeTests();
    FIELDMOCK.$replay();

    HELPER.select('1', 0, '4', 1); // Selects 1234.
    FORMATTER.execCommandInternal(
        goog.editor.plugins.BasicTextFormatter.COMMAND.FONT_SIZE, 6);

    assertFontSizes('New font size should override existing font size',
                    {'1': 32, '23': 32, '4': 32});

    if (goog.editor.BrowserFeature.DOESNT_OVERRIDE_FONT_SIZE_IN_STYLE_ATTR) {
      var span = HELPER.findTextNode('23').parentNode;
      assertFalse('Style attribute should be gone',
          span.getAttributeNode('style') != null &&
          span.getAttributeNode('style').specified);
    }

    FIELDMOCK.$verify();
  }

  /**
   * Make sure the style stripping works when the selection starts and stops in
   * different nodes that both contain font size styles.
   */
  function testFontSizeOverridesStyleAttrMultiNode() {
    setUpFontSizeTests();
    FIELDMOCK.$replay();

    HELPER.select('23', 0, '56', 2); // Selects 23456.
    FORMATTER.execCommandInternal(
        goog.editor.plugins.BasicTextFormatter.COMMAND.FONT_SIZE, 6);
    var span = HELPER.findTextNode('23').parentNode;
    var span2 = HELPER.findTextNode('56').parentNode;

    assertFontSizes(
        'New font size should override existing font size in all spans',
        {'23': 32, '4': 32, '56': 32});
    var whiteSpace = goog.userAgent.IE ?
                     goog.style.getCascadedStyle(span2, 'whiteSpace') :
                     goog.style.getComputedStyle(span2, 'whiteSpace');
    assertEquals('Whitespace style in last span should have been left',
                 'pre', whiteSpace);

    if (goog.editor.BrowserFeature.DOESNT_OVERRIDE_FONT_SIZE_IN_STYLE_ATTR) {
      assertFalse('Style attribute should be gone from first span',
          span.getAttributeNode('style') != null &&
          span.getAttributeNode('style').specified);
      assertTrue('Style attribute should not be gone from last span',
          span2.getAttributeNode('style') != null &&
          span2.getAttributeNode('style').specified);
    }

    FIELDMOCK.$verify();
  }

  /**
   * Makes sure the font size style is not removed when only a part of the
   * element with font size style is selected during the font size command.
   */
  function testFontSizeDoesntOverrideStyleAttr() {
    setUpFontSizeTests();
    FIELDMOCK.$replay();

    HELPER.select('23', 1, '4', 1); // Selects 34 (half of span with font size).
    FORMATTER.execCommandInternal(
        goog.editor.plugins.BasicTextFormatter.COMMAND.FONT_SIZE, 6);

    assertFontSizes(
        'New font size shouldn\'t override existing font size before selection',
        {'2': 2, '23': null, '3': 32, '4': 32});

    FIELDMOCK.$verify();
  }

  /**
   * Makes sure the font size style is not removed when only a part of the
   * element with font size style is selected during the font size command, but
   * is removed for another element that is fully selected.
   */
  function testFontSizeDoesntOverrideStyleAttrMultiNode() {
    setUpFontSizeTests();
    FIELDMOCK.$replay();

    HELPER.select('23', 1, '56', 2); // Selects 3456.
    FORMATTER.execCommandInternal(
        goog.editor.plugins.BasicTextFormatter.COMMAND.FONT_SIZE, 6);

    assertFontSizes(
        'New font size shouldn\'t override existing font size before ' +
        'selection, but still override existing font size in last span',
        {'2': 2, '23': null, '3': 32, '4': 32, '56': 32});

    FIELDMOCK.$verify();
  }

  /**
   * Helper to make sure the precondition that executing the font size command
   * wraps the content in font tags instead of modifying the style attribute is
   * maintained by the browser even if the selection is already text that is
   * wrapped in a tag with a font size style. We test this with several
   * permutations of how the selection looks: selecting the text in the text
   * node, selecting the whole text node as a unit, or selecting the whole span
   * node as a unit. Sometimes the browser wraps the text node with the font
   * tag, sometimes it wraps the span with the font tag. Either one is ok as
   * long as a font tag is actually being used instead of just modifying the
   * span's style, because our fix for {@bug 1286408} would remove that style.
   * @param {function} doSelect Function to select the "23" text in the test
   *     content.
   */
  function doTestFontSizeStyledSpan(doSelect) {
    // Make sure no new browsers start getting this bad behavior. If they do,
    // this test will unexpectedly pass.
    expectedFailures.expectFailureFor(
        !goog.editor.BrowserFeature.DOESNT_OVERRIDE_FONT_SIZE_IN_STYLE_ATTR);

    try {
    setUpFontSizeTests();
    FIELDMOCK.$replay();

    doSelect();
    FORMATTER.execCommandInternal(
        goog.editor.plugins.BasicTextFormatter.COMMAND.FONT_SIZE, 7);
    var parentNode = HELPER.findTextNode('23').parentNode;
    var grandparentNode = parentNode.parentNode;
    var fontNode = goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.FONT,
                                                         undefined, ROOT)[0];
    var spanNode = goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.SPAN,
                                                         undefined, ROOT)[0];
    assertTrue('A font tag should have been added either outside or inside' +
               ' the existing span',
               parentNode == spanNode && grandparentNode == fontNode ||
               parentNode == fontNode && grandparentNode == spanNode);

    FIELDMOCK.$verify();
    } catch (e) {
      expectedFailures.handleException(e);
    }
  }

  function testFontSizeStyledSpanSelectingText() {
    doTestFontSizeStyledSpan(function() {
      HELPER.select('23', 0, '23', 2);
    });
  }

  function testFontSizeStyledSpanSelectingTextNode() {
    doTestFontSizeStyledSpan(function() {
      var textNode = HELPER.findTextNode('23');
      HELPER.select(textNode.parentNode, 0, textNode.parentNode, 1);
    });
  }

  function testFontSizeStyledSpanSelectingSpanNode() {
    doTestFontSizeStyledSpan(function() {
      var spanNode = HELPER.findTextNode('23').parentNode;
      HELPER.select(spanNode.parentNode, 1, spanNode.parentNode, 2);
    });
  }

  function setUpIframeField(content) {
    var ifr = document.getElementById('iframe');
    var body = ifr.contentWindow.document.body;
    body.innerHTML = content;

    HELPER = new goog.testing.editor.TestHelper(body);
    HELPER.setUpEditableElement();
    FIELDMOCK = new goog.testing.editor.FieldMock(ifr.contentWindow);
    FIELDMOCK.getElement();
    FIELDMOCK.$anyTimes();
    FIELDMOCK.$returns(body);
    FIELDMOCK.queryCommandValue('rtl');
    FIELDMOCK.$anyTimes();
    FIELDMOCK.$returns(null);
    FORMATTER.fieldObject = FIELDMOCK;
  }

  function tearDownIframeField() {
    tearDownHelper();
  }

  function setUpConvertBreaksToDivTests() {
    ROOT.innerHTML = '<p>paragraph</p>one<br id="br1">two<br><br><br>three';
    HELPER = new goog.testing.editor.TestHelper(ROOT);
    HELPER.setUpEditableElement();

    FIELDMOCK.getElement();
    FIELDMOCK.$anyTimes();
    FIELDMOCK.$returns(ROOT);
  }

  function tearDownConvertBreaksToDivTests() {
    tearDownHelper();
  }

  /** @bug 1414941 */
  function testConvertBreaksToDivsKeepsP() {
    if (goog.editor.BrowserFeature.CAN_LISTIFY_BR) {
      return;
    }
    setUpConvertBreaksToDivTests();
    FIELDMOCK.$replay();

    HELPER.select('three', 0);
    FORMATTER.convertBreaksToDivs_();
    assertEquals('There should still be a <p> tag',
                 1, FIELDMOCK.getElement().getElementsByTagName('p').length);
    var html = FIELDMOCK.getElement().innerHTML.toLowerCase();
    assertNotBadBrElements(html);
    assertNotContains('There should not be empty <div> elements',
                      '<div><\/div>', html);

    FIELDMOCK.$verify();
    tearDownConvertBreaksToDivTests();
  }

  /**
  * @bug 1414937
  * @bug 934535
  */
  function testConvertBreaksToDivsDoesntCollapseBR() {
    if (goog.editor.BrowserFeature.CAN_LISTIFY_BR) {
      return;
    }
    setUpConvertBreaksToDivTests();
    FIELDMOCK.$replay();

    HELPER.select('three', 0);
    FORMATTER.convertBreaksToDivs_();
    var html = FIELDMOCK.getElement().innerHTML.toLowerCase();
    assertNotBadBrElements(html);
    assertNotContains('There should not be empty <div> elements',
                      '<div><\/div>', html);
    if (goog.userAgent.IE) {
      // <div><br></div> misbehaves in IE
      assertNotContains(
          '<br> should not be used to prevent <div> from collapsing',
          '<div><br><\/div>', html);
    }

    FIELDMOCK.$verify();
    tearDownConvertBreaksToDivTests();
  }

  function testConvertBreaksToDivsSelection() {
    if (goog.editor.BrowserFeature.CAN_LISTIFY_BR) {
      return;
    }
    setUpConvertBreaksToDivTests();
    FIELDMOCK.$replay();

    HELPER.select('two', 1, 'three', 3);
    var before = FIELDMOCK.getRange().getText().replace(/\s/g, '');
    FORMATTER.convertBreaksToDivs_();
    assertEquals('Selection must not be changed',
                 before, FIELDMOCK.getRange().getText().replace(/\s/g, ''));

    FIELDMOCK.$verify();
    tearDownConvertBreaksToDivTests();
  }

  /** @bug 1414937 */
  function testConvertBreaksToDivsInsertList() {
    setUpConvertBreaksToDivTests();
    FIELDMOCK.$replay();

    HELPER.select('three', 0);
    FORMATTER.execCommandInternal('insertorderedlist');
    assertTrue('Ordered list must be inserted',
               FIELDMOCK.getEditableDomHelper().getDocument().queryCommandState(
                   'insertorderedlist'));
    tearDownConvertBreaksToDivTests();
  }

  /**
   * Regression test for {@bug 1939883}, where if a br has an id, it causes
   * the convert br code to throw a js error. This goes a step further and
   * ensures that the id is preserved in the resulting div element.
   */
  function testConvertBreaksToDivsKeepsId() {
    if (goog.editor.BrowserFeature.CAN_LISTIFY_BR) {
      return;
    }
    setUpConvertBreaksToDivTests();
    FIELDMOCK.$replay();

    HELPER.select('one', 0, 'two', 0);
    FORMATTER.convertBreaksToDivs_();
    var html = FIELDMOCK.getElement().innerHTML.toLowerCase();
    assertNotBadBrElements(html);
    var idBr = document.getElementById('br1');
    assertNotNull('There should still be a tag with id="br1"', idBr);
    assertEquals('The tag with id="br1" should be a <div> now',
                 goog.dom.TagName.DIV,
                 idBr.tagName);
    assertNull('There should not be any tag with id="temp_br"',
               document.getElementById('temp_br'));

    FIELDMOCK.$verify();
    tearDownConvertBreaksToDivTests();
  }

  /**
   * @bug 2420054
   */
  var JUSTIFICATION_COMMANDS = [
      goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_LEFT,
      goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_RIGHT,
      goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_CENTER,
      goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_FULL
  ];
  function doTestIsJustification(command) {
    setUpRealField();
    REAL_FIELD.setHtml(false, 'foo');
    selectRealField();
    REAL_FIELD.execCommand(command);

    for (var i = 0; i < JUSTIFICATION_COMMANDS.length; i++) {
      if (JUSTIFICATION_COMMANDS[i] == command) {
        assertTrue('queryCommandValue(' +JUSTIFICATION_COMMANDS[i] +
                   ') should be true after execCommand(' + command + ')',
            REAL_FIELD.queryCommandValue(JUSTIFICATION_COMMANDS[i]));
      } else {
        assertFalse('queryCommandValue(' +JUSTIFICATION_COMMANDS[i] +
                   ') should be false after execCommand(' + command + ')',
            REAL_FIELD.queryCommandValue(JUSTIFICATION_COMMANDS[i]));
      }
    }
  }
  function testIsJustificationLeft() {
    doTestIsJustification(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_LEFT);
  }
  function testIsJustificationRight() {
    doTestIsJustification(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_RIGHT);
  }
  function testIsJustificationCenter() {
    doTestIsJustification(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_CENTER);
  }
  function testIsJustificationFull() {
    doTestIsJustification(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_FULL);
  }

  /**
   * Regression test for {@bug 1414813}, where all 3 justification buttons are
   * considered "on" when you first tab into the editable field. In this
   * situation, when lorem ipsum is the only node in the editable field iframe
   * body, mockField.getRange() returns an empty range.
   */
  function testIsJustificationEmptySelection() {
    var mockField = new goog.testing.LooseMock(goog.editor.Field);

    mockField.getRange();
    mockField.$anyTimes();
    mockField.$returns(null);
    mockField.getPluginByClassId('Bidi');
    mockField.$anyTimes();
    mockField.$returns(null);
    FORMATTER.fieldObject = mockField;

    mockField.$replay();

    assertFalse('Empty selection should not be justified',
                FORMATTER.isJustification_(
                    goog.editor.plugins.BasicTextFormatter.
                    COMMAND.JUSTIFY_CENTER));
    assertFalse('Empty selection should not be justified',
                FORMATTER.isJustification_(
                    goog.editor.plugins.BasicTextFormatter.
                    COMMAND.JUSTIFY_FULL));
    assertFalse('Empty selection should not be justified',
                FORMATTER.isJustification_(
                    goog.editor.plugins.BasicTextFormatter.
                    COMMAND.JUSTIFY_RIGHT));
    assertFalse('Empty selection should not be justified',
                FORMATTER.isJustification_(
                    goog.editor.plugins.BasicTextFormatter.
                    COMMAND.JUSTIFY_LEFT));

    mockField.$verify();
  }

  function testIsJustificationSimple1() {
    setUpRealField();
    REAL_FIELD.setHtml(false,'<div align="right">foo</div>');
    selectRealField();

    assertFalse(REAL_FIELD.queryCommandValue(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_LEFT));
    assertTrue(REAL_FIELD.queryCommandValue(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_RIGHT));
  }

  function testIsJustificationSimple2() {
    setUpRealField();
    REAL_FIELD.setHtml(false,'<div style="text-align: right;">foo</div>');
    selectRealField();

    assertFalse(REAL_FIELD.queryCommandValue(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_LEFT));
    assertTrue(REAL_FIELD.queryCommandValue(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_RIGHT));
  }

  function testIsJustificationComplete1() {
    setUpRealField();
    REAL_FIELD.setHtml(false,
        '<div align="left">a</div><div align="right">b</div>');
    selectRealField();

    assertFalse(REAL_FIELD.queryCommandValue(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_LEFT));
    assertFalse(REAL_FIELD.queryCommandValue(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_RIGHT));
  }

  function testIsJustificationComplete2() {
    setUpRealField();
    REAL_FIELD.setHtml(false,
        '<div align="left">a</div><div align="left">b</div>');
    selectRealField();

    assertTrue(REAL_FIELD.queryCommandValue(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_LEFT));
    assertFalse(REAL_FIELD.queryCommandValue(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_RIGHT));
  }

  function testIsJustificationComplete3() {
    setUpRealField();
    REAL_FIELD.setHtml(false,
        '<div align="right">a</div><div align="right">b</div>');
    selectRealField();

    assertFalse(REAL_FIELD.queryCommandValue(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_LEFT));
    assertTrue(REAL_FIELD.queryCommandValue(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_RIGHT));
  }

  function testIsJustificationComplete4() {
    setUpRealField();
    REAL_FIELD.setHtml(false,
        '<div align="right"><div align="left">a</div></div>' +
        '<div align="right">b</div>');
    selectRealField();

    assertFalse(REAL_FIELD.queryCommandValue(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_LEFT));
    assertTrue(REAL_FIELD.queryCommandValue(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_RIGHT));
  }

  function testIsJustificationComplete5() {
    setUpRealField();
    REAL_FIELD.setHtml(false,
        '<div align="right">a</div>b' +
        '<div align="right">c</div>');
    selectRealField();

    assertFalse(REAL_FIELD.queryCommandValue(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_LEFT));
    assertFalse(REAL_FIELD.queryCommandValue(
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_RIGHT));
  }

  /** @bug 2472589 */
  function doTestIsJustificationPInDiv(useCss, align, command) {
    setUpRealField();
    var html = '<div ' +
               (useCss ? 'style="text-align:' : 'align="') + align +
               '"><p>foo</p></div>';
    REAL_FIELD.setHtml(false, html);
    selectRealField();
    assertTrue(
        'P inside ' + align + ' aligned' + (useCss ? ' (using CSS)' : '') +
            ' DIV should be considered ' + align + ' aligned',
        REAL_FIELD.queryCommandValue(command));
  }
  function testIsJustificationPInDivLeft() {
    doTestIsJustificationPInDiv(false, 'left',
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_LEFT);
  }
  function testIsJustificationPInDivRight() {
    doTestIsJustificationPInDiv(false, 'right',
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_RIGHT);
  }
  function testIsJustificationPInDivCenter() {
    doTestIsJustificationPInDiv(false, 'center',
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_CENTER);
  }
  function testIsJustificationPInDivJustify() {
    doTestIsJustificationPInDiv(false, 'justify',
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_FULL);
  }
  function testIsJustificationPInDivLeftCss() {
    doTestIsJustificationPInDiv(true, 'left',
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_LEFT);
  }
  function testIsJustificationPInDivRightCss() {
    doTestIsJustificationPInDiv(true, 'right',
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_RIGHT);
  }
  function testIsJustificationPInDivCenterCss() {
    doTestIsJustificationPInDiv(true, 'center',
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_CENTER);
  }
  function testIsJustificationPInDivJustifyCss() {
    doTestIsJustificationPInDiv(true, 'justify',
        goog.editor.plugins.BasicTextFormatter.COMMAND.JUSTIFY_FULL);
  }


  function testPrepareContent() {
    setUpRealField();
    assertPreparedContents("\n", "\n");

    if (goog.editor.BrowserFeature.COLLAPSES_EMPTY_NODES) {
      assertPreparedContents("&nbsp;<script>alert('hi')<" + "/script>",
          "<script>alert('hi')<" + "/script>");
    } else {
      assertNotPreparedContents("<script>alert('hi')<" + "/script>");
    }

    if (goog.editor.BrowserFeature.CONVERT_TO_B_AND_I_TAGS) {
      assertPreparedContents("<b id='foo'>hi</b>",
          "<strong id='foo'>hi</strong>");
      assertPreparedContents("<i>hi</i>", "<em>hi</em>");
      assertNotPreparedContents("<embed/>");
    } else {
      assertNotPreparedContents("<em>hi</em>");
      assertNotPreparedContents("<strong id='foo'>hi</strong>");
    }
  }

  function testScrubImagesRemovesCustomAttributes() {
    var fieldElem = goog.dom.getElement('real-field');
    fieldElem.innerHTML = '';
    var attrs = {'src': 'http://www.google.com/foo.jpg',
                 'tabIndex': '0',
                 'tabIndexSet': '0'};
    attrs[goog.HASH_CODE_PROPERTY_] = '0';
    goog.dom.appendChild(fieldElem,
        goog.dom.createDom('img', attrs));

    setUpRealField();

    var html = REAL_FIELD.getCleanContents();
    assert('Images must not have forbidden attributes: ' + html,
        -1 == html.indexOf('tabIndex') && -1 == html.indexOf('closure'));
    assert('Image URLs must not be made relative by default: ' + html,
        -1 != html.indexOf('/foo.jpg'));
  }

  function testGeckoSelectionChange() {
    if (!goog.userAgent.GECKO || !goog.userAgent.isVersion('1.9')) {
      return;
    }

    setUpRealFieldIframe();
    // Use native selection for this test because goog.dom.Range will
    // change selections of <br>
    var ifr = document.getElementById('iframe');
    ifr.contentWindow.document.body.innerHTML = 'hello<br id="br1"><br id="br2">';
    var body = ifr.contentWindow.document.body;
    var range = REAL_FIELD.getRange();
    var browserRange = range.getBrowserRangeObject();
    browserRange.setStart(body, 2);
    browserRange.setEnd(body, 2);
    FORMATTER.applyExecCommandGeckoFixes_('formatblock');
    var updatedRange = REAL_FIELD.getRange().getBrowserRangeObject();
    assertEquals('Range should have been updated to deep range',
        'br2', updatedRange.startContainer.id);
    assertEquals('Range should have been updated to deep range',
        0, updatedRange.startOffset);
  }

  function testIEExecCommandFixes() {
    if (!goog.userAgent.IE) {
      return;
    }

    setUpRealField();
    REAL_FIELD.setHtml(false, '<blockquote>hi</blockquote>');
    goog.dom.Range.createFromNodeContents(REAL_FIELD.getElement()).select();

    var nodes = REAL_PLUGIN.applyExecCommandIEFixes_('insertOrderedList');
    assertHTMLEquals(
        '<blockquote>hi <div style="height:0px"></div></blockquote>',
        REAL_FIELD.getCleanContents());
  }

  /**
   * Assert that the prepared contents matches the expected.
   */
  function assertPreparedContents(expected, original) {
    assertEquals(expected,
        REAL_FIELD.reduceOp_(
            goog.editor.Plugin.Op.PREPARE_CONTENTS_HTML, original));
  }

  /**
   * Assert that sanitization doesn't affect the given text.
   */
  function assertNotPreparedContents(text) {
    assertPreparedContents(text, text);
  }

  /**
   * Assert that only BR elements expected to persist after convertBreaksToDivs_
   * are in the HTML.
   */
  function assertNotBadBrElements(html) {
    if (goog.userAgent.IE) {
      assertNotContains('There should not be <br> elements', '<br', html);
    } else {
      assertFalse('There should not be <br> elements, except ones to prevent ' +
                  '<div>s from collapsing' + html,
                  /(?!<div>)<br>(?!<\/div>)/.test(html))
    }
  }

">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:41:26
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>tableeditor_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.testing.ExpectedFailures');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');
  goog.require('goog.editor.plugins.TableEditor');
  goog.require('goog.testing.editor.FieldMock');
  goog.require('goog.testing.editor.TestHelper');



var field = goog.dom.getElement('field');
var plugin;
var fieldMock;
var expectedFailures = new goog.testing.ExpectedFailures();
var testHelper;

function setUp() {
  testHelper = new goog.testing.editor.TestHelper(
      goog.dom.getElement('field'));
  testHelper.setUpEditableElement();
  field.focus();
  plugin = new goog.editor.plugins.TableEditor();
  fieldMock = new goog.testing.editor.FieldMock();
  plugin.registerFieldObject(fieldMock);
  if (goog.userAgent.IE &&
      (goog.userAgent.compare(goog.userAgent.VERSION, '7.0') >= 0)) {
    goog.testing.TestCase.protectedTimeout_ = window.setTimeout;
  }
}

function tearDown() {
  testHelper.tearDownEditableElement();
  expectedFailures.handleTearDown();
}

function testEnable() {
  fieldMock.$replay();

  plugin.enable(fieldMock);
  assertTrue('Plugin should be enabled', plugin.isEnabled(fieldMock));

  if (goog.userAgent.GECKO) {
    // This code path is executed only for GECKO browsers but we can't
    // verify it because of a GECKO bug while reading the value of the
    // command "enableObjectResizing".
    // See https://bugzilla.mozilla.org/show_bug.cgi?id=506368
    expectedFailures.expectFailureFor(goog.userAgent.GECKO);
    try {
      var doc = plugin.getFieldDomHelper().getDocument();
      assertTrue('Object resizing should be enabled',
                 doc.queryCommandValue('enableObjectResizing'));
    } catch(e) {
      // We need to marshal our exception in order for it to be handled
      // properly.
      expectedFailures.handleException(new goog.testing.JsUnitException(e));
    }
  }
  fieldMock.$verify();
}

function testIsSupportedCommand() {
  goog.object.forEach(goog.editor.plugins.TableEditor.COMMAND,
      function(command) {
    assertTrue(goog.string.subs('Plugin should support %s', command),
               plugin.isSupportedCommand(command));
  });
  assertFalse('Plugin shouldn\'t support a bogus command',
              plugin.isSupportedCommand('+fable'));
}

function testCreateTable() {
  fieldMock.$replay();
  createTableAndSelectCell();
  var table = plugin.getCurrentTable_();
  assertNotNull('Table should not be null', table);
  assertEquals('Table should have the default number of rows',
               2,
               table.rows.length);
  assertEquals('Table should have the default number of cells',
               8,
               getCellCount(table));
  fieldMock.$verify();
}

function testInsertRowBefore() {
  fieldMock.$replay();
  createTableAndSelectCell();
  var table = plugin.getCurrentTable_();
  var selectedRow = fieldMock.getRange().getContainerElement().parentNode;
  assertNull('Selected row shouldn\'t have a previous sibling',
             selectedRow.previousSibling);
  assertEquals('Table should have two rows', 2, table.rows.length);
  plugin.execCommandInternal(
      goog.editor.plugins.TableEditor.COMMAND.INSERT_ROW_BEFORE);
  assertEquals('A row should have been inserted', 3, table.rows.length);

  // Assert that we inserted a row above the currently selected row.
  assertNotNull('Selected row should have a previous sibling',
                selectedRow.previousSibling);
  fieldMock.$verify();
}

function testInsertRowAfter() {
  fieldMock.$replay();
  createTableAndSelectCell({width: 2, height: 1});
  var selectedRow = fieldMock.getRange().getContainerElement().parentNode;
  var table = plugin.getCurrentTable_();
  assertEquals('Table should have one row', 1, table.rows.length);
  assertNull('Selected row shouldn\'t have a next sibling',
             selectedRow.nextSibling);
  plugin.execCommandInternal(
      goog.editor.plugins.TableEditor.COMMAND.INSERT_ROW_AFTER);
  assertEquals('A row should have been inserted', 2, table.rows.length);
  // Assert that we inserted a row after the currently selected row.
  assertNotNull('Selected row should have a next sibling',
                selectedRow.nextSibling);
  fieldMock.$verify();
}

function testInsertColumnBefore() {
  fieldMock.$replay();
  createTableAndSelectCell({width: 1, height: 1});
  var table = plugin.getCurrentTable_();
  var selectedCell = fieldMock.getRange().getContainerElement();
  assertEquals('Table should have one cell', 1, getCellCount(table));
  assertNull('Selected cell shouldn\'t have a previous sibling',
             selectedCell.previousSibling);
  plugin.execCommandInternal(
      goog.editor.plugins.TableEditor.COMMAND.INSERT_COLUMN_BEFORE);
  assertEquals('A cell should have been inserted', 2, getCellCount(table));
  assertNotNull('Selected cell should have a previous sibling',
                selectedCell.previousSibling);
  fieldMock.$verify();
}

function testInsertColumnAfter() {
  fieldMock.$replay();
  createTableAndSelectCell({width: 1, height: 1});
  var table = plugin.getCurrentTable_();
  var selectedCell = fieldMock.getRange().getContainerElement();
  assertEquals('Table should have one cell', 1, getCellCount(table));
  assertNull('Selected cell shouldn\'t have a next sibling',
             selectedCell.nextSibling);
  plugin.execCommandInternal(
      goog.editor.plugins.TableEditor.COMMAND.INSERT_COLUMN_AFTER);
  assertEquals('A cell should have been inserted', 2, getCellCount(table));
  assertNotNull('Selected cell should have a next sibling',
                selectedCell.nextSibling);
  fieldMock.$verify();
}

function testRemoveRows() {
  fieldMock.$replay();
  createTableAndSelectCell({width: 1, height: 2});
  var table = plugin.getCurrentTable_();
  var selectedCell = fieldMock.getRange().getContainerElement();
  selectedCell.id = 'selected';
  assertEquals('Table should have two rows', 2, table.rows.length);
  plugin.execCommandInternal(
      goog.editor.plugins.TableEditor.COMMAND.REMOVE_ROWS);
  assertEquals('A row should have been removed', 1, table.rows.length);
  assertNull('The correct row should have been removed',
             goog.dom.getElement('selected'));

  // Verify that the table is removed if we don't have any rows.
  plugin.execCommandInternal(
      goog.editor.plugins.TableEditor.COMMAND.REMOVE_ROWS);
  assertEquals('The table should have been removed',
               0,
               field.getElementsByTagName('table').length);
  fieldMock.$verify();
}

function testRemoveColumns() {
  fieldMock.$replay();
  createTableAndSelectCell({width: 2, height: 1});
  var table = plugin.getCurrentTable_();
  var selectedCell = fieldMock.getRange().getContainerElement();
  selectedCell.id = 'selected';
  assertEquals('Table should have two cells', 2, getCellCount(table));
  plugin.execCommandInternal(
      goog.editor.plugins.TableEditor.COMMAND.REMOVE_COLUMNS);
  assertEquals('A cell should have been removed', 1, getCellCount(table));
  assertNull('The correct cell should have been removed',
             goog.dom.getElement('selected'));

  // Verify that the table is removed if we don't have any columns.
  plugin.execCommandInternal(
      goog.editor.plugins.TableEditor.COMMAND.REMOVE_COLUMNS);
  assertEquals('The table should have been removed',
               0,
               field.getElementsByTagName('table').length);
  fieldMock.$verify();
}

function testSplitCell() {
  fieldMock.$replay();
  createTableAndSelectCell({width: 1, height: 1});
  var table = plugin.getCurrentTable_();
  var selectedCell = fieldMock.getRange().getContainerElement();
  // Splitting is only supported if we set these attributes.
  selectedCell.rowSpan = '1';
  selectedCell.colSpan = '2';
  selectedCell.innerHTML = 'foo';
  goog.dom.Range.createFromNodeContents(selectedCell).select();
  assertEquals('Table should have one cell', 1, getCellCount(table));
  plugin.execCommandInternal(
      goog.editor.plugins.TableEditor.COMMAND.SPLIT_CELL);
  assertEquals('The cell should have been split', 2, getCellCount(table));
  assertEquals('The cell content should be intact',
               'foo',
               selectedCell.innerHTML);
  assertNotNull('The new cell should be inserted before',
               selectedCell.previousSibling);
  fieldMock.$verify();
}

function testMergeCells() {
  fieldMock.$replay();
  createTableAndSelectCell({width: 2, height: 1});
  var table = plugin.getCurrentTable_();
  var selectedCell = fieldMock.getRange().getContainerElement();
  selectedCell.innerHTML = 'foo';
  selectedCell.nextSibling.innerHTML = 'bar';
  var range = goog.dom.Range.createFromNodeContents(
      table.getElementsByTagName('tr')[0]);
  range.select();
  plugin.execCommandInternal(
      goog.editor.plugins.TableEditor.COMMAND.MERGE_CELLS);
  expectedFailures.expectFailureFor(
      goog.userAgent.IE &&
      goog.userAgent.isVersion('8'));
  try {
    // In IE8, even after explicitly setting the range to span
    // multiple cells, the browser selection only contains the first TD
    // which causes the merge operation to fail.
    assertEquals('The cells should be merged', 1, getCellCount(table));
    assertEquals('The cell should have expected colspan',
                 2,
                 selectedCell.colSpan);
    assertHTMLEquals('The content should be merged',
                     'foo bar',
                     selectedCell.innerHTML);
  } catch(e) {
    expectedFailures.handleException(e);
  }
  fieldMock.$verify();
}

/**
 * Helper routine which returns the number of cells in the table.
 *
 * @param {Element} table The table in question.
 * @return {number} Number of cells.
 */
function getCellCount(table) {
  return table.cells ? table.cells.length :
      table.rows[0].cells.length * table.rows.length;
}

/**
 * Helper method which creates a table and puts the cursor on the first TD.
 * In IE, the cursor isn't positioned in the first cell (TD) and we simulate
 * that behavior explicitly to be consistent across all browsers.
 *
 * @param {Object} op_tableProps Optional table properties.
 */
function createTableAndSelectCell(opt_tableProps) {
  goog.dom.Range.createCaret(field, 1).select();
  plugin.execCommandInternal(goog.editor.plugins.TableEditor.COMMAND.TABLE,
                             opt_tableProps);
  if (goog.userAgent.IE) {
    var range = goog.dom.Range.createFromNodeContents(
        field.getElementsByTagName('td')[0]);
    range.select();
  }
}
">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:15:24
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>linkdialogplugin_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.editor.BrowserFeature');
  goog.require('goog.editor.Command');
  goog.require('goog.editor.Field');
  goog.require('goog.editor.Link');
  goog.require('goog.editor.plugins.LinkDialogPlugin');
  goog.require('goog.string.Unicode');
  goog.require('goog.testing.MockControl');
  goog.require('goog.testing.editor.FieldMock');
  goog.require('goog.testing.editor.TestHelper');
  goog.require('goog.testing.editor.dom');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.mockmatchers');
  goog.require('goog.ui.editor.AbstractDialog.EventType');
  goog.require('goog.ui.editor.LinkDialog');
  goog.require('goog.ui.editor.LinkDialog.OkEvent');
  goog.require('goog.userAgent');


  var plugin;
  var anchorElem;
  var isNew;

  var mockCtrl;
  var mockField;
  var mockLink;

  var OLD_LINK_TEXT = 'old text';
  var OLD_LINK_URL = 'http://old.url/';
  var NEW_LINK_TEXT = 'My Link Text';
  var NEW_LINK_URL = 'http://my.link/url/';

  var fieldElem;
  var fieldObj;
  var linkObj;

  function setUp() {
    anchorElem = goog.dom.createElement(goog.dom.TagName.A);
    anchorElem.href = 'http://www.google.com/';
    anchorElem.innerHTML = 'anchor text';
    goog.dom.appendChild(goog.dom.getDocument().body, anchorElem);

    mockCtrl = new goog.testing.MockControl();
    mockField = new goog.testing.editor.FieldMock();
    mockCtrl.addMock(mockField);
    mockLink = mockCtrl.createLooseMock(goog.editor.Link);

    isNew = false;
    mockLink.isNew().$anyTimes().$does(function() {
      return isNew;
    });
    mockLink.
        setTextAndUrl(goog.testing.mockmatchers.isString,
            goog.testing.mockmatchers.isString).
        $anyTimes().
        $does(function(text, url) {
          anchorElem.innerHTML = text;
          anchorElem.href = url;
        });
    mockLink.getAnchor().$anyTimes().$returns(anchorElem);
  }

  function tearDown() {
    plugin.dispose();
    tearDownRealEditableField();
    goog.dom.removeNode(anchorElem);
  }

  function setUpAnchor(text, href, opt_isNew) {
    anchorElem.innerHTML = text;
    anchorElem.href = href;
    isNew = !!opt_isNew;
  }

  /**
   * Tests that the plugin's dialog is properly created.
   */
  function testCreateDialog() {
    // Note: this tests simply creating the dialog because that's the only
    // functionality added to this class. Opening or closing effects (editing
    // the actual link) is tested in linkdialog_test.html, but should be moved
    // here if that functionality gets refactored from the dialog to the plugin.
    mockCtrl.$replayAll();

    plugin = new goog.editor.plugins.LinkDialogPlugin();
    plugin.registerFieldObject(mockField);

    var dialog = plugin.createDialog(new goog.dom.DomHelper(), mockLink);
    assertTrue('Dialog should be of type goog.ui.editor.LinkDialog',
               dialog instanceof goog.ui.editor.LinkDialog);

    mockCtrl.$verifyAll();
  }

  /**
   * Tests that when the OK event fires the link is properly updated.
   */
  function testOk() {
    mockLink.placeCursorRightOf();
    mockField.dispatchSelectionChangeEvent();
    mockField.dispatchChange();
    mockCtrl.$replayAll();

    setUpAnchor(OLD_LINK_TEXT, OLD_LINK_URL);
    plugin = new goog.editor.plugins.LinkDialogPlugin();
    plugin.registerFieldObject(mockField);
    var dialog = plugin.createDialog(new goog.dom.DomHelper(), mockLink);

    // Mock of execCommand + clicking OK without actually opening the dialog.
    plugin.currentLink_ = mockLink;
    dialog.dispatchEvent(new goog.ui.editor.LinkDialog.OkEvent(NEW_LINK_TEXT,
                                                             NEW_LINK_URL));

    assertEquals('Display text incorrect',
                 NEW_LINK_TEXT,
                 anchorElem.innerHTML);
    assertEquals('Anchor element href incorrect',
                 NEW_LINK_URL,
                 anchorElem.href);

    mockCtrl.$verifyAll();
  }

  /**
   * Tests that when the Cancel event fires the link is unchanged.
   */
  function testCancel() {
    mockCtrl.$replayAll();

    setUpAnchor(OLD_LINK_TEXT, OLD_LINK_URL);
    plugin = new goog.editor.plugins.LinkDialogPlugin();
    plugin.registerFieldObject(mockField);
    var dialog = plugin.createDialog(new goog.dom.DomHelper(), mockLink);

    // Mock of execCommand + cancel without actually opening the dialog.
    plugin.currentLink_ = mockLink;
    dialog.dispatchEvent(goog.ui.editor.AbstractDialog.EventType.CANCEL);

    assertEquals('Display text should not be changed',
                 OLD_LINK_TEXT,
                 anchorElem.innerHTML);
    assertEquals('Anchor element href should not be changed',
                 OLD_LINK_URL,
                 anchorElem.href);

    mockCtrl.$verifyAll();
  }

  /**
   * Tests that when the Cancel event fires for a new link it gets removed.
   */
  function testCancelNew() {
    mockField.dispatchChange(); // Should be fired because link was removed.
    mockCtrl.$replayAll();

    setUpAnchor(OLD_LINK_TEXT, OLD_LINK_URL, true);
    var prevSib = anchorElem.previousSibling;
    plugin = new goog.editor.plugins.LinkDialogPlugin();
    plugin.registerFieldObject(mockField);
    var dialog = plugin.createDialog(new goog.dom.DomHelper(), mockLink);

    // Mock of execCommand + cancel without actually opening the dialog.
    plugin.currentLink_ = mockLink;
    dialog.dispatchEvent(goog.ui.editor.AbstractDialog.EventType.CANCEL);

    assertNotEquals('Anchor element should be removed from document body',
                    goog.dom.getDocument().body,
                    anchorElem.parentNode);
    var newElem = prevSib.nextSibling;
    assertEquals('Link should be replaced by text node',
                 goog.dom.NodeType.TEXT,
                 newElem.nodeType);
    assertEquals('Original text should be left behind',
                 OLD_LINK_TEXT,
                 newElem.nodeValue);

    mockCtrl.$verifyAll();
    goog.dom.removeNode(newElem);
  }

  /**
   * Tests that the selection is cleared when the dialog opens and is
   * correctly restored after cancel is clicked.
   */
  function testRestoreSelectionOnOk() {
    setUpAnchor('12345', '/');
    setUpRealEditableField();

    var elem = fieldObj.getElement();
    var helper = new goog.testing.editor.TestHelper(elem);
    helper.select('12345', 1, '12345', 4); // Selects '234'.

    assertEquals('Incorrect text selected before dialog is opened',
                 '234',
                 fieldObj.getRange().getText());
    plugin.execCommand(goog.editor.Command.MODAL_LINK_EDITOR, linkObj);
    if (!goog.userAgent.IE && !goog.userAgent.OPERA) {
      // IE returns some bogus range when field doesn't have selection.
      // You can't remove the selection from a whitebox field in Opera.
      assertNull('There should be no selection while dialog is open',
                 fieldObj.getRange());
    }
    goog.testing.events.fireClickSequence(
        plugin.dialog_.getOkButtonElement());
    assertEquals('No text should be selected after clicking ok',
                 '',
                 fieldObj.getRange().getText());

    // Test that the caret is placed at the end of the link text.
    goog.testing.editor.dom.assertRangeBetweenText(
        // If the browser gets stuck in links, an nbsp was added after the link
        // to avoid that, otherwise we just look for the 5.
        goog.editor.BrowserFeature.GETS_STUCK_IN_LINKS ?
            goog.string.Unicode.NBSP : '5',
        '',
        fieldObj.getRange());

    // NOTE(user): The functionality to avoid getting stuck in links is
    // tested in editablelink_test.html::testPlaceCursorRightOf().
  }

  /**
   * Tests that the selection is cleared when the dialog opens and is
   * correctly restored after cancel is clicked.
   * @param {boolean=} opt_isNew Whether to test behavior when creating a new
   *     link (cancelling will flatten it).
   */
  function testRestoreSelectionOnCancel(opt_isNew) {
    setUpAnchor('12345', '/', opt_isNew);
    setUpRealEditableField();

    var elem = fieldObj.getElement();
    var helper = new goog.testing.editor.TestHelper(elem);
    helper.select('12345', 1, '12345', 4); // Selects '234'.

    assertEquals('Incorrect text selected before dialog is opened',
                 '234',
                 fieldObj.getRange().getText());
    plugin.execCommand(goog.editor.Command.MODAL_LINK_EDITOR, linkObj);
    if (!goog.userAgent.IE && !goog.userAgent.OPERA) {
      // IE returns some bogus range when field doesn't have selection.
      // You can't remove the selection from a whitebox field in Opera.
      assertNull('There should be no selection while dialog is open',
                 fieldObj.getRange());
    }
    goog.testing.events.fireClickSequence(
        plugin.dialog_.getCancelButtonElement());
    assertEquals('Incorrect text selected after clicking cancel',
                 '234',
                 fieldObj.getRange().getText());
  }

  /**
   * Tests that the selection is cleared when the dialog opens and is
   * correctly restored after cancel is clicked and the new link is removed.
   */
  function testRestoreSelectionOnCancelNew() {
    testRestoreSelectionOnCancel(true);
  }

  /**
   * Regression test for http://b/issue?id=1607766 . Without the fix, this
   * should give an Invalid Argument error in IE, because the editable field
   * caches a selection util that has a reference to the node of the link text
   * before it is edited (which gets replaced by a new node for the new text
   * after editing).
   */
  function testBug1607766() {
    setUpAnchor('abc', 'def');
    setUpRealEditableField();

    var elem = fieldObj.getElement();
    var helper = new goog.testing.editor.TestHelper(elem);
    helper.select('abc', 1, 'abc', 2); // Selects 'b'.
    // Dispatching a selection event causes the field to cache a selection
    // util, which is the root of the bug.
    plugin.fieldObject.dispatchSelectionChangeEvent();

    plugin.execCommand(goog.editor.Command.MODAL_LINK_EDITOR, linkObj);
    goog.dom.getElement(
        goog.ui.editor.LinkDialog.Id_.TEXT_TO_DISPLAY).value = 'Abc';
    goog.testing.events.fireClickSequence(plugin.dialog_.getOkButtonElement());

    // In IE the unit test somehow doesn't cause a browser focus event, so we
    // need to manually invoke this, which is where the bug happens.
    plugin.fieldObject.dispatchFocus_();
  }

  /**
   * Regression test for http://b/issue?id=2215546 .
   */
  function testBug2215546() {
    setUpRealEditableField();

    var elem = fieldObj.getElement();
    fieldObj.setHtml(false, '<div><a href="/"></a></div>');
    anchorElem = elem.firstChild.firstChild;
    linkObj = new goog.editor.Link(anchorElem, true);

    var helper = new goog.testing.editor.TestHelper(elem);
    // Select "</a>" in a way, simulating what IE does if you hit enter twice,
    // arrow up into the blank line and open the link dialog.
    helper.select(anchorElem, 0, elem.firstChild, 1);

    plugin.execCommand(goog.editor.Command.MODAL_LINK_EDITOR, linkObj);
    goog.dom.getElement(
        goog.ui.editor.LinkDialog.Id_.TEXT_TO_DISPLAY).value = 'foo';
    goog.dom.getElement(
        goog.ui.editor.LinkDialog.Id_.ON_WEB_INPUT).value = 'foo';
    var okButton = plugin.dialog_.getOkButtonElement();
    okButton.disabled = false;
    goog.testing.events.fireClickSequence(okButton);

    assertEquals('Link text should have been inserted',
                 'foo', anchorElem.innerHTML);
  }

  /**
   * Setup a real editable field (instead of a mock) and register the plugin to
   * it.
   */
  function setUpRealEditableField() {
    fieldElem = document.createElement('div');
    fieldElem.id = 'myField';
    document.body.appendChild(fieldElem);
    fieldElem.appendChild(anchorElem);
    fieldObj = new goog.editor.Field('myField', document);
    fieldObj.makeEditable();
    linkObj = new goog.editor.Link(fieldObj.getElement().firstChild, isNew)
    // Register the plugin to that field.
    plugin = new goog.editor.plugins.LinkDialogPlugin();
    fieldObj.registerPlugin(plugin);
  }

  /**
   * Tear down the real editable field.
   */
  function tearDownRealEditableField() {
    if (fieldObj) {
      fieldObj.makeUneditable();
      fieldObj.dispose();
      fieldObj = null;
    }
    goog.dom.removeNode(fieldElem);
  }


">Error: Namespace "goog.window" already declared.
    at Error (unknown source)
    at Object.provide (base.js:105:13)
    at window/window.js:20:6
    at [object Object].loadScript_ (/home/ubuntu/Dev/projects/node-goog/lib/goog.js:256:38)
    at /home/ubuntu/Dev/projects/node-goog/lib/goog.js:224:8
    at Object.importScript_ (base.js:455:45)
    at Object.writeScripts_ (base.js:536:14)
    at Object.require (base.js:280:12)
    at _tmpclosuretest.js:7:8
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
</td></tr>
<tr><td>seamlessfield_test.html</td><td>Fail</td><td> undefined</td><td title="

">0 of 0 tests run in 1ms.<br />No tests found.  Call G_testRunner.setStrict(false) if this is expected behavior.<br /></td></tr>
<tr><td>range_test.html</td><td>Fail</td><td> 1 passed, 34 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.Range');
  goog.require('goog.testing.dom');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');


  var assertRangeEquals = goog.testing.dom.assertRangeEquals;

  function normalizeHtml(str) {
    return str.toLowerCase().replace(/[\n\r\f"]/g, '')
        .replace(/<\/li>/g, ''); // " for emacs
  }

  function testCreate() {
    assertNotNull('Browser range object can be created for node',
        goog.dom.Range.createFromNodeContents(goog.dom.getElement('test1')));
  }

  function testTableRange() {
    var tr = goog.dom.getElement('cell').parentNode;
    var range = goog.dom.Range.createFromNodeContents(tr);
    assertEquals('Selection should have correct text', '12',
        range.getText());
    assertEquals('Selection should have correct html fragment',
        '1</td><td>2', normalizeHtml(range.getHtmlFragment()));

    // TODO(robbyw): On IE the TR is included, on FF it is not.
    //assertEquals('Selection should have correct valid html',
    //    '<tr id=row><td>1</td><td>2</td></tr>',
    //    normalizeHtml(range.getValidHtml()));

    assertEquals('Selection should have correct pastable html',
        '<table><tbody><tr><td id=cell>1</td><td>2</td></tr></tbody></table>',
        normalizeHtml(range.getPastableHtml()));
  }

  function testUnorderedListRange() {
    var ul = goog.dom.getElement('ulTest').firstChild;
    var range = goog.dom.Range.createFromNodeContents(ul);
    assertEquals('Selection should have correct html fragment',
        '1<li>2', normalizeHtml(range.getHtmlFragment()));

    // TODO(robbyw): On IE the UL is included, on FF it is not.
    //assertEquals('Selection should have correct valid html',
    //    '<li>1</li><li>2</li>', normalizeHtml(range.getValidHtml()));

    assertEquals('Selection should have correct pastable html',
        '<ul><li>1<li>2</ul>',
        normalizeHtml(range.getPastableHtml()));
  }

  function testOrderedListRange() {
    var ol = goog.dom.getElement('olTest').firstChild;
    var range = goog.dom.Range.createFromNodeContents(ol);
    assertEquals('Selection should have correct html fragment',
        '1<li>2', normalizeHtml(range.getHtmlFragment()));

    // TODO(robbyw): On IE the OL is included, on FF it is not.
    //assertEquals('Selection should have correct valid html',
    //    '<li>1</li><li>2</li>', normalizeHtml(range.getValidHtml()));

    assertEquals('Selection should have correct pastable html',
        '<ol><li>1<li>2</ol>',
        normalizeHtml(range.getPastableHtml()));
  }

  function testCreateFromNodes() {
    var start = goog.dom.getElement('test1').firstChild;
    var end = goog.dom.getElement('br');
    var range = goog.dom.Range.createFromNodes(start, 2, end, 0);
    assertNotNull('Browser range object can be created for W3C node range',
        range);

    assertEquals('Start node should be selected at start endpoint', start,
        range.getStartNode());
    assertEquals('Selection should start at offset 2', 2,
        range.getStartOffset());
    assertEquals('Start node should be selected at anchor endpoint', start,
        range.getAnchorNode());
    assertEquals('Selection should be anchored at offset 2', 2,
        range.getAnchorOffset());

    var div = goog.dom.getElement('test2');
    assertEquals('DIV node should be selected at end endpoint', div,
        range.getEndNode());
    assertEquals('Selection should end at offset 1', 1, range.getEndOffset());
    assertEquals('DIV node should be selected at focus endpoint', div,
        range.getFocusNode());
    assertEquals('Selection should be focused at offset 1', 1,
        range.getFocusOffset());


    assertTrue('Text content should be "xt\\s*abc"',
        /xt\s*abc/.test(range.getText()));
    assertFalse('Nodes range is not collapsed', range.isCollapsed());
  }


  function testCreateControlRange() {
    if (!goog.userAgent.IE) {
      return;
    }
    var cr = document.body.createControlRange();
    cr.addElement(goog.dom.getElement('logo'));

    var range = goog.dom.Range.createFromBrowserRange(cr);
    assertNotNull('Control range object can be created from browser range',
        range);
    assertEquals('Created range is a control range', goog.dom.RangeType.CONTROL,
        range.getType());
  }


  function testTextNode() {
    var range = goog.dom.Range.createFromNodeContents(
        goog.dom.getElement('test1').firstChild);

    assertEquals('Created range is a text range', goog.dom.RangeType.TEXT,
        range.getType());
    assertEquals('Text node should be selected at start endpoint', 'Text',
        range.getStartNode().nodeValue);
    assertEquals('Selection should start at offset 0', 0,
        range.getStartOffset());

    assertEquals('Text node should be selected at end endpoint', 'Text',
        range.getEndNode().nodeValue);
    assertEquals('Selection should end at offset 4', 'Text'.length,
        range.getEndOffset());

    assertEquals('Container should be text node', goog.dom.NodeType.TEXT,
        range.getContainer().nodeType);

    assertEquals('Text content should be "Text"', 'Text', range.getText());
    assertFalse('Text range is not collapsed', range.isCollapsed());
  }


  function testDiv() {
    var range = goog.dom.Range.createFromNodeContents(
        goog.dom.getElement('test2'));

    assertEquals('Text node "abc" should be selected at start endpoint', 'abc',
        range.getStartNode().nodeValue);
    assertEquals('Selection should start at offset 0', 0,
        range.getStartOffset());

    assertEquals('Text node "def" should be selected at end endpoint', 'def',
        range.getEndNode().nodeValue);
    assertEquals('Selection should end at offset 3', 'def'.length,
        range.getEndOffset());

    assertEquals('Container should be DIV', goog.dom.getElement('test2'),
        range.getContainer());

    assertTrue('Div text content should be "abc\\s*def"',
        /abc\s*def/.test(range.getText()));
    assertFalse('Div range is not collapsed', range.isCollapsed());
  }


  function testEmptyNode() {
    var range = goog.dom.Range.createFromNodeContents(
        goog.dom.getElement('empty'));

    assertEquals('DIV be selected at start endpoint',
        goog.dom.getElement('empty'), range.getStartNode());
    assertEquals('Selection should start at offset 0', 0,
        range.getStartOffset());

    assertEquals('DIV should be selected at end endpoint',
        goog.dom.getElement('empty'), range.getEndNode());
    assertEquals('Selection should end at offset 0', 0,
        range.getEndOffset());

    assertEquals('Container should be DIV', goog.dom.getElement('empty'),
        range.getContainer());

    assertEquals('Empty text content should be ""', '', range.getText());
    assertTrue('Empty range is collapsed', range.isCollapsed());
  }


  function testCollapse() {
    var range = goog.dom.Range.createFromNodeContents(
        goog.dom.getElement('test2'));
    assertFalse('Div range is not collapsed', range.isCollapsed());
    range.collapse();
    assertTrue('Div range is collapsed after call to empty()',
        range.isCollapsed());

    range = goog.dom.Range.createFromNodeContents(goog.dom.getElement('empty'));
    assertTrue('Empty range is collapsed', range.isCollapsed());
    range.collapse();
    assertTrue('Empty range is still collapsed', range.isCollapsed());
  }

  // TODO(robbyw): Test iteration over a strange document fragment.

  function testIterator() {
    goog.testing.dom.assertNodesMatch(goog.dom.Range.createFromNodeContents(
        goog.dom.getElement('test2')), ['abc', '#br', '#br', 'def']);
  }

  function testReversedNodes() {
    var node = goog.dom.getElement('test1').firstChild;
    var range = goog.dom.Range.createFromNodes(node, 4, node, 0);
    assertTrue('Range is reversed', range.isReversed());
    node = goog.dom.getElement('test3');
    range = goog.dom.Range.createFromNodes(node, 0, node, 1);
    assertFalse('Range is not reversed', range.isReversed());
  }

  function testReversedContents() {
    var range = goog.dom.Range.createFromNodeContents(
        goog.dom.getElement('test1'), true);
    assertTrue('Range is reversed', range.isReversed());
    assertEquals('Range should select "Text"', 'Text',
        range.getText());
    assertEquals('Range start offset should be 0', 0, range.getStartOffset());
    assertEquals('Range end offset should be 4', 4, range.getEndOffset());
    assertEquals('Range anchor offset should be 4', 4, range.getAnchorOffset());
    assertEquals('Range focus offset should be 0', 0, range.getFocusOffset());

    var range2 = range.clone();

    range.collapse(true);
    assertTrue('Range is collapsed', range.isCollapsed());
    assertFalse('Collapsed range is not reversed', range.isReversed());
    assertEquals('Post collapse start offset should be 4', 4,
        range.getStartOffset());

    range2.collapse(false);
    assertTrue('Range 2 is collapsed', range2.isCollapsed());
    assertFalse('Collapsed range 2 is not reversed', range2.isReversed());
    assertEquals('Post collapse start offset 2 should be 0', 0,
        range2.getStartOffset());
  }

  function testRemoveContents() {
    var outer = goog.dom.getElement('removeTest');
    var range = goog.dom.Range.createFromNodeContents(outer.firstChild);

    range.removeContents();

    assertEquals('Removed range content should be ""', '', range.getText());
    assertTrue('Removed range should be collapsed', range.isCollapsed());
    assertEquals('Outer div should have 1 child now', 1,
        outer.childNodes.length);
    assertEquals('Inner div should be empty', 0,
        outer.firstChild.childNodes.length);
  }

  function testRemovePartialContents() {
    var outer = goog.dom.getElement('removePartialTest');

    var range = goog.dom.Range.createFromNodes(outer.firstChild, 2,
        outer.firstChild, 4);
    removeHelper(1, range, outer, 1, '0145');

    range = goog.dom.Range.createFromNodes(outer.firstChild, 0,
        outer.firstChild, 1);
    removeHelper(2, range, outer, 1, '145');

    range = goog.dom.Range.createFromNodes(outer.firstChild, 2,
        outer.firstChild, 3);
    removeHelper(3, range, outer, 1, '14');

    var br = goog.dom.createDom('BR');
    outer.appendChild(br);
    range = goog.dom.Range.createFromNodes(outer.firstChild, 1,
        outer, 1);
    removeHelper(4, range, outer, 2, '1<br>');

    outer.innerHTML = '<br>123';
    range = goog.dom.Range.createFromNodes(outer, 0, outer.lastChild, 2);
    removeHelper(5, range, outer, 1, '3');

    outer.innerHTML = '123<br>456';
    range = goog.dom.Range.createFromNodes(outer.firstChild, 1, outer.lastChild,
        2);
    removeHelper(6, range, outer, 2, '16');

    outer.innerHTML = '123<br>456';
    range = goog.dom.Range.createFromNodes(outer.firstChild, 0, outer.lastChild,
        2);
    removeHelper(7, range, outer, 1, '6');

    outer.innerHTML = '<div></div>';
    range = goog.dom.Range.createFromNodeContents(outer.firstChild);
    removeHelper(8, range, outer, 1, '<div></div>');

    // TODO(robbyw): Fix the following edge cases:
    //    * Selecting contents of a node containing multiply empty divs
    //    * Selecting via createFromNodes(x, 0, x, x.childNodes.length)
    //    * Consistent handling of nodeContents(<div><div></div></div>).remove
  }

  function removeHelper(testNumber, range, outer, expectedChildCount,
      expectedContent) {
    range.removeContents();
    assertTrue(testNumber + ': Removed range should now be collapsed',
        range.isCollapsed());
    assertEquals(testNumber + ': Removed range content should be ""', '',
        range.getText());
    assertEquals(testNumber + ': Outer div should contain correct text',
        expectedContent, outer.innerHTML.toLowerCase());
    assertEquals(testNumber + ': Outer div should have ' + expectedChildCount +
        ' children now', expectedChildCount, outer.childNodes.length);
    assertNotNull(testNumber + ': Empty node should still exist',
        goog.dom.getElement('empty'));
  }

  function testSurroundContents() {
    var outer = goog.dom.getElement('surroundTest');
    outer.innerHTML = '---Text that<br/>will be surrounded---';
    var range = goog.dom.Range.createFromNodes(outer.firstChild, 3,
        outer.lastChild, outer.lastChild.nodeValue.length - 3);

    var div = goog.dom.createDom(goog.dom.TagName.DIV, {'style': 'color: red'});
    var output = range.surroundContents(div);

    assertEquals('Outer element should contain new element', outer,
        output.parentNode);
    assertFalse('New element should have no id', !!output.id);
    assertEquals('New element should be red', 'red', output.style.color);
    assertEquals('Outer element should have three children', 3,
        outer.childNodes.length);
    assertEquals('New element should have three children', 3,
        output.childNodes.length);

    // TODO(robbyw): Ensure the range stays in a reasonable state.
  }

  /**
   * Given two offsets into the 'foobar' node, make sure that inserting
   * nodes at those offsets doesn't change a selection of 'oba'.
   * @bug 1480638
   */
  function assertSurroundDoesntChangeSelectionWithOffsets(
      offset1, offset2, expectedHtml) {
    var div = goog.dom.getElement('bug1480638');
    div.innerHTML = 'foobar';
    var rangeToSelect = goog.dom.Range.createFromNodes(
        div.firstChild, 2, div.firstChild, 5);
    rangeToSelect.select();

    var rangeToSurround = goog.dom.Range.createFromNodes(
        div.firstChild, offset1, div.firstChild, offset2);
    rangeToSurround.surroundWithNodes(goog.dom.createDom('span'),
        goog.dom.createDom('span'));

    // Make sure that the selection didn't change.
    assertHTMLEquals('Selection must not change when contents are surrounded.',
        expectedHtml, goog.dom.Range.createFromWindow().getHtmlFragment());
  }

  function testSurroundWithNodesDoesntChangeSelection1() {
    assertSurroundDoesntChangeSelectionWithOffsets(3, 4,
        'o<span></span>b<span></span>a');
  }

  function testSurroundWithNodesDoesntChangeSelection2() {
    assertSurroundDoesntChangeSelectionWithOffsets(3, 6,
        'o<span></span>ba');
  }

  function testSurroundWithNodesDoesntChangeSelection3() {
    assertSurroundDoesntChangeSelectionWithOffsets(1, 3,
        'o<span></span>ba');
  }

  function testSurroundWithNodesDoesntChangeSelection4() {
    assertSurroundDoesntChangeSelectionWithOffsets(1, 6,
        'oba');
  }

  function testInsertNode() {
    var outer = goog.dom.getElement('insertTest');
    outer.innerHTML = 'ACD';

    var range = goog.dom.Range.createFromNodes(outer.firstChild, 1,
        outer.firstChild, 2);
    range.insertNode(goog.dom.createTextNode('B'), true);
    assertEquals('Element should have correct innerHTML', 'ABCD',
        outer.innerHTML);

    outer.innerHTML = '12';
    range = goog.dom.Range.createFromNodes(outer.firstChild, 0,
        outer.firstChild, 1);
    var br = range.insertNode(goog.dom.createDom(goog.dom.TagName.BR), false);
    assertEquals('New element should have correct innerHTML', '1<br>2',
        outer.innerHTML.toLowerCase());
    assertEquals('BR should be in outer', outer, br.parentNode);
  }

  function testReplaceContentsWithNode() {
    var outer = goog.dom.getElement('insertTest');
    outer.innerHTML = 'AXC';

    var range = goog.dom.Range.createFromNodes(outer.firstChild, 1,
        outer.firstChild, 2);
    range.replaceContentsWithNode(goog.dom.createTextNode('B'));
    assertEquals('Element should have correct innerHTML', 'ABC',
        outer.innerHTML);

    outer.innerHTML = 'ABC';
    range = goog.dom.Range.createFromNodes(outer.firstChild, 3,
        outer.firstChild, 3);
    range.replaceContentsWithNode(goog.dom.createTextNode('D'));
    assertEquals(
        'Element should have correct innerHTML after collapsed replace',
        'ABCD', outer.innerHTML);

    outer.innerHTML = 'AX<b>X</b>XC';
    range = goog.dom.Range.createFromNodes(outer.firstChild, 1,
        outer.lastChild, 1);
    range.replaceContentsWithNode(goog.dom.createTextNode('B'));
    goog.testing.dom.assertHtmlContentsMatch('ABC', outer);
  }

  function testSurroundWithNodes() {
    var outer = goog.dom.getElement('insertTest');
    outer.innerHTML = 'ACE';
    var range = goog.dom.Range.createFromNodes(outer.firstChild, 1,
        outer.firstChild, 2);

    range.surroundWithNodes(goog.dom.createTextNode('B'),
        goog.dom.createTextNode('D'));

    assertEquals('New element should have correct innerHTML', 'ABCDE',
        outer.innerHTML);
  }

  function testIsRangeInDocument() {
    var outer = goog.dom.getElement('insertTest');
    outer.innerHTML = '<br>ABC';
    var range = goog.dom.Range.createCaret(outer.lastChild, 1);

    assertEquals('Should get correct start element', 'ABC',
        range.getStartNode().nodeValue);
    assertTrue('Should be considered in document', range.isRangeInDocument());

    outer.innerHTML = 'DEF';

    assertFalse('Should be marked as out of document',
        range.isRangeInDocument());
  }

  function testRemovedNode() {
    var node = goog.dom.getElement('removeNodeTest');
    var range = goog.dom.browserrange.createRangeFromNodeContents(node);
    range.select();
    goog.dom.removeNode(node);

    var newRange = goog.dom.Range.createFromWindow(window);
    if (goog.userAgent.WEBKIT) {
      assertNull('Webkit supports rangeCount == 0', newRange);
    } else {
      assertTrue('The other browsers will just have an empty range.',
          newRange.isCollapsed());
    }
  }

  function testReversedRange() {
    goog.dom.Range.createFromNodes(goog.dom.getElement('test2'), 0,
        goog.dom.getElement('test1'), 0).select();

    var range = goog.dom.Range.createFromWindow(window);
    assertTrue('Range should be reversed',
        goog.userAgent.IE || range.isReversed());
  }

  function testUnreversedRange() {
    goog.dom.Range.createFromNodes(goog.dom.getElement('test1'), 0,
        goog.dom.getElement('test2'), 0).select();

    var range = goog.dom.Range.createFromWindow(window);
    assertFalse('Range should not be reversed', range.isReversed());
  }

  function testReversedThenUnreversedRange() {
    // This tests a workaround for a webkit bug where webkit caches selections
    // incorrectly.
    goog.dom.Range.createFromNodes(goog.dom.getElement('test2'), 0,
        goog.dom.getElement('test1'), 0).select();
    goog.dom.Range.createFromNodes(goog.dom.getElement('test1'), 0,
        goog.dom.getElement('test2'), 0).select();

    var range = goog.dom.Range.createFromWindow(window);
    assertFalse('Range should not be reversed', range.isReversed());
  }

  function testHasAndClearSelection() {
    goog.dom.Range.createFromNodeContents(
        goog.dom.getElement('test1')).select();

    assertTrue('Selection should exist', goog.dom.Range.hasSelection());

    goog.dom.Range.clearSelection();

    assertFalse('Selection should not exist', goog.dom.Range.hasSelection());
  }

  function assertForward(string, startNode, startOffset, endNode, endOffset) {
    var root = goog.dom.getElement('test2');
    var originalInnerHtml = root.innerHTML;

    assertFalse(string, goog.dom.Range.isReversed(startNode, startOffset,
        endNode, endOffset));
    assertTrue(string, goog.dom.Range.isReversed(endNode, endOffset,
        startNode, startOffset));
    assertEquals('Contents should be unaffected after: ' + string,
        root.innerHTML, originalInnerHtml);
  }

  function testIsReversed() {
    var root = goog.dom.getElement('test2');
    var text1 = root.firstChild; // Text content: 'abc'.
    var br = root.childNodes[1];
    var text2 = root.lastChild; // Text content: 'def'.

    assertFalse('Same element position gives false', goog.dom.Range.isReversed(
        root, 0, root, 0));
    assertFalse('Same text position gives false', goog.dom.Range.isReversed(
        text1, 0, text2, 0));
    assertForward('Element offsets should compare against each other',
        root, 0, root, 2);
    assertForward('Text node offsets should compare against each other',
        text1, 0, text2, 2);
    assertForward('Text nodes should compare correctly',
        text1, 0, text2, 0);
    assertForward('Text nodes should compare to later elements',
        text1, 0, br, 0);
    assertForward('Text nodes should compare to earlier elements',
        br, 0, text2, 0);
    assertForward('Parent is before element child', root, 0, br, 0);
    assertForward('Parent is before text child', root, 0, text1, 0);
    assertFalse('Equivalent position gives false', goog.dom.Range.isReversed(
        root, 0, text1, 0));
    assertFalse('Equivalent position gives false', goog.dom.Range.isReversed(
        root, 1, br, 0));
    assertForward('End of element is after children', text1, 0, root, 3);
    assertForward('End of element is after children', br, 0, root, 3);
    assertForward('End of element is after children', text2, 0, root, 3);
    assertForward('End of element is after end of last child',
        text2, 3, root, 3);
  }

  function testSelectAroundSpaces() {
    // set the selection
    var textNode = goog.dom.getElement('textWithSpaces').firstChild;
    goog.dom.TextRange.createFromNodes(
        textNode, 5, textNode, 12).select();

    // get the selection and check that it matches what we set it to
    var range = goog.dom.Range.createFromWindow();
    assertEquals(' world ', range.getText());
    assertEquals(5, range.getStartOffset());
    assertEquals(12, range.getEndOffset());
    assertEquals(textNode, range.getContainer());

    // Check the contents again, because there used to be a bug where
    // it changed after calling getContainer().
    assertEquals(' world ', range.getText());
  }

  function testSelectInsideSpaces() {
    // set the selection
    var textNode = goog.dom.getElement('textWithSpaces').firstChild;
    goog.dom.TextRange.createFromNodes(
        textNode, 6, textNode, 11).select();

    // get the selection and check that it matches what we set it to
    var range = goog.dom.Range.createFromWindow();
    assertEquals('world', range.getText());
    assertEquals(6, range.getStartOffset());
    assertEquals(11, range.getEndOffset());
    assertEquals(textNode, range.getContainer());

    // Check the contents again, because there used to be a bug where
    // it changed after calling getContainer().
    assertEquals('world', range.getText());
  }

  function testRangeBeforeBreak() {
    var container = goog.dom.getElement('rangeAroundBreaks');
    var text = container.firstChild;
    var offset = text.length;
    assertEquals(4, offset);

    var br = container.childNodes[1];
    var caret = goog.dom.Range.createCaret(text, offset);
    caret.select();
    assertEquals(offset, caret.getStartOffset());

    var range = goog.dom.Range.createFromWindow();
    assertFalse('Should not contain whole <br>',
        range.containsNode(br, false));
    if (goog.userAgent.IE) {
      assertTrue('Range over <br> is adjacent to the immediate range before it',
          range.containsNode(br, true));
    } else {
      assertFalse('Should not contain partial <br>',
          range.containsNode(br, true));
    }

    assertEquals(offset, range.getStartOffset());
    assertEquals(text, range.getStartNode());
  }

  function testRangeAfterBreak() {
    var container = goog.dom.getElement('rangeAroundBreaks');
    var br = container.childNodes[1];
    var caret = goog.dom.Range.createCaret(container.lastChild, 0);
    caret.select();
    assertEquals(0, caret.getStartOffset());

    var range = goog.dom.Range.createFromWindow();
    assertFalse('Should not contain whole <br>',
        range.containsNode(br, false));
    var isSafari3 = goog.userAgent.WEBKIT && !goog.userAgent.isVersion('528');

    if (goog.userAgent.IE || isSafari3) {
      assertTrue('Range over <br> is adjacent to the immediate range after it',
          range.containsNode(br, true));
    } else {
      assertFalse('Should not contain partial <br>',
          range.containsNode(br, true));
    }

    if (isSafari3) {
      assertEquals(2, range.getStartOffset());
      assertEquals(container, range.getStartNode());
    } else {
      assertEquals(0, range.getStartOffset());
      assertEquals(container.lastChild, range.getStartNode());
    }
  }

  function testRangeAtBreakAtStart() {
    var container = goog.dom.getElement('breaksAroundNode');
    var br = container.firstChild;
    var caret = goog.dom.Range.createCaret(container.firstChild, 0);
    caret.select();
    assertEquals(0, caret.getStartOffset());

    var range = goog.dom.Range.createFromWindow();
    assertTrue('Range over <br> is adjacent to the immediate range before it',
        range.containsNode(br, true));
    assertFalse('Should not contain whole <br>',
        range.containsNode(br, false));

    assertRangeEquals(container, 0, container, 0, range);
  }

  function assertNodeEquals(expected, actual) {
    assertEquals(
        'Expected: ' + goog.testing.dom.exposeNode(expected) +
        '\nActual: ' + goog.testing.dom.exposeNode(actual),
        expected, actual);
  }
">35 of 35 tests run in 29ms.<br />1 passed, 34 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testCollapse<br />Cannot call method 'createRange' of undefined<br />ERROR in testCreate<br />Cannot call method 'createRange' of undefined<br />ERROR in testCreateFromNodes<br />Cannot read property 'nodeType' of undefined<br />ERROR in testDiv<br />Cannot call method 'createRange' of undefined<br />ERROR in testEmptyNode<br />Cannot call method 'createRange' of undefined<br />ERROR in testHasAndClearSelection<br />Cannot call method 'createRange' of undefined<br />ERROR in testInsertNode<br />Cannot read property 'tagName' of undefined<br />ERROR in testIsRangeInDocument<br />Cannot read property 'tagName' of undefined<br />ERROR in testIsReversed<br />Cannot read property '1' of undefined<br />ERROR in testIterator<br />Cannot call method 'createRange' of undefined<br />ERROR in testOrderedListRange<br />Cannot read property 'nodeType' of undefined<br />ERROR in testRangeAfterBreak<br />Cannot read property '1' of undefined<br />ERROR in testRangeAtBreakAtStart<br />Cannot read property 'tagName' of undefined<br />ERROR in testRangeBeforeBreak<br />Cannot read property 'length' of undefined<br />ERROR in testRemoveContents<br />Cannot read property 'nodeType' of undefined<br />ERROR in testRemovePartialContents<br />Cannot read property 'tagName' of undefined<br />ERROR in testRemovedNode<br />Cannot call method 'createRange' of undefined<br />ERROR in testReplaceContentsWithNode<br />Cannot read property 'tagName' of undefined<br />ERROR in testReversedContents<br />Cannot call method 'createRange' of undefined<br />ERROR in testReversedNodes<br />Cannot read property 'tagName' of undefined<br />ERROR in testReversedRange<br />Cannot call method 'createRange' of undefined<br />ERROR in testReversedThenUnreversedRange<br />Cannot call method 'createRange' of undefined<br />ERROR in testSelectAroundSpaces<br />Cannot read property 'tagName' of undefined<br />ERROR in testSelectInsideSpaces<br />Cannot read property 'tagName' of undefined<br />ERROR in testSurroundContents<br />Cannot read property 'nodeValue' of undefined<br />ERROR in testSurroundWithNodes<br />Cannot read property 'tagName' of undefined<br />ERROR in testSurroundWithNodesDoesntChangeSelection1<br />Cannot read property 'tagName' of undefined<br />ERROR in testSurroundWithNodesDoesntChangeSelection2<br />Cannot read property 'tagName' of undefined<br />ERROR in testSurroundWithNodesDoesntChangeSelection3<br />Cannot read property 'tagName' of undefined<br />ERROR in testSurroundWithNodesDoesntChangeSelection4<br />Cannot read property 'tagName' of undefined<br />ERROR in testTableRange<br />Cannot read property 'nodeType' of undefined<br />ERROR in testTextNode<br />Cannot read property 'nodeType' of undefined<br />ERROR in testUnorderedListRange<br />Cannot read property 'nodeType' of undefined<br />ERROR in testUnreversedRange<br />Cannot call method 'createRange' of undefined<br /></td></tr>
<tr><td>table_test.html</td><td>Fail</td><td> 0 passed, 36 failed.</td><td title="

    goog.require('goog.editor.Table');
    goog.require('goog.testing.jsunit');
  


  function setUp() {
    var inputTables = document.getElementsByTagName('table');
    testElements = {};
    testObjects = {}
    for (var i = 0; i < inputTables.length; i++) {
      var originalTable = inputTables[i];
      if (originalTable.id.substring(0, 5) == 'test-') {
        var tableName = originalTable.id.substring(5);
        var testTable = originalTable.cloneNode(true);
        testTable.id = tableName;
        testElements[tableName] = testTable;
        document.body.appendChild(testTable);
        testObjects[tableName] = new goog.editor.Table(testTable);
      }
    }
  }

  function tearDown() {
    for (var tableName in testElements) {
      document.body.removeChild(testElements[tableName]);
      delete testElements[tableName];
      delete testObjects[tableName];
    }
    testElements = null;
    testObjects = null;
  }

  // These tests don't pass on Safari, because the table editor only works
  // on IE and FF right now.
  // TODO(nicksantos): Fix this.
  if (!goog.userAgent.WEBKIT) {

  function tableSanityCheck(editableTable, rowCount, colCount) {
    assertEquals('Table has expected number of rows',
        rowCount, editableTable.rows.length);
    for (var i = 0, row; row = editableTable.rows[i]; i++) {
      assertEquals('Row ' + i + ' has expected number of columns',
          colCount, row.columns.length);
    }
  }

  function testBasicTable() {
    // Do some basic sanity checking on the editable table structure
    tableSanityCheck(testObjects.basic, 4, 3);
    var originalRows = testElements.basic.getElementsByTagName('tr');
    assertEquals('Basic table row count, compared to source',
        originalRows.length, testObjects.basic.rows.length);
    assertEquals('Basic table row count, known value',
        4, testObjects.basic.rows.length);
    assertEquals('Basic table first row element',
        originalRows[0], testObjects.basic.rows[0].element);
    assertEquals('Basic table last row element',
        originalRows[3], testObjects.basic.rows[3].element);
    assertEquals('Basic table first row length',
        3, testObjects.basic.rows[0].columns.length);
    assertEquals('Basic table last row length',
        3, testObjects.basic.rows[3].columns.length);
  }

  function testTortureTable() {
    // Do basic sanity checking on torture table structure
    tableSanityCheck(testObjects.torture, 9, 3);
    var originalRows = testElements.torture.getElementsByTagName('tr');
    assertEquals('Torture table row count, compared to source',
        originalRows.length, testObjects.torture.rows.length);
    assertEquals('Torture table row count, known value',
        9, testObjects.torture.rows.length);
  }

  function _testInsertRowResult(element, editableTable,  newTr, index) {
    if (element == testElements.basic) {
      originalRowCount = 4;
    } else if (element == testElements.torture) {
      originalRowCount = 9;
    }

    assertEquals('Row was added to table',
        originalRowCount + 1, element.getElementsByTagName('tr').length);
    assertEquals('Row was added at position ' + index,
        element.getElementsByTagName('tr')[index], newTr);
    assertEquals('Row knows its own position',
        index, editableTable.rows[index].index);
    assertEquals('EditableTable shows row at position ' + index,
        newTr, editableTable.rows[index].element);
    assertEquals('New row has correct number of TDs',
        3, newTr.getElementsByTagName('td').length);
  }

  function testInsertRowAtBeginning() {
    var tr = testObjects.basic.insertRow(0);
    _testInsertRowResult(testElements.basic, testObjects.basic, tr, 0);
  }

  function testInsertRowInMiddle() {
    var tr = testObjects.basic.insertRow(2);
    _testInsertRowResult(testElements.basic, testObjects.basic, tr, 2);
  }

  function testInsertRowAtEnd() {
    assertEquals('Table has expected number of existing rows',
        4, testObjects.basic.rows.length);
    var tr = testObjects.basic.insertRow(4);
    _testInsertRowResult(testElements.basic, testObjects.basic, tr, 4);
  }

  function testInsertRowAtEndNoIndexArgument() {
    assertEquals('Table has expected number of existing rows',
        4, testObjects.basic.rows.length);
    var tr = testObjects.basic.insertRow();
    _testInsertRowResult(testElements.basic, testObjects.basic, tr, 4);
  }

  function testInsertRowAtBeginningRowspan() {
    // Test inserting a row when the existing DOM row at that index has
    // a cell with a rowspan. This should be just like a regular insert -
    // the rowspan shouldn't have any effect.
    assertEquals('Cell has starting rowspan',
        2,
        goog.dom.getFirstElementChild(
            testElements.torture.getElementsByTagName('tr')[0]).rowSpan);
    var tr = testObjects.torture.insertRow(0);
    // Among other things this verifies that the new row has 3 child TDs.
    _testInsertRowResult(testElements.torture, testObjects.torture, tr, 0);
  }

  function testInsertRowAtEndingRowspan() {
    // Test inserting a row when there's a cell in a previous DOM row
    // with a rowspan that extends into the row with the given index
    // and ends there. This should be just like a regular insert -
    // the rowspan shouldn't have any effect.
    assertEquals('Cell has ending rowspan',
        4,
        goog.dom.getLastElementChild(
            testElements.torture.getElementsByTagName('tr')[5]).rowSpan);
    var tr = testObjects.torture.insertRow();
    // Among other things this verifies that the new row has 3 child TDs.
    _testInsertRowResult(testElements.torture, testObjects.torture, tr, 9);
  }

  function testInsertRowAtSpanningRowspan() {
    // Test inserting a row at an index where there's a cell with a rowspan
    // that begins in a previous row and continues into the next row. In this
    // case the existing cell's rowspan should be extended, and the new
    // tr should have one less child element.
    var rowSpannedCell = testObjects.torture.rows[7].columns[2];
    assertTrue('Existing cell has overlapping rowspan',
       rowSpannedCell.startRow == 5 && rowSpannedCell.endRow == 8);
    var tr = testObjects.torture.insertRow(7);
    assertEquals('New DOM row has one less cell',
        2, tr.getElementsByTagName('td').length);
    assertEquals('Rowspanned cell listed in new EditableRow\'s columns',
        testObjects.torture.rows[6].columns[2].element,
        testObjects.torture.rows[7].columns[2].element)
  }

  function _testInsertColumnResult(newCells, element, editableTable, index) {
    for (var rowNo = 0, row; row = editableTable.rows[rowNo]; rowNo++) {
      assertEquals('Row includes new column',
        4, row.columns.length);
    }
    assertEquals('New cell in correct position',
      newCells[0], editableTable.rows[0].columns[index].element);
  }

  function testInsertColumnAtBeginning() {
    var startColCount = testObjects.basic.rows[0].columns.length;
    var newCells = testObjects.basic.insertColumn(0);
    assertEquals('New cell added for each row',
        testObjects.basic.rows.length, newCells.length);
    assertEquals('Insert column incremented column length',
        startColCount + 1, testObjects.basic.rows[0].columns.length);
    _testInsertColumnResult(newCells, testElements.basic, testObjects.basic, 0);
  }

  function testInsertColumnAtEnd() {
    var startColCount = testObjects.basic.rows[0].columns.length;
    var newCells = testObjects.basic.insertColumn(3);
    assertEquals('New cell added for each row',
        testObjects.basic.rows.length, newCells.length);
    assertEquals('Insert column incremented column length',
        startColCount + 1, testObjects.basic.rows[0].columns.length);
    _testInsertColumnResult(newCells, testElements.basic, testObjects.basic, 3);
  }

  function testInsertColumnAtEndNoIndexArgument() {
    var startColCount = testObjects.basic.rows[0].columns.length;
    var newCells = testObjects.basic.insertColumn();
    assertEquals('New cell added for each row',
        testObjects.basic.rows.length, newCells.length);
    assertEquals('Insert column incremented column length',
        startColCount + 1, testObjects.basic.rows[0].columns.length);
    _testInsertColumnResult(newCells, testElements.basic, testObjects.basic, 3);
  }

  function testInsertColumnInMiddle() {
    var startColCount = testObjects.basic.rows[0].columns.length;
    var newCells = testObjects.basic.insertColumn(2);
    assertEquals('New cell added for each row',
        testObjects.basic.rows.length, newCells.length);
    assertEquals('Insert column incremented column length',
        startColCount + 1, testObjects.basic.rows[0].columns.length);
    _testInsertColumnResult(newCells, testElements.basic, testObjects.basic, 2);
  }

  function testInsertColumnAtBeginning() {
    var startColCount = testObjects.basic.rows[0].columns.length;
    var newCells = testObjects.basic.insertColumn(0);
    assertEquals('Insert column incremented column length',
        startColCount + 1, testObjects.basic.rows[0].columns.length);
    _testInsertColumnResult(newCells, testElements.basic, testObjects.basic, 0);
  }

  function testInsertColumnAtBeginningColSpan() {
    var cells = testObjects.torture.insertColumn(0);
    tableSanityCheck(testObjects.torture, 9, 4);
    assertEquals('New cell was added before colspanned cell',
        1, testObjects.torture.rows[3].columns[0].colSpan);
    assertEquals('New cell was added and returned',
        testObjects.torture.rows[3].columns[0].element,
        cells[3]);
  }

  function testInsertColumnAtEndingColSpan() {
    var cells = testObjects.torture.insertColumn();
    tableSanityCheck(testObjects.torture, 9, 4);
    assertEquals('New cell was added after colspanned cell',
        1, testObjects.torture.rows[0].columns[3].colSpan);
    assertEquals('New cell was added and returned',
        testObjects.torture.rows[0].columns[3].element,
        cells[0]);
  }

  function testInsertColumnAtSpanningColSpan() {
    assertEquals('Existing cell has expected colspan',
        3, testObjects.torture.rows[4].columns[1].colSpan);
    var cells = testObjects.torture.insertColumn(1);
    tableSanityCheck(testObjects.torture, 9, 4);
    assertEquals('Existing cell increased colspan',
        4, testObjects.torture.rows[4].columns[1].colSpan);
    assertEquals('3 cells weren\'t created due to existing colspans',
        6, cells.length);
  }

  function testRemoveFirstRow() {
    var originalRow = testElements.basic.getElementsByTagName('tr')[0];
    testObjects.basic.removeRow(0);
    tableSanityCheck(testObjects.basic, 3, 3);
    assertNotEquals('Row was removed from table element',
        originalRow, testElements.basic.getElementsByTagName('tr')[0]);
  }

  function testRemoveLastRow() {
    var originalRow = testElements.basic.getElementsByTagName('tr')[3];
    testObjects.basic.removeRow(3);
    tableSanityCheck(testObjects.basic, 3, 3);
    assertNotEquals('Row was removed from table element',
        originalRow, testElements.basic.getElementsByTagName('tr')[3]);
  }

  function testRemoveMiddleRow() {
    var originalRow = testElements.basic.getElementsByTagName('tr')[2];
    testObjects.basic.removeRow(2);
    tableSanityCheck(testObjects.basic, 3, 3);
    assertNotEquals('Row was removed from table element',
        originalRow, testElements.basic.getElementsByTagName('tr')[2]);
  }

  function testRemoveRowAtBeginingRowSpan() {
    var originalRow = testObjects.torture.removeRow(0);
    tableSanityCheck(testObjects.torture, 8, 3);
    assertNotEquals('Row was removed from table element',
        originalRow, testElements.basic.getElementsByTagName('tr')[0]);
    assertEquals('Rowspan correctly adjusted',
        1, testObjects.torture.rows[0].columns[0].rowSpan);
  }

  function testRemoveRowAtEndingRowSpan() {
    var originalRow = testElements.torture.getElementsByTagName('tr')[8];
    testObjects.torture.removeRow(8);
    tableSanityCheck(testObjects.torture, 8, 3);
    assertNotEquals('Row was removed from table element',
        originalRow, testElements.basic.getElementsByTagName('tr')[8]);
    assertEquals('Rowspan correctly adjusted',
        3, testObjects.torture.rows[7].columns[2].rowSpan);
  }

  function testRemoveRowAtSpanningRowSpan() {
    var originalRow = testElements.torture.getElementsByTagName('tr')[7];
    testObjects.torture.removeRow(7);
    tableSanityCheck(testObjects.torture, 8, 3);
    assertNotEquals('Row was removed from table element',
        originalRow, testElements.basic.getElementsByTagName('tr')[7]);
    assertEquals('Rowspan correctly adjusted',
        3, testObjects.torture.rows[6].columns[2].rowSpan);
  }

  function _testRemoveColumn(index) {
    var sampleCell = testElements.basic.getElementsByTagName(
        'tr')[0].getElementsByTagName('th')[index];
    testObjects.basic.removeColumn(index);
    tableSanityCheck(testObjects.basic, 4, 2);
    assertNotEquals(
        'Test cell removed from column',
        sampleCell,
        testElements.basic.getElementsByTagName(
            'tr')[0].getElementsByTagName('th')[index]);
  }

  function testRemoveFirstColumn() {
    _testRemoveColumn(0);
  }

  function testRemoveMiddleColumn() {
    _testRemoveColumn(1);
  }

  function testRemoveLastColumn() {
    _testRemoveColumn(2);
  }

  function testRemoveColumnAtStartingColSpan() {
    testObjects.torture.removeColumn(0);
    tableSanityCheck(testObjects.torture, 9, 2);
    assertEquals('Colspan was decremented correctly',
      1,
      testElements.torture.getElementsByTagName(
          'tr')[5].getElementsByTagName('th')[0].colSpan);
  }

  function testRemoveColumnAtEndingColSpan() {
    testObjects.torture.removeColumn(2);
    tableSanityCheck(testObjects.torture, 9, 2);
    assertEquals('Colspan was decremented correctly',
      1,
      testElements.torture.getElementsByTagName(
          'tr')[1].getElementsByTagName('td')[0].colSpan);
  }

  function testRemoveColumnAtSpanningColSpan() {
    testObjects.torture.removeColumn(2);
    tableSanityCheck(testObjects.torture, 9, 2);
    assertEquals('Colspan was decremented correctly',
      2,
      testElements.torture.getElementsByTagName(
          'tr')[4].getElementsByTagName('th')[0].colSpan);
  }

  function testMergeCellsInRow() {
    testObjects.basic.mergeCells(0, 0, 0, 2);
    tableSanityCheck(testObjects.basic, 4, 3);
    var trs = testElements.basic.getElementsByTagName('tr');
    assertEquals('Cells merged',
        1, trs[0].getElementsByTagName('th').length);
    assertEquals('Merged cell has correct colspan',
        3, trs[0].getElementsByTagName('th')[0].colSpan);
    assertEquals('Merged cell has correct rowspan',
        1, trs[0].getElementsByTagName('th')[0].rowSpan);
  }

  function testMergeCellsInColumn() {
    testObjects.basic.mergeCells(0, 0, 2, 0);
    tableSanityCheck(testObjects.basic, 4, 3);
    var trs = testElements.basic.getElementsByTagName('tr');
    assertEquals('Other cells still in row',
        3, trs[0].getElementsByTagName('th').length);
    assertEquals('Merged cell has correct colspan',
        1, trs[0].getElementsByTagName('th')[0].colSpan);
    assertEquals('Merged cell has correct rowspan',
        3, trs[0].getElementsByTagName('th')[0].rowSpan);
    assert('Cell appears in multiple rows after merge',
        testObjects.basic.rows[0].columns[0] ==
        testObjects.basic.rows[2].columns[0]);
  }

  function testMergeCellsInRowAndColumn() {
    testObjects.basic.mergeCells(1, 1, 3, 2);
    tableSanityCheck(testObjects.basic, 4, 3);
    var trs = testElements.basic.getElementsByTagName('tr');
    var mergedCell = trs[1].getElementsByTagName('td')[1];
    assertEquals('Merged cell has correct rowspan',
        3, mergedCell.rowSpan);
    assertEquals('Merged cell has correct colspan',
        2, mergedCell.colSpan);
  }

  function testMergeCellsAlreadyMerged() {
    testObjects.torture.mergeCells(5, 0, 8, 2);
    tableSanityCheck(testObjects.torture, 9, 3);
    var trs = testElements.torture.getElementsByTagName('tr');
    var mergedCell = trs[5].getElementsByTagName('th')[0];
    assertEquals('Merged cell has correct rowspan',
        4, mergedCell.rowSpan);
    assertEquals('Merged cell has correct colspan',
        3, mergedCell.colSpan);
  }

  function testIllegalMergeNonRectangular() {
    // This should fail because it involves trying to merge two parts
    // of a 3-colspan cell with other cells
    var mergeSucceeded = testObjects.torture.mergeCells(3, 1, 5, 2);
    if (mergeSucceeded) {
      throw 'EditableTable allowed impossible merge!';
    }
    tableSanityCheck(testObjects.torture, 9, 3);
  }

  function testIllegalMergeSingleCell() {
    // This should fail because it involves merging a single cell
    var mergeSucceeded = testObjects.torture.mergeCells(0, 1, 0, 1);
    if (mergeSucceeded) {
      throw 'EditableTable allowed impossible merge!';
    }
    tableSanityCheck(testObjects.torture, 9, 3);
  }

  function testSplitCell() {
    testObjects.torture.splitCell(1, 1);
    tableSanityCheck(testObjects.torture, 9, 3);
    var trs = testElements.torture.getElementsByTagName('tr');
    assertEquals('Cell was split into multiple columns in row 1',
      3, trs[1].getElementsByTagName('*').length);
    assertEquals('Cell was split into multiple columns in row 2',
      3, trs[2].getElementsByTagName('*').length);
  }

  function testChildTableRowsNotCountedInParentTable() {
    tableSanityCheck(testObjects.nested, 2, 3);
    for (var i = 0; i < testObjects.nested.rows.length; i++) {
      var tr = testObjects.nested.rows[i].element;
      // A tr's parent is tbody, parent of that is table - check to
      // make sure the ancestor table is as expected. This means
      // that none of the child table's rows have been erroneously
      // loaded into the EditableTable.
      assertEquals('Row is child of parent table',
                   testElements.nested,
                   tr.parentNode.parentNode);
    }
  }

  }

  

/*
  // TODO(user): write more unit tests for selection stuff.
  // The following code is left in here for reference in implementing
  // this TODO.

    var tds = goog.dom.getElement('test1').getElementsByTagName('td');
    var range = goog.dom.Range.createFromNodes(tds[7], tds[9]);
    range.select();
    var cellSelection = new goog.editor.Table.CellSelection(range);
    assertEquals(0, cellSelection.getFirstColumnIndex());
    assertEquals(2, cellSelection.getLastColumnIndex());
    assertEquals(2, cellSelection.getFirstRowIndex());
    assertEquals(2, cellSelection.getLastRowIndex());
    assertTrue(cellSelection.isRectangle());

    range = goog.dom.Range.createFromNodes(tds[7], tds[12]);
    range.select();
    var cellSelection2 = new goog.editor.Table.CellSelection(range);
    assertFalse(cellSelection2.isRectangle());
*/
  ">36 of 36 tests run in 28ms.<br />0 passed, 36 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testBasicTable<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testChildTableRowsNotCountedInParentTable<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testIllegalMergeNonRectangular<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testIllegalMergeSingleCell<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testInsertColumnAtBeginning<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testInsertColumnAtBeginningColSpan<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testInsertColumnAtEnd<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testInsertColumnAtEndNoIndexArgument<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testInsertColumnAtEndingColSpan<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testInsertColumnAtSpanningColSpan<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testInsertColumnInMiddle<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testInsertRowAtBeginning<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testInsertRowAtBeginningRowspan<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testInsertRowAtEnd<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testInsertRowAtEndNoIndexArgument<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testInsertRowAtEndingRowspan<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testInsertRowAtSpanningRowspan<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testInsertRowInMiddle<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testMergeCellsAlreadyMerged<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testMergeCellsInColumn<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testMergeCellsInRow<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testMergeCellsInRowAndColumn<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testRemoveColumnAtEndingColSpan<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testRemoveColumnAtSpanningColSpan<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testRemoveColumnAtStartingColSpan<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testRemoveFirstColumn<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testRemoveFirstRow<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testRemoveLastColumn<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testRemoveLastRow<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testRemoveMiddleColumn<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testRemoveMiddleRow<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testRemoveRowAtBeginingRowSpan<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testRemoveRowAtEndingRowSpan<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testRemoveRowAtSpanningRowSpan<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testSplitCell<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testTortureTable<br />Object #<Object> has no method 'getElementsByTagName'<br /></td></tr>
<tr><td>seamlessfield_test.js</td><td>Fail</td><td> 0 passed, 14 failed.</td><td title="// Copyright 2009 The Closure Library Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS-IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Trogedit unit tests for goog.editor.SeamlessField.
 *
 * @author nicksantos@google.com (Nick Santos)
 * @suppress {missingProperties} There are many mocks in this unit test,
 *     and the mocks don't fit well in the type system.
 */

goog.provide('goog.editor.seamlessfield_test');

goog.require('goog.dom');
goog.require('goog.editor.BrowserFeature');
goog.require('goog.editor.SeamlessField');
goog.require('goog.events');
goog.require('goog.style');
goog.require('goog.testing.MockClock');
goog.require('goog.testing.MockRange');
goog.require('goog.testing.jsunit');


var fieldElem;
var fieldElemClone;

function setUp() {
  fieldElem = goog.dom.getElement('field');
  fieldElemClone = fieldElem.cloneNode(true);
}

function tearDown() {
  fieldElem.parentNode.replaceChild(fieldElemClone, fieldElem);
}

// the following tests check for blended iframe positioning. They really
// only make sense on browsers without contentEditable.
function testBlankField() {
  if (!goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE) {
    assertAttachSeamlessIframeSizesCorrectly(
        initSeamlessField('&nbsp;', {}), createSeamlessIframe());
  }
}

function testFieldWithContent() {
  if (!goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE) {
    assertAttachSeamlessIframeSizesCorrectly(
        initSeamlessField('Hi!', {}), createSeamlessIframe());
  }
}

function testFieldWithPadding() {
  if (!goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE) {
    assertAttachSeamlessIframeSizesCorrectly(
        initSeamlessField('Hi!', {'padding': '2px 5px'}),
        createSeamlessIframe());
  }
}

function testFieldWithMargin() {
  if (!goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE) {
    assertAttachSeamlessIframeSizesCorrectly(
        initSeamlessField('Hi!', {'margin': '2px 5px'}),
        createSeamlessIframe());
  }
}

function testFieldWithBorder() {
  if (!goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE) {
    assertAttachSeamlessIframeSizesCorrectly(
        initSeamlessField('Hi!', {'border': '2px 5px'}),
        createSeamlessIframe());
  }
}

function testFieldWithOverflow() {
  if (!goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE) {
    assertAttachSeamlessIframeSizesCorrectly(
        initSeamlessField(['1', '2', '3', '4', '5', '6', '7'].join('<p/>'),
        {'overflow': 'auto', 'position': 'relative', 'height': '20px'}),
        createSeamlessIframe());
    assertEquals(20, fieldElem.offsetHeight);
  }
}

function testFieldWithOverflowAndPadding() {
  if (!goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE) {
    var blendedField = initSeamlessField(
        ['1', '2', '3', '4', '5', '6', '7'].join('<p/>'),
        {
          'overflow': 'auto',
          'position': 'relative',
          'height': '20px',
          'padding': '2px 3px'
        });
    var blendedIframe = createSeamlessIframe();
    assertAttachSeamlessIframeSizesCorrectly(blendedField, blendedIframe);
    assertEquals(24, fieldElem.offsetHeight);
  }
}

function testIframeHeightGrowsOnWrap() {
  if (!goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE) {
    var clock = new goog.testing.MockClock(true);
    var blendedField;
    try {
      blendedField = initSeamlessField('',
          {'border': '1px solid black', 'height': '20px'});
      blendedField.makeEditable();
      blendedField.setHtml(false, 'Content that should wrap after resize.');

      // Ensure that the field was fully loaded and sized before measuring.
      clock.tick(1);

      // Capture starting heights.
      var unwrappedIframeHeight = blendedField.getEditableIframe().offsetHeight;

      // Resize the field such that the text should wrap.
      fieldElem.style.width = '200px';
      blendedField.doFieldSizingGecko();

      // Iframe should grow as a result.
      var wrappedIframeHeight = blendedField.getEditableIframe().offsetHeight;
      assertTrue('Wrapped text should cause iframe to grow - initial height: ' +
          unwrappedIframeHeight + ', wrapped height: ' + wrappedIframeHeight,
          wrappedIframeHeight > unwrappedIframeHeight);
    } finally {
      blendedField.dispose();
      clock.dispose();
    }
  }
}

function testDispatchBlur() {
  if (!goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE &&
      !goog.editor.BrowserFeature.CLEARS_SELECTION_WHEN_FOCUS_LEAVES) {
    var blendedField = initSeamlessField('Hi!', {'border': '2px 5px'});
    var iframe = createSeamlessIframe();
    blendedField.attachIframe(iframe);

    var blurCalled = false;
    goog.events.listenOnce(blendedField, goog.editor.Field.EventType.BLUR,
        function() {
          blurCalled = true;
        });

    var clearSelection = goog.dom.Range.clearSelection;
    var cleared = false;
    var clearedWindow;
    blendedField.editableDomHelper = new goog.dom.DomHelper();
    blendedField.editableDomHelper.getWindow =
        goog.functions.constant(iframe.contentWindow);
    var mockRange = new goog.testing.MockRange();
    blendedField.getRange = function() {
      return mockRange;
    };
    goog.dom.Range.clearSelection = function(opt_window) {
      clearSelection(opt_window);
      cleared = true;
      clearedWindow = opt_window;
    }
    var clock = new goog.testing.MockClock(true);

    mockRange.collapse(true);
    mockRange.select();
    mockRange.$replay();
    blendedField.dispatchBlur();
    clock.tick(1);

    assertTrue('Blur must be dispatched.', blurCalled);
    assertTrue('Selection must be cleared.', cleared);
    assertEquals('Selection must be cleared in iframe',
        iframe.contentWindow, clearedWindow);
    mockRange.$verify();
    clock.dispose();
  }
}

function testSetMinHeight() {
  if (!goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE) {
    var clock = new goog.testing.MockClock(true);
    try {
      var field = initSeamlessField(
          ['1', '2', '3', '4', '5', '6', '7'].join('<p/>'),
          {'position': 'relative', 'height': '60px'});

      // Initially create and size iframe.
      var iframe = createSeamlessIframe();
      field.attachIframe(iframe);
      field.iframeFieldLoadHandler(iframe, '', {});
      // Need to process timeouts set by load handlers.
      clock.tick(1000);

      var normalHeight = goog.style.getSize(iframe).height;

      var delayedChangeCalled = false;
      goog.events.listen(field, goog.editor.Field.EventType.DELAYEDCHANGE,
          function() {
            delayedChangeCalled = true;
          });

      // Test that min height is obeyed.
      field.setMinHeight(30);
      clock.tick(1000);
      assertEquals('Iframe height must match min height.',
          30, goog.style.getSize(iframe).height);
      assertFalse('Setting min height must not cause delayed change event.',
          delayedChangeCalled);

      // Test that min height doesn't shrink field.
      field.setMinHeight(0);
      clock.tick(1000);
      assertEquals(normalHeight, goog.style.getSize(iframe).height);
      assertFalse('Setting min height must not cause delayed change event.',
          delayedChangeCalled);
    } finally {
      goog.events.removeAll();
      field.dispose();
      clock.dispose();
    }
  }
}


/**
 * @bug 1649967 This code used to throw a Javascript error.
 */
function testSetMinHeightWithNoIframe() {
  if (goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE) {
    try {
      var field = initSeamlessField('&nbsp;', {});
      field.makeEditable();
      field.setMinHeight(30);
    } finally {
      field.dispose();
      goog.events.removeAll();
    }
  }
}

function testStartChangeEvents() {
  if (goog.editor.BrowserFeature.USE_MUTATION_EVENTS) {
    var clock = new goog.testing.MockClock(true);

    try {
      var field = initSeamlessField('&nbsp;', {});
      field.makeEditable();

      var changeCalled = false;
      goog.events.listenOnce(field, goog.editor.Field.EventType.CHANGE,
          function() {
            changeCalled = true;
          });

      var delayedChangeCalled = false;
      goog.events.listenOnce(field, goog.editor.Field.EventType.CHANGE,
          function() {
            delayedChangeCalled = true;
          });

      field.stopChangeEvents(true, true);
      if (field.changeTimerGecko_) {
        field.changeTimerGecko_.start();
      }

      field.startChangeEvents();
      clock.tick(1000);

      assertFalse(changeCalled);
      assertFalse(delayedChangeCalled);
    } finally {
      clock.dispose();
      field.dispose();
    }
  }
}

function testManipulateDom() {
  // Test in blended field since that is what fires change events.
  var editableField = initSeamlessField('&nbsp;', {});
  var clock = new goog.testing.MockClock(true);

  var delayedChangeCalled = 0;
  goog.events.listen(editableField, goog.editor.Field.EventType.DELAYEDCHANGE,
      function() {
        delayedChangeCalled++;
      });

  assertFalse(editableField.isLoaded());
  editableField.manipulateDom(goog.nullFunction);
  clock.tick(1000);
  assertEquals('Must not fire delayed change events if field is not loaded.',
      0, delayedChangeCalled);

  editableField.makeEditable();
  var usesIframe = editableField.usesIframe();

  try {
    editableField.manipulateDom(goog.nullFunction);
    clock.tick(1000); // Wait for delayed change to fire.
    assertEquals('By default must fire a single delayed change event.',
        1, delayedChangeCalled);

    editableField.manipulateDom(goog.nullFunction, true);
    clock.tick(1000); // Wait for delayed change to fire.
    assertEquals('Must prevent all delayed change events.',
        1, delayedChangeCalled);

    editableField.manipulateDom(function() {
      this.handleChange();
      this.handleChange();
      if (this.changeTimerGecko_) {
        this.changeTimerGecko_.fire();
      }

      this.dispatchDelayedChange_();
      this.delayedChangeTimer_.fire();
    }, false, editableField);
    clock.tick(1000); // Wait for delayed change to fire.
    assertEquals('Must ignore dispatch delayed change called within func.',
        2, delayedChangeCalled);
  } finally {
    // Ensure we always uninstall the mock clock and dispose of everything.
    editableField.dispose();
    clock.dispose();
  }
}

function testAttachIframe() {
  var blendedField = initSeamlessField('Hi!', {});
  var iframe = createSeamlessIframe();
  try {
    blendedField.attachIframe(iframe);
  } catch (err) {
    fail('Error occurred while attaching iframe.');
  }
}


function createSeamlessIframe() {
  // NOTE(nicksantos): This is a reimplementation of
  // TR_EditableUtil.getIframeAttributes, but untangled for tests, and
  // specifically with what we need for blended mode.
  return goog.dom.createDom('IFRAME',
      { 'frameBorder': '0', 'style': 'padding:0;' });
}


/**
 * Initialize a new editable field for the field id 'field', with the given
 * innerHTML and styles.
 *
 * @param {string} innerHTML html for the field contents.
 * @param {Object} styles Key-value pairs for styles on the field.
 * @return {goog.editor.SeamlessField} The field.
 */
function initSeamlessField(innerHTML, styles) {
  var field = new goog.editor.SeamlessField('field');
  fieldElem.innerHTML = innerHTML;
  goog.style.setStyle(fieldElem, styles);
  return field;
}


/**
 * Make sure that the original field element for the given goog.editor.Field has
 * the same size before and after attaching the given iframe. If this is not
 * true, then the field will fidget while we're initializing the field,
 * and that's not what we want.
 *
 * @param {goog.editor.Field} fieldObj The field.
 * @param {HTMLIFrameElement} iframe The iframe.
 */
function assertAttachSeamlessIframeSizesCorrectly(fieldObj, iframe) {
  var size = goog.style.getSize(fieldObj.getOriginalElement());
  fieldObj.attachIframe(iframe);
  var newSize = goog.style.getSize(fieldObj.getOriginalElement());

  assertEquals(size.width, newSize.width);
  assertEquals(size.height, newSize.height);
}
">14 of 14 tests run in 29ms.<br />0 passed, 14 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testAttachIframe<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testBlankField<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testDispatchBlur<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testFieldWithBorder<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testFieldWithContent<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testFieldWithMargin<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testFieldWithOverflow<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testFieldWithOverflowAndPadding<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testFieldWithPadding<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testIframeHeightGrowsOnWrap<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testManipulateDom<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testSetMinHeight<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testSetMinHeightWithNoIframe<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testStartChangeEvents<br />Object #<Object> has no method 'cloneNode'<br /></td></tr>
<tr><td>browserfeature_test.html</td><td>Fail</td><td> undefined</td><td title="

goog.require('goog.dom');
goog.require('goog.dom.Range');
goog.require('goog.editor.BrowserFeature');
goog.require('goog.testing.ExpectedFailures');
goog.require('goog.testing.jsunit');



var expectedFailures = new goog.testing.ExpectedFailures();

function tearDown() {
  var root = goog.dom.getElement('root');
  goog.dom.removeChildren(root);
  expectedFailures.handleTearDown();
}

function testEmptyNodeNormalization() {
  var root = goog.dom.getElement('root');
  goog.dom.appendChild(root, goog.dom.createTextNode('text'));

  var textNode = root.firstChild;
  textNode.splitText(0);
  root.normalize();

  assertEquals(
      'NORMALIZE_CORRUPTS_EMPTY_TEXT_NODES incorrect for ' +
      navigator.userAgent,
      goog.editor.BrowserFeature.NORMALIZE_CORRUPTS_EMPTY_TEXT_NODES,
      textNode.parentNode == null);
}

function testLeavesPWhenRemovingLists() {
  if (!goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE) {
    return;
  }
  var root = goog.dom.getElement('root');
  goog.dom.removeChildren(root);
  root.innerHTML = '<div>foo</div>';
  goog.dom.Range.createFromNodeContents(root.firstChild.firstChild).select();
  document.execCommand('insertorderedlist', false, true);
  document.execCommand('insertorderedlist', false, true);

  assertEquals(
      'LEAVES_P_WHEN_REMOVING_LISTS incorrect for ' +
      navigator.userAgent,
      goog.editor.BrowserFeature.LEAVES_P_WHEN_REMOVING_LISTS,
      !!root.getElementsByTagName('p').length);
}

function testActiveElement() {
  var root = goog.dom.getElement('root');
  var div = goog.dom.createElement('div');
  root.appendChild(div);
  div.tabIndex = 0;
  div.focus();

  expectedFailures.expectFailureFor(
      !goog.editor.BrowserFeature.HAS_ACTIVE_ELEMENT);
  try {
    assertEquals('document.activeElement should be the created div',
                 div, document.activeElement);
  } catch (e) {
    expectedFailures.handleException(e);
  }
}

function testNormalizeCorruption() {
  var root = goog.dom.getElement('testNormalizeCorruption');
  var textNode = root.firstChild;
  textNode.splitText(0);
  var secondTextNode = textNode.nextSibling;

  root.normalize();

  expectedFailures.expectFailureFor(
      goog.editor.BrowserFeature.NORMALIZE_CORRUPTS_EMPTY_TEXT_NODES);
  try {
    assertEquals('text node should not be corrupted',
        textNode, root.firstChild);
  } catch (e) {
    expectedFailures.handleException(e);

    expectedFailures.expectFailureFor(
        goog.editor.BrowserFeature.NORMALIZE_CORRUPTS_ALL_TEXT_NODES);
    try {
      assertEquals(
          'first text node should be corrupted and replaced by sibling',
          secondTextNode, root.firstChild);
    } catch (e) {
      expectedFailures.handleException(e);
    }
  }
}

">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:11:24
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>node_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.TagName');
  goog.require('goog.editor.node');
  goog.require('goog.testing.ExpectedFailures');
  goog.require('goog.testing.dom');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');


var expectedFailures = new goog.testing.ExpectedFailures();
var parentNode = document.getElementById('parentNode');
var childNode1 = parentNode.childNodes[0];
var childNode2 = parentNode.childNodes[1];
var childNode3 = parentNode.childNodes[2];

var gChildWsNode1 = null;
var gChildTextNode1 = null;
var gChildNbspNode1 = null;
var gChildMixedNode1 = null;
var gChildWsNode2a = null;
var gChildWsNode2b = null;
var gChildTextNode3a = null;
var gChildWsNode3 = null;
var gChildTextNode3b = null;

function setUpDomTree() {
  gChildWsNode1 = document.createTextNode(' \t\r\n');
  gChildTextNode1 = document.createTextNode('Child node');
  gChildNbspNode1 = document.createTextNode('\u00a0');
  gChildMixedNode1 = document.createTextNode('Text\n plus\u00a0');
  gChildWsNode2a = document.createTextNode('');
  gChildWsNode2b = document.createTextNode(' ');
  gChildTextNode3a = document.createTextNode('I am a grand child');
  gChildWsNode3 = document.createTextNode('   \t  \r   \n');
  gChildTextNode3b = document.createTextNode('I am also a grand child');

  childNode3.appendChild(gChildTextNode3a);
  childNode3.appendChild(gChildWsNode3);
  childNode3.appendChild(gChildTextNode3b);

  childNode1.appendChild(gChildMixedNode1);
  childNode1.appendChild(gChildWsNode1);
  childNode1.appendChild(gChildNbspNode1);
  childNode1.appendChild(gChildTextNode1);

  childNode2.appendChild(gChildWsNode2a);
  childNode2.appendChild(gChildWsNode2b);
  document.body.appendChild(parentNode);
}

function tearDownDomTree() {
  childNode1.innerHTML = childNode2.innerHTML = childNode3.innerHTML = "";
  gChildWsNode1 = null;
  gChildTextNode1 = null;
  gChildNbspNode1 = null;
  gChildMixedNode1 = null;
  gChildWsNode2a = null;
  gChildWsNode2b = null;
  gChildTextNode3a = null;
  gChildWsNode3 = null;
  gChildTextNode3b = null;
}

function testGetCompatModeQuirks() {
  var quirksIfr = document.createElement('iframe');
  document.body.appendChild(quirksIfr);
  // Webkit used to default to standards mode, but fixed this in
  // Safari 4/Chrome 2, aka, WebKit 530.
  expectedFailures.expectFailureFor(goog.userAgent.WEBKIT &&
                                    !goog.userAgent.isVersion('530'));
  expectedFailures.run(function() {
    assertFalse('Empty sourceless iframe is quirks mode, not standards mode',
        goog.editor.node.isStandardsMode(
            goog.dom.getFrameContentDocument(quirksIfr)));
  });
  document.body.removeChild(quirksIfr);
}

function testGetCompatModeStandards() {
  var standardsIfr = document.createElement('iframe');
  document.body.appendChild(standardsIfr);
  var doc = goog.dom.getFrameContentDocument(standardsIfr);
  doc.open();
  doc.write('<!DOCTYPE HTML><html><head></head><body>&nbsp;</body></html>');
  doc.close();
  assertTrue('Iframe with DOCTYPE written in is standards mode',
      goog.editor.node.isStandardsMode(doc));
  document.body.removeChild(standardsIfr);
}

/**
 * Creates a DOM tree and tests that getLeftMostLeaf returns proper node
 */
function testGetLeftMostLeaf() {
  setUpDomTree();

  assertEquals('Should skip ws node', gChildMixedNode1,
               goog.editor.node.getLeftMostLeaf(parentNode));
  assertEquals('Should skip ws node', gChildMixedNode1,
               goog.editor.node.getLeftMostLeaf(childNode1));
  assertEquals('Has no non ws leaves', childNode2,
               goog.editor.node.getLeftMostLeaf(childNode2));
  assertEquals('Should return first child', gChildTextNode3a,
               goog.editor.node.getLeftMostLeaf(childNode3));
  assertEquals('Has no children', gChildTextNode1,
               goog.editor.node.getLeftMostLeaf(gChildTextNode1));

  tearDownDomTree();
}

/**
 * Creates a DOM tree and tests that getRightMostLeaf returns proper node
 */
function testGetRightMostLeaf() {
  setUpDomTree();

  assertEquals("Should return child3's rightmost child", gChildTextNode3b,
               goog.editor.node.getRightMostLeaf(parentNode));
  assertEquals('Should skip ws node', gChildTextNode1,
               goog.editor.node.getRightMostLeaf(childNode1));
  assertEquals('Has no non ws leaves', childNode2,
               goog.editor.node.getRightMostLeaf(childNode2));
  assertEquals('Should return last child', gChildTextNode3b,
               goog.editor.node.getRightMostLeaf(childNode3));
  assertEquals('Has no children', gChildTextNode1,
               goog.editor.node.getRightMostLeaf(gChildTextNode1));

  tearDownDomTree();
}

/**
 * Creates a DOM tree and tests that getFirstChild properly ignores
 * ignorable nodes
 */
function testGetFirstChild() {
  setUpDomTree();

  assertNull('Has no none ws children',
      goog.editor.node.getFirstChild(childNode2));
  assertEquals('Should skip first child, as it is ws', gChildMixedNode1,
      goog.editor.node.getFirstChild(childNode1));
  assertEquals('Should just return first child', gChildTextNode3a,
      goog.editor.node.getFirstChild(childNode3));
  assertEquals('Should return first child', childNode1,
      goog.editor.node.getFirstChild(parentNode));

  assertNull('First child of a text node should return null',
      goog.editor.node.getFirstChild(gChildTextNode1));
  assertNull('First child of null should return null',
      goog.editor.node.getFirstChild(null));

  tearDownDomTree();
}

/**
 * Create a DOM tree and test that getLastChild properly ignores
 * ignorable nodes
 */
function testGetLastChild() {
  setUpDomTree();

  assertNull('Has no none ws children',
      goog.editor.node.getLastChild(childNode2));
  assertEquals('Should skip last child, as it is ws', gChildTextNode1,
               goog.editor.node.getLastChild(childNode1));
  assertEquals('Should just return last child', gChildTextNode3b,
               goog.editor.node.getLastChild(childNode3));
  assertEquals('Should return last child', childNode3,
               goog.editor.node.getLastChild(parentNode));

  assertNull('Last child of a text node should return null',
      goog.editor.node.getLastChild(gChildTextNode1));
  assertNull('Last child of null should return null',
      goog.editor.node.getLastChild(gChildTextNode1));

  tearDownDomTree();
}

/**
 * Test if nodes that should be ignorable return false and nodes that should
 * not be ignored return true.
 */
function testIsImportant() {
  var wsNode = document.createTextNode(' \t\r\n');
  assertFalse('White space node is ignorable',
      goog.editor.node.isImportant(wsNode));
  var textNode = document.createTextNode('Hello');
  assertTrue('Text node is important', goog.editor.node.isImportant(textNode));
  var nbspNode = document.createTextNode('\u00a0');
  assertTrue('Node with nbsp is important',
      goog.editor.node.isImportant(nbspNode));
  var imageNode = document.createElement('img');
  assertTrue('Image node is important',
      goog.editor.node.isImportant(imageNode));
}


/**
 * Test that isAllNonNbspWhiteSpace returns true if node contains only
 * whitespace that is not nbsp and false otherwise
 */
function testIsAllNonNbspWhiteSpace() {
  var wsNode = document.createTextNode(' \t\r\n');
  assertTrue('String is all non nbsp',
      goog.editor.node.isAllNonNbspWhiteSpace(wsNode));
  var textNode = document.createTextNode('Hello');
  assertFalse('String should not be whitespace',
              goog.editor.node.isAllNonNbspWhiteSpace(textNode));
  var nbspNode = document.createTextNode('\u00a0');
  assertFalse('String has nbsp',
      goog.editor.node.isAllNonNbspWhiteSpace(nbspNode));
}


/**
 * Creates a DOM tree and Test that getPreviousSibling properly ignores
 * ignorable nodes
 */
function testGetPreviousSibling() {
  setUpDomTree();

  assertNull('No previous sibling',
             goog.editor.node.getPreviousSibling(gChildTextNode3a));
  assertEquals('Should have text sibling', gChildTextNode3a,
               goog.editor.node.getPreviousSibling(gChildWsNode3));
  assertEquals('Should skip over white space sibling', gChildTextNode3a,
               goog.editor.node.getPreviousSibling(gChildTextNode3b));
  assertNull('No previous sibling',
             goog.editor.node.getPreviousSibling(gChildMixedNode1));
  assertEquals('Should have mixed text sibling', gChildMixedNode1,
               goog.editor.node.getPreviousSibling(gChildWsNode1));
  assertEquals('Should skip over white space sibling', gChildMixedNode1,
               goog.editor.node.getPreviousSibling(gChildNbspNode1));
  assertNotEquals('Should not move past ws and nbsp', gChildMixedNode1,
                  goog.editor.node.getPreviousSibling(gChildTextNode1));
  assertEquals('Should go to child 2', childNode2,
               goog.editor.node.getPreviousSibling(childNode3));
  assertEquals('Should go to child 1', childNode1,
               goog.editor.node.getPreviousSibling(childNode2));
  assertNull('Only has white space siblings',
             goog.editor.node.getPreviousSibling(gChildWsNode2b));

  tearDownDomTree();
}


/**
 * Creates a DOM tree and tests that getNextSibling properly ignores igrnorable
 * nodes when determining the next sibling
 */
function testGetNextSibling() {
  setUpDomTree();

  assertEquals('Child 1 should have Child 2', childNode2,
               goog.editor.node.getNextSibling(childNode1));
  assertEquals('Child 2 should have child 3', childNode3,
               goog.editor.node.getNextSibling(childNode2));
  assertNull('Child 3 has no next sibling',
      goog.editor.node.getNextSibling(childNode3));
  assertNotEquals('Should not skip ws and nbsp nodes', gChildTextNode1,
                  goog.editor.node.getNextSibling(gChildMixedNode1));
  assertNotEquals('Should not skip nbsp node', gChildTextNode1,
                  goog.editor.node.getNextSibling(gChildWsNode1));
  assertEquals('Should have sibling', gChildTextNode1,
               goog.editor.node.getNextSibling(gChildNbspNode1));
  assertNull('Should have no next sibling',
             goog.editor.node.getNextSibling(gChildTextNode1));
  assertNull('Only has ws sibling',
      goog.editor.node.getNextSibling(gChildWsNode2a));
  assertNull('Has no next sibling',
      goog.editor.node.getNextSibling(gChildWsNode2b));
  assertEquals('Should skip ws node', gChildTextNode3b,
               goog.editor.node.getNextSibling(gChildTextNode3a));

  tearDownDomTree();
}


function testIsEmpty() {
  var textNode = document.createTextNode('');
  assertTrue('Text node with no content should be empty',
      goog.editor.node.isEmpty(textNode));
  textNode.data = '\xa0';
  assertTrue('Text node with nbsp should be empty',
      goog.editor.node.isEmpty(textNode));
  assertFalse('Text node with nbsp should not be empty when prohibited',
      goog.editor.node.isEmpty(textNode, true));

  textNode.data = '     ';
  assertTrue('Text node with whitespace should be empty',
      goog.editor.node.isEmpty(textNode));
  textNode.data = 'notEmpty';
  assertFalse('Text node with text should not be empty',
      goog.editor.node.isEmpty(textNode));

  var div = document.createElement('div');
  assertTrue('Empty div should be empty',
      goog.editor.node.isEmpty(div));
  div.innerHTML = '<iframe></iframe>'
  assertFalse('Div containing an iframe is not empty',
      goog.editor.node.isEmpty(div));
  div.innerHTML = '<img></img>'
  assertFalse('Div containing an image is not empty',
      goog.editor.node.isEmpty(div));
  div.innerHTML = '<embed></embed>'
  assertFalse('Div containing an embed is not empty',
      goog.editor.node.isEmpty(div));
  div.innerHTML = '<div><span></span></div>';
  assertTrue('Div containing other empty tags is empty',
      goog.editor.node.isEmpty(div));
  div.innerHTML = '<div><span>  </span></div>';
  assertTrue('Div containing other empty tags and whitespace is empty',
      goog.editor.node.isEmpty(div));
  div.innerHTML = '<div><span>Not empty</span></div>';
  assertFalse('Div containing tags and text is not empty',
      goog.editor.node.isEmpty(div));

  var img = document.createElement(goog.dom.TagName.IMG);
  assertFalse('Empty img should not be empty',
      goog.editor.node.isEmpty(img));

  var iframe = document.createElement(goog.dom.TagName.IFRAME);
  assertFalse('Empty iframe should not be empty',
      goog.editor.node.isEmpty(iframe));

  var embed = document.createElement('embed');
  assertFalse('Empty embed should not be empty',
      goog.editor.node.isEmpty(embed));  
}

function testActiveElementIE() {
  if (!goog.userAgent.IE) {
    return;
  }

  var link = goog.dom.getElement('link')
  link.focus();

  assertEquals(link,
      goog.editor.node.getActiveElementIE(document));
}

/**
 * Test that getLength returns 0 if the node has no length and no children,
 * the # of children if the node has no length but does have children,
 * and the length of the node if the node does have length
 */
function testGetLength() {
  var parentNode = document.createElement('p');

  assertEquals('Length 0 and no children', 0,
      goog.editor.node.getLength(parentNode));

  var childNode1 = document.createTextNode('node 1');
  var childNode2 = document.createTextNode('node number 2');
  var childNode3 = document.createTextNode('');
  parentNode.appendChild(childNode1);
  parentNode.appendChild(childNode2);
  parentNode.appendChild(childNode3);
  assertEquals('Length 0 and 3 children', 3,
      goog.editor.node.getLength(parentNode));
  assertEquals('Text node, length 6', 6,
      goog.editor.node.getLength(childNode1));
  assertEquals('Text node, length 0', 0,
      goog.editor.node.getLength(childNode3));
}

function testFindInChildrenSuccess() {
  var parentNode = document.createElement('div');
  parentNode.innerHTML = '<div>foo</div><b>foo2</b>';

  var index = goog.editor.node.findInChildren(parentNode,
      function(node) {
        return node.tagName == 'B';
      });
  assertEquals('Should find second child', index, 1);
}

function testFindInChildrenFailure() {
  var parentNode = document.createElement('div');
  parentNode.innerHTML = '<div>foo</div><b>foo2</b>';

  var index = goog.editor.node.findInChildren(parentNode,
      function(node) {
        return false;
      });
  assertNull("Shouldn't find a child", index);
}

function testFindHighestMatchingAncestor() {
  setUpDomTree();
  var predicateFunc = function(node) {
    return node.tagName == 'DIV';
  };
  var node = goog.editor.node.findHighestMatchingAncestor(
      gChildTextNode3a, predicateFunc);
  assertNotNull('Should return an ancestor', node);
  assertEquals('Should have found "parentNode" as the last ' +
               'ancestor matching the predicate',
               parentNode,
               node);

  predicateFunc = function(node) {
    return node.childNodes.length == 1;
  };
  node = goog.editor.node.findHighestMatchingAncestor(gChildTextNode3a,
                                                      predicateFunc);
  assertNull("Shouldn't return an ancestor", node);

  tearDownDomTree();
}

function testIsBlock() {
  var blockDisplays = ['block', 'list-item', 'table', 'table-caption',
      'table-cell', 'table-column', 'table-column-group', 'table-footer',
      'table-footer-group', 'table-header-group', 'table-row',
      'table-row-group'];
  var structuralTags = goog.object.createSet('HTML', 'BODY', 'HEAD');
  // The following tags are considered inline in IE, except LEGEND which is
  // only a block element in WEBKIT.
  var ambiguousTags = goog.object.createSet('HR', 'ISINDEX', 'LEGEND', 'MAP',
      'OPTGROUP', 'OPTION');
  for (var tag in goog.dom.TagName) {
    if (tag.substr(0, 5) != 'FRAME' && !structuralTags[tag] &&
        !ambiguousTags[tag]) {
      var el = goog.dom.createElement(tag);
      document.body.appendChild(el);
      var display = goog.style.getCascadedStyle(el, 'display') ||
                    goog.style.getComputedStyle(el, 'display');
      goog.dom.removeNode(el);

      if (goog.editor.node.isBlockTag(el)) {
        assertContains('Display for ' + tag + ' should be block-like',
            display, blockDisplays);
      } else {
        assertNotContains('Display for ' + tag + ' should not be block-like',
            display, blockDisplays);
      }
    }
  }
}

function createDivWithTextNodes(var_args) {
  var dom = goog.dom.createDom('div');
  for (var i = 0; i < arguments.length; i++) {
    goog.dom.appendChild(dom, goog.dom.createTextNode(arguments[i]));
  }
  return dom;
}

function testSkipEmptyTextNodes() {
  assertNull('skipEmptyTextNodes should gracefully handle null',
      goog.editor.node.skipEmptyTextNodes(null));

  var dom1 = createDivWithTextNodes('abc', '', 'xyz', '', '');
  assertEquals('expected not to skip first child', dom1.firstChild,
      goog.editor.node.skipEmptyTextNodes(dom1.firstChild));
  assertEquals('expected to skip second child', dom1.childNodes[2],
      goog.editor.node.skipEmptyTextNodes(dom1.childNodes[1]));
  assertNull('expected to skip all the rest of the children',
      goog.editor.node.skipEmptyTextNodes(dom1.childNodes[3]));
}

function testIsEditableContainer() {
  var editableContainerElement = document.getElementById('editableTest');
  assertTrue('Container element should be considered editable container',
    goog.editor.node.isEditableContainer(editableContainerElement));

  var nonEditableContainerElement = document.getElementById('parentNode');
  assertFalse('Other element should not be considered editable container',
    goog.editor.node.isEditableContainer(nonEditableContainerElement));
}

function testIsEditable() {
  var editableContainerElement = document.getElementById('editableTest');
  var childNode = editableContainerElement.firstChild;
  var childElement = editableContainerElement.getElementsByTagName('span')[0];

  assertFalse('Container element should not be considered editable',
    goog.editor.node.isEditable(editableContainerElement));
  assertTrue('Child text node should be considered editable',
    goog.editor.node.isEditable(childNode));
  assertTrue('Child element should be considered editable',
    goog.editor.node.isEditable(childElement));
  assertTrue('Grandchild node should be considered editable',
    goog.editor.node.isEditable(childElement.firstChild));
  assertFalse('Other element should not be considered editable',
   goog.editor.node.isEditable(document.getElementById('parentNode')));
}

function testFindTopMostEditableAncestor() {
  var root = document.getElementById('editableTest');
  var span = root.getElementsByTagName(goog.dom.TagName.SPAN)[0];
  var textNode = span.firstChild;

  assertEquals('Should return self if self is matched.',
      textNode, goog.editor.node.findTopMostEditableAncestor(textNode,
      function(node) {
        return node.nodeType == goog.dom.NodeType.TEXT;
      }));
  assertEquals('Should not walk out of editable node.',
      null, goog.editor.node.findTopMostEditableAncestor(textNode,
      function(node) {
        return node.tagName == goog.dom.TagName.BODY;
      }));
  assertEquals('Should not match editable container.',
      null, goog.editor.node.findTopMostEditableAncestor(textNode,
      function(node) {
        return node.tagName == goog.dom.TagName.DIV;
      }));
  assertEquals('Should find node in editable container.',
      span, goog.editor.node.findTopMostEditableAncestor(textNode,
      function(node) {
        return node.tagName == goog.dom.TagName.SPAN;
      }));
}

function testSplitDomTreeAt() {
  var innerHTML = '<p>1<b>2</b>3</p>';
  var root = goog.dom.createElement(goog.dom.TagName.DIV);

  root.innerHTML = innerHTML;
  var result = goog.editor.node.splitDomTreeAt(
      root.getElementsByTagName(goog.dom.TagName.B)[0], null, root);
  goog.testing.dom.assertHtmlContentsMatch('<p>1<b>2</b></p>', root);
  goog.testing.dom.assertHtmlContentsMatch('<p>3</p>', result);

  root.innerHTML = innerHTML;
  result = goog.editor.node.splitDomTreeAt(
      root.getElementsByTagName(goog.dom.TagName.B)[0],
      goog.dom.createTextNode('and'),
      root);
  goog.testing.dom.assertHtmlContentsMatch('<p>1<b>2</b></p>', root);
  goog.testing.dom.assertHtmlContentsMatch('<p>and3</p>', result);
}

function testTransferChildren() {
  var prefix = '<b>Bold 1</b>';
  var innerHTML = '<b>Bold</b><ul><li>Item 1</li><li>Item 2</li></ul>';

  var root1 = goog.dom.createElement(goog.dom.TagName.DIV);
  root1.innerHTML = innerHTML;

  var root2 = goog.dom.createElement(goog.dom.TagName.P);
  root2.innerHTML = prefix;

  var b = root1.getElementsByTagName(goog.dom.TagName.B)[0];

  // Transfer the children.
  goog.editor.node.transferChildren(root2, root1);
  assertEquals(0, root1.childNodes.length);
  goog.testing.dom.assertHtmlContentsMatch(prefix + innerHTML, root2);
  assertEquals(b, root2.getElementsByTagName(goog.dom.TagName.B)[1]);

  // Transfer them back.
  goog.editor.node.transferChildren(root1, root2);
  assertEquals(0, root2.childNodes.length);
  goog.testing.dom.assertHtmlContentsMatch(prefix + innerHTML, root1);
  assertEquals(b, root1.getElementsByTagName(goog.dom.TagName.B)[1]);
}

">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:12:24
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>plugin_test.html</td><td>Success</td><td> 10 passed, 0 failed.</td><td title="


  goog.require('goog.editor.Field');
  goog.require('goog.editor.Plugin');
  goog.require('goog.functions');
  goog.require('goog.userAgent');
  goog.require('goog.testing.StrictMock');
  goog.require('goog.testing.jsunit');



var plugin;
var fieldObject;


function setUp() {
  plugin = new goog.editor.Plugin();
  fieldObject = {};
}


function tearDown() {
  plugin.dispose();
}


function testRegisterFieldObject() {
  plugin.registerFieldObject(fieldObject);
  assertEquals('Register field object must be stored in protected field.',
      fieldObject, plugin.fieldObject);

  assertFalse('Newly registered plugin must not be enabled.',
      plugin.isEnabled(fieldObject));
}


function testUnregisterFieldObject() {
  plugin.registerFieldObject(fieldObject);
  plugin.enable(fieldObject);
  plugin.unregisterFieldObject(fieldObject);

  assertNull('fieldObject property must be undefined after ' +
      'unregistering a field object.', plugin.fieldObject);
  assertFalse('Unregistered field object must not be enabled',
      plugin.isEnabled(fieldObject));
}


function testEnable() {
  plugin.registerFieldObject(fieldObject);
  plugin.enable(fieldObject);

  assertTrue('Enabled field object must be enabled according to isEnabled().',
      plugin.isEnabled(fieldObject));
}


function testDisable() {
  plugin.registerFieldObject(fieldObject);
  plugin.enable(fieldObject);
  plugin.disable(fieldObject);

  assertFalse('Disabled field object must be disabled according to ' +
      'isEnabled().', plugin.isEnabled(fieldObject));
}


function testIsEnabled() {
  // Other base cases covered while testing enable() and disable().
  
  assertFalse('Unregistered field object must be disabled according ' +
              'to isEnabled().', plugin.isEnabled(fieldObject));
}


function testIsSupportedCommand() {
  assertFalse('Base plugin class must not support any commands.',
      plugin.isSupportedCommand('+indent'))
}

function testExecCommand() {
  var mockField = new goog.testing.StrictMock(goog.editor.Field);
  plugin.registerFieldObject(mockField);

  if (goog.userAgent.GECKO) {
    mockField.stopChangeEvents(true, true);
  }
  mockField.dispatchBeforeChange();
  // Note(user): dispatch change turns back on (delayed) change events.
  mockField.dispatchChange();
  mockField.dispatchSelectionChangeEvent();
  mockField.$replay();

  var passedCommand, passedArg;
  plugin.execCommandInternal = function(command, arg){
    passedCommand = command;
    passedArg = arg;
  };
  plugin.execCommand('+indent', true);

  // Verify that execCommand dispatched the expected events.
  mockField.$verify();
  mockField.$reset();
  // Verify that execCommandInternal was called with the correct arguments.
  assertEquals('+indent', passedCommand);
  assertTrue(passedArg);

  plugin.isSilentCommand = goog.functions.constant(true);
  mockField.$replay();
  plugin.execCommand('+outdent', false);
  // Verify that execCommand on a silent plugin dispatched no events.
  mockField.$verify();
  // Verify that execCommandInternal was called with the correct arguments.
  assertEquals('+outdent', passedCommand);
  assertFalse(passedArg);
}

/**
 * Regression test for http://b/issue?id=1471355 .
 */
function testExecCommandException() {
  var mockField = new goog.testing.StrictMock(goog.editor.Field);
  plugin.registerFieldObject(mockField);
  plugin.execCommandInternal = function() {
    throw 1;
  };

  if (goog.userAgent.GECKO) {
    mockField.stopChangeEvents(true, true);
  }
  mockField.dispatchBeforeChange();
  // Note(user): dispatch change turns back on (delayed) change events.
  mockField.dispatchChange();
  mockField.dispatchSelectionChangeEvent();
  mockField.$replay();

  assertThrows('Exception should not be swallowed', function() {
    plugin.execCommand();
  });

  // Verifies that cleanup is done despite the exception.
  mockField.$verify();
}

function testDisposed() {
  plugin.registerFieldObject(fieldObject);
  plugin.dispose();
  assert(plugin.getDisposed());
  assertNull('Disposed plugin must not have a field object.',
      plugin.fieldObject);
  assertFalse('Disposed plugin must not have an enabled field object.',
      plugin.isEnabled(fieldObject));
}

function testIsAndSetAutoDispose() {
  assertTrue('Plugin must start auto-disposable', plugin.isAutoDispose());

  plugin.setAutoDispose(false);
  assertFalse(plugin.isAutoDispose());

  plugin.setAutoDispose(true);
  assertTrue(plugin.isAutoDispose());
}

">n/a</td></tr>
<tr><td>clicktoeditwrapper_test.html</td><td>Fail</td><td> 0 passed, 4 failed.</td><td title="

  goog.require('goog.editor.ClickToEditWrapper');
  goog.require('goog.editor.Field');
  goog.require('goog.editor.SeamlessField');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.MockClock');



var FIELD;
var CLOCK;
var HTML;

function setUp() {
  HTML = goog.dom.getElement('root').innerHTML;
  CLOCK = new goog.testing.MockClock(true);

  // The following 3 lines are to get around an IE bug where it says
  // 'Incompatible markup pointers for this operation'.
  // Must be done in the setup, not teardown, or else it won't take effect for
  // the first test that is run, or any test that runs immediately after a
  // "breaking async" message from the jsunit framework.
  goog.dom.Range.clearSelection();
  window.blur();
  window.focus();
}

function setUpField(opt_isBlended) {
  FIELD = opt_isBlended ? new goog.editor.SeamlessField('testField') :
      new goog.editor.SeamlessField('testField');

  (new goog.editor.ClickToEditWrapper(FIELD));

  goog.dom.Range.clearSelection();
}

function tearDown() {
  if (FIELD) {
    FIELD.dispose();
  }

  CLOCK.dispose();

  goog.dom.getElement('root').innerHTML = HTML;
}

function testClickToEdit(opt_isBlended) {
  setUpField(opt_isBlended);

  var text = goog.dom.getElement('testField').firstChild;
  goog.dom.Range.createFromNodes(text, 4, text, 8).select();

  goog.testing.events.fireClickSequence(text.parentNode);

  assertFalse('Field should not be made editable immediately after clicking',
      FIELD.isLoaded());
  CLOCK.tick(1);
  assertTrue('Field should be editable', FIELD.isLoaded());

  var dom = FIELD.getEditableDomHelper();
  var selection = goog.dom.Range.createFromWindow(dom.getWindow());

  var body = FIELD.getElement();
  text = body.firstChild;

  assertEquals('Wrong start node', text, selection.getStartNode());
  assertEquals('Wrong end node', text, selection.getEndNode());
  assertEquals('Wrong start offset', 4, selection.getStartOffset());
  assertEquals('Wrong end offset', 8, selection.getEndOffset());
}

function testBlendedClickToEdit() {
  testClickToEdit(true);
}


function testClickToEditWithAnchor(opt_isBlended) {
  // We bail out if we are running on chrome+winxp because of flaky selenium
  // issues. TODO(user): Remove this assertion once we start running on the
  // JsUnit farm.
  if (goog.userAgent.product.CHROME && goog.userAgent.WINDOWS) {
    return;
  }
  setUpField(opt_isBlended);

  goog.dom.getElement('testAnchor').focus();
  goog.testing.events.fireClickSequence(goog.dom.getElement('testAnchor'));

  CLOCK.tick(1);
  assertTrue('Field should be editable', FIELD.isLoaded());

  var dom = FIELD.getEditableDomHelper();
  var selection = goog.dom.Range.createFromWindow(dom.getWindow());

  // IE and Gecko and Safari are all dumb and put the cursor
  // in different places.
  var body = FIELD.getElement();
  var text = body.firstChild;
  var link = dom.getElementsByTagNameAndClass('A', null, body)[0].firstChild;
  var isIEorWebkit = goog.userAgent.WEBKIT || goog.userAgent.IE;
  assertEquals('Wrong start node',
      isIEorWebkit ? text : link, selection.getStartNode());
  assertEquals('Wrong start offset',
      isIEorWebkit ? 17 : 0, selection.getStartOffset());
  assertEquals('Wrong end node',
      isIEorWebkit ? text : link, selection.getEndNode());
  assertEquals('Wrong end offset',
      isIEorWebkit ? 17 : 0, selection.getEndOffset());
}

function testBlendedClickToEditWithAnchor() {
  testClickToEditWithAnchor(true);
}

">4 of 4 tests run in 7ms.<br />0 passed, 4 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testBlendedClickToEdit<br />Object #<Object> has no method 'blur'<br />ERROR in testBlendedClickToEditWithAnchor<br />Object #<Object> has no method 'blur'<br />ERROR in testClickToEdit<br />Object #<Object> has no method 'blur'<br />ERROR in testClickToEditWithAnchor<br />Object #<Object> has no method 'blur'<br /></td></tr>
<tr><td>style_test.html</td><td>Fail</td><td> 1 passed, 5 failed.</td><td title="

    goog.require('goog.cssom');
    goog.require('goog.cssom.iframe.style');
    goog.require('goog.testing.jsunit');
  

    // unit tests
    var propertiesToTest = [
      'color',
      'font-family',
      'font-style',
      'font-size',
      'font-variant',
      'border-top-style',
      'border-top-width',
      'border-top-color',
      'background-color',
      'margin-bottom'
    ];

    function crawlDom(startNode, func) {
      if (startNode.nodeType != 1) { return; }
      func(startNode);
      for (var i = 0; i < startNode.childNodes.length; i++) {
        crawlDom(startNode.childNodes[i], func);
      }
    }

    function getCurrentCssProperties(node, propList) {
      var props = {};
      if (node.nodeType != 1) { return; }
      for (var i = 0; i < propList.length; i++) {
        var prop = propList[i];
        if (node.currentStyle) { // IE
          var propCamelCase = '';
          var propParts = prop.split('-');
          for (var j = 0; j < propParts.length; j++) {
            propCamelCase += propParts[j].charAt(0).toUpperCase() +
                             propParts[j].substring(1, propParts[j].length);
          }
          props[prop] = node.currentStyle[propCamelCase];
        } else { // standards-compliant browsers
          props[prop] = node.ownerDocument.defaultView.getComputedStyle(
              node, '').getPropertyValue(prop);
        }
      }
      return props;
    }

    function CssPropertyCollector(){
      var propsList = [];
      this.propsList = propsList

      this.collectProps = function(node) {
        var nodeProps = getCurrentCssProperties(node, propertiesToTest);
        if (nodeProps) { propsList.push([nodeProps, node]); }
      }
    }

    function recursivelyListCssProperties(el) {
      var collector = new CssPropertyCollector();
      crawlDom(el, collector.collectProps);
      return collector.propsList;
    }

    function testMatchCssSelector() {
      var container = document.createElement('div');
      container.className = 'container';
      var el = document.createElement('div');
      x = el;
      el.id = 'mydiv';
      el.className = 'colorful foo';
      // set some arbirtrary content
      el.innerHTML = '<div><ul><li>One</li><li>Two</li></ul></div>';
      container.appendChild(el);
      document.body.appendChild(container);

      var elementAncestry = new goog.cssom.iframe.style.NodeAncestry_(el);
      assertEquals(5, elementAncestry.nodes.length);

      // list of input/output results. Output is the index of the selector
      // that we expect to match - for example, in 'body div div.colorful',
      // 'div.colorful' has an index of 2.
      var expectedResults = [
        ['body div', [4, 1]],
        ['h1',  null],
        ['body div h1', [4, 1]],
        ['body div.colorful h1', [4, 1]],
        ['body div div', [4, 2]],
        ['body div div div', [4, 2]],
        ['body div div.somethingelse div', [4, 1]],
        ['body div.somethingelse div', [2, 0]],
        ['div.container', [3, 0]],
        ['div.container div', [4, 1]],
        ['#mydiv', [4, 0]],
        ['div#mydiv', [4, 0]],
        ['div.colorful', [4, 0]],
        ['div#mydiv .colorful', [4, 0]],
        ['.colorful', [4, 0]],
        ['body * div', [4,2]],
        ['body * *', [4,2]]
      ];
      for (var i = 0; i < expectedResults.length; i++) {
        var input = expectedResults[i][0];
        var expectedResult = expectedResults[i][1];
        var selector = new goog.cssom.iframe.style.CssSelector_(input);
        var result = selector.matchElementAncestry(elementAncestry);
        if (expectedResult == null) {
          assertEquals('Expected null result', expectedResult, result);
        } else {
          assertEquals('Expected element index for ' + input,
                       expectedResult[0],
                       result.elementIndex);
          assertEquals('Expected selector part index for ' + input,
                       expectedResult[1],
                       result.selectorPartIndex);
        }
      }
      document.body.removeChild(container);
    }

    function makeIframeDocument(iframe) {
      var doc = goog.dom.getFrameContentDocument(iframe);
      doc.open();
      doc.write('<html><head>');
      doc.write('<style>html,body { background-color: transparent; }</style>');
      doc.write('</head><body></body></html>');
      doc.close();
      return doc;
    }

    function testCopyCss() {
      for (var i = 1; i <= 4; i++) {
        var sourceElement = document.getElementById('source'+i);
        var newFrame = document.createElement('iframe');
        newFrame.allowTransparency = true;
        sourceElement.parentNode.insertBefore(newFrame,
                                              sourceElement.nextSibling);
        var doc = makeIframeDocument(newFrame);
        goog.cssom.addCssText(
            goog.cssom.iframe.style.getElementContext(sourceElement),
            new goog.dom.DomHelper(doc));
        doc.body.innerHTML = sourceElement.innerHTML;

        var oldProps = recursivelyListCssProperties(sourceElement);
        var newProps = recursivelyListCssProperties(doc.body);

        assertEquals(oldProps.length, newProps.length);
        for (var j=0; j<oldProps.length; j++) {
          for (var k=0; k<propertiesToTest.length; k++) {
            assertEquals('testing property ' + propertiesToTest[k],
                         oldProps[j][0][propertiesToTest[k]],
                         newProps[j][0][propertiesToTest[k]]);
          }
        }
      }
    }

    function normalizeCssText(cssText) {
      // Normalize cssText for testing purposes.
      return cssText.replace(/\s/g, '').toLowerCase();
    }

    function testAImportantInFF2() {
      var testDiv = document.getElementById('source1');
      var cssText = normalizeCssText(
          goog.cssom.iframe.style.getElementContext(testDiv));
      var color = standardizeCSSValue('color', 'red');
      var NORMAL_RULE = 'a{color:' + color;
      var FF_2_RULE = 'a{color:' + color + '!important';
      if (goog.userAgent.GECKO && !goog.userAgent.isVersion('1.9a')) {
        assertContains(FF_2_RULE, cssText);
      } else {
        assertContains(NORMAL_RULE, cssText);
        assertNotContains(FF_2_RULE, cssText);
      }
    }

    function testCopyBackgroundContext() {
      var testDiv = document.getElementById('backgroundTest');
      var cssText = goog.cssom.iframe.style.getElementContext(testDiv,
                                                              null,
                                                              true);
      var iframe = document.createElement('iframe');
      var ancestor = document.getElementById('backgroundTest-ancestor-1');
      ancestor.parentNode.insertBefore(iframe, ancestor.nextSibling);
      iframe.style.width = '100%';
      iframe.style.height = '100px';
      iframe.style.borderWidth = '0px';
      var doc = makeIframeDocument(iframe);
      goog.cssom.addCssText(cssText, new goog.dom.DomHelper(doc));
      doc.body.innerHTML = testDiv.innerHTML;
      var normalizedCssText = normalizeCssText(cssText);
      assertTrue(
          'Background color should be copied from parent element',
          /body{[^{]*background-color:(?:rgb\(128,0,128\)|#800080)/.test(
              normalizedCssText));
      assertTrue(
          'Background image should be copied from ancestor element',
          /body{[^{]*background-image:url\(/.test(normalizedCssText));
      // Background-position can't be calculated in FF2, due to this bug:
      // http://bugzilla.mozilla.org/show_bug.cgi?id=316981
      if (!(goog.userAgent.GECKO && !goog.userAgent.isVersion('1.9'))) {
        // Expected x position is:
        // originalBackgroundPositionX - elementOffsetLeft
        // 40px - (1px + 8px) == 31px
        // Expected y position is:
        // originalBackgroundPositionY - elementOffsetLeft
        // 70px - (1px + 10px + 5px) == 54px;
        assertTrue('Background image position should be adjusted correctly',
            /body{[^{]*background-position:31px54px/.test(normalizedCssText));
      }
    }

    function testCopyBackgroundContextFromIframe() {
      var testDiv = document.getElementById('backgroundTest');
      var iframe = document.createElement('iframe');
      iframe.allowTransparency = true;
      iframe.style.position = 'absolute';
      iframe.style.top = '5px';
      iframe.style.left = '5px';
      iframe.style.borderWidth = '2px';
      iframe.style.borderStyle = 'solid';
      testDiv.appendChild(iframe);
      var doc = makeIframeDocument(iframe);
      doc.body.backgroundColor = 'transparent';
      doc.body.style.margin = '0';
      doc.body.style.padding = '0';
      doc.body.innerHTML = '<p style="margin: 0">I am transparent!</p>';
      var normalizedCssText = normalizeCssText(
          goog.cssom.iframe.style.getElementContext(
              doc.body.firstChild, null, true));
      // Background properties should get copied through from the parent
      // document since the iframe is transparent
      assertTrue(
          'Background color should be copied from parent element',
          /body{[^{]*background-color:(?:rgb\(128,0,128\)|#800080)/.test(
              normalizedCssText));
      assertTrue(
          'Background image should be copied from ancestor element',
          /body{[^{]*background-image:url\(/.test(normalizedCssText));
      // Background-position can't be calculated in FF2, due to this bug:
      // http://bugzilla.mozilla.org/show_bug.cgi?id=316981
      if (!(goog.userAgent.GECKO && !goog.userAgent.isVersion('1.9'))) {
        // Image offset should have been calculated to be the same as the
        // above example, but adding iframe offset and borderWidth.
        // Expected x position is:
        // originalBackgroundPositionX - elementOffsetLeft
        // 40px - (1px + 8px + 5px + 2px) == 24px
        // Expected y position is:
        // originalBackgroundPositionY - elementOffsetLeft
        // 70px - (1px + 10px + 5px + 5px + 2px) == 47px;
        assertTrue('Background image position should be adjusted correctly',
            !!/body{[^{]*background-position:24px47px/.exec(
                normalizedCssText))
      }
      iframe.parentNode.removeChild(iframe);
    }

    function testCopyFontFaceRules() {
      var isFontFaceCssomSupported =
          goog.userAgent.WEBKIT ||
          goog.userAgent.OPERA ||
          (goog.userAgent.GECKO && goog.userAgent.isVersion('1.9.1'));
      // We cannot use goog.testing.ExpectedFailures since it dynamically
      // brings in CSS which causes the background context tests to fail
      // in IE6.
      if (isFontFaceCssomSupported) {
        var cssText = goog.cssom.iframe.style.getElementContext(
            document.getElementById('cavalier'));
        assertTrue('The font face rule should have been copied correctly',
                   /@font-face/.test(cssText));
      }
    }

  ">6 of 6 tests run in 7ms.<br />1 passed, 5 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testAImportantInFF2<br />Cannot read property 'closure_uid_8lw2vp' of undefined<br />ERROR in testCopyBackgroundContext<br />Cannot read property 'closure_uid_8lw2vp' of undefined<br />ERROR in testCopyBackgroundContextFromIframe<br />Object #<Object> has no method 'createElement'<br />ERROR in testCopyCss<br />Object #<Object> has no method 'createElement'<br />ERROR in testMatchCssSelector<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>icontent_test.html</td><td>Fail</td><td> 0 passed, 7 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.classes');
  goog.require('goog.editor.BrowserFeature');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.PropertyReplacer');

  goog.require('goog.editor.icontent');



var wrapperDiv;
var realIframe;
var realIframeDoc;
var propertyReplacer;

function setUp() {
  wrapperDiv = goog.dom.createDom('div', null,
      realIframe = goog.dom.createDom('iframe'));
  goog.dom.appendChild(document.body, wrapperDiv);
  realIframeDoc = realIframe.contentWindow.document;
  propertyReplacer = new goog.testing.PropertyReplacer();
}

function tearDown() {
  goog.dom.removeNode(wrapperDiv);
  propertyReplacer.reset();
}

function testWriteHttpsInitialIframeContent() {
  // This is not a particularly useful test; it's just a sanity check to make
  // sure nothing explodes
  var info =
      new goog.editor.icontent.FieldFormatInfo('id', false, false, false);
  var doc = createMockDocument();
  goog.editor.icontent.writeHttpsInitialIframe(info, doc, 'some html');
  assertBodyCorrect(doc.body, 'id', 'some html');
}

function testWriteHttpsInitialIframeContentRtl() {
  var info = new goog.editor.icontent.FieldFormatInfo('id', false, false, true);
  var doc = createMockDocument();
  goog.editor.icontent.writeHttpsInitialIframe(info, doc, 'some html');
  assertBodyCorrect(doc.body, 'id', 'some html', true);
}

function testWriteInitialIframeContentBlendedStandardsGrowing() {
  if (goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE) {
    return; // only executes when using an iframe
  }

  var info = new goog.editor.icontent.FieldFormatInfo('id', true, true, false);
  var styleInfo = new goog.editor.icontent.FieldStyleInfo(wrapperDiv,
      '.MyClass { position: absolute; top: 500px; }');
  var doc = realIframeDoc;
  var html = '<div class="MyClass">Some Html</div>';
  goog.editor.icontent.writeNormalInitialBlendedIframe(info, html,
      styleInfo, realIframe);

  assertBodyCorrect(doc.body, 'id', html);
  assertEquals('CSS1Compat', doc.compatMode); // standards
  assertEquals('auto', doc.documentElement.style.height); // growing
  assertEquals('100%', doc.body.style.height); // standards
  assertEquals('hidden', doc.body.style.overflowY); // growing
  assertEquals('', realIframe.style.position); // no padding on wrapper

  assertEquals(500, doc.body.firstChild.offsetTop);
  assert(doc.getElementsByTagName('style')[0].innerHTML.indexOf(
             '-moz-force-broken-image-icon') != -1); // standards
}

function testWriteInitialIframeContentBlendedQuirksFixedRtl() {
  if (goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE) {
    return; // only executes when using an iframe
  }

  var info = new goog.editor.icontent.FieldFormatInfo('id', false, true, true);
  var styleInfo = new goog.editor.icontent.FieldStyleInfo(wrapperDiv, '');
  wrapperDiv.style.padding = '2px 5px';
  var doc = realIframeDoc;
  var html = 'Some Html';
  goog.editor.icontent.writeNormalInitialBlendedIframe(info, html,
      styleInfo, realIframe);

  assertBodyCorrect(doc.body, 'id', html, true);
  assertEquals('BackCompat', doc.compatMode); // quirks
  assertEquals('100%', doc.documentElement.style.height); // fixed height
  assertEquals('auto', doc.body.style.height); // quirks
  assertEquals('auto', doc.body.style.overflow); // fixed height

  assertEquals('-2px', realIframe.style.marginTop);
  assertEquals('-5px', realIframe.style.marginLeft);
  assert(doc.getElementsByTagName('style')[0].innerHTML.indexOf(
             '-moz-force-broken-image-icon') == -1); // quirks
}

function testWhiteboxStandardsFixedRtl() {
  var info = new goog.editor.icontent.FieldFormatInfo('id', true, false, true);
  var styleInfo = null;
  var doc = realIframeDoc;
  var html = 'Some Html';
  goog.editor.icontent.writeNormalInitialBlendedIframe(info, html,
      styleInfo, realIframe);
  assertBodyCorrect(doc.body, 'id', html, true);

  // TODO(nicksantos): on Safari, there's a bug where all written iframes
  // are CSS1Compat. It's fixed in the nightlies as of 3/31/08, so remove
  // this guard when the latest version of Safari is on the farm.
  if (!goog.userAgent.WEBKIT) {
    assertEquals('BackCompat', doc.compatMode); // always use quirks in whitebox
  }
}

function testGetInitialIframeContent() {
  var info = new goog.editor.icontent.FieldFormatInfo(
      'id', true, false, false);
  var styleInfo = null;
  var html = 'Some Html';
  propertyReplacer.set(goog.editor.BrowserFeature,
      'HAS_CONTENT_EDITABLE', false);
  var htmlOut = goog.editor.icontent.getInitialIframeContent_(
      info, html, styleInfo);
  assertEquals(/contentEditable/i.test(htmlOut), false);
  propertyReplacer.set(goog.editor.BrowserFeature,
      'HAS_CONTENT_EDITABLE', true);
  propertyReplacer.set(goog.editor.BrowserFeature,
      'FOCUSES_EDITABLE_BODY_ON_HTML_CLICK', false);
  htmlOut = goog.editor.icontent.getInitialIframeContent_(
      info, html, styleInfo);
  assertEquals(/<html[^>]+?contentEditable/i.test(htmlOut), true);
  propertyReplacer.set(goog.editor.BrowserFeature,
      'FOCUSES_EDITABLE_BODY_ON_HTML_CLICK', true);
  htmlOut = goog.editor.icontent.getInitialIframeContent_(
      info, html, styleInfo);
  assertEquals(/<body[^>]+?contentEditable/i.test(htmlOut), true);
};

function testBlendedStandardsGrowingMatchesComparisonDiv() {
  // TODO(nicksantos): If we ever move
  // TR_EditableUtil.prototype.makeIframeField_
  // into goog.editor.icontent (and I think we should), we could actually run
  // functional tests to ensure that the iframed field matches the dimensions
  // of the equivalent uneditable div. Functional tests would help a lot here.
}

/**
 * Check a given body for the most basic properties that all iframes must have.
 *
 * @param {Element} body The actual body element
 * @param {string} id The expected id
 * @param {string} bodyHTML The expected innerHTML
 * @param {boolean=} opt_rtl If true, expect RTL directionality
 */
function assertBodyCorrect(body, id, bodyHTML, opt_rtl) {
  assertEquals(bodyHTML, body.innerHTML);
  // We can't just check
  // assert(HAS_CONTENTE_EDITABLE, !!body.contentEditable) since in
  // FF 3 we don't currently use contentEditable, but body.contentEditable
  // = 'inherit' and !!'inherit' = true.
  if (goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE) {
    assertEquals('true', String(body.contentEditable));
  } else {
    assertNotEquals('true', String(body.contentEditable));
  }
  assert(goog.dom.classes.has(body, 'editable'));
  assertEquals('true', String(body.getAttribute('g_editable')));
  assertEquals('true',
      // IE has bugs with getAttribute('hideFocus'), and
      // Webkit has bugs with normal .hideFocus access.
      String(goog.userAgent.IE ? body.hideFocus :
          body.getAttribute('hideFocus')));
  assertEquals(id, body.id);
}

/**
 * @return {Object} A mock document
 */
function createMockDocument() {
  return {
    body: {
      setAttribute: function(key, val) { this[key] = val; },
      getAttribute: function(key) { return this[key]; },
      style: { direction: '' }
    }
  };
};

">7 of 7 tests run in 7ms.<br />0 passed, 7 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testBlendedStandardsGrowingMatchesComparisonDiv<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetInitialIframeContent<br />Object #<Object> has no method 'createElement'<br />ERROR in testWhiteboxStandardsFixedRtl<br />Object #<Object> has no method 'createElement'<br />ERROR in testWriteHttpsInitialIframeContent<br />Object #<Object> has no method 'createElement'<br />ERROR in testWriteHttpsInitialIframeContentRtl<br />Object #<Object> has no method 'createElement'<br />ERROR in testWriteInitialIframeContentBlendedQuirksFixedRtl<br />Object #<Object> has no method 'createElement'<br />ERROR in testWriteInitialIframeContentBlendedStandardsGrowing<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>focus_test.html</td><td>Fail</td><td> 0 passed, 1 failed.</td><td title="

  goog.require('goog.dom.selection');
  goog.require('goog.editor.focus');
  goog.require('goog.editor.BrowserFeature');
  goog.require('goog.testing.jsunit');



  function setUp() {
    // Make sure focus is not in the input to begin with.
    var dummy = document.getElementById('dummyLink');
    dummy.focus();
  }


  /**
   * Tests that focusInputField() puts focus in the input field and sets the
   * cursor to the end of the text cointained inside.
   */
  function testFocusInputField() {
    var input = document.getElementById('myInput');
    assertNotEquals('Input should not be focused initially',
                    input,
                    document.activeElement);

    goog.editor.focus.focusInputField(input);
    if (goog.editor.BrowserFeature.HAS_ACTIVE_ELEMENT) {
      assertEquals('Input should be focused after call to focusInputField',
                   input,
                   document.activeElement);
    }
    assertEquals('Selection should start at the end of the input text',
                 input.value.length,
                 goog.dom.selection.getStart(input));
    assertEquals('Selection should end at the end of the input text',
                 input.value.length,
                 goog.dom.selection.getEnd(input));
  }

">1 of 1 tests run in 5ms.<br />0 passed, 1 failed.<br />5 ms/test. 1 files loaded.<br />ERROR in testFocusInputField<br />Object #<Object> has no method 'focus'<br /></td></tr>
<tr><td>seamlessfield_quirks_test.html</td><td>Fail</td><td> undefined</td><td title="

">0 of 0 tests run in 3ms.<br />No tests found.  Call G_testRunner.setStrict(false) if this is expected behavior.<br /></td></tr>
<tr><td>link_test.html</td><td>Fail</td><td> 0 passed, 11 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.NodeType');
  goog.require('goog.dom.Range');
  goog.require('goog.dom.TagName');
  goog.require('goog.editor.Link');
  goog.require('goog.testing.dom');
  goog.require('goog.testing.jsunit');


var anchor;

function setUp() {
  anchor = goog.dom.createDom('A');
  document.body.appendChild(anchor);
}

function tearDown() {
  goog.dom.removeNode(anchor);
}

function testCreateNew() {
  var link = new goog.editor.Link(anchor, true);
  assertNotNull('Should have created object', link);
  assertTrue('Should be new', link.isNew());
  assertEquals('Should have correct anchor', anchor, link.getAnchor());
  assertEquals('Should be empty', '', link.getCurrentText());
}

function testCreateNotNew() {
  var link = new goog.editor.Link(anchor, false);
  assertNotNull('Should have created object', link);
  assertFalse('Should not be new', link.isNew());
  assertEquals('Should have correct anchor', anchor, link.getAnchor());
  assertEquals('Should be empty', '', link.getCurrentText());
}

function testInitialize() {
  var link = goog.editor.Link.createNewLink(anchor, 'http://www.google.com');
  assertNotNull('Should have created object', link);
  assertTrue('Should be new', link.isNew());
  assertEquals('Should have correct anchor', anchor, link.getAnchor());
  assertEquals('Should be empty', '', link.getCurrentText());
}

function testInitializeWithTarget() {
  var link = goog.editor.Link.createNewLink(anchor, 'http://www.google.com',
      '_blank');
  assertNotNull('Should have created object', link);
  assertTrue('Should be new', link.isNew());
  assertEquals('Should have correct anchor', anchor, link.getAnchor());
  assertEquals('Should be empty', '', link.getCurrentText());
  assertEquals('Should have _blank target', '_blank', anchor.target);
}

function testSetText() {
  var link = goog.editor.Link.createNewLink(anchor, 'http://www.google.com',
      '_blank');
  assertEquals('Should be empty', '', link.getCurrentText());
  link.setTextAndUrl('Text', 'http://docs.google.com/');
  assertEquals('Should point to http://docs.google.com/',
      'http://docs.google.com/', anchor.href);
  assertEquals('Should have correct text', 'Text', link.getCurrentText());
}

function testSetBoldText() {
  anchor.innerHTML = '<b></b>';
  var link = goog.editor.Link.createNewLink(anchor, 'http://www.google.com',
      '_blank');
  assertEquals('Should be empty', '', link.getCurrentText());
  link.setTextAndUrl('Text', 'http://docs.google.com/');
  assertEquals('Should point to http://docs.google.com/',
      'http://docs.google.com/', anchor.href);
  assertEquals('Should have correct text', 'Text', link.getCurrentText());
  assertEquals('Should still be bold', goog.dom.TagName.B,
      anchor.firstChild.tagName);
}

function testSetMixed() {
  anchor.innerHTML = '<b>A</b>B';
  var link = goog.editor.Link.createNewLink(anchor, 'http://www.google.com',
      '_blank');
  assertEquals('Should have text: AB', 'AB', link.getCurrentText());
  link.setTextAndUrl('Text', 'http://docs.google.com/');
  assertEquals('Should point to http://docs.google.com/',
      'http://docs.google.com/', anchor.href);
  assertEquals('Should have correct text', 'Text', link.getCurrentText());
  assertEquals('Should not be bold', goog.dom.NodeType.TEXT,
      anchor.firstChild.nodeType);
}

function testPlaceCursorRightOf() {
  // IE can only do selections properly if the region is editable.
  var ed = goog.dom.createDom('div');
  goog.dom.replaceNode(ed, anchor);
  ed.contentEditable = true;
  ed.appendChild(anchor);

  // In order to test the cursor placement properly, we need to have
  // link text.  See more details in the test below.
  anchor.innerHTML = 'I am text';

  var link = goog.editor.Link.createNewLink(anchor, 'http://www.google.com');
  link.placeCursorRightOf();

  var range = goog.dom.Range.createFromWindow();
  assertTrue('Range should be collapsed', range.isCollapsed());
  var startNode = range.getStartNode();

  if (goog.userAgent.WEBKIT && !goog.userAgent.isVersion('528')) {
    assertEquals('Selection should be to the right of the anchor',
        anchor, startNode.previousSibling);
  } else {
    // Check that the selection is the "right" place.
    //
    // If you query the selection, it is actually still inside the anchor,
    // but if you type, it types outside the anchor.
    //
    // Best we can do is test that it is at the end of the anchor text.
    assertEquals('Selection should be in anchor text',
        anchor.firstChild, startNode);
    assertEquals('Selection should be at the end of the text',
        anchor.firstChild.length, range.getStartOffset());
  }

  if (ed) {
    goog.dom.removeNode(ed);
  }
}

function testIsLikelyUrl() {
  var good = [
    // Proper URLs
    'http://google.com', 'http://google.com/', 'http://192.168.1.103',
    'http://www.google.com:8083', 'https://antoine', 'https://foo.foo.net',
    'ftp://google.com:22/', 'http://user@site.com',
    'ftp://user:pass@ftp.site.com', 'http://google.com/search?q=laser%20cats',
    'aim:goim?screenname=en2es', 'mailto:x@y.com',

    // Bad URLs a browser will accept
    'www.google.com', 'www.amazon.co.uk', 'amazon.co.uk', 'foo2.foo3.com',
    'pandora.tv', 'marketing.us', 'del.icio.us', 'bridge-line.com',
    'www.frigid.net:80', 'www.google.com?q=foo', 'www.foo.com/j%20.txt',
    'foodtv.net', 'google.com', 'slashdot.org', '192.168.1.1',
    'justin.edu?kumar&nbsp;something', 'google.com/search?q=hot%20pockets',

    // Due to TLD explosion, these could be URLs either now or soon.
    'ww.jester', 'juicer.fake', 'abs.nonsense.something', 'filename.txt'
  ];
  for (var i = 0; i < good.length; i++) {
    assertTrue(good[i] + ' should be good',
        goog.editor.Link.isLikelyUrl(good[i]));
  }

  var bad = [
    // Definitely not URLs
    'bananas', 'http google com', '<img>', 'Sad :/', '*garbage!.123',
    'ftp', 'http', '/', 'https', 'this is', '*!&.banana!*&!',
    'www.jester is gone.com', 'ftp .nospaces.net', 'www_foo_net',
    "www.'jester'.net", 'www:8080',
    'www . notnsense.com', 'email@address.com',

    // URL-ish but not quite
    '  http://www.google.com', 'http://www.google.com:8081   ',
    'www.google.com foo bar', 'google.com/search?q=not quite'
  ];

  for (i = 0; i < bad.length; i++) {
    assertFalse(bad[i] + ' should be bad',
        goog.editor.Link.isLikelyUrl(bad[i]));
  }
};

function testIsLikelyEmailAddress() {
  var good = [
    // Valid email addresses
    'foo@foo.com', 'foo1@foo2.foo3.com', 'f45_1@goog13.org', 'user@gmail.co.uk',
    'jon-smith@crazy.net', 'roland1@capuchino.gov', 'ernir@gshi.nl',
    'JOON@jno.COM', 'media@meDIa.fREnology.FR', 'john.mail4me@del.icio.us',
    'www9@wc3.madeup1.org', 'hi@192.168.1.103', 'hi@192.168.1.1'
  ];
  for (var i = 0; i < good.length; i++) {
    assertTrue(goog.editor.Link.isLikelyEmailAddress(good[i]));
  }

  var bad = [
    // Malformed/incomplete email addresses
    'user', '@gmail.com', 'user@gmail', 'user@.com', 'user@gmail.c',
    'user@gmail.co.u', '@ya.com', '.@hi3.nl', 'jim.com',
    'ed:@gmail.com', '*!&.banana!*&!', ':jon@gmail.com',
    '3g?@bil.com', 'adam be@hi.net', 'john\nsmith@test.com',
    "www.'jester'.net", "'james'@covald.net", 'ftp://user@site.com/',
    'aim:goim?screenname=en2es', 'user:pass@site.com', 'user@site.com yay'
  ];

  for (i = 0; i < bad.length; i++) {
    assertFalse(goog.editor.Link.isLikelyEmailAddress(bad[i]));
  }
};

function testIsMailToLink() {
  assertFalse(goog.editor.Link.isMailto());
  assertFalse(goog.editor.Link.isMailto(null));
  assertFalse(goog.editor.Link.isMailto(''));
  assertFalse(goog.editor.Link.isMailto('http://foo.com'));
  assertFalse(goog.editor.Link.isMailto('http://mailto:80'));

  assertTrue(goog.editor.Link.isMailto('mailto:'));
  assertTrue(goog.editor.Link.isMailto('mailto://'));
  assertTrue(goog.editor.Link.isMailto('mailto://ptucker@gmail.com'));
}

">11 of 11 tests run in 16ms.<br />0 passed, 11 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testCreateNew<br />Object #<Object> has no method 'createElement'<br />ERROR in testCreateNotNew<br />Object #<Object> has no method 'createElement'<br />ERROR in testInitialize<br />Object #<Object> has no method 'createElement'<br />ERROR in testInitializeWithTarget<br />Object #<Object> has no method 'createElement'<br />ERROR in testIsLikelyEmailAddress<br />Object #<Object> has no method 'createElement'<br />ERROR in testIsLikelyUrl<br />Object #<Object> has no method 'createElement'<br />ERROR in testIsMailToLink<br />Object #<Object> has no method 'createElement'<br />ERROR in testPlaceCursorRightOf<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetBoldText<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetMixed<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetText<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>fs_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="


goog.require('goog.testing.AsyncTestCase');
goog.require('goog.testing.fs');
goog.require('goog.testing.fs.Blob');
goog.require('goog.testing.jsunit');



var asyncTestCase = goog.testing.AsyncTestCase.createAndInstall();

function testObjectUrls() {
  var blob = goog.testing.fs.getBlob('foo');
  var url = goog.testing.fs.createObjectUrl(blob);
  assertTrue(goog.testing.fs.isObjectUrlGranted(blob));
  goog.testing.fs.revokeObjectUrl(url);
  assertFalse(goog.testing.fs.isObjectUrlGranted(blob));
}

function testGetBlob() {
  assertEquals(
      new goog.testing.fs.Blob('foobarbaz').toString(),
      goog.testing.fs.getBlob('foo', 'bar', 'baz').toString());
  assertEquals(
      new goog.testing.fs.Blob('foobarbaz').toString(),
      goog.testing.fs.getBlob('foo', new goog.testing.fs.Blob('bar'), 'baz').
        toString());
}

function testBlobToString() {
  goog.testing.fs.blobToString(new goog.testing.fs.Blob('foobarbaz')).
      addCallback(goog.partial(assertEquals, 'foobarbaz')).
      addCallback(goog.bind(asyncTestCase.continueTesting, asyncTestCase));
  asyncTestCase.waitForAsync('testBlobToString');
}

">n/a</td></tr>
<tr><td>cursor_test.html</td><td>Success</td><td> 4 passed, 0 failed.</td><td title="

  goog.require('goog.testing.jsunit');

  goog.require('goog.style.cursor');
  goog.require('goog.userAgent');



var baseCursorUrl = '/images/2/';
var origWindowsUserAgentValue;
var origGeckoUserAgentValue;
var origWebkitUserAgentValue;


function setUp() {
  origWindowsUserAgentValue = goog.userAgent.WINDOWS;
  origGeckoUserAgentValue = goog.userAgent.GECKO;
  origWebkitUserAgentValue = goog.userAgent.WEBKIT;
}


function tearDown() {
  goog.userAgent.WINDOWS = origWindowsUserAgentValue;
  goog.userAgent.GECKO = origGeckoUserAgentValue;
  goog.userAgent.WEBKIT = origWebkitUserAgentValue;
}


function testGetCursorStylesWebkit() {
  goog.userAgent.GECKO = false;
  goog.userAgent.WEBKIT = true;

  assertEquals('Webkit should get a cursor style with moved hot-spot.',
      'url("/images/2/openhand.cur") 7 5, default',
      goog.style.cursor.getDraggableCursorStyle(baseCursorUrl));
  assertEquals('Webkit should get a cursor style with moved hot-spot.',
      'url("/images/2/openhand.cur") 7 5, default !important',
      goog.style.cursor.getDraggableCursorStyle(baseCursorUrl, true));

  assertEquals('Webkit should get a cursor style with moved hot-spot.',
      'url("/images/2/closedhand.cur") 7 5, move',
      goog.style.cursor.getDraggingCursorStyle(baseCursorUrl));
  assertEquals('Webkit should get a cursor style with moved hot-spot.',
      'url("/images/2/closedhand.cur") 7 5, move !important',
      goog.style.cursor.getDraggingCursorStyle(baseCursorUrl, true));
}


function testGetCursorStylesFireFoxNonWin() {
  goog.userAgent.GECKO = true;
  goog.userAgent.WEBKIT = false;
  goog.userAgent.WINDOWS = false;

  assertEquals('FireFox on non Windows should get a custom cursor style.',
      '-moz-grab',
      goog.style.cursor.getDraggableCursorStyle(baseCursorUrl));
  assertEquals('FireFox on non Windows should get a custom cursor style and ' +
      'no !important modifier.',
      '-moz-grab',
      goog.style.cursor.getDraggableCursorStyle(baseCursorUrl, true));

  assertEquals('FireFox on non Windows should get a custom cursor style.',
      '-moz-grabbing',
      goog.style.cursor.getDraggingCursorStyle(baseCursorUrl));
  assertEquals('FireFox on non Windows should get a custom cursor style and ' +
          'no !important modifier.',
      '-moz-grabbing',
      goog.style.cursor.getDraggingCursorStyle(baseCursorUrl, true));
}


function testGetCursorStylesFireFoxWin() {
  goog.userAgent.GECKO = true;
  goog.userAgent.WEBKIT = false;
  goog.userAgent.WINDOWS = true;

  assertEquals('FireFox should get a cursor style with URL.',
      'url("/images/2/openhand.cur"), default',
      goog.style.cursor.getDraggableCursorStyle(baseCursorUrl));
  assertEquals('FireFox should get a cursor style with URL and no !important' +
          ' modifier.',
      'url("/images/2/openhand.cur"), default',
      goog.style.cursor.getDraggableCursorStyle(baseCursorUrl, true));

  assertEquals('FireFox should get a cursor style with URL.',
      'url("/images/2/closedhand.cur"), move',
      goog.style.cursor.getDraggingCursorStyle(baseCursorUrl));
  assertEquals('FireFox should get a cursor style with URL and no !important' +
          ' modifier.',
      'url("/images/2/closedhand.cur"), move',
      goog.style.cursor.getDraggingCursorStyle(baseCursorUrl, true));
}


function testGetCursorStylesOther() {
  goog.userAgent.GECKO = false;
  goog.userAgent.WEBKIT = false;

  assertEquals('Other browsers (IE) should get a cursor style with URL.',
      'url("/images/2/openhand.cur"), default',
      goog.style.cursor.getDraggableCursorStyle(baseCursorUrl));
  assertEquals('Other browsers (IE) should get a cursor style with URL.',
      'url("/images/2/openhand.cur"), default !important',
      goog.style.cursor.getDraggableCursorStyle(baseCursorUrl, true));

  assertEquals('Other browsers (IE) should get a cursor style with URL.',
      'url("/images/2/closedhand.cur"), move',
      goog.style.cursor.getDraggingCursorStyle(baseCursorUrl));
  assertEquals('Other browsers (IE) should get a cursor style with URL.',
      'url("/images/2/closedhand.cur"), move !important',
      goog.style.cursor.getDraggingCursorStyle(baseCursorUrl, true));
}
">n/a</td></tr>
<tr><td>style_quirks_test.html</td><td>Fail</td><td> undefined</td><td title="


goog.require('goog.color');
goog.require('goog.dom');
goog.require('goog.math.Coordinate');
goog.require('goog.math.Size');
goog.require('goog.style');
goog.require('goog.testing.ExpectedFailures');
goog.require('goog.testing.jsunit');
goog.require('goog.userAgent');
goog.require('goog.userAgent.product');
goog.require('goog.userAgent.product.isVersion');



var isBorderBox = true;



var expectedFailures = new goog.testing.ExpectedFailures();

function setUpPage() {
  var viewportSize = goog.dom.getViewportSize();
  // When the window is too short or not wide enough, some tests, especially
  // those for off-screen elements, fail.  Oddly, the most reliable
  // height sometimes includes a scroll bar.  We can make no assumptions on
  // window size on the Selenium farm.
  if (goog.userAgent.IE && !viewportSize.width) {
    // Move to origin, since IE won't resize outside the screen.
    window.moveTo(0, 0);
    window.resizeTo(640, 480);
  }
}

function setUp() {
  window.scrollTo(0, 0);
}

function tearDown() {
  expectedFailures.handleTearDown();
}

function testSetStyle() {
  var el = goog.dom.getElement('span1');
  goog.style.setStyle(el, 'textDecoration', 'underline');
  assertEquals('Should be underline', 'underline', el.style.textDecoration);
}

function testSetStyleMap() {
  var el = goog.dom.getElement('span6');

  var styles = {
    'background-color': 'blue',
    'font-size': '100px',
    textAlign: 'center'
  };

  goog.style.setStyle(el, styles);

  var answers = {
    backgroundColor: 'blue',
    fontSize: '100px',
    textAlign: 'center'
  };

  goog.object.forEach(answers, function(value, style) {
    assertEquals('Should be ' + value, value, el.style[style]);
  });
}

function testSetStyleWithNonCamelizedString() {
  var el = goog.dom.getElement('span5');
  goog.style.setStyle(el, 'text-decoration', 'underline');
  assertEquals('Should be underline', 'underline', el.style.textDecoration);
}

function testGetStyle() {
  var el = goog.dom.getElement('styleTest3');
  goog.style.setStyle(el, 'width', '80px');
  goog.style.setStyle(el, 'textDecoration', 'underline');

  assertEquals('80px', goog.style.getStyle(el, 'width'));
  assertEquals('underline', goog.style.getStyle(el, 'textDecoration'));
  assertEquals('underline', goog.style.getStyle(el, 'text-decoration'));
  // Non set properties are always empty strings.
  assertEquals('', goog.style.getStyle(el, 'border'));
}

function testGetStyleMsFilter() {
  // Element with -ms-filter style set.
  var e = goog.dom.getElement('msFilter');

  if (goog.userAgent.IE && goog.userAgent.isVersion(8)) {
    // Only IE8 supports -ms-filter and returns it as value for the "filter"
    // property. When in compatibility mode, -ms-filter is not supported
    // and IE8 behaves as IE7 so the other case will apply.
    assertEquals('alpha(opacity=0)', goog.style.getStyle(e, 'filter'));
  } else {
    // Any other browser does not support ms-filter so it returns empty string.
    assertEquals('', goog.style.getStyle(e, 'filter'));
  }
}

function testGetStyleFilter() {
  // Element with filter style set.
  var e = goog.dom.getElement('filter');

  if (goog.userAgent.IE) {
    // Filter supported.
    assertEquals('alpha(opacity=0)', goog.style.getStyle(e, 'filter'));
  } else {
    assertEquals('', goog.style.getStyle(e, 'filter'));
  }
}

function testGetComputedStyleMsFilter() {
  // Element with -ms-filter style set.
  var e = goog.dom.getElement('msFilter');

  if (goog.userAgent.IE) {
    // IE always returns empty string for computed styles.
    assertEquals('', goog.style.getComputedStyle(e, 'filter'));
  } else {
    // Non IE returns 'none' for filter as it is a SVG property
    assertEquals('none', goog.style.getComputedStyle(e, 'filter'));
  }
}

function testGetComputedStyleFilter() {
  // Element with filter style set.
  var e = goog.dom.getElement('filter');

  if (goog.userAgent.IE) {
    // IE always returns empty string for computed styles.
    assertEquals('', goog.style.getComputedStyle(e, 'filter'));
  } else {
    // Non IE returns 'none' for filter as it is a SVG property
    assertEquals('none', goog.style.getComputedStyle(e, 'filter'));
  }
}

function testGetBackgroundColor() {
  var dest = goog.dom.getElement('bgcolorDest');

  for (var i = 0; goog.dom.getElement('bgcolorTest' + i); i++) {
    var src = goog.dom.getElement('bgcolorTest' + i);
    var bgColor = goog.style.getBackgroundColor(src);

    dest.style.backgroundColor = bgColor;
    assertEquals('Background colors should be equal',
                 goog.style.getBackgroundColor(src),
                 goog.style.getBackgroundColor(dest));

    try {
      // goog.color.parse throws a generic exception if handed input it
      // doesn't understand.
      var c = goog.color.parse(bgColor);
      assertEquals('rgb(255,0,0)', goog.color.hexToRgbStyle(c.hex));
    } catch (e) {
      // Internet Explorer is unable to parse colors correctly after test 4.
      // Other browsers may vary, but all should be able to handle straight
      // hex input.
      assertFalse('Should be able to parse color "' + bgColor + '"', i < 5);
    }
  }
}

function testSetPosition() {
  var el = goog.dom.getElement('testEl');

  goog.style.setPosition(el, 100, 100);
  assertEquals('100px', el.style.left);
  assertEquals('100px', el.style.top);

  goog.style.setPosition(el, '50px', '25px');
  assertEquals('50px', el.style.left);
  assertEquals('25px', el.style.top);

  goog.style.setPosition(el, '10ex', '25px');
  assertEquals('10ex', el.style.left);
  assertEquals('25px', el.style.top);

  goog.style.setPosition(el, '10%', '25%');
  assertEquals('10%', el.style.left);
  assertEquals('25%', el.style.top);

  // ignores stupid units
  goog.style.setPosition(el, 0, 0);
  // TODO(user): IE errors if you set these values.  Should we make setStyle
  // catch these?  Or leave it up to the app.  Fixing the tests for now.
  //goog.style.setPosition(el, '10rainbows', '25rainbows');
  assertEquals('0px', el.style.left);
  assertEquals('0px', el.style.top);


  goog.style.setPosition(el, new goog.math.Coordinate(20,40));
  assertEquals('20px', el.style.left);
  assertEquals('40px', el.style.top);
}

function testGetClientPositionAbsPositionElement() {
  var div = goog.dom.createDom('DIV');
  div.style.position = 'absolute';
  div.style.left = '100px';
  div.style.top = '200px';
  document.body.appendChild(div);
  var pos = goog.style.getClientPosition(div);
  assertEquals(100, pos.x);
  assertEquals(200, pos.y);
}

function testGetClientPositionNestedElements() {
  var innerDiv = goog.dom.createDom('DIV');
  innerDiv.style.position = 'relative';
  innerDiv.style.left = '-10px';
  innerDiv.style.top = '-10px';
  var div = goog.dom.createDom('DIV');
  div.style.position = 'absolute';
  div.style.left = '150px';
  div.style.top = '250px';
  div.appendChild(innerDiv);
  document.body.appendChild(div);
  var pos = goog.style.getClientPosition(innerDiv);
  assertEquals(140, pos.x);
  assertEquals(240, pos.y);
}

function testGetClientPositionOfOffscreenElement() {
  var div = goog.dom.createDom('DIV');
  div.style.position = 'absolute';
  div.style.left = '2000px';
  div.style.top = '2000px';
  div.style.width = '10px';
  div.style.height = '10px';
  document.body.appendChild(div);

  window.scroll(0, 0);
  var pos = goog.style.getClientPosition(div);
  assertEquals(2000, pos.x);
  assertEquals(2000, pos.y);

  // The following tests do not work in Gecko 1.8 and below, due to an
  // obscure off-by-one bug in goog.style.getPageOffset.  Same for IE.
  if (!(goog.userAgent.IE) &&
      !(goog.userAgent.GECKO && !goog.userAgent.isVersion('1.9'))) {
    window.scroll(1, 1);
    var pos = goog.style.getClientPosition(div);
    assertEquals(1999, pos.x);
    assertEquals(1999, pos.y);

    window.scroll(2, 2);
    pos = goog.style.getClientPosition(div);
    assertEquals(1998, pos.x);
    assertEquals(1998, pos.y);

    window.scroll(100, 100);
    pos = goog.style.getClientPosition(div);
    assertEquals(1900, pos.x);
    assertEquals(1900, pos.y);
  }
}

function testGetPageOffsetAbsPositionedElement() {
  var div = goog.dom.createDom('DIV');
  div.style.position = 'absolute';
  div.style.left = '100px';
  div.style.top = '200px';
  document.body.appendChild(div);
  var pos = goog.style.getPageOffset(div);
  assertEquals(100, pos.x);
  assertEquals(200, pos.y);
}

function testGetPageOffsetNestedElements() {
  var innerDiv = goog.dom.createDom('DIV');
  innerDiv.style.position = 'relative';
  innerDiv.style.left = '-10px';
  innerDiv.style.top = '-10px';
  var div = goog.dom.createDom('DIV');
  div.style.position = 'absolute';
  div.style.left = '150px';
  div.style.top = '250px';
  div.appendChild(innerDiv);
  document.body.appendChild(div);
  var pos = goog.style.getPageOffset(innerDiv);
  assertEquals(140, pos.x);
  assertEquals(240, pos.y);
}

function testGetPageOffsetWithBodyPadding() {
  try {
    document.body.style.margin = '40px'
    document.body.style.padding = '60px'
    document.body.style.borderWidth = '70px';
    var div = goog.dom.createDom('DIV');
    div.style.position = 'absolute';
    div.style.left = '100px';
    div.style.top = '200px';
    // Margin will affect position, but padding and borders should not.
    div.style.margin = '1px';
    div.style.padding = '2px';
    div.style.borderWidth = '3px';
    document.body.appendChild(div);
    var pos = goog.style.getPageOffset(div);
    assertEquals(101, pos.x);
    assertEquals(201, pos.y);
  } finally {
    document.body.style.margin = '';
    document.body.style.padding = '';
    document.body.style.borderWidth = '';
  }
}

function testGetPageOffsetWithDocumentElementPadding() {
  try {
    document.documentElement.style.margin = '40px';
    document.documentElement.style.padding = '60px';
    document.documentElement.style.borderWidth = '70px';
    var div = goog.dom.createDom('DIV');
    div.style.position = 'absolute';
    div.style.left = '100px';
    div.style.top = '200px';
    // Margin will affect position, but padding and borders should not.
    div.style.margin = '1px';
    div.style.padding = '2px';
    div.style.borderWidth = '3px';
    document.body.appendChild(div);
    var pos = goog.style.getPageOffset(div);
    // FF3 (but not beyond) gets confused by document margins.
    if (goog.userAgent.GECKO && goog.userAgent.isVersion('1.9') &&
        !goog.userAgent.isVersion('1.9.1')) {
      assertEquals(141, pos.x);
      assertEquals(241, pos.y);
    } else {
      assertEquals(101, pos.x);
      assertEquals(201, pos.y);
    }
  } finally {
    document.documentElement.style.margin = '';
    document.documentElement.style.padding = '';
    document.documentElement.style.borderWidth = '';
  }
}

function testGetPageOffsetElementOffscreen() {
  var div = goog.dom.createDom('DIV');
  div.style.position = 'absolute';
  div.style.left = '10000px';
  div.style.top = '20000px';
  document.body.appendChild(div);
  window.scroll(0, 0);
  var pos = goog.style.getPageOffset(div);
  assertEquals(10000, pos.x);
  assertEquals(20000, pos.y);

  // The following tests do not work in Gecko 1.8 and below, due to an
  // obscure off-by-one bug in goog.style.getPageOffset.  Same for IE.
  if (!(goog.userAgent.IE) &&
      !(goog.userAgent.GECKO && !goog.userAgent.isVersion('1.9'))) {
    window.scroll(1, 1);
    pos = goog.style.getPageOffset(div);
    assertEquals(10000, pos.x);
    assertEquals(20000, pos.y);

    window.scroll(1000, 2000);
    pos = goog.style.getPageOffset(div);
    assertEquals(10000, pos.x);
    assertEquals(20000, pos.y);

    window.scroll(10000, 20000);
    pos = goog.style.getPageOffset(div);
    assertEquals(10000, pos.x);
    assertEquals(20000, pos.y);
  }

  // Undo changes.
  document.body.removeChild(div);
  window.scroll(0, 0);
}

function testGetPageOffsetFixedPositionElements() {
  // Skip these tests in certain browsers.
  // position:fixed is not supported in IE before version 7
  // TODO(user): This conditional looks fishy: it excludes all versions of
  // IE version 6 and greater.
  if (!goog.userAgent.IE || !goog.userAgent.isVersion('6')) {
    // Test with a position fixed element
    var div = goog.dom.createDom('DIV');
    div.style.position = 'fixed';
    div.style.top = '10px';
    div.style.left = '10px';
    document.body.appendChild(div);
    var pos = goog.style.getPageOffset(div);
    assertEquals(10, pos.x);
    assertEquals(10, pos.y);

    // Test with a position fixed element as parent
    var innerDiv = goog.dom.createDom('DIV');
    div = goog.dom.createDom('DIV');
    div.style.position = 'fixed';
    div.style.top = '10px';
    div.style.left = '10px';
    div.style.padding = '5px';
    div.appendChild(innerDiv);
    document.body.appendChild(div);
    pos = goog.style.getPageOffset(innerDiv);
    assertEquals(15, pos.x);
    assertEquals(15, pos.y);
  }
}

function testGetPositionTolerantToNoDocumentElementBorder() {
  // In IE, removing the border on the document element undoes the normal
  // 2-pixel offset.  Ensure that we're correctly compensating for both cases.
  try {
    document.documentElement.style.borderWidth = '0';
    var div = goog.dom.createDom('DIV');
    div.style.position = 'absolute';
    div.style.left = '100px';
    div.style.top = '200px';
    document.body.appendChild(div);
    // Test all major positioning methods.
    // Temporarily disabled for IE8 - IE8 returns dimensions multiplied by 100
    expectedFailures.expectFailureFor(isIE8());
    try {
      var pos = goog.style.getClientPosition(div);
      assertEquals(100, pos.x);
      assertEquals(200, pos.y);
      var offset = goog.style.getPageOffset(div);
      assertEquals(100, offset.x);
      assertEquals(200, offset.y);
    } catch (e) {
      expectedFailures.handleException(e);
    }
  } finally {
    document.documentElement.style.borderWidth = '';
  }
}

function testSetSize() {
  var el = goog.dom.getElement('testEl');

  goog.style.setSize(el, 100, 100);
  assertEquals('100px', el.style.width);
  assertEquals('100px', el.style.height);

  goog.style.setSize(el, '50px', '25px');
  assertEquals('should be "50px"', '50px', el.style.width);
  assertEquals('should be "25px"', '25px', el.style.height);

  goog.style.setSize(el, '10ex', '25px');
  assertEquals('10ex', el.style.width);
  assertEquals('25px', el.style.height);

  goog.style.setSize(el, '10%', '25%');
  assertEquals('10%', el.style.width);
  assertEquals('25%', el.style.height);

  // ignores stupid units
  goog.style.setSize(el, 0, 0);
  // TODO(user): IE errors if you set these values.  Should we make setStyle
  // catch these?  Or leave it up to the app.  Fixing the tests for now.
  //goog.style.setSize(el, '10rainbows', '25rainbows');
  assertEquals('0px', el.style.width);
  assertEquals('0px', el.style.height);

  goog.style.setSize(el, new goog.math.Size(20,40));
  assertEquals('20px', el.style.width);
  assertEquals('40px', el.style.height);
}

function testSetWidthAndHeight() {
  var el = goog.dom.getElement('testEl');

  // Replicate all of the setSize tests above.

  goog.style.setWidth(el, 100);
  goog.style.setHeight(el, 100);
  assertEquals('100px', el.style.width);
  assertEquals('100px', el.style.height);

  goog.style.setWidth(el, '50px');
  goog.style.setHeight(el, '25px');
  assertEquals('should be "50px"', '50px', el.style.width);
  assertEquals('should be "25px"', '25px', el.style.height);

  goog.style.setWidth(el, '10ex');
  goog.style.setHeight(el, '25px');
  assertEquals('10ex', el.style.width);
  assertEquals('25px', el.style.height);

  goog.style.setWidth(el, '10%');
  goog.style.setHeight(el, '25%');
  assertEquals('10%', el.style.width);
  assertEquals('25%', el.style.height);

  goog.style.setWidth(el, 0);
  goog.style.setHeight(el, 0);
  assertEquals('0px', el.style.width);
  assertEquals('0px', el.style.height);

  goog.style.setWidth(el, 20);
  goog.style.setHeight(el, 40);
  assertEquals('20px', el.style.width);
  assertEquals('40px', el.style.height);

  // Additional tests testing each separately.
  goog.style.setWidth(el, '');
  goog.style.setHeight(el, '');
  assertEquals('', el.style.width);
  assertEquals('', el.style.height);

  goog.style.setHeight(el, 20);
  assertEquals('', el.style.width);
  assertEquals('20px', el.style.height);

  goog.style.setWidth(el, 40);
  assertEquals('40px', el.style.width);
  assertEquals('20px', el.style.height);
}

function testGetSize() {
  var el = goog.dom.getElement('testEl');
  goog.style.setSize(el, 100, 100);

  var dims = goog.style.getSize(el);
  assertEquals(100, dims.width);
  assertEquals(100, dims.height);

  goog.style.setStyle(el, 'display', 'none');
  dims = goog.style.getSize(el);
  assertEquals(100, dims.width);
  assertEquals(100, dims.height);

  el = goog.dom.getElement('testEl5');
  goog.style.setSize(el, 100, 100);
  dims = goog.style.getSize(el);
  assertEquals(100, dims.width);
  assertEquals(100, dims.height);

  el = goog.dom.getElement('span0');
  dims = goog.style.getSize(el);
  assertNotEquals(0, dims.width);
  assertNotEquals(0, dims.height);

  el = goog.dom.getElement('table1');
  dims = goog.style.getSize(el);
  assertNotEquals(0, dims.width);
  assertNotEquals(0, dims.height);

  el = goog.dom.getElement('td1');
  dims = goog.style.getSize(el);
  assertNotEquals(0, dims.width);
  assertNotEquals(0, dims.height);

  el = goog.dom.getElement('li1');
  dims = goog.style.getSize(el);
  assertNotEquals(0, dims.width);
  assertNotEquals(0, dims.height);

  el = goog.dom.getElementsByTagNameAndClass('html')[0];
  dims = goog.style.getSize(el);
  assertNotEquals(0, dims.width);
  assertNotEquals(0, dims.height);

  el = goog.dom.getElementsByTagNameAndClass('body')[0];
  dims = goog.style.getSize(el);
  assertNotEquals(0, dims.width);
  assertNotEquals(0, dims.height);
}

function testGetSizeInlineBlock() {
  var el = goog.dom.getElement('height-test-inner');
  var dims = goog.style.getSize(el);
  assertNotEquals(0, dims.height);
}

function testGetBounds() {
  var el = goog.dom.getElement('testEl');

  var dims = goog.style.getSize(el);
  var pos = goog.style.getPageOffset(el);

  var rect = goog.style.getBounds(el);

  // Relies on getSize and getPageOffset being correct.
  assertEquals(dims.width, rect.width);
  assertEquals(dims.height, rect.height);
  assertEquals(pos.x, rect.left);
  assertEquals(pos.y, rect.top);
}

function testInstallStyles() {
  var el = goog.dom.getElement('installTest0');
  var originalBackground = goog.style.getBackgroundColor(el);

  // Uses background-color because it's easy to get the computed value
  var result = goog.style.installStyles(
      '#installTest0 { background-color: rgb(255, 192, 203); }');

  assertColorRgbEquals('rgb(255,192,203)', goog.style.getBackgroundColor(el));

  goog.style.uninstallStyles(result);
  assertEquals(originalBackground, goog.style.getBackgroundColor(el));
}

function testSetStyles() {
  var el = goog.dom.getElement('installTest1');

  // Change to pink
  var ss = goog.style.installStyles(
      '#installTest1 { background-color: rgb(255, 192, 203); }');
  assertColorRgbEquals('rgb(255,192,203)', goog.style.getBackgroundColor(el));

  // Now change to orange
  goog.style.setStyles(ss,
      '#installTest1 { background-color: rgb(255, 255, 0); }');
  assertColorRgbEquals('rgb(255,255,0)', goog.style.getBackgroundColor(el));
}


function assertColorRgbEquals(expected, actual) {
  assertEquals(expected,
      goog.color.hexToRgbStyle(goog.color.parse(actual).hex));
}

function testIsRightToLeft() {
  assertFalse(goog.style.isRightToLeft(goog.dom.getElement('rtl1')));
  assertTrue(goog.style.isRightToLeft(goog.dom.getElement('rtl2')));
  assertFalse(goog.style.isRightToLeft(goog.dom.getElement('rtl3')));
  assertFalse(goog.style.isRightToLeft(goog.dom.getElement('rtl4')));
  assertTrue(goog.style.isRightToLeft(goog.dom.getElement('rtl5')));
  assertFalse(goog.style.isRightToLeft(goog.dom.getElement('rtl6')));
  assertTrue(goog.style.isRightToLeft(goog.dom.getElement('rtl7')));
  assertFalse(goog.style.isRightToLeft(goog.dom.getElement('rtl8')));
  assertTrue(goog.style.isRightToLeft(goog.dom.getElement('rtl9')));
  assertFalse(goog.style.isRightToLeft(goog.dom.getElement('rtl10')));
}

function testPosWithAbsoluteAndScroll() {
  var el = goog.dom.getElement('pos-scroll-abs')
  var el1 = goog.dom.getElement('pos-scroll-abs-1');
  var el2 = goog.dom.getElement('pos-scroll-abs-2');

  el1.scrollTop = 200;
  var pos = goog.style.getPageOffset(el2);

  assertEquals(200, pos.x);
  // Don't bother with IE in quirks mode
  if (!goog.userAgent.IE || document.compatMode == 'CSS1Compat') {
    assertEquals(300, pos.y);
  }
}

function testPosWithAbsoluteAndWindowScroll() {
  window.scrollBy(0, 200);
  var el = goog.dom.getElement('abs-upper-left');
  var pos = goog.style.getPageOffset(el);
  assertEquals('Top should be about 0', 0, pos.y);
}

function testGetBorderBoxSize() {
  // Strict mode
  var getBorderBoxSize = goog.style.getBorderBoxSize;

  var el = goog.dom.getElement('size-a');
  var rect = getBorderBoxSize(el);
  assertEquals('width:100px', 100, rect.width);
  assertEquals('height:100px', 100, rect.height);

  // with border: 10px
  el = goog.dom.getElement('size-b');
  rect = getBorderBoxSize(el);
  assertEquals('width:100px;border:10px', isBorderBox ? 100 : 120, rect.width);
  assertEquals('height:100px;border:10px', isBorderBox ? 100 : 120,
               rect.height);

  // with border: 10px; padding: 10px
  el = goog.dom.getElement('size-c');
  rect = getBorderBoxSize(el);
  assertEquals('width:100px;border:10px;padding:10px',
               isBorderBox ? 100 : 140, rect.width);
  assertEquals('height:100px;border:10px;padding:10px',
               isBorderBox ? 100 : 140, rect.height);

  // size, padding and borders are all in non pixel units
  // all we test here is that we get a number out
  el = goog.dom.getElement('size-d');
  rect = getBorderBoxSize(el);
  assertEquals('number', typeof rect.width);
  assertEquals('number', typeof rect.height);
  assertFalse(isNaN(rect.width));
  assertFalse(isNaN(rect.height));
}

function testGetContentBoxSize() {
  // Strict mode
  var getContentBoxSize = goog.style.getContentBoxSize;

  var el = goog.dom.getElement('size-a');
  var rect = getContentBoxSize(el);
  assertEquals('width:100px', 100, rect.width);
  assertEquals('height:100px', 100, rect.height);

  // with border: 10px
  el = goog.dom.getElement('size-b');
  rect = getContentBoxSize(el);
  assertEquals('width:100px;border:10px',
               isBorderBox ? 80 : 100, rect.width);
  assertEquals('height:100px;border:10px',
               isBorderBox ? 80 : 100, rect.height);

  // with border: 10px; padding: 10px
  el = goog.dom.getElement('size-c');
  rect = getContentBoxSize(el);
  assertEquals('width:100px;border:10px;padding:10px',
               isBorderBox ? 60 : 100, rect.width);
  assertEquals('height:100px;border:10px;padding:10px',
               isBorderBox ? 60 : 100, rect.height);

  // test whether getContentBoxSize works when width and height
  // aren't explicitly set, but the default of 'auto'.
  // 'size-f' has no margin, border, or padding, so offsetWidth/Height
  // should match the content box size
  el = goog.dom.getElement('size-f');
  rect = getContentBoxSize(el);
  assertEquals(el.offsetWidth, rect.width);
  assertEquals(el.offsetHeight, rect.height);

  // size, padding and borders are all in non pixel units
  // all we test here is that we get a number out
  el = goog.dom.getElement('size-d');
  rect = getContentBoxSize(el);
  assertEquals('number', typeof rect.width);
  assertEquals('number', typeof rect.height);
  assertFalse(isNaN(rect.width));
  assertFalse(isNaN(rect.height));
}

function testSetBorderBoxSize() {
  // Strict mode
  var el = goog.dom.getElement('size-e');
  var Size = goog.math.Size;
  var setBorderBoxSize = goog.style.setBorderBoxSize;

  // Clean up
  // style element has 100x100, no border and no padding
  el.style.padding = '';
  el.style.margin = '';
  el.style.borderWidth = '';
  el.style.width = '';
  el.style.height = '';

  setBorderBoxSize(el, new Size(100, 100));

  assertEquals(100, el.offsetWidth);
  assertEquals(100, el.offsetHeight);

  el.style.borderWidth = '10px';
  setBorderBoxSize(el, new Size(100, 100));

  assertEquals('width:100px;border:10px', 100, el.offsetWidth);
  assertEquals('height:100px;border:10px', 100, el.offsetHeight);

  el.style.padding = '10px';
  setBorderBoxSize(el, new Size(100, 100));
  assertEquals(100, el.offsetWidth);
  assertEquals(100, el.offsetHeight);

  el.style.borderWidth = '0';
  setBorderBoxSize(el, new Size(100, 100));
  assertEquals(100, el.offsetWidth);
  assertEquals(100, el.offsetHeight);

  if (goog.userAgent.GECKO) {
    assertEquals('border-box', el.style.MozBoxSizing);
  } else if (goog.userAgent.WEBKIT) {
    assertEquals('border-box', el.style.WebkitBoxSizing);
  } else if (goog.userAgent.OPERA) {
    // opera doesnt expose this as a DOM property.
    assertEquals('border-box', el.style.getPropertyValue('box-sizing'));
  }
}

function testSetContentBoxSize() {
  // Strict mode
  var el = goog.dom.getElement('size-e');
  var Size = goog.math.Size;
  var setContentBoxSize = goog.style.setContentBoxSize;

  // Clean up
  // style element has 100x100, no border and no padding
  el.style.padding = '';
  el.style.margin = '';
  el.style.borderWidth = '';
  el.style.width = '';
  el.style.height = '';

  setContentBoxSize(el, new Size(100, 100));

  assertEquals(100, el.offsetWidth);
  assertEquals(100, el.offsetHeight);

  el.style.borderWidth = '10px';
  setContentBoxSize(el, new Size(100, 100));
  assertEquals('width:100px;border-width:10px', 120, el.offsetWidth);
  assertEquals('height:100px;border-width:10px', 120, el.offsetHeight);

  el.style.padding = '10px';
  setContentBoxSize(el, new Size(100, 100));
  assertEquals('width:100px;border-width:10px;padding:10px',
               140, el.offsetWidth);
  assertEquals('height:100px;border-width:10px;padding:10px',
               140, el.offsetHeight);

  el.style.borderWidth = '0';
  setContentBoxSize(el, new Size(100, 100));
  assertEquals('width:100px;padding:10px', 120, el.offsetWidth);
  assertEquals('height:100px;padding:10px', 120, el.offsetHeight);

  if (goog.userAgent.GECKO) {
    assertEquals('content-box', el.style.MozBoxSizing);
  } else if (goog.userAgent.WEBKIT) {
    assertEquals('content-box', el.style.WebkitBoxSizing);
  } else if (goog.userAgent.OPERA) {
    // opera doesnt expose this as a DOM property.
    assertEquals('content-box', el.style.getPropertyValue('box-sizing'));
  }
}

function testGetPaddingBox() {
  // Strict mode
  var el = goog.dom.getElement('size-e');
  var Size = goog.math.Size;
  var getPaddingBox = goog.style.getPaddingBox;

  // Clean up
  // style element has 100x100, no border and no padding
  el.style.padding = '';
  el.style.margin = '';
  el.style.borderWidth = '';
  el.style.width = '';
  el.style.height = '';

  el.style.padding = '10px';
  var rect = getPaddingBox(el);
  assertEquals(10, rect.left);
  assertEquals(10, rect.right);
  assertEquals(10, rect.top);
  assertEquals(10, rect.bottom);

  el.style.padding = '0';
  rect = getPaddingBox(el);
  assertEquals(0, rect.left);
  assertEquals(0, rect.right);
  assertEquals(0, rect.top);
  assertEquals(0, rect.bottom);

  el.style.padding = '1px 2px 3px 4px';
  rect = getPaddingBox(el);
  assertEquals(1, rect.top);
  assertEquals(2, rect.right);
  assertEquals(3, rect.bottom);
  assertEquals(4, rect.left);

  el.style.padding = '1mm 2em 3ex 4%';
  rect = getPaddingBox(el);
  assertFalse(isNaN(rect.top));
  assertFalse(isNaN(rect.right));
  assertFalse(isNaN(rect.bottom));
  assertFalse(isNaN(rect.left));
  assertTrue(rect.top >= 0);
  assertTrue(rect.right >= 0);
  assertTrue(rect.bottom >= 0);
  assertTrue(rect.left >= 0);
}

function testGetMarginBox() {
  // Strict mode
  var el = goog.dom.getElement('size-e');
  var Size = goog.math.Size;
  var getMarginBox = goog.style.getMarginBox;

  // Clean up
  // style element has 100x100, no border and no padding
  el.style.padding = '';
  el.style.margin = '';
  el.style.borderWidth = '';
  el.style.width = '';
  el.style.height = '';

  el.style.margin = '10px';
  var rect = getMarginBox(el);
  assertEquals(10, rect.left);
  // In webkit the right margin is the calculated distance from right edge and
  // not the computed right margin so it is not reliable.
  // See https://bugs.webkit.org/show_bug.cgi?id=19828
  if (!goog.userAgent.WEBKIT) {
    assertEquals(10, rect.right);
  }
  assertEquals(10, rect.top);
  assertEquals(10, rect.bottom);

  el.style.margin = '0';
  rect = getMarginBox(el);
  assertEquals(0, rect.left);
  // In webkit the right margin is the calculated distance from right edge and
  // not the computed right margin so it is not reliable.
  // See https://bugs.webkit.org/show_bug.cgi?id=19828
  if (!goog.userAgent.WEBKIT) {
    assertEquals(0, rect.right);
  }
  assertEquals(0, rect.top);
  assertEquals(0, rect.bottom);

  el.style.margin = '1px 2px 3px 4px';
  rect = getMarginBox(el);
  assertEquals(1, rect.top);
  // In webkit the right margin is the calculated distance from right edge and
  // not the computed right margin so it is not reliable.
  // See https://bugs.webkit.org/show_bug.cgi?id=19828
  if (!goog.userAgent.WEBKIT) {
    assertEquals(2, rect.right);
  }
  assertEquals(3, rect.bottom);
  assertEquals(4, rect.left);

  el.style.margin = '1mm 2em 3ex 4%';
  rect = getMarginBox(el);
  assertFalse(isNaN(rect.top));
  assertFalse(isNaN(rect.right));
  assertFalse(isNaN(rect.bottom));
  assertFalse(isNaN(rect.left));
  assertTrue(rect.top >= 0);
  // In webkit the right margin is the calculated distance from right edge and
  // not the computed right margin so it is not reliable.
  // See https://bugs.webkit.org/show_bug.cgi?id=19828
  if (!goog.userAgent.WEBKIT) {
    assertTrue(rect.right >= 0);
  }
  assertTrue(rect.bottom >= 0);
  assertTrue(rect.left >= 0);
}

function testGetBorderBox() {
  // Strict mode
  var el = goog.dom.getElement('size-e');
  var Size = goog.math.Size;
  var getBorderBox = goog.style.getBorderBox;

  // Clean up
  // style element has 100x100, no border and no padding
  el.style.padding = '';
  el.style.margin = '';
  el.style.borderWidth = '';
  el.style.width = '';
  el.style.height = '';

  el.style.borderWidth = '10px';
  var rect = getBorderBox(el);
  assertEquals(10, rect.left);
  assertEquals(10, rect.right);
  assertEquals(10, rect.top);
  assertEquals(10, rect.bottom);

  el.style.borderWidth = '0';
  rect = getBorderBox(el);
  assertEquals(0, rect.left);
  assertEquals(0, rect.right);
  assertEquals(0, rect.top);
  assertEquals(0, rect.bottom);

  el.style.borderWidth = '1px 2px 3px 4px';
  rect = getBorderBox(el);
  assertEquals(1, rect.top);
  assertEquals(2, rect.right);
  assertEquals(3, rect.bottom);
  assertEquals(4, rect.left);

  // % does not work for border widths in IE
  el.style.borderWidth = '1mm 2em 3ex 4pt';
  rect = getBorderBox(el);
  assertFalse(isNaN(rect.top));
  assertFalse(isNaN(rect.right));
  assertFalse(isNaN(rect.bottom));
  assertFalse(isNaN(rect.left));
  assertTrue(rect.top >= 0);
  assertTrue(rect.right >= 0);
  assertTrue(rect.bottom >= 0);
  assertTrue(rect.left >= 0);

  el.style.borderWidth = 'thin medium thick 1px';
  rect = getBorderBox(el);
  assertFalse(isNaN(rect.top));
  assertFalse(isNaN(rect.right));
  assertFalse(isNaN(rect.bottom));
  assertFalse(isNaN(rect.left));
  assertTrue(rect.top >= 0);
  assertTrue(rect.right >= 0);
  assertTrue(rect.bottom >= 0);
  assertTrue(rect.left >= 0);
}

function testGetFontFamily() {
  // I tried to use common fonts for these tests. It's possible the test fails
  // because the testing platform doesn't have one of these fonts installed:
  //   Comic Sans MS or Century Schoolbook L
  //   Times
  //   Helvetica

  var tmpFont = goog.style.getFontFamily(goog.dom.getElement('font-tag'));
  assertTrue('FontFamily should be detectable when set via <font face>',
             'Times' == tmpFont || 'Times New Roman' == tmpFont);
  tmpFont = goog.style.getFontFamily(goog.dom.getElement('small-text'));
  assertTrue('Multiword fonts should be reported with quotes stripped.',
             'Comic Sans MS' == tmpFont ||
                 'Century Schoolbook L' == tmpFont);
  // Firefox fails this test & retuns a generic 'monospace' instead of the
  // actually displayed font (e.g., "Times New").
  //tmpFont = goog.style.getFontFamily(goog.dom.getElement('pre-font'));
  //assertEquals('<pre> tags should use a fixed-width font',
  //             'Times New',
  //             tmpFont);
  tmpFont = goog.style.getFontFamily(goog.dom.getElement('inherit-font'));
  assertEquals('Explicitly inherited fonts should be detectable',
               'Helvetica',
               tmpFont);
  tmpFont = goog.style.getFontFamily(goog.dom.getElement('times-font-family'));
  assertEquals('Font-family set via style attribute should be detected',
               'Times',
               tmpFont);
  tmpFont = goog.style.getFontFamily(goog.dom.getElement('bold-font'));
  assertEquals('Implicitly inherited font should be detected',
               'Helvetica',
               tmpFont);
  tmpFont = goog.style.getFontFamily(goog.dom.getElement('css-html-tag-redefinition'));
  assertEquals('HTML tag CSS rewrites should be detected',
               'Times',
               tmpFont);
  tmpFont = goog.style.getFontFamily(goog.dom.getElement('no-text-font-styles'));
  assertEquals('Font family should exist even with no text',
               'Helvetica',
               tmpFont);
  tmpFont = goog.style.getFontFamily(goog.dom.getElement('icon-font'));
  assertNotEquals('icon is a special font-family value',
                  'icon',
                  tmpFont.toLowerCase());
  tmpFont = goog.style.getFontFamily(goog.dom.getElement('font-style-badfont'));
  // Firefox fails this test and reports the specified "badFont", which is
  // obviously not displayed.
  //assertEquals('Invalid fonts should not be returned',
  //             'Helvetica',
  //             tmpFont);
  tmpFont = goog.style.getFontFamily(goog.dom.getElement('img-font-test'));
  assertTrue('Even img tags should inherit the document body\'s font',
             tmpFont != '');
  tmpFont = goog.style.getFontFamily(goog.dom.getElement('nested-font'));
  assertEquals('An element with nested content should be unaffected.',
               'Arial',
               tmpFont);
}

function testGetFontSize() {
  assertEquals('Font size should be determined even without any text',
               30,
               goog.style.getFontSize(
                   goog.dom.getElement('no-text-font-styles')));
  assertEquals('A 5em font should be 5x larger than its parent.',
               150,
               goog.style.getFontSize(
                   goog.dom.getElement('css-html-tag-redefinition')));
  assertTrue('Setting font size=-1 should result in a positive font size.',
             goog.style.getFontSize(goog.dom.getElement('font-tag')) > 0);
  assertEquals('Inheriting a 50% font-size should have no additional effect',
               goog.style.getFontSize(
                   goog.dom.getElement('font-style-badfont')),
               goog.style.getFontSize(
                   goog.dom.getElement('inherit-50pct-font')));
  assertTrue('In pretty much any display, 3in should be > 8px',
             goog.style.getFontSize(goog.dom.getElement('times-font-family')) >
                 goog.style.getFontSize(
                     goog.dom.getElement('no-text-font-styles')));
  assertTrue('With no applied styles, font-size should still be defined.',
             goog.style.getFontSize(goog.dom.getElement('no-font-style')) > 0);
  assertEquals('50% of 30px is 15',
               15,
               goog.style.getFontSize(
                   goog.dom.getElement('font-style-badfont')));
  assertTrue('x-small text should be smaller than small text',
             goog.style.getFontSize(goog.dom.getElement('x-small-text')) <
                 goog.style.getFontSize(goog.dom.getElement('small-text')));
  // IE fails this test, the decimal portion of px lengths isn't reported
  // by getCascadedStyle. Firefox passes, but only because it ignores the
  // decimals altogether.
  //assertEquals('12.5px should be the same as 0.5em nested in a 25px node.',
  //             goog.style.getFontSize(
  //                 goog.dom.getElement('font-size-12-point-5-px')),
  //             goog.style.getFontSize(
  //                 goog.dom.getElement('font-size-50-pct-of-25-px')));
}

function testGetLengthUnits() {
  assertEquals('px', goog.style.getLengthUnits('15px'));
  assertEquals('%', goog.style.getLengthUnits('99%'));
  assertNull(goog.style.getLengthUnits(''));
}

function testGetFloat() {
  assertEquals('', goog.style.getFloat(goog.dom.getElement('no-float')));
  assertEquals('none', goog.style.getFloat(goog.dom.getElement('float-none')));
  assertEquals('left', goog.style.getFloat(goog.dom.getElement('float-left')));
}

function testSetFloat() {
  var el = goog.dom.getElement('float-test');

  goog.style.setFloat(el, 'left');
  assertEquals('left', goog.style.getFloat(el));

  goog.style.setFloat(el, 'right');
  assertEquals('right', goog.style.getFloat(el));

  goog.style.setFloat(el, 'none');
  assertEquals('none', goog.style.getFloat(el));

  goog.style.setFloat(el, '');
  assertEquals('', goog.style.getFloat(el));
}

function testIsElementShown() {
  var el = goog.dom.getElement('testEl');

  goog.style.showElement(el, false);
  assertFalse(goog.style.isElementShown(el));

  goog.style.showElement(el, true);
  assertTrue(goog.style.isElementShown(el));
}

function testGetOpacity() {
  var el1 = {
    style: {
      opacity: '0.3'
    }
  };

  var el2 = {
    style: {
      MozOpacity: '0.1'
    }
  };

  var el3 = {
    style: {
      filter: 'some:other,filter;alpha(opacity=25.5);alpha(more=100);'
    }
  };

  assertEquals(0.3, goog.style.getOpacity(el1));
  assertEquals(0.1, goog.style.getOpacity(el2));
  assertEquals(0.255, goog.style.getOpacity(el3));

  el1.style.opacity = '0';
  el2.style.MozOpacity = '0';
  el3.style.filter = 'some:other,filter;alpha(opacity=0);alpha(more=100);';

  assertEquals(0, goog.style.getOpacity(el1));
  assertEquals(0, goog.style.getOpacity(el2));
  assertEquals(0, goog.style.getOpacity(el3));

  el1.style.opacity = '';
  el2.style.MozOpacity = '';
  el3.style.filter = '';

  assertEquals('', goog.style.getOpacity(el1));
  assertEquals('', goog.style.getOpacity(el2));
  assertEquals('', goog.style.getOpacity(el3));

  var el4 = {
    style: {}
  }

  assertEquals('', goog.style.getOpacity(el4));
  assertEquals('', goog.style.getOpacity(goog.dom.getElement('test-opacity')));
}

function testSetOpacity() {
  var el1 = {
    style: {
      opacity: '0.3'
    }
  };
  goog.style.setOpacity(el1, 0.8);

  var el2 = {
    style: {
      MozOpacity: '0.1'
    }
  };
  goog.style.setOpacity(el2, 0.5);

  var el3 = {
    style: {
      filter: 'alpha(opacity=25)'
    }
  };
  goog.style.setOpacity(el3, 0.1);

  assertEquals(0.8, Number(el1.style.opacity));
  assertEquals(0.5, Number(el2.style.MozOpacity));
  assertEquals('alpha(opacity=10)', el3.style.filter);

  goog.style.setOpacity(el1, 0);
  goog.style.setOpacity(el2, 0);
  goog.style.setOpacity(el3, 0);

  assertEquals(0, Number(el1.style.opacity));
  assertEquals(0, Number(el2.style.MozOpacity));
  assertEquals('alpha(opacity=0)', el3.style.filter);

  goog.style.setOpacity(el1, '');
  goog.style.setOpacity(el2, '');
  goog.style.setOpacity(el3, '');

  assertEquals('', el1.style.opacity);
  assertEquals('', el2.style.MozOpacity);
  assertEquals('', el3.style.filter);
}

function testFramedPageOffset() {
  // Set up a complicated iframe ancestor chain.
  var iframe = goog.dom.getElement('test-frame-offset');
  var iframeDoc = goog.dom.getFrameContentDocument(iframe);
  var iframeWindow = goog.dom.getWindow(iframeDoc);

  var iframePos = 'style="display:block;position:absolute;' +
      'top:50px;left:50px;width:50px;height:50px;"';
  iframeDoc.write('<iframe id="test-frame-offset-2" ' +
      iframePos + '></iframe>' +
      '<div id="test-element-2" ' +
      ' style="position:absolute;left:300px;top:300px">hi mom!</div>');
  iframeDoc.close();
  var iframe2 = iframeDoc.getElementById('test-frame-offset-2');
  var testElement2 = iframeDoc.getElementById('test-element-2');
  var iframeDoc2 = goog.dom.getFrameContentDocument(iframe2);
  var iframeWindow2 = goog.dom.getWindow(iframeDoc2);

  iframeDoc2.write(
      '<div id="test-element-3" ' +
      ' style="position:absolute;left:500px;top:500px">hi mom!</div>');
  iframeDoc2.close();
  var testElement3 = iframeDoc2.getElementById('test-element-3');

  assertCoordinateApprox(300, 300, 0,
      goog.style.getPageOffset(testElement2));
  assertCoordinateApprox(500, 500, 0,
      goog.style.getPageOffset(testElement3));

  assertCoordinateApprox(350, 350, 0,
      goog.style.getFramedPageOffset(testElement2, window));
  assertCoordinateApprox(300, 300, 0,
      goog.style.getFramedPageOffset(testElement2, iframeWindow));

  assertCoordinateApprox(600, 600, 0,
      goog.style.getFramedPageOffset(testElement3, window));
  assertCoordinateApprox(550, 550, 0,
      goog.style.getFramedPageOffset(testElement3, iframeWindow));
  assertCoordinateApprox(500, 500, 0,
      goog.style.getFramedPageOffset(testElement3, iframeWindow2));

  // Scroll the iframes a bit.
  window.scrollBy(0, 5);
  iframeWindow.scrollBy(0, 11);
  iframeWindow2.scrollBy(0, 18);

  // On Firefox 2, scrolling inner iframes causes off by one errors
  // in the page position, because we're using screen coords to compute them.
  assertCoordinateApprox(300, 300, 2,
      goog.style.getPageOffset(testElement2));
  assertCoordinateApprox(500, 500, 2,
      goog.style.getPageOffset(testElement3));

  assertCoordinateApprox(350, 350 - 11, 2,
      goog.style.getFramedPageOffset(testElement2, window));
  assertCoordinateApprox(300, 300, 2,
      goog.style.getFramedPageOffset(testElement2, iframeWindow));

  assertCoordinateApprox(600, 600 - 18 - 11, 2,
      goog.style.getFramedPageOffset(testElement3, window));
  assertCoordinateApprox(550, 550 - 18, 2,
      goog.style.getFramedPageOffset(testElement3, iframeWindow));
  assertCoordinateApprox(500, 500, 2,
      goog.style.getFramedPageOffset(testElement3, iframeWindow2));
}

/**
 * Asserts that the coordinate is approximately equal to the given
 * x and y coordinates, give or take delta.
 */
function assertCoordinateApprox(x, y, delta, coord) {
  assertTrue('Expected x: ' + x + ', actual x: ' + coord.x,
      coord.x >= x - delta && coord.x <= x + delta);
  assertTrue('Expected y: ' + y + ', actual y: ' + coord.y,
      coord.y >= y - delta && coord.y <= y + delta);
}

function testTranslateRectForAnotherFrame() {
  var rect = new goog.math.Rect(1, 2, 3, 4);
  var thisDom = goog.dom.getDomHelper();
  goog.style.translateRectForAnotherFrame(rect, thisDom, thisDom);
  assertEquals(1, rect.left);
  assertEquals(2, rect.top);
  assertEquals(3, rect.width);
  assertEquals(4, rect.height);

  var iframe = goog.dom.getElement('test-translate-frame-standard');
  var iframeDoc = goog.dom.getFrameContentDocument(iframe);
  var iframeDom = goog.dom.getDomHelper(iframeDoc);
  // Cannot rely on iframe starting at origin.
  iframeDom.getWindow().scrollTo(0, 0);
  // iframe is at (100, 150) and its body is not scrolled.
  rect = new goog.math.Rect(1, 2, 3, 4);
  goog.style.translateRectForAnotherFrame(rect, iframeDom, thisDom);
  assertEquals(1 + 100, rect.left);
  assertEquals(2 + 150, rect.top);
  assertEquals(3, rect.width);
  assertEquals(4, rect.height);

  iframeDom.getWindow().scrollTo(11, 13);
  rect = new goog.math.Rect(1, 2, 3, 4);
  goog.style.translateRectForAnotherFrame(rect, iframeDom, thisDom);
  assertEquals(1 + 100 - 11, rect.left);
  assertEquals(2 + 150 - 13, rect.top);
  assertEquals(3, rect.width);
  assertEquals(4, rect.height);

  iframe = goog.dom.getElement('test-translate-frame-quirk');
  iframeDoc = goog.dom.getFrameContentDocument(iframe);
  iframeDom = goog.dom.getDomHelper(iframeDoc);
  // Cannot rely on iframe starting at origin.
  iframeDom.getWindow().scrollTo(0, 0);
  // iframe is at (100, 350) and its body is not scrolled.
  rect = new goog.math.Rect(1, 2, 3, 4);
  goog.style.translateRectForAnotherFrame(rect, iframeDom, thisDom);
  assertEquals(1 + 100, rect.left);
  assertEquals(2 + 350, rect.top);
  assertEquals(3, rect.width);
  assertEquals(4, rect.height);

  iframeDom.getWindow().scrollTo(11, 13);
  rect = new goog.math.Rect(1, 2, 3, 4);
  goog.style.translateRectForAnotherFrame(rect, iframeDom, thisDom);
  assertEquals(1 + 100 - 11, rect.left);
  assertEquals(2 + 350 - 13, rect.top);
  assertEquals(3, rect.width);
  assertEquals(4, rect.height);
};

function testGetVisibleRectForElement() {
  var container = goog.dom.getElement('test-visible');
  var el = goog.dom.getElement('test-visible-el');
  var dom = goog.dom.getDomHelper(el);
  var winScroll = dom.getDocumentScroll();
  var winSize = dom.getViewportSize();

  // Skip this test if the window size is small.  Firefox3/Linux in Selenium
  // sometimes fails without this check.
  if (winSize.width < 20 || winSize.height < 20) {
    return;
  }

  // Move the container element to the window's viewport.
  var h = winSize.height < 100 ? winSize.height / 2 : 100;
  goog.style.setSize(container, winSize.width / 2, h);
  goog.style.setPosition(container, 8, winScroll.y + winSize.height - h);
  var visible = goog.style.getVisibleRectForElement(el);
  var bounds = goog.style.getBounds(container);
  // VisibleRect == Bounds rect of the offsetParent
  assertNotNull(visible);
  assertEquals(bounds.left, visible.left);
  assertEquals(bounds.top, visible.top);
  // Firefox sometimes returns a non-integer.
  assertRoughlyEquals(bounds.left + bounds.width, visible.right, 1);
  assertRoughlyEquals(bounds.top + bounds.height, visible.bottom, 1);

  // Move a part of the container element to outside of the viewpoert.
  goog.style.setPosition(container, 8, winScroll.y + winSize.height - h / 2);
  visible = goog.style.getVisibleRectForElement(el);
  bounds = goog.style.getBounds(container);
  // Confirm VisibleRect == Intersection of the bounds rect of the
  // offsetParent and the viewport.
  assertNotNull(visible);
  assertEquals(bounds.left, visible.left);
  assertEquals(bounds.top, visible.top);
  assertRoughlyEquals(bounds.left + bounds.width, visible.right, 1);
  assertRoughlyEquals(winScroll.y + winSize.height, visible.bottom, 1);

  // Move the container element to outside of the viewpoert.
  goog.style.setPosition(container, 8, winScroll.y + winSize.height);
  visible = goog.style.getVisibleRectForElement(el);
  assertNull(visible);

  // Test the case with body element of height 0
  var iframe = goog.dom.getElement('test-visible-frame');
  var iframeDoc = goog.dom.getFrameContentDocument(iframe);
  el = iframeDoc.getElementById('test-visible');
  visible = goog.style.getVisibleRectForElement(el);
  // Just check whether it is not null, which means non-zero height
  assertNotNull(visible);
};

function testScrollIntoContainerView() {
  var container = goog.dom.getElement('scrollable-container');

  // Scroll the minimum amount to make the elements visible.
  goog.style.scrollIntoContainerView(goog.dom.getElement('item7'), container);
  assertEquals('scroll to item7', 79, container.scrollTop);
  goog.style.scrollIntoContainerView(goog.dom.getElement('item8'), container);
  assertEquals('scroll to item8', 100, container.scrollTop);
  goog.style.scrollIntoContainerView(goog.dom.getElement('item7'), container);
  assertEquals('item7 still visible', 100, container.scrollTop);
  goog.style.scrollIntoContainerView(goog.dom.getElement('item1'), container);
  assertEquals('scroll to item1', 17, container.scrollTop);

  // Center the element in the first argument.
  goog.style.scrollIntoContainerView(goog.dom.getElement('item1'), container,
                                     true);
  assertEquals('center item1', 0, container.scrollTop);
  goog.style.scrollIntoContainerView(goog.dom.getElement('item4'), container,
                                     true);
  assertEquals('center item4', 48, container.scrollTop);

  // The element is higher than the container.
  goog.dom.getElement('item3').style.height = '140px';
  goog.style.scrollIntoContainerView(goog.dom.getElement('item3'), container);
  assertEquals('show item3 with increased height', 59, container.scrollTop);
  goog.style.scrollIntoContainerView(goog.dom.getElement('item3'), container,
                                                         true);
  assertEquals('center item3 with increased height', 87, container.scrollTop);
  goog.dom.getElement('item3').style.height = '';

  // Scroll to non-integer position.
  goog.dom.getElement('item4').style.height = '21px';
  goog.style.scrollIntoContainerView(goog.dom.getElement('item4'), container,
                                     true);
  assertEquals('scroll position is rounded down', 48, container.scrollTop);
  goog.dom.getElement('item4').style.height = '';
}

function testScrollBarWidth() {
  var width = goog.style.getScrollbarWidth();
  assertTrue(width > 0);

  var outer = goog.dom.getElement('test-scrollbarwidth');
  var inner = goog.dom.getElementsByTagNameAndClass('div', null, outer)[0];
  assertTrue('should have a scroll bar', hasVerticalScroll(outer));
  assertTrue('should have a scroll bar', hasHorizontalScroll(outer));

  // Get the inner div absolute width
  goog.style.setStyle(outer, 'width', '100%');
  assertTrue('should have a scroll bar', hasVerticalScroll(outer));
  assertFalse('should not have a scroll bar', hasHorizontalScroll(outer));
  var innerAbsoluteWidth = inner.offsetWidth;

  // Leave the vertical scroll and remove the horizontal by using the scroll
  // bar width calculation.
  goog.style.setStyle(outer, 'width',
      (innerAbsoluteWidth + width) + 'px');
  assertTrue('should have a scroll bar', hasVerticalScroll(outer));
  assertFalse('should not have a scroll bar', hasHorizontalScroll(outer));

  // verify by adding 1 more pixel (brings back the vertical scroll bar).
  goog.style.setStyle(outer, 'width',
      (innerAbsoluteWidth + width - 1) + 'px');
  assertTrue('should have a scroll bar', hasVerticalScroll(outer));
  assertTrue('should have a scroll bar', hasHorizontalScroll(outer));
}

function hasVerticalScroll(el) {
  return el.clientWidth != 0 && el.offsetWidth - el.clientWidth  > 0;
}

function hasHorizontalScroll(el) {
  return el.clientHeight != 0 && el.offsetHeight - el.clientHeight > 0;
}

function isIE8() {
  return goog.userAgent.IE && goog.userAgent.product.isVersion('8') &&
      !goog.userAgent.product.isVersion('9');
}
">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:21:24
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>htmlprettyprinter_test.html</td><td>Success</td><td> 13 passed, 0 failed.</td><td title="

  goog.require('goog.format.HtmlPrettyPrinter');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.jsunit');


var COMPLEX_HTML = '<!DOCTYPE root-element [SYSTEM OR PUBLIC FPI] "uri" [' +
    '<!-- internal declarations -->]>' +
    '<html><head><title>My HTML</title><!-- my comment --></head>' +
    '<body><h1>My Header</h1>My text.<br><b>My bold text.</b><hr>' +
    '<pre>My\npreformatted <br> HTML.</pre>5 < 10</body>' +
    '</html>';
var mockClock;
var mockClockTicks;

function setUp() {
  mockClockTicks = 0;
  mockClock = new goog.testing.MockClock();
  mockClock.getCurrentTime = function() {
    return mockClockTicks++;
  };
  mockClock.install();
}

function tearDown() {
  if (mockClock) {
    mockClock.uninstall();
  }
}

function testSimpleHtml() {
  var actual = goog.format.HtmlPrettyPrinter.format('<br><b>bold</b>');
  assertEquals('<br>\n<b>bold</b>\n', actual);
  assertEquals(actual, goog.format.HtmlPrettyPrinter.format(actual));
};

function testSimpleHtmlMixedCase() {
  var actual = goog.format.HtmlPrettyPrinter.format('<BR><b>bold</b>');
  assertEquals('<BR>\n<b>bold</b>\n', actual);
  assertEquals(actual, goog.format.HtmlPrettyPrinter.format(actual));
}

function testComplexHtml() {
  var actual = goog.format.HtmlPrettyPrinter.format(COMPLEX_HTML);
  var expected = '<!DOCTYPE root-element [SYSTEM OR PUBLIC FPI] "uri" [' +
    '<!-- internal declarations -->]>\n' +
    '<html>\n' +
    '<head>\n' +
    '<title>My HTML</title>\n' +
    '<!-- my comment -->' +
    '</head>\n' +
    '<body>\n' +
    '<h1>My Header</h1>\n' +
    'My text.<br>\n' +
    '<b>My bold text.</b>\n' +
    '<hr>\n' +
    '<pre>My\npreformatted <br> HTML.</pre>\n' +
    '5 < 10' +
    '</body>\n' +
    '</html>\n';
  assertEquals(expected, actual);
  assertEquals(actual, goog.format.HtmlPrettyPrinter.format(actual));
}

function testTimeout() {
  var pp = new goog.format.HtmlPrettyPrinter(3);
  var actual = pp.format(COMPLEX_HTML);
  var expected = '<!DOCTYPE root-element [SYSTEM OR PUBLIC FPI] "uri" [' +
    '<!-- internal declarations -->]>\n' +
    '<html>\n' +
    '<head><title>My HTML</title><!-- my comment --></head>' +
    '<body><h1>My Header</h1>My text.<br><b>My bold text.</b><hr>' +
    '<pre>My\npreformatted <br> HTML.</pre>5 < 10</body>' +
    '</html>\n';
  assertEquals(expected, actual);
}

function testKeepLeadingIndent() {
  var original = ' <b>Bold</b> <i>Ital</i> ';
  var expected = ' <b>Bold</b> <i>Ital</i>\n';
  assertEquals(expected, goog.format.HtmlPrettyPrinter.format(original));
}

function testTrimLeadingLineBreaks() {
  var original = '\n \t\r\n  \n <b>Bold</b> <i>Ital</i> ';
  var expected = ' <b>Bold</b> <i>Ital</i>\n';
  assertEquals(expected, goog.format.HtmlPrettyPrinter.format(original));
}

function testExtraLines() {
  var original = '<br>\ntombrat';
  assertEquals(original + '\n', goog.format.HtmlPrettyPrinter.format(original));
}

function testCrlf() {
  var original = '<br>\r\none\r\ntwo<br>';
  assertEquals(original + '\n', goog.format.HtmlPrettyPrinter.format(original));
}

function testEndInLineBreak() {
  assertEquals('foo\n', goog.format.HtmlPrettyPrinter.format('foo'));
  assertEquals('foo\n', goog.format.HtmlPrettyPrinter.format('foo\n'));
  assertEquals('foo\n', goog.format.HtmlPrettyPrinter.format('foo\n\n'));
  assertEquals('foo<br>\n', goog.format.HtmlPrettyPrinter.format('foo<br>'));
  assertEquals('foo<br>\n', goog.format.HtmlPrettyPrinter.format('foo<br>\n'));
}

function testTable() {
  var original = '<table>' +
    '<tr><td>one.one</td><td>one.two</td></tr>' +
    '<tr><td>two.one</td><td>two.two</td></tr>' +
    '</table>';
  var expected = '<table>\n' +
    '<tr>\n<td>one.one</td>\n<td>one.two</td>\n</tr>\n' +
    '<tr>\n<td>two.one</td>\n<td>two.two</td>\n</tr>\n' +
    '</table>\n';
  assertEquals(expected, goog.format.HtmlPrettyPrinter.format(original));
}

/**
 * We have a sanity check in HtmlPrettyPrinter to make sure the regex index
 * advances after every match. We should never hit this, but we include it on
 * the chance there is some corner case where the pattern would match but not
 * process a new token. It's not generally a good idea to break the
 * implementation to test behavior, but this is the easiest way to mimic a
 * bad internal state.
 */
function testRegexMakesProgress() {
  var original = goog.format.HtmlPrettyPrinter.TOKEN_REGEX_;

  try {
    // This regex matches \B, an index between 2 word characters, so the regex
    // index does not advance when matching this.
    goog.format.HtmlPrettyPrinter.TOKEN_REGEX_ =
        /(?:\B|<!--.*?-->|<!.*?>|<(\/?)(\w+)[^>]*>|[^<]+|<)/g;

    // It would work on this string.
    assertEquals('f o o\n', goog.format.HtmlPrettyPrinter.format('f o o'));

    // But not this one.
    var ex = assertThrows('should have failed for invalid regex - endless loop',
        goog.partial(goog.format.HtmlPrettyPrinter.format, COMPLEX_HTML));
    assertEquals('Regex failed to make progress through source html.',
        ex.message);
  } finally {
    goog.format.HtmlPrettyPrinter.TOKEN_REGEX_ = original;
  }
}

/**
 * FF3.0 doesn't like \n between </li> and </ul>. See bug 1520665.
 */
function testLists() {
  var original = "<ul><li>one</li><ul><li>two</li></UL><li>three</li></ul>";
  var expected =
    "<ul><li>one</li>\n<ul><li>two</li></UL>\n<li>three</li></ul>\n";
  assertEquals(expected, goog.format.HtmlPrettyPrinter.format(original));
}

/**
 * We have a sanity check in HtmlPrettyPrinter to make sure the regex fully
 * tokenizes the string. We should never hit this, but we include it on the
 * chance there is some corner case where the pattern would miss a section of
 * original string. It's not generally a good idea to break the
 * implementation to test behavior, but this is the easiest way to mimic a
 * bad internal state.
 */
function testAvoidDataLoss() {
  var original = goog.format.HtmlPrettyPrinter.TOKEN_REGEX_;

  try {
    // This regex does not match stranded '<' characters, so does not fully
    // tokenize the string.
    goog.format.HtmlPrettyPrinter.TOKEN_REGEX_ =
        /(?:<!--.*?-->|<!.*?>|<(\/?)(\w+)[^>]*>|[^<]+)/g;

    // It would work on this string.
    assertEquals('foo\n', goog.format.HtmlPrettyPrinter.format('foo'));

    // But not this one.
    var ex = assertThrows('should have failed for invalid regex - data loss',
        goog.partial(goog.format.HtmlPrettyPrinter.format, COMPLEX_HTML));
    assertEquals('Lost data pretty printing html.', ex.message);
  } finally {
    goog.format.HtmlPrettyPrinter.TOKEN_REGEX_ = original;
  }
}

">n/a</td></tr>
<tr><td>emailaddress_test.html</td><td>Success</td><td> 7 passed, 0 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.format.EmailAddress');
  goog.require('goog.testing.jsunit');


function testparseList() {
  var res = goog.format.EmailAddress.parseList('');
  assertEquals('Failed to parse empty string', 0, res.length);

  res = goog.format.EmailAddress.parseList(',,');
  assertEquals('Failed to parse string with commas only', 0, res.length);

  res = goog.format.EmailAddress.parseList('<foo@gmail.com>');
  assertEquals('Failed to parse string with one email address', 1, res.length);
  assertEquals('Failed to parse string with one email address',
               'foo@gmail.com', res[0].getAddress());

  res = goog.format.EmailAddress.parseList('<foo@gmail.com>,');
  assertEquals('Failed to parse string with one email address. Trailing comma',
               1, res.length);

  res = goog.format.EmailAddress.parseList('<foo@gmail.com>, ');
  assertEquals('Failed to parse string with one email address. ' +
               'Trailing comma and whitespace', 1, res.length);

  res = goog.format.EmailAddress.parseList(',<foo@gmail.com>');
  assertEquals('Failed to parse string with one email address. Leading comma',
               1, res.length);

  res = goog.format.EmailAddress.parseList(' ,<foo@gmail.com>');
  assertEquals('Failed to parse string with one email address. ' +
               'Leading whitespace and comma.',
               1, res.length);

  res = goog.format.EmailAddress.parseList(
      '<foo@gmail.com>, <bar@gmail.com>');
  assertEquals('Failed to parse string with two email address', 2, res.length);
  assertEquals('Failed to parse string with two email address',
               'foo@gmail.com', res[0].getAddress());
  assertEquals('Failed to parse string with two email address',
               'bar@gmail.com', res[1].getAddress());

  res = goog.format.EmailAddress.parseList(
      '<foo@gmail.com>, <bar@gmail.com>,');
  assertEquals('Failed to parse string with two email address. Trailing comma',
               2, res.length);

  res = goog.format.EmailAddress.parseList(
      '<foo@gmail.com>, <bar@gmail.com>, ');
  assertEquals('Failed to parse string with two email address. ' +
               'Trailing comma and whitespace', 2, res.length);

  res = goog.format.EmailAddress.parseList(
      'John Doe <john@gmail.com>; Jane Doe <jane@gmail.com>, ' +
      '<jerry@gmail.com>');
  assertEquals('Failed to parse addresses with semicolon separator',
      3, res.length);
  assertEquals('First address should be for John Doe',
      'john@gmail.com', res[0].getAddress());
  assertEquals('Second address should be for Jane Doe',
      'jane@gmail.com', res[1].getAddress());
  assertEquals('Third address should be for Jerry',
      'jerry@gmail.com', res[2].getAddress());
};

function testparseListOpenersAndClosers() {
  var res = goog.format.EmailAddress.parseList('aaa@gmail.com, ' +
                                                  '"bbb@gmail.com", ' +
                                                  '<ccc@gmail.com>, ' +
                                                  '(ddd@gmail.com), ' +
                                                  '[eee@gmail.com]');
  assertEquals('Failed to handle all 5 opener/closer characters',
               5, res.length);
};

function testparseListIdn() {
  var idnaddr = 'mailtest@\u4F8B\u3048.\u30C6\u30B9\u30C8';
  var res = goog.format.EmailAddress.parseList(idnaddr);
  assertEquals('Failed to parse an address with an IDN',
               1, res.length);
  assertEquals('Failed to parse an address with an IDN',
               idnaddr, res[0].getAddress());
};

function testparseListWithQuotedSpecialChars() {
  var res = goog.format.EmailAddress.parseList('a\\"b\\"c <d@e.f>,' +
      '"g\\"h\\"i\\\\" <j@k.l>');
  assertEquals('Wrong name 0', 'a"b"c', res[0].getName());
  assertEquals('Wrong address 0', 'd@e.f', res[0].getAddress());
  assertEquals('Wrong name 1', 'g"h"i\\', res[1].getName());
  assertEquals('Wrong address 1', 'j@k.l', res[1].getAddress());
};

function testparseListWithCommaInLocalPart() {
  var res = goog.format.EmailAddress.parseList(
      '"Doe, John" <doe.john@gmail.com>, <someone@gmail.com>');
  assertEquals('Should have 2 addresses', 2, res.length);
  assertEquals('Doe, John', res[0].getName());
  assertEquals('doe.john@gmail.com', res[0].getAddress());
  assertEquals('', res[1].getName());
  assertEquals('someone@gmail.com', res[1].getAddress());
};

function testToString() {
  var f = function(str) {
    return goog.format.EmailAddress.parse(str).toString();
  };

  // No modification.
  assertEquals('JOHN Doe <john@gmail.com>',
               f('JOHN Doe <john@gmail.com>'));

  // Extra spaces.
  assertEquals('JOHN Doe <john@gmail.com>',
               f(' JOHN  Doe  <john@gmail.com> '));

  // No name.
  assertEquals('john@gmail.com', f('<john@gmail.com>'));
  assertEquals('john@gmail.com', f('john@gmail.com'));

  // No address.
  assertEquals('JOHN Doe', f('JOHN Doe <>'));

  // Special char in the name.
  assertEquals('"JOHN, Doe" <john@gmail.com>',
               f('JOHN, Doe <john@gmail.com>'));

  // Already quoted.
  assertEquals('"JOHN, Doe" <john@gmail.com>',
               f('"JOHN, Doe" <john@gmail.com>'));

  // Needless quotes.
  assertEquals('JOHN Doe <john@gmail.com>',
               f('"JOHN Doe" <john@gmail.com>'));

  // Not quoted-string, but has double quotes.
  assertEquals('"JOHN, Doe" <john@gmail.com>',
               f('JOHN, "Doe" <john@gmail.com>'));

  // No special characters other than quotes.
  assertEquals('JOHN Doe <john@gmail.com>',
               f('JOHN "Doe" <john@gmail.com>'));

  // Escaped quotes are also removed.
  assertEquals('"JOHN, Doe" <john@gmail.com>',
               f('JOHN, \\"Doe\\" <john@gmail.com>'));
};

function testIsValid() {
  var valid = [
      'e@b.eu', '<a.b+foo@c.com>', 'eric <e@b.com>', '"e" <e@b.com>',
      'a@FOO.MUSEUM', 'bla@b.co.ac.uk', 'bla@a.b.com'];
  var invalid = [
      'e', '', 'e @c.com', 'a@b', 'foo.com', 'foo@c..com'];
  goog.array.forEach(valid, function(str) {
    assertTrue(goog.format.EmailAddress.isValidAddress(str));
  });
  goog.array.forEach(invalid, function(str) {
    assertFalse(goog.format.EmailAddress.isValidAddress(str));
  });
};
">n/a</td></tr>
<tr><td>format_test.html</td><td>Fail</td><td> 8 passed, 2 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.format');
  goog.require('goog.string');
  goog.require('goog.testing.jsunit');
  goog.require('goog.style');



var wordBreakHtml;

function setUpPage() {
  wordBreakHtml = goog.format.WORD_BREAK_HTML;
}

function tearDown() {
  // set back to the original value (some tests edit this member).
  goog.format.WORD_BREAK_HTML = wordBreakHtml;
}

function testFormatFileSize() {
  var fn = goog.format.fileSize;

  assertEquals('45', fn(45));
  assertEquals('45', fn(45, 0));
  assertEquals('45', fn(45, 1));
  assertEquals('45', fn(45, 3));
  assertEquals('454', fn(454));
  assertEquals('600', fn(600));

  assertEquals('1K', fn(1024));
  assertEquals('2K', fn(2 * 1024));
  assertEquals('5K', fn(5 * 1024));
  assertEquals('5.123K', fn(5.12345 * 1024, 3));
  assertEquals('5.68K', fn(5.678 * 1024, 2));

  assertEquals('1M', fn(1024 * 1024));
  assertEquals('1.5M', fn(1.5 * 1024 * 1024));
  assertEquals('2M', fn(1.5 * 1024 * 1024, 0));
  assertEquals('1.5M', fn(1.51 * 1024 * 1024, 1));
  assertEquals('1.56M', fn(1.56 * 1024 * 1024, 2));

  assertEquals('1G', fn(1024 * 1024 * 1024));
  assertEquals('6G', fn(6 * 1024 * 1024 * 1024));
  assertEquals('12.06T', fn(12345.6789 * 1024 * 1024 * 1024));
}

function testIsConvertableScaledNumber() {
  var fn = goog.format.isConvertableScaledNumber;

  assertTrue(fn('0'));
  assertTrue(fn('45'));
  assertTrue(fn('45K'));
  assertTrue(fn('45MB'));
  assertTrue(fn('45GB'));
  assertTrue(fn('45T'));
  assertTrue(fn('2.33P'));
  assertTrue(fn('45m'));
  assertTrue(fn('45u'));
  assertTrue(fn('-5.0n'));

  assertFalse(fn('45x'));
  assertFalse(fn('ux'));
  assertFalse(fn('K'));
}

function testNumericValueToString() {
  var fn = goog.format.numericValueToString;

  assertEquals('0', fn(0.0));
  assertEquals('45', fn(45));
  assertEquals('454', fn(454));
  assertEquals('600', fn(600));

  assertEquals('1.02K', fn(1024));
  assertEquals('2.05K', fn(2 * 1024));
  assertEquals('5.12K', fn(5 * 1024));
  assertEquals('5.246K', fn(5.12345 * 1024, 3));
  assertEquals('5.81K', fn(5.678 * 1024, 2));

  assertEquals('1.05M', fn(1024 * 1024));
  assertEquals('1.57M', fn(1.5 * 1024 * 1024));
  assertEquals('2M', fn(1.5 * 1024 * 1024, 0));
  assertEquals('1.6M', fn(1.51 * 1024 * 1024, 1));
  assertEquals('1.64M', fn(1.56 * 1024 * 1024, 2));

  assertEquals('1.07G', fn(1024 * 1024 * 1024));
  assertEquals('6.44G', fn(6 * 1024 * 1024 * 1024));
  assertEquals('13.26T', fn(12345.6789 * 1024 * 1024 * 1024));

  assertEquals('23.4m', fn(0.0234));
  assertEquals('1.23u', fn(0.00000123));
  assertEquals('15.78n', fn(0.000000015784));
  assertEquals('0.58u', fn(0.0000005784));
  assertEquals('0.5', fn(0.5));

  assertEquals('-45', fn(-45.3, 0));
  assertEquals('-45', fn(-45.5, 0));
  assertEquals('-46', fn(-45.51, 0));
}

function testFormatNumBytes() {
  var fn = goog.format.numBytesToString;

  assertEquals('45', fn(45));
  assertEquals('454', fn(454));

  assertEquals('5KB', fn(5 * 1024));
  assertEquals('1MB', fn(1024 * 1024));
  assertEquals('6GB', fn(6 * 1024 * 1024 * 1024));
  assertEquals('12.06TB', fn(12345.6789 * 1024 * 1024 * 1024));
}

function testStringToNumeric() {
  var fn = goog.format.stringToNumericValue;
  var epsilon = Math.pow(10, -10);

  assertNaN(fn('foo'));

  assertEquals(45, fn('45'));
  assertEquals(-45, fn('-45'));
  assertEquals(-45, fn('-45'));
  assertEquals(454, fn('454'));

  assertEquals(5 * 1024, fn('5KB'));
  assertEquals(1024 * 1024, fn('1MB'));
  assertEquals(6 * 1024 * 1024 * 1024, fn('6GB'));
  assertEquals(13260110230978.56, fn('12.06TB'));

  assertEquals(5010, fn('5.01K'));
  assertEquals(5100000, fn('5.1M'));
  assertTrue(Math.abs(0.051 - fn('51.0m')) < epsilon);
  assertTrue(Math.abs(0.000051 - fn('51.0u')) < epsilon);
}

function testStringToNumBytes() {
  var fn = goog.format.stringToNumBytes;

  assertEquals(45, fn('45'));
  assertEquals(454, fn('454'));

  assertEquals(5 * 1024, fn('5K'));
  assertEquals(1024 * 1024, fn('1M'));
  assertEquals(6 * 1024 * 1024 * 1024, fn('6G'));
  assertEquals(13260110230978.56, fn('12.06T'));
}

function testInsertWordBreaks() {
  // HTML that gets inserted is browser dependent, ensure for the test it is
  // a constant - browser dependent HTML is for display purposes only.
  goog.format.WORD_BREAK_HTML = '<wbr>';

  var fn = goog.format.insertWordBreaks;

  assertEquals('abcdef', fn('abcdef', 10));
  assertEquals('ab<wbr>cd<wbr>ef', fn('abcdef', 2));
  assertEquals('a<wbr>b<wbr>c<wbr>d<wbr>e<wbr>f', fn('abcdef', 1));

  assertEquals('a&amp;b=<wbr>=fal<wbr>se', fn('a&amp;b==false', 4));
  assertEquals('&lt;&amp;&gt;&raquo;<wbr>&laquo;',
               fn('&lt;&amp;&gt;&raquo;&laquo;', 4));

  assertEquals('a<wbr>b<wbr>c d<wbr>e<wbr>f', fn('abc def', 1));
  assertEquals('ab<wbr>c de<wbr>f', fn('abc def', 2));
  assertEquals('abc def', fn('abc def', 3));
  assertEquals('abc def', fn('abc def', 4));

  assertEquals('a<b>cd</b>e<wbr>f', fn('a<b>cd</b>ef', 4));
  assertEquals('Thi<wbr>s is a <a href="">lin<wbr>k</a>.',
               fn('This is a <a href="">link</a>.', 3));
  assertEquals('<abc a="&amp;&amp;&amp;&amp;&amp;">a<wbr>b',
      fn('<abc a="&amp;&amp;&amp;&amp;&amp;">ab', 1));

  assertEquals('ab\u0300<wbr>cd', fn('ab\u0300cd', 2));
  assertEquals('ab\u036F<wbr>cd', fn('ab\u036Fcd', 2));
  assertEquals('ab<wbr>\u0370c<wbr>d', fn('ab\u0370cd', 2));
  assertEquals('ab<wbr>\uFE1Fc<wbr>d', fn('ab\uFE1Fcd', 2));
  assertEquals('ab\u0300<wbr>c\u0301<wbr>de<wbr>f',
      fn('ab\u0300c\u0301def', 2));
}

function testInsertWordBreaksBasic() {
  // HTML that gets inserted is browser dependent, ensure for the test it is
  // a constant - browser dependent HTML is for display purposes only.
  goog.format.WORD_BREAK_HTML = '<wbr>';
  var fn = goog.format.insertWordBreaksBasic;

  assertEquals('abcdef', fn('abcdef', 10));
  assertEquals('ab<wbr>cd<wbr>ef', fn('abcdef', 2));
  assertEquals('a<wbr>b<wbr>c<wbr>d<wbr>e<wbr>f', fn('abcdef', 1));
  assertEquals('ab\u0300<wbr>c\u0301<wbr>de<wbr>f',
      fn('ab\u0300c\u0301def', 2));

  assertEquals(
      'Inserting word breaks into the word "Russia" should work fine.',
      '\u0420\u043E<wbr>\u0441\u0441<wbr>\u0438\u044F',
      fn('\u0420\u043E\u0441\u0441\u0438\u044F', 2));

  // The word 'Internet' in Hindi.
  var hindiInternet = '\u0907\u0902\u091F\u0930\u0928\u0947\u091F';
  assertEquals('The baisc algorithm is not good enough to insert word ' +
      'breaks into Hindi.',
      hindiInternet, fn(hindiInternet, 2));
  // The word 'Internet' in Hindi broken into slashes.
  assertEquals('Hindi can have word breaks inserted between slashes',
      hindiInternet + '<wbr>/' + hindiInternet + '<wbr>.' + hindiInternet,
      fn(hindiInternet + '/' + hindiInternet + '.' + hindiInternet, 2));
}

function testWordBreaksWorking() {
  var text = goog.string.repeat('test', 20);
  var textWbr = goog.string.repeat('test' + goog.format.WORD_BREAK_HTML, 20);

  var overflowEl = goog.dom.createDom('div',
      {'style': 'width: 100px; overflow: hidden; margin 5px'});
  var wbrEl = goog.dom.createDom('div',
      {'style': 'width: 100px; overflow: hidden; margin-top: 15px'});
  goog.dom.appendChild(goog.global.document.body, overflowEl);
  goog.dom.appendChild(goog.global.document.body, wbrEl);

  overflowEl.innerHTML = text;
  wbrEl.innerHTML = textWbr;

  assertTrue('Text should overflow', overflowEl.scrollWidth > 100);
  assertTrue('Text should not overflow', wbrEl.scrollWidth <= 100);
}

function testWordBreaksRemovedFromTextContent() {
  var expectedText = goog.string.repeat('test', 20);
  var textWbr = goog.string.repeat('test' + goog.format.WORD_BREAK_HTML, 20);

  var wbrEl = goog.dom.createDom('div', null);
  wbrEl.innerHTML = textWbr;

  assertEquals('text content should have wbr character removed', expectedText,
      goog.dom.getTextContent(wbrEl));

}


">10 of 10 tests run in 8ms.<br />8 passed, 2 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testWordBreaksRemovedFromTextContent<br />Object #<Object> has no method 'createElement'<br />ERROR in testWordBreaksWorking<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>jsonprettyprinter_test.html</td><td>Success</td><td> 14 passed, 0 failed.</td><td title="

  goog.require('goog.format.JsonPrettyPrinter');
  goog.require('goog.testing.jsunit');


var formatter;


function setUp() {
  formatter = new goog.format.JsonPrettyPrinter();
}


function testUndefined() {
  assertEquals('', formatter.format());
}


function testNull() {
  assertEquals('', formatter.format(null));
}


function testBoolean() {
  assertEquals('true', formatter.format(true));
}


function testNumber() {
  assertEquals('1', formatter.format(1));
}


function testEmptyString() {
  assertEquals('', formatter.format(''));
}


function testWhitespaceString() {
  assertEquals('', formatter.format('   '));
}


function testString() {
  assertEquals('{}', formatter.format('{}'));
}


function testEmptyArray() {
  assertEquals('[]', formatter.format([]));
}


function testArrayOneElement() {
  assertEquals('[\n  1\n]', formatter.format([1]));
}


function testArrayMultipleElements() {
  assertEquals('[\n  1,\n  2,\n  3\n]', formatter.format([1, 2, 3]));
}


function testFunction() {
  assertEquals('{\n  "a": "1",\n  "b": ""\n}',
      formatter.format({'a': '1', 'b': function() { return null; }}));
}


function testObject() {
  assertEquals('{}', formatter.format({}));
}


function testObjectMultipleProperties() {
  assertEquals('{\n  "a": null,\n  "b": true,\n  "c": 1,\n  "d": "d",\n  "e":' +
      ' [\n    1,\n    2,\n    3\n  ],\n  "f": {\n    "g": 1,\n    "h": "h"\n' +
      '  }\n}',
      formatter.format({"a": null, "b": true, "c": 1, "d": "d", "e": [1, 2, 3],
          "f": {"g": 1, "h": "h"}}));
}


function testHtmlDelimiters() {
  var htmlFormatter = new goog.format.JsonPrettyPrinter(
      new goog.format.JsonPrettyPrinter.HtmlDelimiters());
  assertEquals('{\n  <span class="goog-jsonprettyprinter-propertyname">"a"</s' +
      'pan>: <span class="goog-jsonprettyprinter-propertyvalue-number">1</spa' +
      'n>,\n  <span class="goog-jsonprettyprinter-propertyname">"b"</span>: <' +
      'span class="goog-jsonprettyprinter-propertyvalue-string">"2"</span>,\n' +
      '  <span class="goog-jsonprettyprinter-propertyname">"c"</span>: <span ' +
      'class="goog-jsonprettyprinter-propertyvalue-unknown">""</span>\n}',
      htmlFormatter.format({"a": 1, "b": "2", "c": function() {}}));
}
">n/a</td></tr>
<tr><td>rect_test.html</td><td>Success</td><td> 12 passed, 0 failed.</td><td title="

goog.require('goog.math.Box');
goog.require('goog.math.Coordinate');
goog.require('goog.math.Rect');
goog.require('goog.math.Size');
goog.require('goog.testing.jsunit');



/**
 * Produce legible assertion results. If two rects are not equal, the error
 * message will be of the form
 * "Expected <(1, 2 - 10 x 10)> (Object) but was <(3, 4 - 20 x 20)> (Object)"
 */
function assertRectsEqual(expected, actual) {
  if (!goog.math.Rect.equals(expected, actual)) {
    assertEquals(expected, actual);
  }
}

function createRect(a) {
  return a ? new goog.math.Rect(a[0], a[1], a[2] - a[0], a[3] - a[1]) : null;
}

function testRectClone() {
  var r = new goog.math.Rect(0, 0, 0, 0);
  assertRectsEqual(r, r.clone());
  r.left = -10;
  r.top = -20;
  r.width = 10;
  r.height = 20;
  assertRectsEqual(r, r.clone());
}

function testRectIntersection() {
  var tests = [[[10, 10, 20, 20], [15, 15, 25, 25], [15, 15, 20, 20]],
               [[10, 10, 20, 20], [20, 0, 30, 10], [20, 10, 20, 10]],
               [[0, 0, 1, 1], [10, 11, 12, 13], null],
               [[11, 12, 98, 99], [22, 23, 34, 35], [22, 23, 34, 35]]];
  for (var i = 0; i < tests.length; ++i) {
    var t = tests[i];
    var r0 = createRect(t[0]);
    var r1 = createRect(t[1]);

    var expected = createRect(t[2]);

    assertRectsEqual(expected, goog.math.Rect.intersection(r0, r1));
    assertRectsEqual(expected, goog.math.Rect.intersection(r1, r0));

    // Test in place methods.
    var clone = r0.clone();

    assertRectsEqual(expected, clone.intersection(r1) ? clone : null);
    assertRectsEqual(expected, r1.intersection(r0) ? r1 : null);
  }
}

function testRectIntersects() {
  var r0 = createRect([10, 10, 20, 20]);
  var r1 = createRect([15, 15, 25, 25]);
  var r2 = createRect([0, 0, 1, 1]);

  assertTrue(goog.math.Rect.intersects(r0, r1));
  assertTrue(goog.math.Rect.intersects(r1, r0));
  assertTrue(r0.intersects(r1));
  assertTrue(r1.intersects(r0));

  assertFalse(goog.math.Rect.intersects(r0, r2));
  assertFalse(goog.math.Rect.intersects(r2, r0));
  assertFalse(r0.intersects(r2));
  assertFalse(r2.intersects(r0));
}

function testRectBoundingRect() {
  var tests = [[[10, 10, 20, 20], [15, 15, 25, 25], [10, 10, 25, 25]],
               [[10, 10, 20, 20], [20, 0, 30, 10], [10, 0, 30, 20]],
               [[0, 0, 1, 1], [10, 11, 12, 13], [0, 0, 12, 13]],
               [[11, 12, 98, 99], [22, 23, 34, 35], [11, 12, 98, 99]]];
  for (var i = 0; i < tests.length; ++i) {
    var t = tests[i];
    var r0 = createRect(t[0]);
    var r1 = createRect(t[1]);
    var expected = createRect(t[2]);
    assertRectsEqual(expected, goog.math.Rect.boundingRect(r0, r1));
    assertRectsEqual(expected, goog.math.Rect.boundingRect(r1, r0));

    // Test in place methods.
    var clone = r0.clone();

    clone.boundingRect(r1);
    assertRectsEqual(expected, clone);

    r1.boundingRect(r0);
    assertRectsEqual(expected, r1);
  }
}

function testRectDifference() {
  // B is the same as A.
  assertDifference([10, 10, 20, 20], [10, 10, 20, 20], []);
  // B does not touch A.
  assertDifference([10, 10, 20, 20], [0, 0, 5, 5], [[10, 10, 20, 20]]);
  // B overlaps top half of A.
  assertDifference([10, 10, 20, 20], [5, 15, 25, 25],
      [[10, 10, 20, 15]]);
  // B overlaps bottom half of A.
  assertDifference([10, 10, 20, 20], [5, 5, 25, 15],
      [[10, 15, 20, 20]]);
  // B overlaps right half of A.
  assertDifference([10, 10, 20, 20], [15, 5, 25, 25],
      [[10, 10, 15, 20]]);
  // B overlaps left half of A.
  assertDifference([10, 10, 20, 20], [5, 5, 15, 25],
      [[15, 10, 20, 20]]);
  // B touches A at its bottom right corner
  assertDifference([10, 10, 20, 20], [20, 20, 30, 30],
      [[10, 10, 20, 20]]);
  // B touches A at its top left corner
  assertDifference([10, 10, 20, 20], [5, 5, 10, 10],
      [[10, 10, 20, 20]]);
  // B touches A along its bottom edge
  assertDifference([10, 10, 20, 20], [12, 20, 17, 25],
      [[10, 10, 20, 20]]);
  // B splits A horizontally.
  assertDifference([10, 10, 20, 20], [5, 12, 25, 18],
      [[10, 10, 20, 12], [10, 18, 20, 20]]);
  // B splits A vertically.
  assertDifference([10, 10, 20, 20], [12, 5, 18, 25],
      [[10, 10, 12, 20], [18, 10, 20, 20]]);
  // B subtracts a notch from the top of A.
  assertDifference([10, 10, 20, 20], [12, 5, 18, 15],
      [[10, 15, 20, 20], [10, 10, 12, 15], [18, 10, 20, 15]]);
  // B subtracts a notch from the bottom left of A
  assertDifference([1, 6, 3, 9], [1, 7, 2, 9],
      [[1, 6, 3, 7], [2, 7, 3, 9]]);
  // B subtracts a notch from the bottom right of A
  assertDifference([1, 6, 3, 9], [2, 7, 3, 9],
      [[1, 6, 3, 7], [1, 7, 2, 9]]);
  // B subtracts a notch from the top left of A
  assertDifference([1, 6, 3, 9], [1, 6, 2, 8],
      [[1, 8, 3, 9], [2, 6, 3, 8]]);
  // B subtracts a notch from the top left of A (no coinciding edge)
  assertDifference([1, 6, 3, 9], [0, 5, 2, 8],
      [[1, 8, 3, 9], [2, 6, 3, 8]]);
  // B subtracts a hole from the center of A.
  assertDifference([-20, -20, -10, -10], [-18, -18, -12, -12],
      [[-20, -20, -10, -18], [-20, -12, -10, -10],
          [-20, -18, -18, -12], [-12, -18, -10, -12]]);
}

function assertDifference(a, b, expected) {
  var r0 = createRect(a);
  var r1 = createRect(b);
  var diff = goog.math.Rect.difference(r0, r1);

  assertEquals('Wrong number of rectangles in difference ',
      expected.length, diff.length);

  for (var j = 0; j < expected.length; ++j) {
    var e = createRect(expected[j]);
    if (!goog.math.Rect.equals(e, diff[j])) {
      alert(j + ": " + e + " != " + diff[j]);
    }
    assertRectsEqual(e, diff[j]);
  }

  // Test in place version
  var diff = r0.difference(r1);

  assertEquals('Wrong number of rectangles in in-place difference ',
      expected.length, diff.length);

  for (var j = 0; j < expected.length; ++j) {
    var e = createRect(expected[j]);
    if (!goog.math.Rect.equals(e, diff[j])) {
      alert(j + ": " + e + " != " + diff[j]);
    }
    assertRectsEqual(e, diff[j]);
  }
}

function testRectToBox() {
  var r = new goog.math.Rect(0, 0, 0, 0);
  assertEquals(new goog.math.Box(0, 0, 0, 0).toString(),
               r.toBox().toString());

  r.top = 10;
  r.left = 10;
  r.width = 20;
  r.height = 20;
  assertEquals(new goog.math.Box(10, 30, 30, 10).toString(),
               r.toBox().toString());

  r.top = -10;
  r.left = 0;
  r.width = 10;
  r.height = 10;
  assertEquals(new goog.math.Box(-10, 10, 0, 0).toString(),
               r.toBox().toString());
}

function testBoxToRect() {
  var box = new goog.math.Box(0, 0, 0, 0);
  assertEquals(new goog.math.Rect(0, 0, 0, 0).toString(),
               goog.math.Rect.createFromBox(box).toString());

  box.top = 10;
  box.left = 15;
  box.right = 23;
  box.bottom = 27;
  assertEquals(goog.math.Rect.createFromBox(box).toString(),
               new goog.math.Rect(15, 10, 8, 17).toString());

  box.top = -10;
  box.left = 3;
  box.right = 12;
  box.bottom = 7;
  assertEquals(new goog.math.Rect(3, -10, 9, 17).toString(),
               goog.math.Rect.createFromBox(box).toString());
}

function testBoxToRectAndBack() {
  rectToBoxAndBackTest(new goog.math.Rect(8, 11, 20, 23));
  rectToBoxAndBackTest(new goog.math.Rect(9, 13, NaN, NaN));
  rectToBoxAndBackTest(new goog.math.Rect(10, 13, NaN, 21));
  rectToBoxAndBackTest(new goog.math.Rect(5, 7, 14, NaN));
}

function rectToBoxAndBackTest(rect) {
  var box = rect.toBox();
  var rect2 = goog.math.Rect.createFromBox(box);
  assertEquals(rect.toString(), rect2.toString());
}

function testRectToBoxAndBack() {
  // This doesn't work if left or top is undefined.
  boxToRectAndBackTest(new goog.math.Box(11, 13, 20, 17));
  boxToRectAndBackTest(new goog.math.Box(10, NaN, NaN, 11));
  boxToRectAndBackTest(new goog.math.Box(9, 14, NaN, 11));
  boxToRectAndBackTest(new goog.math.Box(10, NaN, 22, 15));
}

function boxToRectAndBackTest(box) {
  var rect = goog.math.Rect.createFromBox(box);
  var box2 = rect.toBox();
  assertEquals(box.toString(), box2.toString());
}

function testRectContainsRect() {
  var r = new goog.math.Rect(-10, 0, 20, 10);
  assertTrue(r.contains(r));
  assertFalse(r.contains(new goog.math.Rect(NaN, NaN, NaN, NaN)));
  var r2 = new goog.math.Rect(0, 2, 5, 5);
  assertTrue(r.contains(r2));
  assertFalse(r2.contains(r));
  r2.left = -11;
  assertFalse(r.contains(r2));
  r2.left = 0;
  r2.width = 15;
  assertFalse(r.contains(r2));
  r2.width = 5;
  r2.height = 10;
  assertFalse(r.contains(r2));
  r2.top = 0;
  assertTrue(r.contains(r2));
}

function testRectContainsCoordinate() {
  var r = new goog.math.Rect(20, 40, 60, 80);

  // Test middle.
  assertTrue(r.contains(new goog.math.Coordinate(50, 80)));

  // Test edges.
  assertTrue(r.contains(new goog.math.Coordinate(20, 40)));
  assertTrue(r.contains(new goog.math.Coordinate(50, 40)));
  assertTrue(r.contains(new goog.math.Coordinate(80, 40)));
  assertTrue(r.contains(new goog.math.Coordinate(80, 80)));
  assertTrue(r.contains(new goog.math.Coordinate(80, 120)));
  assertTrue(r.contains(new goog.math.Coordinate(50, 120)));
  assertTrue(r.contains(new goog.math.Coordinate(20, 120)));
  assertTrue(r.contains(new goog.math.Coordinate(20, 80)));

  // Test outside.
  assertFalse(r.contains(new goog.math.Coordinate(0, 0)));
  assertFalse(r.contains(new goog.math.Coordinate(50, 0)));
  assertFalse(r.contains(new goog.math.Coordinate(100, 0)));
  assertFalse(r.contains(new goog.math.Coordinate(100, 80)));
  assertFalse(r.contains(new goog.math.Coordinate(100, 160)));
  assertFalse(r.contains(new goog.math.Coordinate(50, 160)));
  assertFalse(r.contains(new goog.math.Coordinate(0, 160)));
  assertFalse(r.contains(new goog.math.Coordinate(0, 80)));
}

function testGetSize() {
  assertEquals(new goog.math.Size(60, 80).toString(),
               new goog.math.Rect(20, 40, 60, 80).getSize().toString());
}
">n/a</td></tr>
<tr><td>long_test.html</td><td>Success</td><td> 150 passed, 0 failed.</td><td title="

  goog.require('goog.math.Long');
  goog.require('goog.testing.jsunit');


// Interprets the given numbers as the bits of a 32-bit int.  In particular,
// this takes care of the 32-bit being interpretted as the sign.
function toInt32s(arr) {
  for (var i = 0; i < arr.length; ++i) {
    arr[i] = arr[i] & 0xFFFFFFFF;
  }
}

// Note that these are in numerical order.
var TEST_BITS = [ 0x80000000, 0x00000000,
                  0xb776d5f5, 0x5634e2db,
                  0xffefffff, 0xffffffff,
                  0xfff00000, 0x00000000,
                  0xfffeffff, 0xffffffff,
                  0xffff0000, 0x00000000,
                  0xfffffffe, 0xffffffff,
                  0xffffffff, 0x00000000,
                  0xffffffff, 0xfeffffff,
                  0xffffffff, 0xff000000,
                  0xffffffff, 0xfffeffff,
                  0xffffffff, 0xffff0000,
                  0xffffffff, 0xffff7fff,
                  0xffffffff, 0xffff8000,
                  0xffffffff, 0xfffffffe,
                  0xffffffff, 0xffffffff,
                  0x00000000, 0x00000000,
                  0x00000000, 0x00000001,
                  0x00000000, 0x00000002,
                  0x00000000, 0x00007fff,
                  0x00000000, 0x00008000,
                  0x00000000, 0x0000ffff,
                  0x00000000, 0x00010000,
                  0x00000000, 0x00ffffff,
                  0x00000000, 0x01000000,
                  0x00000000, 0x5634e2db,
                  0x00000000, 0xb776d5f5,
                  0x00000000, 0xffffffff,
                  0x00000001, 0x00000000,
                  0x0000ffff, 0xffffffff,
                  0x00010000, 0x00000000,
                  0x000fffff, 0xffffffff,
                  0x00100000, 0x00000000,
                  0x5634e2db, 0xb776d5f5,
                  0x7fffffff, 0xffffffff ];
toInt32s(TEST_BITS);

var TEST_ADD_BITS = [
      0x3776d5f5, 0x5634e2db, 0x7fefffff, 0xffffffff, 0xb766d5f5, 0x5634e2da,
      0x7ff00000, 0x00000000, 0xb766d5f5, 0x5634e2db, 0xffdfffff, 0xffffffff,
      0x7ffeffff, 0xffffffff, 0xb775d5f5, 0x5634e2da, 0xffeeffff, 0xfffffffe,
      0xffeeffff, 0xffffffff, 0x7fff0000, 0x00000000, 0xb775d5f5, 0x5634e2db,
      0xffeeffff, 0xffffffff, 0xffef0000, 0x00000000, 0xfffdffff, 0xffffffff,
      0x7ffffffe, 0xffffffff, 0xb776d5f4, 0x5634e2da, 0xffeffffe, 0xfffffffe,
      0xffeffffe, 0xffffffff, 0xfffefffe, 0xfffffffe, 0xfffefffe, 0xffffffff,
      0x7fffffff, 0x00000000, 0xb776d5f4, 0x5634e2db, 0xffeffffe, 0xffffffff,
      0xffefffff, 0x00000000, 0xfffefffe, 0xffffffff, 0xfffeffff, 0x00000000,
      0xfffffffd, 0xffffffff, 0x7fffffff, 0xfeffffff, 0xb776d5f5, 0x5534e2da,
      0xffefffff, 0xfefffffe, 0xffefffff, 0xfeffffff, 0xfffeffff, 0xfefffffe,
      0xfffeffff, 0xfeffffff, 0xfffffffe, 0xfefffffe, 0xfffffffe, 0xfeffffff,
      0x7fffffff, 0xff000000, 0xb776d5f5, 0x5534e2db, 0xffefffff, 0xfeffffff,
      0xffefffff, 0xff000000, 0xfffeffff, 0xfeffffff, 0xfffeffff, 0xff000000,
      0xfffffffe, 0xfeffffff, 0xfffffffe, 0xff000000, 0xffffffff, 0xfdffffff,
      0x7fffffff, 0xfffeffff, 0xb776d5f5, 0x5633e2da, 0xffefffff, 0xfffefffe,
      0xffefffff, 0xfffeffff, 0xfffeffff, 0xfffefffe, 0xfffeffff, 0xfffeffff,
      0xfffffffe, 0xfffefffe, 0xfffffffe, 0xfffeffff, 0xffffffff, 0xfefefffe,
      0xffffffff, 0xfefeffff, 0x7fffffff, 0xffff0000, 0xb776d5f5, 0x5633e2db,
      0xffefffff, 0xfffeffff, 0xffefffff, 0xffff0000, 0xfffeffff, 0xfffeffff,
      0xfffeffff, 0xffff0000, 0xfffffffe, 0xfffeffff, 0xfffffffe, 0xffff0000,
      0xffffffff, 0xfefeffff, 0xffffffff, 0xfeff0000, 0xffffffff, 0xfffdffff,
      0x7fffffff, 0xffff7fff, 0xb776d5f5, 0x563462da, 0xffefffff, 0xffff7ffe,
      0xffefffff, 0xffff7fff, 0xfffeffff, 0xffff7ffe, 0xfffeffff, 0xffff7fff,
      0xfffffffe, 0xffff7ffe, 0xfffffffe, 0xffff7fff, 0xffffffff, 0xfeff7ffe,
      0xffffffff, 0xfeff7fff, 0xffffffff, 0xfffe7ffe, 0xffffffff, 0xfffe7fff,
      0x7fffffff, 0xffff8000, 0xb776d5f5, 0x563462db, 0xffefffff, 0xffff7fff,
      0xffefffff, 0xffff8000, 0xfffeffff, 0xffff7fff, 0xfffeffff, 0xffff8000,
      0xfffffffe, 0xffff7fff, 0xfffffffe, 0xffff8000, 0xffffffff, 0xfeff7fff,
      0xffffffff, 0xfeff8000, 0xffffffff, 0xfffe7fff, 0xffffffff, 0xfffe8000,
      0xffffffff, 0xfffeffff, 0x7fffffff, 0xfffffffe, 0xb776d5f5, 0x5634e2d9,
      0xffefffff, 0xfffffffd, 0xffefffff, 0xfffffffe, 0xfffeffff, 0xfffffffd,
      0xfffeffff, 0xfffffffe, 0xfffffffe, 0xfffffffd, 0xfffffffe, 0xfffffffe,
      0xffffffff, 0xfefffffd, 0xffffffff, 0xfefffffe, 0xffffffff, 0xfffefffd,
      0xffffffff, 0xfffefffe, 0xffffffff, 0xffff7ffd, 0xffffffff, 0xffff7ffe,
      0x7fffffff, 0xffffffff, 0xb776d5f5, 0x5634e2da, 0xffefffff, 0xfffffffe,
      0xffefffff, 0xffffffff, 0xfffeffff, 0xfffffffe, 0xfffeffff, 0xffffffff,
      0xfffffffe, 0xfffffffe, 0xfffffffe, 0xffffffff, 0xffffffff, 0xfefffffe,
      0xffffffff, 0xfeffffff, 0xffffffff, 0xfffefffe, 0xffffffff, 0xfffeffff,
      0xffffffff, 0xffff7ffe, 0xffffffff, 0xffff7fff, 0xffffffff, 0xfffffffd,
      0x80000000, 0x00000000, 0xb776d5f5, 0x5634e2db, 0xffefffff, 0xffffffff,
      0xfff00000, 0x00000000, 0xfffeffff, 0xffffffff, 0xffff0000, 0x00000000,
      0xfffffffe, 0xffffffff, 0xffffffff, 0x00000000, 0xffffffff, 0xfeffffff,
      0xffffffff, 0xff000000, 0xffffffff, 0xfffeffff, 0xffffffff, 0xffff0000,
      0xffffffff, 0xffff7fff, 0xffffffff, 0xffff8000, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xffffffff, 0x80000000, 0x00000001, 0xb776d5f5, 0x5634e2dc,
      0xfff00000, 0x00000000, 0xfff00000, 0x00000001, 0xffff0000, 0x00000000,
      0xffff0000, 0x00000001, 0xffffffff, 0x00000000, 0xffffffff, 0x00000001,
      0xffffffff, 0xff000000, 0xffffffff, 0xff000001, 0xffffffff, 0xffff0000,
      0xffffffff, 0xffff0001, 0xffffffff, 0xffff8000, 0xffffffff, 0xffff8001,
      0xffffffff, 0xffffffff, 0x00000000, 0x00000000, 0x00000000, 0x00000001,
      0x80000000, 0x00000002, 0xb776d5f5, 0x5634e2dd, 0xfff00000, 0x00000001,
      0xfff00000, 0x00000002, 0xffff0000, 0x00000001, 0xffff0000, 0x00000002,
      0xffffffff, 0x00000001, 0xffffffff, 0x00000002, 0xffffffff, 0xff000001,
      0xffffffff, 0xff000002, 0xffffffff, 0xffff0001, 0xffffffff, 0xffff0002,
      0xffffffff, 0xffff8001, 0xffffffff, 0xffff8002, 0x00000000, 0x00000000,
      0x00000000, 0x00000001, 0x00000000, 0x00000002, 0x00000000, 0x00000003,
      0x80000000, 0x00007fff, 0xb776d5f5, 0x563562da, 0xfff00000, 0x00007ffe,
      0xfff00000, 0x00007fff, 0xffff0000, 0x00007ffe, 0xffff0000, 0x00007fff,
      0xffffffff, 0x00007ffe, 0xffffffff, 0x00007fff, 0xffffffff, 0xff007ffe,
      0xffffffff, 0xff007fff, 0xffffffff, 0xffff7ffe, 0xffffffff, 0xffff7fff,
      0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff, 0x00000000, 0x00007ffd,
      0x00000000, 0x00007ffe, 0x00000000, 0x00007fff, 0x00000000, 0x00008000,
      0x00000000, 0x00008001, 0x80000000, 0x00008000, 0xb776d5f5, 0x563562db,
      0xfff00000, 0x00007fff, 0xfff00000, 0x00008000, 0xffff0000, 0x00007fff,
      0xffff0000, 0x00008000, 0xffffffff, 0x00007fff, 0xffffffff, 0x00008000,
      0xffffffff, 0xff007fff, 0xffffffff, 0xff008000, 0xffffffff, 0xffff7fff,
      0xffffffff, 0xffff8000, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00007ffe, 0x00000000, 0x00007fff, 0x00000000, 0x00008000,
      0x00000000, 0x00008001, 0x00000000, 0x00008002, 0x00000000, 0x0000ffff,
      0x80000000, 0x0000ffff, 0xb776d5f5, 0x5635e2da, 0xfff00000, 0x0000fffe,
      0xfff00000, 0x0000ffff, 0xffff0000, 0x0000fffe, 0xffff0000, 0x0000ffff,
      0xffffffff, 0x0000fffe, 0xffffffff, 0x0000ffff, 0xffffffff, 0xff00fffe,
      0xffffffff, 0xff00ffff, 0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff,
      0x00000000, 0x00007ffe, 0x00000000, 0x00007fff, 0x00000000, 0x0000fffd,
      0x00000000, 0x0000fffe, 0x00000000, 0x0000ffff, 0x00000000, 0x00010000,
      0x00000000, 0x00010001, 0x00000000, 0x00017ffe, 0x00000000, 0x00017fff,
      0x80000000, 0x00010000, 0xb776d5f5, 0x5635e2db, 0xfff00000, 0x0000ffff,
      0xfff00000, 0x00010000, 0xffff0000, 0x0000ffff, 0xffff0000, 0x00010000,
      0xffffffff, 0x0000ffff, 0xffffffff, 0x00010000, 0xffffffff, 0xff00ffff,
      0xffffffff, 0xff010000, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00007fff, 0x00000000, 0x00008000, 0x00000000, 0x0000fffe,
      0x00000000, 0x0000ffff, 0x00000000, 0x00010000, 0x00000000, 0x00010001,
      0x00000000, 0x00010002, 0x00000000, 0x00017fff, 0x00000000, 0x00018000,
      0x00000000, 0x0001ffff, 0x80000000, 0x00ffffff, 0xb776d5f5, 0x5734e2da,
      0xfff00000, 0x00fffffe, 0xfff00000, 0x00ffffff, 0xffff0000, 0x00fffffe,
      0xffff0000, 0x00ffffff, 0xffffffff, 0x00fffffe, 0xffffffff, 0x00ffffff,
      0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff, 0x00000000, 0x00fefffe,
      0x00000000, 0x00feffff, 0x00000000, 0x00ff7ffe, 0x00000000, 0x00ff7fff,
      0x00000000, 0x00fffffd, 0x00000000, 0x00fffffe, 0x00000000, 0x00ffffff,
      0x00000000, 0x01000000, 0x00000000, 0x01000001, 0x00000000, 0x01007ffe,
      0x00000000, 0x01007fff, 0x00000000, 0x0100fffe, 0x00000000, 0x0100ffff,
      0x80000000, 0x01000000, 0xb776d5f5, 0x5734e2db, 0xfff00000, 0x00ffffff,
      0xfff00000, 0x01000000, 0xffff0000, 0x00ffffff, 0xffff0000, 0x01000000,
      0xffffffff, 0x00ffffff, 0xffffffff, 0x01000000, 0xffffffff, 0xffffffff,
      0x00000000, 0x00000000, 0x00000000, 0x00feffff, 0x00000000, 0x00ff0000,
      0x00000000, 0x00ff7fff, 0x00000000, 0x00ff8000, 0x00000000, 0x00fffffe,
      0x00000000, 0x00ffffff, 0x00000000, 0x01000000, 0x00000000, 0x01000001,
      0x00000000, 0x01000002, 0x00000000, 0x01007fff, 0x00000000, 0x01008000,
      0x00000000, 0x0100ffff, 0x00000000, 0x01010000, 0x00000000, 0x01ffffff,
      0x80000000, 0x5634e2db, 0xb776d5f5, 0xac69c5b6, 0xfff00000, 0x5634e2da,
      0xfff00000, 0x5634e2db, 0xffff0000, 0x5634e2da, 0xffff0000, 0x5634e2db,
      0xffffffff, 0x5634e2da, 0xffffffff, 0x5634e2db, 0x00000000, 0x5534e2da,
      0x00000000, 0x5534e2db, 0x00000000, 0x5633e2da, 0x00000000, 0x5633e2db,
      0x00000000, 0x563462da, 0x00000000, 0x563462db, 0x00000000, 0x5634e2d9,
      0x00000000, 0x5634e2da, 0x00000000, 0x5634e2db, 0x00000000, 0x5634e2dc,
      0x00000000, 0x5634e2dd, 0x00000000, 0x563562da, 0x00000000, 0x563562db,
      0x00000000, 0x5635e2da, 0x00000000, 0x5635e2db, 0x00000000, 0x5734e2da,
      0x00000000, 0x5734e2db, 0x80000000, 0xb776d5f5, 0xb776d5f6, 0x0dabb8d0,
      0xfff00000, 0xb776d5f4, 0xfff00000, 0xb776d5f5, 0xffff0000, 0xb776d5f4,
      0xffff0000, 0xb776d5f5, 0xffffffff, 0xb776d5f4, 0xffffffff, 0xb776d5f5,
      0x00000000, 0xb676d5f4, 0x00000000, 0xb676d5f5, 0x00000000, 0xb775d5f4,
      0x00000000, 0xb775d5f5, 0x00000000, 0xb77655f4, 0x00000000, 0xb77655f5,
      0x00000000, 0xb776d5f3, 0x00000000, 0xb776d5f4, 0x00000000, 0xb776d5f5,
      0x00000000, 0xb776d5f6, 0x00000000, 0xb776d5f7, 0x00000000, 0xb77755f4,
      0x00000000, 0xb77755f5, 0x00000000, 0xb777d5f4, 0x00000000, 0xb777d5f5,
      0x00000000, 0xb876d5f4, 0x00000000, 0xb876d5f5, 0x00000001, 0x0dabb8d0,
      0x80000000, 0xffffffff, 0xb776d5f6, 0x5634e2da, 0xfff00000, 0xfffffffe,
      0xfff00000, 0xffffffff, 0xffff0000, 0xfffffffe, 0xffff0000, 0xffffffff,
      0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff, 0x00000000, 0xfefffffe,
      0x00000000, 0xfeffffff, 0x00000000, 0xfffefffe, 0x00000000, 0xfffeffff,
      0x00000000, 0xffff7ffe, 0x00000000, 0xffff7fff, 0x00000000, 0xfffffffd,
      0x00000000, 0xfffffffe, 0x00000000, 0xffffffff, 0x00000001, 0x00000000,
      0x00000001, 0x00000001, 0x00000001, 0x00007ffe, 0x00000001, 0x00007fff,
      0x00000001, 0x0000fffe, 0x00000001, 0x0000ffff, 0x00000001, 0x00fffffe,
      0x00000001, 0x00ffffff, 0x00000001, 0x5634e2da, 0x00000001, 0xb776d5f4,
      0x80000001, 0x00000000, 0xb776d5f6, 0x5634e2db, 0xfff00000, 0xffffffff,
      0xfff00001, 0x00000000, 0xffff0000, 0xffffffff, 0xffff0001, 0x00000000,
      0xffffffff, 0xffffffff, 0x00000000, 0x00000000, 0x00000000, 0xfeffffff,
      0x00000000, 0xff000000, 0x00000000, 0xfffeffff, 0x00000000, 0xffff0000,
      0x00000000, 0xffff7fff, 0x00000000, 0xffff8000, 0x00000000, 0xfffffffe,
      0x00000000, 0xffffffff, 0x00000001, 0x00000000, 0x00000001, 0x00000001,
      0x00000001, 0x00000002, 0x00000001, 0x00007fff, 0x00000001, 0x00008000,
      0x00000001, 0x0000ffff, 0x00000001, 0x00010000, 0x00000001, 0x00ffffff,
      0x00000001, 0x01000000, 0x00000001, 0x5634e2db, 0x00000001, 0xb776d5f5,
      0x00000001, 0xffffffff, 0x8000ffff, 0xffffffff, 0xb777d5f5, 0x5634e2da,
      0xfff0ffff, 0xfffffffe, 0xfff0ffff, 0xffffffff, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xffffffff, 0x0000fffe, 0xfffffffe, 0x0000fffe, 0xffffffff,
      0x0000ffff, 0xfefffffe, 0x0000ffff, 0xfeffffff, 0x0000ffff, 0xfffefffe,
      0x0000ffff, 0xfffeffff, 0x0000ffff, 0xffff7ffe, 0x0000ffff, 0xffff7fff,
      0x0000ffff, 0xfffffffd, 0x0000ffff, 0xfffffffe, 0x0000ffff, 0xffffffff,
      0x00010000, 0x00000000, 0x00010000, 0x00000001, 0x00010000, 0x00007ffe,
      0x00010000, 0x00007fff, 0x00010000, 0x0000fffe, 0x00010000, 0x0000ffff,
      0x00010000, 0x00fffffe, 0x00010000, 0x00ffffff, 0x00010000, 0x5634e2da,
      0x00010000, 0xb776d5f4, 0x00010000, 0xfffffffe, 0x00010000, 0xffffffff,
      0x80010000, 0x00000000, 0xb777d5f5, 0x5634e2db, 0xfff0ffff, 0xffffffff,
      0xfff10000, 0x00000000, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x0000fffe, 0xffffffff, 0x0000ffff, 0x00000000, 0x0000ffff, 0xfeffffff,
      0x0000ffff, 0xff000000, 0x0000ffff, 0xfffeffff, 0x0000ffff, 0xffff0000,
      0x0000ffff, 0xffff7fff, 0x0000ffff, 0xffff8000, 0x0000ffff, 0xfffffffe,
      0x0000ffff, 0xffffffff, 0x00010000, 0x00000000, 0x00010000, 0x00000001,
      0x00010000, 0x00000002, 0x00010000, 0x00007fff, 0x00010000, 0x00008000,
      0x00010000, 0x0000ffff, 0x00010000, 0x00010000, 0x00010000, 0x00ffffff,
      0x00010000, 0x01000000, 0x00010000, 0x5634e2db, 0x00010000, 0xb776d5f5,
      0x00010000, 0xffffffff, 0x00010001, 0x00000000, 0x0001ffff, 0xffffffff,
      0x800fffff, 0xffffffff, 0xb786d5f5, 0x5634e2da, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xffffffff, 0x000effff, 0xfffffffe, 0x000effff, 0xffffffff,
      0x000ffffe, 0xfffffffe, 0x000ffffe, 0xffffffff, 0x000fffff, 0xfefffffe,
      0x000fffff, 0xfeffffff, 0x000fffff, 0xfffefffe, 0x000fffff, 0xfffeffff,
      0x000fffff, 0xffff7ffe, 0x000fffff, 0xffff7fff, 0x000fffff, 0xfffffffd,
      0x000fffff, 0xfffffffe, 0x000fffff, 0xffffffff, 0x00100000, 0x00000000,
      0x00100000, 0x00000001, 0x00100000, 0x00007ffe, 0x00100000, 0x00007fff,
      0x00100000, 0x0000fffe, 0x00100000, 0x0000ffff, 0x00100000, 0x00fffffe,
      0x00100000, 0x00ffffff, 0x00100000, 0x5634e2da, 0x00100000, 0xb776d5f4,
      0x00100000, 0xfffffffe, 0x00100000, 0xffffffff, 0x0010ffff, 0xfffffffe,
      0x0010ffff, 0xffffffff, 0x80100000, 0x00000000, 0xb786d5f5, 0x5634e2db,
      0xffffffff, 0xffffffff, 0x00000000, 0x00000000, 0x000effff, 0xffffffff,
      0x000f0000, 0x00000000, 0x000ffffe, 0xffffffff, 0x000fffff, 0x00000000,
      0x000fffff, 0xfeffffff, 0x000fffff, 0xff000000, 0x000fffff, 0xfffeffff,
      0x000fffff, 0xffff0000, 0x000fffff, 0xffff7fff, 0x000fffff, 0xffff8000,
      0x000fffff, 0xfffffffe, 0x000fffff, 0xffffffff, 0x00100000, 0x00000000,
      0x00100000, 0x00000001, 0x00100000, 0x00000002, 0x00100000, 0x00007fff,
      0x00100000, 0x00008000, 0x00100000, 0x0000ffff, 0x00100000, 0x00010000,
      0x00100000, 0x00ffffff, 0x00100000, 0x01000000, 0x00100000, 0x5634e2db,
      0x00100000, 0xb776d5f5, 0x00100000, 0xffffffff, 0x00100001, 0x00000000,
      0x0010ffff, 0xffffffff, 0x00110000, 0x00000000, 0x001fffff, 0xffffffff,
      0xd634e2db, 0xb776d5f5, 0x0dabb8d1, 0x0dabb8d0, 0x5624e2db, 0xb776d5f4,
      0x5624e2db, 0xb776d5f5, 0x5633e2db, 0xb776d5f4, 0x5633e2db, 0xb776d5f5,
      0x5634e2da, 0xb776d5f4, 0x5634e2da, 0xb776d5f5, 0x5634e2db, 0xb676d5f4,
      0x5634e2db, 0xb676d5f5, 0x5634e2db, 0xb775d5f4, 0x5634e2db, 0xb775d5f5,
      0x5634e2db, 0xb77655f4, 0x5634e2db, 0xb77655f5, 0x5634e2db, 0xb776d5f3,
      0x5634e2db, 0xb776d5f4, 0x5634e2db, 0xb776d5f5, 0x5634e2db, 0xb776d5f6,
      0x5634e2db, 0xb776d5f7, 0x5634e2db, 0xb77755f4, 0x5634e2db, 0xb77755f5,
      0x5634e2db, 0xb777d5f4, 0x5634e2db, 0xb777d5f5, 0x5634e2db, 0xb876d5f4,
      0x5634e2db, 0xb876d5f5, 0x5634e2dc, 0x0dabb8d0, 0x5634e2dc, 0x6eedabea,
      0x5634e2dc, 0xb776d5f4, 0x5634e2dc, 0xb776d5f5, 0x5635e2db, 0xb776d5f4,
      0x5635e2db, 0xb776d5f5, 0x5644e2db, 0xb776d5f4, 0x5644e2db, 0xb776d5f5,
      0xffffffff, 0xffffffff, 0x3776d5f5, 0x5634e2da, 0x7fefffff, 0xfffffffe,
      0x7fefffff, 0xffffffff, 0x7ffeffff, 0xfffffffe, 0x7ffeffff, 0xffffffff,
      0x7ffffffe, 0xfffffffe, 0x7ffffffe, 0xffffffff, 0x7fffffff, 0xfefffffe,
      0x7fffffff, 0xfeffffff, 0x7fffffff, 0xfffefffe, 0x7fffffff, 0xfffeffff,
      0x7fffffff, 0xffff7ffe, 0x7fffffff, 0xffff7fff, 0x7fffffff, 0xfffffffd,
      0x7fffffff, 0xfffffffe, 0x7fffffff, 0xffffffff, 0x80000000, 0x00000000,
      0x80000000, 0x00000001, 0x80000000, 0x00007ffe, 0x80000000, 0x00007fff,
      0x80000000, 0x0000fffe, 0x80000000, 0x0000ffff, 0x80000000, 0x00fffffe,
      0x80000000, 0x00ffffff, 0x80000000, 0x5634e2da, 0x80000000, 0xb776d5f4,
      0x80000000, 0xfffffffe, 0x80000000, 0xffffffff, 0x8000ffff, 0xfffffffe,
      0x8000ffff, 0xffffffff, 0x800fffff, 0xfffffffe, 0x800fffff, 0xffffffff,
      0xd634e2db, 0xb776d5f4
    ];
toInt32s(TEST_ADD_BITS);

var TEST_SUB_BITS = [
      0x00000000, 0x00000000, 0xc8892a0a, 0xa9cb1d25, 0x80100000, 0x00000001,
      0x80100000, 0x00000000, 0x80010000, 0x00000001, 0x80010000, 0x00000000,
      0x80000001, 0x00000001, 0x80000001, 0x00000000, 0x80000000, 0x01000001,
      0x80000000, 0x01000000, 0x80000000, 0x00010001, 0x80000000, 0x00010000,
      0x80000000, 0x00008001, 0x80000000, 0x00008000, 0x80000000, 0x00000002,
      0x80000000, 0x00000001, 0x80000000, 0x00000000, 0x7fffffff, 0xffffffff,
      0x7fffffff, 0xfffffffe, 0x7fffffff, 0xffff8001, 0x7fffffff, 0xffff8000,
      0x7fffffff, 0xffff0001, 0x7fffffff, 0xffff0000, 0x7fffffff, 0xff000001,
      0x7fffffff, 0xff000000, 0x7fffffff, 0xa9cb1d25, 0x7fffffff, 0x48892a0b,
      0x7fffffff, 0x00000001, 0x7fffffff, 0x00000000, 0x7fff0000, 0x00000001,
      0x7fff0000, 0x00000000, 0x7ff00000, 0x00000001, 0x7ff00000, 0x00000000,
      0x29cb1d24, 0x48892a0b, 0x00000000, 0x00000001, 0x3776d5f5, 0x5634e2db,
      0x00000000, 0x00000000, 0xb786d5f5, 0x5634e2dc, 0xb786d5f5, 0x5634e2db,
      0xb777d5f5, 0x5634e2dc, 0xb777d5f5, 0x5634e2db, 0xb776d5f6, 0x5634e2dc,
      0xb776d5f6, 0x5634e2db, 0xb776d5f5, 0x5734e2dc, 0xb776d5f5, 0x5734e2db,
      0xb776d5f5, 0x5635e2dc, 0xb776d5f5, 0x5635e2db, 0xb776d5f5, 0x563562dc,
      0xb776d5f5, 0x563562db, 0xb776d5f5, 0x5634e2dd, 0xb776d5f5, 0x5634e2dc,
      0xb776d5f5, 0x5634e2db, 0xb776d5f5, 0x5634e2da, 0xb776d5f5, 0x5634e2d9,
      0xb776d5f5, 0x563462dc, 0xb776d5f5, 0x563462db, 0xb776d5f5, 0x5633e2dc,
      0xb776d5f5, 0x5633e2db, 0xb776d5f5, 0x5534e2dc, 0xb776d5f5, 0x5534e2db,
      0xb776d5f5, 0x00000000, 0xb776d5f4, 0x9ebe0ce6, 0xb776d5f4, 0x5634e2dc,
      0xb776d5f4, 0x5634e2db, 0xb775d5f5, 0x5634e2dc, 0xb775d5f5, 0x5634e2db,
      0xb766d5f5, 0x5634e2dc, 0xb766d5f5, 0x5634e2db, 0x6141f319, 0x9ebe0ce6,
      0x3776d5f5, 0x5634e2dc, 0x7fefffff, 0xffffffff, 0x48792a0a, 0xa9cb1d24,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xfff10000, 0x00000000,
      0xfff0ffff, 0xffffffff, 0xfff00001, 0x00000000, 0xfff00000, 0xffffffff,
      0xfff00000, 0x01000000, 0xfff00000, 0x00ffffff, 0xfff00000, 0x00010000,
      0xfff00000, 0x0000ffff, 0xfff00000, 0x00008000, 0xfff00000, 0x00007fff,
      0xfff00000, 0x00000001, 0xfff00000, 0x00000000, 0xffefffff, 0xffffffff,
      0xffefffff, 0xfffffffe, 0xffefffff, 0xfffffffd, 0xffefffff, 0xffff8000,
      0xffefffff, 0xffff7fff, 0xffefffff, 0xffff0000, 0xffefffff, 0xfffeffff,
      0xffefffff, 0xff000000, 0xffefffff, 0xfeffffff, 0xffefffff, 0xa9cb1d24,
      0xffefffff, 0x48892a0a, 0xffefffff, 0x00000000, 0xffeffffe, 0xffffffff,
      0xffef0000, 0x00000000, 0xffeeffff, 0xffffffff, 0xffe00000, 0x00000000,
      0xffdfffff, 0xffffffff, 0xa9bb1d24, 0x48892a0a, 0x7ff00000, 0x00000000,
      0x7ff00000, 0x00000000, 0x48792a0a, 0xa9cb1d25, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xfff10000, 0x00000001, 0xfff10000, 0x00000000,
      0xfff00001, 0x00000001, 0xfff00001, 0x00000000, 0xfff00000, 0x01000001,
      0xfff00000, 0x01000000, 0xfff00000, 0x00010001, 0xfff00000, 0x00010000,
      0xfff00000, 0x00008001, 0xfff00000, 0x00008000, 0xfff00000, 0x00000002,
      0xfff00000, 0x00000001, 0xfff00000, 0x00000000, 0xffefffff, 0xffffffff,
      0xffefffff, 0xfffffffe, 0xffefffff, 0xffff8001, 0xffefffff, 0xffff8000,
      0xffefffff, 0xffff0001, 0xffefffff, 0xffff0000, 0xffefffff, 0xff000001,
      0xffefffff, 0xff000000, 0xffefffff, 0xa9cb1d25, 0xffefffff, 0x48892a0b,
      0xffefffff, 0x00000001, 0xffefffff, 0x00000000, 0xffef0000, 0x00000001,
      0xffef0000, 0x00000000, 0xffe00000, 0x00000001, 0xffe00000, 0x00000000,
      0xa9bb1d24, 0x48892a0b, 0x7ff00000, 0x00000001, 0x7ffeffff, 0xffffffff,
      0x48882a0a, 0xa9cb1d24, 0x000f0000, 0x00000000, 0x000effff, 0xffffffff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffff0001, 0x00000000,
      0xffff0000, 0xffffffff, 0xffff0000, 0x01000000, 0xffff0000, 0x00ffffff,
      0xffff0000, 0x00010000, 0xffff0000, 0x0000ffff, 0xffff0000, 0x00008000,
      0xffff0000, 0x00007fff, 0xffff0000, 0x00000001, 0xffff0000, 0x00000000,
      0xfffeffff, 0xffffffff, 0xfffeffff, 0xfffffffe, 0xfffeffff, 0xfffffffd,
      0xfffeffff, 0xffff8000, 0xfffeffff, 0xffff7fff, 0xfffeffff, 0xffff0000,
      0xfffeffff, 0xfffeffff, 0xfffeffff, 0xff000000, 0xfffeffff, 0xfeffffff,
      0xfffeffff, 0xa9cb1d24, 0xfffeffff, 0x48892a0a, 0xfffeffff, 0x00000000,
      0xfffefffe, 0xffffffff, 0xfffe0000, 0x00000000, 0xfffdffff, 0xffffffff,
      0xffef0000, 0x00000000, 0xffeeffff, 0xffffffff, 0xa9ca1d24, 0x48892a0a,
      0x7fff0000, 0x00000000, 0x7fff0000, 0x00000000, 0x48882a0a, 0xa9cb1d25,
      0x000f0000, 0x00000001, 0x000f0000, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffff0001, 0x00000001, 0xffff0001, 0x00000000,
      0xffff0000, 0x01000001, 0xffff0000, 0x01000000, 0xffff0000, 0x00010001,
      0xffff0000, 0x00010000, 0xffff0000, 0x00008001, 0xffff0000, 0x00008000,
      0xffff0000, 0x00000002, 0xffff0000, 0x00000001, 0xffff0000, 0x00000000,
      0xfffeffff, 0xffffffff, 0xfffeffff, 0xfffffffe, 0xfffeffff, 0xffff8001,
      0xfffeffff, 0xffff8000, 0xfffeffff, 0xffff0001, 0xfffeffff, 0xffff0000,
      0xfffeffff, 0xff000001, 0xfffeffff, 0xff000000, 0xfffeffff, 0xa9cb1d25,
      0xfffeffff, 0x48892a0b, 0xfffeffff, 0x00000001, 0xfffeffff, 0x00000000,
      0xfffe0000, 0x00000001, 0xfffe0000, 0x00000000, 0xffef0000, 0x00000001,
      0xffef0000, 0x00000000, 0xa9ca1d24, 0x48892a0b, 0x7fff0000, 0x00000001,
      0x7ffffffe, 0xffffffff, 0x48892a09, 0xa9cb1d24, 0x000fffff, 0x00000000,
      0x000ffffe, 0xffffffff, 0x0000ffff, 0x00000000, 0x0000fffe, 0xffffffff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0x01000000,
      0xffffffff, 0x00ffffff, 0xffffffff, 0x00010000, 0xffffffff, 0x0000ffff,
      0xffffffff, 0x00008000, 0xffffffff, 0x00007fff, 0xffffffff, 0x00000001,
      0xffffffff, 0x00000000, 0xfffffffe, 0xffffffff, 0xfffffffe, 0xfffffffe,
      0xfffffffe, 0xfffffffd, 0xfffffffe, 0xffff8000, 0xfffffffe, 0xffff7fff,
      0xfffffffe, 0xffff0000, 0xfffffffe, 0xfffeffff, 0xfffffffe, 0xff000000,
      0xfffffffe, 0xfeffffff, 0xfffffffe, 0xa9cb1d24, 0xfffffffe, 0x48892a0a,
      0xfffffffe, 0x00000000, 0xfffffffd, 0xffffffff, 0xfffeffff, 0x00000000,
      0xfffefffe, 0xffffffff, 0xffefffff, 0x00000000, 0xffeffffe, 0xffffffff,
      0xa9cb1d23, 0x48892a0a, 0x7fffffff, 0x00000000, 0x7fffffff, 0x00000000,
      0x48892a09, 0xa9cb1d25, 0x000fffff, 0x00000001, 0x000fffff, 0x00000000,
      0x0000ffff, 0x00000001, 0x0000ffff, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0x01000001, 0xffffffff, 0x01000000,
      0xffffffff, 0x00010001, 0xffffffff, 0x00010000, 0xffffffff, 0x00008001,
      0xffffffff, 0x00008000, 0xffffffff, 0x00000002, 0xffffffff, 0x00000001,
      0xffffffff, 0x00000000, 0xfffffffe, 0xffffffff, 0xfffffffe, 0xfffffffe,
      0xfffffffe, 0xffff8001, 0xfffffffe, 0xffff8000, 0xfffffffe, 0xffff0001,
      0xfffffffe, 0xffff0000, 0xfffffffe, 0xff000001, 0xfffffffe, 0xff000000,
      0xfffffffe, 0xa9cb1d25, 0xfffffffe, 0x48892a0b, 0xfffffffe, 0x00000001,
      0xfffffffe, 0x00000000, 0xfffeffff, 0x00000001, 0xfffeffff, 0x00000000,
      0xffefffff, 0x00000001, 0xffefffff, 0x00000000, 0xa9cb1d23, 0x48892a0b,
      0x7fffffff, 0x00000001, 0x7fffffff, 0xfeffffff, 0x48892a0a, 0xa8cb1d24,
      0x000fffff, 0xff000000, 0x000fffff, 0xfeffffff, 0x0000ffff, 0xff000000,
      0x0000ffff, 0xfeffffff, 0x00000000, 0xff000000, 0x00000000, 0xfeffffff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xff010000,
      0xffffffff, 0xff00ffff, 0xffffffff, 0xff008000, 0xffffffff, 0xff007fff,
      0xffffffff, 0xff000001, 0xffffffff, 0xff000000, 0xffffffff, 0xfeffffff,
      0xffffffff, 0xfefffffe, 0xffffffff, 0xfefffffd, 0xffffffff, 0xfeff8000,
      0xffffffff, 0xfeff7fff, 0xffffffff, 0xfeff0000, 0xffffffff, 0xfefeffff,
      0xffffffff, 0xfe000000, 0xffffffff, 0xfdffffff, 0xffffffff, 0xa8cb1d24,
      0xffffffff, 0x47892a0a, 0xfffffffe, 0xff000000, 0xfffffffe, 0xfeffffff,
      0xfffeffff, 0xff000000, 0xfffeffff, 0xfeffffff, 0xffefffff, 0xff000000,
      0xffefffff, 0xfeffffff, 0xa9cb1d24, 0x47892a0a, 0x7fffffff, 0xff000000,
      0x7fffffff, 0xff000000, 0x48892a0a, 0xa8cb1d25, 0x000fffff, 0xff000001,
      0x000fffff, 0xff000000, 0x0000ffff, 0xff000001, 0x0000ffff, 0xff000000,
      0x00000000, 0xff000001, 0x00000000, 0xff000000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xff010001, 0xffffffff, 0xff010000,
      0xffffffff, 0xff008001, 0xffffffff, 0xff008000, 0xffffffff, 0xff000002,
      0xffffffff, 0xff000001, 0xffffffff, 0xff000000, 0xffffffff, 0xfeffffff,
      0xffffffff, 0xfefffffe, 0xffffffff, 0xfeff8001, 0xffffffff, 0xfeff8000,
      0xffffffff, 0xfeff0001, 0xffffffff, 0xfeff0000, 0xffffffff, 0xfe000001,
      0xffffffff, 0xfe000000, 0xffffffff, 0xa8cb1d25, 0xffffffff, 0x47892a0b,
      0xfffffffe, 0xff000001, 0xfffffffe, 0xff000000, 0xfffeffff, 0xff000001,
      0xfffeffff, 0xff000000, 0xffefffff, 0xff000001, 0xffefffff, 0xff000000,
      0xa9cb1d24, 0x47892a0b, 0x7fffffff, 0xff000001, 0x7fffffff, 0xfffeffff,
      0x48892a0a, 0xa9ca1d24, 0x000fffff, 0xffff0000, 0x000fffff, 0xfffeffff,
      0x0000ffff, 0xffff0000, 0x0000ffff, 0xfffeffff, 0x00000000, 0xffff0000,
      0x00000000, 0xfffeffff, 0x00000000, 0x00ff0000, 0x00000000, 0x00feffff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xffff8000,
      0xffffffff, 0xffff7fff, 0xffffffff, 0xffff0001, 0xffffffff, 0xffff0000,
      0xffffffff, 0xfffeffff, 0xffffffff, 0xfffefffe, 0xffffffff, 0xfffefffd,
      0xffffffff, 0xfffe8000, 0xffffffff, 0xfffe7fff, 0xffffffff, 0xfffe0000,
      0xffffffff, 0xfffdffff, 0xffffffff, 0xfeff0000, 0xffffffff, 0xfefeffff,
      0xffffffff, 0xa9ca1d24, 0xffffffff, 0x48882a0a, 0xfffffffe, 0xffff0000,
      0xfffffffe, 0xfffeffff, 0xfffeffff, 0xffff0000, 0xfffeffff, 0xfffeffff,
      0xffefffff, 0xffff0000, 0xffefffff, 0xfffeffff, 0xa9cb1d24, 0x48882a0a,
      0x7fffffff, 0xffff0000, 0x7fffffff, 0xffff0000, 0x48892a0a, 0xa9ca1d25,
      0x000fffff, 0xffff0001, 0x000fffff, 0xffff0000, 0x0000ffff, 0xffff0001,
      0x0000ffff, 0xffff0000, 0x00000000, 0xffff0001, 0x00000000, 0xffff0000,
      0x00000000, 0x00ff0001, 0x00000000, 0x00ff0000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xffff8001, 0xffffffff, 0xffff8000,
      0xffffffff, 0xffff0002, 0xffffffff, 0xffff0001, 0xffffffff, 0xffff0000,
      0xffffffff, 0xfffeffff, 0xffffffff, 0xfffefffe, 0xffffffff, 0xfffe8001,
      0xffffffff, 0xfffe8000, 0xffffffff, 0xfffe0001, 0xffffffff, 0xfffe0000,
      0xffffffff, 0xfeff0001, 0xffffffff, 0xfeff0000, 0xffffffff, 0xa9ca1d25,
      0xffffffff, 0x48882a0b, 0xfffffffe, 0xffff0001, 0xfffffffe, 0xffff0000,
      0xfffeffff, 0xffff0001, 0xfffeffff, 0xffff0000, 0xffefffff, 0xffff0001,
      0xffefffff, 0xffff0000, 0xa9cb1d24, 0x48882a0b, 0x7fffffff, 0xffff0001,
      0x7fffffff, 0xffff7fff, 0x48892a0a, 0xa9ca9d24, 0x000fffff, 0xffff8000,
      0x000fffff, 0xffff7fff, 0x0000ffff, 0xffff8000, 0x0000ffff, 0xffff7fff,
      0x00000000, 0xffff8000, 0x00000000, 0xffff7fff, 0x00000000, 0x00ff8000,
      0x00000000, 0x00ff7fff, 0x00000000, 0x00008000, 0x00000000, 0x00007fff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xffff8001,
      0xffffffff, 0xffff8000, 0xffffffff, 0xffff7fff, 0xffffffff, 0xffff7ffe,
      0xffffffff, 0xffff7ffd, 0xffffffff, 0xffff0000, 0xffffffff, 0xfffeffff,
      0xffffffff, 0xfffe8000, 0xffffffff, 0xfffe7fff, 0xffffffff, 0xfeff8000,
      0xffffffff, 0xfeff7fff, 0xffffffff, 0xa9ca9d24, 0xffffffff, 0x4888aa0a,
      0xfffffffe, 0xffff8000, 0xfffffffe, 0xffff7fff, 0xfffeffff, 0xffff8000,
      0xfffeffff, 0xffff7fff, 0xffefffff, 0xffff8000, 0xffefffff, 0xffff7fff,
      0xa9cb1d24, 0x4888aa0a, 0x7fffffff, 0xffff8000, 0x7fffffff, 0xffff8000,
      0x48892a0a, 0xa9ca9d25, 0x000fffff, 0xffff8001, 0x000fffff, 0xffff8000,
      0x0000ffff, 0xffff8001, 0x0000ffff, 0xffff8000, 0x00000000, 0xffff8001,
      0x00000000, 0xffff8000, 0x00000000, 0x00ff8001, 0x00000000, 0x00ff8000,
      0x00000000, 0x00008001, 0x00000000, 0x00008000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xffff8002, 0xffffffff, 0xffff8001,
      0xffffffff, 0xffff8000, 0xffffffff, 0xffff7fff, 0xffffffff, 0xffff7ffe,
      0xffffffff, 0xffff0001, 0xffffffff, 0xffff0000, 0xffffffff, 0xfffe8001,
      0xffffffff, 0xfffe8000, 0xffffffff, 0xfeff8001, 0xffffffff, 0xfeff8000,
      0xffffffff, 0xa9ca9d25, 0xffffffff, 0x4888aa0b, 0xfffffffe, 0xffff8001,
      0xfffffffe, 0xffff8000, 0xfffeffff, 0xffff8001, 0xfffeffff, 0xffff8000,
      0xffefffff, 0xffff8001, 0xffefffff, 0xffff8000, 0xa9cb1d24, 0x4888aa0b,
      0x7fffffff, 0xffff8001, 0x7fffffff, 0xfffffffe, 0x48892a0a, 0xa9cb1d23,
      0x000fffff, 0xffffffff, 0x000fffff, 0xfffffffe, 0x0000ffff, 0xffffffff,
      0x0000ffff, 0xfffffffe, 0x00000000, 0xffffffff, 0x00000000, 0xfffffffe,
      0x00000000, 0x00ffffff, 0x00000000, 0x00fffffe, 0x00000000, 0x0000ffff,
      0x00000000, 0x0000fffe, 0x00000000, 0x00007fff, 0x00000000, 0x00007ffe,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xfffffffd, 0xffffffff, 0xfffffffc, 0xffffffff, 0xffff7fff,
      0xffffffff, 0xffff7ffe, 0xffffffff, 0xfffeffff, 0xffffffff, 0xfffefffe,
      0xffffffff, 0xfeffffff, 0xffffffff, 0xfefffffe, 0xffffffff, 0xa9cb1d23,
      0xffffffff, 0x48892a09, 0xfffffffe, 0xffffffff, 0xfffffffe, 0xfffffffe,
      0xfffeffff, 0xffffffff, 0xfffeffff, 0xfffffffe, 0xffefffff, 0xffffffff,
      0xffefffff, 0xfffffffe, 0xa9cb1d24, 0x48892a09, 0x7fffffff, 0xffffffff,
      0x7fffffff, 0xffffffff, 0x48892a0a, 0xa9cb1d24, 0x00100000, 0x00000000,
      0x000fffff, 0xffffffff, 0x00010000, 0x00000000, 0x0000ffff, 0xffffffff,
      0x00000001, 0x00000000, 0x00000000, 0xffffffff, 0x00000000, 0x01000000,
      0x00000000, 0x00ffffff, 0x00000000, 0x00010000, 0x00000000, 0x0000ffff,
      0x00000000, 0x00008000, 0x00000000, 0x00007fff, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xfffffffd, 0xffffffff, 0xffff8000, 0xffffffff, 0xffff7fff,
      0xffffffff, 0xffff0000, 0xffffffff, 0xfffeffff, 0xffffffff, 0xff000000,
      0xffffffff, 0xfeffffff, 0xffffffff, 0xa9cb1d24, 0xffffffff, 0x48892a0a,
      0xffffffff, 0x00000000, 0xfffffffe, 0xffffffff, 0xffff0000, 0x00000000,
      0xfffeffff, 0xffffffff, 0xfff00000, 0x00000000, 0xffefffff, 0xffffffff,
      0xa9cb1d24, 0x48892a0a, 0x80000000, 0x00000000, 0x80000000, 0x00000000,
      0x48892a0a, 0xa9cb1d25, 0x00100000, 0x00000001, 0x00100000, 0x00000000,
      0x00010000, 0x00000001, 0x00010000, 0x00000000, 0x00000001, 0x00000001,
      0x00000001, 0x00000000, 0x00000000, 0x01000001, 0x00000000, 0x01000000,
      0x00000000, 0x00010001, 0x00000000, 0x00010000, 0x00000000, 0x00008001,
      0x00000000, 0x00008000, 0x00000000, 0x00000002, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xffff8001, 0xffffffff, 0xffff8000, 0xffffffff, 0xffff0001,
      0xffffffff, 0xffff0000, 0xffffffff, 0xff000001, 0xffffffff, 0xff000000,
      0xffffffff, 0xa9cb1d25, 0xffffffff, 0x48892a0b, 0xffffffff, 0x00000001,
      0xffffffff, 0x00000000, 0xffff0000, 0x00000001, 0xffff0000, 0x00000000,
      0xfff00000, 0x00000001, 0xfff00000, 0x00000000, 0xa9cb1d24, 0x48892a0b,
      0x80000000, 0x00000001, 0x80000000, 0x00000001, 0x48892a0a, 0xa9cb1d26,
      0x00100000, 0x00000002, 0x00100000, 0x00000001, 0x00010000, 0x00000002,
      0x00010000, 0x00000001, 0x00000001, 0x00000002, 0x00000001, 0x00000001,
      0x00000000, 0x01000002, 0x00000000, 0x01000001, 0x00000000, 0x00010002,
      0x00000000, 0x00010001, 0x00000000, 0x00008002, 0x00000000, 0x00008001,
      0x00000000, 0x00000003, 0x00000000, 0x00000002, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xffff8002,
      0xffffffff, 0xffff8001, 0xffffffff, 0xffff0002, 0xffffffff, 0xffff0001,
      0xffffffff, 0xff000002, 0xffffffff, 0xff000001, 0xffffffff, 0xa9cb1d26,
      0xffffffff, 0x48892a0c, 0xffffffff, 0x00000002, 0xffffffff, 0x00000001,
      0xffff0000, 0x00000002, 0xffff0000, 0x00000001, 0xfff00000, 0x00000002,
      0xfff00000, 0x00000001, 0xa9cb1d24, 0x48892a0c, 0x80000000, 0x00000002,
      0x80000000, 0x00000002, 0x48892a0a, 0xa9cb1d27, 0x00100000, 0x00000003,
      0x00100000, 0x00000002, 0x00010000, 0x00000003, 0x00010000, 0x00000002,
      0x00000001, 0x00000003, 0x00000001, 0x00000002, 0x00000000, 0x01000003,
      0x00000000, 0x01000002, 0x00000000, 0x00010003, 0x00000000, 0x00010002,
      0x00000000, 0x00008003, 0x00000000, 0x00008002, 0x00000000, 0x00000004,
      0x00000000, 0x00000003, 0x00000000, 0x00000002, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xffff8003, 0xffffffff, 0xffff8002,
      0xffffffff, 0xffff0003, 0xffffffff, 0xffff0002, 0xffffffff, 0xff000003,
      0xffffffff, 0xff000002, 0xffffffff, 0xa9cb1d27, 0xffffffff, 0x48892a0d,
      0xffffffff, 0x00000003, 0xffffffff, 0x00000002, 0xffff0000, 0x00000003,
      0xffff0000, 0x00000002, 0xfff00000, 0x00000003, 0xfff00000, 0x00000002,
      0xa9cb1d24, 0x48892a0d, 0x80000000, 0x00000003, 0x80000000, 0x00007fff,
      0x48892a0a, 0xa9cb9d24, 0x00100000, 0x00008000, 0x00100000, 0x00007fff,
      0x00010000, 0x00008000, 0x00010000, 0x00007fff, 0x00000001, 0x00008000,
      0x00000001, 0x00007fff, 0x00000000, 0x01008000, 0x00000000, 0x01007fff,
      0x00000000, 0x00018000, 0x00000000, 0x00017fff, 0x00000000, 0x00010000,
      0x00000000, 0x0000ffff, 0x00000000, 0x00008001, 0x00000000, 0x00008000,
      0x00000000, 0x00007fff, 0x00000000, 0x00007ffe, 0x00000000, 0x00007ffd,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xffff8000,
      0xffffffff, 0xffff7fff, 0xffffffff, 0xff008000, 0xffffffff, 0xff007fff,
      0xffffffff, 0xa9cb9d24, 0xffffffff, 0x4889aa0a, 0xffffffff, 0x00008000,
      0xffffffff, 0x00007fff, 0xffff0000, 0x00008000, 0xffff0000, 0x00007fff,
      0xfff00000, 0x00008000, 0xfff00000, 0x00007fff, 0xa9cb1d24, 0x4889aa0a,
      0x80000000, 0x00008000, 0x80000000, 0x00008000, 0x48892a0a, 0xa9cb9d25,
      0x00100000, 0x00008001, 0x00100000, 0x00008000, 0x00010000, 0x00008001,
      0x00010000, 0x00008000, 0x00000001, 0x00008001, 0x00000001, 0x00008000,
      0x00000000, 0x01008001, 0x00000000, 0x01008000, 0x00000000, 0x00018001,
      0x00000000, 0x00018000, 0x00000000, 0x00010001, 0x00000000, 0x00010000,
      0x00000000, 0x00008002, 0x00000000, 0x00008001, 0x00000000, 0x00008000,
      0x00000000, 0x00007fff, 0x00000000, 0x00007ffe, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xffff8001, 0xffffffff, 0xffff8000,
      0xffffffff, 0xff008001, 0xffffffff, 0xff008000, 0xffffffff, 0xa9cb9d25,
      0xffffffff, 0x4889aa0b, 0xffffffff, 0x00008001, 0xffffffff, 0x00008000,
      0xffff0000, 0x00008001, 0xffff0000, 0x00008000, 0xfff00000, 0x00008001,
      0xfff00000, 0x00008000, 0xa9cb1d24, 0x4889aa0b, 0x80000000, 0x00008001,
      0x80000000, 0x0000ffff, 0x48892a0a, 0xa9cc1d24, 0x00100000, 0x00010000,
      0x00100000, 0x0000ffff, 0x00010000, 0x00010000, 0x00010000, 0x0000ffff,
      0x00000001, 0x00010000, 0x00000001, 0x0000ffff, 0x00000000, 0x01010000,
      0x00000000, 0x0100ffff, 0x00000000, 0x00020000, 0x00000000, 0x0001ffff,
      0x00000000, 0x00018000, 0x00000000, 0x00017fff, 0x00000000, 0x00010001,
      0x00000000, 0x00010000, 0x00000000, 0x0000ffff, 0x00000000, 0x0000fffe,
      0x00000000, 0x0000fffd, 0x00000000, 0x00008000, 0x00000000, 0x00007fff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xff010000,
      0xffffffff, 0xff00ffff, 0xffffffff, 0xa9cc1d24, 0xffffffff, 0x488a2a0a,
      0xffffffff, 0x00010000, 0xffffffff, 0x0000ffff, 0xffff0000, 0x00010000,
      0xffff0000, 0x0000ffff, 0xfff00000, 0x00010000, 0xfff00000, 0x0000ffff,
      0xa9cb1d24, 0x488a2a0a, 0x80000000, 0x00010000, 0x80000000, 0x00010000,
      0x48892a0a, 0xa9cc1d25, 0x00100000, 0x00010001, 0x00100000, 0x00010000,
      0x00010000, 0x00010001, 0x00010000, 0x00010000, 0x00000001, 0x00010001,
      0x00000001, 0x00010000, 0x00000000, 0x01010001, 0x00000000, 0x01010000,
      0x00000000, 0x00020001, 0x00000000, 0x00020000, 0x00000000, 0x00018001,
      0x00000000, 0x00018000, 0x00000000, 0x00010002, 0x00000000, 0x00010001,
      0x00000000, 0x00010000, 0x00000000, 0x0000ffff, 0x00000000, 0x0000fffe,
      0x00000000, 0x00008001, 0x00000000, 0x00008000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xff010001, 0xffffffff, 0xff010000,
      0xffffffff, 0xa9cc1d25, 0xffffffff, 0x488a2a0b, 0xffffffff, 0x00010001,
      0xffffffff, 0x00010000, 0xffff0000, 0x00010001, 0xffff0000, 0x00010000,
      0xfff00000, 0x00010001, 0xfff00000, 0x00010000, 0xa9cb1d24, 0x488a2a0b,
      0x80000000, 0x00010001, 0x80000000, 0x00ffffff, 0x48892a0a, 0xaacb1d24,
      0x00100000, 0x01000000, 0x00100000, 0x00ffffff, 0x00010000, 0x01000000,
      0x00010000, 0x00ffffff, 0x00000001, 0x01000000, 0x00000001, 0x00ffffff,
      0x00000000, 0x02000000, 0x00000000, 0x01ffffff, 0x00000000, 0x01010000,
      0x00000000, 0x0100ffff, 0x00000000, 0x01008000, 0x00000000, 0x01007fff,
      0x00000000, 0x01000001, 0x00000000, 0x01000000, 0x00000000, 0x00ffffff,
      0x00000000, 0x00fffffe, 0x00000000, 0x00fffffd, 0x00000000, 0x00ff8000,
      0x00000000, 0x00ff7fff, 0x00000000, 0x00ff0000, 0x00000000, 0x00feffff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xaacb1d24,
      0xffffffff, 0x49892a0a, 0xffffffff, 0x01000000, 0xffffffff, 0x00ffffff,
      0xffff0000, 0x01000000, 0xffff0000, 0x00ffffff, 0xfff00000, 0x01000000,
      0xfff00000, 0x00ffffff, 0xa9cb1d24, 0x49892a0a, 0x80000000, 0x01000000,
      0x80000000, 0x01000000, 0x48892a0a, 0xaacb1d25, 0x00100000, 0x01000001,
      0x00100000, 0x01000000, 0x00010000, 0x01000001, 0x00010000, 0x01000000,
      0x00000001, 0x01000001, 0x00000001, 0x01000000, 0x00000000, 0x02000001,
      0x00000000, 0x02000000, 0x00000000, 0x01010001, 0x00000000, 0x01010000,
      0x00000000, 0x01008001, 0x00000000, 0x01008000, 0x00000000, 0x01000002,
      0x00000000, 0x01000001, 0x00000000, 0x01000000, 0x00000000, 0x00ffffff,
      0x00000000, 0x00fffffe, 0x00000000, 0x00ff8001, 0x00000000, 0x00ff8000,
      0x00000000, 0x00ff0001, 0x00000000, 0x00ff0000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xaacb1d25, 0xffffffff, 0x49892a0b,
      0xffffffff, 0x01000001, 0xffffffff, 0x01000000, 0xffff0000, 0x01000001,
      0xffff0000, 0x01000000, 0xfff00000, 0x01000001, 0xfff00000, 0x01000000,
      0xa9cb1d24, 0x49892a0b, 0x80000000, 0x01000001, 0x80000000, 0x5634e2db,
      0x48892a0b, 0x00000000, 0x00100000, 0x5634e2dc, 0x00100000, 0x5634e2db,
      0x00010000, 0x5634e2dc, 0x00010000, 0x5634e2db, 0x00000001, 0x5634e2dc,
      0x00000001, 0x5634e2db, 0x00000000, 0x5734e2dc, 0x00000000, 0x5734e2db,
      0x00000000, 0x5635e2dc, 0x00000000, 0x5635e2db, 0x00000000, 0x563562dc,
      0x00000000, 0x563562db, 0x00000000, 0x5634e2dd, 0x00000000, 0x5634e2dc,
      0x00000000, 0x5634e2db, 0x00000000, 0x5634e2da, 0x00000000, 0x5634e2d9,
      0x00000000, 0x563462dc, 0x00000000, 0x563462db, 0x00000000, 0x5633e2dc,
      0x00000000, 0x5633e2db, 0x00000000, 0x5534e2dc, 0x00000000, 0x5534e2db,
      0x00000000, 0x00000000, 0xffffffff, 0x9ebe0ce6, 0xffffffff, 0x5634e2dc,
      0xffffffff, 0x5634e2db, 0xffff0000, 0x5634e2dc, 0xffff0000, 0x5634e2db,
      0xfff00000, 0x5634e2dc, 0xfff00000, 0x5634e2db, 0xa9cb1d24, 0x9ebe0ce6,
      0x80000000, 0x5634e2dc, 0x80000000, 0xb776d5f5, 0x48892a0b, 0x6141f31a,
      0x00100000, 0xb776d5f6, 0x00100000, 0xb776d5f5, 0x00010000, 0xb776d5f6,
      0x00010000, 0xb776d5f5, 0x00000001, 0xb776d5f6, 0x00000001, 0xb776d5f5,
      0x00000000, 0xb876d5f6, 0x00000000, 0xb876d5f5, 0x00000000, 0xb777d5f6,
      0x00000000, 0xb777d5f5, 0x00000000, 0xb77755f6, 0x00000000, 0xb77755f5,
      0x00000000, 0xb776d5f7, 0x00000000, 0xb776d5f6, 0x00000000, 0xb776d5f5,
      0x00000000, 0xb776d5f4, 0x00000000, 0xb776d5f3, 0x00000000, 0xb77655f6,
      0x00000000, 0xb77655f5, 0x00000000, 0xb775d5f6, 0x00000000, 0xb775d5f5,
      0x00000000, 0xb676d5f6, 0x00000000, 0xb676d5f5, 0x00000000, 0x6141f31a,
      0x00000000, 0x00000000, 0xffffffff, 0xb776d5f6, 0xffffffff, 0xb776d5f5,
      0xffff0000, 0xb776d5f6, 0xffff0000, 0xb776d5f5, 0xfff00000, 0xb776d5f6,
      0xfff00000, 0xb776d5f5, 0xa9cb1d25, 0x00000000, 0x80000000, 0xb776d5f6,
      0x80000000, 0xffffffff, 0x48892a0b, 0xa9cb1d24, 0x00100001, 0x00000000,
      0x00100000, 0xffffffff, 0x00010001, 0x00000000, 0x00010000, 0xffffffff,
      0x00000002, 0x00000000, 0x00000001, 0xffffffff, 0x00000001, 0x01000000,
      0x00000001, 0x00ffffff, 0x00000001, 0x00010000, 0x00000001, 0x0000ffff,
      0x00000001, 0x00008000, 0x00000001, 0x00007fff, 0x00000001, 0x00000001,
      0x00000001, 0x00000000, 0x00000000, 0xffffffff, 0x00000000, 0xfffffffe,
      0x00000000, 0xfffffffd, 0x00000000, 0xffff8000, 0x00000000, 0xffff7fff,
      0x00000000, 0xffff0000, 0x00000000, 0xfffeffff, 0x00000000, 0xff000000,
      0x00000000, 0xfeffffff, 0x00000000, 0xa9cb1d24, 0x00000000, 0x48892a0a,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffff0001, 0x00000000,
      0xffff0000, 0xffffffff, 0xfff00001, 0x00000000, 0xfff00000, 0xffffffff,
      0xa9cb1d25, 0x48892a0a, 0x80000001, 0x00000000, 0x80000001, 0x00000000,
      0x48892a0b, 0xa9cb1d25, 0x00100001, 0x00000001, 0x00100001, 0x00000000,
      0x00010001, 0x00000001, 0x00010001, 0x00000000, 0x00000002, 0x00000001,
      0x00000002, 0x00000000, 0x00000001, 0x01000001, 0x00000001, 0x01000000,
      0x00000001, 0x00010001, 0x00000001, 0x00010000, 0x00000001, 0x00008001,
      0x00000001, 0x00008000, 0x00000001, 0x00000002, 0x00000001, 0x00000001,
      0x00000001, 0x00000000, 0x00000000, 0xffffffff, 0x00000000, 0xfffffffe,
      0x00000000, 0xffff8001, 0x00000000, 0xffff8000, 0x00000000, 0xffff0001,
      0x00000000, 0xffff0000, 0x00000000, 0xff000001, 0x00000000, 0xff000000,
      0x00000000, 0xa9cb1d25, 0x00000000, 0x48892a0b, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffff0001, 0x00000001, 0xffff0001, 0x00000000,
      0xfff00001, 0x00000001, 0xfff00001, 0x00000000, 0xa9cb1d25, 0x48892a0b,
      0x80000001, 0x00000001, 0x8000ffff, 0xffffffff, 0x488a2a0a, 0xa9cb1d24,
      0x00110000, 0x00000000, 0x0010ffff, 0xffffffff, 0x00020000, 0x00000000,
      0x0001ffff, 0xffffffff, 0x00010001, 0x00000000, 0x00010000, 0xffffffff,
      0x00010000, 0x01000000, 0x00010000, 0x00ffffff, 0x00010000, 0x00010000,
      0x00010000, 0x0000ffff, 0x00010000, 0x00008000, 0x00010000, 0x00007fff,
      0x00010000, 0x00000001, 0x00010000, 0x00000000, 0x0000ffff, 0xffffffff,
      0x0000ffff, 0xfffffffe, 0x0000ffff, 0xfffffffd, 0x0000ffff, 0xffff8000,
      0x0000ffff, 0xffff7fff, 0x0000ffff, 0xffff0000, 0x0000ffff, 0xfffeffff,
      0x0000ffff, 0xff000000, 0x0000ffff, 0xfeffffff, 0x0000ffff, 0xa9cb1d24,
      0x0000ffff, 0x48892a0a, 0x0000ffff, 0x00000000, 0x0000fffe, 0xffffffff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xfff10000, 0x00000000,
      0xfff0ffff, 0xffffffff, 0xa9cc1d24, 0x48892a0a, 0x80010000, 0x00000000,
      0x80010000, 0x00000000, 0x488a2a0a, 0xa9cb1d25, 0x00110000, 0x00000001,
      0x00110000, 0x00000000, 0x00020000, 0x00000001, 0x00020000, 0x00000000,
      0x00010001, 0x00000001, 0x00010001, 0x00000000, 0x00010000, 0x01000001,
      0x00010000, 0x01000000, 0x00010000, 0x00010001, 0x00010000, 0x00010000,
      0x00010000, 0x00008001, 0x00010000, 0x00008000, 0x00010000, 0x00000002,
      0x00010000, 0x00000001, 0x00010000, 0x00000000, 0x0000ffff, 0xffffffff,
      0x0000ffff, 0xfffffffe, 0x0000ffff, 0xffff8001, 0x0000ffff, 0xffff8000,
      0x0000ffff, 0xffff0001, 0x0000ffff, 0xffff0000, 0x0000ffff, 0xff000001,
      0x0000ffff, 0xff000000, 0x0000ffff, 0xa9cb1d25, 0x0000ffff, 0x48892a0b,
      0x0000ffff, 0x00000001, 0x0000ffff, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xfff10000, 0x00000001, 0xfff10000, 0x00000000,
      0xa9cc1d24, 0x48892a0b, 0x80010000, 0x00000001, 0x800fffff, 0xffffffff,
      0x48992a0a, 0xa9cb1d24, 0x00200000, 0x00000000, 0x001fffff, 0xffffffff,
      0x00110000, 0x00000000, 0x0010ffff, 0xffffffff, 0x00100001, 0x00000000,
      0x00100000, 0xffffffff, 0x00100000, 0x01000000, 0x00100000, 0x00ffffff,
      0x00100000, 0x00010000, 0x00100000, 0x0000ffff, 0x00100000, 0x00008000,
      0x00100000, 0x00007fff, 0x00100000, 0x00000001, 0x00100000, 0x00000000,
      0x000fffff, 0xffffffff, 0x000fffff, 0xfffffffe, 0x000fffff, 0xfffffffd,
      0x000fffff, 0xffff8000, 0x000fffff, 0xffff7fff, 0x000fffff, 0xffff0000,
      0x000fffff, 0xfffeffff, 0x000fffff, 0xff000000, 0x000fffff, 0xfeffffff,
      0x000fffff, 0xa9cb1d24, 0x000fffff, 0x48892a0a, 0x000fffff, 0x00000000,
      0x000ffffe, 0xffffffff, 0x000f0000, 0x00000000, 0x000effff, 0xffffffff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xa9db1d24, 0x48892a0a,
      0x80100000, 0x00000000, 0x80100000, 0x00000000, 0x48992a0a, 0xa9cb1d25,
      0x00200000, 0x00000001, 0x00200000, 0x00000000, 0x00110000, 0x00000001,
      0x00110000, 0x00000000, 0x00100001, 0x00000001, 0x00100001, 0x00000000,
      0x00100000, 0x01000001, 0x00100000, 0x01000000, 0x00100000, 0x00010001,
      0x00100000, 0x00010000, 0x00100000, 0x00008001, 0x00100000, 0x00008000,
      0x00100000, 0x00000002, 0x00100000, 0x00000001, 0x00100000, 0x00000000,
      0x000fffff, 0xffffffff, 0x000fffff, 0xfffffffe, 0x000fffff, 0xffff8001,
      0x000fffff, 0xffff8000, 0x000fffff, 0xffff0001, 0x000fffff, 0xffff0000,
      0x000fffff, 0xff000001, 0x000fffff, 0xff000000, 0x000fffff, 0xa9cb1d25,
      0x000fffff, 0x48892a0b, 0x000fffff, 0x00000001, 0x000fffff, 0x00000000,
      0x000f0000, 0x00000001, 0x000f0000, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xa9db1d24, 0x48892a0b, 0x80100000, 0x00000001,
      0xd634e2db, 0xb776d5f5, 0x9ebe0ce6, 0x6141f31a, 0x5644e2db, 0xb776d5f6,
      0x5644e2db, 0xb776d5f5, 0x5635e2db, 0xb776d5f6, 0x5635e2db, 0xb776d5f5,
      0x5634e2dc, 0xb776d5f6, 0x5634e2dc, 0xb776d5f5, 0x5634e2db, 0xb876d5f6,
      0x5634e2db, 0xb876d5f5, 0x5634e2db, 0xb777d5f6, 0x5634e2db, 0xb777d5f5,
      0x5634e2db, 0xb77755f6, 0x5634e2db, 0xb77755f5, 0x5634e2db, 0xb776d5f7,
      0x5634e2db, 0xb776d5f6, 0x5634e2db, 0xb776d5f5, 0x5634e2db, 0xb776d5f4,
      0x5634e2db, 0xb776d5f3, 0x5634e2db, 0xb77655f6, 0x5634e2db, 0xb77655f5,
      0x5634e2db, 0xb775d5f6, 0x5634e2db, 0xb775d5f5, 0x5634e2db, 0xb676d5f6,
      0x5634e2db, 0xb676d5f5, 0x5634e2db, 0x6141f31a, 0x5634e2db, 0x00000000,
      0x5634e2da, 0xb776d5f6, 0x5634e2da, 0xb776d5f5, 0x5633e2db, 0xb776d5f6,
      0x5633e2db, 0xb776d5f5, 0x5624e2db, 0xb776d5f6, 0x5624e2db, 0xb776d5f5,
      0x00000000, 0x00000000, 0xd634e2db, 0xb776d5f6, 0xffffffff, 0xffffffff,
      0xc8892a0a, 0xa9cb1d24, 0x80100000, 0x00000000, 0x800fffff, 0xffffffff,
      0x80010000, 0x00000000, 0x8000ffff, 0xffffffff, 0x80000001, 0x00000000,
      0x80000000, 0xffffffff, 0x80000000, 0x01000000, 0x80000000, 0x00ffffff,
      0x80000000, 0x00010000, 0x80000000, 0x0000ffff, 0x80000000, 0x00008000,
      0x80000000, 0x00007fff, 0x80000000, 0x00000001, 0x80000000, 0x00000000,
      0x7fffffff, 0xffffffff, 0x7fffffff, 0xfffffffe, 0x7fffffff, 0xfffffffd,
      0x7fffffff, 0xffff8000, 0x7fffffff, 0xffff7fff, 0x7fffffff, 0xffff0000,
      0x7fffffff, 0xfffeffff, 0x7fffffff, 0xff000000, 0x7fffffff, 0xfeffffff,
      0x7fffffff, 0xa9cb1d24, 0x7fffffff, 0x48892a0a, 0x7fffffff, 0x00000000,
      0x7ffffffe, 0xffffffff, 0x7fff0000, 0x00000000, 0x7ffeffff, 0xffffffff,
      0x7ff00000, 0x00000000, 0x7fefffff, 0xffffffff, 0x29cb1d24, 0x48892a0a,
      0x00000000, 0x00000000
    ];
toInt32s(TEST_SUB_BITS);

var TEST_MUL_BITS = [
      0x80000000, 0x00000000, 0x80000000, 0x00000000, 0x1ad92a0a, 0xa9cb1d25,
      0x00000000, 0x00000000, 0xd2500000, 0x00000000, 0x00100000, 0x00000000,
      0x80000000, 0x00000000, 0x65ae2a0a, 0xa9cb1d25, 0x00110000, 0x00000001,
      0x00100000, 0x00000000, 0x00000000, 0x00000000, 0x1d250000, 0x00000000,
      0x00010000, 0x00000000, 0x00000000, 0x00000000, 0x00010000, 0x00000000,
      0x80000000, 0x00000000, 0xf254472f, 0xa9cb1d25, 0x00100001, 0x00000001,
      0x00100000, 0x00000000, 0x00010001, 0x00000001, 0x00010000, 0x00000000,
      0x00000000, 0x00000000, 0xa9cb1d25, 0x00000000, 0x00000001, 0x00000000,
      0x00000000, 0x00000000, 0x00000001, 0x00000000, 0x00000000, 0x00000000,
      0x00000001, 0x00000000, 0x80000000, 0x00000000, 0x5332f527, 0xcecb1d25,
      0x00100000, 0x01000001, 0x00100000, 0x00000000, 0x00010000, 0x01000001,
      0x00010000, 0x00000000, 0x01000001, 0x01000001, 0x01000001, 0x00000000,
      0x00000000, 0x00000000, 0x0aa9cb1d, 0x25000000, 0x00000000, 0x01000000,
      0x00000000, 0x00000000, 0x00000000, 0x01000000, 0x00000000, 0x00000000,
      0x01000000, 0x01000000, 0x01000000, 0x00000000, 0x00010000, 0x01000000,
      0x80000000, 0x00000000, 0x7293d3d5, 0xc6f01d25, 0x00100000, 0x00010001,
      0x00100000, 0x00000000, 0x00010000, 0x00010001, 0x00010000, 0x00000000,
      0x00010001, 0x00010001, 0x00010001, 0x00000000, 0x00000100, 0x01010001,
      0x00000100, 0x01000000, 0x00000000, 0x00000000, 0x2a0aa9cb, 0x1d250000,
      0x00000000, 0x00010000, 0x00000000, 0x00000000, 0x00000000, 0x00010000,
      0x00000000, 0x00000000, 0x00010000, 0x00010000, 0x00010000, 0x00000000,
      0x00000100, 0x00010000, 0x00000100, 0x00000000, 0x00000001, 0x00010000,
      0x80000000, 0x00000000, 0xdd8e7ef0, 0x385d9d25, 0x00100000, 0x00008001,
      0x00100000, 0x00000000, 0x80010000, 0x00008001, 0x80010000, 0x00000000,
      0x00008001, 0x00008001, 0x00008001, 0x00000000, 0x00000080, 0x01008001,
      0x00000080, 0x01000000, 0x00000000, 0x80018001, 0x00000000, 0x80010000,
      0x00000000, 0x00000000, 0x950554e5, 0x8e928000, 0x00000000, 0x00008000,
      0x00000000, 0x00000000, 0x80000000, 0x00008000, 0x80000000, 0x00000000,
      0x00008000, 0x00008000, 0x00008000, 0x00000000, 0x00000080, 0x00008000,
      0x00000080, 0x00000000, 0x00000000, 0x80008000, 0x00000000, 0x80000000,
      0x00000000, 0x40008000, 0x00000000, 0x00000000, 0x91125415, 0x53963a4a,
      0x00200000, 0x00000002, 0x00200000, 0x00000000, 0x00020000, 0x00000002,
      0x00020000, 0x00000000, 0x00000002, 0x00000002, 0x00000002, 0x00000000,
      0x00000000, 0x02000002, 0x00000000, 0x02000000, 0x00000000, 0x00020002,
      0x00000000, 0x00020000, 0x00000000, 0x00010002, 0x00000000, 0x00010000,
      0x80000000, 0x00000000, 0x48892a0a, 0xa9cb1d25, 0x00100000, 0x00000001,
      0x00100000, 0x00000000, 0x00010000, 0x00000001, 0x00010000, 0x00000000,
      0x00000001, 0x00000001, 0x00000001, 0x00000000, 0x00000000, 0x01000001,
      0x00000000, 0x01000000, 0x00000000, 0x00010001, 0x00000000, 0x00010000,
      0x00000000, 0x00008001, 0x00000000, 0x00008000, 0x00000000, 0x00000002,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x80000000, 0x00000000, 0xb776d5f5, 0x5634e2db,
      0xffefffff, 0xffffffff, 0xfff00000, 0x00000000, 0xfffeffff, 0xffffffff,
      0xffff0000, 0x00000000, 0xfffffffe, 0xffffffff, 0xffffffff, 0x00000000,
      0xffffffff, 0xfeffffff, 0xffffffff, 0xff000000, 0xffffffff, 0xfffeffff,
      0xffffffff, 0xffff0000, 0xffffffff, 0xffff7fff, 0xffffffff, 0xffff8000,
      0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x6eedabea, 0xac69c5b6, 0xffdfffff, 0xfffffffe,
      0xffe00000, 0x00000000, 0xfffdffff, 0xfffffffe, 0xfffe0000, 0x00000000,
      0xfffffffd, 0xfffffffe, 0xfffffffe, 0x00000000, 0xffffffff, 0xfdfffffe,
      0xffffffff, 0xfe000000, 0xffffffff, 0xfffdfffe, 0xffffffff, 0xfffe0000,
      0xffffffff, 0xfffefffe, 0xffffffff, 0xffff0000, 0xffffffff, 0xfffffffc,
      0xffffffff, 0xfffffffe, 0x00000000, 0x00000000, 0x00000000, 0x00000002,
      0x80000000, 0x00000000, 0xb383d525, 0x1b389d25, 0x000fffff, 0xffff8001,
      0x00100000, 0x00000000, 0x8000ffff, 0xffff8001, 0x80010000, 0x00000000,
      0xffff8000, 0xffff8001, 0xffff8001, 0x00000000, 0xffffff80, 0x00ff8001,
      0xffffff80, 0x01000000, 0xffffffff, 0x80008001, 0xffffffff, 0x80010000,
      0xffffffff, 0xc0000001, 0xffffffff, 0xc0008000, 0xffffffff, 0xffff0002,
      0xffffffff, 0xffff8001, 0x00000000, 0x00000000, 0x00000000, 0x00007fff,
      0x00000000, 0x0000fffe, 0x00000000, 0x00000000, 0x6afaab1a, 0x716d8000,
      0xffffffff, 0xffff8000, 0x00000000, 0x00000000, 0x7fffffff, 0xffff8000,
      0x80000000, 0x00000000, 0xffff7fff, 0xffff8000, 0xffff8000, 0x00000000,
      0xffffff7f, 0xffff8000, 0xffffff80, 0x00000000, 0xffffffff, 0x7fff8000,
      0xffffffff, 0x80000000, 0xffffffff, 0xbfff8000, 0xffffffff, 0xc0000000,
      0xffffffff, 0xffff0000, 0xffffffff, 0xffff8000, 0x00000000, 0x00000000,
      0x00000000, 0x00008000, 0x00000000, 0x00010000, 0x00000000, 0x3fff8000,
      0x80000000, 0x00000000, 0x1e7e803f, 0x8ca61d25, 0x000fffff, 0xffff0001,
      0x00100000, 0x00000000, 0x0000ffff, 0xffff0001, 0x00010000, 0x00000000,
      0xffff0000, 0xffff0001, 0xffff0001, 0x00000000, 0xffffff00, 0x00ff0001,
      0xffffff00, 0x01000000, 0xffffffff, 0x00000001, 0xffffffff, 0x00010000,
      0xffffffff, 0x7fff8001, 0xffffffff, 0x80008000, 0xffffffff, 0xfffe0002,
      0xffffffff, 0xffff0001, 0x00000000, 0x00000000, 0x00000000, 0x0000ffff,
      0x00000000, 0x0001fffe, 0x00000000, 0x7ffe8001, 0x00000000, 0x7fff8000,
      0x00000000, 0x00000000, 0xd5f55634, 0xe2db0000, 0xffffffff, 0xffff0000,
      0x00000000, 0x00000000, 0xffffffff, 0xffff0000, 0x00000000, 0x00000000,
      0xfffeffff, 0xffff0000, 0xffff0000, 0x00000000, 0xfffffeff, 0xffff0000,
      0xffffff00, 0x00000000, 0xfffffffe, 0xffff0000, 0xffffffff, 0x00000000,
      0xffffffff, 0x7fff0000, 0xffffffff, 0x80000000, 0xffffffff, 0xfffe0000,
      0xffffffff, 0xffff0000, 0x00000000, 0x00000000, 0x00000000, 0x00010000,
      0x00000000, 0x00020000, 0x00000000, 0x7fff0000, 0x00000000, 0x80000000,
      0x00000000, 0xffff0000, 0x80000000, 0x00000000, 0x3ddf5eed, 0x84cb1d25,
      0x000fffff, 0xff000001, 0x00100000, 0x00000000, 0x0000ffff, 0xff000001,
      0x00010000, 0x00000000, 0xff000000, 0xff000001, 0xff000001, 0x00000000,
      0xffff0000, 0x00000001, 0xffff0000, 0x01000000, 0xfffffeff, 0xff010001,
      0xffffff00, 0x00010000, 0xffffff7f, 0xff008001, 0xffffff80, 0x00008000,
      0xffffffff, 0xfe000002, 0xffffffff, 0xff000001, 0x00000000, 0x00000000,
      0x00000000, 0x00ffffff, 0x00000000, 0x01fffffe, 0x0000007f, 0xfeff8001,
      0x0000007f, 0xffff8000, 0x000000ff, 0xfeff0001, 0x000000ff, 0xffff0000,
      0x00000000, 0x00000000, 0xf55634e2, 0xdb000000, 0xffffffff, 0xff000000,
      0x00000000, 0x00000000, 0xffffffff, 0xff000000, 0x00000000, 0x00000000,
      0xfeffffff, 0xff000000, 0xff000000, 0x00000000, 0xfffeffff, 0xff000000,
      0xffff0000, 0x00000000, 0xfffffeff, 0xff000000, 0xffffff00, 0x00000000,
      0xffffff7f, 0xff000000, 0xffffff80, 0x00000000, 0xffffffff, 0xfe000000,
      0xffffffff, 0xff000000, 0x00000000, 0x00000000, 0x00000000, 0x01000000,
      0x00000000, 0x02000000, 0x0000007f, 0xff000000, 0x00000080, 0x00000000,
      0x000000ff, 0xff000000, 0x00000100, 0x00000000, 0x0000ffff, 0xff000000,
      0x80000000, 0x00000000, 0xbc56e5ef, 0x15ff6759, 0xd24fffff, 0xa9cb1d25,
      0xd2500000, 0x00000000, 0x1d24ffff, 0xa9cb1d25, 0x1d250000, 0x00000000,
      0xa9cb1d24, 0xa9cb1d25, 0xa9cb1d25, 0x00000000, 0xffa9cb1c, 0xcecb1d25,
      0xffa9cb1d, 0x25000000, 0xffffa9ca, 0xc6f01d25, 0xffffa9cb, 0x1d250000,
      0xffffd4e5, 0x385d9d25, 0xffffd4e5, 0x8e928000, 0xffffffff, 0x53963a4a,
      0xffffffff, 0xa9cb1d25, 0x00000000, 0x00000000, 0x00000000, 0x5634e2db,
      0x00000000, 0xac69c5b6, 0x00002b1a, 0x1b389d25, 0x00002b1a, 0x716d8000,
      0x00005634, 0x8ca61d25, 0x00005634, 0xe2db0000, 0x005634e2, 0x84cb1d25,
      0x005634e2, 0xdb000000, 0x80000000, 0x00000000, 0x74756f10, 0x9f4f5297,
      0xa0afffff, 0x48892a0b, 0xa0b00000, 0x00000000, 0x2a0affff, 0x48892a0b,
      0x2a0b0000, 0x00000000, 0x48892a0a, 0x48892a0b, 0x48892a0b, 0x00000000,
      0xff488929, 0x53892a0b, 0xff48892a, 0x0b000000, 0xffff4888, 0x72942a0b,
      0xffff4889, 0x2a0b0000, 0xffffa443, 0xdd8eaa0b, 0xffffa444, 0x95058000,
      0xfffffffe, 0x91125416, 0xffffffff, 0x48892a0b, 0x00000000, 0x00000000,
      0x00000000, 0xb776d5f5, 0x00000001, 0x6eedabea, 0x00005bba, 0xb383aa0b,
      0x00005bbb, 0x6afa8000, 0x0000b776, 0x1e7e2a0b, 0x0000b776, 0xd5f50000,
      0x00b776d5, 0x3d892a0b, 0x00b776d5, 0xf5000000, 0x3dc7d297, 0x9f4f5297,
      0x80000000, 0x00000000, 0x9ebe0ce5, 0xa9cb1d25, 0x000fffff, 0x00000001,
      0x00100000, 0x00000000, 0x0000ffff, 0x00000001, 0x00010000, 0x00000000,
      0x00000000, 0x00000001, 0x00000001, 0x00000000, 0xfeffffff, 0x01000001,
      0xff000000, 0x01000000, 0xfffeffff, 0x00010001, 0xffff0000, 0x00010000,
      0xffff7fff, 0x00008001, 0xffff8000, 0x00008000, 0xfffffffe, 0x00000002,
      0xffffffff, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0xffffffff,
      0x00000001, 0xfffffffe, 0x00007ffe, 0xffff8001, 0x00007fff, 0xffff8000,
      0x0000fffe, 0xffff0001, 0x0000ffff, 0xffff0000, 0x00fffffe, 0xff000001,
      0x00ffffff, 0xff000000, 0x5634e2da, 0xa9cb1d25, 0xb776d5f4, 0x48892a0b,
      0x00000000, 0x00000000, 0x5634e2db, 0x00000000, 0xffffffff, 0x00000000,
      0x00000000, 0x00000000, 0xffffffff, 0x00000000, 0x00000000, 0x00000000,
      0xffffffff, 0x00000000, 0x00000000, 0x00000000, 0xfeffffff, 0x00000000,
      0xff000000, 0x00000000, 0xfffeffff, 0x00000000, 0xffff0000, 0x00000000,
      0xffff7fff, 0x00000000, 0xffff8000, 0x00000000, 0xfffffffe, 0x00000000,
      0xffffffff, 0x00000000, 0x00000000, 0x00000000, 0x00000001, 0x00000000,
      0x00000002, 0x00000000, 0x00007fff, 0x00000000, 0x00008000, 0x00000000,
      0x0000ffff, 0x00000000, 0x00010000, 0x00000000, 0x00ffffff, 0x00000000,
      0x01000000, 0x00000000, 0x5634e2db, 0x00000000, 0xb776d5f5, 0x00000000,
      0xffffffff, 0x00000000, 0x80000000, 0x00000000, 0x2b642a0a, 0xa9cb1d25,
      0x000f0000, 0x00000001, 0x00100000, 0x00000000, 0x00000000, 0x00000001,
      0x00010000, 0x00000000, 0xffff0001, 0x00000001, 0x00000001, 0x00000000,
      0xffff0000, 0x01000001, 0x00000000, 0x01000000, 0xffff0000, 0x00010001,
      0x00000000, 0x00010000, 0x7fff0000, 0x00008001, 0x80000000, 0x00008000,
      0xfffe0000, 0x00000002, 0xffff0000, 0x00000001, 0x00000000, 0x00000000,
      0x0000ffff, 0xffffffff, 0x0001ffff, 0xfffffffe, 0x7ffeffff, 0xffff8001,
      0x7fffffff, 0xffff8000, 0xfffeffff, 0xffff0001, 0xffffffff, 0xffff0000,
      0xfffeffff, 0xff000001, 0xffffffff, 0xff000000, 0xe2daffff, 0xa9cb1d25,
      0xd5f4ffff, 0x48892a0b, 0xfffeffff, 0x00000001, 0xffffffff, 0x00000000,
      0x00000000, 0x00000000, 0xe2db0000, 0x00000000, 0xffff0000, 0x00000000,
      0x00000000, 0x00000000, 0xffff0000, 0x00000000, 0x00000000, 0x00000000,
      0xffff0000, 0x00000000, 0x00000000, 0x00000000, 0xffff0000, 0x00000000,
      0x00000000, 0x00000000, 0xffff0000, 0x00000000, 0x00000000, 0x00000000,
      0x7fff0000, 0x00000000, 0x80000000, 0x00000000, 0xfffe0000, 0x00000000,
      0xffff0000, 0x00000000, 0x00000000, 0x00000000, 0x00010000, 0x00000000,
      0x00020000, 0x00000000, 0x7fff0000, 0x00000000, 0x80000000, 0x00000000,
      0xffff0000, 0x00000000, 0x00000000, 0x00000000, 0xffff0000, 0x00000000,
      0x00000000, 0x00000000, 0xe2db0000, 0x00000000, 0xd5f50000, 0x00000000,
      0xffff0000, 0x00000000, 0x00000000, 0x00000000, 0xffff0000, 0x00000000,
      0x80000000, 0x00000000, 0x76392a0a, 0xa9cb1d25, 0x00000000, 0x00000001,
      0x00100000, 0x00000000, 0xfff10000, 0x00000001, 0x00010000, 0x00000000,
      0xfff00001, 0x00000001, 0x00000001, 0x00000000, 0xfff00000, 0x01000001,
      0x00000000, 0x01000000, 0xfff00000, 0x00010001, 0x00000000, 0x00010000,
      0xfff00000, 0x00008001, 0x00000000, 0x00008000, 0xffe00000, 0x00000002,
      0xfff00000, 0x00000001, 0x00000000, 0x00000000, 0x000fffff, 0xffffffff,
      0x001fffff, 0xfffffffe, 0xffefffff, 0xffff8001, 0xffffffff, 0xffff8000,
      0xffefffff, 0xffff0001, 0xffffffff, 0xffff0000, 0xffefffff, 0xff000001,
      0xffffffff, 0xff000000, 0x2dafffff, 0xa9cb1d25, 0x5f4fffff, 0x48892a0b,
      0xffefffff, 0x00000001, 0xffffffff, 0x00000000, 0xffef0000, 0x00000001,
      0xffff0000, 0x00000000, 0x00000000, 0x00000000, 0x2db00000, 0x00000000,
      0xfff00000, 0x00000000, 0x00000000, 0x00000000, 0xfff00000, 0x00000000,
      0x00000000, 0x00000000, 0xfff00000, 0x00000000, 0x00000000, 0x00000000,
      0xfff00000, 0x00000000, 0x00000000, 0x00000000, 0xfff00000, 0x00000000,
      0x00000000, 0x00000000, 0xfff00000, 0x00000000, 0x00000000, 0x00000000,
      0xffe00000, 0x00000000, 0xfff00000, 0x00000000, 0x00000000, 0x00000000,
      0x00100000, 0x00000000, 0x00200000, 0x00000000, 0xfff00000, 0x00000000,
      0x00000000, 0x00000000, 0xfff00000, 0x00000000, 0x00000000, 0x00000000,
      0xfff00000, 0x00000000, 0x00000000, 0x00000000, 0x2db00000, 0x00000000,
      0x5f500000, 0x00000000, 0xfff00000, 0x00000000, 0x00000000, 0x00000000,
      0xfff00000, 0x00000000, 0x00000000, 0x00000000, 0xfff00000, 0x00000000,
      0x80000000, 0x00000000, 0x8a74d669, 0x9f4f5297, 0x4a7b1d24, 0x48892a0b,
      0xa0b00000, 0x00000000, 0xd3d61d24, 0x48892a0b, 0x2a0b0000, 0x00000000,
      0xf254472f, 0x48892a0b, 0x48892a0b, 0x00000000, 0xce13a64e, 0x53892a0b,
      0x2448892a, 0x0b000000, 0xc6ef65ad, 0x72942a0b, 0x1d244889, 0x2a0b0000,
      0x385d4168, 0xdd8eaa0b, 0x8e922444, 0x95058000, 0x53963a48, 0x91125416,
      0xa9cb1d24, 0x48892a0b, 0x00000000, 0x00000000, 0x5634e2db, 0xb776d5f5,
      0xac69c5b7, 0x6eedabea, 0x1b38f8df, 0xb383aa0b, 0x716ddbbb, 0x6afa8000,
      0x8ca6d49b, 0x1e7e2a0b, 0xe2dbb776, 0xd5f50000, 0x858293fa, 0x3d892a0b,
      0xdbb776d5, 0xf5000000, 0x53c739f0, 0x9f4f5297, 0x22ca6fa5, 0x36ad9c79,
      0x6141f319, 0x48892a0b, 0xb776d5f5, 0x00000000, 0x7fc01d24, 0x48892a0b,
      0xd5f50000, 0x00000000, 0x091b1d24, 0x48892a0b, 0x5f500000, 0x00000000,
      0x80000000, 0x00000000, 0xc8892a0a, 0xa9cb1d25, 0x80100000, 0x00000001,
      0x00100000, 0x00000000, 0x80010000, 0x00000001, 0x00010000, 0x00000000,
      0x80000001, 0x00000001, 0x00000001, 0x00000000, 0x80000000, 0x01000001,
      0x00000000, 0x01000000, 0x80000000, 0x00010001, 0x00000000, 0x00010000,
      0x80000000, 0x00008001, 0x00000000, 0x00008000, 0x00000000, 0x00000002,
      0x80000000, 0x00000001, 0x00000000, 0x00000000, 0x7fffffff, 0xffffffff,
      0xffffffff, 0xfffffffe, 0x7fffffff, 0xffff8001, 0xffffffff, 0xffff8000,
      0x7fffffff, 0xffff0001, 0xffffffff, 0xffff0000, 0x7fffffff, 0xff000001,
      0xffffffff, 0xff000000, 0x7fffffff, 0xa9cb1d25, 0x7fffffff, 0x48892a0b,
      0x7fffffff, 0x00000001, 0xffffffff, 0x00000000, 0x7fff0000, 0x00000001,
      0xffff0000, 0x00000000, 0x7ff00000, 0x00000001, 0xfff00000, 0x00000000,
      0x29cb1d24, 0x48892a0b
    ];
toInt32s(TEST_MUL_BITS);

var TEST_DIV_BITS = [
      0x00000000, 0x00000001, 0x00000000, 0x00000001, 0x00000000, 0x000007ff,
      0x00000000, 0x00000800, 0x00000000, 0x00007fff, 0x00000000, 0x00008000,
      0x00000000, 0x7fffffff, 0x00000000, 0x80000000, 0x0000007f, 0xffff8000,
      0x00000080, 0x00000000, 0x00007fff, 0x80007fff, 0x00008000, 0x00000000,
      0x0000fffe, 0x0003fff8, 0x00010000, 0x00000000, 0x40000000, 0x00000000,
      0x80000000, 0x00000000, 0x80000000, 0x00000000, 0xc0000000, 0x00000000,
      0xfffefffd, 0xfffbfff8, 0xffff0000, 0x00000000, 0xffff7fff, 0x7fff8000,
      0xffff8000, 0x00000000, 0xffffff7f, 0xffff8000, 0xffffff80, 0x00000000,
      0xfffffffe, 0x83e3cc1a, 0xffffffff, 0x4d64985a, 0xffffffff, 0x80000000,
      0xffffffff, 0x80000000, 0xffffffff, 0xffff8000, 0xffffffff, 0xffff8000,
      0xffffffff, 0xfffff800, 0xffffffff, 0xfffff800, 0xffffffff, 0xffffffff,
      0xffffffff, 0xffffffff, 0x00000000, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x00000488, 0x00000000, 0x00000488, 0x00000000, 0x00004889,
      0x00000000, 0x00004889, 0x00000000, 0x48892a0a, 0x00000000, 0x48892a0a,
      0x00000048, 0x8929c220, 0x00000048, 0x892a0aa9, 0x00004888, 0xe181c849,
      0x00004889, 0x2a0aa9cb, 0x00009111, 0x31f2efb0, 0x00009112, 0x54155396,
      0x24449505, 0x54e58e92, 0x48892a0a, 0xa9cb1d25, 0xb776d5f5, 0x5634e2db,
      0xdbbb6afa, 0xab1a716e, 0xffff6eec, 0x89c3bff2, 0xffff6eed, 0xabeaac6a,
      0xffffb776, 0x8d6be3a1, 0xffffb776, 0xd5f55635, 0xffffffb7, 0x76d5acce,
      0xffffffb7, 0x76d5f557, 0xffffffff, 0x2898cfc6, 0xffffffff, 0x9ac930b4,
      0xffffffff, 0xb776d5f6, 0xffffffff, 0xb776d5f6, 0xffffffff, 0xffffb777,
      0xffffffff, 0xffffb777, 0xffffffff, 0xfffffb78, 0xffffffff, 0xfffffb78,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000001, 0x00000000, 0x00000001,
      0x00000000, 0x0000000f, 0x00000000, 0x00000010, 0x00000000, 0x000fffff,
      0x00000000, 0x00100000, 0x00000000, 0x0ffffff0, 0x00000000, 0x10000000,
      0x0000000f, 0xfff0000f, 0x00000010, 0x00000000, 0x0000001f, 0xffc0007f,
      0x00000020, 0x00000000, 0x00080000, 0x00000000, 0x00100000, 0x00000001,
      0xffefffff, 0xffffffff, 0xfff80000, 0x00000000, 0xffffffdf, 0xffbfff80,
      0xffffffe0, 0x00000000, 0xffffffef, 0xffeffff0, 0xfffffff0, 0x00000000,
      0xffffffff, 0xeffffff0, 0xffffffff, 0xf0000000, 0xffffffff, 0xffd07c7a,
      0xffffffff, 0xffe9ac94, 0xffffffff, 0xfff00000, 0xffffffff, 0xfff00000,
      0xffffffff, 0xfffffff0, 0xffffffff, 0xfffffff0, 0xffffffff, 0xffffffff,
      0xffffffff, 0xffffffff, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000001, 0x00000000, 0x0000000f, 0x00000000, 0x00000010,
      0x00000000, 0x000fffff, 0x00000000, 0x00100000, 0x00000000, 0x0ffffff0,
      0x00000000, 0x10000000, 0x0000000f, 0xfff0000f, 0x00000010, 0x00000000,
      0x0000001f, 0xffc0007f, 0x00000020, 0x00000000, 0x00080000, 0x00000000,
      0x00100000, 0x00000000, 0xfff00000, 0x00000000, 0xfff80000, 0x00000000,
      0xffffffdf, 0xffbfff80, 0xffffffe0, 0x00000000, 0xffffffef, 0xffeffff0,
      0xfffffff0, 0x00000000, 0xffffffff, 0xeffffff0, 0xffffffff, 0xf0000000,
      0xffffffff, 0xffd07c7a, 0xffffffff, 0xffe9ac94, 0xffffffff, 0xfff00000,
      0xffffffff, 0xfff00000, 0xffffffff, 0xfffffff0, 0xffffffff, 0xfffffff0,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x00000001, 0x00000000, 0x0000ffff, 0x00000000, 0x00010000,
      0x00000000, 0x00ffffff, 0x00000000, 0x01000000, 0x00000000, 0xffff0001,
      0x00000001, 0x00000000, 0x00000001, 0xfffc0007, 0x00000002, 0x00000000,
      0x00008000, 0x00000000, 0x00010000, 0x00000001, 0xfffeffff, 0xffffffff,
      0xffff8000, 0x00000000, 0xfffffffd, 0xfffbfff8, 0xfffffffe, 0x00000000,
      0xfffffffe, 0xfffeffff, 0xffffffff, 0x00000000, 0xffffffff, 0xfeffffff,
      0xffffffff, 0xff000000, 0xffffffff, 0xfffd07c8, 0xffffffff, 0xfffe9aca,
      0xffffffff, 0xffff0000, 0xffffffff, 0xffff0000, 0xffffffff, 0xffffffff,
      0xffffffff, 0xffffffff, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000001, 0x00000000, 0x0000ffff,
      0x00000000, 0x00010000, 0x00000000, 0x00ffffff, 0x00000000, 0x01000000,
      0x00000000, 0xffff0000, 0x00000001, 0x00000000, 0x00000001, 0xfffc0007,
      0x00000002, 0x00000000, 0x00008000, 0x00000000, 0x00010000, 0x00000000,
      0xffff0000, 0x00000000, 0xffff8000, 0x00000000, 0xfffffffd, 0xfffbfff8,
      0xfffffffe, 0x00000000, 0xfffffffe, 0xfffeffff, 0xffffffff, 0x00000000,
      0xffffffff, 0xfeffffff, 0xffffffff, 0xff000000, 0xffffffff, 0xfffd07c8,
      0xffffffff, 0xfffe9aca, 0xffffffff, 0xffff0000, 0xffffffff, 0xffff0000,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000001, 0x00000000, 0x00000001, 0x00000000, 0x000000ff,
      0x00000000, 0x00000100, 0x00000000, 0x0000ffff, 0x00000000, 0x00010000,
      0x00000000, 0x0001fffc, 0x00000000, 0x00020000, 0x00000000, 0x80000000,
      0x00000001, 0x00000001, 0xfffffffe, 0xffffffff, 0xffffffff, 0x80000000,
      0xffffffff, 0xfffdfffc, 0xffffffff, 0xfffe0000, 0xffffffff, 0xfffeffff,
      0xffffffff, 0xffff0000, 0xffffffff, 0xffffff00, 0xffffffff, 0xffffff00,
      0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff,
      0xffffffff, 0xffffffff, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x000000ff, 0x00000000, 0x00000100, 0x00000000, 0x0000ffff,
      0x00000000, 0x00010000, 0x00000000, 0x0001fffc, 0x00000000, 0x00020000,
      0x00000000, 0x80000000, 0x00000001, 0x00000000, 0xffffffff, 0x00000000,
      0xffffffff, 0x80000000, 0xffffffff, 0xfffdfffc, 0xffffffff, 0xfffe0000,
      0xffffffff, 0xfffeffff, 0xffffffff, 0xffff0000, 0xffffffff, 0xffffff00,
      0xffffffff, 0xffffff00, 0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000001, 0x00000000, 0x00000001,
      0x00000000, 0x000000ff, 0x00000000, 0x00000100, 0x00000000, 0x000001ff,
      0x00000000, 0x00000200, 0x00000000, 0x00800000, 0x00000000, 0x01000001,
      0xffffffff, 0xfeffffff, 0xffffffff, 0xff800000, 0xffffffff, 0xfffffe00,
      0xffffffff, 0xfffffe00, 0xffffffff, 0xffffff00, 0xffffffff, 0xffffff00,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000001, 0x00000000, 0x000000ff, 0x00000000, 0x00000100,
      0x00000000, 0x000001ff, 0x00000000, 0x00000200, 0x00000000, 0x00800000,
      0x00000000, 0x01000000, 0xffffffff, 0xff000000, 0xffffffff, 0xff800000,
      0xffffffff, 0xfffffe00, 0xffffffff, 0xfffffe00, 0xffffffff, 0xffffff00,
      0xffffffff, 0xffffff00, 0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x00000001, 0x00000000, 0x00000001, 0x00000000, 0x00000002,
      0x00000000, 0x00008000, 0x00000000, 0x00010001, 0xffffffff, 0xfffeffff,
      0xffffffff, 0xffff8000, 0xffffffff, 0xfffffffe, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000001, 0x00000000, 0x00000001,
      0x00000000, 0x00000002, 0x00000000, 0x00008000, 0x00000000, 0x00010000,
      0xffffffff, 0xffff0000, 0xffffffff, 0xffff8000, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000001, 0x00000000, 0x00000001, 0x00000000, 0x00004000,
      0x00000000, 0x00008001, 0xffffffff, 0xffff7fff, 0xffffffff, 0xffffc000,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x00004000, 0x00000000, 0x00008000, 0xffffffff, 0xffff8000,
      0xffffffff, 0xffffc000, 0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000001, 0x00000000, 0x00000002,
      0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000001, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xffffffff,
      0x00000000, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xffffffff,
      0xffffffff, 0xfffffffe, 0x00000000, 0x00000002, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0xffffffff, 0xffffc001, 0xffffffff, 0xffff8001, 0x00000000, 0x00007fff,
      0x00000000, 0x00003fff, 0x00000000, 0x00000001, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffc000, 0xffffffff, 0xffff8000,
      0x00000000, 0x00008000, 0x00000000, 0x00004000, 0x00000000, 0x00000001,
      0x00000000, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0xffff8001,
      0xffffffff, 0xffff0001, 0x00000000, 0x0000ffff, 0x00000000, 0x00007fff,
      0x00000000, 0x00000002, 0x00000000, 0x00000001, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xffff8000, 0xffffffff, 0xffff0000, 0x00000000, 0x00010000,
      0x00000000, 0x00008000, 0x00000000, 0x00000002, 0x00000000, 0x00000002,
      0x00000000, 0x00000001, 0x00000000, 0x00000001, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0xffffffff, 0xffffff01, 0xffffffff, 0xffffff01, 0xffffffff, 0xfffffe01,
      0xffffffff, 0xfffffe01, 0xffffffff, 0xff800001, 0xffffffff, 0xff000001,
      0x00000000, 0x00ffffff, 0x00000000, 0x007fffff, 0x00000000, 0x00000200,
      0x00000000, 0x000001ff, 0x00000000, 0x00000100, 0x00000000, 0x000000ff,
      0x00000000, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffff01, 0xffffffff, 0xffffff00,
      0xffffffff, 0xfffffe01, 0xffffffff, 0xfffffe00, 0xffffffff, 0xff800000,
      0xffffffff, 0xff000000, 0x00000000, 0x01000000, 0x00000000, 0x00800000,
      0x00000000, 0x00000200, 0x00000000, 0x00000200, 0x00000000, 0x00000100,
      0x00000000, 0x00000100, 0x00000000, 0x00000001, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0xffffffff, 0xffffffaa, 0xffffffff, 0xffffffaa, 0xffffffff, 0xffffa9cc,
      0xffffffff, 0xffffa9cc, 0xffffffff, 0xffff5398, 0xffffffff, 0xffff5397,
      0xffffffff, 0xd4e58e93, 0xffffffff, 0xa9cb1d25, 0x00000000, 0x5634e2db,
      0x00000000, 0x2b1a716d, 0x00000000, 0x0000ac6b, 0x00000000, 0x0000ac69,
      0x00000000, 0x00005635, 0x00000000, 0x00005634, 0x00000000, 0x00000056,
      0x00000000, 0x00000056, 0x00000000, 0x00000001, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0xffffffff, 0xffffff49, 0xffffffff, 0xffffff49,
      0xffffffff, 0xffff488a, 0xffffffff, 0xffff488a, 0xffffffff, 0xfffe9116,
      0xffffffff, 0xfffe9113, 0xffffffff, 0xa4449506, 0xffffffff, 0x48892a0b,
      0x00000000, 0xb776d5f5, 0x00000000, 0x5bbb6afa, 0x00000000, 0x00016ef0,
      0x00000000, 0x00016eed, 0x00000000, 0x0000b777, 0x00000000, 0x0000b776,
      0x00000000, 0x000000b7, 0x00000000, 0x000000b7, 0x00000000, 0x00000002,
      0x00000000, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xffffff01,
      0xffffffff, 0xffffff01, 0xffffffff, 0xffff0001, 0xffffffff, 0xffff0001,
      0xffffffff, 0xfffe0004, 0xffffffff, 0xfffe0001, 0xffffffff, 0x80000001,
      0xffffffff, 0x00000001, 0x00000000, 0xffffffff, 0x00000000, 0x7fffffff,
      0x00000000, 0x00020004, 0x00000000, 0x0001ffff, 0x00000000, 0x00010001,
      0x00000000, 0x0000ffff, 0x00000000, 0x00000100, 0x00000000, 0x000000ff,
      0x00000000, 0x00000002, 0x00000000, 0x00000001, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xffffffff,
      0xffffffff, 0xffffff01, 0xffffffff, 0xffffff00, 0xffffffff, 0xffff0001,
      0xffffffff, 0xffff0000, 0xffffffff, 0xfffe0004, 0xffffffff, 0xfffe0000,
      0xffffffff, 0x80000000, 0xffffffff, 0x00000000, 0x00000001, 0x00000000,
      0x00000000, 0x80000000, 0x00000000, 0x00020004, 0x00000000, 0x00020000,
      0x00000000, 0x00010001, 0x00000000, 0x00010000, 0x00000000, 0x00000100,
      0x00000000, 0x00000100, 0x00000000, 0x00000002, 0x00000000, 0x00000001,
      0x00000000, 0x00000001, 0x00000000, 0x00000001, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xffff0001,
      0xffffffff, 0xffff0001, 0xffffffff, 0xff000001, 0xffffffff, 0xff000001,
      0xffffffff, 0x00010000, 0xffffffff, 0x00000001, 0xfffffffe, 0x0003fff9,
      0xfffffffe, 0x00000001, 0xffff8000, 0x00000001, 0xffff0000, 0x00000001,
      0x0000ffff, 0xffffffff, 0x00007fff, 0xffffffff, 0x00000002, 0x00040008,
      0x00000001, 0xffffffff, 0x00000001, 0x00010001, 0x00000000, 0xffffffff,
      0x00000000, 0x01000001, 0x00000000, 0x00ffffff, 0x00000000, 0x0002f838,
      0x00000000, 0x00016536, 0x00000000, 0x00010000, 0x00000000, 0x0000ffff,
      0x00000000, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xffffffff,
      0xffffffff, 0xffff0001, 0xffffffff, 0xffff0000, 0xffffffff, 0xff000001,
      0xffffffff, 0xff000000, 0xffffffff, 0x00010000, 0xffffffff, 0x00000000,
      0xfffffffe, 0x0003fff9, 0xfffffffe, 0x00000000, 0xffff8000, 0x00000000,
      0xffff0000, 0x00000000, 0x00010000, 0x00000000, 0x00008000, 0x00000000,
      0x00000002, 0x00040008, 0x00000002, 0x00000000, 0x00000001, 0x00010001,
      0x00000001, 0x00000000, 0x00000000, 0x01000001, 0x00000000, 0x01000000,
      0x00000000, 0x0002f838, 0x00000000, 0x00016536, 0x00000000, 0x00010000,
      0x00000000, 0x00010000, 0x00000000, 0x00000001, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xfffffff1,
      0xffffffff, 0xfffffff1, 0xffffffff, 0xfff00001, 0xffffffff, 0xfff00001,
      0xffffffff, 0xf0000010, 0xffffffff, 0xf0000001, 0xfffffff0, 0x000ffff1,
      0xfffffff0, 0x00000001, 0xffffffe0, 0x003fff81, 0xffffffe0, 0x00000001,
      0xfff80000, 0x00000001, 0xfff00000, 0x00000001, 0x000fffff, 0xffffffff,
      0x0007ffff, 0xffffffff, 0x00000020, 0x00400080, 0x0000001f, 0xffffffff,
      0x00000010, 0x00100010, 0x0000000f, 0xffffffff, 0x00000000, 0x10000010,
      0x00000000, 0x0fffffff, 0x00000000, 0x002f8386, 0x00000000, 0x0016536c,
      0x00000000, 0x00100000, 0x00000000, 0x000fffff, 0x00000000, 0x00000010,
      0x00000000, 0x0000000f, 0x00000000, 0x00000001, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xffffffff,
      0xffffffff, 0xfffffff1, 0xffffffff, 0xfffffff0, 0xffffffff, 0xfff00001,
      0xffffffff, 0xfff00000, 0xffffffff, 0xf0000010, 0xffffffff, 0xf0000000,
      0xfffffff0, 0x000ffff1, 0xfffffff0, 0x00000000, 0xffffffe0, 0x003fff81,
      0xffffffe0, 0x00000000, 0xfff80000, 0x00000000, 0xfff00000, 0x00000000,
      0x00100000, 0x00000000, 0x00080000, 0x00000000, 0x00000020, 0x00400080,
      0x00000020, 0x00000000, 0x00000010, 0x00100010, 0x00000010, 0x00000000,
      0x00000000, 0x10000010, 0x00000000, 0x10000000, 0x00000000, 0x002f8386,
      0x00000000, 0x0016536c, 0x00000000, 0x00100000, 0x00000000, 0x00100000,
      0x00000000, 0x00000010, 0x00000000, 0x00000010, 0x00000000, 0x00000001,
      0x00000000, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xfffffa9d,
      0xffffffff, 0xfffffa9d, 0xffffffff, 0xffffa9cc, 0xffffffff, 0xffffa9cc,
      0xffffffff, 0xa9cb1d25, 0xffffffff, 0xa9cb1d25, 0xffffffa9, 0xcb1d7a7e,
      0xffffffa9, 0xcb1d2449, 0xffffa9cb, 0x7358d531, 0xffffa9cb, 0x1d24488a,
      0xffff5397, 0x93196ae0, 0xffff5396, 0x3a489113, 0xd4e58e92, 0x24449506,
      0xa9cb1d24, 0x48892a0b, 0x5634e2db, 0xb776d5f5, 0x2b1a716d, 0xdbbb6afa,
      0x0000ac6b, 0x1e8dac09, 0x0000ac69, 0xc5b76eed, 0x00005635, 0x3910f087,
      0x00005634, 0xe2dbb776, 0x00000056, 0x34e331ec, 0x00000056, 0x34e2dbb7,
      0x00000001, 0x00000002, 0x00000000, 0x784a3552, 0x00000000, 0x5634e2dc,
      0x00000000, 0x5634e2db, 0x00000000, 0x00005634, 0x00000000, 0x00005634,
      0x00000000, 0x00000563, 0x00000000, 0x00000563, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xffffffff,
      0xffffffff, 0xfffff801, 0xffffffff, 0xfffff801, 0xffffffff, 0xffff8001,
      0xffffffff, 0xffff8001, 0xffffffff, 0x80000001, 0xffffffff, 0x80000001,
      0xffffff80, 0x00008000, 0xffffff80, 0x00000001, 0xffff8000, 0x7fff8001,
      0xffff8000, 0x00000001, 0xffff0001, 0xfffc0008, 0xffff0000, 0x00000001,
      0xc0000000, 0x00000001, 0x80000000, 0x00000001, 0x7fffffff, 0xffffffff,
      0x3fffffff, 0xffffffff, 0x00010002, 0x00040008, 0x0000ffff, 0xffffffff,
      0x00008000, 0x80008000, 0x00007fff, 0xffffffff, 0x00000080, 0x00008000,
      0x0000007f, 0xffffffff, 0x00000001, 0x7c1c33e6, 0x00000000, 0xb29b67a6,
      0x00000000, 0x80000000, 0x00000000, 0x7fffffff, 0x00000000, 0x00008000,
      0x00000000, 0x00007fff, 0x00000000, 0x00000800, 0x00000000, 0x000007ff,
      0x00000000, 0x00000001, 0x00000000, 0x00000001
    ];
toInt32s(TEST_DIV_BITS);

var TEST_STRINGS = [
      "-9223372036854775808",
      "-5226755067826871589",
      "-4503599627370497",
      "-4503599627370496",
      "-281474976710657",
      "-281474976710656",
      "-4294967297",
      "-4294967296",
      "-16777217",
      "-16777216",
      "-65537",
      "-65536",
      "-32769",
      "-32768",
      "-2",
      "-1",
      "0",
      "1",
      "2",
      "32767",
      "32768",
      "65535",
      "65536",
      "16777215",
      "16777216",
      "1446306523",
      "3078018549",
      "4294967295",
      "4294967296",
      "281474976710655",
      "281474976710656",
      "4503599627370495",
      "4503599627370496",
      "6211839219354490357",
      "9223372036854775807"
    ];

function testToFromBits() {
  for (var i = 0; i < TEST_BITS.length; i += 2) {
    var val = goog.math.Long.fromBits(TEST_BITS[i+1], TEST_BITS[i]);
    assertEquals(TEST_BITS[i], val.getHighBits());
    assertEquals(TEST_BITS[i+1], val.getLowBits());
  }
}

function testToFromInt() {
  for (var i = 0; i < TEST_BITS.length; i += 1) {
    var val = goog.math.Long.fromInt(TEST_BITS[i]);
    assertEquals(TEST_BITS[i], val.toInt());
  }
}

function testToFromNumber() {
  for (var i = 0; i < TEST_BITS.length; i += 2) {
    var num = TEST_BITS[i] * Math.pow(2, 32) +
        TEST_BITS[i+1] >= 0 ? TEST_BITS[i+1] : Math.pow(2, 32) + TEST_BITS[i+1];
    var val = goog.math.Long.fromNumber(num);
    assertEquals(num, val.toNumber());
  }
}

function testIsZero() {
  for (var i = 0; i < TEST_BITS.length; i += 2) {
    var val = goog.math.Long.fromBits(TEST_BITS[i+1], TEST_BITS[i]);
    assertEquals(TEST_BITS[i] == 0 && TEST_BITS[i+1] == 0, val.isZero());
  }
}

function testIsNegative() {
  for (var i = 0; i < TEST_BITS.length; i += 2) {
    var val = goog.math.Long.fromBits(TEST_BITS[i+1], TEST_BITS[i]);
    assertEquals((TEST_BITS[i] >> 31) != 0, val.isNegative());
  }
}

function testIsOdd() {
  for (var i = 0; i < TEST_BITS.length; i += 2) {
    var val = goog.math.Long.fromBits(TEST_BITS[i+1], TEST_BITS[i]);
    assertEquals((TEST_BITS[i+1] & 1) != 0, val.isOdd());
  }
}

function createTestComparisons(i) {
  return function() {
    var vi = goog.math.Long.fromBits(TEST_BITS[i+1], TEST_BITS[i]);
    for (var j = 0; j < TEST_BITS.length; j += 2) {
      var vj = goog.math.Long.fromBits(TEST_BITS[j+1], TEST_BITS[j]);
      assertEquals(i == j, vi.equals(vj));
      assertEquals(i != j, vi.notEquals(vj));
      assertEquals(i < j, vi.lessThan(vj));
      assertEquals(i <= j, vi.lessThanOrEqual(vj));
      assertEquals(i > j, vi.greaterThan(vj));
      assertEquals(i >= j, vi.greaterThanOrEqual(vj));
    }
  };
}

// Here and below, we translate one conceptual test (e.g., "testComparisons")
// into a number of test functions that will be run separately by jsunit. This
// is necessary because, in some testing configurations, the full combined test
// can take so long that it times out. These smaller tests run much faster.
for (var i = 0; i < TEST_BITS.length; i += 2) {
  goog.global['testComparisons' + i] = createTestComparisons(i);
}

function createTestBitOperations(i) {
  return function() {
    var vi = goog.math.Long.fromBits(TEST_BITS[i+1], TEST_BITS[i]);
    assertEquals(~TEST_BITS[i], vi.not().getHighBits());
    assertEquals(~TEST_BITS[i+1], vi.not().getLowBits());

    for (var j = 0; j < TEST_BITS.length; j += 2) {
      var vj = goog.math.Long.fromBits(TEST_BITS[j+1], TEST_BITS[j]);
      assertEquals(TEST_BITS[i] & TEST_BITS[j], vi.and(vj).getHighBits());
      assertEquals(TEST_BITS[i+1] & TEST_BITS[j+1], vi.and(vj).getLowBits());
      assertEquals(TEST_BITS[i] | TEST_BITS[j], vi.or(vj).getHighBits());
      assertEquals(TEST_BITS[i+1] | TEST_BITS[j+1], vi.or(vj).getLowBits());
      assertEquals(TEST_BITS[i] ^ TEST_BITS[j], vi.xor(vj).getHighBits());
      assertEquals(TEST_BITS[i+1] ^ TEST_BITS[j+1], vi.xor(vj).getLowBits());
    }

    assertEquals(TEST_BITS[i], vi.shiftLeft(0).getHighBits());
    assertEquals(TEST_BITS[i+1], vi.shiftLeft(0).getLowBits());
    assertEquals(TEST_BITS[i], vi.shiftRight(0).getHighBits());
    assertEquals(TEST_BITS[i+1], vi.shiftRight(0).getLowBits());
    assertEquals(TEST_BITS[i], vi.shiftRightUnsigned(0).getHighBits());
    assertEquals(TEST_BITS[i+1], vi.shiftRightUnsigned(0).getLowBits());

    for (var len = 1; len < 64; ++len) {
      if (len < 32) {
        assertEquals((TEST_BITS[i] << len) | (TEST_BITS[i+1] >>> (32 - len)),
                     vi.shiftLeft(len).getHighBits());
        assertEquals(TEST_BITS[i+1] << len, vi.shiftLeft(len).getLowBits());

        assertEquals(TEST_BITS[i] >> len, vi.shiftRight(len).getHighBits());
        assertEquals((TEST_BITS[i+1] >>> len) | (TEST_BITS[i] << (32 - len)),
                     vi.shiftRight(len).getLowBits());

        assertEquals(TEST_BITS[i] >>> len,
                     vi.shiftRightUnsigned(len).getHighBits());
        assertEquals((TEST_BITS[i+1] >>> len) | (TEST_BITS[i] << (32 - len)),
                     vi.shiftRightUnsigned(len).getLowBits());
      } else {
        assertEquals(TEST_BITS[i+1] << (len - 32),
                     vi.shiftLeft(len).getHighBits());
        assertEquals(0, vi.shiftLeft(len).getLowBits());

        assertEquals(TEST_BITS[i] >= 0 ? 0 : -1,
                     vi.shiftRight(len).getHighBits());
        assertEquals(TEST_BITS[i] >> (len - 32),
                     vi.shiftRight(len).getLowBits());

        assertEquals(0, vi.shiftRightUnsigned(len).getHighBits());
        if (len == 32) {
          assertEquals(TEST_BITS[i], vi.shiftRightUnsigned(len).getLowBits());
        } else {
          assertEquals(TEST_BITS[i] >>> (len - 32),
                       vi.shiftRightUnsigned(len).getLowBits());
        }
      }
    }

    assertEquals(TEST_BITS[i], vi.shiftLeft(64).getHighBits());
    assertEquals(TEST_BITS[i+1], vi.shiftLeft(64).getLowBits());
    assertEquals(TEST_BITS[i], vi.shiftRight(64).getHighBits());
    assertEquals(TEST_BITS[i+1], vi.shiftRight(64).getLowBits());
    assertEquals(TEST_BITS[i], vi.shiftRightUnsigned(64).getHighBits());
    assertEquals(TEST_BITS[i+1], vi.shiftRightUnsigned(64).getLowBits());
  };
}

for (var i = 0; i < TEST_BITS.length; i += 2) {
  goog.global['testBitOperations' + i] = createTestBitOperations(i);
}

function testNegation() {
  for (var i = 0; i < TEST_BITS.length; i += 2) {
    var vi = goog.math.Long.fromBits(TEST_BITS[i+1], TEST_BITS[i]);
    if (TEST_BITS[i+1] == 0) {
      assertEquals((~TEST_BITS[i] + 1)|0, vi.negate().getHighBits());
      assertEquals(0, vi.negate().getLowBits());
    } else {
      assertEquals(~TEST_BITS[i], vi.negate().getHighBits());
      assertEquals((~TEST_BITS[i+1] + 1)|0, vi.negate().getLowBits());
    }
  }
}

function testAdd() {
  var count = 0;
  for (var i = 0; i < TEST_BITS.length; i += 2) {
    var vi = goog.math.Long.fromBits(TEST_BITS[i+1], TEST_BITS[i]);
    for (var j = 0; j < i; j += 2) {
      var vj = goog.math.Long.fromBits(TEST_BITS[j+1], TEST_BITS[j]);
      var result = vi.add(vj);
      assertEquals(TEST_ADD_BITS[count++], result.getHighBits());
      assertEquals(TEST_ADD_BITS[count++], result.getLowBits());
    }
  }
}

function testSubtract() {
  var count = 0;
  for (var i = 0; i < TEST_BITS.length; i += 2) {
    var vi = goog.math.Long.fromBits(TEST_BITS[i+1], TEST_BITS[i]);
    for (var j = 0; j < TEST_BITS.length; j += 2) {
      var vj = goog.math.Long.fromBits(TEST_BITS[j+1], TEST_BITS[j]);
      var result = vi.subtract(vj);
      assertEquals(TEST_SUB_BITS[count++], result.getHighBits());
      assertEquals(TEST_SUB_BITS[count++], result.getLowBits());
    }
  }
}

function testMultiply() {
  var count = 0;
  for (var i = 0; i < TEST_BITS.length; i += 2) {
    var vi = goog.math.Long.fromBits(TEST_BITS[i+1], TEST_BITS[i]);
    for (var j = 0; j < i; j += 2) {
      var vj = goog.math.Long.fromBits(TEST_BITS[j+1], TEST_BITS[j]);
      var result = vi.multiply(vj);
      assertEquals(TEST_MUL_BITS[count++], result.getHighBits());
      assertEquals(TEST_MUL_BITS[count++], result.getLowBits());
    }
  }
}

function createTestDivMod(i, count) {
  return function() {
    var vi = goog.math.Long.fromBits(TEST_BITS[i+1], TEST_BITS[i]);
    for (var j = 0; j < TEST_BITS.length; j += 2) {
      var vj = goog.math.Long.fromBits(TEST_BITS[j+1], TEST_BITS[j]);
      if (!vj.isZero()) {
        var divResult = vi.div(vj);
        assertEquals(TEST_DIV_BITS[count++], divResult.getHighBits());
        assertEquals(TEST_DIV_BITS[count++], divResult.getLowBits());

        var modResult = vi.modulo(vj);
        var combinedResult = divResult.multiply(vj).add(modResult);
        assertTrue(vi.equals(combinedResult));
      }
    }
  }
}

var countPerDivModCall = 0;
for (var j = 0; j < TEST_BITS.length; j += 2) {
  var vj = goog.math.Long.fromBits(TEST_BITS[j+1], TEST_BITS[j]);
  if (!vj.isZero()) {
    countPerDivModCall += 2;
  }
}

var countDivMod = 0;
for (var i = 0; i < TEST_BITS.length; i += 2) {
  goog.global['testDivMod' + i] = createTestDivMod(i, countDivMod);
  countDivMod += countPerDivModCall;
}

function createTestToFromString(i) {
  return function() {
    var vi = goog.math.Long.fromBits(TEST_BITS[i+1], TEST_BITS[i]);
    var str = vi.toString(10);
    assertEquals(TEST_STRINGS[i/2], str);
    assertEquals(TEST_BITS[i],
                 goog.math.Long.fromString(str, 10).getHighBits());
    assertEquals(TEST_BITS[i+1],
                 goog.math.Long.fromString(str, 10).getLowBits());

    for (var radix = 2; radix <= 36; ++radix) {
      var result = vi.toString(radix);
      assertEquals(TEST_BITS[i],
                   goog.math.Long.fromString(result, radix).getHighBits());
      assertEquals(TEST_BITS[i+1],
                   goog.math.Long.fromString(result, radix).getLowBits());
    }
  }
}

for (var i = 0; i < TEST_BITS.length; i += 2) {
  goog.global['testToFromString' + i] = createTestToFromString(i);
}
">n/a</td></tr>
<tr><td>bezier_test.html</td><td>Success</td><td> 5 passed, 0 failed.</td><td title="

  goog.require('goog.math.Bezier');
  goog.require('goog.testing.jsunit');



  function testEquals() {
    var input = new goog.math.Bezier(1, 2, 3, 4, 5, 6, 7, 8);

    assert(input.equals(input));
  }

  function testClone() {
    var input = new goog.math.Bezier(1, 2, 3, 4, 5, 6, 7, 8);

    assertNotEquals('Clone returns a new object', input, input.clone())
    assert('Contents of clone match original', input.equals(input.clone()));
  }

  function testFlip() {
    var input = new goog.math.Bezier(1, 1, 2, 2, 3, 3, 4, 4);
    var compare = new goog.math.Bezier(4, 4, 3, 3, 2, 2, 1, 1);

    var flipped = input.clone();
    flipped.flip();
    assert('Flipped behaves as expected', compare.equals(flipped));

    flipped.flip();
    assert('Flipping twice gives original', input.equals(flipped));
  }

  function testGetPoint() {
    var input = new goog.math.Bezier(0, 1, 1, 2, 2, 3, 3, 4);

    assert(goog.math.Coordinate.equals(input.getPoint(0),
        new goog.math.Coordinate(0, 1)));
    assert(goog.math.Coordinate.equals(input.getPoint(1),
        new goog.math.Coordinate(3, 4)));
    assert(goog.math.Coordinate.equals(input.getPoint(0.5),
        new goog.math.Coordinate(1.5, 2.5)));
  }

  function testSubdivide() {
    var input = new goog.math.Bezier(0, 1, 1, 2, 2, 3, 3, 4);

    input.subdivide(1/3, 2/3);

    assert(goog.math.nearlyEquals(1, input.x0));
    assert(goog.math.nearlyEquals(2, input.y0));
    assert(goog.math.nearlyEquals(2, input.x3));
    assert(goog.math.nearlyEquals(3, input.y3));    
  }
  
">n/a</td></tr>
<tr><td>integer_test.html</td><td>Success</td><td> 255 passed, 0 failed.</td><td title="

  goog.require('goog.math.Integer');
  goog.require('goog.testing.jsunit');


// Interprets the given numbers as the bits of a 32-bit int.  In particular,
// this takes care of the 32-bit being interpretted as the sign.
function toInt32s(arr) {
  for (var i = 0; i < arr.length; ++i) {
    arr[i] = arr[i] & 0xFFFFFFFF;
  }
}

// Note that these are in numerical order.
var TEST_BITS = [ 0x80000000, 0x00000000,
                  0xb776d5f5, 0x5634e2db,
                  0xffefffff, 0xffffffff,
                  0xfff00000, 0x00000000,
                  0xfffeffff, 0xffffffff,
                  0xffff0000, 0x00000000,
                  0xfffffffe, 0xffffffff,
                  0xffffffff, 0x00000000,
                  0xffffffff, 0xfeffffff,
                  0xffffffff, 0xff000000,
                  0xffffffff, 0xfffeffff,
                  0xffffffff, 0xffff0000,
                  0xffffffff, 0xffff7fff,
                  0xffffffff, 0xffff8000,
                  0xffffffff, 0xfffffffe,
                  0xffffffff, 0xffffffff,
                  0x00000000, 0x00000000,
                  0x00000000, 0x00000001,
                  0x00000000, 0x00000002,
                  0x00000000, 0x00007fff,
                  0x00000000, 0x00008000,
                  0x00000000, 0x0000ffff,
                  0x00000000, 0x00010000,
                  0x00000000, 0x00ffffff,
                  0x00000000, 0x01000000,
                  0x00000000, 0x5634e2db,
                  0x00000000, 0xb776d5f5,
                  0x00000000, 0xffffffff,
                  0x00000001, 0x00000000,
                  0x0000ffff, 0xffffffff,
                  0x00010000, 0x00000000,
                  0x000fffff, 0xffffffff,
                  0x00100000, 0x00000000,
                  0x5634e2db, 0xb776d5f5,
                  0x7fffffff, 0xffffffff ];
toInt32s(TEST_BITS);

var TEST_ADD_BITS = [
      0x3776d5f5, 0x5634e2db, 0x7fefffff, 0xffffffff, 0xb766d5f5, 0x5634e2da,
      0x7ff00000, 0x00000000, 0xb766d5f5, 0x5634e2db, 0xffdfffff, 0xffffffff,
      0x7ffeffff, 0xffffffff, 0xb775d5f5, 0x5634e2da, 0xffeeffff, 0xfffffffe,
      0xffeeffff, 0xffffffff, 0x7fff0000, 0x00000000, 0xb775d5f5, 0x5634e2db,
      0xffeeffff, 0xffffffff, 0xffef0000, 0x00000000, 0xfffdffff, 0xffffffff,
      0x7ffffffe, 0xffffffff, 0xb776d5f4, 0x5634e2da, 0xffeffffe, 0xfffffffe,
      0xffeffffe, 0xffffffff, 0xfffefffe, 0xfffffffe, 0xfffefffe, 0xffffffff,
      0x7fffffff, 0x00000000, 0xb776d5f4, 0x5634e2db, 0xffeffffe, 0xffffffff,
      0xffefffff, 0x00000000, 0xfffefffe, 0xffffffff, 0xfffeffff, 0x00000000,
      0xfffffffd, 0xffffffff, 0x7fffffff, 0xfeffffff, 0xb776d5f5, 0x5534e2da,
      0xffefffff, 0xfefffffe, 0xffefffff, 0xfeffffff, 0xfffeffff, 0xfefffffe,
      0xfffeffff, 0xfeffffff, 0xfffffffe, 0xfefffffe, 0xfffffffe, 0xfeffffff,
      0x7fffffff, 0xff000000, 0xb776d5f5, 0x5534e2db, 0xffefffff, 0xfeffffff,
      0xffefffff, 0xff000000, 0xfffeffff, 0xfeffffff, 0xfffeffff, 0xff000000,
      0xfffffffe, 0xfeffffff, 0xfffffffe, 0xff000000, 0xffffffff, 0xfdffffff,
      0x7fffffff, 0xfffeffff, 0xb776d5f5, 0x5633e2da, 0xffefffff, 0xfffefffe,
      0xffefffff, 0xfffeffff, 0xfffeffff, 0xfffefffe, 0xfffeffff, 0xfffeffff,
      0xfffffffe, 0xfffefffe, 0xfffffffe, 0xfffeffff, 0xffffffff, 0xfefefffe,
      0xffffffff, 0xfefeffff, 0x7fffffff, 0xffff0000, 0xb776d5f5, 0x5633e2db,
      0xffefffff, 0xfffeffff, 0xffefffff, 0xffff0000, 0xfffeffff, 0xfffeffff,
      0xfffeffff, 0xffff0000, 0xfffffffe, 0xfffeffff, 0xfffffffe, 0xffff0000,
      0xffffffff, 0xfefeffff, 0xffffffff, 0xfeff0000, 0xffffffff, 0xfffdffff,
      0x7fffffff, 0xffff7fff, 0xb776d5f5, 0x563462da, 0xffefffff, 0xffff7ffe,
      0xffefffff, 0xffff7fff, 0xfffeffff, 0xffff7ffe, 0xfffeffff, 0xffff7fff,
      0xfffffffe, 0xffff7ffe, 0xfffffffe, 0xffff7fff, 0xffffffff, 0xfeff7ffe,
      0xffffffff, 0xfeff7fff, 0xffffffff, 0xfffe7ffe, 0xffffffff, 0xfffe7fff,
      0x7fffffff, 0xffff8000, 0xb776d5f5, 0x563462db, 0xffefffff, 0xffff7fff,
      0xffefffff, 0xffff8000, 0xfffeffff, 0xffff7fff, 0xfffeffff, 0xffff8000,
      0xfffffffe, 0xffff7fff, 0xfffffffe, 0xffff8000, 0xffffffff, 0xfeff7fff,
      0xffffffff, 0xfeff8000, 0xffffffff, 0xfffe7fff, 0xffffffff, 0xfffe8000,
      0xffffffff, 0xfffeffff, 0x7fffffff, 0xfffffffe, 0xb776d5f5, 0x5634e2d9,
      0xffefffff, 0xfffffffd, 0xffefffff, 0xfffffffe, 0xfffeffff, 0xfffffffd,
      0xfffeffff, 0xfffffffe, 0xfffffffe, 0xfffffffd, 0xfffffffe, 0xfffffffe,
      0xffffffff, 0xfefffffd, 0xffffffff, 0xfefffffe, 0xffffffff, 0xfffefffd,
      0xffffffff, 0xfffefffe, 0xffffffff, 0xffff7ffd, 0xffffffff, 0xffff7ffe,
      0x7fffffff, 0xffffffff, 0xb776d5f5, 0x5634e2da, 0xffefffff, 0xfffffffe,
      0xffefffff, 0xffffffff, 0xfffeffff, 0xfffffffe, 0xfffeffff, 0xffffffff,
      0xfffffffe, 0xfffffffe, 0xfffffffe, 0xffffffff, 0xffffffff, 0xfefffffe,
      0xffffffff, 0xfeffffff, 0xffffffff, 0xfffefffe, 0xffffffff, 0xfffeffff,
      0xffffffff, 0xffff7ffe, 0xffffffff, 0xffff7fff, 0xffffffff, 0xfffffffd,
      0x80000000, 0x00000000, 0xb776d5f5, 0x5634e2db, 0xffefffff, 0xffffffff,
      0xfff00000, 0x00000000, 0xfffeffff, 0xffffffff, 0xffff0000, 0x00000000,
      0xfffffffe, 0xffffffff, 0xffffffff, 0x00000000, 0xffffffff, 0xfeffffff,
      0xffffffff, 0xff000000, 0xffffffff, 0xfffeffff, 0xffffffff, 0xffff0000,
      0xffffffff, 0xffff7fff, 0xffffffff, 0xffff8000, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xffffffff, 0x80000000, 0x00000001, 0xb776d5f5, 0x5634e2dc,
      0xfff00000, 0x00000000, 0xfff00000, 0x00000001, 0xffff0000, 0x00000000,
      0xffff0000, 0x00000001, 0xffffffff, 0x00000000, 0xffffffff, 0x00000001,
      0xffffffff, 0xff000000, 0xffffffff, 0xff000001, 0xffffffff, 0xffff0000,
      0xffffffff, 0xffff0001, 0xffffffff, 0xffff8000, 0xffffffff, 0xffff8001,
      0xffffffff, 0xffffffff, 0x00000000, 0x00000000, 0x00000000, 0x00000001,
      0x80000000, 0x00000002, 0xb776d5f5, 0x5634e2dd, 0xfff00000, 0x00000001,
      0xfff00000, 0x00000002, 0xffff0000, 0x00000001, 0xffff0000, 0x00000002,
      0xffffffff, 0x00000001, 0xffffffff, 0x00000002, 0xffffffff, 0xff000001,
      0xffffffff, 0xff000002, 0xffffffff, 0xffff0001, 0xffffffff, 0xffff0002,
      0xffffffff, 0xffff8001, 0xffffffff, 0xffff8002, 0x00000000, 0x00000000,
      0x00000000, 0x00000001, 0x00000000, 0x00000002, 0x00000000, 0x00000003,
      0x80000000, 0x00007fff, 0xb776d5f5, 0x563562da, 0xfff00000, 0x00007ffe,
      0xfff00000, 0x00007fff, 0xffff0000, 0x00007ffe, 0xffff0000, 0x00007fff,
      0xffffffff, 0x00007ffe, 0xffffffff, 0x00007fff, 0xffffffff, 0xff007ffe,
      0xffffffff, 0xff007fff, 0xffffffff, 0xffff7ffe, 0xffffffff, 0xffff7fff,
      0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff, 0x00000000, 0x00007ffd,
      0x00000000, 0x00007ffe, 0x00000000, 0x00007fff, 0x00000000, 0x00008000,
      0x00000000, 0x00008001, 0x80000000, 0x00008000, 0xb776d5f5, 0x563562db,
      0xfff00000, 0x00007fff, 0xfff00000, 0x00008000, 0xffff0000, 0x00007fff,
      0xffff0000, 0x00008000, 0xffffffff, 0x00007fff, 0xffffffff, 0x00008000,
      0xffffffff, 0xff007fff, 0xffffffff, 0xff008000, 0xffffffff, 0xffff7fff,
      0xffffffff, 0xffff8000, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00007ffe, 0x00000000, 0x00007fff, 0x00000000, 0x00008000,
      0x00000000, 0x00008001, 0x00000000, 0x00008002, 0x00000000, 0x0000ffff,
      0x80000000, 0x0000ffff, 0xb776d5f5, 0x5635e2da, 0xfff00000, 0x0000fffe,
      0xfff00000, 0x0000ffff, 0xffff0000, 0x0000fffe, 0xffff0000, 0x0000ffff,
      0xffffffff, 0x0000fffe, 0xffffffff, 0x0000ffff, 0xffffffff, 0xff00fffe,
      0xffffffff, 0xff00ffff, 0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff,
      0x00000000, 0x00007ffe, 0x00000000, 0x00007fff, 0x00000000, 0x0000fffd,
      0x00000000, 0x0000fffe, 0x00000000, 0x0000ffff, 0x00000000, 0x00010000,
      0x00000000, 0x00010001, 0x00000000, 0x00017ffe, 0x00000000, 0x00017fff,
      0x80000000, 0x00010000, 0xb776d5f5, 0x5635e2db, 0xfff00000, 0x0000ffff,
      0xfff00000, 0x00010000, 0xffff0000, 0x0000ffff, 0xffff0000, 0x00010000,
      0xffffffff, 0x0000ffff, 0xffffffff, 0x00010000, 0xffffffff, 0xff00ffff,
      0xffffffff, 0xff010000, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00007fff, 0x00000000, 0x00008000, 0x00000000, 0x0000fffe,
      0x00000000, 0x0000ffff, 0x00000000, 0x00010000, 0x00000000, 0x00010001,
      0x00000000, 0x00010002, 0x00000000, 0x00017fff, 0x00000000, 0x00018000,
      0x00000000, 0x0001ffff, 0x80000000, 0x00ffffff, 0xb776d5f5, 0x5734e2da,
      0xfff00000, 0x00fffffe, 0xfff00000, 0x00ffffff, 0xffff0000, 0x00fffffe,
      0xffff0000, 0x00ffffff, 0xffffffff, 0x00fffffe, 0xffffffff, 0x00ffffff,
      0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff, 0x00000000, 0x00fefffe,
      0x00000000, 0x00feffff, 0x00000000, 0x00ff7ffe, 0x00000000, 0x00ff7fff,
      0x00000000, 0x00fffffd, 0x00000000, 0x00fffffe, 0x00000000, 0x00ffffff,
      0x00000000, 0x01000000, 0x00000000, 0x01000001, 0x00000000, 0x01007ffe,
      0x00000000, 0x01007fff, 0x00000000, 0x0100fffe, 0x00000000, 0x0100ffff,
      0x80000000, 0x01000000, 0xb776d5f5, 0x5734e2db, 0xfff00000, 0x00ffffff,
      0xfff00000, 0x01000000, 0xffff0000, 0x00ffffff, 0xffff0000, 0x01000000,
      0xffffffff, 0x00ffffff, 0xffffffff, 0x01000000, 0xffffffff, 0xffffffff,
      0x00000000, 0x00000000, 0x00000000, 0x00feffff, 0x00000000, 0x00ff0000,
      0x00000000, 0x00ff7fff, 0x00000000, 0x00ff8000, 0x00000000, 0x00fffffe,
      0x00000000, 0x00ffffff, 0x00000000, 0x01000000, 0x00000000, 0x01000001,
      0x00000000, 0x01000002, 0x00000000, 0x01007fff, 0x00000000, 0x01008000,
      0x00000000, 0x0100ffff, 0x00000000, 0x01010000, 0x00000000, 0x01ffffff,
      0x80000000, 0x5634e2db, 0xb776d5f5, 0xac69c5b6, 0xfff00000, 0x5634e2da,
      0xfff00000, 0x5634e2db, 0xffff0000, 0x5634e2da, 0xffff0000, 0x5634e2db,
      0xffffffff, 0x5634e2da, 0xffffffff, 0x5634e2db, 0x00000000, 0x5534e2da,
      0x00000000, 0x5534e2db, 0x00000000, 0x5633e2da, 0x00000000, 0x5633e2db,
      0x00000000, 0x563462da, 0x00000000, 0x563462db, 0x00000000, 0x5634e2d9,
      0x00000000, 0x5634e2da, 0x00000000, 0x5634e2db, 0x00000000, 0x5634e2dc,
      0x00000000, 0x5634e2dd, 0x00000000, 0x563562da, 0x00000000, 0x563562db,
      0x00000000, 0x5635e2da, 0x00000000, 0x5635e2db, 0x00000000, 0x5734e2da,
      0x00000000, 0x5734e2db, 0x80000000, 0xb776d5f5, 0xb776d5f6, 0x0dabb8d0,
      0xfff00000, 0xb776d5f4, 0xfff00000, 0xb776d5f5, 0xffff0000, 0xb776d5f4,
      0xffff0000, 0xb776d5f5, 0xffffffff, 0xb776d5f4, 0xffffffff, 0xb776d5f5,
      0x00000000, 0xb676d5f4, 0x00000000, 0xb676d5f5, 0x00000000, 0xb775d5f4,
      0x00000000, 0xb775d5f5, 0x00000000, 0xb77655f4, 0x00000000, 0xb77655f5,
      0x00000000, 0xb776d5f3, 0x00000000, 0xb776d5f4, 0x00000000, 0xb776d5f5,
      0x00000000, 0xb776d5f6, 0x00000000, 0xb776d5f7, 0x00000000, 0xb77755f4,
      0x00000000, 0xb77755f5, 0x00000000, 0xb777d5f4, 0x00000000, 0xb777d5f5,
      0x00000000, 0xb876d5f4, 0x00000000, 0xb876d5f5, 0x00000001, 0x0dabb8d0,
      0x80000000, 0xffffffff, 0xb776d5f6, 0x5634e2da, 0xfff00000, 0xfffffffe,
      0xfff00000, 0xffffffff, 0xffff0000, 0xfffffffe, 0xffff0000, 0xffffffff,
      0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff, 0x00000000, 0xfefffffe,
      0x00000000, 0xfeffffff, 0x00000000, 0xfffefffe, 0x00000000, 0xfffeffff,
      0x00000000, 0xffff7ffe, 0x00000000, 0xffff7fff, 0x00000000, 0xfffffffd,
      0x00000000, 0xfffffffe, 0x00000000, 0xffffffff, 0x00000001, 0x00000000,
      0x00000001, 0x00000001, 0x00000001, 0x00007ffe, 0x00000001, 0x00007fff,
      0x00000001, 0x0000fffe, 0x00000001, 0x0000ffff, 0x00000001, 0x00fffffe,
      0x00000001, 0x00ffffff, 0x00000001, 0x5634e2da, 0x00000001, 0xb776d5f4,
      0x80000001, 0x00000000, 0xb776d5f6, 0x5634e2db, 0xfff00000, 0xffffffff,
      0xfff00001, 0x00000000, 0xffff0000, 0xffffffff, 0xffff0001, 0x00000000,
      0xffffffff, 0xffffffff, 0x00000000, 0x00000000, 0x00000000, 0xfeffffff,
      0x00000000, 0xff000000, 0x00000000, 0xfffeffff, 0x00000000, 0xffff0000,
      0x00000000, 0xffff7fff, 0x00000000, 0xffff8000, 0x00000000, 0xfffffffe,
      0x00000000, 0xffffffff, 0x00000001, 0x00000000, 0x00000001, 0x00000001,
      0x00000001, 0x00000002, 0x00000001, 0x00007fff, 0x00000001, 0x00008000,
      0x00000001, 0x0000ffff, 0x00000001, 0x00010000, 0x00000001, 0x00ffffff,
      0x00000001, 0x01000000, 0x00000001, 0x5634e2db, 0x00000001, 0xb776d5f5,
      0x00000001, 0xffffffff, 0x8000ffff, 0xffffffff, 0xb777d5f5, 0x5634e2da,
      0xfff0ffff, 0xfffffffe, 0xfff0ffff, 0xffffffff, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xffffffff, 0x0000fffe, 0xfffffffe, 0x0000fffe, 0xffffffff,
      0x0000ffff, 0xfefffffe, 0x0000ffff, 0xfeffffff, 0x0000ffff, 0xfffefffe,
      0x0000ffff, 0xfffeffff, 0x0000ffff, 0xffff7ffe, 0x0000ffff, 0xffff7fff,
      0x0000ffff, 0xfffffffd, 0x0000ffff, 0xfffffffe, 0x0000ffff, 0xffffffff,
      0x00010000, 0x00000000, 0x00010000, 0x00000001, 0x00010000, 0x00007ffe,
      0x00010000, 0x00007fff, 0x00010000, 0x0000fffe, 0x00010000, 0x0000ffff,
      0x00010000, 0x00fffffe, 0x00010000, 0x00ffffff, 0x00010000, 0x5634e2da,
      0x00010000, 0xb776d5f4, 0x00010000, 0xfffffffe, 0x00010000, 0xffffffff,
      0x80010000, 0x00000000, 0xb777d5f5, 0x5634e2db, 0xfff0ffff, 0xffffffff,
      0xfff10000, 0x00000000, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x0000fffe, 0xffffffff, 0x0000ffff, 0x00000000, 0x0000ffff, 0xfeffffff,
      0x0000ffff, 0xff000000, 0x0000ffff, 0xfffeffff, 0x0000ffff, 0xffff0000,
      0x0000ffff, 0xffff7fff, 0x0000ffff, 0xffff8000, 0x0000ffff, 0xfffffffe,
      0x0000ffff, 0xffffffff, 0x00010000, 0x00000000, 0x00010000, 0x00000001,
      0x00010000, 0x00000002, 0x00010000, 0x00007fff, 0x00010000, 0x00008000,
      0x00010000, 0x0000ffff, 0x00010000, 0x00010000, 0x00010000, 0x00ffffff,
      0x00010000, 0x01000000, 0x00010000, 0x5634e2db, 0x00010000, 0xb776d5f5,
      0x00010000, 0xffffffff, 0x00010001, 0x00000000, 0x0001ffff, 0xffffffff,
      0x800fffff, 0xffffffff, 0xb786d5f5, 0x5634e2da, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xffffffff, 0x000effff, 0xfffffffe, 0x000effff, 0xffffffff,
      0x000ffffe, 0xfffffffe, 0x000ffffe, 0xffffffff, 0x000fffff, 0xfefffffe,
      0x000fffff, 0xfeffffff, 0x000fffff, 0xfffefffe, 0x000fffff, 0xfffeffff,
      0x000fffff, 0xffff7ffe, 0x000fffff, 0xffff7fff, 0x000fffff, 0xfffffffd,
      0x000fffff, 0xfffffffe, 0x000fffff, 0xffffffff, 0x00100000, 0x00000000,
      0x00100000, 0x00000001, 0x00100000, 0x00007ffe, 0x00100000, 0x00007fff,
      0x00100000, 0x0000fffe, 0x00100000, 0x0000ffff, 0x00100000, 0x00fffffe,
      0x00100000, 0x00ffffff, 0x00100000, 0x5634e2da, 0x00100000, 0xb776d5f4,
      0x00100000, 0xfffffffe, 0x00100000, 0xffffffff, 0x0010ffff, 0xfffffffe,
      0x0010ffff, 0xffffffff, 0x80100000, 0x00000000, 0xb786d5f5, 0x5634e2db,
      0xffffffff, 0xffffffff, 0x00000000, 0x00000000, 0x000effff, 0xffffffff,
      0x000f0000, 0x00000000, 0x000ffffe, 0xffffffff, 0x000fffff, 0x00000000,
      0x000fffff, 0xfeffffff, 0x000fffff, 0xff000000, 0x000fffff, 0xfffeffff,
      0x000fffff, 0xffff0000, 0x000fffff, 0xffff7fff, 0x000fffff, 0xffff8000,
      0x000fffff, 0xfffffffe, 0x000fffff, 0xffffffff, 0x00100000, 0x00000000,
      0x00100000, 0x00000001, 0x00100000, 0x00000002, 0x00100000, 0x00007fff,
      0x00100000, 0x00008000, 0x00100000, 0x0000ffff, 0x00100000, 0x00010000,
      0x00100000, 0x00ffffff, 0x00100000, 0x01000000, 0x00100000, 0x5634e2db,
      0x00100000, 0xb776d5f5, 0x00100000, 0xffffffff, 0x00100001, 0x00000000,
      0x0010ffff, 0xffffffff, 0x00110000, 0x00000000, 0x001fffff, 0xffffffff,
      0xd634e2db, 0xb776d5f5, 0x0dabb8d1, 0x0dabb8d0, 0x5624e2db, 0xb776d5f4,
      0x5624e2db, 0xb776d5f5, 0x5633e2db, 0xb776d5f4, 0x5633e2db, 0xb776d5f5,
      0x5634e2da, 0xb776d5f4, 0x5634e2da, 0xb776d5f5, 0x5634e2db, 0xb676d5f4,
      0x5634e2db, 0xb676d5f5, 0x5634e2db, 0xb775d5f4, 0x5634e2db, 0xb775d5f5,
      0x5634e2db, 0xb77655f4, 0x5634e2db, 0xb77655f5, 0x5634e2db, 0xb776d5f3,
      0x5634e2db, 0xb776d5f4, 0x5634e2db, 0xb776d5f5, 0x5634e2db, 0xb776d5f6,
      0x5634e2db, 0xb776d5f7, 0x5634e2db, 0xb77755f4, 0x5634e2db, 0xb77755f5,
      0x5634e2db, 0xb777d5f4, 0x5634e2db, 0xb777d5f5, 0x5634e2db, 0xb876d5f4,
      0x5634e2db, 0xb876d5f5, 0x5634e2dc, 0x0dabb8d0, 0x5634e2dc, 0x6eedabea,
      0x5634e2dc, 0xb776d5f4, 0x5634e2dc, 0xb776d5f5, 0x5635e2db, 0xb776d5f4,
      0x5635e2db, 0xb776d5f5, 0x5644e2db, 0xb776d5f4, 0x5644e2db, 0xb776d5f5,
      0xffffffff, 0xffffffff, 0x3776d5f5, 0x5634e2da, 0x7fefffff, 0xfffffffe,
      0x7fefffff, 0xffffffff, 0x7ffeffff, 0xfffffffe, 0x7ffeffff, 0xffffffff,
      0x7ffffffe, 0xfffffffe, 0x7ffffffe, 0xffffffff, 0x7fffffff, 0xfefffffe,
      0x7fffffff, 0xfeffffff, 0x7fffffff, 0xfffefffe, 0x7fffffff, 0xfffeffff,
      0x7fffffff, 0xffff7ffe, 0x7fffffff, 0xffff7fff, 0x7fffffff, 0xfffffffd,
      0x7fffffff, 0xfffffffe, 0x7fffffff, 0xffffffff, 0x80000000, 0x00000000,
      0x80000000, 0x00000001, 0x80000000, 0x00007ffe, 0x80000000, 0x00007fff,
      0x80000000, 0x0000fffe, 0x80000000, 0x0000ffff, 0x80000000, 0x00fffffe,
      0x80000000, 0x00ffffff, 0x80000000, 0x5634e2da, 0x80000000, 0xb776d5f4,
      0x80000000, 0xfffffffe, 0x80000000, 0xffffffff, 0x8000ffff, 0xfffffffe,
      0x8000ffff, 0xffffffff, 0x800fffff, 0xfffffffe, 0x800fffff, 0xffffffff,
      0xd634e2db, 0xb776d5f4
    ];
toInt32s(TEST_ADD_BITS);

var TEST_SUB_BITS = [
      0x00000000, 0x00000000, 0xc8892a0a, 0xa9cb1d25, 0x80100000, 0x00000001,
      0x80100000, 0x00000000, 0x80010000, 0x00000001, 0x80010000, 0x00000000,
      0x80000001, 0x00000001, 0x80000001, 0x00000000, 0x80000000, 0x01000001,
      0x80000000, 0x01000000, 0x80000000, 0x00010001, 0x80000000, 0x00010000,
      0x80000000, 0x00008001, 0x80000000, 0x00008000, 0x80000000, 0x00000002,
      0x80000000, 0x00000001, 0x80000000, 0x00000000, 0x7fffffff, 0xffffffff,
      0x7fffffff, 0xfffffffe, 0x7fffffff, 0xffff8001, 0x7fffffff, 0xffff8000,
      0x7fffffff, 0xffff0001, 0x7fffffff, 0xffff0000, 0x7fffffff, 0xff000001,
      0x7fffffff, 0xff000000, 0x7fffffff, 0xa9cb1d25, 0x7fffffff, 0x48892a0b,
      0x7fffffff, 0x00000001, 0x7fffffff, 0x00000000, 0x7fff0000, 0x00000001,
      0x7fff0000, 0x00000000, 0x7ff00000, 0x00000001, 0x7ff00000, 0x00000000,
      0x29cb1d24, 0x48892a0b, 0x00000000, 0x00000001, 0x3776d5f5, 0x5634e2db,
      0x00000000, 0x00000000, 0xb786d5f5, 0x5634e2dc, 0xb786d5f5, 0x5634e2db,
      0xb777d5f5, 0x5634e2dc, 0xb777d5f5, 0x5634e2db, 0xb776d5f6, 0x5634e2dc,
      0xb776d5f6, 0x5634e2db, 0xb776d5f5, 0x5734e2dc, 0xb776d5f5, 0x5734e2db,
      0xb776d5f5, 0x5635e2dc, 0xb776d5f5, 0x5635e2db, 0xb776d5f5, 0x563562dc,
      0xb776d5f5, 0x563562db, 0xb776d5f5, 0x5634e2dd, 0xb776d5f5, 0x5634e2dc,
      0xb776d5f5, 0x5634e2db, 0xb776d5f5, 0x5634e2da, 0xb776d5f5, 0x5634e2d9,
      0xb776d5f5, 0x563462dc, 0xb776d5f5, 0x563462db, 0xb776d5f5, 0x5633e2dc,
      0xb776d5f5, 0x5633e2db, 0xb776d5f5, 0x5534e2dc, 0xb776d5f5, 0x5534e2db,
      0xb776d5f5, 0x00000000, 0xb776d5f4, 0x9ebe0ce6, 0xb776d5f4, 0x5634e2dc,
      0xb776d5f4, 0x5634e2db, 0xb775d5f5, 0x5634e2dc, 0xb775d5f5, 0x5634e2db,
      0xb766d5f5, 0x5634e2dc, 0xb766d5f5, 0x5634e2db, 0x6141f319, 0x9ebe0ce6,
      0x3776d5f5, 0x5634e2dc, 0x7fefffff, 0xffffffff, 0x48792a0a, 0xa9cb1d24,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xfff10000, 0x00000000,
      0xfff0ffff, 0xffffffff, 0xfff00001, 0x00000000, 0xfff00000, 0xffffffff,
      0xfff00000, 0x01000000, 0xfff00000, 0x00ffffff, 0xfff00000, 0x00010000,
      0xfff00000, 0x0000ffff, 0xfff00000, 0x00008000, 0xfff00000, 0x00007fff,
      0xfff00000, 0x00000001, 0xfff00000, 0x00000000, 0xffefffff, 0xffffffff,
      0xffefffff, 0xfffffffe, 0xffefffff, 0xfffffffd, 0xffefffff, 0xffff8000,
      0xffefffff, 0xffff7fff, 0xffefffff, 0xffff0000, 0xffefffff, 0xfffeffff,
      0xffefffff, 0xff000000, 0xffefffff, 0xfeffffff, 0xffefffff, 0xa9cb1d24,
      0xffefffff, 0x48892a0a, 0xffefffff, 0x00000000, 0xffeffffe, 0xffffffff,
      0xffef0000, 0x00000000, 0xffeeffff, 0xffffffff, 0xffe00000, 0x00000000,
      0xffdfffff, 0xffffffff, 0xa9bb1d24, 0x48892a0a, 0x7ff00000, 0x00000000,
      0x7ff00000, 0x00000000, 0x48792a0a, 0xa9cb1d25, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xfff10000, 0x00000001, 0xfff10000, 0x00000000,
      0xfff00001, 0x00000001, 0xfff00001, 0x00000000, 0xfff00000, 0x01000001,
      0xfff00000, 0x01000000, 0xfff00000, 0x00010001, 0xfff00000, 0x00010000,
      0xfff00000, 0x00008001, 0xfff00000, 0x00008000, 0xfff00000, 0x00000002,
      0xfff00000, 0x00000001, 0xfff00000, 0x00000000, 0xffefffff, 0xffffffff,
      0xffefffff, 0xfffffffe, 0xffefffff, 0xffff8001, 0xffefffff, 0xffff8000,
      0xffefffff, 0xffff0001, 0xffefffff, 0xffff0000, 0xffefffff, 0xff000001,
      0xffefffff, 0xff000000, 0xffefffff, 0xa9cb1d25, 0xffefffff, 0x48892a0b,
      0xffefffff, 0x00000001, 0xffefffff, 0x00000000, 0xffef0000, 0x00000001,
      0xffef0000, 0x00000000, 0xffe00000, 0x00000001, 0xffe00000, 0x00000000,
      0xa9bb1d24, 0x48892a0b, 0x7ff00000, 0x00000001, 0x7ffeffff, 0xffffffff,
      0x48882a0a, 0xa9cb1d24, 0x000f0000, 0x00000000, 0x000effff, 0xffffffff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffff0001, 0x00000000,
      0xffff0000, 0xffffffff, 0xffff0000, 0x01000000, 0xffff0000, 0x00ffffff,
      0xffff0000, 0x00010000, 0xffff0000, 0x0000ffff, 0xffff0000, 0x00008000,
      0xffff0000, 0x00007fff, 0xffff0000, 0x00000001, 0xffff0000, 0x00000000,
      0xfffeffff, 0xffffffff, 0xfffeffff, 0xfffffffe, 0xfffeffff, 0xfffffffd,
      0xfffeffff, 0xffff8000, 0xfffeffff, 0xffff7fff, 0xfffeffff, 0xffff0000,
      0xfffeffff, 0xfffeffff, 0xfffeffff, 0xff000000, 0xfffeffff, 0xfeffffff,
      0xfffeffff, 0xa9cb1d24, 0xfffeffff, 0x48892a0a, 0xfffeffff, 0x00000000,
      0xfffefffe, 0xffffffff, 0xfffe0000, 0x00000000, 0xfffdffff, 0xffffffff,
      0xffef0000, 0x00000000, 0xffeeffff, 0xffffffff, 0xa9ca1d24, 0x48892a0a,
      0x7fff0000, 0x00000000, 0x7fff0000, 0x00000000, 0x48882a0a, 0xa9cb1d25,
      0x000f0000, 0x00000001, 0x000f0000, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffff0001, 0x00000001, 0xffff0001, 0x00000000,
      0xffff0000, 0x01000001, 0xffff0000, 0x01000000, 0xffff0000, 0x00010001,
      0xffff0000, 0x00010000, 0xffff0000, 0x00008001, 0xffff0000, 0x00008000,
      0xffff0000, 0x00000002, 0xffff0000, 0x00000001, 0xffff0000, 0x00000000,
      0xfffeffff, 0xffffffff, 0xfffeffff, 0xfffffffe, 0xfffeffff, 0xffff8001,
      0xfffeffff, 0xffff8000, 0xfffeffff, 0xffff0001, 0xfffeffff, 0xffff0000,
      0xfffeffff, 0xff000001, 0xfffeffff, 0xff000000, 0xfffeffff, 0xa9cb1d25,
      0xfffeffff, 0x48892a0b, 0xfffeffff, 0x00000001, 0xfffeffff, 0x00000000,
      0xfffe0000, 0x00000001, 0xfffe0000, 0x00000000, 0xffef0000, 0x00000001,
      0xffef0000, 0x00000000, 0xa9ca1d24, 0x48892a0b, 0x7fff0000, 0x00000001,
      0x7ffffffe, 0xffffffff, 0x48892a09, 0xa9cb1d24, 0x000fffff, 0x00000000,
      0x000ffffe, 0xffffffff, 0x0000ffff, 0x00000000, 0x0000fffe, 0xffffffff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0x01000000,
      0xffffffff, 0x00ffffff, 0xffffffff, 0x00010000, 0xffffffff, 0x0000ffff,
      0xffffffff, 0x00008000, 0xffffffff, 0x00007fff, 0xffffffff, 0x00000001,
      0xffffffff, 0x00000000, 0xfffffffe, 0xffffffff, 0xfffffffe, 0xfffffffe,
      0xfffffffe, 0xfffffffd, 0xfffffffe, 0xffff8000, 0xfffffffe, 0xffff7fff,
      0xfffffffe, 0xffff0000, 0xfffffffe, 0xfffeffff, 0xfffffffe, 0xff000000,
      0xfffffffe, 0xfeffffff, 0xfffffffe, 0xa9cb1d24, 0xfffffffe, 0x48892a0a,
      0xfffffffe, 0x00000000, 0xfffffffd, 0xffffffff, 0xfffeffff, 0x00000000,
      0xfffefffe, 0xffffffff, 0xffefffff, 0x00000000, 0xffeffffe, 0xffffffff,
      0xa9cb1d23, 0x48892a0a, 0x7fffffff, 0x00000000, 0x7fffffff, 0x00000000,
      0x48892a09, 0xa9cb1d25, 0x000fffff, 0x00000001, 0x000fffff, 0x00000000,
      0x0000ffff, 0x00000001, 0x0000ffff, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0x01000001, 0xffffffff, 0x01000000,
      0xffffffff, 0x00010001, 0xffffffff, 0x00010000, 0xffffffff, 0x00008001,
      0xffffffff, 0x00008000, 0xffffffff, 0x00000002, 0xffffffff, 0x00000001,
      0xffffffff, 0x00000000, 0xfffffffe, 0xffffffff, 0xfffffffe, 0xfffffffe,
      0xfffffffe, 0xffff8001, 0xfffffffe, 0xffff8000, 0xfffffffe, 0xffff0001,
      0xfffffffe, 0xffff0000, 0xfffffffe, 0xff000001, 0xfffffffe, 0xff000000,
      0xfffffffe, 0xa9cb1d25, 0xfffffffe, 0x48892a0b, 0xfffffffe, 0x00000001,
      0xfffffffe, 0x00000000, 0xfffeffff, 0x00000001, 0xfffeffff, 0x00000000,
      0xffefffff, 0x00000001, 0xffefffff, 0x00000000, 0xa9cb1d23, 0x48892a0b,
      0x7fffffff, 0x00000001, 0x7fffffff, 0xfeffffff, 0x48892a0a, 0xa8cb1d24,
      0x000fffff, 0xff000000, 0x000fffff, 0xfeffffff, 0x0000ffff, 0xff000000,
      0x0000ffff, 0xfeffffff, 0x00000000, 0xff000000, 0x00000000, 0xfeffffff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xff010000,
      0xffffffff, 0xff00ffff, 0xffffffff, 0xff008000, 0xffffffff, 0xff007fff,
      0xffffffff, 0xff000001, 0xffffffff, 0xff000000, 0xffffffff, 0xfeffffff,
      0xffffffff, 0xfefffffe, 0xffffffff, 0xfefffffd, 0xffffffff, 0xfeff8000,
      0xffffffff, 0xfeff7fff, 0xffffffff, 0xfeff0000, 0xffffffff, 0xfefeffff,
      0xffffffff, 0xfe000000, 0xffffffff, 0xfdffffff, 0xffffffff, 0xa8cb1d24,
      0xffffffff, 0x47892a0a, 0xfffffffe, 0xff000000, 0xfffffffe, 0xfeffffff,
      0xfffeffff, 0xff000000, 0xfffeffff, 0xfeffffff, 0xffefffff, 0xff000000,
      0xffefffff, 0xfeffffff, 0xa9cb1d24, 0x47892a0a, 0x7fffffff, 0xff000000,
      0x7fffffff, 0xff000000, 0x48892a0a, 0xa8cb1d25, 0x000fffff, 0xff000001,
      0x000fffff, 0xff000000, 0x0000ffff, 0xff000001, 0x0000ffff, 0xff000000,
      0x00000000, 0xff000001, 0x00000000, 0xff000000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xff010001, 0xffffffff, 0xff010000,
      0xffffffff, 0xff008001, 0xffffffff, 0xff008000, 0xffffffff, 0xff000002,
      0xffffffff, 0xff000001, 0xffffffff, 0xff000000, 0xffffffff, 0xfeffffff,
      0xffffffff, 0xfefffffe, 0xffffffff, 0xfeff8001, 0xffffffff, 0xfeff8000,
      0xffffffff, 0xfeff0001, 0xffffffff, 0xfeff0000, 0xffffffff, 0xfe000001,
      0xffffffff, 0xfe000000, 0xffffffff, 0xa8cb1d25, 0xffffffff, 0x47892a0b,
      0xfffffffe, 0xff000001, 0xfffffffe, 0xff000000, 0xfffeffff, 0xff000001,
      0xfffeffff, 0xff000000, 0xffefffff, 0xff000001, 0xffefffff, 0xff000000,
      0xa9cb1d24, 0x47892a0b, 0x7fffffff, 0xff000001, 0x7fffffff, 0xfffeffff,
      0x48892a0a, 0xa9ca1d24, 0x000fffff, 0xffff0000, 0x000fffff, 0xfffeffff,
      0x0000ffff, 0xffff0000, 0x0000ffff, 0xfffeffff, 0x00000000, 0xffff0000,
      0x00000000, 0xfffeffff, 0x00000000, 0x00ff0000, 0x00000000, 0x00feffff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xffff8000,
      0xffffffff, 0xffff7fff, 0xffffffff, 0xffff0001, 0xffffffff, 0xffff0000,
      0xffffffff, 0xfffeffff, 0xffffffff, 0xfffefffe, 0xffffffff, 0xfffefffd,
      0xffffffff, 0xfffe8000, 0xffffffff, 0xfffe7fff, 0xffffffff, 0xfffe0000,
      0xffffffff, 0xfffdffff, 0xffffffff, 0xfeff0000, 0xffffffff, 0xfefeffff,
      0xffffffff, 0xa9ca1d24, 0xffffffff, 0x48882a0a, 0xfffffffe, 0xffff0000,
      0xfffffffe, 0xfffeffff, 0xfffeffff, 0xffff0000, 0xfffeffff, 0xfffeffff,
      0xffefffff, 0xffff0000, 0xffefffff, 0xfffeffff, 0xa9cb1d24, 0x48882a0a,
      0x7fffffff, 0xffff0000, 0x7fffffff, 0xffff0000, 0x48892a0a, 0xa9ca1d25,
      0x000fffff, 0xffff0001, 0x000fffff, 0xffff0000, 0x0000ffff, 0xffff0001,
      0x0000ffff, 0xffff0000, 0x00000000, 0xffff0001, 0x00000000, 0xffff0000,
      0x00000000, 0x00ff0001, 0x00000000, 0x00ff0000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xffff8001, 0xffffffff, 0xffff8000,
      0xffffffff, 0xffff0002, 0xffffffff, 0xffff0001, 0xffffffff, 0xffff0000,
      0xffffffff, 0xfffeffff, 0xffffffff, 0xfffefffe, 0xffffffff, 0xfffe8001,
      0xffffffff, 0xfffe8000, 0xffffffff, 0xfffe0001, 0xffffffff, 0xfffe0000,
      0xffffffff, 0xfeff0001, 0xffffffff, 0xfeff0000, 0xffffffff, 0xa9ca1d25,
      0xffffffff, 0x48882a0b, 0xfffffffe, 0xffff0001, 0xfffffffe, 0xffff0000,
      0xfffeffff, 0xffff0001, 0xfffeffff, 0xffff0000, 0xffefffff, 0xffff0001,
      0xffefffff, 0xffff0000, 0xa9cb1d24, 0x48882a0b, 0x7fffffff, 0xffff0001,
      0x7fffffff, 0xffff7fff, 0x48892a0a, 0xa9ca9d24, 0x000fffff, 0xffff8000,
      0x000fffff, 0xffff7fff, 0x0000ffff, 0xffff8000, 0x0000ffff, 0xffff7fff,
      0x00000000, 0xffff8000, 0x00000000, 0xffff7fff, 0x00000000, 0x00ff8000,
      0x00000000, 0x00ff7fff, 0x00000000, 0x00008000, 0x00000000, 0x00007fff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xffff8001,
      0xffffffff, 0xffff8000, 0xffffffff, 0xffff7fff, 0xffffffff, 0xffff7ffe,
      0xffffffff, 0xffff7ffd, 0xffffffff, 0xffff0000, 0xffffffff, 0xfffeffff,
      0xffffffff, 0xfffe8000, 0xffffffff, 0xfffe7fff, 0xffffffff, 0xfeff8000,
      0xffffffff, 0xfeff7fff, 0xffffffff, 0xa9ca9d24, 0xffffffff, 0x4888aa0a,
      0xfffffffe, 0xffff8000, 0xfffffffe, 0xffff7fff, 0xfffeffff, 0xffff8000,
      0xfffeffff, 0xffff7fff, 0xffefffff, 0xffff8000, 0xffefffff, 0xffff7fff,
      0xa9cb1d24, 0x4888aa0a, 0x7fffffff, 0xffff8000, 0x7fffffff, 0xffff8000,
      0x48892a0a, 0xa9ca9d25, 0x000fffff, 0xffff8001, 0x000fffff, 0xffff8000,
      0x0000ffff, 0xffff8001, 0x0000ffff, 0xffff8000, 0x00000000, 0xffff8001,
      0x00000000, 0xffff8000, 0x00000000, 0x00ff8001, 0x00000000, 0x00ff8000,
      0x00000000, 0x00008001, 0x00000000, 0x00008000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xffff8002, 0xffffffff, 0xffff8001,
      0xffffffff, 0xffff8000, 0xffffffff, 0xffff7fff, 0xffffffff, 0xffff7ffe,
      0xffffffff, 0xffff0001, 0xffffffff, 0xffff0000, 0xffffffff, 0xfffe8001,
      0xffffffff, 0xfffe8000, 0xffffffff, 0xfeff8001, 0xffffffff, 0xfeff8000,
      0xffffffff, 0xa9ca9d25, 0xffffffff, 0x4888aa0b, 0xfffffffe, 0xffff8001,
      0xfffffffe, 0xffff8000, 0xfffeffff, 0xffff8001, 0xfffeffff, 0xffff8000,
      0xffefffff, 0xffff8001, 0xffefffff, 0xffff8000, 0xa9cb1d24, 0x4888aa0b,
      0x7fffffff, 0xffff8001, 0x7fffffff, 0xfffffffe, 0x48892a0a, 0xa9cb1d23,
      0x000fffff, 0xffffffff, 0x000fffff, 0xfffffffe, 0x0000ffff, 0xffffffff,
      0x0000ffff, 0xfffffffe, 0x00000000, 0xffffffff, 0x00000000, 0xfffffffe,
      0x00000000, 0x00ffffff, 0x00000000, 0x00fffffe, 0x00000000, 0x0000ffff,
      0x00000000, 0x0000fffe, 0x00000000, 0x00007fff, 0x00000000, 0x00007ffe,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xfffffffd, 0xffffffff, 0xfffffffc, 0xffffffff, 0xffff7fff,
      0xffffffff, 0xffff7ffe, 0xffffffff, 0xfffeffff, 0xffffffff, 0xfffefffe,
      0xffffffff, 0xfeffffff, 0xffffffff, 0xfefffffe, 0xffffffff, 0xa9cb1d23,
      0xffffffff, 0x48892a09, 0xfffffffe, 0xffffffff, 0xfffffffe, 0xfffffffe,
      0xfffeffff, 0xffffffff, 0xfffeffff, 0xfffffffe, 0xffefffff, 0xffffffff,
      0xffefffff, 0xfffffffe, 0xa9cb1d24, 0x48892a09, 0x7fffffff, 0xffffffff,
      0x7fffffff, 0xffffffff, 0x48892a0a, 0xa9cb1d24, 0x00100000, 0x00000000,
      0x000fffff, 0xffffffff, 0x00010000, 0x00000000, 0x0000ffff, 0xffffffff,
      0x00000001, 0x00000000, 0x00000000, 0xffffffff, 0x00000000, 0x01000000,
      0x00000000, 0x00ffffff, 0x00000000, 0x00010000, 0x00000000, 0x0000ffff,
      0x00000000, 0x00008000, 0x00000000, 0x00007fff, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xfffffffd, 0xffffffff, 0xffff8000, 0xffffffff, 0xffff7fff,
      0xffffffff, 0xffff0000, 0xffffffff, 0xfffeffff, 0xffffffff, 0xff000000,
      0xffffffff, 0xfeffffff, 0xffffffff, 0xa9cb1d24, 0xffffffff, 0x48892a0a,
      0xffffffff, 0x00000000, 0xfffffffe, 0xffffffff, 0xffff0000, 0x00000000,
      0xfffeffff, 0xffffffff, 0xfff00000, 0x00000000, 0xffefffff, 0xffffffff,
      0xa9cb1d24, 0x48892a0a, 0x80000000, 0x00000000, 0x80000000, 0x00000000,
      0x48892a0a, 0xa9cb1d25, 0x00100000, 0x00000001, 0x00100000, 0x00000000,
      0x00010000, 0x00000001, 0x00010000, 0x00000000, 0x00000001, 0x00000001,
      0x00000001, 0x00000000, 0x00000000, 0x01000001, 0x00000000, 0x01000000,
      0x00000000, 0x00010001, 0x00000000, 0x00010000, 0x00000000, 0x00008001,
      0x00000000, 0x00008000, 0x00000000, 0x00000002, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xffff8001, 0xffffffff, 0xffff8000, 0xffffffff, 0xffff0001,
      0xffffffff, 0xffff0000, 0xffffffff, 0xff000001, 0xffffffff, 0xff000000,
      0xffffffff, 0xa9cb1d25, 0xffffffff, 0x48892a0b, 0xffffffff, 0x00000001,
      0xffffffff, 0x00000000, 0xffff0000, 0x00000001, 0xffff0000, 0x00000000,
      0xfff00000, 0x00000001, 0xfff00000, 0x00000000, 0xa9cb1d24, 0x48892a0b,
      0x80000000, 0x00000001, 0x80000000, 0x00000001, 0x48892a0a, 0xa9cb1d26,
      0x00100000, 0x00000002, 0x00100000, 0x00000001, 0x00010000, 0x00000002,
      0x00010000, 0x00000001, 0x00000001, 0x00000002, 0x00000001, 0x00000001,
      0x00000000, 0x01000002, 0x00000000, 0x01000001, 0x00000000, 0x00010002,
      0x00000000, 0x00010001, 0x00000000, 0x00008002, 0x00000000, 0x00008001,
      0x00000000, 0x00000003, 0x00000000, 0x00000002, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xffff8002,
      0xffffffff, 0xffff8001, 0xffffffff, 0xffff0002, 0xffffffff, 0xffff0001,
      0xffffffff, 0xff000002, 0xffffffff, 0xff000001, 0xffffffff, 0xa9cb1d26,
      0xffffffff, 0x48892a0c, 0xffffffff, 0x00000002, 0xffffffff, 0x00000001,
      0xffff0000, 0x00000002, 0xffff0000, 0x00000001, 0xfff00000, 0x00000002,
      0xfff00000, 0x00000001, 0xa9cb1d24, 0x48892a0c, 0x80000000, 0x00000002,
      0x80000000, 0x00000002, 0x48892a0a, 0xa9cb1d27, 0x00100000, 0x00000003,
      0x00100000, 0x00000002, 0x00010000, 0x00000003, 0x00010000, 0x00000002,
      0x00000001, 0x00000003, 0x00000001, 0x00000002, 0x00000000, 0x01000003,
      0x00000000, 0x01000002, 0x00000000, 0x00010003, 0x00000000, 0x00010002,
      0x00000000, 0x00008003, 0x00000000, 0x00008002, 0x00000000, 0x00000004,
      0x00000000, 0x00000003, 0x00000000, 0x00000002, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xffff8003, 0xffffffff, 0xffff8002,
      0xffffffff, 0xffff0003, 0xffffffff, 0xffff0002, 0xffffffff, 0xff000003,
      0xffffffff, 0xff000002, 0xffffffff, 0xa9cb1d27, 0xffffffff, 0x48892a0d,
      0xffffffff, 0x00000003, 0xffffffff, 0x00000002, 0xffff0000, 0x00000003,
      0xffff0000, 0x00000002, 0xfff00000, 0x00000003, 0xfff00000, 0x00000002,
      0xa9cb1d24, 0x48892a0d, 0x80000000, 0x00000003, 0x80000000, 0x00007fff,
      0x48892a0a, 0xa9cb9d24, 0x00100000, 0x00008000, 0x00100000, 0x00007fff,
      0x00010000, 0x00008000, 0x00010000, 0x00007fff, 0x00000001, 0x00008000,
      0x00000001, 0x00007fff, 0x00000000, 0x01008000, 0x00000000, 0x01007fff,
      0x00000000, 0x00018000, 0x00000000, 0x00017fff, 0x00000000, 0x00010000,
      0x00000000, 0x0000ffff, 0x00000000, 0x00008001, 0x00000000, 0x00008000,
      0x00000000, 0x00007fff, 0x00000000, 0x00007ffe, 0x00000000, 0x00007ffd,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xffff8000,
      0xffffffff, 0xffff7fff, 0xffffffff, 0xff008000, 0xffffffff, 0xff007fff,
      0xffffffff, 0xa9cb9d24, 0xffffffff, 0x4889aa0a, 0xffffffff, 0x00008000,
      0xffffffff, 0x00007fff, 0xffff0000, 0x00008000, 0xffff0000, 0x00007fff,
      0xfff00000, 0x00008000, 0xfff00000, 0x00007fff, 0xa9cb1d24, 0x4889aa0a,
      0x80000000, 0x00008000, 0x80000000, 0x00008000, 0x48892a0a, 0xa9cb9d25,
      0x00100000, 0x00008001, 0x00100000, 0x00008000, 0x00010000, 0x00008001,
      0x00010000, 0x00008000, 0x00000001, 0x00008001, 0x00000001, 0x00008000,
      0x00000000, 0x01008001, 0x00000000, 0x01008000, 0x00000000, 0x00018001,
      0x00000000, 0x00018000, 0x00000000, 0x00010001, 0x00000000, 0x00010000,
      0x00000000, 0x00008002, 0x00000000, 0x00008001, 0x00000000, 0x00008000,
      0x00000000, 0x00007fff, 0x00000000, 0x00007ffe, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xffff8001, 0xffffffff, 0xffff8000,
      0xffffffff, 0xff008001, 0xffffffff, 0xff008000, 0xffffffff, 0xa9cb9d25,
      0xffffffff, 0x4889aa0b, 0xffffffff, 0x00008001, 0xffffffff, 0x00008000,
      0xffff0000, 0x00008001, 0xffff0000, 0x00008000, 0xfff00000, 0x00008001,
      0xfff00000, 0x00008000, 0xa9cb1d24, 0x4889aa0b, 0x80000000, 0x00008001,
      0x80000000, 0x0000ffff, 0x48892a0a, 0xa9cc1d24, 0x00100000, 0x00010000,
      0x00100000, 0x0000ffff, 0x00010000, 0x00010000, 0x00010000, 0x0000ffff,
      0x00000001, 0x00010000, 0x00000001, 0x0000ffff, 0x00000000, 0x01010000,
      0x00000000, 0x0100ffff, 0x00000000, 0x00020000, 0x00000000, 0x0001ffff,
      0x00000000, 0x00018000, 0x00000000, 0x00017fff, 0x00000000, 0x00010001,
      0x00000000, 0x00010000, 0x00000000, 0x0000ffff, 0x00000000, 0x0000fffe,
      0x00000000, 0x0000fffd, 0x00000000, 0x00008000, 0x00000000, 0x00007fff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xff010000,
      0xffffffff, 0xff00ffff, 0xffffffff, 0xa9cc1d24, 0xffffffff, 0x488a2a0a,
      0xffffffff, 0x00010000, 0xffffffff, 0x0000ffff, 0xffff0000, 0x00010000,
      0xffff0000, 0x0000ffff, 0xfff00000, 0x00010000, 0xfff00000, 0x0000ffff,
      0xa9cb1d24, 0x488a2a0a, 0x80000000, 0x00010000, 0x80000000, 0x00010000,
      0x48892a0a, 0xa9cc1d25, 0x00100000, 0x00010001, 0x00100000, 0x00010000,
      0x00010000, 0x00010001, 0x00010000, 0x00010000, 0x00000001, 0x00010001,
      0x00000001, 0x00010000, 0x00000000, 0x01010001, 0x00000000, 0x01010000,
      0x00000000, 0x00020001, 0x00000000, 0x00020000, 0x00000000, 0x00018001,
      0x00000000, 0x00018000, 0x00000000, 0x00010002, 0x00000000, 0x00010001,
      0x00000000, 0x00010000, 0x00000000, 0x0000ffff, 0x00000000, 0x0000fffe,
      0x00000000, 0x00008001, 0x00000000, 0x00008000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xff010001, 0xffffffff, 0xff010000,
      0xffffffff, 0xa9cc1d25, 0xffffffff, 0x488a2a0b, 0xffffffff, 0x00010001,
      0xffffffff, 0x00010000, 0xffff0000, 0x00010001, 0xffff0000, 0x00010000,
      0xfff00000, 0x00010001, 0xfff00000, 0x00010000, 0xa9cb1d24, 0x488a2a0b,
      0x80000000, 0x00010001, 0x80000000, 0x00ffffff, 0x48892a0a, 0xaacb1d24,
      0x00100000, 0x01000000, 0x00100000, 0x00ffffff, 0x00010000, 0x01000000,
      0x00010000, 0x00ffffff, 0x00000001, 0x01000000, 0x00000001, 0x00ffffff,
      0x00000000, 0x02000000, 0x00000000, 0x01ffffff, 0x00000000, 0x01010000,
      0x00000000, 0x0100ffff, 0x00000000, 0x01008000, 0x00000000, 0x01007fff,
      0x00000000, 0x01000001, 0x00000000, 0x01000000, 0x00000000, 0x00ffffff,
      0x00000000, 0x00fffffe, 0x00000000, 0x00fffffd, 0x00000000, 0x00ff8000,
      0x00000000, 0x00ff7fff, 0x00000000, 0x00ff0000, 0x00000000, 0x00feffff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xaacb1d24,
      0xffffffff, 0x49892a0a, 0xffffffff, 0x01000000, 0xffffffff, 0x00ffffff,
      0xffff0000, 0x01000000, 0xffff0000, 0x00ffffff, 0xfff00000, 0x01000000,
      0xfff00000, 0x00ffffff, 0xa9cb1d24, 0x49892a0a, 0x80000000, 0x01000000,
      0x80000000, 0x01000000, 0x48892a0a, 0xaacb1d25, 0x00100000, 0x01000001,
      0x00100000, 0x01000000, 0x00010000, 0x01000001, 0x00010000, 0x01000000,
      0x00000001, 0x01000001, 0x00000001, 0x01000000, 0x00000000, 0x02000001,
      0x00000000, 0x02000000, 0x00000000, 0x01010001, 0x00000000, 0x01010000,
      0x00000000, 0x01008001, 0x00000000, 0x01008000, 0x00000000, 0x01000002,
      0x00000000, 0x01000001, 0x00000000, 0x01000000, 0x00000000, 0x00ffffff,
      0x00000000, 0x00fffffe, 0x00000000, 0x00ff8001, 0x00000000, 0x00ff8000,
      0x00000000, 0x00ff0001, 0x00000000, 0x00ff0000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffffffff, 0xaacb1d25, 0xffffffff, 0x49892a0b,
      0xffffffff, 0x01000001, 0xffffffff, 0x01000000, 0xffff0000, 0x01000001,
      0xffff0000, 0x01000000, 0xfff00000, 0x01000001, 0xfff00000, 0x01000000,
      0xa9cb1d24, 0x49892a0b, 0x80000000, 0x01000001, 0x80000000, 0x5634e2db,
      0x48892a0b, 0x00000000, 0x00100000, 0x5634e2dc, 0x00100000, 0x5634e2db,
      0x00010000, 0x5634e2dc, 0x00010000, 0x5634e2db, 0x00000001, 0x5634e2dc,
      0x00000001, 0x5634e2db, 0x00000000, 0x5734e2dc, 0x00000000, 0x5734e2db,
      0x00000000, 0x5635e2dc, 0x00000000, 0x5635e2db, 0x00000000, 0x563562dc,
      0x00000000, 0x563562db, 0x00000000, 0x5634e2dd, 0x00000000, 0x5634e2dc,
      0x00000000, 0x5634e2db, 0x00000000, 0x5634e2da, 0x00000000, 0x5634e2d9,
      0x00000000, 0x563462dc, 0x00000000, 0x563462db, 0x00000000, 0x5633e2dc,
      0x00000000, 0x5633e2db, 0x00000000, 0x5534e2dc, 0x00000000, 0x5534e2db,
      0x00000000, 0x00000000, 0xffffffff, 0x9ebe0ce6, 0xffffffff, 0x5634e2dc,
      0xffffffff, 0x5634e2db, 0xffff0000, 0x5634e2dc, 0xffff0000, 0x5634e2db,
      0xfff00000, 0x5634e2dc, 0xfff00000, 0x5634e2db, 0xa9cb1d24, 0x9ebe0ce6,
      0x80000000, 0x5634e2dc, 0x80000000, 0xb776d5f5, 0x48892a0b, 0x6141f31a,
      0x00100000, 0xb776d5f6, 0x00100000, 0xb776d5f5, 0x00010000, 0xb776d5f6,
      0x00010000, 0xb776d5f5, 0x00000001, 0xb776d5f6, 0x00000001, 0xb776d5f5,
      0x00000000, 0xb876d5f6, 0x00000000, 0xb876d5f5, 0x00000000, 0xb777d5f6,
      0x00000000, 0xb777d5f5, 0x00000000, 0xb77755f6, 0x00000000, 0xb77755f5,
      0x00000000, 0xb776d5f7, 0x00000000, 0xb776d5f6, 0x00000000, 0xb776d5f5,
      0x00000000, 0xb776d5f4, 0x00000000, 0xb776d5f3, 0x00000000, 0xb77655f6,
      0x00000000, 0xb77655f5, 0x00000000, 0xb775d5f6, 0x00000000, 0xb775d5f5,
      0x00000000, 0xb676d5f6, 0x00000000, 0xb676d5f5, 0x00000000, 0x6141f31a,
      0x00000000, 0x00000000, 0xffffffff, 0xb776d5f6, 0xffffffff, 0xb776d5f5,
      0xffff0000, 0xb776d5f6, 0xffff0000, 0xb776d5f5, 0xfff00000, 0xb776d5f6,
      0xfff00000, 0xb776d5f5, 0xa9cb1d25, 0x00000000, 0x80000000, 0xb776d5f6,
      0x80000000, 0xffffffff, 0x48892a0b, 0xa9cb1d24, 0x00100001, 0x00000000,
      0x00100000, 0xffffffff, 0x00010001, 0x00000000, 0x00010000, 0xffffffff,
      0x00000002, 0x00000000, 0x00000001, 0xffffffff, 0x00000001, 0x01000000,
      0x00000001, 0x00ffffff, 0x00000001, 0x00010000, 0x00000001, 0x0000ffff,
      0x00000001, 0x00008000, 0x00000001, 0x00007fff, 0x00000001, 0x00000001,
      0x00000001, 0x00000000, 0x00000000, 0xffffffff, 0x00000000, 0xfffffffe,
      0x00000000, 0xfffffffd, 0x00000000, 0xffff8000, 0x00000000, 0xffff7fff,
      0x00000000, 0xffff0000, 0x00000000, 0xfffeffff, 0x00000000, 0xff000000,
      0x00000000, 0xfeffffff, 0x00000000, 0xa9cb1d24, 0x00000000, 0x48892a0a,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffff0001, 0x00000000,
      0xffff0000, 0xffffffff, 0xfff00001, 0x00000000, 0xfff00000, 0xffffffff,
      0xa9cb1d25, 0x48892a0a, 0x80000001, 0x00000000, 0x80000001, 0x00000000,
      0x48892a0b, 0xa9cb1d25, 0x00100001, 0x00000001, 0x00100001, 0x00000000,
      0x00010001, 0x00000001, 0x00010001, 0x00000000, 0x00000002, 0x00000001,
      0x00000002, 0x00000000, 0x00000001, 0x01000001, 0x00000001, 0x01000000,
      0x00000001, 0x00010001, 0x00000001, 0x00010000, 0x00000001, 0x00008001,
      0x00000001, 0x00008000, 0x00000001, 0x00000002, 0x00000001, 0x00000001,
      0x00000001, 0x00000000, 0x00000000, 0xffffffff, 0x00000000, 0xfffffffe,
      0x00000000, 0xffff8001, 0x00000000, 0xffff8000, 0x00000000, 0xffff0001,
      0x00000000, 0xffff0000, 0x00000000, 0xff000001, 0x00000000, 0xff000000,
      0x00000000, 0xa9cb1d25, 0x00000000, 0x48892a0b, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xffff0001, 0x00000001, 0xffff0001, 0x00000000,
      0xfff00001, 0x00000001, 0xfff00001, 0x00000000, 0xa9cb1d25, 0x48892a0b,
      0x80000001, 0x00000001, 0x8000ffff, 0xffffffff, 0x488a2a0a, 0xa9cb1d24,
      0x00110000, 0x00000000, 0x0010ffff, 0xffffffff, 0x00020000, 0x00000000,
      0x0001ffff, 0xffffffff, 0x00010001, 0x00000000, 0x00010000, 0xffffffff,
      0x00010000, 0x01000000, 0x00010000, 0x00ffffff, 0x00010000, 0x00010000,
      0x00010000, 0x0000ffff, 0x00010000, 0x00008000, 0x00010000, 0x00007fff,
      0x00010000, 0x00000001, 0x00010000, 0x00000000, 0x0000ffff, 0xffffffff,
      0x0000ffff, 0xfffffffe, 0x0000ffff, 0xfffffffd, 0x0000ffff, 0xffff8000,
      0x0000ffff, 0xffff7fff, 0x0000ffff, 0xffff0000, 0x0000ffff, 0xfffeffff,
      0x0000ffff, 0xff000000, 0x0000ffff, 0xfeffffff, 0x0000ffff, 0xa9cb1d24,
      0x0000ffff, 0x48892a0a, 0x0000ffff, 0x00000000, 0x0000fffe, 0xffffffff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xfff10000, 0x00000000,
      0xfff0ffff, 0xffffffff, 0xa9cc1d24, 0x48892a0a, 0x80010000, 0x00000000,
      0x80010000, 0x00000000, 0x488a2a0a, 0xa9cb1d25, 0x00110000, 0x00000001,
      0x00110000, 0x00000000, 0x00020000, 0x00000001, 0x00020000, 0x00000000,
      0x00010001, 0x00000001, 0x00010001, 0x00000000, 0x00010000, 0x01000001,
      0x00010000, 0x01000000, 0x00010000, 0x00010001, 0x00010000, 0x00010000,
      0x00010000, 0x00008001, 0x00010000, 0x00008000, 0x00010000, 0x00000002,
      0x00010000, 0x00000001, 0x00010000, 0x00000000, 0x0000ffff, 0xffffffff,
      0x0000ffff, 0xfffffffe, 0x0000ffff, 0xffff8001, 0x0000ffff, 0xffff8000,
      0x0000ffff, 0xffff0001, 0x0000ffff, 0xffff0000, 0x0000ffff, 0xff000001,
      0x0000ffff, 0xff000000, 0x0000ffff, 0xa9cb1d25, 0x0000ffff, 0x48892a0b,
      0x0000ffff, 0x00000001, 0x0000ffff, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xfff10000, 0x00000001, 0xfff10000, 0x00000000,
      0xa9cc1d24, 0x48892a0b, 0x80010000, 0x00000001, 0x800fffff, 0xffffffff,
      0x48992a0a, 0xa9cb1d24, 0x00200000, 0x00000000, 0x001fffff, 0xffffffff,
      0x00110000, 0x00000000, 0x0010ffff, 0xffffffff, 0x00100001, 0x00000000,
      0x00100000, 0xffffffff, 0x00100000, 0x01000000, 0x00100000, 0x00ffffff,
      0x00100000, 0x00010000, 0x00100000, 0x0000ffff, 0x00100000, 0x00008000,
      0x00100000, 0x00007fff, 0x00100000, 0x00000001, 0x00100000, 0x00000000,
      0x000fffff, 0xffffffff, 0x000fffff, 0xfffffffe, 0x000fffff, 0xfffffffd,
      0x000fffff, 0xffff8000, 0x000fffff, 0xffff7fff, 0x000fffff, 0xffff0000,
      0x000fffff, 0xfffeffff, 0x000fffff, 0xff000000, 0x000fffff, 0xfeffffff,
      0x000fffff, 0xa9cb1d24, 0x000fffff, 0x48892a0a, 0x000fffff, 0x00000000,
      0x000ffffe, 0xffffffff, 0x000f0000, 0x00000000, 0x000effff, 0xffffffff,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xa9db1d24, 0x48892a0a,
      0x80100000, 0x00000000, 0x80100000, 0x00000000, 0x48992a0a, 0xa9cb1d25,
      0x00200000, 0x00000001, 0x00200000, 0x00000000, 0x00110000, 0x00000001,
      0x00110000, 0x00000000, 0x00100001, 0x00000001, 0x00100001, 0x00000000,
      0x00100000, 0x01000001, 0x00100000, 0x01000000, 0x00100000, 0x00010001,
      0x00100000, 0x00010000, 0x00100000, 0x00008001, 0x00100000, 0x00008000,
      0x00100000, 0x00000002, 0x00100000, 0x00000001, 0x00100000, 0x00000000,
      0x000fffff, 0xffffffff, 0x000fffff, 0xfffffffe, 0x000fffff, 0xffff8001,
      0x000fffff, 0xffff8000, 0x000fffff, 0xffff0001, 0x000fffff, 0xffff0000,
      0x000fffff, 0xff000001, 0x000fffff, 0xff000000, 0x000fffff, 0xa9cb1d25,
      0x000fffff, 0x48892a0b, 0x000fffff, 0x00000001, 0x000fffff, 0x00000000,
      0x000f0000, 0x00000001, 0x000f0000, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0xa9db1d24, 0x48892a0b, 0x80100000, 0x00000001,
      0xd634e2db, 0xb776d5f5, 0x9ebe0ce6, 0x6141f31a, 0x5644e2db, 0xb776d5f6,
      0x5644e2db, 0xb776d5f5, 0x5635e2db, 0xb776d5f6, 0x5635e2db, 0xb776d5f5,
      0x5634e2dc, 0xb776d5f6, 0x5634e2dc, 0xb776d5f5, 0x5634e2db, 0xb876d5f6,
      0x5634e2db, 0xb876d5f5, 0x5634e2db, 0xb777d5f6, 0x5634e2db, 0xb777d5f5,
      0x5634e2db, 0xb77755f6, 0x5634e2db, 0xb77755f5, 0x5634e2db, 0xb776d5f7,
      0x5634e2db, 0xb776d5f6, 0x5634e2db, 0xb776d5f5, 0x5634e2db, 0xb776d5f4,
      0x5634e2db, 0xb776d5f3, 0x5634e2db, 0xb77655f6, 0x5634e2db, 0xb77655f5,
      0x5634e2db, 0xb775d5f6, 0x5634e2db, 0xb775d5f5, 0x5634e2db, 0xb676d5f6,
      0x5634e2db, 0xb676d5f5, 0x5634e2db, 0x6141f31a, 0x5634e2db, 0x00000000,
      0x5634e2da, 0xb776d5f6, 0x5634e2da, 0xb776d5f5, 0x5633e2db, 0xb776d5f6,
      0x5633e2db, 0xb776d5f5, 0x5624e2db, 0xb776d5f6, 0x5624e2db, 0xb776d5f5,
      0x00000000, 0x00000000, 0xd634e2db, 0xb776d5f6, 0xffffffff, 0xffffffff,
      0xc8892a0a, 0xa9cb1d24, 0x80100000, 0x00000000, 0x800fffff, 0xffffffff,
      0x80010000, 0x00000000, 0x8000ffff, 0xffffffff, 0x80000001, 0x00000000,
      0x80000000, 0xffffffff, 0x80000000, 0x01000000, 0x80000000, 0x00ffffff,
      0x80000000, 0x00010000, 0x80000000, 0x0000ffff, 0x80000000, 0x00008000,
      0x80000000, 0x00007fff, 0x80000000, 0x00000001, 0x80000000, 0x00000000,
      0x7fffffff, 0xffffffff, 0x7fffffff, 0xfffffffe, 0x7fffffff, 0xfffffffd,
      0x7fffffff, 0xffff8000, 0x7fffffff, 0xffff7fff, 0x7fffffff, 0xffff0000,
      0x7fffffff, 0xfffeffff, 0x7fffffff, 0xff000000, 0x7fffffff, 0xfeffffff,
      0x7fffffff, 0xa9cb1d24, 0x7fffffff, 0x48892a0a, 0x7fffffff, 0x00000000,
      0x7ffffffe, 0xffffffff, 0x7fff0000, 0x00000000, 0x7ffeffff, 0xffffffff,
      0x7ff00000, 0x00000000, 0x7fefffff, 0xffffffff, 0x29cb1d24, 0x48892a0a,
      0x00000000, 0x00000000
    ];
toInt32s(TEST_SUB_BITS);

var TEST_MUL_BITS = [
      0x80000000, 0x00000000, 0x80000000, 0x00000000, 0x1ad92a0a, 0xa9cb1d25,
      0x00000000, 0x00000000, 0xd2500000, 0x00000000, 0x00100000, 0x00000000,
      0x80000000, 0x00000000, 0x65ae2a0a, 0xa9cb1d25, 0x00110000, 0x00000001,
      0x00100000, 0x00000000, 0x00000000, 0x00000000, 0x1d250000, 0x00000000,
      0x00010000, 0x00000000, 0x00000000, 0x00000000, 0x00010000, 0x00000000,
      0x80000000, 0x00000000, 0xf254472f, 0xa9cb1d25, 0x00100001, 0x00000001,
      0x00100000, 0x00000000, 0x00010001, 0x00000001, 0x00010000, 0x00000000,
      0x00000000, 0x00000000, 0xa9cb1d25, 0x00000000, 0x00000001, 0x00000000,
      0x00000000, 0x00000000, 0x00000001, 0x00000000, 0x00000000, 0x00000000,
      0x00000001, 0x00000000, 0x80000000, 0x00000000, 0x5332f527, 0xcecb1d25,
      0x00100000, 0x01000001, 0x00100000, 0x00000000, 0x00010000, 0x01000001,
      0x00010000, 0x00000000, 0x01000001, 0x01000001, 0x01000001, 0x00000000,
      0x00000000, 0x00000000, 0x0aa9cb1d, 0x25000000, 0x00000000, 0x01000000,
      0x00000000, 0x00000000, 0x00000000, 0x01000000, 0x00000000, 0x00000000,
      0x01000000, 0x01000000, 0x01000000, 0x00000000, 0x00010000, 0x01000000,
      0x80000000, 0x00000000, 0x7293d3d5, 0xc6f01d25, 0x00100000, 0x00010001,
      0x00100000, 0x00000000, 0x00010000, 0x00010001, 0x00010000, 0x00000000,
      0x00010001, 0x00010001, 0x00010001, 0x00000000, 0x00000100, 0x01010001,
      0x00000100, 0x01000000, 0x00000000, 0x00000000, 0x2a0aa9cb, 0x1d250000,
      0x00000000, 0x00010000, 0x00000000, 0x00000000, 0x00000000, 0x00010000,
      0x00000000, 0x00000000, 0x00010000, 0x00010000, 0x00010000, 0x00000000,
      0x00000100, 0x00010000, 0x00000100, 0x00000000, 0x00000001, 0x00010000,
      0x80000000, 0x00000000, 0xdd8e7ef0, 0x385d9d25, 0x00100000, 0x00008001,
      0x00100000, 0x00000000, 0x80010000, 0x00008001, 0x80010000, 0x00000000,
      0x00008001, 0x00008001, 0x00008001, 0x00000000, 0x00000080, 0x01008001,
      0x00000080, 0x01000000, 0x00000000, 0x80018001, 0x00000000, 0x80010000,
      0x00000000, 0x00000000, 0x950554e5, 0x8e928000, 0x00000000, 0x00008000,
      0x00000000, 0x00000000, 0x80000000, 0x00008000, 0x80000000, 0x00000000,
      0x00008000, 0x00008000, 0x00008000, 0x00000000, 0x00000080, 0x00008000,
      0x00000080, 0x00000000, 0x00000000, 0x80008000, 0x00000000, 0x80000000,
      0x00000000, 0x40008000, 0x00000000, 0x00000000, 0x91125415, 0x53963a4a,
      0x00200000, 0x00000002, 0x00200000, 0x00000000, 0x00020000, 0x00000002,
      0x00020000, 0x00000000, 0x00000002, 0x00000002, 0x00000002, 0x00000000,
      0x00000000, 0x02000002, 0x00000000, 0x02000000, 0x00000000, 0x00020002,
      0x00000000, 0x00020000, 0x00000000, 0x00010002, 0x00000000, 0x00010000,
      0x80000000, 0x00000000, 0x48892a0a, 0xa9cb1d25, 0x00100000, 0x00000001,
      0x00100000, 0x00000000, 0x00010000, 0x00000001, 0x00010000, 0x00000000,
      0x00000001, 0x00000001, 0x00000001, 0x00000000, 0x00000000, 0x01000001,
      0x00000000, 0x01000000, 0x00000000, 0x00010001, 0x00000000, 0x00010000,
      0x00000000, 0x00008001, 0x00000000, 0x00008000, 0x00000000, 0x00000002,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x80000000, 0x00000000, 0xb776d5f5, 0x5634e2db,
      0xffefffff, 0xffffffff, 0xfff00000, 0x00000000, 0xfffeffff, 0xffffffff,
      0xffff0000, 0x00000000, 0xfffffffe, 0xffffffff, 0xffffffff, 0x00000000,
      0xffffffff, 0xfeffffff, 0xffffffff, 0xff000000, 0xffffffff, 0xfffeffff,
      0xffffffff, 0xffff0000, 0xffffffff, 0xffff7fff, 0xffffffff, 0xffff8000,
      0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x6eedabea, 0xac69c5b6, 0xffdfffff, 0xfffffffe,
      0xffe00000, 0x00000000, 0xfffdffff, 0xfffffffe, 0xfffe0000, 0x00000000,
      0xfffffffd, 0xfffffffe, 0xfffffffe, 0x00000000, 0xffffffff, 0xfdfffffe,
      0xffffffff, 0xfe000000, 0xffffffff, 0xfffdfffe, 0xffffffff, 0xfffe0000,
      0xffffffff, 0xfffefffe, 0xffffffff, 0xffff0000, 0xffffffff, 0xfffffffc,
      0xffffffff, 0xfffffffe, 0x00000000, 0x00000000, 0x00000000, 0x00000002,
      0x80000000, 0x00000000, 0xb383d525, 0x1b389d25, 0x000fffff, 0xffff8001,
      0x00100000, 0x00000000, 0x8000ffff, 0xffff8001, 0x80010000, 0x00000000,
      0xffff8000, 0xffff8001, 0xffff8001, 0x00000000, 0xffffff80, 0x00ff8001,
      0xffffff80, 0x01000000, 0xffffffff, 0x80008001, 0xffffffff, 0x80010000,
      0xffffffff, 0xc0000001, 0xffffffff, 0xc0008000, 0xffffffff, 0xffff0002,
      0xffffffff, 0xffff8001, 0x00000000, 0x00000000, 0x00000000, 0x00007fff,
      0x00000000, 0x0000fffe, 0x00000000, 0x00000000, 0x6afaab1a, 0x716d8000,
      0xffffffff, 0xffff8000, 0x00000000, 0x00000000, 0x7fffffff, 0xffff8000,
      0x80000000, 0x00000000, 0xffff7fff, 0xffff8000, 0xffff8000, 0x00000000,
      0xffffff7f, 0xffff8000, 0xffffff80, 0x00000000, 0xffffffff, 0x7fff8000,
      0xffffffff, 0x80000000, 0xffffffff, 0xbfff8000, 0xffffffff, 0xc0000000,
      0xffffffff, 0xffff0000, 0xffffffff, 0xffff8000, 0x00000000, 0x00000000,
      0x00000000, 0x00008000, 0x00000000, 0x00010000, 0x00000000, 0x3fff8000,
      0x80000000, 0x00000000, 0x1e7e803f, 0x8ca61d25, 0x000fffff, 0xffff0001,
      0x00100000, 0x00000000, 0x0000ffff, 0xffff0001, 0x00010000, 0x00000000,
      0xffff0000, 0xffff0001, 0xffff0001, 0x00000000, 0xffffff00, 0x00ff0001,
      0xffffff00, 0x01000000, 0xffffffff, 0x00000001, 0xffffffff, 0x00010000,
      0xffffffff, 0x7fff8001, 0xffffffff, 0x80008000, 0xffffffff, 0xfffe0002,
      0xffffffff, 0xffff0001, 0x00000000, 0x00000000, 0x00000000, 0x0000ffff,
      0x00000000, 0x0001fffe, 0x00000000, 0x7ffe8001, 0x00000000, 0x7fff8000,
      0x00000000, 0x00000000, 0xd5f55634, 0xe2db0000, 0xffffffff, 0xffff0000,
      0x00000000, 0x00000000, 0xffffffff, 0xffff0000, 0x00000000, 0x00000000,
      0xfffeffff, 0xffff0000, 0xffff0000, 0x00000000, 0xfffffeff, 0xffff0000,
      0xffffff00, 0x00000000, 0xfffffffe, 0xffff0000, 0xffffffff, 0x00000000,
      0xffffffff, 0x7fff0000, 0xffffffff, 0x80000000, 0xffffffff, 0xfffe0000,
      0xffffffff, 0xffff0000, 0x00000000, 0x00000000, 0x00000000, 0x00010000,
      0x00000000, 0x00020000, 0x00000000, 0x7fff0000, 0x00000000, 0x80000000,
      0x00000000, 0xffff0000, 0x80000000, 0x00000000, 0x3ddf5eed, 0x84cb1d25,
      0x000fffff, 0xff000001, 0x00100000, 0x00000000, 0x0000ffff, 0xff000001,
      0x00010000, 0x00000000, 0xff000000, 0xff000001, 0xff000001, 0x00000000,
      0xffff0000, 0x00000001, 0xffff0000, 0x01000000, 0xfffffeff, 0xff010001,
      0xffffff00, 0x00010000, 0xffffff7f, 0xff008001, 0xffffff80, 0x00008000,
      0xffffffff, 0xfe000002, 0xffffffff, 0xff000001, 0x00000000, 0x00000000,
      0x00000000, 0x00ffffff, 0x00000000, 0x01fffffe, 0x0000007f, 0xfeff8001,
      0x0000007f, 0xffff8000, 0x000000ff, 0xfeff0001, 0x000000ff, 0xffff0000,
      0x00000000, 0x00000000, 0xf55634e2, 0xdb000000, 0xffffffff, 0xff000000,
      0x00000000, 0x00000000, 0xffffffff, 0xff000000, 0x00000000, 0x00000000,
      0xfeffffff, 0xff000000, 0xff000000, 0x00000000, 0xfffeffff, 0xff000000,
      0xffff0000, 0x00000000, 0xfffffeff, 0xff000000, 0xffffff00, 0x00000000,
      0xffffff7f, 0xff000000, 0xffffff80, 0x00000000, 0xffffffff, 0xfe000000,
      0xffffffff, 0xff000000, 0x00000000, 0x00000000, 0x00000000, 0x01000000,
      0x00000000, 0x02000000, 0x0000007f, 0xff000000, 0x00000080, 0x00000000,
      0x000000ff, 0xff000000, 0x00000100, 0x00000000, 0x0000ffff, 0xff000000,
      0x80000000, 0x00000000, 0xbc56e5ef, 0x15ff6759, 0xd24fffff, 0xa9cb1d25,
      0xd2500000, 0x00000000, 0x1d24ffff, 0xa9cb1d25, 0x1d250000, 0x00000000,
      0xa9cb1d24, 0xa9cb1d25, 0xa9cb1d25, 0x00000000, 0xffa9cb1c, 0xcecb1d25,
      0xffa9cb1d, 0x25000000, 0xffffa9ca, 0xc6f01d25, 0xffffa9cb, 0x1d250000,
      0xffffd4e5, 0x385d9d25, 0xffffd4e5, 0x8e928000, 0xffffffff, 0x53963a4a,
      0xffffffff, 0xa9cb1d25, 0x00000000, 0x00000000, 0x00000000, 0x5634e2db,
      0x00000000, 0xac69c5b6, 0x00002b1a, 0x1b389d25, 0x00002b1a, 0x716d8000,
      0x00005634, 0x8ca61d25, 0x00005634, 0xe2db0000, 0x005634e2, 0x84cb1d25,
      0x005634e2, 0xdb000000, 0x80000000, 0x00000000, 0x74756f10, 0x9f4f5297,
      0xa0afffff, 0x48892a0b, 0xa0b00000, 0x00000000, 0x2a0affff, 0x48892a0b,
      0x2a0b0000, 0x00000000, 0x48892a0a, 0x48892a0b, 0x48892a0b, 0x00000000,
      0xff488929, 0x53892a0b, 0xff48892a, 0x0b000000, 0xffff4888, 0x72942a0b,
      0xffff4889, 0x2a0b0000, 0xffffa443, 0xdd8eaa0b, 0xffffa444, 0x95058000,
      0xfffffffe, 0x91125416, 0xffffffff, 0x48892a0b, 0x00000000, 0x00000000,
      0x00000000, 0xb776d5f5, 0x00000001, 0x6eedabea, 0x00005bba, 0xb383aa0b,
      0x00005bbb, 0x6afa8000, 0x0000b776, 0x1e7e2a0b, 0x0000b776, 0xd5f50000,
      0x00b776d5, 0x3d892a0b, 0x00b776d5, 0xf5000000, 0x3dc7d297, 0x9f4f5297,
      0x80000000, 0x00000000, 0x9ebe0ce5, 0xa9cb1d25, 0x000fffff, 0x00000001,
      0x00100000, 0x00000000, 0x0000ffff, 0x00000001, 0x00010000, 0x00000000,
      0x00000000, 0x00000001, 0x00000001, 0x00000000, 0xfeffffff, 0x01000001,
      0xff000000, 0x01000000, 0xfffeffff, 0x00010001, 0xffff0000, 0x00010000,
      0xffff7fff, 0x00008001, 0xffff8000, 0x00008000, 0xfffffffe, 0x00000002,
      0xffffffff, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0xffffffff,
      0x00000001, 0xfffffffe, 0x00007ffe, 0xffff8001, 0x00007fff, 0xffff8000,
      0x0000fffe, 0xffff0001, 0x0000ffff, 0xffff0000, 0x00fffffe, 0xff000001,
      0x00ffffff, 0xff000000, 0x5634e2da, 0xa9cb1d25, 0xb776d5f4, 0x48892a0b,
      0x00000000, 0x00000000, 0x5634e2db, 0x00000000, 0xffffffff, 0x00000000,
      0x00000000, 0x00000000, 0xffffffff, 0x00000000, 0x00000000, 0x00000000,
      0xffffffff, 0x00000000, 0x00000000, 0x00000000, 0xfeffffff, 0x00000000,
      0xff000000, 0x00000000, 0xfffeffff, 0x00000000, 0xffff0000, 0x00000000,
      0xffff7fff, 0x00000000, 0xffff8000, 0x00000000, 0xfffffffe, 0x00000000,
      0xffffffff, 0x00000000, 0x00000000, 0x00000000, 0x00000001, 0x00000000,
      0x00000002, 0x00000000, 0x00007fff, 0x00000000, 0x00008000, 0x00000000,
      0x0000ffff, 0x00000000, 0x00010000, 0x00000000, 0x00ffffff, 0x00000000,
      0x01000000, 0x00000000, 0x5634e2db, 0x00000000, 0xb776d5f5, 0x00000000,
      0xffffffff, 0x00000000, 0x80000000, 0x00000000, 0x2b642a0a, 0xa9cb1d25,
      0x000f0000, 0x00000001, 0x00100000, 0x00000000, 0x00000000, 0x00000001,
      0x00010000, 0x00000000, 0xffff0001, 0x00000001, 0x00000001, 0x00000000,
      0xffff0000, 0x01000001, 0x00000000, 0x01000000, 0xffff0000, 0x00010001,
      0x00000000, 0x00010000, 0x7fff0000, 0x00008001, 0x80000000, 0x00008000,
      0xfffe0000, 0x00000002, 0xffff0000, 0x00000001, 0x00000000, 0x00000000,
      0x0000ffff, 0xffffffff, 0x0001ffff, 0xfffffffe, 0x7ffeffff, 0xffff8001,
      0x7fffffff, 0xffff8000, 0xfffeffff, 0xffff0001, 0xffffffff, 0xffff0000,
      0xfffeffff, 0xff000001, 0xffffffff, 0xff000000, 0xe2daffff, 0xa9cb1d25,
      0xd5f4ffff, 0x48892a0b, 0xfffeffff, 0x00000001, 0xffffffff, 0x00000000,
      0x00000000, 0x00000000, 0xe2db0000, 0x00000000, 0xffff0000, 0x00000000,
      0x00000000, 0x00000000, 0xffff0000, 0x00000000, 0x00000000, 0x00000000,
      0xffff0000, 0x00000000, 0x00000000, 0x00000000, 0xffff0000, 0x00000000,
      0x00000000, 0x00000000, 0xffff0000, 0x00000000, 0x00000000, 0x00000000,
      0x7fff0000, 0x00000000, 0x80000000, 0x00000000, 0xfffe0000, 0x00000000,
      0xffff0000, 0x00000000, 0x00000000, 0x00000000, 0x00010000, 0x00000000,
      0x00020000, 0x00000000, 0x7fff0000, 0x00000000, 0x80000000, 0x00000000,
      0xffff0000, 0x00000000, 0x00000000, 0x00000000, 0xffff0000, 0x00000000,
      0x00000000, 0x00000000, 0xe2db0000, 0x00000000, 0xd5f50000, 0x00000000,
      0xffff0000, 0x00000000, 0x00000000, 0x00000000, 0xffff0000, 0x00000000,
      0x80000000, 0x00000000, 0x76392a0a, 0xa9cb1d25, 0x00000000, 0x00000001,
      0x00100000, 0x00000000, 0xfff10000, 0x00000001, 0x00010000, 0x00000000,
      0xfff00001, 0x00000001, 0x00000001, 0x00000000, 0xfff00000, 0x01000001,
      0x00000000, 0x01000000, 0xfff00000, 0x00010001, 0x00000000, 0x00010000,
      0xfff00000, 0x00008001, 0x00000000, 0x00008000, 0xffe00000, 0x00000002,
      0xfff00000, 0x00000001, 0x00000000, 0x00000000, 0x000fffff, 0xffffffff,
      0x001fffff, 0xfffffffe, 0xffefffff, 0xffff8001, 0xffffffff, 0xffff8000,
      0xffefffff, 0xffff0001, 0xffffffff, 0xffff0000, 0xffefffff, 0xff000001,
      0xffffffff, 0xff000000, 0x2dafffff, 0xa9cb1d25, 0x5f4fffff, 0x48892a0b,
      0xffefffff, 0x00000001, 0xffffffff, 0x00000000, 0xffef0000, 0x00000001,
      0xffff0000, 0x00000000, 0x00000000, 0x00000000, 0x2db00000, 0x00000000,
      0xfff00000, 0x00000000, 0x00000000, 0x00000000, 0xfff00000, 0x00000000,
      0x00000000, 0x00000000, 0xfff00000, 0x00000000, 0x00000000, 0x00000000,
      0xfff00000, 0x00000000, 0x00000000, 0x00000000, 0xfff00000, 0x00000000,
      0x00000000, 0x00000000, 0xfff00000, 0x00000000, 0x00000000, 0x00000000,
      0xffe00000, 0x00000000, 0xfff00000, 0x00000000, 0x00000000, 0x00000000,
      0x00100000, 0x00000000, 0x00200000, 0x00000000, 0xfff00000, 0x00000000,
      0x00000000, 0x00000000, 0xfff00000, 0x00000000, 0x00000000, 0x00000000,
      0xfff00000, 0x00000000, 0x00000000, 0x00000000, 0x2db00000, 0x00000000,
      0x5f500000, 0x00000000, 0xfff00000, 0x00000000, 0x00000000, 0x00000000,
      0xfff00000, 0x00000000, 0x00000000, 0x00000000, 0xfff00000, 0x00000000,
      0x80000000, 0x00000000, 0x8a74d669, 0x9f4f5297, 0x4a7b1d24, 0x48892a0b,
      0xa0b00000, 0x00000000, 0xd3d61d24, 0x48892a0b, 0x2a0b0000, 0x00000000,
      0xf254472f, 0x48892a0b, 0x48892a0b, 0x00000000, 0xce13a64e, 0x53892a0b,
      0x2448892a, 0x0b000000, 0xc6ef65ad, 0x72942a0b, 0x1d244889, 0x2a0b0000,
      0x385d4168, 0xdd8eaa0b, 0x8e922444, 0x95058000, 0x53963a48, 0x91125416,
      0xa9cb1d24, 0x48892a0b, 0x00000000, 0x00000000, 0x5634e2db, 0xb776d5f5,
      0xac69c5b7, 0x6eedabea, 0x1b38f8df, 0xb383aa0b, 0x716ddbbb, 0x6afa8000,
      0x8ca6d49b, 0x1e7e2a0b, 0xe2dbb776, 0xd5f50000, 0x858293fa, 0x3d892a0b,
      0xdbb776d5, 0xf5000000, 0x53c739f0, 0x9f4f5297, 0x22ca6fa5, 0x36ad9c79,
      0x6141f319, 0x48892a0b, 0xb776d5f5, 0x00000000, 0x7fc01d24, 0x48892a0b,
      0xd5f50000, 0x00000000, 0x091b1d24, 0x48892a0b, 0x5f500000, 0x00000000,
      0x80000000, 0x00000000, 0xc8892a0a, 0xa9cb1d25, 0x80100000, 0x00000001,
      0x00100000, 0x00000000, 0x80010000, 0x00000001, 0x00010000, 0x00000000,
      0x80000001, 0x00000001, 0x00000001, 0x00000000, 0x80000000, 0x01000001,
      0x00000000, 0x01000000, 0x80000000, 0x00010001, 0x00000000, 0x00010000,
      0x80000000, 0x00008001, 0x00000000, 0x00008000, 0x00000000, 0x00000002,
      0x80000000, 0x00000001, 0x00000000, 0x00000000, 0x7fffffff, 0xffffffff,
      0xffffffff, 0xfffffffe, 0x7fffffff, 0xffff8001, 0xffffffff, 0xffff8000,
      0x7fffffff, 0xffff0001, 0xffffffff, 0xffff0000, 0x7fffffff, 0xff000001,
      0xffffffff, 0xff000000, 0x7fffffff, 0xa9cb1d25, 0x7fffffff, 0x48892a0b,
      0x7fffffff, 0x00000001, 0xffffffff, 0x00000000, 0x7fff0000, 0x00000001,
      0xffff0000, 0x00000000, 0x7ff00000, 0x00000001, 0xfff00000, 0x00000000,
      0x29cb1d24, 0x48892a0b
    ];
toInt32s(TEST_MUL_BITS);

var TEST_DIV_BITS = [
      0x00000000, 0x00000001, 0x00000000, 0x00000001, 0x00000000, 0x000007ff,
      0x00000000, 0x00000800, 0x00000000, 0x00007fff, 0x00000000, 0x00008000,
      0x00000000, 0x7fffffff, 0x00000000, 0x80000000, 0x0000007f, 0xffff8000,
      0x00000080, 0x00000000, 0x00007fff, 0x80007fff, 0x00008000, 0x00000000,
      0x0000fffe, 0x0003fff8, 0x00010000, 0x00000000, 0x40000000, 0x00000000,
      0x80000000, 0x00000000, 0x80000000, 0x00000000, 0xc0000000, 0x00000000,
      0xfffefffd, 0xfffbfff8, 0xffff0000, 0x00000000, 0xffff7fff, 0x7fff8000,
      0xffff8000, 0x00000000, 0xffffff7f, 0xffff8000, 0xffffff80, 0x00000000,
      0xfffffffe, 0x83e3cc1a, 0xffffffff, 0x4d64985a, 0xffffffff, 0x80000000,
      0xffffffff, 0x80000000, 0xffffffff, 0xffff8000, 0xffffffff, 0xffff8000,
      0xffffffff, 0xfffff800, 0xffffffff, 0xfffff800, 0xffffffff, 0xffffffff,
      0xffffffff, 0xffffffff, 0x00000000, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x00000488, 0x00000000, 0x00000488, 0x00000000, 0x00004889,
      0x00000000, 0x00004889, 0x00000000, 0x48892a0a, 0x00000000, 0x48892a0a,
      0x00000048, 0x8929c220, 0x00000048, 0x892a0aa9, 0x00004888, 0xe181c849,
      0x00004889, 0x2a0aa9cb, 0x00009111, 0x31f2efb0, 0x00009112, 0x54155396,
      0x24449505, 0x54e58e92, 0x48892a0a, 0xa9cb1d25, 0xb776d5f5, 0x5634e2db,
      0xdbbb6afa, 0xab1a716e, 0xffff6eec, 0x89c3bff2, 0xffff6eed, 0xabeaac6a,
      0xffffb776, 0x8d6be3a1, 0xffffb776, 0xd5f55635, 0xffffffb7, 0x76d5acce,
      0xffffffb7, 0x76d5f557, 0xffffffff, 0x2898cfc6, 0xffffffff, 0x9ac930b4,
      0xffffffff, 0xb776d5f6, 0xffffffff, 0xb776d5f6, 0xffffffff, 0xffffb777,
      0xffffffff, 0xffffb777, 0xffffffff, 0xfffffb78, 0xffffffff, 0xfffffb78,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000001, 0x00000000, 0x00000001,
      0x00000000, 0x0000000f, 0x00000000, 0x00000010, 0x00000000, 0x000fffff,
      0x00000000, 0x00100000, 0x00000000, 0x0ffffff0, 0x00000000, 0x10000000,
      0x0000000f, 0xfff0000f, 0x00000010, 0x00000000, 0x0000001f, 0xffc0007f,
      0x00000020, 0x00000000, 0x00080000, 0x00000000, 0x00100000, 0x00000001,
      0xffefffff, 0xffffffff, 0xfff80000, 0x00000000, 0xffffffdf, 0xffbfff80,
      0xffffffe0, 0x00000000, 0xffffffef, 0xffeffff0, 0xfffffff0, 0x00000000,
      0xffffffff, 0xeffffff0, 0xffffffff, 0xf0000000, 0xffffffff, 0xffd07c7a,
      0xffffffff, 0xffe9ac94, 0xffffffff, 0xfff00000, 0xffffffff, 0xfff00000,
      0xffffffff, 0xfffffff0, 0xffffffff, 0xfffffff0, 0xffffffff, 0xffffffff,
      0xffffffff, 0xffffffff, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000001, 0x00000000, 0x0000000f, 0x00000000, 0x00000010,
      0x00000000, 0x000fffff, 0x00000000, 0x00100000, 0x00000000, 0x0ffffff0,
      0x00000000, 0x10000000, 0x0000000f, 0xfff0000f, 0x00000010, 0x00000000,
      0x0000001f, 0xffc0007f, 0x00000020, 0x00000000, 0x00080000, 0x00000000,
      0x00100000, 0x00000000, 0xfff00000, 0x00000000, 0xfff80000, 0x00000000,
      0xffffffdf, 0xffbfff80, 0xffffffe0, 0x00000000, 0xffffffef, 0xffeffff0,
      0xfffffff0, 0x00000000, 0xffffffff, 0xeffffff0, 0xffffffff, 0xf0000000,
      0xffffffff, 0xffd07c7a, 0xffffffff, 0xffe9ac94, 0xffffffff, 0xfff00000,
      0xffffffff, 0xfff00000, 0xffffffff, 0xfffffff0, 0xffffffff, 0xfffffff0,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x00000001, 0x00000000, 0x0000ffff, 0x00000000, 0x00010000,
      0x00000000, 0x00ffffff, 0x00000000, 0x01000000, 0x00000000, 0xffff0001,
      0x00000001, 0x00000000, 0x00000001, 0xfffc0007, 0x00000002, 0x00000000,
      0x00008000, 0x00000000, 0x00010000, 0x00000001, 0xfffeffff, 0xffffffff,
      0xffff8000, 0x00000000, 0xfffffffd, 0xfffbfff8, 0xfffffffe, 0x00000000,
      0xfffffffe, 0xfffeffff, 0xffffffff, 0x00000000, 0xffffffff, 0xfeffffff,
      0xffffffff, 0xff000000, 0xffffffff, 0xfffd07c8, 0xffffffff, 0xfffe9aca,
      0xffffffff, 0xffff0000, 0xffffffff, 0xffff0000, 0xffffffff, 0xffffffff,
      0xffffffff, 0xffffffff, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000001, 0x00000000, 0x0000ffff,
      0x00000000, 0x00010000, 0x00000000, 0x00ffffff, 0x00000000, 0x01000000,
      0x00000000, 0xffff0000, 0x00000001, 0x00000000, 0x00000001, 0xfffc0007,
      0x00000002, 0x00000000, 0x00008000, 0x00000000, 0x00010000, 0x00000000,
      0xffff0000, 0x00000000, 0xffff8000, 0x00000000, 0xfffffffd, 0xfffbfff8,
      0xfffffffe, 0x00000000, 0xfffffffe, 0xfffeffff, 0xffffffff, 0x00000000,
      0xffffffff, 0xfeffffff, 0xffffffff, 0xff000000, 0xffffffff, 0xfffd07c8,
      0xffffffff, 0xfffe9aca, 0xffffffff, 0xffff0000, 0xffffffff, 0xffff0000,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000001, 0x00000000, 0x00000001, 0x00000000, 0x000000ff,
      0x00000000, 0x00000100, 0x00000000, 0x0000ffff, 0x00000000, 0x00010000,
      0x00000000, 0x0001fffc, 0x00000000, 0x00020000, 0x00000000, 0x80000000,
      0x00000001, 0x00000001, 0xfffffffe, 0xffffffff, 0xffffffff, 0x80000000,
      0xffffffff, 0xfffdfffc, 0xffffffff, 0xfffe0000, 0xffffffff, 0xfffeffff,
      0xffffffff, 0xffff0000, 0xffffffff, 0xffffff00, 0xffffffff, 0xffffff00,
      0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff,
      0xffffffff, 0xffffffff, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x000000ff, 0x00000000, 0x00000100, 0x00000000, 0x0000ffff,
      0x00000000, 0x00010000, 0x00000000, 0x0001fffc, 0x00000000, 0x00020000,
      0x00000000, 0x80000000, 0x00000001, 0x00000000, 0xffffffff, 0x00000000,
      0xffffffff, 0x80000000, 0xffffffff, 0xfffdfffc, 0xffffffff, 0xfffe0000,
      0xffffffff, 0xfffeffff, 0xffffffff, 0xffff0000, 0xffffffff, 0xffffff00,
      0xffffffff, 0xffffff00, 0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000001, 0x00000000, 0x00000001,
      0x00000000, 0x000000ff, 0x00000000, 0x00000100, 0x00000000, 0x000001ff,
      0x00000000, 0x00000200, 0x00000000, 0x00800000, 0x00000000, 0x01000001,
      0xffffffff, 0xfeffffff, 0xffffffff, 0xff800000, 0xffffffff, 0xfffffe00,
      0xffffffff, 0xfffffe00, 0xffffffff, 0xffffff00, 0xffffffff, 0xffffff00,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000001, 0x00000000, 0x000000ff, 0x00000000, 0x00000100,
      0x00000000, 0x000001ff, 0x00000000, 0x00000200, 0x00000000, 0x00800000,
      0x00000000, 0x01000000, 0xffffffff, 0xff000000, 0xffffffff, 0xff800000,
      0xffffffff, 0xfffffe00, 0xffffffff, 0xfffffe00, 0xffffffff, 0xffffff00,
      0xffffffff, 0xffffff00, 0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x00000001, 0x00000000, 0x00000001, 0x00000000, 0x00000002,
      0x00000000, 0x00008000, 0x00000000, 0x00010001, 0xffffffff, 0xfffeffff,
      0xffffffff, 0xffff8000, 0xffffffff, 0xfffffffe, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000001, 0x00000000, 0x00000001,
      0x00000000, 0x00000002, 0x00000000, 0x00008000, 0x00000000, 0x00010000,
      0xffffffff, 0xffff0000, 0xffffffff, 0xffff8000, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000001, 0x00000000, 0x00000001, 0x00000000, 0x00004000,
      0x00000000, 0x00008001, 0xffffffff, 0xffff7fff, 0xffffffff, 0xffffc000,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000001,
      0x00000000, 0x00004000, 0x00000000, 0x00008000, 0xffffffff, 0xffff8000,
      0xffffffff, 0xffffc000, 0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000001, 0x00000000, 0x00000002,
      0xffffffff, 0xfffffffe, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000001, 0xffffffff, 0xffffffff, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xffffffff,
      0x00000000, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xffffffff,
      0xffffffff, 0xfffffffe, 0x00000000, 0x00000002, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0xffffffff, 0xffffc001, 0xffffffff, 0xffff8001, 0x00000000, 0x00007fff,
      0x00000000, 0x00003fff, 0x00000000, 0x00000001, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffc000, 0xffffffff, 0xffff8000,
      0x00000000, 0x00008000, 0x00000000, 0x00004000, 0x00000000, 0x00000001,
      0x00000000, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0xffff8001,
      0xffffffff, 0xffff0001, 0x00000000, 0x0000ffff, 0x00000000, 0x00007fff,
      0x00000000, 0x00000002, 0x00000000, 0x00000001, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff, 0xfffffffe,
      0xffffffff, 0xffff8000, 0xffffffff, 0xffff0000, 0x00000000, 0x00010000,
      0x00000000, 0x00008000, 0x00000000, 0x00000002, 0x00000000, 0x00000002,
      0x00000000, 0x00000001, 0x00000000, 0x00000001, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0xffffffff, 0xffffff01, 0xffffffff, 0xffffff01, 0xffffffff, 0xfffffe01,
      0xffffffff, 0xfffffe01, 0xffffffff, 0xff800001, 0xffffffff, 0xff000001,
      0x00000000, 0x00ffffff, 0x00000000, 0x007fffff, 0x00000000, 0x00000200,
      0x00000000, 0x000001ff, 0x00000000, 0x00000100, 0x00000000, 0x000000ff,
      0x00000000, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0xffffffff, 0xffffffff, 0xffffffff, 0xffffff01, 0xffffffff, 0xffffff00,
      0xffffffff, 0xfffffe01, 0xffffffff, 0xfffffe00, 0xffffffff, 0xff800000,
      0xffffffff, 0xff000000, 0x00000000, 0x01000000, 0x00000000, 0x00800000,
      0x00000000, 0x00000200, 0x00000000, 0x00000200, 0x00000000, 0x00000100,
      0x00000000, 0x00000100, 0x00000000, 0x00000001, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0xffffffff, 0xffffffaa, 0xffffffff, 0xffffffaa, 0xffffffff, 0xffffa9cc,
      0xffffffff, 0xffffa9cc, 0xffffffff, 0xffff5398, 0xffffffff, 0xffff5397,
      0xffffffff, 0xd4e58e93, 0xffffffff, 0xa9cb1d25, 0x00000000, 0x5634e2db,
      0x00000000, 0x2b1a716d, 0x00000000, 0x0000ac6b, 0x00000000, 0x0000ac69,
      0x00000000, 0x00005635, 0x00000000, 0x00005634, 0x00000000, 0x00000056,
      0x00000000, 0x00000056, 0x00000000, 0x00000001, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0xffffffff, 0xffffff49, 0xffffffff, 0xffffff49,
      0xffffffff, 0xffff488a, 0xffffffff, 0xffff488a, 0xffffffff, 0xfffe9116,
      0xffffffff, 0xfffe9113, 0xffffffff, 0xa4449506, 0xffffffff, 0x48892a0b,
      0x00000000, 0xb776d5f5, 0x00000000, 0x5bbb6afa, 0x00000000, 0x00016ef0,
      0x00000000, 0x00016eed, 0x00000000, 0x0000b777, 0x00000000, 0x0000b776,
      0x00000000, 0x000000b7, 0x00000000, 0x000000b7, 0x00000000, 0x00000002,
      0x00000000, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xffffff01,
      0xffffffff, 0xffffff01, 0xffffffff, 0xffff0001, 0xffffffff, 0xffff0001,
      0xffffffff, 0xfffe0004, 0xffffffff, 0xfffe0001, 0xffffffff, 0x80000001,
      0xffffffff, 0x00000001, 0x00000000, 0xffffffff, 0x00000000, 0x7fffffff,
      0x00000000, 0x00020004, 0x00000000, 0x0001ffff, 0x00000000, 0x00010001,
      0x00000000, 0x0000ffff, 0x00000000, 0x00000100, 0x00000000, 0x000000ff,
      0x00000000, 0x00000002, 0x00000000, 0x00000001, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xffffffff,
      0xffffffff, 0xffffff01, 0xffffffff, 0xffffff00, 0xffffffff, 0xffff0001,
      0xffffffff, 0xffff0000, 0xffffffff, 0xfffe0004, 0xffffffff, 0xfffe0000,
      0xffffffff, 0x80000000, 0xffffffff, 0x00000000, 0x00000001, 0x00000000,
      0x00000000, 0x80000000, 0x00000000, 0x00020004, 0x00000000, 0x00020000,
      0x00000000, 0x00010001, 0x00000000, 0x00010000, 0x00000000, 0x00000100,
      0x00000000, 0x00000100, 0x00000000, 0x00000002, 0x00000000, 0x00000001,
      0x00000000, 0x00000001, 0x00000000, 0x00000001, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xffff0001,
      0xffffffff, 0xffff0001, 0xffffffff, 0xff000001, 0xffffffff, 0xff000001,
      0xffffffff, 0x00010000, 0xffffffff, 0x00000001, 0xfffffffe, 0x0003fff9,
      0xfffffffe, 0x00000001, 0xffff8000, 0x00000001, 0xffff0000, 0x00000001,
      0x0000ffff, 0xffffffff, 0x00007fff, 0xffffffff, 0x00000002, 0x00040008,
      0x00000001, 0xffffffff, 0x00000001, 0x00010001, 0x00000000, 0xffffffff,
      0x00000000, 0x01000001, 0x00000000, 0x00ffffff, 0x00000000, 0x0002f838,
      0x00000000, 0x00016536, 0x00000000, 0x00010000, 0x00000000, 0x0000ffff,
      0x00000000, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xffffffff,
      0xffffffff, 0xffff0001, 0xffffffff, 0xffff0000, 0xffffffff, 0xff000001,
      0xffffffff, 0xff000000, 0xffffffff, 0x00010000, 0xffffffff, 0x00000000,
      0xfffffffe, 0x0003fff9, 0xfffffffe, 0x00000000, 0xffff8000, 0x00000000,
      0xffff0000, 0x00000000, 0x00010000, 0x00000000, 0x00008000, 0x00000000,
      0x00000002, 0x00040008, 0x00000002, 0x00000000, 0x00000001, 0x00010001,
      0x00000001, 0x00000000, 0x00000000, 0x01000001, 0x00000000, 0x01000000,
      0x00000000, 0x0002f838, 0x00000000, 0x00016536, 0x00000000, 0x00010000,
      0x00000000, 0x00010000, 0x00000000, 0x00000001, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xfffffff1,
      0xffffffff, 0xfffffff1, 0xffffffff, 0xfff00001, 0xffffffff, 0xfff00001,
      0xffffffff, 0xf0000010, 0xffffffff, 0xf0000001, 0xfffffff0, 0x000ffff1,
      0xfffffff0, 0x00000001, 0xffffffe0, 0x003fff81, 0xffffffe0, 0x00000001,
      0xfff80000, 0x00000001, 0xfff00000, 0x00000001, 0x000fffff, 0xffffffff,
      0x0007ffff, 0xffffffff, 0x00000020, 0x00400080, 0x0000001f, 0xffffffff,
      0x00000010, 0x00100010, 0x0000000f, 0xffffffff, 0x00000000, 0x10000010,
      0x00000000, 0x0fffffff, 0x00000000, 0x002f8386, 0x00000000, 0x0016536c,
      0x00000000, 0x00100000, 0x00000000, 0x000fffff, 0x00000000, 0x00000010,
      0x00000000, 0x0000000f, 0x00000000, 0x00000001, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xffffffff,
      0xffffffff, 0xfffffff1, 0xffffffff, 0xfffffff0, 0xffffffff, 0xfff00001,
      0xffffffff, 0xfff00000, 0xffffffff, 0xf0000010, 0xffffffff, 0xf0000000,
      0xfffffff0, 0x000ffff1, 0xfffffff0, 0x00000000, 0xffffffe0, 0x003fff81,
      0xffffffe0, 0x00000000, 0xfff80000, 0x00000000, 0xfff00000, 0x00000000,
      0x00100000, 0x00000000, 0x00080000, 0x00000000, 0x00000020, 0x00400080,
      0x00000020, 0x00000000, 0x00000010, 0x00100010, 0x00000010, 0x00000000,
      0x00000000, 0x10000010, 0x00000000, 0x10000000, 0x00000000, 0x002f8386,
      0x00000000, 0x0016536c, 0x00000000, 0x00100000, 0x00000000, 0x00100000,
      0x00000000, 0x00000010, 0x00000000, 0x00000010, 0x00000000, 0x00000001,
      0x00000000, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0xffffffff, 0xffffffff, 0xffffffff, 0xfffffa9d,
      0xffffffff, 0xfffffa9d, 0xffffffff, 0xffffa9cc, 0xffffffff, 0xffffa9cc,
      0xffffffff, 0xa9cb1d25, 0xffffffff, 0xa9cb1d25, 0xffffffa9, 0xcb1d7a7e,
      0xffffffa9, 0xcb1d2449, 0xffffa9cb, 0x7358d531, 0xffffa9cb, 0x1d24488a,
      0xffff5397, 0x93196ae0, 0xffff5396, 0x3a489113, 0xd4e58e92, 0x24449506,
      0xa9cb1d24, 0x48892a0b, 0x5634e2db, 0xb776d5f5, 0x2b1a716d, 0xdbbb6afa,
      0x0000ac6b, 0x1e8dac09, 0x0000ac69, 0xc5b76eed, 0x00005635, 0x3910f087,
      0x00005634, 0xe2dbb776, 0x00000056, 0x34e331ec, 0x00000056, 0x34e2dbb7,
      0x00000001, 0x00000002, 0x00000000, 0x784a3552, 0x00000000, 0x5634e2dc,
      0x00000000, 0x5634e2db, 0x00000000, 0x00005634, 0x00000000, 0x00005634,
      0x00000000, 0x00000563, 0x00000000, 0x00000563, 0x00000000, 0x00000001,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xffffffff, 0xffffffff,
      0xffffffff, 0xfffff801, 0xffffffff, 0xfffff801, 0xffffffff, 0xffff8001,
      0xffffffff, 0xffff8001, 0xffffffff, 0x80000001, 0xffffffff, 0x80000001,
      0xffffff80, 0x00008000, 0xffffff80, 0x00000001, 0xffff8000, 0x7fff8001,
      0xffff8000, 0x00000001, 0xffff0001, 0xfffc0008, 0xffff0000, 0x00000001,
      0xc0000000, 0x00000001, 0x80000000, 0x00000001, 0x7fffffff, 0xffffffff,
      0x3fffffff, 0xffffffff, 0x00010002, 0x00040008, 0x0000ffff, 0xffffffff,
      0x00008000, 0x80008000, 0x00007fff, 0xffffffff, 0x00000080, 0x00008000,
      0x0000007f, 0xffffffff, 0x00000001, 0x7c1c33e6, 0x00000000, 0xb29b67a6,
      0x00000000, 0x80000000, 0x00000000, 0x7fffffff, 0x00000000, 0x00008000,
      0x00000000, 0x00007fff, 0x00000000, 0x00000800, 0x00000000, 0x000007ff,
      0x00000000, 0x00000001, 0x00000000, 0x00000001
    ];
toInt32s(TEST_DIV_BITS);

var TEST_STRINGS = [
      "-9223372036854775808",
      "-5226755067826871589",
      "-4503599627370497",
      "-4503599627370496",
      "-281474976710657",
      "-281474976710656",
      "-4294967297",
      "-4294967296",
      "-16777217",
      "-16777216",
      "-65537",
      "-65536",
      "-32769",
      "-32768",
      "-2",
      "-1",
      "0",
      "1",
      "2",
      "32767",
      "32768",
      "65535",
      "65536",
      "16777215",
      "16777216",
      "1446306523",
      "3078018549",
      "4294967295",
      "4294967296",
      "281474976710655",
      "281474976710656",
      "4503599627370495",
      "4503599627370496",
      "6211839219354490357",
      "9223372036854775807"
    ];

function testToFromBits() {
  for (var i = 0; i < TEST_BITS.length; i += 2) {
    var val = goog.math.Integer.fromBits([TEST_BITS[i+1], TEST_BITS[i]]);
    assertEquals(TEST_BITS[i], val.getBits(1));
    assertEquals(TEST_BITS[i+1], val.getBits(0));
  }
}

function testToFromInt() {
  for (var i = 0; i < TEST_BITS.length; i += 1) {
    var val = goog.math.Integer.fromInt(TEST_BITS[i]);
    assertEquals(TEST_BITS[i], val.toInt());
  }
}

function testToFromNumber() {
  for (var i = 0; i < TEST_BITS.length; i += 2) {
    var num = TEST_BITS[i] * Math.pow(2, 32) +
        TEST_BITS[i+1] >= 0 ? TEST_BITS[i+1] : Math.pow(2, 32) + TEST_BITS[i+1];
    var val = goog.math.Integer.fromNumber(num);
    assertEquals(num, val.toNumber());
  }
}

function testShorten() {
  for (var i = 0; i < TEST_BITS.length; i += 2) {
    var val = new goog.math.Integer([TEST_BITS[i+1], TEST_BITS[i]], 0);
    val = val.shorten(64);
    assertEquals(TEST_BITS[i], val.getBits(1));
    assertEquals(TEST_BITS[i+1], val.getBits(0));
  }

  val = new goog.math.Integer.fromBits([0x20000000, 0x01010000], 0);

  var val58 = val.shorten(58);
  assertEquals(0x01010000|0, val58.getBits(1));
  assertEquals(0x20000000|0, val58.getBits(0));

  var val57 = val.shorten(57);
  assertEquals(0xFF010000|0, val57.getBits(1));
  assertEquals(0x20000000|0, val57.getBits(0));

  var val56 = val.shorten(56);
  assertEquals(0x00010000|0, val56.getBits(1));
  assertEquals(0x20000000|0, val56.getBits(0));

  var val50 = val.shorten(50);
  assertEquals(0x00010000|0, val50.getBits(1));
  assertEquals(0x20000000|0, val50.getBits(0));

  var val49 = val.shorten(49);
  assertEquals(0xFFFF0000|0, val49.getBits(1));
  assertEquals(0x20000000|0, val49.getBits(0));

  var val32 = val.shorten(32);
  assertEquals(0x00000000|0, val32.getBits(1));
  assertEquals(0x20000000|0, val32.getBits(0));

  var val31 = val.shorten(31);
  assertEquals(0x00000000|0, val31.getBits(1));
  assertEquals(0x20000000|0, val31.getBits(0));

  var val30 = val.shorten(30);
  assertEquals(0xFFFFFFFF|0, val30.getBits(1));
  assertEquals(0xE0000000|0, val30.getBits(0));

  var val29 = val.shorten(29);
  assertEquals(0x00000000|0, val29.getBits(1));
  assertEquals(0x00000000|0, val29.getBits(0));
}

function testIsZero() {
  for (var i = 0; i < TEST_BITS.length; i += 2) {
    var val = goog.math.Integer.fromBits([TEST_BITS[i+1], TEST_BITS[i]]);
    assertEquals(TEST_BITS[i] == 0 && TEST_BITS[i+1] == 0, val.isZero());
  }
}

function testIsNegative() {
  for (var i = 0; i < TEST_BITS.length; i += 2) {
    var val = goog.math.Integer.fromBits([TEST_BITS[i+1], TEST_BITS[i]]);
    assertEquals((TEST_BITS[i] >> 31) != 0, val.isNegative());
  }
}

function testIsOdd() {
  for (var i = 0; i < TEST_BITS.length; i += 2) {
    var val = goog.math.Integer.fromBits([TEST_BITS[i+1], TEST_BITS[i]]);
    assertEquals((TEST_BITS[i+1] & 1) != 0, val.isOdd());
  }
}

function createTestComparisons(i) {
  return function() {
    var vi = goog.math.Integer.fromBits([TEST_BITS[i+1], TEST_BITS[i]]);
    for (var j = 0; j < TEST_BITS.length; j += 2) {
      var vj = goog.math.Integer.fromBits([TEST_BITS[j+1], TEST_BITS[j]]);
      assertEquals(i == j, vi.equals(vj));
      assertEquals(i != j, vi.notEquals(vj));
      assertEquals(i < j, vi.lessThan(vj));
      assertEquals(i <= j, vi.lessThanOrEqual(vj));
      assertEquals(i > j, vi.greaterThan(vj));
      assertEquals(i >= j, vi.greaterThanOrEqual(vj));
    }
  };
}

// Here and below, we translate one conceptual test (e.g., "testComparisons")
// into a number of test functions that will be run separately by jsunit. This
// is necessary because, in some testing configurations, the full combined test
// can take so long that it times out. These smaller tests run much faster.
for (var i = 0; i < TEST_BITS.length; i += 2) {
  goog.global['testComparisons' + i] = createTestComparisons(i);
}

function createTestBitOperations(i) {
  return function() {
    var vi = goog.math.Integer.fromBits([TEST_BITS[i+1], TEST_BITS[i]]);
    assertEquals(~TEST_BITS[i], vi.not().getBits(1));
    assertEquals(~TEST_BITS[i+1], vi.not().getBits(0));

    for (var j = 0; j < TEST_BITS.length; j += 2) {
      var vj = goog.math.Integer.fromBits([TEST_BITS[j+1], TEST_BITS[j]]);
      assertEquals(TEST_BITS[i] & TEST_BITS[j], vi.and(vj).getBits(1));
      assertEquals(TEST_BITS[i+1] & TEST_BITS[j+1], vi.and(vj).getBits(0));
      assertEquals(TEST_BITS[i] | TEST_BITS[j], vi.or(vj).getBits(1));
      assertEquals(TEST_BITS[i+1] | TEST_BITS[j+1], vi.or(vj).getBits(0));
      assertEquals(TEST_BITS[i] ^ TEST_BITS[j], vi.xor(vj).getBits(1));
      assertEquals(TEST_BITS[i+1] ^ TEST_BITS[j+1], vi.xor(vj).getBits(0));
    }

    assertEquals(TEST_BITS[i], vi.shiftLeft(0).getBits(1));
    assertEquals(TEST_BITS[i+1], vi.shiftLeft(0).getBits(0));
    assertEquals(TEST_BITS[i], vi.shiftRight(0).getBits(1));
    assertEquals(TEST_BITS[i+1], vi.shiftRight(0).getBits(0));

    for (var len = 1; len < 64; ++len) {
      if (len < 32) {
        assertEquals((TEST_BITS[i] << len) | (TEST_BITS[i+1] >>> (32 - len)),
                     vi.shiftLeft(len).getBits(1));
        assertEquals(TEST_BITS[i+1] << len, vi.shiftLeft(len).getBits(0));

        assertEquals(TEST_BITS[i] >> len, vi.shiftRight(len).getBits(1));
        assertEquals((TEST_BITS[i+1] >>> len) | (TEST_BITS[i] << (32 - len)),
                     vi.shiftRight(len).getBits(0));
      } else {
        assertEquals(TEST_BITS[i+1] << (len - 32),
                     vi.shiftLeft(len).getBits(1));
        assertEquals(0, vi.shiftLeft(len).getBits(0));

        assertEquals(TEST_BITS[i] >= 0 ? 0 : -1, vi.shiftRight(len).getBits(1));
        assertEquals(TEST_BITS[i] >> (len - 32), vi.shiftRight(len).getBits(0));
      }
    }

    assertEquals(0, vi.shiftLeft(64).getBits(1));
    assertEquals(0, vi.shiftLeft(64).getBits(0));
    assertEquals(TEST_BITS[i] & (1 << 31) ? -1 : 0,
                 vi.shiftRight(64).getBits(1));
    assertEquals(TEST_BITS[i] & (1 << 31) ? -1 : 0,
                 vi.shiftRight(64).getBits(0));
  };
}

for (var i = 0; i < TEST_BITS.length; i += 2) {
  goog.global['testBitOperations' + i] = createTestBitOperations(i);
}

function testNegation() {
  for (var i = 0; i < TEST_BITS.length; i += 2) {
    var vi = goog.math.Integer.fromBits([TEST_BITS[i+1], TEST_BITS[i]]);
    if (TEST_BITS[i+1] == 0) {
      assertEquals((~TEST_BITS[i] + 1)|0, vi.negate().getBits(1));
      assertEquals(0, vi.negate().getBits(0));
    } else {
      assertEquals(~TEST_BITS[i], vi.negate().getBits(1));
      assertEquals((~TEST_BITS[i+1] + 1)|0, vi.negate().getBits(0));
    }
  }
}

function createTestAdd(i, count) {
  return function() {
    var vi = goog.math.Integer.fromBits([TEST_BITS[i+1], TEST_BITS[i]]);
    for (var j = 0; j < i; j += 2) {
      var vj = goog.math.Integer.fromBits([TEST_BITS[j+1], TEST_BITS[j]]);
      var result = vi.add(vj);
      assertEquals(TEST_ADD_BITS[count++], result.getBits(1));
      assertEquals(TEST_ADD_BITS[count++], result.getBits(0));
    }
  };
}

var countAdd = 0;
for (var i = 0; i < TEST_BITS.length; i += 2) {
  goog.global['testAdd' + i] = createTestAdd(i, countAdd);
  countAdd += i;
}

function createTestSubtract(i, count) {
  return function() {
    var vi = goog.math.Integer.fromBits([TEST_BITS[i+1], TEST_BITS[i]]);
    for (var j = 0; j < TEST_BITS.length; j += 2) {
      var vj = goog.math.Integer.fromBits([TEST_BITS[j+1], TEST_BITS[j]]);
      var result = vi.subtract(vj);
      assertEquals(TEST_SUB_BITS[count++], result.getBits(1));
      assertEquals(TEST_SUB_BITS[count++], result.getBits(0));
    }
  };
}

var countSubtract = 0;
for (var i = 0; i < TEST_BITS.length; i += 2) {
  goog.global['testSubtract' + i] = createTestSubtract(i, countSubtract);
  countSubtract += TEST_BITS.length;
}

function createTestMultiply(i, count) {
  return function() {
    var vi = goog.math.Integer.fromBits([TEST_BITS[i+1], TEST_BITS[i]]);
    for (var j = 0; j < i; j += 2) {
      var vj = goog.math.Integer.fromBits([TEST_BITS[j+1], TEST_BITS[j]]);
      var result = vi.multiply(vj);
      assertEquals(TEST_MUL_BITS[count++], result.getBits(1));
      assertEquals(TEST_MUL_BITS[count++], result.getBits(0));
    }
  };
}

var countMultiply = 0;
for (var i = 0; i < TEST_BITS.length; i += 2) {
  goog.global['testMultiply' + i] = createTestMultiply(i, countMultiply);
  countMultiply += i;
}

function createTestDivMod(i, count) {
  return function() {
    var vi = goog.math.Integer.fromBits([TEST_BITS[i+1], TEST_BITS[i]]);
    for (var j = 0; j < TEST_BITS.length; j += 2) {
      var vj = goog.math.Integer.fromBits([TEST_BITS[j+1], TEST_BITS[j]]);
      if (!vj.isZero()) {
        var divResult = vi.divide(vj);
        assertEquals(TEST_DIV_BITS[count++], divResult.getBits(1));
        assertEquals(TEST_DIV_BITS[count++], divResult.getBits(0));

        var modResult = vi.modulo(vj);
        var combinedResult = divResult.multiply(vj).add(modResult);
        assertTrue(vi.equals(combinedResult));
      }
    }
  };
}

var countPerDivModCall = 0;
for (var j = 0; j < TEST_BITS.length; j += 2) {
  var vj = goog.math.Integer.fromBits([TEST_BITS[j+1], TEST_BITS[j]]);
  if (!vj.isZero()) {
    countPerDivModCall += 2;
  }
}

var countDivMod = 0;
for (var i = 0; i < TEST_BITS.length; i += 2) {
  goog.global['testDivMod' + i] = createTestDivMod(i, countDivMod);
  countDivMod += countPerDivModCall;
}

function createTestToFromString(i) {
  return function() {
    var vi = goog.math.Integer.fromBits([TEST_BITS[i+1], TEST_BITS[i]]);
    var str = vi.toString(10);
    assertEquals(TEST_STRINGS[i/2], str);
    assertEquals(TEST_BITS[i],
                 goog.math.Integer.fromString(str, 10).getBits(1));
    assertEquals(TEST_BITS[i+1],
                 goog.math.Integer.fromString(str, 10).getBits(0));

    for (var radix = 2; radix <= 36; ++radix) {
      var result = vi.toString(radix);
      assertEquals(TEST_BITS[i],
                   goog.math.Integer.fromString(result, radix).getBits(1));
      assertEquals(TEST_BITS[i+1],
                   goog.math.Integer.fromString(result, radix).getBits(0));
    }
  };
}

for (var i = 0; i < TEST_BITS.length; i += 2) {
  goog.global['testToFromString' + i] = createTestToFromString(i);
}

function testBigMultiply() {
  var a = goog.math.Integer.fromString("2389428394283434234234");
  var b = goog.math.Integer.fromString("895489472863784783");
  assertEquals("2139707973242632227811083664960586861222",
               a.multiply(b).toString());
  assertEquals("2139707973242632227811083664960586861222",
               b.multiply(a).toString());

  a = goog.math.Integer.fromString("123940932409302930429304");
  b = goog.math.Integer.fromString("-23940239409234");
  assertEquals("-2967175594482401511466585794961793136",
               a.multiply(b).toString());

  a = goog.math.Integer.fromString("-4895849540949");
  b = goog.math.Integer.fromString("5906390354334334989");
  assertEquals("-28916798504933355408364838964561",
               a.multiply(b).toString());

  a = goog.math.Integer.fromString("-23489238492334893");
  b = goog.math.Integer.fromString("-2930482394829348293489234");
  assertEquals("68834799869735267747353413198446618041962",
               a.multiply(b).toString());

  a = goog.math.Integer.fromString("-39403940");
  b = goog.math.Integer.fromString("-90689586573473848347384834");
  assertEquals("3573527027965969111849451155845960",
               a.multiply(b).toString());
}

function testBigShift() {
  var a = goog.math.Integer.fromString("3735928559");
  assertEquals("591981510028266767381876356163880091648",
               a.shiftLeft(97).toString());
  assertEquals("-591981510028266767381876356163880091648",
               a.negate().shiftLeft(97).toString());
}
">n/a</td></tr>
<tr><td>vec3_test.html</td><td>Success</td><td> 21 passed, 0 failed.</td><td title="

  goog.require('goog.testing.jsunit');
  goog.require('goog.math.Vec3');
  goog.require('goog.math.Coordinate3');



function assertVec3Equals(a, b) {
  assertTrue(b + ' should be equal to ' + a, goog.math.Vec3.equals(a, b));
}

function testVec3() {
  var a = new goog.math.Vec3();
  assertEquals(0, a.x);
  assertEquals(0, a.y);
  assertEquals(0, a.z);

  var b = new goog.math.Vec3(4);
  assertEquals(4, b.x);
  assertEquals(0, b.y);
  assertEquals(0, b.z);

  var c = new goog.math.Vec3(3.14, 2.78, -7.21);
  assertEquals(3.14, c.x);
  assertEquals(2.78, c.y);
  assertEquals(-7.21, c.z);
}


function testRandomUnit() {
  var a = goog.math.Vec3.randomUnit();
  assertRoughlyEquals(1.0, a.magnitude(), 1e-10);
}


function testRandom() {
  var a = goog.math.Vec3.random();
  assertTrue(a.magnitude() <= 1.0);
}


function testFromCoordinate3() {
  var a = new goog.math.Coordinate3(-2, 10, 4);
  var b = goog.math.Vec3.fromCoordinate3(a);
  assertEquals(-2, b.x);
  assertEquals(10, b.y);
  assertEquals(4, b.z);
}


function testClone() {
  var a = new goog.math.Vec3(1, 2, 5);
  var b = a.clone();

  assertEquals(a.x, b.x);
  assertEquals(a.y, b.y);
  assertEquals(a.z, b.z);
}


function testMagnitude() {
  var a = new goog.math.Vec3(0, 10, 0);
  var b = new goog.math.Vec3(3, 4, 5);
  var c = new goog.math.Vec3(-4, 3, 8);

  assertEquals(10, a.magnitude());
  assertEquals(Math.sqrt(50), b.magnitude());
  assertEquals(Math.sqrt(89), c.magnitude());
}


function testSquaredMagnitude() {
  var a = new goog.math.Vec3(-3, -4, -5);
  assertEquals(50, a.squaredMagnitude());
}


function testScale() {
  var a = new goog.math.Vec3(1, 2, 3);
  a.scale(0.5);

  assertEquals(0.5, a.x);
  assertEquals(1, a.y);
  assertEquals(1.5, a.z);
}


function testInvert() {
  var a = new goog.math.Vec3(3, 4, 5);
  a.invert();

  assertEquals(-3, a.x);
  assertEquals(-4, a.y);
  assertEquals(-5, a.z);
}


function testNormalize() {
  var a = new goog.math.Vec3(5, 5, 5);
  a.normalize();
  assertRoughlyEquals(1.0, a.magnitude(), 1e-10);
}


function testAdd() {
  var a = new goog.math.Vec3(1, -1, 7);
  a.add(new goog.math.Vec3(3, 3, 3));
  assertVec3Equals(new goog.math.Vec3(4, 2, 10), a);
}


function testSubtract() {
  var a = new goog.math.Vec3(1, -1, 4);
  a.subtract(new goog.math.Vec3(3, 3, 3));
  assertVec3Equals(new goog.math.Vec3(-2, -4, 1), a);
}


function testEquals() {
  var a = new goog.math.Vec3(1, 2, 5);

  assertFalse(a.equals(null));
  assertFalse(a.equals(new goog.math.Vec3(1, 3, 5)));
  assertFalse(a.equals(new goog.math.Vec3(2, 2, 2)));

  assertTrue(a.equals(a));
  assertTrue(a.equals(new goog.math.Vec3(1, 2, 5)));
}


function testSum() {
  var a = new goog.math.Vec3(0.5, 0.25, 1.2);
  var b = new goog.math.Vec3(0.5, 0.75, -0.6);

  var c = goog.math.Vec3.sum(a, b);
  assertVec3Equals(new goog.math.Vec3(1, 1, 0.6), c);
}


function testDifference() {
  var a = new goog.math.Vec3(0.5, 0.25, 3);
  var b = new goog.math.Vec3(0.5, 0.75, 5);

  var c = goog.math.Vec3.difference(a, b);
  assertVec3Equals(new goog.math.Vec3(0, -0.5, -2), c);
}


function testDistance() {
  var a = new goog.math.Vec3(3, 4, 5);
  var b = new goog.math.Vec3(-3, -4, 5);

  assertEquals(10, goog.math.Vec3.distance(a, b));
}


function testSquaredDistance() {
  var a = new goog.math.Vec3(3, 4, 5);
  var b = new goog.math.Vec3(-3, -4, 5);

  assertEquals(100, goog.math.Vec3.squaredDistance(a, b));
}


function testVec3Equals() {
  assertTrue(goog.math.Vec3.equals(null, null, null));
  assertFalse(goog.math.Vec3.equals(null, new goog.math.Vec3()));

  var a = new goog.math.Vec3(1, 3, 5);
  assertTrue(goog.math.Vec3.equals(a, a));
  assertTrue(goog.math.Vec3.equals(a, new goog.math.Vec3(1, 3, 5)));
  assertFalse(goog.math.Vec3.equals(1, new goog.math.Vec3(3, 1, 5)));
}


function testDot() {
  var a = new goog.math.Vec3(0, 5, 2);
  var b = new goog.math.Vec3(3, 0, 5);
  assertEquals(10, goog.math.Vec3.dot(a, b));

  var c = new goog.math.Vec3(-5, -5, 5);
  var d = new goog.math.Vec3(0, 7, -2);
  assertEquals(-45, goog.math.Vec3.dot(c, d));
}


function testCross() {
  var a = new goog.math.Vec3(3, 0, 0);
  var b = new goog.math.Vec3(0, 2, 0);
  assertVec3Equals(new goog.math.Vec3(0, 0, 6), goog.math.Vec3.cross(a, b));

  var c = new goog.math.Vec3(1, 2, 3);
  var d = new goog.math.Vec3(4, 5, 6);
  assertVec3Equals(new goog.math.Vec3(-3, 6, -3), goog.math.Vec3.cross(c, d));
}


function testLerp() {
  var a = new goog.math.Vec3(0, 0, 0);
  var b = new goog.math.Vec3(10, 10, 10);

  for (var i = 0; i <= 10; i++) {
    var c = goog.math.Vec3.lerp(a, b, i / 10);
    assertEquals(i, c.x);
    assertEquals(i, c.y);
    assertEquals(i, c.z);
  }
}

">n/a</td></tr>
<tr><td>vec2_test.html</td><td>Success</td><td> 20 passed, 0 failed.</td><td title="

  goog.require('goog.math.Coordinate');
  goog.require('goog.math.Vec2');
  goog.require('goog.testing.jsunit');



function assertVectorEquals(a, b) {
  assertTrue(b + ' should be equal to ' + a, goog.math.Vec2.equals(a, b));
}


function testVec2() {
  var a = new goog.math.Vec2();
  assertEquals(0, a.x);
  assertEquals(0, a.y);

  var b = new goog.math.Vec2(4);
  assertEquals(4, b.x);
  assertEquals(0, b.y);

  var c = new goog.math.Vec2(3.14, 2.78);
  assertEquals(3.14, c.x);
  assertEquals(2.78, c.y);
}


function testRandomUnit() {
  var a = goog.math.Vec2.randomUnit();
  assertRoughlyEquals(1.0, a.magnitude(), 1e-10);
}


function testRandom() {
  var a = goog.math.Vec2.random();
  assertTrue(a.magnitude() <= 1.0);
}


function testClone() {
  var a = new goog.math.Vec2(1, 2);
  var b = a.clone();

  assertEquals(a.x, b.x);
  assertEquals(a.y, b.y);
}


function testMagnitude() {
  var a = new goog.math.Vec2(0, 10);
  var b = new goog.math.Vec2(3, 4);

  assertEquals(10, a.magnitude());
  assertEquals(5, b.magnitude());
}


function testSquaredMagnitude() {
  var a = new goog.math.Vec2(-3, -4);
  assertEquals(25, a.squaredMagnitude());
}


function testScale() {
  var a = new goog.math.Vec2(1, 2);
  a.scale(0.5);

  assertEquals(0.5, a.x);
  assertEquals(1, a.y);
}


function testInvert() {
  var a = new goog.math.Vec2(3, 4);
  a.invert();

  assertEquals(-3, a.x);
  assertEquals(-4, a.y);
}


function testNormalize() {
  var a = new goog.math.Vec2(5, 5);
  a.normalize();
  assertRoughlyEquals(1.0, a.magnitude(), 1e-10);
}


function testAdd() {
  var a = new goog.math.Vec2(1, -1);
  a.add(new goog.math.Vec2(3, 3));
  assertVectorEquals(new goog.math.Vec2(4, 2), a);
}


function testSubtract() {
  var a = new goog.math.Vec2(1, -1);
  a.subtract(new goog.math.Vec2(3, 3));
  assertVectorEquals(new goog.math.Vec2(-2, -4), a);
}


function testEquals() {
  var a = new goog.math.Vec2(1, 2);

  assertFalse(a.equals(null));
  assertFalse(a.equals(new goog.math.Vec2(1, 3)));
  assertFalse(a.equals(new goog.math.Vec2(2, 2)));

  assertTrue(a.equals(a));
  assertTrue(a.equals(new goog.math.Vec2(1, 2)));
}


function testSum() {
  var a = new goog.math.Vec2(0.5, 0.25);
  var b = new goog.math.Vec2(0.5, 0.75);

  var c = goog.math.Vec2.sum(a, b);
  assertVectorEquals(new goog.math.Vec2(1, 1), c);
}


function testDifference() {
  var a = new goog.math.Vec2(0.5, 0.25);
  var b = new goog.math.Vec2(0.5, 0.75);

  var c = goog.math.Vec2.difference(a, b);
  assertVectorEquals(new goog.math.Vec2(0, -0.5), c);
}


function testDistance() {
  var a = new goog.math.Vec2(3, 4);
  var b = new goog.math.Vec2(-3, -4);

  assertEquals(10, goog.math.Vec2.distance(a, b));
}


function testSquaredDistance() {
  var a = new goog.math.Vec2(3, 4);
  var b = new goog.math.Vec2(-3, -4);

  assertEquals(100, goog.math.Vec2.squaredDistance(a, b));
}


function testVec2Equals() {
  assertTrue(goog.math.Vec2.equals(null, null));
  assertFalse(goog.math.Vec2.equals(null, new goog.math.Vec2()));

  var a = new goog.math.Vec2(1, 3);
  assertTrue(goog.math.Vec2.equals(a, a));
  assertTrue(goog.math.Vec2.equals(a, new goog.math.Vec2(1, 3)));
  assertFalse(goog.math.Vec2.equals(1, new goog.math.Vec2(3, 1)));
}


function testDot() {
  var a = new goog.math.Vec2(0, 5);
  var b = new goog.math.Vec2(3, 0);
  assertEquals(0, goog.math.Vec2.dot(a, b));

  var c = new goog.math.Vec2(-5, -5);
  var d = new goog.math.Vec2(0, 7);
  assertEquals(-35, goog.math.Vec2.dot(c, d));
}


function testLerp() {
  var a = new goog.math.Vec2(0, 0);
  var b = new goog.math.Vec2(10, 10);

  for (var i = 0; i <= 10; i++) {
    var c = goog.math.Vec2.lerp(a, b, i / 10);
    assertEquals(i, c.x);
    assertEquals(i, c.y);
  }
}


function testToString() {
  testEquals('(0, 0)', new goog.math.Vec2(0, 0).toString());
}

">n/a</td></tr>
<tr><td>rangeset_test.html</td><td>Success</td><td> 23 passed, 0 failed.</td><td title="

goog.require('goog.iter');
goog.require('goog.math.Range');
goog.require('goog.math.RangeSet');
goog.require('goog.testing.jsunit');




/**
 * Produce legible assertion results for comparing ranges. The expected range
 * may be defined as a goog.math.Range or as a two-element array of numbers. If
 * two ranges are not equal, the error message will be in the format:
 * "Expected <[1, 2]> (Object) but was <[3, 4]> (Object)"
 *
 * @param {!goog.math.Range|!Array.<number>|string} a A descriptive string or
 *     the expected range.
 * @param {!goog.math.Range|!Array.<number>} b The expected range when a
 *     descriptive string is present, or the range to compare.
 * @param {goog.math.Range=} opt_c The range to compare when a descriptive
 *     string is present.
 */
function assertRangesEqual(a, b, opt_c) {
  var message = opt_c ? a : '';
  var expected = opt_c ? b : a;
  var actual = opt_c ? opt_c : b;

  if (goog.isArray(expected)) {
    assertEquals(message + '\n' +
                 'Expected ranges must be specified as goog.math.Range ' +
                 'objects or as 2-element number arrays. Found [' +
                 expected.join(', ') + ']',
                 2, expected.length);
    expected = new goog.math.Range(expected[0], expected[1]);
  }

  if (!goog.math.Range.equals(/** @type {!goog.math.Range} */ (expected),
                              /** @type {!goog.math.Range} */ (actual))) {
    if (message) {
      assertEquals(message, expected, actual);
    } else {
      assertEquals(expected, actual);
    }
  }
}


/**
 * Produce legible assertion results for comparing two lists of ranges. Expected
 * lists may be specified as a list of goog.math.Ranges, or as a list of
 * two-element arrays of numbers.
 *
 * @param {Array.<goog.math.Range|Array.<number>>|string} a A help
 *     string or the list of expected ranges.
 * @param {Array.<goog.math.Range|Array.<number>>} b The list of
 *     expected ranges when a descriptive string is present, or the list of
 *     ranges to compare.
 * @param {Array.<goog.math.Range>=} opt_c The list of ranges to compare when a
 *     descriptive string is present.
 */
function assertRangeListsEqual(a, b, opt_c) {
  var message = opt_c ? a + '\n' : '';
  var expected = opt_c ? b : a;
  var actual = opt_c ? opt_c : b;

  assertEquals(message + 'Array lengths unequal.',
               expected.length, actual.length);

  for (var i = 0; i < expected.length; i++) {
    assertRangesEqual(message + 'Range ' + i + ' mismatch.',
                      expected[i], actual[i]);
  }
}


function testClone() {
  var r = new goog.math.RangeSet();

  var test = new goog.math.RangeSet(r);
  assertRangeListsEqual([], test.ranges_);

  r.add(new goog.math.Range(-10, -2));
  r.add(new goog.math.Range(2.72, 3.14));
  r.add(new goog.math.Range(8, 11));

  test = r.clone();
  assertRangeListsEqual([[-10, -2], [2.72, 3.14], [8, 11]], test.ranges_);

  var test2 = r.clone();
  assertRangeListsEqual(test.ranges_, test2.ranges_);

  assertNotEquals('The clones should not share the same list reference.',
                  test.ranges_, test2.ranges_);

  for (var i = 0; i < test.ranges_.length; i++) {
    assertNotEquals('The clones should not share references to ranges.',
                    test.ranges_[i], test2.ranges_[i]);
  }
}


function testAddNoCorruption() {
  var r = new goog.math.RangeSet();

  var range = new goog.math.Range(1, 2);
  r.add(range);

  assertNotEquals('Only a copy of the input range should be stored.',
                  range, r.ranges_[0]);

  range.end = 5;
  assertRangeListsEqual('Modifying an input range after use should not ' +
                        'affect the set.',
                        [[1, 2]], r.ranges_);
}


function testAdd() {
  var r = new goog.math.RangeSet();

  r.add(new goog.math.Range(7, 12));
  assertRangeListsEqual([[7, 12]], r.ranges_);

  r.add(new goog.math.Range(1, 3));
  assertRangeListsEqual([[1, 3], [7, 12]], r.ranges_);

  r.add(new goog.math.Range(13, 18));
  assertRangeListsEqual([[1, 3], [7, 12], [13, 18]], r.ranges_);

  r.add(new goog.math.Range(5, 5));
  assertRangeListsEqual('Zero length ranges should be ignored.',
                        [[1, 3], [7, 12], [13, 18]], r.ranges_);

  var badRange = new goog.math.Range(5, 5);
  badRange.end = 4;
  r.add(badRange);
  assertRangeListsEqual('Negative length ranges should be ignored.',
                        [[1, 3], [7, 12], [13, 18]], r.ranges_);

  r.add(new goog.math.Range(-22, -15));
  assertRangeListsEqual('Negative ranges should work fine.',
                        [[-22, -15], [1, 3], [7, 12], [13, 18]], r.ranges_);

  r.add(new goog.math.Range(3.1, 6.9));
  assertRangeListsEqual('Non-integer ranges should work fine.',
                        [[-22, -15], [1, 3], [3.1, 6.9], [7, 12], [13, 18]],
                        r.ranges_);
}


function testAddWithOverlaps() {
  var r = new goog.math.RangeSet();

  r.add(new goog.math.Range(7, 12));
  r.add(new goog.math.Range(5, 8));
  assertRangeListsEqual([[5, 12]], r.ranges_);

  r.add(new goog.math.Range(15, 20));
  r.add(new goog.math.Range(18, 25));
  assertRangeListsEqual([[5, 12], [15, 25]], r.ranges_);

  r.add(new goog.math.Range(10, 17));
  assertRangeListsEqual([[5, 25]], r.ranges_);

  r.add(new goog.math.Range(-4, 4.5));
  assertRangeListsEqual([[-4, 4.5], [5, 25]], r.ranges_);

  r.add(new goog.math.Range(4.2, 5.3));
  assertRangeListsEqual([[-4, 25]], r.ranges_);
}


function testAddWithAdjacentSpans() {
  var r = new goog.math.RangeSet();

  r.add(new goog.math.Range(7, 12));
  r.add(new goog.math.Range(13, 19));
  assertRangeListsEqual([[7, 12], [13, 19]], r.ranges_);

  r.add(new goog.math.Range(4, 6));
  assertRangeListsEqual([[4, 6], [7, 12], [13, 19]], r.ranges_);

  r.add(new goog.math.Range(6, 7));
  assertRangeListsEqual([[4, 12], [13, 19]], r.ranges_);

  r.add(new goog.math.Range(12, 13));
  assertRangeListsEqual([[4, 19]], r.ranges_);

  r.add(new goog.math.Range(19.1, 22));
  assertRangeListsEqual([[4, 19], [19.1, 22]], r.ranges_);

  r.add(new goog.math.Range(19, 19.1));
  assertRangeListsEqual([[4, 22]], r.ranges_);

  r.add(new goog.math.Range(-3, -2));
  assertRangeListsEqual([[-3, -2], [4, 22]], r.ranges_);

  r.add(new goog.math.Range(-2, 4));
  assertRangeListsEqual([[-3, 22]], r.ranges_);
}


function testAddWithSubsets() {
  var r = new goog.math.RangeSet();

  r.add(new goog.math.Range(7, 12));
  assertRangeListsEqual([[7, 12]], r.ranges_);

  r.add(new goog.math.Range(7, 12));
  assertRangeListsEqual([[7, 12]], r.ranges_);

  r.add(new goog.math.Range(8, 11));
  assertRangeListsEqual([[7, 12]], r.ranges_);

  for (var i = 20; i < 30; i += 2) {
    r.add(new goog.math.Range(i, i + 1));
  }
  assertRangeListsEqual(
      [[7, 12], [20, 21], [22, 23], [24, 25], [26, 27], [28, 29]],
      r.ranges_);

  r.add(new goog.math.Range(1, 30));
  assertRangeListsEqual([[1, 30]], r.ranges_);
}


function testRemove() {
  var r = new goog.math.RangeSet();

  r.add(new goog.math.Range(1, 3));
  r.add(new goog.math.Range(7, 8));
  r.add(new goog.math.Range(10, 20));

  r.remove(new goog.math.Range(3, 6));
  assertRangeListsEqual([[1, 3], [7, 8], [10, 20]], r.ranges_);

  r.remove(new goog.math.Range(7, 8));
  assertRangeListsEqual([[1, 3], [10, 20]], r.ranges_);

  r.remove(new goog.math.Range(1, 3));
  assertRangeListsEqual([[10, 20]], r.ranges_);

  r.remove(new goog.math.Range(8, 11));
  assertRangeListsEqual([[11, 20]], r.ranges_);

  r.remove(new goog.math.Range(18, 25));
  assertRangeListsEqual([[11, 18]], r.ranges_);

  r.remove(new goog.math.Range(15, 16));
  assertRangeListsEqual([[11, 15], [16, 18]], r.ranges_);

  r.remove(new goog.math.Range(11, 15));
  assertRangeListsEqual([[16, 18]], r.ranges_);

  r.remove(new goog.math.Range(16, 16));
  assertRangeListsEqual('Empty ranges should be ignored.',
                        [[16, 18]], r.ranges_);

  r.remove(new goog.math.Range(16, 17));
  assertRangeListsEqual([[17, 18]], r.ranges_);

  r.remove(new goog.math.Range(17, 18));
  assertRangeListsEqual([], r.ranges_);
}


function testRemoveWithNonOverlappingRanges() {
  var r = new goog.math.RangeSet();

  r.add(new goog.math.Range(10, 20));

  r.remove(new goog.math.Range(5, 8));
  assertRangeListsEqual('Non-overlapping ranges should be ignored.',
                        [[10, 20]], r.ranges_);

  r.remove(new goog.math.Range(20, 30));
  assertRangeListsEqual('Non-overlapping ranges should be ignored.',
                        [[10, 20]], r.ranges_);

  r.remove(new goog.math.Range(15, 15));
  assertRangeListsEqual('Zero-length ranges should be ignored.',
                        [[10, 20]], r.ranges_);
}


function testRemoveWithIdenticalRanges() {
  var r = new goog.math.RangeSet();

  r.add(new goog.math.Range(10, 20));
  r.add(new goog.math.Range(30, 40));
  r.add(new goog.math.Range(50, 60));
  assertRangeListsEqual([[10, 20], [30, 40], [50, 60]], r.ranges_);

  r.remove(new goog.math.Range(30, 40));
  assertRangeListsEqual([[10, 20], [50, 60]], r.ranges_);

  r.remove(new goog.math.Range(50, 60));
  assertRangeListsEqual([[10, 20]], r.ranges_);

  r.remove(new goog.math.Range(10, 20));
  assertRangeListsEqual([], r.ranges_);
}


function testRemoveWithOverlappingSubsets() {
  var r = new goog.math.RangeSet();

  r.add(new goog.math.Range(1, 10));

  r.remove(new goog.math.Range(1, 4));
  assertRangeListsEqual([[4, 10]], r.ranges_);

  r.remove(new goog.math.Range(8, 10));
  assertRangeListsEqual([[4, 8]], r.ranges_);
}


function testRemoveMultiple() {
  var r = new goog.math.RangeSet();

  r.add(new goog.math.Range(5, 8));
  r.add(new goog.math.Range(10, 20));
  r.add(new goog.math.Range(30, 35));

  for (var i = 20; i < 30; i += 2) {
    r.add(new goog.math.Range(i, i + 1));
  }

  assertRangeListsEqual(
      'Setting up the test data seems to have failed, how embarrassing.',
      [[5, 8], [10, 21], [22, 23], [24, 25], [26, 27], [28, 29], [30, 35]],
      r.ranges_);

  r.remove(new goog.math.Range(15, 32));
  assertRangeListsEqual([[5, 8], [10, 15], [32, 35]],
                        r.ranges_);
}


function testRemoveWithRealNumbers() {
  var r = new goog.math.RangeSet();

  r.add(new goog.math.Range(2, 4));

  r.remove(new goog.math.Range(1.1, 2.72));
  assertRangeListsEqual([[2.72, 4]], r.ranges_);

  r.remove(new goog.math.Range(3.14, 5));
  assertRangeListsEqual([[2.72, 3.14]], r.ranges_);

  r.remove(new goog.math.Range(2.8, 3));
  assertRangeListsEqual([[2.72, 2.8], [3, 3.14]], r.ranges_);
}


function testEquals() {
  var a = new goog.math.RangeSet();
  var b = new goog.math.RangeSet();

  assertTrue(goog.math.RangeSet.equals(a, b));

  a.add(new goog.math.Range(3, 9));
  assertFalse(goog.math.RangeSet.equals(a, b));

  b.add(new goog.math.Range(4, 9));
  assertFalse(goog.math.RangeSet.equals(a, b));

  b.add(new goog.math.Range(3, 4));
  assertTrue(goog.math.RangeSet.equals(a, b));

  a.add(new goog.math.Range(12, 14));
  b.add(new goog.math.Range(11, 14));
  assertFalse(goog.math.RangeSet.equals(a, b));

  a.add(new goog.math.Range(11, 12));
  assertTrue(goog.math.RangeSet.equals(a, b));
}


function testContains() {
  var r = new goog.math.RangeSet();

  assertFalse(r.contains(7, 9));

  r.add(new goog.math.Range(5, 6));
  r.add(new goog.math.Range(10, 20));

  assertFalse(r.contains(new goog.math.Range(7, 9)));
  assertFalse(r.contains(new goog.math.Range(9, 11)));
  assertFalse(r.contains(new goog.math.Range(18, 22)));

  assertTrue(r.contains(new goog.math.Range(17, 19)));
  assertTrue(r.contains(new goog.math.Range(5, 6)));

  assertTrue(r.contains(new goog.math.Range(5.9, 5.999)));

  assertFalse('An empty input range should always return false.',
              r.contains(new goog.math.Range(15, 15)));

  var badRange = new goog.math.Range(15, 15);
  badRange.end = 14;
  assertFalse('An invalid range should always return false.',
              r.contains(badRange));
}


function testContainsValue() {
  var r = new goog.math.RangeSet();

  assertFalse(r.containsValue(5));

  r.add(new goog.math.Range(1, 4));
  r.add(new goog.math.Range(10, 20));

  assertFalse(r.containsValue(0));
  assertFalse(r.containsValue(0.999));
  assertFalse(r.containsValue(5));
  assertFalse(r.containsValue(25));
  assertFalse(r.containsValue(20));

  assertTrue(r.containsValue(3));
  assertTrue(r.containsValue(10));
  assertTrue(r.containsValue(19));
  assertTrue(r.containsValue(19.999));
}


function testUnion() {
  var a = new goog.math.RangeSet();

  a.add(new goog.math.Range(1, 5));
  a.add(new goog.math.Range(10, 11));
  a.add(new goog.math.Range(15, 20));

  var b = new goog.math.RangeSet();

  b.add(new goog.math.Range(0, 5));
  b.add(new goog.math.Range(8, 18));

  var test = a.union(b);
  assertRangeListsEqual([[0, 5], [8, 20]], test.ranges_);

  var test = b.union(a);
  assertRangeListsEqual([[0, 5], [8, 20]], test.ranges_);

  var test = a.union(a);
  assertRangeListsEqual(a.ranges_, test.ranges_);
}


function testIntersection() {
  var a = new goog.math.RangeSet();

  a.add(new goog.math.Range(1, 5));
  a.add(new goog.math.Range(10, 11));
  a.add(new goog.math.Range(15, 20));

  var b = new goog.math.RangeSet();

  b.add(new goog.math.Range(0, 5));
  b.add(new goog.math.Range(8, 18));

  var test = a.intersection(b);
  assertRangeListsEqual([[1, 5], [10, 11], [15, 18]], test.ranges_);

  var test = b.intersection(a);
  assertRangeListsEqual([[1, 5], [10, 11], [15, 18]], test.ranges_);

  var test = a.intersection(a);
  assertRangeListsEqual(a.ranges_, test.ranges_);
}


function testSlice() {
  var r = new goog.math.RangeSet();

  r.add(new goog.math.Range(2, 4));
  r.add(new goog.math.Range(5, 6));
  r.add(new goog.math.Range(9, 15));

  var test = r.slice(new goog.math.Range(0, 2));
  assertRangeListsEqual([], test.ranges_);

  test = r.slice(new goog.math.Range(2, 4));
  assertRangeListsEqual([[2, 4]], test.ranges_);

  test = r.slice(new goog.math.Range(7, 20));
  assertRangeListsEqual([[9, 15]], test.ranges_);

  test = r.slice(new goog.math.Range(4, 30));
  assertRangeListsEqual([[5, 6], [9, 15]], test.ranges_);

  test = r.slice(new goog.math.Range(2, 15));
  assertRangeListsEqual([[2, 4], [5, 6], [9, 15]], test.ranges_);

  test = r.slice(new goog.math.Range(10, 10));
  assertRangeListsEqual('An empty range should produce an empty set.',
                        [], test.ranges_);

  var badRange = new goog.math.Range(10, 10);
  badRange.end = 9;
  test = r.slice(badRange);
  assertRangeListsEqual('An invalid range should produce an empty set.',
                        [], test.ranges_);
}


function testInverse() {
  var r = new goog.math.RangeSet();

  r.add(new goog.math.Range(1, 3));
  r.add(new goog.math.Range(5, 6));
  r.add(new goog.math.Range(8, 10));

  var test = r.inverse(new goog.math.Range(10, 20));
  assertRangeListsEqual([[10, 20]], test.ranges_);

  test = r.inverse(new goog.math.Range(1, 3));
  assertRangeListsEqual([], test.ranges_);

  test = r.inverse(new goog.math.Range(0, 2));
  assertRangeListsEqual([[0, 1]], test.ranges_);

  test = r.inverse(new goog.math.Range(9, 12));
  assertRangeListsEqual([[10, 12]], test.ranges_);

  test = r.inverse(new goog.math.Range(2, 9));
  assertRangeListsEqual([[3, 5], [6, 8]], test.ranges_);

  test = r.inverse(new goog.math.Range(4, 9));
  assertRangeListsEqual([[4, 5], [6, 8]], test.ranges_);

  test = r.inverse(new goog.math.Range(9, 9));
  assertRangeListsEqual('An empty range should produce an empty set.',
                        [], test.ranges_);

  var badRange = new goog.math.Range(9, 9);
  badRange.end = 8;
  test = r.inverse(badRange);
  assertRangeListsEqual('An invalid range should produce an empty set.',
                        [], test.ranges_);
}


function testGetBounds() {
  var r = new goog.math.RangeSet();

  assertNull(r.getBounds());

  r.add(new goog.math.Range(12, 54));
  assertRangesEqual([12, 54], r.getBounds());

  r.add(new goog.math.Range(108, 139));
  assertRangesEqual([12, 139], r.getBounds());
}


function testIsEmpty() {
  var r = new goog.math.RangeSet();
  assertTrue(r.isEmpty());

  r.add(new goog.math.Range(0, 1));
  assertFalse(r.isEmpty());

  r.remove(new goog.math.Range(0, 1));
  assertTrue(r.isEmpty());
}


function testClear() {
  var r = new goog.math.RangeSet();

  r.add(new goog.math.Range(1, 2));
  r.add(new goog.math.Range(3, 5));
  r.add(new goog.math.Range(8, 13));

  assertFalse(r.isEmpty());

  r.clear();
  assertTrue(r.isEmpty());
}


function testIter() {
  var r = new goog.math.RangeSet();

  r.add(new goog.math.Range(1, 3));
  r.add(new goog.math.Range(5, 6));
  r.add(new goog.math.Range(8, 10));

  assertRangeListsEqual([[1, 3], [5, 6], [8, 10]], goog.iter.toArray(r));

  var i = 0;
  goog.iter.forEach(r, function(testRange) {
    assertRangesEqual('Iterated set values should match the originals.',
                      r.ranges_[i], testRange)
    assertNotEquals('Iterated range should not be a reference to the original.',
                    r.ranges_[i], testRange);
    i++;
  });
}

">n/a</td></tr>
<tr><td>size_test.html</td><td>Success</td><td> 17 passed, 0 failed.</td><td title="

goog.require('goog.math.Size');
goog.require('goog.testing.jsunit');



function testSize1() {
  var s = new goog.math.Size(undefined, undefined);
  assertUndefined(s.width);
  assertUndefined(s.height);
  assertEquals('(undefined x undefined)', s.toString());
}

function testSize3() {
  var s = new goog.math.Size(10, 20);
  assertEquals(10, s.width);
  assertEquals(20, s.height);
  assertEquals('(10 x 20)', s.toString());
}

function testSize4() {
  var s = new goog.math.Size(10.5, 20.897);
  assertEquals(10.5, s.width);
  assertEquals(20.897, s.height);
  assertEquals('(10.5 x 20.897)', s.toString());
}

function testSizeClone() {
  var s = new goog.math.Size(undefined, undefined);
  assertEquals(s.toString(), s.clone().toString());
  s.width = 4;
  s.height = 5;
  assertEquals(s.toString(), s.clone().toString());
}

function testSizeEquals() {
  var a = new goog.math.Size(4, 5);

  assertTrue(goog.math.Size.equals(a, a));
  assertFalse(goog.math.Size.equals(a, null));
  assertFalse(goog.math.Size.equals(null, a));

  var b = new goog.math.Size(4, 5);
  var c = new goog.math.Size(4, 6);
  assertTrue(goog.math.Size.equals(a, b));
  assertFalse(goog.math.Size.equals(a, c));
}

function testSizeArea() {
  var s = new goog.math.Size(4, 5);
  assertEquals(20, s.area());
}

function testSizePerimeter() {
  var s = new goog.math.Size(4, 5);
  assertEquals(18, s.perimeter());
}

function testSizeAspectRatio() {
  var s = new goog.math.Size(undefined, undefined);
  assertNaN(s.aspectRatio());

  s.width = 4;
  s.height = 0;
  assertEquals(Infinity, s.aspectRatio());

  s.height = 5;
  assertEquals(0.8, s.aspectRatio());
}

function testSizeFitsInside() {
  var target = new goog.math.Size(10, 10);

  var a = new goog.math.Size(5, 8);
  var b = new goog.math.Size(5, 12);
  var c = new goog.math.Size(19, 7);


  assertTrue(a.fitsInside(target));
  assertFalse(b.fitsInside(target));
  assertFalse(c.fitsInside(target));
}

function testSizeScaleToFit() {
  var target = new goog.math.Size(512, 640);

  var a = new goog.math.Size(1600, 1200);
  var b = new goog.math.Size(1200, 1600);
  var c = new goog.math.Size(400, 300);
  var d = new goog.math.Size(undefined, undefined);

  assertEquals('(512 x 384)', a.scaleToFit(target).toString());
  assertEquals('(480 x 640)', b.scaleToFit(target).toString());
  assertEquals('(512 x 384)', c.scaleToFit(target).toString());
  assertEquals('(512 x 640)', target.scaleToFit(target).toString());

  assertEquals('(NaN x NaN)', d.scaleToFit(target).toString());
  assertEquals('(NaN x NaN)', a.scaleToFit(d).toString());
}

function testSizeIsEmpty() {
  var s = new goog.math.Size(undefined, undefined);
  assertTrue(s.isEmpty());
  s.width = 0;
  s.height = 5;
  assertTrue(s.isEmpty());
  s.width = 4;
  assertFalse(s.isEmpty());
}

function testSizeScale() {
  var s = new goog.math.Size(4, 5);
  assertEquals('(8 x 10)', s.scale(2).toString());
  assertEquals('(0.8 x 1)', s.scale(0.1).toString());
}

function testSizeCeil() {
  var s = new goog.math.Size(2.3, 4.7);
  assertEquals('(3 x 5)', s.ceil().toString());
}

function testSizeFloor() {
  var s = new goog.math.Size(2.3, 4.7);
  assertEquals('(2 x 4)', s.floor().toString());
}

function testSizeRound() {
  var s = new goog.math.Size(2.3, 4.7);
  assertEquals('(2 x 5)', s.round().toString());
}

function testSizeGetLongest() {
  var s = new goog.math.Size(3, 4);
  assertEquals(4, s.getLongest());

  s.height = 3;
  assertEquals(3, s.getLongest());

  s.height = 2;
  assertEquals(3, s.getLongest());

  assertNaN(new goog.math.Size(undefined, undefined).getLongest());
}

function testSizeGetShortest() {
  var s = new goog.math.Size(3, 4);
  assertEquals(3, s.getShortest());

  s.height = 3;
  assertEquals(3, s.getShortest());

  s.height = 2;
  assertEquals(2, s.getShortest());

  assertNaN(new goog.math.Size(undefined, undefined).getShortest());
}

">n/a</td></tr>
<tr><td>math_test.html</td><td>Success</td><td> 22 passed, 0 failed.</td><td title="

    goog.require('goog.math');
    goog.require('goog.testing.jsunit');
  

    function testRandomInt() {
      assertEquals(0, goog.math.randomInt(0));
      assertEquals(0, goog.math.randomInt(1));

      var r = goog.math.randomInt(3);
      assertTrue(0 <= r && r < 3);
    }

    function testUniformRandom() {
      assertEquals(5.2, goog.math.uniformRandom(5.2, 5.2));
      assertEquals(-6, goog.math.uniformRandom(-6, -6));

      var r = goog.math.uniformRandom(-0.5, 0.5);
      assertTrue(-0.5 <= r && r < 0.5);
    }

    function testClamp() {
      assertEquals(3, goog.math.clamp(3, -5, 5));
      assertEquals(5, goog.math.clamp(5, -5, 5));
      assertEquals(-5, goog.math.clamp(-5, -5, 5));

      assertEquals(-5, goog.math.clamp(-22, -5, 5));
      assertEquals(5, goog.math.clamp(6, -5, 5));
    }

    function testModulo() {
      assertEquals(0, goog.math.modulo(256, 8));

      assertEquals(7, goog.math.modulo(7, 8));
      assertEquals(7, goog.math.modulo(23, 8));
      assertEquals(7, goog.math.modulo(-1, 8));

      assertEquals(-4, goog.math.modulo(1, -5));
      assertEquals(-4, goog.math.modulo(6, -5));
      assertEquals(-4, goog.math.modulo(-4, -5));
    }

    function testLerp() {
      assertEquals(0, goog.math.lerp(0, 0, 0));
      assertEquals(3, goog.math.lerp(0, 6, 0.5));
      assertEquals(3, goog.math.lerp(-1, 1, 2));
    }

    function testNearlyEquals() {
      assertTrue('Numbers inside default tolerance should be equal',
                 goog.math.nearlyEquals(0.000001, 0.000001001));
      assertFalse('Numbers outside default tolerance should be unequal',
                  goog.math.nearlyEquals(0.000001, 0.000003));
      assertTrue('Numbers inside custom tolerance should be equal',
                 goog.math.nearlyEquals(0.001, 0.002, 0.1));
      assertFalse('Numbers outside custom tolerance should be unequal',
                  goog.math.nearlyEquals(0.001, -0.1, 0.1));
      assertTrue('Integer tolerance greater than one should succeed',
                 goog.math.nearlyEquals(87, 85, 3));
    }

    function testStandardAngle() {
      assertEquals(359.5, goog.math.standardAngle(-360.5));
      assertEquals(0, goog.math.standardAngle(-360));
      assertEquals(359.5, goog.math.standardAngle(-0.5));
      assertEquals(0, goog.math.standardAngle(0));
      assertEquals(0.5, goog.math.standardAngle(0.5));
      assertEquals(0, goog.math.standardAngle(360));
      assertEquals(1, goog.math.standardAngle(721));
    }

    function testToRadians() {
      assertEquals(-Math.PI, goog.math.toRadians(-180));
      assertEquals(0, goog.math.toRadians(0));
      assertEquals(Math.PI, goog.math.toRadians(180));
    }

    function testToDegrees() {
      assertEquals(-180, goog.math.toDegrees(-Math.PI));
      assertEquals(0, goog.math.toDegrees(0));
      assertEquals(180, goog.math.toDegrees(Math.PI));
    }

    function testAngleDx() {
      assertRoughlyEquals(0, goog.math.angleDx(0, 0), 1e-10);
      assertRoughlyEquals(0, goog.math.angleDx(90, 0), 1e-10);
      assertRoughlyEquals(100, goog.math.angleDx(0, 100), 1e-10);
      assertRoughlyEquals(0, goog.math.angleDx(90, 100), 1e-10);
      assertRoughlyEquals(-100, goog.math.angleDx(180, 100), 1e-10);
      assertRoughlyEquals(0, goog.math.angleDx(270, 100), 1e-10);
    }

    function testAngleDy() {
      assertRoughlyEquals(0, goog.math.angleDy(0, 0), 1e-10);
      assertRoughlyEquals(0, goog.math.angleDy(90, 0), 1e-10);
      assertRoughlyEquals(0, goog.math.angleDy(0, 100), 1e-10);
      assertRoughlyEquals(100, goog.math.angleDy(90, 100), 1e-10);
      assertRoughlyEquals(0, goog.math.angleDy(180, 100), 1e-10);
      assertRoughlyEquals(-100, goog.math.angleDy(270, 100), 1e-10);
    }

    function testAngle() {
      assertRoughlyEquals(0, goog.math.angle(10, 10, 20, 10), 1e-10);
      assertRoughlyEquals(90, goog.math.angle(10, 10, 10, 20), 1e-10);
      assertRoughlyEquals(225, goog.math.angle(10, 10, 0, 0), 1e-10);
      assertRoughlyEquals(270, goog.math.angle(10, 10, 10, 0), 1e-10);

      // 0 is the conventional result, but mathematically this is undefined.
      assertEquals(0, goog.math.angle(10, 10, 10, 10));
    }

    function testAngleDifference() {
      assertEquals(10, goog.math.angleDifference(30, 40));
      assertEquals(-10, goog.math.angleDifference(40, 30));
      assertEquals(180, goog.math.angleDifference(10, 190));
      assertEquals(180, goog.math.angleDifference(190, 10));
      assertEquals(20, goog.math.angleDifference(350, 10));
      assertEquals(-20, goog.math.angleDifference(10, 350));
      assertEquals(100, goog.math.angleDifference(350, 90));
      assertEquals(-80, goog.math.angleDifference(350, 270));
      assertEquals(0, goog.math.angleDifference(15, 15));
    }

    function testSign() {
      assertEquals(-1, goog.math.sign(-1));
      assertEquals(1, goog.math.sign(1));
      assertEquals(0, goog.math.sign(0));
      assertEquals(0, goog.math.sign(-0));
      assertEquals(1, goog.math.sign(0.0001));
      assertEquals(-1, goog.math.sign(-0.0001));
      assertEquals(-1, goog.math.sign(-Infinity));
      assertEquals(1, goog.math.sign(Infinity));
      assertEquals(1, goog.math.sign(3141592653589793));
    }

    function testLongestCommonSubsequence() {
      var func = goog.math.longestCommonSubsequence;

      assertArrayEquals([2], func([1,2], [2,1]));
      assertArrayEquals([1,2], func([1,2,5], [2,1,2]));
      assertArrayEquals([1,2,3,4,5], func([1,0,2,3,8,4,9,5], [8,1,2,4,3,6,4,5]));
      assertArrayEquals([1,1,1,1,1], func([1,1,1,1,1], [1,1,1,1,1]));
      assertArrayEquals([5], func([1,2,3,4,5], [5,4,3,2,1]));
    }

    function testLongestCommonSubsequenceWithCustomComparator() {
      var func = goog.math.longestCommonSubsequence;

      var compareFn = function(a, b) {
        return a.field == b.field;
      };

      var a1 = {field: 'a1', field2: 'hello'};
      var a2 = {field: 'a2', field2: 33};
      var a3 = {field: 'a3'};
      var a4 = {field: 'a3'};

      assertArrayEquals([a1,a2], func([a1,a2,a3], [a3,a1,a2], compareFn));
      assertArrayEquals([a1,a3], func([a1,a3], [a1,a4], compareFn));
      // testing the same arrays without compare function
      assertArrayEquals([a1], func([a1,a3], [a1,a4]));
    }

    function testLongestCommonSubsequenceWithCustomCollector() {
      var func = goog.math.longestCommonSubsequence;

      var collectorFn = function(a, b) {
        return b;
      };

      assertArrayEquals([1,2,4,6,7], func([1,0,2,3,8,4,9,5], [8,1,2,4,3,6,4,5],
          null, collectorFn));
    }

    function testSum() {
      assertEquals('sum() must return 0 if there are no arguments',
          0, goog.math.sum());
      assertEquals('sum() must return its argument if there is only one',
          17, goog.math.sum(17));
      assertEquals('sum() must handle positive integers',
          10, goog.math.sum(1, 2, 3, 4));
      assertEquals('sum() must handle real numbers',
          -2.5, goog.math.sum(1, -2, 3, -4.5));
      assertTrue('sum() must return NaN if one of the arguments isn\'t numeric',
          isNaN(goog.math.sum(1, 2, 'foo', 3)));
    }

    function testAverage() {
      assertTrue('average() must return NaN if there are no arguments',
          isNaN(goog.math.average()));
      assertEquals('average() must return its argument if there is only one',
          17, goog.math.average(17));
      assertEquals('average() must handle positive integers',
          3, goog.math.average(1, 2, 3, 4, 5));
      assertEquals('average() must handle real numbers',
          -0.625, goog.math.average(1, -2, 3, -4.5));
      assertTrue('average() must return NaN if one of the arguments isn\'t ' +
          'numeric', isNaN(goog.math.average(1, 2, 'foo', 3)));
    }

    function testStandardDeviation() {
      assertEquals('standardDeviation() must return 0 if there are no samples',
          0, goog.math.standardDeviation());
      assertEquals('standardDeviation() must return 0 if there is only one ' +
          'sample', 0, goog.math.standardDeviation(17));
      assertRoughlyEquals('standardDeviation() must handle positive integers',
          6.9282, goog.math.standardDeviation(3, 7, 7, 19),
          0.0001);
      assertRoughlyEquals('standardDeviation() must handle real numbers',
          3.4660, goog.math.standardDeviation(1.23, -2.34, 3.14, -4.56),
          0.0001);
    }

    function testIsInt() {
      assertFalse(goog.math.isInt(12345.67));
      assertFalse(goog.math.isInt(0.123));
      assertFalse(goog.math.isInt(.1));
      assertFalse(goog.math.isInt(-23.43));
      assertFalse(goog.math.isInt(-.1));
      assertFalse(goog.math.isInt(1e-1));
      assertTrue(goog.math.isInt(1));
      assertTrue(goog.math.isInt(0));
      assertTrue(goog.math.isInt(-2));
      assertTrue(goog.math.isInt(-2.0));
      assertTrue(goog.math.isInt(10324231));
      assertTrue(goog.math.isInt(1.));
      assertTrue(goog.math.isInt(1e3));
    }

    function testIsFiniteNumber() {
      assertFalse(goog.math.isFiniteNumber(NaN));
      assertFalse(goog.math.isFiniteNumber(-Infinity));
      assertFalse(goog.math.isFiniteNumber(+Infinity));
      assertTrue(goog.math.isFiniteNumber(0));
      assertTrue(goog.math.isFiniteNumber(1));
      assertTrue(goog.math.isFiniteNumber(Math.PI));
    }
  ">n/a</td></tr>
<tr><td>coordinate_test.html</td><td>Success</td><td> 10 passed, 0 failed.</td><td title="

goog.require('goog.math.Coordinate');
goog.require('goog.testing.jsunit');



function testCoordinate1() {
  var dim1 = new goog.math.Coordinate();
  assertEquals(0, dim1.x);
  assertEquals(0, dim1.y);
  assertEquals('(0, 0)', dim1.toString());
}

function testCoordinate2() {
  var dim2 = new goog.math.Coordinate(10);
  assertEquals(10, dim2.x);
  assertEquals(0, dim2.y);
  assertEquals('(10, 0)', dim2.toString());
}

function testCoordinate3() {
  var dim3 = new goog.math.Coordinate(10, 20);
  assertEquals(10, dim3.x);
  assertEquals(20, dim3.y);
  assertEquals('(10, 20)', dim3.toString());
}

function testCoordinate4() {
  var dim4 = new goog.math.Coordinate(10.5, 20.897);
  assertEquals(10.5, dim4.x);
  assertEquals(20.897, dim4.y);
  assertEquals('(10.5, 20.897)', dim4.toString());
}

function testCoordinate5() {
  var dim5 = new goog.math.Coordinate(NaN, 1000);
  assertTrue(isNaN(dim5.x));
  assertEquals(1000, dim5.y);
  assertEquals('(NaN, 1000)', dim5.toString());
}

function testCoordinateSquaredDistance() {
  var a = new goog.math.Coordinate(7, 11);
  var b = new goog.math.Coordinate(3, -1);
  assertEquals(160, goog.math.Coordinate.squaredDistance(a, b));
}

function testCoordinateDistance() {
  var a = new goog.math.Coordinate(-2, -3);
  var b = new goog.math.Coordinate(2, 0);
  assertEquals(5, goog.math.Coordinate.distance(a, b));
}

function testCoordinateClone() {
  var c = new goog.math.Coordinate();
  assertEquals(c.toString(), c.clone().toString());
  c.x = -12;
  c.y = 13;
  assertEquals(c.toString(), c.clone().toString());
}

function testCoordinateDifference() {
  assertObjectEquals(new goog.math.Coordinate(3, -40),
      goog.math.Coordinate.difference(
          new goog.math.Coordinate(5, 10),
          new goog.math.Coordinate(2, 50)));
}

function testCoordinateSum() {
  assertObjectEquals(new goog.math.Coordinate(7, 60),
      goog.math.Coordinate.sum(
          new goog.math.Coordinate(5, 10),
          new goog.math.Coordinate(2, 50)));
}

">n/a</td></tr>
<tr><td>coordinate3_test.html</td><td>Success</td><td> 16 passed, 0 failed.</td><td title="

goog.require('goog.testing.jsunit');
goog.require('goog.math.Coordinate3');



function assertCoordinate3Equals(a, b) {
  assertTrue(b + ' should be equal to ' + a,
             goog.math.Coordinate3.equals(a, b));
}


function testCoordinate3MissingXYZ() {
  var noXYZ = new goog.math.Coordinate3();
  assertUndefined(noXYZ.x);
  assertUndefined(noXYZ.y);
  assertUndefined(noXYZ.z);
  assertCoordinate3Equals(noXYZ, new goog.math.Coordinate3());
}


function testCoordinate3MissingYZ() {
  var noYZ = new goog.math.Coordinate3(10);
  assertEquals(10, noYZ.x);
  assertUndefined(noYZ.y);
  assertUndefined(noYZ.z);
  assertCoordinate3Equals(noYZ, new goog.math.Coordinate3(10));
}


function testCoordinate3MissingZ() {
  var noZ = new goog.math.Coordinate3(10, 20);
  assertEquals(10, noZ.x);
  assertEquals(20, noZ.y);
  assertUndefined(noZ.z);
  assertCoordinate3Equals(noZ, new goog.math.Coordinate3(10, 20));
}


function testCoordinate3IntegerValues() {
  var intCoord = new goog.math.Coordinate3(10, 20, -19);
  assertEquals(10, intCoord.x);
  assertEquals(20, intCoord.y);
  assertEquals(-19, intCoord.z);
  assertCoordinate3Equals(intCoord, new goog.math.Coordinate3(10, 20, -19));
}


function testCoordinate3FloatValues() {
  var floatCoord = new goog.math.Coordinate3(10.5, 20.897, -71.385);
  assertEquals(10.5, floatCoord.x);
  assertEquals(20.897, floatCoord.y);
  assertEquals(-71.385, floatCoord.z);
  assertCoordinate3Equals(floatCoord,
      new goog.math.Coordinate3(10.5, 20.897, -71.385));
}


function testCoordinate3OneNonNumericValue() {
  var dim5 = new goog.math.Coordinate3('ten', 1000, 85);
  assertTrue(isNaN(dim5.x));
  assertEquals(1000, dim5.y);
  assertEquals(85, dim5.z);
}


function testCoordinate3AllNonNumericValues() {
  var nonNumeric = new goog.math.Coordinate3('ten',
                                             {woop: 'test'},
                                             Math.sqrt(-1));
  assertTrue(isNaN(nonNumeric.x));
  assertTrue(isNaN(nonNumeric.y));
  assertTrue(isNaN(nonNumeric.z));
}


function testCoordinate3Origin() {
  var origin = new goog.math.Coordinate3(0, 0, 0);
  assertEquals(0, origin.x);
  assertEquals(0, origin.y);
  assertEquals(0, origin.z);
  assertCoordinate3Equals(origin, new goog.math.Coordinate3(0, 0, 0));
}


function testCoordinate3Clone() {
  var c = new goog.math.Coordinate3();
  assertCoordinate3Equals(c, c.clone());
  c.x = -12;
  c.y = 13;
  c.z = 5;
  assertCoordinate3Equals(c, c.clone());
}


function testToString() {
  assertEquals('(undefined, undefined, undefined)', new
               goog.math.Coordinate3().toString());
  assertEquals('(1, undefined, undefined)', new
               goog.math.Coordinate3(1).toString());
  assertEquals('(1, 2, undefined)', new
               goog.math.Coordinate3(1, 2).toString());
  assertEquals('(0, 0, 0)', new goog.math.Coordinate3(0, 0, 0).toString());
  assertEquals('(1, 2, 3)', new goog.math.Coordinate3(1, 2, 3).toString());
  assertEquals('(-4, 5, -3)', new goog.math.Coordinate3(-4, 5, -3).toString());
  assertEquals('(11.25, -71.935, 2.8)',
               new goog.math.Coordinate3(11.25, -71.935, 2.8).toString());
  assertEquals('(1, 2, NaN)', new goog.math.Coordinate3(1, 2, 'a').toString());
  assertEquals('(NaN, NaN, NaN)',
               new goog.math.Coordinate3('ten', {woop: 'test'},
                                         Math.sqrt(-1)).toString());
}


function testEquals() {
  var a = new goog.math.Coordinate3(3, 4, 5);
  var b = new goog.math.Coordinate3(3, 4, 5);
  var c = new goog.math.Coordinate3(-3, 4, -5);

  assertTrue(goog.math.Coordinate3.equals(null, null));
  assertFalse(goog.math.Coordinate3.equals(a, null));
  assertTrue(goog.math.Coordinate3.equals(a, a));
  assertTrue(goog.math.Coordinate3.equals(a, b));
  assertFalse(goog.math.Coordinate3.equals(a, c));
}


function testCoordinate3Distance() {
  var a = new goog.math.Coordinate3(-2, -3, 1);
  var b = new goog.math.Coordinate3(2, 0, 1);
  assertEquals(5, goog.math.Coordinate3.distance(a, b));
}


function testCoordinate3SquaredDistance() {
  var a = new goog.math.Coordinate3(7, 11, 1);
  var b = new goog.math.Coordinate3(3, -1, 1);
  assertEquals(160, goog.math.Coordinate3.squaredDistance(a, b));
}


function testCoordinate3Difference() {
  var a = new goog.math.Coordinate3(7, 11, 1);
  var b = new goog.math.Coordinate3(3, -1, 1);
  assertCoordinate3Equals(goog.math.Coordinate3.difference(a, b),
                          new goog.math.Coordinate3(4, 12, 0));
}


function testToArray() {
  var a = new goog.math.Coordinate3(7, 11, 1);
  var b = a.toArray();
  assertEquals(b.length, 3);
  assertEquals(b[0], 7);
  assertEquals(b[1], 11);
  assertEquals(b[2], 1);

  var c = new goog.math.Coordinate3('abc', 'def', 'xyz');
  var result = c.toArray();
  assertTrue(isNaN(result[0]));
  assertTrue(isNaN(result[1]));
  assertTrue(isNaN(result[2]));
}


function testFromArray() {
  var a = [1, 2, 3];
  var b = goog.math.Coordinate3.fromArray(a);
  assertEquals('(1, 2, 3)', b.toString());

  var c = [1, 2];
  var d = goog.math.Coordinate3.fromArray(c);
  assertEquals('(1, 2, undefined)', d.toString());

  var e = [1];
  var f = goog.math.Coordinate3.fromArray(e);
  assertEquals('(1, undefined, undefined)', f.toString());

  var g = [];
  var h = goog.math.Coordinate3.fromArray(g);
  assertEquals('(undefined, undefined, undefined)', h.toString());

  var tooLong = [1, 2, 3, 4, 5, 6];
  assertThrows('Error should be thrown attempting to convert an invalid type.',
      goog.partial(goog.math.Coordinate3.fromArray, tooLong));
}

">n/a</td></tr>
<tr><td>matrix_test.html</td><td>Success</td><td> 32 passed, 0 failed.</td><td title="

  goog.require('goog.math.Matrix');
  goog.require('goog.testing.jsunit');



  function testConstuctorWithGoodArray() {
    var a1 = [ [1, 2], [2, 3], [4, 5] ];
    var m1 = new goog.math.Matrix(a1);
    assertArrayEquals('1. Internal array should be the same', m1.toArray(), a1);
    assertEquals(3, m1.getSize().height);
    assertEquals(2, m1.getSize().width);

    var a2 = [ [-61, 45, 123], [11112, 343, 1235] ];
    var m2 = new goog.math.Matrix(a2);
    assertArrayEquals('2. Internal array should be the same', m2.toArray(), a2);
    assertEquals(2, m2.getSize().height);
    assertEquals(3, m2.getSize().width);

    var a3 = [ [1, 1, 1, 1], [2, 2, 2, 2], [3, 3, 3, 3], [4, 4, 4, 4] ];
    var m3 = new goog.math.Matrix(a3);
    assertArrayEquals('3. Internal array should be the same', m3.toArray(), a3);
    assertEquals(4, m3.getSize().height);
    assertEquals(4, m3.getSize().width);
  }


  function testConstructorWithBadArray() {
    assertThrows('1. All arrays should be of equal length', function() {
      new goog.math.Matrix([[1, 2, 3], [1, 2], [1]]);
    });

    assertThrows('2. All arrays should be of equal length', function() {
      new goog.math.Matrix([[1, 2], [1, 2], [1, 2, 3, 4]]);
    });

    assertThrows('3. Arrays should contain only numeric values', function() {
      new goog.math.Matrix([[1, 2], [1, 2], [1, 'a']]);
    });

    assertThrows('4. Arrays should contain only numeric values', function() {
      new goog.math.Matrix([[1, 2], [1, 2], [1, {a: 3}]]);
    });

    assertThrows('5. Arrays should contain only numeric values', function() {
      new goog.math.Matrix([[1, 2], [1, 2], [1, [1, 2, 3]]]);
    });
  }


  function testConstructorWithGoodNumbers() {
    var m1 = new goog.math.Matrix(2, 2);
    assertEquals('Height should be 2', 2, m1.getSize().height);
    assertEquals('Width should be 2', 2, m1.getSize().width);

    var m2 = new goog.math.Matrix(4, 2);
    assertEquals('Height should be 4', 4, m2.getSize().height);
    assertEquals('Width should be 2', 2, m2.getSize().width);

    var m3 = new goog.math.Matrix(4, 6);
    assertEquals('Height should be 4', 4, m3.getSize().height);
    assertEquals('Width should be 6', 6, m3.getSize().width);
  }


  function testConstructorWithBadNumbers() {
    assertThrows('1. Negative argument should have errored', function() {
      new goog.math.Matrix(-4, 6);
    });

    assertThrows('2. Negative argument should have errored', function() {
      new goog.math.Matrix(4, -6);
    });

    assertThrows('3. Zero argument should have errored', function() {
      new goog.math.Matrix(4, 0);
    });

    assertThrows('4. Zero argument should have errored', function() {
      new goog.math.Matrix(0, 1);
    });
  }


  function testConstructorWithMatrix() {
    var a1 = [ [1, 2], [2, 3], [4, 5] ];
    var m1 = new goog.math.Matrix(a1);
    var m2 = new goog.math.Matrix(m1);
    assertArrayEquals(
        'Internal arrays should be the same', m1.toArray(), m2.toArray());
    assertNotEquals(
        'Should be different objects', goog.getUid(m1), goog.getUid(m2));
  }


  function testCreateIdentityMatrix() {
    var m1 = goog.math.Matrix.createIdentityMatrix(3);
    assertArrayEquals([[1, 0, 0], [0, 1, 0], [0, 0, 1]], m1.toArray());

    var m2 = goog.math.Matrix.createIdentityMatrix(4);
    assertArrayEquals(
        [[1, 0, 0, 0], [0, 1, 0, 0], [0, 0, 1, 0], [0, 0, 0, 1]], m2.toArray());
  }


  function testIsValidArrayWithGoodArrays() {
    var fn = goog.math.Matrix.isValidArray;
    assertTrue('2x2 array should be fine', fn([[1, 2], [3, 5]]));
    assertTrue('3x2 array should be fine', fn([[1, 2, 3], [3, 5, 6]]));
    assertTrue(
        '3x3 array should be fine', fn([[1, 2, 3], [3, 5, 6], [10, 10, 10]]));
    assertTrue('[[1]] should be fine', fn([[1]]));
    assertTrue('1D array should work', fn([[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]]));
    assertTrue('Negs and decimals should be ok',
        fn([[0], [-4], [-10], [1.2345], [123.53]]));
    assertTrue('Hex, Es and decimals are ok', fn([[0x100, 10E-2], [1.213, 213]]));
  }


  function testIsValidArrayWithBadArrays() {
    var fn = goog.math.Matrix.isValidArray;
    assertFalse('Arrays should have same size', fn([[1, 2], [3]]));
    assertFalse('Arrays should have same size 2', fn([[1, 2], [3, 4, 5]]));
    assertFalse('2D arrays are ok', fn([[1, 2], [3, 4], []]));
    assertFalse('Values should be numeric', fn([[1, 2], [3, 'a']]));
    assertFalse('Values can not be strings', fn([['bah'], ['foo']]));
    assertFalse('Flat array not supported', fn([1, 2, 3, 4, 5]));
  }


  function testForEach() {
    var m = new goog.math.Matrix([[1, 2, 3], [4, 5, 6], [7, 8, 9]]);
    var count = 0, sum = 0, xs = '', ys = '';
    goog.math.Matrix.forEach(m, function(val, x, y) {
      count++;
      sum += val;
      xs += x;
      ys += y;
    });
    assertEquals('forEach should have visited every item', 9, count);
    assertEquals('forEach should have summed all values', 45, sum);
    assertEquals('Xs should have been visited in order', '000111222', xs);
    assertEquals('Ys should have been visited sequentially', '012012012', ys);
  }


  function testMap() {
    var m1 = new goog.math.Matrix([[1, 2, 3], [4, 5, 6], [7, 8, 9]]);
    var m2 = goog.math.Matrix.map(m1, function(val, x, y) {
      return val + 1;
    });
    assertArrayEquals([[2, 3, 4], [5, 6, 7], [8, 9, 10]], m2.toArray());
  }


  function testSetValueAt() {
    var m = new goog.math.Matrix(3, 3);
    for (var x = 0; x < 3; x++) {
      for (var y = 0; y < 3; y++) {
        m.setValueAt(x, y, 3 * x - y);
      }
    }
    assertArrayEquals([[0, -1, -2], [3, 2, 1], [6, 5, 4]], m.toArray());
  }


  function testGetValueAt() {
    var m = new goog.math.Matrix([[0, -1, -2], [3, 2, 1], [6, 5, 4]]);
    for (var x = 0; x < 3; x++) {
      for (var y = 0; y < 3; y++) {
        assertEquals(
            'Value at (x, y) should equal 3x - y',
            3 * x - y, m.getValueAt(x, y));
      }
    }
    assertNull('Out of bounds value should be null', m.getValueAt(-1, 2));
    assertNull('Out of bounds value should be null', m.getValueAt(-1, 0));
    assertNull('Out of bounds value should be null', m.getValueAt(0, 4));
  }


  function testSum1() {
    var m1 = new goog.math.Matrix([[1, 1, 1], [2, 2, 2], [3, 3, 3]]);
    var m2 = new goog.math.Matrix([[3, 3, 3], [2, 2, 2], [1, 1, 1]]);
    assertArrayEquals('Sum should be all the 4s',
        [[4, 4, 4], [4, 4, 4], [4, 4, 4]], m1.add(m2).toArray());
    assertArrayEquals('Addition should be commutative',
        m1.add(m2).toArray(), m2.add(m1).toArray());
  }


  function testSum2() {
    var m1 = new goog.math.Matrix([[1, 2, 3], [4, 5, 6], [7, 8, 9]]);
    var m2 = new goog.math.Matrix([[-1, -2, -3], [-4, -5, -6], [-7, -8, -9]]);
    assertArrayEquals('Sum should be all 0s',
        [[0, 0, 0], [0, 0, 0], [0, 0, 0]], m1.add(m2).toArray());
    assertArrayEquals('Addition should be commutative',
        m1.add(m2).toArray(), m2.add(m1).toArray());
  }


  function testSubtract1() {
    var m1 = new goog.math.Matrix([[1, 2, 3], [4, 5, 6], [7, 8, 9]]);
    var m2 = new goog.math.Matrix([[5, 5, 5], [5, 5, 5], [5, 5, 5]]);

    assertArrayEquals([[-4, -3, -2], [-1, 0, 1], [2, 3, 4]],
                      m1.subtract(m2).toArray());
    assertArrayEquals([[4, 3, 2], [1, 0, -1], [-2, -3, -4]],
                      m2.subtract(m1).toArray());
  }


  function testSubtract2() {
    var m1 = new goog.math.Matrix([[1, 2, 3], [4, 5, 6], [7, 8, 9]]);
    var m2 = new goog.math.Matrix([[-1, -2, -3], [-4, -5, -6], [-7, -8, -9]]);
    assertArrayEquals([[2, 4, 6], [8, 10, 12], [14, 16, 18]],
                      m1.subtract(m2).toArray());
    assertArrayEquals([[-2, -4, -6], [-8, -10, -12], [-14, -16, -18]],
                      m2.subtract(m1).toArray());
  }


  function testScalarMultiplication() {
    var m1 = new goog.math.Matrix([[1, 1, 1], [2, 2, 2], [3, 3, 3]]);
    assertArrayEquals(
        [[2, 2, 2], [4, 4, 4], [6, 6, 6]], m1.multiply(2).toArray());
    assertArrayEquals(
        [[3, 3, 3], [6, 6, 6], [9, 9, 9]], m1.multiply(3).toArray());
    assertArrayEquals(
        [[4, 4, 4], [8, 8, 8], [12, 12, 12]], m1.multiply(4).toArray());

    var m2 = new goog.math.Matrix([[1, 2, 3], [4, 5, 6], [7, 8, 9]]);
    assertArrayEquals(
        [[2, 4, 6], [8, 10, 12], [14, 16, 18]], m2.multiply(2).toArray());
  }


  function testMatrixMultiplication() {
    var m1 = new goog.math.Matrix([[1, 2], [3, 4]]);
    var m2 = new goog.math.Matrix([[3, 4], [5, 6]]);
    // m1 * m2
    assertArrayEquals([[1 * 3 + 2 * 5, 1 * 4 + 2 * 6],
                       [3 * 3 + 4 * 5, 3 * 4 + 4 * 6]],
                      m1.multiply(m2).toArray());
    // m2 * m1 != m1 * m2
    assertArrayEquals([[3 * 1 + 4 * 3, 3 * 2 + 4 * 4],
                       [5 * 1 + 6 * 3, 5 * 2 + 6 * 4]],
                      m2.multiply(m1).toArray());
    var m3 = new goog.math.Matrix([[1, 2, 3, 4],
                                   [5, 6, 7, 8]]);
    var m4 = new goog.math.Matrix([[1, 2, 3],
                                   [4, 5, 6],
                                   [7, 8, 9],
                                   [10, 11, 12]]);
    // m3 * m4
    assertArrayEquals([[1 * 1 + 2 * 4 + 3 * 7 + 4 * 10,
                        1 * 2 + 2 * 5 + 3 * 8 + 4 * 11,
                        1 * 3 + 2 * 6 + 3 * 9 + 4 * 12],
                       [5 * 1 + 6 * 4 + 7 * 7 + 8 * 10,
                        5 * 2 + 6 * 5 + 7 * 8 + 8 * 11,
                        5 * 3 + 6 * 6 + 7 * 9 + 8 * 12]],
                      m3.multiply(m4).toArray());
    assertThrows("Matrix dimensions should not line up.",
                 function () { m4.multiply(m3); });
  }

  function testMatrixMultiplicationIsAssociative() {
    var A = new goog.math.Matrix([[1, 2], [3, 4]]);
    var B = new goog.math.Matrix([[3, 4], [5, 6]]);
    var C = new goog.math.Matrix([[2, 7], [9, 1]]);

    assertArrayEquals('A(BC) == (AB)C',
                      A.multiply(B.multiply(C)).toArray(),
                      A.multiply(B).multiply(C).toArray());
  }


  function testMatrixMultiplicationIsDistributive() {
    var A = new goog.math.Matrix([[1, 2], [3, 4]]);
    var B = new goog.math.Matrix([[3, 4], [5, 6]]);
    var C = new goog.math.Matrix([[2, 7], [9, 1]]);

    assertArrayEquals('A(B + C) = AB + AC',
                      A.multiply(B.add(C)).toArray(),
                      A.multiply(B).add(A.multiply(C)).toArray());

    assertArrayEquals('(A + B)C = AC + BC',
                      A.add(B).multiply(C).toArray(),
                      A.multiply(C).add(B.multiply(C)).toArray());
  }


  function testTranspose() {
    var m = new goog.math.Matrix([[1, 3, 1], [0, -6, 0]]);
    var t = [[1, 0], [3, -6], [1, 0]];
    assertArrayEquals(t, m.getTranspose().toArray());
  }


  function testAppendColumns() {
    var m = new goog.math.Matrix([[1, 3, 2], [2, 0, 1], [5, 2, 2]]);
    var b = new goog.math.Matrix([[4], [3], [1]]);
    var result = [[1, 3, 2, 4], [2, 0, 1, 3], [5, 2, 2, 1]];
    assertArrayEquals(result, m.appendColumns(b).toArray());
  }


  function testAppendRows() {
    var m = new goog.math.Matrix([[1, 3, 2], [2, 0, 1], [5, 2, 2]]);
    var b = new goog.math.Matrix([[4, 3, 1]]);
    var result = [[1, 3, 2], [2, 0, 1], [5, 2, 2], [4, 3, 1]];
    assertArrayEquals(result, m.appendRows(b).toArray());
  }


  function testSubmatrixByDeletion() {
    var m = new goog.math.Matrix([[1, 2, 3, 4], [5, 6, 7, 8],
        [9, 10, 11, 12], [13, 14, 15, 16]]);
    var arr = [[1, 2, 3], [5, 6, 7], [13, 14, 15]];
    assertArrayEquals(arr, m.getSubmatrixByDeletion_(2, 3).toArray());
  }


  function testMinor() {
    var m = new goog.math.Matrix([[1, 2, 3], [4, 5, 6], [7, 8, 9]]);
    assertEquals(-3, m.getMinor_(0, 0));
  }


  function testCofactor() {
    var m = new goog.math.Matrix([[1, 2, 3], [4, 5, 6], [7, 8, 9]]);
    assertEquals(6, m.getCofactor_(0, 1));
  }


  function testDeterminantForOneByOneMatrix() {
    var m = new goog.math.Matrix([[3]]);
    assertEquals(3, m.getDeterminant());
  }


  function testDeterminant() {
    var m = new goog.math.Matrix([[1, 2, 3], [4, 5, 6], [7, 8, 9]]);
    assertEquals(0, m.getDeterminant());
  }


  function testGetSubmatrix() {
    var m = new goog.math.Matrix([[ 2, -1,  0, 1, 0, 0],
                                  [-1,  2, -1, 0, 1, 0],
                                  [ 0, -1,  2, 0, 0, 1]]);
    var sub1 = [[2, -1, 0], [-1, 2, -1], [0, -1, 2]];
    assertArrayEquals(sub1,
                      m.getSubmatrixByCoordinates_(0, 0, 2, 2).toArray());

    var sub2 = [[1, 0, 0], [0, 1, 0], [0, 0, 1]];
    assertArrayEquals(sub2, m.getSubmatrixByCoordinates_(0, 3).toArray());
  }


  function testGetReducedRowEchelonForm() {
    var m = new goog.math.Matrix([[ 2, -1,  0, 1, 0, 0],
                                  [-1,  2, -1, 0, 1, 0],
                                  [ 0, -1,  2, 0, 0, 1]]);

    var expected = new goog.math.Matrix([[1, 0, 0, .75, .5, .25],
                                         [0, 1, 0, .5,  1,  .5 ],
                                         [0, 0, 1, .25, .5, .75]]);

    assertTrue(expected.equals(m.getReducedRowEchelonForm()));
  }


  function testInverse() {
    var m1 = new goog.math.Matrix([[ 2, -1,  0],
                                   [-1,  2, -1],
                                   [ 0, -1,  2]]);
    var expected1 = new goog.math.Matrix([[.75, .5, .25],
                                          [.5,  1,  .5 ],
                                          [.25, .5, .75]]);
    assertTrue(expected1.equals(m1.getInverse()));

    var m2 = new goog.math.Matrix([[4,  8],
                                   [7, -2]]);
    var expected2 = new goog.math.Matrix([[.03125,  .125 ],
                                          [.10936, -.0625]]);
    assertTrue(expected2.equals(m2.getInverse(), .0001));
  }


  function testEquals() {
    var a1 = new goog.math.Matrix([[1, 0, 0, .75, .5, .25],
                                   [0, 1, 0, .5,  1,  .5 ],
                                   [0, 0, 1, .25, .5, .75]]);

    var a2 = new goog.math.Matrix([[1, 0, 0, .75, .5, .25],
                                   [0, 1, 0, .5,  1,  .5 ],
                                   [0, 0, 1, .25, .5, .75]]);

    var a3 = new goog.math.Matrix([[1, 0, 0, .749, .5, .25],
                                   [0, 1, 0, .5,    1, .5 ],
                                   [0, 0, 1, .25,  .5, .75]]);

    assertTrue(a1.equals(a2));
    assertTrue(a1.equals(a3, .01));
    assertFalse(a1.equals(a3, .001));
  }

">n/a</td></tr>
<tr><td>line_test.html</td><td>Success</td><td> 5 passed, 0 failed.</td><td title="

  goog.require('goog.math.Coordinate');
  goog.require('goog.math.Line');
  goog.require('goog.testing.jsunit');



  function testEquals() {
    var input = new goog.math.Line(1, 2, 3, 4);

    assert(input.equals(input));
  }

  function testClone() {
    var input = new goog.math.Line(1, 2, 3, 4);

    assertNotEquals('Clone returns a new object', input, input.clone())
    assertTrue('Contents of clone match original', input.equals(input.clone()));
  }

  function testGetLength() {
    var input = new goog.math.Line(0, 0, Math.sqrt(2), Math.sqrt(2));
    assertRoughlyEquals(input.getSegmentLengthSquared(), 4, 1e-10);
    assertRoughlyEquals(input.getSegmentLength(), 2, 1e-10);
  }

  function testGetClosestPoint() {
    var input = new goog.math.Line(0, 1, 1, 2);

    var point = input.getClosestPoint(0, 3);
    assertRoughlyEquals(point.x, 1, 1e-10);
    assertRoughlyEquals(point.y, 2, 1e-10);
  }

  function testGetClosestSegmentPoint() {
    var input = new goog.math.Line(0, 1, 2, 3);

    var point = input.getClosestSegmentPoint(4, 4);
    assertRoughlyEquals(point.x, 2, 1e-10);
    assertRoughlyEquals(point.y, 3, 1e-10);

    point = input.getClosestSegmentPoint(new goog.math.Coordinate(-1, -10));
    assertRoughlyEquals(point.x, 0, 1e-10);
    assertRoughlyEquals(point.y, 1, 1e-10);
  }
">n/a</td></tr>
<tr><td>box_test.html</td><td>Success</td><td> 6 passed, 0 failed.</td><td title="

goog.require('goog.math.Box');
goog.require('goog.math.Coordinate');
goog.require('goog.testing.jsunit');



function testBoxClone() {
  var b = new goog.math.Box(0, 0, 0, 0);
  assertTrue(goog.math.Box.equals(b, b.clone()));

  b.left = 0;
  b.top = 1;
  b.right = 2;
  b.bottom = 3;
  assertTrue(goog.math.Box.equals(b, b.clone()));
}

function testBoxDistance() {
  var box = new goog.math.Box(50, 100, 100, 50);

  assertEquals(25,
               goog.math.Box.distance(box, new goog.math.Coordinate(75, 25)));
  assertEquals(10,
               goog.math.Box.distance(box, new goog.math.Coordinate(40, 80)));
  assertEquals(5,
               goog.math.Box.distance(box, new goog.math.Coordinate(46, 47)));
  assertEquals(10,
               goog.math.Box.distance(box, new goog.math.Coordinate(106, 108)));
}

function testBoxContains() {
  var box = new goog.math.Box(50, 100, 100, 50);

  assertTrue(goog.math.Box.contains(box, new goog.math.Coordinate(75, 75)));
  assertTrue(goog.math.Box.contains(box, new goog.math.Coordinate(50, 100)));
  assertTrue(goog.math.Box.contains(box, new goog.math.Coordinate(100, 99)));
  assertFalse(goog.math.Box.contains(box, new goog.math.Coordinate(100, 101)));
  assertFalse(goog.math.Box.contains(box, new goog.math.Coordinate(49, 50)));
  assertFalse(goog.math.Box.contains(box, new goog.math.Coordinate(25, 25)));
}

function testBoxContainsBox() {
  var box = new goog.math.Box(50, 100, 100, 50);

  function assertContains(boxB) {
    assertTrue(box + ' expected to contain ' + boxB,
        goog.math.Box.contains(box, boxB));
  }

  function assertNotContains(boxB) {
    assertFalse(box + ' expected to not contain ' + boxB,
        goog.math.Box.contains(box, boxB));
  }

  assertContains(new goog.math.Box(60, 90, 90, 60));
  assertNotContains(new goog.math.Box(1, 3, 4, 2));
  assertNotContains(new goog.math.Box(30, 90, 60, 60));
  assertNotContains(new goog.math.Box(60, 110, 60, 60));
  assertNotContains(new goog.math.Box(60, 90, 110, 60));
  assertNotContains(new goog.math.Box(60, 90, 60, 40));
}

function testBoxesIntersect() {
  var box = new goog.math.Box(50, 100, 100, 50);

  function assertIntersects(boxB) {
    assertTrue(box + ' expected to intersect ' + boxB,
        goog.math.Box.intersects(box, boxB));
  }
  function assertNotIntersects(boxB) {
    assertFalse(box + ' expected to not intersect ' + boxB,
        goog.math.Box.intersects(box, boxB));
  }

  assertIntersects(box);
  assertIntersects(new goog.math.Box(20, 80, 80, 20));
  assertIntersects(new goog.math.Box(50, 80, 100, 20));
  assertIntersects(new goog.math.Box(80, 80, 120, 20));
  assertIntersects(new goog.math.Box(20, 100, 80, 50));
  assertIntersects(new goog.math.Box(80, 100, 120, 50));
  assertIntersects(new goog.math.Box(20, 120, 80, 80));
  assertIntersects(new goog.math.Box(50, 120, 100, 80));
  assertIntersects(new goog.math.Box(80, 120, 120, 80));
  assertIntersects(new goog.math.Box(20, 120, 120, 20));
  assertIntersects(new goog.math.Box(70, 80, 80, 70));
  assertNotIntersects(new goog.math.Box(10, 30, 30, 10));
  assertNotIntersects(new goog.math.Box(10, 70, 30, 30));
  assertNotIntersects(new goog.math.Box(10, 100, 30, 50));
  assertNotIntersects(new goog.math.Box(10, 120, 30, 80));
  assertNotIntersects(new goog.math.Box(10, 140, 30, 120));
  assertNotIntersects(new goog.math.Box(30, 30, 70, 10));
  assertNotIntersects(new goog.math.Box(30, 140, 70, 120));
  assertNotIntersects(new goog.math.Box(50, 30, 100, 10));
  assertNotIntersects(new goog.math.Box(50, 140, 100, 120));
  assertNotIntersects(new goog.math.Box(80, 30, 120, 10));
  assertNotIntersects(new goog.math.Box(80, 140, 120, 120));
  assertNotIntersects(new goog.math.Box(120, 30, 140, 10));
  assertNotIntersects(new goog.math.Box(120, 70, 140, 30));
  assertNotIntersects(new goog.math.Box(120, 100, 140, 50));
  assertNotIntersects(new goog.math.Box(120, 120, 140, 80));
  assertNotIntersects(new goog.math.Box(120, 140, 140, 120));
}

function testExpandToInclude() {
  var box = new goog.math.Box(10, 50, 50, 10);
  box.expandToInclude(new goog.math.Box(60, 70, 70, 60));
  assertEquals(10, box.left);
  assertEquals(10, box.top);
  assertEquals(70, box.right);
  assertEquals(70, box.bottom);
  box.expandToInclude(new goog.math.Box(30, 40, 40, 30));
  assertEquals(10, box.left);
  assertEquals(10, box.top);
  assertEquals(70, box.right);
  assertEquals(70, box.bottom);
  box.expandToInclude(new goog.math.Box(0, 100, 100, 0));
  assertEquals(0, box.left);
  assertEquals(0, box.top);
  assertEquals(100, box.right);
  assertEquals(100, box.bottom);
}
">n/a</td></tr>
<tr><td>timer_test.html</td><td>Success</td><td> 10 passed, 0 failed.</td><td title="

  goog.require('goog.Timer');
  goog.require('goog.events');
  goog.require('goog.events.EventTarget');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.MockClock');



  var intervalIds = {};
  var intervalIdCounter = 0;
  var mockClock;
  var maxDuration = 60 * 1000; // 60s

  function setUp() {
    mockClock = new goog.testing.MockClock(true /* install */);
  }

  function tearDown() {
    mockClock.dispose();
  }

  // Run a test for 60s and see how many counts we get
  function runTest(string, ticks, number) {
    var t = new goog.Timer(ticks);
    var count = 0;
    goog.events.listen(t, 'tick', function(evt) {
      count++;
    });
    t.start();
    mockClock.tick(maxDuration);
    assertEquals(string, number, count);
    t.stop();
    goog.events.removeAll(t);
  }


  function test100msTicks() {
    // Desc, interval in ms, expected ticks in 60s
    runTest('10 ticks per second for 60 seconds', 100, 600);
  }

  function test500msTicks() {
    runTest('2 ticks per second for 60 seconds', 500, 120);
  }

  function test1sTicks() {
    runTest('1 tick per second for 60 seconds', 1000, 60);
  }

  function test2sTicks() {
    runTest('1 tick every 2 seconds for 60 seconds', 2000, 30);
  }

  function test5sTicks() {
    runTest('1 tick every 5 seconds for 60 seconds', 5000, 12);
  }

  function test10sTicks() {
    runTest('1 tick every 10 seconds for 60 seconds', 10000, 6);
  }

  function test30sTicks() {
    runTest('1 tick every 30 seconds for 60 seconds', 30000, 2);
  }

  function test60sTicks() {
    runTest('1 tick every 60 seconds', 60000, 1);
  }

  function testCallOnce() {
    var c = 0;
    var actualTimeoutId = goog.Timer.callOnce(
        function() {
          if (c > 0) {
            assertTrue('callOnce should only be called once', false);
          }
          c++;
        });
    assertEquals('callOnce should return the timeout ID',
        mockClock.getTimeoutsMade(), actualTimeoutId);

    var obj = {c:0};
    goog.Timer.callOnce(function() {
      if (this.c > 0) {
        assertTrue('callOnce should only be called once', false);
      }
      assertEquals(obj, this);
      this.c++;
    }, 1, obj);
    mockClock.tick(maxDuration);
  }

  function testCallOnceIgnoresTimeoutsTooLarge() {
    var failCallback = goog.partial(fail, 'Timeout should never be called');
    assertEquals('Timeouts slightly too large should yield a timer ID of -1',
      -1, goog.Timer.callOnce(failCallback, 2147483648));
    assertEquals('Infinite timeouts should yield a timer ID of -1',
      -1, goog.Timer.callOnce(failCallback, Infinity));
  }

">n/a</td></tr>
<tr><td>pool_test.html</td><td>Success</td><td> 14 passed, 0 failed.</td><td title="

  goog.require('goog.structs');
  goog.require('goog.structs.Pool');
  goog.require('goog.testing.jsunit');



// Implementation of the Pool class with isObjectDead() always returning TRUE,
// so that the the Pool will not reuse any objects.
function NoObjectReusePool(opt_min, opt_max) {
  goog.structs.Pool.call(this, opt_min, opt_max);
};
goog.inherits(NoObjectReusePool, goog.structs.Pool);

NoObjectReusePool.prototype.objectCanBeReused = function(obj) {
  return false;
};


function testExceedMax1() {
  var p = new goog.structs.Pool(0, 3);
  var obj1 = p.getObject();
  var obj2 = p.getObject();
  var obj3 = p.getObject();
  var obj4 = p.getObject();
  var obj5 = p.getObject();

  assertNotUndefined(obj1);
  assertNotUndefined(obj2);
  assertNotUndefined(obj3);
  assertUndefined(obj4);
  assertUndefined(obj5);
}


function testExceedMax2() {
  var p = new goog.structs.Pool(0, 1);
  var obj1 = p.getObject();
  var obj2 = p.getObject();
  var obj3 = p.getObject();
  var obj4 = p.getObject();
  var obj5 = p.getObject();

  assertNotUndefined(obj1);
  assertUndefined(obj2);
  assertUndefined(obj3);
  assertUndefined(obj4);
  assertUndefined(obj5);
}


function testExceedMax3() {
  var p = new goog.structs.Pool(); // default: 10
  var objs = [];

  for (var i = 0; i < 12; i++) {
    objs[i] = p.getObject();
  }

  for (var i = 0; i < 10; i++) {
    assertNotNull('First 10 should be not null', objs[i]);
  }

  assertUndefined(objs[10]);
  assertUndefined(objs[11]);
}


function testReleaseAndGet1() {
  var p = new goog.structs.Pool(0, 10);
  var o = p.getObject();
  assertEquals(1, p.getCount());
  assertEquals(1, p.getInUseCount());
  assertEquals(0, p.getFreeCount());
  assertTrue('Result should be true', p.releaseObject(o));
  assertEquals(1, p.getCount());
  assertEquals(0, p.getInUseCount());
  assertEquals(1, p.getFreeCount());
}


function testReleaseAndGet2() {
  var p = new NoObjectReusePool(0, 10);
  var o = p.getObject();
  assertEquals(1, p.getCount());
  assertEquals(1, p.getInUseCount());
  assertEquals(0, p.getFreeCount());
  assertTrue('Result should be true', p.releaseObject(o));
  assertEquals(0, p.getCount());
  assertEquals(0, p.getInUseCount());
  assertEquals(0, p.getFreeCount());
}


function testReleaseAndGet3() {
  var p = new goog.structs.Pool(0, 10);
  var o1 = p.getObject();
  var o2 = p.getObject();
  var o3 = p.getObject();
  var o4 = {};
  assertEquals(3, p.getCount());
  assertEquals(3, p.getInUseCount());
  assertEquals(0, p.getFreeCount());
  assertTrue('Result should be true', p.releaseObject(o1));
  assertTrue('Result should be true', p.releaseObject(o2));
  assertFalse('Result should be false', p.releaseObject(o4));
  assertEquals(3, p.getCount());
  assertEquals(1, p.getInUseCount());
  assertEquals(2, p.getFreeCount());
}


function testReleaseAndGet4() {
  var p = new NoObjectReusePool(0, 10);
  var o1 = p.getObject();
  var o2 = p.getObject();
  var o3 = p.getObject();
  var o4 = {};
  assertEquals(3, p.getCount());
  assertEquals(3, p.getInUseCount());
  assertEquals(0, p.getFreeCount());
  assertTrue('Result should be true', p.releaseObject(o1));
  assertTrue('Result should be true', p.releaseObject(o2));
  assertFalse('Result should be false', p.releaseObject(o4));
  assertEquals(1, p.getCount());
  assertEquals(1, p.getInUseCount());
  assertEquals(0, p.getFreeCount());
}


function testIsInPool1() {
  var p = new goog.structs.Pool();
  var o1 = p.getObject();
  var o2 = p.getObject();
  var o3 = p.getObject();
  var o4 = {};
  var o5 = {};
  var o6 = o1;

  assertTrue(p.contains(o1));
  assertTrue(p.contains(o2));
  assertTrue(p.contains(o3));
  assertFalse(p.contains(o4));
  assertFalse(p.contains(o5));
  assertTrue(p.contains(o6));
}


function testSetMin1() {
  var p = new goog.structs.Pool(0, 10);

  assertEquals(0, p.getCount());
  assertEquals(0, p.getInUseCount());
  assertEquals(0, p.getFreeCount());

  p.setMinimumCount(10);

  assertEquals(10, p.getCount());
  assertEquals(0, p.getInUseCount());
  assertEquals(10, p.getFreeCount());
}


function testSetMin2() {
  var p = new goog.structs.Pool(0, 10);

  assertEquals(0, p.getCount());
  assertEquals(0, p.getInUseCount());
  assertEquals(0, p.getFreeCount());

  var o1 = p.getObject();

  assertEquals(1, p.getCount());
  assertEquals(1, p.getInUseCount());
  assertEquals(0, p.getFreeCount());

  p.setMinimumCount(10);

  assertEquals(10, p.getCount());
  assertEquals(1, p.getInUseCount());
  assertEquals(9, p.getFreeCount());
}


function testSetMax1() {
  var p = new goog.structs.Pool(0, 10);

  assertEquals(0, p.getCount());
  assertEquals(0, p.getInUseCount());
  assertEquals(0, p.getFreeCount());

  var o1 = p.getObject();
  var o2 = p.getObject();
  var o3 = p.getObject();
  var o4 = p.getObject();
  var o5 = p.getObject();

  assertEquals(5, p.getCount());
  assertEquals(5, p.getInUseCount());
  assertEquals(0, p.getFreeCount());

  assertTrue('Result should be true', p.releaseObject(o5));

  assertEquals(5, p.getCount());
  assertEquals(4, p.getInUseCount());
  assertEquals(1, p.getFreeCount());

  p.setMaximumCount(4);

  assertEquals(4, p.getCount());
  assertEquals(4, p.getInUseCount());
  assertEquals(0, p.getFreeCount());
}


function testInvalidMinMax1() {
  var p = new goog.structs.Pool(0, 10);

  assertEquals(0, p.getCount());
  assertEquals(0, p.getInUseCount());
  assertEquals(0, p.getFreeCount());

  assertThrows(function() {
    p.setMinimumCount(11);
  });
}


function testInvalidMinMax2() {
  var p = new goog.structs.Pool(5, 10);

  assertEquals(5, p.getCount());
  assertEquals(0, p.getInUseCount());
  assertEquals(5, p.getFreeCount());

  assertThrows(function() {
    p.setMaximumCount(4);
  });
}


function testInvalidMinMax3() {
  assertThrows(function() {
    new goog.structs.Pool(10, 1);
  });
}


">n/a</td></tr>
<tr><td>circularbuffer_test.html</td><td>Success</td><td> 8 passed, 0 failed.</td><td title="

  goog.require('goog.structs.CircularBuffer');
  goog.require('goog.testing.jsunit');



function testCircularBuffer() {
  var buff = new goog.structs.CircularBuffer(2);
  buff.add('first');
  assertEquals(1, buff.getCount());
  assertEquals('first', buff.get(0));
  assertEquals('first', buff.getLast());
  buff.add('second');
  assertEquals(2, buff.getCount());
  assertEquals('first', buff.get(0));
  assertEquals('second', buff.get(1));
  assertEquals('second', buff.getLast());
  buff.add('third');
  assertEquals(2, buff.getCount());
  assertEquals('second', buff.get(0));
  assertEquals('third', buff.get(1));
  assertEquals('third', buff.getLast());
}

function testIsEmpty() {
  var buff = new goog.structs.CircularBuffer(2);
  assertTrue('initially empty', buff.isEmpty());
  buff.add('first');
  assertFalse('not empty after add empty', buff.isEmpty());
}

function testClear() {
  var buff = new goog.structs.CircularBuffer(2);
  buff.add('first');
  buff.clear();
  assertTrue('should be empty after clear', buff.isEmpty());

}

function testGetValues() {
  var buff = new goog.structs.CircularBuffer(2);
  buff.add('first');
  buff.add('second');
  assertEquals('firstsecond', buff.getValues().join(''));
}

function testGetNewestVtalues() {
  var buff = new goog.structs.CircularBuffer(5);
  buff.add('first');
  buff.add('second');
  buff.add('third');
  buff.add('fourth');
  buff.add('fifth');
  assertEquals('fourthfifth', buff.getNewestValues(2).join(''));
}


function testGetKeys() {
  var buff = new goog.structs.CircularBuffer(2);
  buff.add('first');
  buff.add('second');
  assertEquals('01', buff.getKeys().join(''));
}

function testContainsValue() {
  var buff = new goog.structs.CircularBuffer(2);
  buff.add('first');
  buff.add('second');
  assertTrue(buff.containsValue('first'));
  assertTrue(buff.containsValue('second'));
  assertFalse(buff.containsValue('third'));
}

function testContainsKey() {
  var buff = new goog.structs.CircularBuffer(3);
  buff.add('first');
  buff.add('second');
  buff.add('third');
  assertTrue(buff.containsKey(0));
  assertTrue(buff.containsKey('0'));
  assertTrue(buff.containsKey(1));
  assertTrue(buff.containsKey('1'));
  assertTrue(buff.containsKey(2));
  assertTrue(buff.containsKey('2'));
  assertFalse(buff.containsKey(3));
  assertFalse(buff.containsKey('3'));
}

">n/a</td></tr>
<tr><td>queue_test.html</td><td>Success</td><td> 9 passed, 0 failed.</td><td title="

  goog.require('goog.structs.Queue');
  goog.require('goog.testing.jsunit');



function stringifyQueue(q) {
  var values = q.getValues();
  var s = '';
  for (var i = 0; i < values.length; i++) {
    s += values[i];
  }
  return s;
}

function createQueue() {
  var q = new goog.structs.Queue();
  q.enqueue('a');
  q.enqueue('b');
  q.enqueue('c');
  return q;
}

function testConstructor() {
  var q = new goog.structs.Queue();
  assertTrue('testConstructor(), queue should be empty initially', q.isEmpty());
  assertEquals('testConstructor(), count should be 0', q.getCount(), 0);
  assertEquals('testConstructor(), head element should be undefined', q.peek(),
      undefined);
}

function testCount() {
  var q = createQueue();
  assertEquals('testCount(), count should be 3', q.getCount(), 3);
  q.enqueue('d');
  assertEquals('testCount(), count should be 4', q.getCount(), 4);
  q.dequeue();
  assertEquals('testCount(), count should be 3', q.getCount(), 3);
  q.clear();
  assertEquals('testCount(), count should be 0', q.getCount(), 0);
}

function testEnqueue() {
  var q = new goog.structs.Queue();
  q.enqueue('a');
  assertEquals('testEnqueue(), count should be 1', q.getCount(), 1);
  q.enqueue('b');
  assertEquals('testEnqueue(), count should be 2', q.getCount(), 2);
  assertEquals('testEnqueue(), head element should be a', q.peek(), 'a');
  q.dequeue();
  assertEquals('testEnqueue(), count should be 1', q.getCount(), 1);
  assertEquals('testEnqueue(), head element should be b', q.peek(), 'b');
}

function testDequeue() {
  var q = createQueue();
  var head = q.dequeue();
  assertEquals('testDequeue(), should return a', head, 'a');
  q.dequeue();
  head = q.dequeue();
  assertEquals('testDequeue(), should return c', head, 'c');
  assertTrue('testDequeue(), queue should be empty', q.isEmpty());
  head = q.dequeue();
  assertEquals('testDequeue(), should return undefined for empty queue', head,
      undefined);
}

function testPeek() {
  var q = createQueue();
  var head = q.peek();
  assertEquals('testPeek(), should return a', head, 'a');
  var head2 = q.dequeue();
  assertEquals('testPeek(), dequeue should return peek() result', head, head2);
  head = q.peek();
  assertEquals('testPeek(), should return b', head, 'b');
  q.clear();
  head = q.peek();
  assertEquals('testPeek(), should return undefined for empty queue', head,
      undefined);
}

function testClear() {
  var q = createQueue();
  q.clear();
  assertTrue('testClear(), queue should be empty', q.isEmpty());
}

function testQueue() {
  var q = createQueue();
  assertEquals('testQueue(), contents must be abc', stringifyQueue(q), 'abc');
}

function testRemove() {
  var q = createQueue();
  assertEquals('testRemove(), contents must be abc', stringifyQueue(q), 'abc');

  q.dequeue();
  assertEquals('testRemove(), contents must be bc', stringifyQueue(q), 'bc');

  q.enqueue('a');
  assertEquals('testRemove(), contents must be bca', stringifyQueue(q), 'bca');

  assertTrue('testRemove(), remove should have returned true', q.remove('c'));
  assertEquals('testRemove(), contents must be ba', stringifyQueue(q), 'ba');

  assertTrue('testRemove(), remove should have returned true', q.remove('b'));
  assertEquals('testRemove(), contents must be a', stringifyQueue(q), 'a');

  assertFalse('testRemove(), remove should have returned false', q.remove('b'));
  assertEquals('testRemove(), contents must be a', stringifyQueue(q), 'a');

  assertTrue('testRemove(), remove should have returned true', q.remove('a'));
  assertEquals('testRemove(), contents must be empty', stringifyQueue(q), '');
}

function testContains() {
  var q = createQueue();
  assertTrue('testContains(), contains should have returned true',
      q.contains('a'));
  assertFalse('testContains(), contains should have returned false',
      q.contains('foobar'));
}

">n/a</td></tr>
<tr><td>treenode_test.html</td><td>Success</td><td> 19 passed, 0 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.structs.TreeNode');
  goog.require('goog.testing.jsunit');



function testConstructor() {
  var node = new goog.structs.TreeNode('key', 'value');
  assertEquals('key', 'key', node.getKey());
  assertEquals('value', 'value', node.getValue());
  assertNull('parent', node.getParent());
  assertArrayEquals('children', [], node.getChildren());
  assertTrue('leaf', node.isLeaf());
}

function testClone() {
  var node1 = new goog.structs.TreeNode(1, '1');
  var node2 = new goog.structs.TreeNode(2, '2');
  var node3 = new goog.structs.TreeNode(3, '3');
  node1.addChild(node2);
  node2.addChild(node3);

  var clone = node2.clone();
  assertEquals('key', 2, clone.getKey());
  assertEquals('value', '2', clone.getValue());
  assertNull('parent', clone.getParent());
  assertArrayEquals('children', [], clone.getChildren());
}

function testDeepClone() {
  var node1 = new goog.structs.TreeNode(1, '1');
  var node2 = new goog.structs.TreeNode(2, '2');
  var node3 = new goog.structs.TreeNode(3, '3');
  node1.addChild(node2);
  node2.addChild(node3);

  var clone = node2.deepClone();
  assertEquals('key', 2, clone.getKey());
  assertEquals('value', '2', clone.getValue());
  assertNull('parent', clone.getParent());
  assertEquals('number of children', 1, clone.getChildren().length);
  assertEquals('first child key', 3, clone.getChildAt(0).getKey());
  assertNotEquals('first child has been cloned', node3, clone.getChildAt(0));
}

function testGetParent() {
  var node1 = new goog.structs.TreeNode(1, null);
  var node2 = new goog.structs.TreeNode(2, null);
  node1.addChild(node2);
  assertEquals('parent', node1, node2.getParent());
  assertNull('orphan', node1.getParent());
}

function testIsLeaf() {
  var node1 = new goog.structs.TreeNode(1, null);
  var node2 = new goog.structs.TreeNode(2, null);
  node1.addChild(node2);
  assertFalse('not leaf', node1.isLeaf());
  assertTrue('leaf', node2.isLeaf());
}

function testGetChildren() {
  var node1 = new goog.structs.TreeNode(1, null);
  var node2 = new goog.structs.TreeNode(2, null);
  node1.addChild(node2);
  assertArrayEquals('1 child', [node2], node1.getChildren());
  assertArrayEquals('no children', [], node2.getChildren());
}

function testGetChildAt() {
  var node1 = new goog.structs.TreeNode(1, null);
  var node2 = new goog.structs.TreeNode(2, null);
  node1.addChild(node2);
  assertNull('index too low', node1.getChildAt(-1));
  assertEquals('first child', node2, node1.getChildAt(0));
  assertNull('index too high', node1.getChildAt(1));
  assertNull('no children', node2.getChildAt(0));
}

function testGetChildCount() {
  var node1 = new goog.structs.TreeNode(1, null);
  var node2 = new goog.structs.TreeNode(2, null);
  node1.addChild(node2);
  assertEquals('child count of root node', 1, node1.getChildCount());
  assertEquals('child count of leaf node', 0, node2.getChildCount());
}

function testGetDepth() {
  var node1 = new goog.structs.TreeNode(1, null);
  var node2 = new goog.structs.TreeNode(2, null);
  var node3 = new goog.structs.TreeNode(3, null);
  node1.addChild(node2);
  node2.addChild(node3);
  assertEquals('no parent', 0, node1.getDepth());
  assertEquals('1 ancestor', 1, node2.getDepth());
  assertEquals('2 ancestors', 2, node3.getDepth());
}

function testGetAncestors() {
  var node1 = new goog.structs.TreeNode(1, null);
  var node2 = new goog.structs.TreeNode(2, null);
  var node3 = new goog.structs.TreeNode(3, null);
  node1.addChild(node2);
  node2.addChild(node3);
  assertArrayEquals('no ancestors', [], node1.getAncestors());
  assertArrayEquals('2 ancestors', [node2, node1], node3.getAncestors());
}

function testGetRoot() {
  var node1 = new goog.structs.TreeNode(1, null);
  var node2 = new goog.structs.TreeNode(2, null);
  node1.addChild(node2);
  assertEquals('no ancestors', node1, node1.getRoot());
  assertEquals('has ancestors', node1, node2.getRoot());
}

function testContains() {
  var node1 = new goog.structs.TreeNode(1, null);
  var node2 = new goog.structs.TreeNode(2, null);
  var node3 = new goog.structs.TreeNode(3, null);
  var node4 = new goog.structs.TreeNode(4, null);
  node1.addChild(node2);
  node2.addChild(node3);
  node2.addChild(node4);

  assertTrue('parent', node1.contains(node2));
  assertTrue('grandparent', node1.contains(node3));
  assertFalse('child', node2.contains(node1));
  assertFalse('grandchild', node3.contains(node1));
  assertFalse('sibling', node3.contains(node4));
}

function testForEachChild() {
  var node1 = new goog.structs.TreeNode(1, null);
  var node2 = new goog.structs.TreeNode(2, null);
  var node3 = new goog.structs.TreeNode(3, null);
  node1.addChild(node2);
  node1.addChild(node3);

  var thisContext = {};
  var visitedNodes = [];
  var indices = [];
  node1.forEachChild(function(node, index, children) {
    assertEquals('value of this', thisContext, this);
    visitedNodes.push(node);
    indices.push(index);
    assertArrayEquals('children argument', [node2, node3], children);
  }, thisContext);
  assertArrayEquals('visited nodes', [node2, node3], visitedNodes);
  assertArrayEquals('index of visited nodes', [0, 1],  indices);
}

function testForEachDescendant() {
  var node1 = new goog.structs.TreeNode(1, null);
  var node2 = new goog.structs.TreeNode(2, null);
  var node3 = new goog.structs.TreeNode(3, null);
  var node4 = new goog.structs.TreeNode(4, null);
  node1.addChild(node2);
  node2.addChild(node3);
  node2.addChild(node4);

  var thisContext = {};
  var visitedNodes = [];
  node1.forEachDescendant(function(node) {
    assertEquals('value of this', thisContext, this);
    visitedNodes.push(node);
  }, thisContext);
  assertArrayEquals('visited nodes', [node2, node3, node4], visitedNodes);
}

function testAddChild() {
  var node1 = new goog.structs.TreeNode(1, null);
  var node2 = new goog.structs.TreeNode(2, null);
  var node3 = new goog.structs.TreeNode(3, null);
  assertArrayEquals('0 children', [], node1.getChildren());
  node1.addChild(node2);
  assertArrayEquals('1 child', [node2], node1.getChildren());
  assertEquals('parent is set', node1, node2.getParent());
  node1.addChild(node3);
  assertArrayEquals('2 children', [node2, node3], node1.getChildren());
}

function testAddChildAt() {
  var node1 = new goog.structs.TreeNode(1, null);
  var node2 = new goog.structs.TreeNode(2, null);
  var node3 = new goog.structs.TreeNode(3, null);
  var node4 = new goog.structs.TreeNode(4, null);
  var node5 = new goog.structs.TreeNode(5, null);
  node1.addChildAt(node2, 0);
  assertArrayEquals('add first child', [node2], node1.getChildren());
  assertEquals('parent is set', node1, node2.getParent());
  node1.addChildAt(node3, 0);
  assertArrayEquals('add to the front', [node3, node2],
      node1.getChildren());
  node1.addChildAt(node4, 1);
  assertArrayEquals('add to the middle', [node3, node4, node2],
      node1.getChildren());
  node1.addChildAt(node5, 3);
  assertArrayEquals('add to the end', [node3, node4, node2, node5],
      node1.getChildren());
}

function testRemoveChildAt() {
  var node1 = new goog.structs.TreeNode(1, null);
  var node2 = new goog.structs.TreeNode(2, null);
  var node3 = new goog.structs.TreeNode(3, null);
  node1.addChild(node2);
  node1.addChild(node3);

  assertNull('index too low', node1.removeChildAt(-1));
  assertNull('index too high', node1.removeChildAt(2));
  assertArrayEquals('node1 is intact', [node2, node3], node1.getChildren());

  assertEquals('remove first child', node2, node1.removeChildAt(0));
  assertArrayEquals('remove from the front', [node3], node1.getChildren());
  assertNull('parent is unset', node2.getParent());

  assertEquals('remove last child', node3, node1.removeChildAt(0));
  assertArrayEquals('remove last child', [], node1.getChildren());
  assertTrue('node1 became leaf', node1.isLeaf());
}

function testRemoveChild() {
  var node1 = new goog.structs.TreeNode(1, null);
  var node2 = new goog.structs.TreeNode(2, null);
  var node3 = new goog.structs.TreeNode(3, null);
  node1.addChild(node2);
  node1.addChild(node3);

  assertNull('remove null', node1.removeChild(null));
  assertNull('remove non-child', node1.removeChild(node1));
  assertArrayEquals('node1 is intact', [node2, node3], node1.getChildren());

  assertEquals('remove node3, return value', node3, node1.removeChild(node3));
  assertArrayEquals('node is removed', [node2], node1.getChildren());
}

function testRemoveChildren() {
  var node1 = new goog.structs.TreeNode(1, null);
  var node2 = new goog.structs.TreeNode(2, null);
  var node3 = new goog.structs.TreeNode(3, null);
  node1.addChild(node2);
  node1.addChild(node3);

  node2.removeChildren();
  assertArrayEquals('removing a leaf node\'s children has no effect', [],
      node2.getChildren());
  assertEquals('node still has parent', node1, node2.getParent());

  node1.removeChildren();
  assertArrayEquals('children have been removed', [], node1.getChildren());
  assertNull('children\'s parents have been unset', node2.getParent());
}

">n/a</td></tr>
<tr><td>trie_test.html</td><td>Success</td><td> 18 passed, 0 failed.</td><td title="

  goog.require('goog.object');
  goog.require('goog.structs');
  goog.require('goog.structs.Trie');
  goog.require('goog.testing.jsunit');



function makeTrie() {
  var trie = new goog.structs.Trie();
  trie.add('hello', 1);
  trie.add('hi', 'howdy');
  trie.add('', 'an empty string key');
  trie.add('empty value', '');
  trie.add('zero', 0);
  trie.add('object', {});
  trie.add('null', null);
  trie.add('hello, world', 2);
  trie.add('world', {});
  return trie;
}

function checkTrie(trie) {
  assertEquals('get, should be 1', trie.get('hello'), 1);
  assertEquals('get, should be "howdy"', trie.get('hi'), 'howdy');
  assertEquals('get, should be "an empty string key"', trie.get(''),
      'an empty string key');
  assertEquals('get, should be ""', trie.get('empty value'), '');
  assertEquals('get, should be ""', typeof trie.get('empty value'), 'string');
  assertEquals('get, should be an object', typeof trie.get('object'), 'object');
  assertEquals('get, should be 0', trie.get('zero'), 0);
  assertEquals('get "null", should be null', trie.get('null'), null);
  assertEquals('get, should be 2', trie.get('hello, world'), 2);
  assertEquals('get, should be an object', typeof trie.get('world'), 'object');
}

function testTrieFormation() {
  var t = makeTrie();
  checkTrie(t);
}

function testFailureOfMultipleAdds() {
  var t = new goog.structs.Trie();
  t.add('hello', 'testing');
  assertThrows('Error should be thrown when same key added twice.', function() {
    t.add('hello', 'test');
  });

  t = new goog.structs.Trie();
  t.add('null', null);
  assertThrows('Error should be thrown when same key added twice.', function() {
    t.add('null', 'hi!');
  });

  t = new goog.structs.Trie();
  t.add('null', 'blah');
  assertThrows('Error should be thrown when same key added twice.', function() {
    t.add('null', null);
  });
}

function testTrieClone() {
  var trieOne = makeTrie();
  var trieTwo = new goog.structs.Trie(trieOne);
  checkTrie(trieTwo);
}

function testTrieFromObject() {
  var someObject = {'hello' : 1,
                    'hi' : 'howdy',
                    '' : 'an empty string key',
                    'empty value' : '',
                    'object' : {},
                    'zero' : 0,
                    'null' : null,
                    'hello, world' : 2,
                    'world' : {}};
  var trie = new goog.structs.Trie(someObject);
  checkTrie(trie);
}

function testTrieGetValues() {
  var trie = makeTrie();
  var values = trie.getValues();
  assertTrue('getValues, should contain "howdy"',
      goog.object.contains(values, 'howdy'));
  assertTrue('getValues, should contain 1', goog.object.contains(values, 1));
  assertTrue('getValues, should contain 0', goog.object.contains(values, 0));
  assertTrue('getValues, should contain ""', goog.object.contains(values, ''));
  assertTrue('getValues, should contain null',
      goog.object.contains(values, null));
  assertEquals('goog.structs.getCount(getValues()) should be 9',
      goog.structs.getCount(values), 9);
}

function testTrieGetKeys() {
  var trie = makeTrie();
  var keys = trie.getKeys();
  assertTrue('getKeys, should contain "hello"',
      goog.object.contains(keys, 'hello'));
  assertTrue('getKeys, should contain "empty value"',
      goog.object.contains(keys, 'empty value'));
  assertTrue('getKeys, should contain ""', goog.object.contains(keys, ''));
  assertTrue('getKeys, should contain "zero"',
      goog.object.contains(keys, 'zero'));
  assertEquals('goog.structs.getCount(getKeys()) should be 9',
      goog.structs.getCount(keys), 9);
}


function testTrieCount() {
  var trieOne = makeTrie();
  var trieTwo = new goog.structs.Trie();
  assertEquals('count, should be 9', trieOne.getCount(), 9);
  assertEquals('count, should be 0', trieTwo.getCount(), 0);
}

function testRemoveKeyFromTrie() {
  var trie = new goog.structs.Trie();
  trie.add('key1', 'value1');
  trie.add('key2', 'value2');
  trie.add('ke', 'value3');
  trie.add('zero', 0);
  trie.remove('key2');
  assertEquals('get "key1", should be "value1"', trie.get('key1'), 'value1');
  assertUndefined('get "key2", should be undefined', trie.get('key2'));
  trie.remove('zero');
  assertUndefined('get "zero", should be undefined', trie.get('zero'));
  trie.remove('ke');
  assertUndefined('get "ke", should be undefined', trie.get('ke'));
  assertEquals('get "key1", should be "value1"', trie.get('key1'), 'value1');
  trie.add('a', 'value4');
  assertTrue('testing internal structure, a should be a child',
      'a' in trie.childNodes_);
  trie.remove('a');
  assertFalse('testing internal structure, a should no longer be a child',
      'a' in trie.childNodes_);

  trie.add('xyza', 'value');
  trie.remove('xyza', 'value');
  assertFalse('Should not have "x"', 'x' in trie.childNodes_);

  trie.add('xyza', null);
  assertTrue('Should have "x"', 'x' in trie.childNodes_);
  trie.remove('xyza');
  assertFalse('Should not have "x"', 'x' in trie.childNodes_);

  trie.add('xyza', 'value');
  trie.add('xb', 'value');
  trie.remove('xyza');
  assertTrue('get "x" should be defined', 'x' in trie.childNodes_);
  assertFalse('get "y" should be undefined',
      'y' in trie.childNodes_['x'].childNodes_);
}

function testRemoveKeyFromTrieWithNulls() {
  var trie = new goog.structs.Trie();
  trie.add('key1', null);
  trie.add('key2', 'value2');
  trie.add('ke', 'value3');
  trie.add('zero', 0);
  trie.remove('key2');
  assertEquals('get "key1", should be null', trie.get('key1'), null);
  assertUndefined('get "key2", should be undefined', trie.get('key2'));
  trie.remove('zero');
  assertUndefined('get "zero", should be undefined', trie.get('zero'));
  trie.remove('ke');
  assertUndefined('get "ke", should be undefined', trie.get('ke'));
  assertEquals('get "key1", should be null', trie.get('key1'), null);
  trie.add('a', 'value4');
  assertTrue('testing internal structure, a should be a child',
      'a' in trie.childNodes_);
  trie.remove('a');
  assertFalse('testing internal structure, a should no longer be a child',
      'a' in trie.childNodes_);

  trie.add('xyza', null);
  trie.add('xb', 'value');
  trie.remove('xyza');
  assertTrue('Should have "x"', 'x' in trie.childNodes_);
  assertFalse('Should not have "y"',
      'y' in trie.childNodes_['x'].childNodes_);
}

function testRemoveKeyException() {
  var trie = new goog.structs.Trie();
  trie.add('abcdefg', 'value');
  trie.add('abcz', 'value');
  trie.add('abc', 'value');

  assertThrows('Remove should throw an error on removal of non-existent key',
      function() {
        trie.remove('abcdefge');
      });
}

function testTrieIsEmpty() {
  var trieOne = new goog.structs.Trie();
  var trieTwo = makeTrie();
  assertTrue('isEmpty, should be empty', trieOne.isEmpty());
  assertFalse('isEmpty, should not be empty', trieTwo.isEmpty());
  trieOne.add('', 1);
  assertFalse('isEmpty, should not be empty', trieTwo.isEmpty());
  trieOne.remove('');
  assertTrue('isEmpty, should be empty', trieOne.isEmpty());
  trieOne.add('', 1);
  trieOne.add('a', 1);
  trieOne.remove('a');
  assertFalse('isEmpty, should not be empty', trieOne.isEmpty());
  trieOne.remove('');
  assertTrue('isEmpty, should be empty', trieOne.isEmpty());
  trieOne.add('', 1);
  trieOne.add('a', 1);
  trieOne.remove('');
  assertFalse('isEmpty, should not be empty', trieOne.isEmpty());
  trieOne.remove('a');
  assertTrue('isEmpty, should be empty', trieOne.isEmpty());
}

function testTrieClear() {
  var trie = new goog.structs.Trie();
  trie.add('key1', 'value1');
  trie.add('key2', 'value2');
  trie.add('key3', null);
  trie.clear();
  assertUndefined('get key1, should be undefined', trie.get('key1'));
  assertUndefined('get key2, should be undefined', trie.get('key2'));
  assertUndefined('get key3, should be undefined', trie.get('key3'));
}

function testTrieContainsKey() {
  var trie = makeTrie();
  assertTrue('containsKey, should contain "hello"', trie.containsKey('hello'));
  assertTrue('containsKey, should contain "hi"', trie.containsKey('hi'));
  assertTrue('containsKey, should contain ""', trie.containsKey(''));
  assertTrue('containsKey, should contain "empty value"',
      trie.containsKey('empty value'));
  assertTrue('containsKey, should contain "object"',
      trie.containsKey('object'));
  assertTrue('containsKey, should contain "zero"', trie.containsKey('zero'));
  assertTrue('containsKey, should contain "null"', trie.containsKey('null'));
  assertFalse('containsKey, should not contain "blah"',
      trie.containsKey('blah'));
  trie.remove('');
  trie.remove('hi');
  trie.remove('zero');
  trie.remove('null');
  assertFalse('containsKey, should not contain "zero"',
      trie.containsKey('zero'));
  assertFalse('containsKey, should not contain ""', trie.containsKey(''));
  assertFalse('containsKey, should not contain "hi"', trie.containsKey('hi'));
  assertFalse('containsKey, should not contain "null"',
      trie.containsKey('null'));
}

function testTrieContainsValue() {
  var trie = makeTrie();
  assertTrue('containsValue, should be true, should contain 1',
      trie.containsValue(1));
  assertTrue('containsValue, should be true, should contain "howdy"',
      trie.containsValue('howdy'));
  assertTrue('containsValue, should be true, should contain ""',
      trie.containsValue(''));
  assertTrue('containsValue, should be true, should contain 0',
      trie.containsValue(0));
  assertTrue('containsValue, should be true, should contain null',
      trie.containsValue(null));
  assertTrue('containsValue, should be true, should ' +
      'contain "an empty string key"',
      trie.containsValue('an empty string key'));
  assertFalse('containsValue, should be false, should not contain "blah"',
      trie.containsValue('blah'));
  trie.remove('empty value');
  trie.remove('zero');
  assertFalse('containsValue, should be false, should not contain 0',
      trie.containsValue(0));
  assertFalse('containsValue, should be false, should not contain ""',
      trie.containsValue(''));
}

function testTrieHandlingOfEmptyStrings() {
  var trie = new goog.structs.Trie();
  assertEquals('get, should be undefined', trie.get(''), undefined);
  assertFalse('containsValue, should be false', trie.containsValue(''));
  assertFalse('containsKey, should be false', trie.containsKey(''));
  trie.add('', 'test');
  trie.add('test2', '');
  assertTrue('containsValue, should be true', trie.containsValue(''));
  assertTrue('containsKey, should be true', trie.containsKey(''));
  assertEquals('get, should be "test"', trie.get(''), 'test');
  assertEquals('get, should be ""', trie.get('test2'), '');
  trie.remove('');
  trie.remove('test2');
  assertEquals('get, should be undefined', trie.get(''), undefined);
  assertFalse('containsValue, should be false', trie.containsValue(''));
  assertFalse('containsKey, should be false', trie.containsKey(''));
}

function testPrefixOptionOnGetKeys() {
  var trie = new goog.structs.Trie();
  trie.add('abcdefg', 'one');
  trie.add('abcdefghijk', 'two');
  trie.add('abcde', 'three');
  trie.add('abcq', null);
  trie.add('abc', 'four');
  trie.add('xyz', 'five');
  assertEquals('getKeys, should be 1', trie.getKeys('xy').length, 1);
  assertEquals('getKeys, should be 1', trie.getKeys('xyz').length, 1);
  assertEquals('getKeys, should be 1', trie.getKeys('x').length, 1);
  assertEquals('getKeys, should be 4', trie.getKeys('abc').length, 5);
  assertEquals('getKeys, should be 2', trie.getKeys('abcdef').length, 2);
  assertEquals('getKeys, should be 0', trie.getKeys('abcdefgi').length, 0);
}

function testGetKeyAndPrefixes() {
  var trie = makeTrie();
  // Note: trie has one of its keys as ''
  assertEquals('getKeyAndPrefixes, should be 2',
               2,
               goog.object.getCount(trie.getKeyAndPrefixes('world')));
  assertEquals('getKeyAndPrefixes, should be 2',
               2,
               goog.object.getCount(trie.getKeyAndPrefixes('hello')));
  assertEquals('getKeyAndPrefixes, should be 2',
               2,
               goog.object.getCount(trie.getKeyAndPrefixes('hello,')));
  assertEquals('getKeyAndPrefixes, should be 3',
               3,
               goog.object.getCount(trie.getKeyAndPrefixes('hello, world')));
  assertEquals('getKeyAndPrefixes, should be 1',
               1,
               goog.object.getCount(trie.getKeyAndPrefixes('hell')));
}

function testGetKeyAndPrefixesStartIndex() {
  var trie = new goog.structs.Trie();
  trie.add('abcdefg', 'one');
  trie.add('bcdefg', 'two');
  trie.add('abcdefghijk', 'three');
  trie.add('abcde', 'four');
  trie.add('abcq', null);
  trie.add('q', null);
  trie.add('abc', 'five');
  trie.add('xyz', 'six');
  assertEquals('getKeyAndPrefixes, should be 3',
               3,
               goog.object.getCount(trie.getKeyAndPrefixes('abcdefg', 0)));
  assertEquals('getKeyAndPrefixes, should be 1',
               1,
               goog.object.getCount(trie.getKeyAndPrefixes('abcdefg', 1)));
  assertEquals('getKeyAndPrefixes, should be 1',
               1,
               goog.object.getCount(trie.getKeyAndPrefixes('abcq', 3)));
  assertEquals('getKeyAndPrefixes, should be 0',
               0,
               goog.object.getCount(trie.getKeyAndPrefixes('abcd', 3)));
}

">n/a</td></tr>
<tr><td>heap_test.html</td><td>Success</td><td> 19 passed, 0 failed.</td><td title="

  goog.require('goog.structs');
  goog.require('goog.structs.Heap');
  goog.require('goog.testing.jsunit');



function getHeap() {
  var h = new goog.structs.Heap();
  h.insert(0, 'a');
  h.insert(1, 'b');
  h.insert(2, 'c');
  h.insert(3, 'd');
  return h;
}


function getHeap2() {
  var h = new goog.structs.Heap();
  h.insert(1, 'b');
  h.insert(3, 'd');
  h.insert(0, 'a');
  h.insert(2, 'c');
  return h;
}


function testGetCount1() {
  var h = getHeap();
  assertEquals('count, should be 4', h.getCount(), 4);
  h.remove();
  assertEquals('count, should be 3', h.getCount(), 3);
}

function testGetCount2() {
  var h = getHeap();
  h.remove();
  h.remove();
  h.remove();
  h.remove();
  assertEquals('count, should be 0', h.getCount(), 0);
}


function testKeys() {
  var h = getHeap();
  var keys = h.getKeys();
  for (var i = 0; i < 4; i++) {
    assertTrue('getKeys, key ' + i + ' found', goog.structs.contains(keys, i));
  }
  assertEquals('getKeys, Should be 4 keys', goog.structs.getCount(keys), 4);
}


function testValues() {
  var h = getHeap();
  var values = h.getValues();

  assertTrue('getKeys, value "a" found', goog.structs.contains(values, 'a'));
  assertTrue('getKeys, value "b" found', goog.structs.contains(values, 'b'));
  assertTrue('getKeys, value "c" found', goog.structs.contains(values, 'c'));
  assertTrue('getKeys, value "d" found', goog.structs.contains(values, 'd'));
  assertEquals('getKeys, Should be 4 keys', goog.structs.getCount(values), 4);
}


function testContainsKey() {
  var h = getHeap();

  for (var i = 0; i < 4; i++) {
    assertTrue('containsKey, key ' + i + ' found', h.containsKey(i));
  }
  assertFalse('containsKey, value 4 not found', h.containsKey(4));
}


function testContainsValue() {
  var h = getHeap();

  assertTrue('containsValue, value "a" found', h.containsValue('a'));
  assertTrue('containsValue, value "b" found', h.containsValue('b'));
  assertTrue('containsValue, value "c" found', h.containsValue('c'));
  assertTrue('containsValue, value "d" found', h.containsValue('d'));
  assertFalse('containsValue, value "e" not found', h.containsValue('e'));
}


function testClone() {
  var h = getHeap();
  var h2 = h.clone();
  assertTrue('clone so it should not be empty', !h2.isEmpty());
  assertTrue('clone so it should contain key 0', h2.containsKey(0));
  assertTrue('clone so it should contain value "a"', h2.containsValue('a'));
}


function testClear() {
  var h = getHeap();
  h.clear();
  assertTrue('cleared so it should be empty', h.isEmpty());
}


function testIsEmpty() {
  var h = getHeap();
  assertFalse('4 values so should not be empty', h.isEmpty());

  h.remove();
  h.remove();
  h.remove();
  assertFalse('1 values so should not be empty', h.isEmpty());

  h.remove();
  assertTrue('0 values so should be empty', h.isEmpty());
}


function testPeek1() {
  var h = getHeap();
  assertEquals('peek, Should be "a"', h.peek(), 'a');
}


function testPeek2() {
  var h = getHeap2();
  assertEquals('peek, Should be "a"', h.peek(), 'a');
}


function testPeek3() {
  var h = getHeap();
  h.clear();
  assertEquals('peek, Should be "undefined"', h.peek(), undefined);
}


function testPeekKey1() {
  var h = getHeap();
  assertEquals('peekKey, Should be "0"', h.peekKey(), 0);
}


function testPeekKey2() {
  var h = getHeap2();
  assertEquals('peekKey, Should be "0"', h.peekKey(), 0);
}


function testPeekKey3() {
  var h = getHeap();
  h.clear();
  assertEquals('peekKey, Should be "undefined"', h.peekKey(), undefined);
}


function testRemove1() {
  var h = getHeap();

  assertEquals('remove, Should be "a"', h.remove(), 'a');
  assertEquals('remove, Should be "b"', h.remove(), 'b');
  assertEquals('remove, Should be "c"', h.remove(), 'c');
  assertEquals('remove, Should be "d"', h.remove(), 'd');
}


function testRemove2() {
  var h = getHeap2();

  assertEquals('remove, Should be "a"', h.remove(), 'a');
  assertEquals('remove, Should be "b"', h.remove(), 'b');
  assertEquals('remove, Should be "c"', h.remove(), 'c');
  assertEquals('remove, Should be "d"', h.remove(), 'd');
}


function testInsertPeek1() {
  var h = new goog.structs.Heap();

  h.insert(3, 'd');
  assertEquals('peek, Should be "d"', h.peek(), 'd');
  h.insert(2, 'c');
  assertEquals('peek, Should be "c"', h.peek(), 'c');
  h.insert(1, 'b');
  assertEquals('peek, Should be "b"', h.peek(), 'b');
  h.insert(0, 'a');
  assertEquals('peek, Should be "a"', h.peek(), 'a');
}


function testInsertPeek2() {
  var h = new goog.structs.Heap();

  h.insert(1, 'b');
  assertEquals('peak, Should be "b"', h.peek(), 'b');
  h.insert(3, 'd');
  assertEquals('peak, Should be "b"', h.peek(), 'b');
  h.insert(0, 'a');
  assertEquals('peak, Should be "a"', h.peek(), 'a');
  h.insert(2, 'c');
  assertEquals('peak, Should be "a"', h.peek(), 'a');
}


">n/a</td></tr>
<tr><td>priorityqueue_test.html</td><td>Success</td><td> 14 passed, 0 failed.</td><td title="

  goog.require('goog.structs');
  goog.require('goog.structs.PriorityQueue');
  goog.require('goog.testing.jsunit');



function getPriorityQueue() {
  var p = new goog.structs.PriorityQueue();
  p.enqueue(0, 'a');
  p.enqueue(1, 'b');
  p.enqueue(2, 'c');
  p.enqueue(3, 'd');
  return p;
}


function getPriorityQueue2() {
  var p = new goog.structs.PriorityQueue();
  p.insert(1, 'b');
  p.insert(3, 'd');
  p.insert(0, 'a');
  p.insert(2, 'c');
  return p;
}


function testGetCount1() {
  var p = getPriorityQueue();
  assertEquals('count, should be 4', p.getCount(), 4);
  p.dequeue();
  assertEquals('count, should be 3', p.getCount(), 3);
}


function testGetCount2() {
  var p = getPriorityQueue();
  assertEquals('count, should be 4', p.getCount(), 4);
  p.dequeue();
  assertEquals('count, should be 3', p.getCount(), 3);
}


function testGetCount3() {
  var p = getPriorityQueue();
  p.dequeue();
  p.dequeue();
  p.dequeue();
  p.dequeue();
  assertEquals('count, should be 0', p.getCount(), 0);
}


function testKeys() {
  var p = getPriorityQueue();
  var keys = p.getKeys();
  for (var i = 0; i < 4; i++) {
    assertTrue('getKeys, key ' + i + ' found', goog.structs.contains(keys, i));
  }
  assertEquals('getKeys, Should be 4 keys', goog.structs.getCount(keys), 4);
}


function testValues() {
  var p = getPriorityQueue();
  var values = p.getValues();

  assertTrue('getKeys, value "a" found', goog.structs.contains(values, 'a'));
  assertTrue('getKeys, value "b" found', goog.structs.contains(values, 'b'));
  assertTrue('getKeys, value "c" found', goog.structs.contains(values, 'c'));
  assertTrue('getKeys, value "d" found', goog.structs.contains(values, 'd'));
  assertEquals('getKeys, Should be 4 keys', goog.structs.getCount(values), 4);
}


function testClear() {
  var p = getPriorityQueue();
  p.clear();
  assertTrue('cleared so it should be empty', p.isEmpty());
}


function testIsEmpty() {
  var p = getPriorityQueue();
  assertFalse('4 values so should not be empty', p.isEmpty());

  p.dequeue();
  p.dequeue();
  p.dequeue();
  assertFalse('1 values so should not be empty', p.isEmpty());

  p.dequeue();
  assertTrue('0 values so should be empty', p.isEmpty());
}


function testPeek1() {
  var p = getPriorityQueue();
  assertEquals('peek, Should be "a"', p.peek(), 'a');
}


function testPeek2() {
  var p = getPriorityQueue2();
  assertEquals('peek, Should be "a"', p.peek(), 'a');
}


function testPeek3() {
  var p = getPriorityQueue();
  p.clear();
  assertEquals('peek, Should be "a"', p.peek(), undefined);
}


function testDequeue1() {
  var p = getPriorityQueue();

  assertEquals('dequeue, Should be "a"', p.dequeue(), 'a');
  assertEquals('dequeue, Should be "b"', p.dequeue(), 'b');
  assertEquals('dequeue, Should be "c"', p.dequeue(), 'c');
  assertEquals('dequeue, Should be "d"', p.dequeue(), 'd');
}


function testDequeue2() {
  var p = getPriorityQueue2();

  assertEquals('dequeue, Should be "a"', p.dequeue(), 'a');
  assertEquals('dequeue, Should be "b"', p.dequeue(), 'b');
  assertEquals('dequeue, Should be "c"', p.dequeue(), 'c');
  assertEquals('dequeue, Should be "d"', p.dequeue(), 'd');
}


function testEnqueuePeek1() {
  var p = new goog.structs.PriorityQueue();

  p.enqueue(3, 'd');
  assertEquals('peak, Should be "d"', p.peek(), 'd');
  p.enqueue(2, 'c');
  assertEquals('peak, Should be "c"', p.peek(), 'c');
  p.enqueue(1, 'b');
  assertEquals('peak, Should be "b"', p.peek(), 'b');
  p.enqueue(0, 'a');
  assertEquals('peak, Should be "a"', p.peek(), 'a');
}


function testEnqueuePeek2() {
  var p = new goog.structs.PriorityQueue();

  p.enqueue(1, 'b');
  assertEquals('peak, Should be "b"', p.peek(), 'b');
  p.enqueue(3, 'd');
  assertEquals('peak, Should be "b"', p.peek(), 'b');
  p.enqueue(0, 'a');
  assertEquals('peak, Should be "a"', p.peek(), 'a');
  p.enqueue(2, 'c');
  assertEquals('peak, Should be "a"', p.peek(), 'a');
}

">n/a</td></tr>
<tr><td>quadtree_test.html</td><td>Success</td><td> 12 passed, 0 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.structs');
  goog.require('goog.structs.QuadTree');
  goog.require('goog.testing.jsunit');



  function getTree() {
    var qt = new goog.structs.QuadTree(0, 0, 100, 100);
    qt.set(5, 20, 'Foo');
    qt.set(50, 32, 'Bar');
    qt.set(47, 96, 'Baz');
    qt.set(50, 50, 'Bing');
    qt.set(12, 0, 'Bong');
    return qt;
  }

  function testGetCount() {
    var qt = getTree();
    assertEquals('Count should be 5', 5, qt.getCount());
    qt.remove(50, 32);
    assertEquals('Count should be 4', 4, qt.getCount());
  }

  function testGetKeys() {
    var keys = getTree().getKeys();
    var keyString = keys.sort().join(' ');
    var expected = '(12, 0) (47, 96) (5, 20) (50, 32) (50, 50)';
    assertEquals('Sorted keys should be ' + expected, expected, keyString);
  }

  function testGetValues() {
    var values = getTree().getValues();
    var valueString = values.sort().join(',');
    assertEquals('Sorted values should be Bar,Baz,Bing,Bong,Foo',
        'Bar,Baz,Bing,Bong,Foo', valueString);
  }

  function testContains() {
    var qt = getTree();
    assertTrue('Should contain (5, 20)', qt.contains(5, 20));
    assertFalse('Should not contain (13, 13)', qt.contains(13, 13));
  }

  function testClear() {
    var qt = getTree();
    qt.clear();
    assertTrue('Tree should be empty', qt.isEmpty());
    assertFalse('Tree should not contain (5, 20)', qt.contains(5, 20));
  }

  function testConstructor() {
    var qt = new goog.structs.QuadTree(-10, -5, 6, 12);
    var root = qt.getRootNode();
    assertEquals('X of root should be -10', -10, root.x);
    assertEquals('Y of root should be -5', -5, root.y);
    assertEquals('Width of root should be 16', 16, root.w);
    assertEquals('Height of root should be 17', 17, root.h);
    assertTrue('Tree should be empty', qt.isEmpty());
  }

  function testClone() {
    var qt = getTree().clone();
    assertFalse('Clone should not be empty', qt.isEmpty());
    assertTrue('Should contain (47, 96)', qt.contains(47, 96));
  }

  function testRemove() {
    var qt = getTree();
    assertEquals('(5, 20) should be removed', 'Foo', qt.remove(5, 20));
    assertEquals('(5, 20) should be removed', 'Bar', qt.remove(50, 32));
    assertEquals('(5, 20) should be removed', 'Baz', qt.remove(47, 96));
    assertEquals('(5, 20) should be removed', 'Bing', qt.remove(50, 50));
    assertEquals('(5, 20) should be removed', 'Bong', qt.remove(12, 0));
    assertNull('(6, 6) wasn\'t there to remove', qt.remove(6, 6));
    assertTrue('Tree should be empty', qt.isEmpty());
    assertTreesChildrenAreNull(qt)
  }

  function testIsEmpty() {
    var qt = getTree();
    qt.clear();
    assertTrue(qt.isEmpty());
    assertEquals('Root should  be empty node',
        goog.structs.QuadTree.NodeType.EMPTY, qt.getRootNode().nodeType);
    assertTreesChildrenAreNull(qt);
  }

  function testForEach() {
    var qt = getTree();
    var s = '';
    goog.structs.forEach(qt, function(val, key, qt2) {
      assertNotUndefined(key);
      assertEquals(qt, qt2);
      s += key.x + ',' + key.y + '=' + val + ' ';
    });
    assertEquals('50,32=Bar 50,50=Bing 47,96=Baz 5,20=Foo 12,0=Bong ', s);
  }

  function testBalancing() {
    var qt = new goog.structs.QuadTree(0, 0, 100, 100);
    var root = qt.getRootNode();

    // Add a point to the NW quadrant.
    qt.set(25, 25, 'first');

    assertEquals('Root should be a leaf node.',
        goog.structs.QuadTree.NodeType.LEAF, root.nodeType);
    assertTreesChildrenAreNull(qt);

    assertEquals('first', root.point.value);

    // Add another point in the NW quadrant
    qt.set(25, 30, 'second');

  assertEquals('Root should now be a pointer.',
      goog.structs.QuadTree.NodeType.POINTER, root.nodeType);
    assertNotNull('NE should be not be null', root.ne);
    assertNotNull('NW should be not be null', root.nw);
    assertNotNull('SE should be not be null', root.se);
    assertNotNull('SW should be not be null', root.sw);
    assertNull(root.point);

    // Delete the second point.
    qt.remove(25, 30);

  assertEquals('Root should have been rebalanced and be a leaf node.',
      goog.structs.QuadTree.NodeType.LEAF, root.nodeType);
    assertTreesChildrenAreNull(qt);
    assertEquals('first', root.point.value);
  }

  function testTreeBounds() {
    var qt = getTree();
    assertFails(qt, qt.set, [-10, -10, 1]);
    assertFails(qt, qt.set, [-10, 10, 2]);
    assertFails(qt, qt.set, [10, -10, 3]);
    assertFails(qt, qt.set, [-10, 110, 4]);
    assertFails(qt, qt.set, [10, 130, 5]);
    assertFails(qt, qt.set, [110, -10, 6]);
    assertFails(qt, qt.set, [150, 14, 7]);
  }

  // Helper functions

  function assertFails(context, fn, args) {
    assertThrows('Exception expected from ' + fn.toString() +
        ' with arguments ' + args,
        function() {
          fn.apply(context, args);
        });
  }

  function assertTreesChildrenAreNull(qt) {
    var root = qt.getRootNode();
    assertNull('NE should be null', root.ne);
    assertNull('NW should be null', root.nw);
    assertNull('SE should be null', root.se);
    assertNull('SW should be null', root.sw);
  }

">n/a</td></tr>
<tr><td>set_test.html</td><td>Success</td><td> 19 passed, 0 failed.</td><td title="

  goog.require('goog.iter');
  goog.require('goog.structs');
  goog.require('goog.structs.Set');
  goog.require('goog.testing.jsunit');



var Set = goog.structs.Set;

function stringifySet(s) {
  return goog.structs.getValues(s).join('');
}

function testGetCount() {
  var s = new Set;
  var a = new String('a'); s.add(a);
  var b = new String('b'); s.add(b);
  var c = new String('c'); s.add(c);
  assertEquals('count, should be 3', s.getCount(), 3);
  var d = new String('d'); s.add(d);
  assertEquals('count, should be 4', s.getCount(), 4);
  s.remove(d);
  assertEquals('count, should be 3', s.getCount(), 3);

  s = new Set;
  s.add('a');
  s.add('b');
  s.add('c');
  assertEquals('count, should be 3', s.getCount(), 3);
  s.add('d');
  assertEquals('count, should be 4', s.getCount(), 4);
  s.remove('d');
  assertEquals('count, should be 3', s.getCount(), 3);
}

function testGetValues() {
  var s = new Set;
  var a = new String('a'); s.add(a);
  var b = new String('b'); s.add(b);
  var c = new String('c'); s.add(c);
  var d = new String('d'); s.add(d);
  assertEquals(s.getValues().join(''), 'abcd');

  var s = new Set;
  s.add('a');
  s.add('b');
  s.add('c');
  s.add('d');
  assertEquals(s.getValues().join(''), 'abcd');
}

function testContains() {
  var s = new Set;
  var a = new String('a'); s.add(a);
  var b = new String('b'); s.add(b);
  var c = new String('c'); s.add(c);
  var d = new String('d'); s.add(d);
  var e = new String('e');;

  assertTrue("contains, Should contain 'a'", s.contains(a));
  assertFalse("contains, Should not contain 'e'", s.contains(e));

  s = new Set;
  s.add('a');
  s.add('b');
  s.add('c');
  s.add('d');

  assertTrue("contains, Should contain 'a'", s.contains('a'));
  assertFalse("contains, Should not contain 'e'", s.contains('e'));
}

function testContainsFunctionValue() {
  var s = new Set;

  var fn1 = function() {};

  assertFalse(s.contains(fn1));
  s.add(fn1);
  assertTrue(s.contains(fn1));

  var fn2 = function() {};

  assertFalse(s.contains(fn2));
  s.add(fn2);
  assertTrue(s.contains(fn2));

  assertEquals(s.getCount(), 2);
}

function testContainsAll() {
  var set = new Set([1, 2, 3]);

  assertTrue("{1, 2, 3} contains []", set.containsAll([]));
  assertTrue("{1, 2, 3} contains [1]", set.containsAll([1]));
  assertTrue("{1, 2, 3} contains [1, 1]", set.containsAll([1, 1]));
  assertTrue("{1, 2, 3} contains [3, 2, 1]", set.containsAll([3, 2, 1]));
  assertFalse("{1, 2, 3} doesn't contain [4]", set.containsAll([4]));
  assertFalse("{1, 2, 3} doesn't contain [1, 4]", set.containsAll([1, 4]));

  assertTrue("{1, 2, 3} contains {a: 1}", set.containsAll({a: 1}));
  assertFalse("{1, 2, 3} doesn't contain {a: 4}", set.containsAll({a: 4}));

  assertTrue("{1, 2, 3} contains {1}", set.containsAll(new Set([1])));
  assertFalse("{1, 2, 3} doesn't contain {4}", set.containsAll(new Set([4])));
}

function testIntersection() {
  var emptySet = new Set;

  assertTrue('intersection of empty set and [] should be empty',
      emptySet.intersection([]).isEmpty());
  assertIntersection('intersection of 2 empty sets should be empty',
      emptySet, new Set(), new Set());

  var abcdSet = new Set();
  abcdSet.add('a');
  abcdSet.add('b');
  abcdSet.add('c');
  abcdSet.add('d');

  assertTrue('intersection of populated set and [] should be empty',
      abcdSet.intersection([]).isEmpty());
  assertIntersection('intersection of 2 empty sets should be empty',
      abcdSet, new Set(), new Set());

  var bcSet = new Set(['b', 'c']);
  assertIntersection('intersection of [a,b,c,d] and [b,c]',
      abcdSet, bcSet, bcSet);

  var bceSet = new Set(['b', 'c', 'e']);
  assertIntersection('intersection of [a,b,c,d] and [b,c,e]',
      abcdSet, bceSet, bcSet);
}

/**
 * Helper function to assert intersection is commutative.
 */
function assertIntersection(msg, set1, set2, expectedIntersection) {
  assertTrue(msg + ': set1->set2',
      set1.intersection(set2).equals(expectedIntersection));
  assertTrue(msg + ': set2->set1',
      set2.intersection(set1).equals(expectedIntersection));
}

function testRemoveAll() {
  assertRemoveAll('removeAll of empty set from empty set', [], [], []);
  assertRemoveAll('removeAll of empty set from populated set',
      ['a', 'b', 'c', 'd'], [], ['a', 'b', 'c', 'd']);
  assertRemoveAll('removeAll of [a,d] from [a,b,c,d]',
      ['a', 'b', 'c', 'd'], ['a', 'd'], ['b', 'c']);
  assertRemoveAll('removeAll of [b,c] from [a,b,c,d]',
      ['a', 'b', 'c', 'd'], ['b', 'c'], ['a', 'd']);
  assertRemoveAll('removeAll of [b,c,e] from [a,b,c,d]',
      ['a', 'b', 'c', 'd'], ['b', 'c', 'e'], ['a', 'd']);
  assertRemoveAll('removeAll of [a,b,c,d] from [a,d]',
      ['a', 'd'], ['a', 'b', 'c', 'd'], []);
  assertRemoveAll('removeAll of [a,b,c,d] from [b,c]',
      ['b', 'c'], ['a', 'b', 'c', 'd'], []);
  assertRemoveAll('removeAll of [a,b,c,d] from [b,c,e]',
      ['b', 'c', 'e'], ['a', 'b', 'c', 'd'], ['e']);
}

/**
 * Helper function to test removeAll.
 */
function assertRemoveAll(msg, elements1, elements2, expectedResult) {
  var set1 = new Set(elements1);
  var set2 = new Set(elements2);
  set1.removeAll(set2);

  assertTrue(msg + ': set1 count increased after removeAll',
      elements1.length >= set1.getCount());
  assertEquals(msg + ': set2 count changed after removeAll',
      elements2.length, set2.getCount());
  assertTrue(msg + ': wrong set1 after removeAll', set1.equals(expectedResult));
  assertIntersection(msg + ': non-empty intersection after removeAll',
      set1, set2, []);
}

function testAdd() {
  var s = new Set;
  var a = new String('a');
  var b = new String('b');
  s.add(a);
  assertTrue(s.contains(a));
  s.add(b)
  assertTrue(s.contains(b));

  s = new Set;
  s.add('a')
  assertTrue(s.contains('a'));
  s.add('b')
  assertTrue(s.contains('b'));
  s.add(null);
  assertTrue('contains null', s.contains(null));
  assertFalse('does not contain "null"', s.contains('null'));
}


function testClear() {
  var s = new Set;
  var a = new String('a'); s.add(a);
  var b = new String('b'); s.add(b);
  var c = new String('c'); s.add(c);
  var d = new String('d'); s.add(d);
  s.clear();
  assertTrue('cleared so it should be empty', s.isEmpty());
  assertTrue("cleared so it should not contain 'a' key", !s.contains(a));

  s = new Set;
  s.add('a');
  s.add('b');
  s.add('c');
  s.add('d');
  s.clear();
  assertTrue('cleared so it should be empty', s.isEmpty());
  assertTrue("cleared so it should not contain 'a' key", !s.contains('a'));
}


function testAddAll() {
  var s = new Set;
  var a = new String('a');
  var b = new String('b');
  var c = new String('c');
  var d = new String('d');
  s.addAll([a, b, c, d]);
  assertTrue('addAll so it should not be empty', !s.isEmpty());
  assertTrue("addAll so it should contain 'c' key", s.contains(c));

  var s2 = new Set;
  s2.addAll(s);
  assertTrue('addAll so it should not be empty', !s2.isEmpty());
  assertTrue("addAll so it should contain 'c' key", s2.contains(c));


  s = new Set;
  s.addAll(['a', 'b', 'c', 'd']);
  assertTrue('addAll so it should not be empty', !s.isEmpty());
  assertTrue("addAll so it should contain 'c' key", s.contains('c'));

  s2 = new Set;
  s2.addAll(s);
  assertTrue('addAll so it should not be empty', !s2.isEmpty());
  assertTrue("addAll so it should contain 'c' key", s2.contains('c'));
}


function testConstructor() {
  var s = new Set;
  var a = new String('a'); s.add(a);
  var b = new String('b'); s.add(b);
  var c = new String('c'); s.add(c);
  var d = new String('d'); s.add(d);
  var s2 = new Set(s);
  assertFalse('constr with Set so it should not be empty', s2.isEmpty());
  assertTrue('constr with Set so it should contain c', s2.contains(c));

  s = new Set;
  s.add('a');
  s.add('b');
  s.add('c');
  s.add('d');
  s2 = new Set(s);
  assertFalse('constr with Set so it should not be empty', s2.isEmpty());
  assertTrue('constr with Set so it should contain c', s2.contains('c'));
}


function testClone() {
  var s = new Set;
  var a = new String('a'); s.add(a);
  var b = new String('b'); s.add(b);
  var c = new String('c'); s.add(c);
  var d = new String('d'); s.add(d);

  var s2 = s.clone();
  assertFalse('clone so it should not be empty', s2.isEmpty());
  assertTrue("clone so it should contain 'c' key", s2.contains(c));

  var s = new Set;
  s.add('a');
  s.add('b');
  s.add('c');
  s.add('d');

  s2 = s.clone();
  assertFalse('clone so it should not be empty', s2.isEmpty());
  assertTrue("clone so it should contain 'c' key", s2.contains('c'));
}


/**
 * Helper method for testEquals().
 * @param {Object} a First element to use in the tests.
 * @param {Object} b Second element to use in the tests.
 * @param {Object} c Third element to use in the tests.
 * @param {Object} d Fourth element to use in the tests.
 */
function helperForTestEquals(a, b, c, d) {
  var s = new Set([a, b, c]);

  assertTrue("set == itself", s.equals(s));
  assertTrue("set == same set", s.equals(new Set([a, b, c])));
  assertTrue("set == its clone", s.equals(s.clone()));
  assertTrue("set == array of same elements", s.equals([a, b, c]));
  assertTrue("set == array of same elements in different order",
             s.equals([c, b, a]));

  assertFalse("set != empty set", s.equals(new Set));
  assertFalse("set != its subset", s.equals(new Set([a, c])));
  assertFalse("set != its superset",
              s.equals(new Set([a, b, c, d])));
  assertFalse("set != different set",
              s.equals(new Set([b, c, d])));
  assertFalse("set != its subset as array", s.equals([a, c]));
  assertFalse("set != its superset as array", s.equals([a, b, c, d]));
  assertFalse("set != different set as array", s.equals([b, c, d]));
  assertFalse("set != [a, b, c, c]", s.equals([a, b, c, c]));
  assertFalse("set != [a, b, b]", s.equals([a, b, b]));
  assertFalse("set != [a, a]", s.equals([a, a]));
}


function testEquals() {
  helperForTestEquals(1, 2, 3, 4);
  helperForTestEquals('a', 'b', 'c', 'd');
  helperForTestEquals(new String('a'), new String('b'),
                      new String('c'), new String('d'));
}


/**
 * Helper method for testIsSubsetOf().
 * @param {Object} a First element to use in the tests.
 * @param {Object} b Second element to use in the tests.
 * @param {Object} c Third element to use in the tests.
 * @param {Object} d Fourth element to use in the tests.
 */
function helperForTestIsSubsetOf(a, b, c, d) {
  var s = new Set([a, b, c]);

  assertTrue("set <= itself", s.isSubsetOf(s));
  assertTrue("set <= same set",
             s.isSubsetOf(new Set([a, b, c])));
  assertTrue("set <= its clone", s.isSubsetOf(s.clone()));
  assertTrue("set <= array of same elements", s.isSubsetOf([a, b, c]));
  assertTrue("set <= array of same elements in different order",
             s.equals([c, b, a]));

  assertTrue("set <= Set([a, b, c, d])",
             s.isSubsetOf(new Set([a, b, c, d])));
  assertTrue("set <= [a, b, c, d]", s.isSubsetOf([a, b, c, d]));
  assertTrue("set <= [a, b, c, c]", s.isSubsetOf([a, b, c, c]));

  assertFalse("set !<= Set([a, b])",
              s.isSubsetOf(new Set([a, b])));
  assertFalse("set !<= [a, b]", s.isSubsetOf([a, b]));
  assertFalse("set !<= Set([c, d])",
              s.isSubsetOf(new Set([c, d])));
  assertFalse("set !<= [c, d]", s.isSubsetOf([c, d]));
  assertFalse("set !<= Set([a, c, d])",
              s.isSubsetOf(new Set([a, c, d])));
  assertFalse("set !<= [a, c, d]", s.isSubsetOf([a, c, d]));
  assertFalse("set !<= [a, a, b]", s.isSubsetOf([a, a, b]));
  assertFalse("set !<= [a, a, b, b]", s.isSubsetOf([a, a, b, b]));
}


function testIsSubsetOf() {
  helperForTestIsSubsetOf(1, 2, 3, 4);
  helperForTestIsSubsetOf('a', 'b', 'c', 'd');
  helperForTestIsSubsetOf(new String('a'), new String('b'),
                          new String('c'), new String('d'));
}


function testForEach() {
  var s = new Set;
  var a = new String('a'); s.add(a);
  var b = new String('b'); s.add(b);
  var c = new String('c'); s.add(c);
  var d = new String('d'); s.add(d);
  var str = '';
  goog.structs.forEach(s, function(val, key, set) {
    assertUndefined(key);
    assertEquals(s, set);
    str += val;
  });
  assertEquals(str, 'abcd');

  s = new Set;
  s.add('a');
  s.add('b');
  s.add('c');
  s.add('d');
  str = '';
  goog.structs.forEach(s, function(val, key, set) {
    assertUndefined(key);
    assertEquals(s, set);
    str += val;
  });
  assertEquals(str, 'abcd');
}


function testFilter() {
  var s = new Set;
  var a = new Number(0); s.add(a);
  var b = new Number(1); s.add(b);
  var c = new Number(2); s.add(c);
  var d = new Number(3); s.add(d);

  var s2 = goog.structs.filter(s, function (val, key, set) {
    assertUndefined(key);
    assertEquals(s, set);
    return val > 1;
  });
  assertEquals(stringifySet(s2), '23');

  s = new Set;
  s.add(0);
  s.add(1);
  s.add(2);
  s.add(3);

  s2 = goog.structs.filter(s, function (val, key, set) {
    assertUndefined(key);
    assertEquals(s, set);
    return val > 1;
  });
  assertEquals(stringifySet(s2), '23');
}


function testSome() {
  var s = new Set;
  var a = new Number(0); s.add(a);
  var b = new Number(1); s.add(b);
  var c = new Number(2); s.add(c);
  var d = new Number(3); s.add(d);

  var b = goog.structs.some(s, function (val, key, s2) {
    assertUndefined(key);
    assertEquals(s, s2);
    return val > 1;
  });
  assertTrue(b);
  var b = goog.structs.some(s, function (val, key, s2) {
    assertUndefined(key);
    assertEquals(s, s2);
    return val > 100;
  });
  assertFalse(b);

  s = new Set;
  s.add(0);
  s.add(1);
  s.add(2);
  s.add(3);

  b = goog.structs.some(s, function (val, key, s2) {
    assertUndefined(key);
    assertEquals(s, s2);
    return val > 1;
  });
  assertTrue(b);
  b = goog.structs.some(s, function (val, key, s2) {
    assertUndefined(key);
    assertEquals(s, s2);
    return val > 100;
  });
  assertFalse(b);
}


function testEvery() {
  var s = new Set;
  var a = new Number(0); s.add(a);
  var b = new Number(1); s.add(b);
  var c = new Number(2); s.add(c);
  var d = new Number(3); s.add(d);

  var b = goog.structs.every(s, function (val, key, s2) {
    assertUndefined(key);
    assertEquals(s, s2);
    return val >= 0;
  });
  assertTrue(b);
  b = goog.structs.every(s, function (val, key, s2) {
    assertUndefined(key);
    assertEquals(s, s2);
    return val > 1;
  });
  assertFalse(b);

  s = new Set;
  s.add(0);
  s.add(1);
  s.add(2);
  s.add(3);

  b = goog.structs.every(s, function (val, key, s2) {
    assertUndefined(key);
    assertEquals(s, s2);
    return val >= 0;
  });
  assertTrue(b);
  b = goog.structs.every(s, function (val, key, s2) {
    assertUndefined(key);
    assertEquals(s, s2);
    return val > 1;
  });
  assertFalse(b);
}

function testIterator() {
  var s = new Set;
  s.add(0);
  s.add(1);
  s.add(2);
  s.add(3);
  s.add(4);

  assertEquals('01234', goog.iter.join(s, ''));

  s.remove(1);
  s.remove(3);

  assertEquals('024', goog.iter.join(s, ''));
}

">n/a</td></tr>
<tr><td>linkedmap_test.html</td><td>Success</td><td> 17 passed, 0 failed.</td><td title="

  goog.require('goog.structs.LinkedMap');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.recordFunction');



function fillLinkedMap(m) {
  m.set('a', 0);
  m.set('b', 1);
  m.set('c', 2);
  m.set('d', 3);
}

var someObj = {};

function testLinkedMap() {
  var m = new goog.structs.LinkedMap();
  fillLinkedMap(m);

  assertArrayEquals(['a', 'b', 'c', 'd'], m.getKeys());
  assertArrayEquals([0, 1, 2, 3], m.getValues());
}

function testMaxSizeLinkedMap() {
  var m = new goog.structs.LinkedMap(3);
  fillLinkedMap(m);

  assertArrayEquals(['b', 'c', 'd'], m.getKeys());
  assertArrayEquals([1, 2, 3], m.getValues());
}

function testLruLinkedMap() {
  var m = new goog.structs.LinkedMap(undefined, true);
  fillLinkedMap(m);

  assertArrayEquals(['d', 'c', 'b', 'a'], m.getKeys());
  assertArrayEquals([3, 2, 1, 0], m.getValues());

  m.get('a');
  assertArrayEquals(['a', 'd', 'c', 'b'], m.getKeys());
  assertArrayEquals([0, 3, 2, 1], m.getValues());

  m.set('b', 4);
  assertArrayEquals(['b', 'a', 'd', 'c'], m.getKeys());
  assertArrayEquals([4, 0, 3, 2], m.getValues());
}

function testMaxSizeLruLinkedMap() {
  var m = new goog.structs.LinkedMap(3, true);
  fillLinkedMap(m);

  assertArrayEquals(['d', 'c', 'b'], m.getKeys());
  assertArrayEquals([3, 2, 1], m.getValues());

  m.get('c');
  assertArrayEquals(['c', 'd', 'b'], m.getKeys());
  assertArrayEquals([2, 3, 1], m.getValues());

  m.set('d', 4);
  assertArrayEquals(['d', 'c', 'b'], m.getKeys());
  assertArrayEquals([4, 2, 1], m.getValues());
}

function testGetCount() {
  var m = new goog.structs.LinkedMap();
  assertEquals(0, m.getCount());
  m.set('a', 0);
  assertEquals(1, m.getCount());
  m.set('a', 1);
  assertEquals(1, m.getCount());
  m.set('b', 2);
  assertEquals(2, m.getCount());
  m.remove('a');
  assertEquals(1, m.getCount());
}

function testIsEmpty() {
  var m = new goog.structs.LinkedMap();
  assertTrue(m.isEmpty());
  m.set('a', 0);
  assertFalse(m.isEmpty());
  m.remove('a');
  assertTrue(m.isEmpty());
}

function testSetMaxCount() {
  var m = new goog.structs.LinkedMap(3);
  fillLinkedMap(m);
  assertEquals(3, m.getCount());

  m.setMaxCount(5);
  m.set('e', 5);
  m.set('f', 6);
  m.set('g', 7);
  assertEquals(5, m.getCount());

  m.setMaxCount(4);
  assertEquals(4, m.getCount());

  m.setMaxCount(0);
  m.set('h', 8);
  m.set('i', 9);
  m.set('j', 10);
  assertEquals(7, m.getCount());
}

function testClear() {
  var m = new goog.structs.LinkedMap();
  fillLinkedMap(m);
  m.clear();
  assertTrue(m.isEmpty());
}

function testForEach() {
  var m = new goog.structs.LinkedMap();
  fillLinkedMap(m);

  m.forEach(function(val, key, linkedMap) {
    linkedMap.set(key, val * 2);
    assertEquals('forEach should run in provided context.', someObj, this);
  }, someObj);

  assertArrayEquals(['a', 'b', 'c', 'd'], m.getKeys());
  assertArrayEquals([0, 2, 4, 6], m.getValues());
}

function testMap() {
  var m = new goog.structs.LinkedMap();
  fillLinkedMap(m);

  var result = m.map(function(val, key, linkedMap) {
    assertEquals('The LinkedMap object should get passed in', m, linkedMap);
    assertEquals('map should run in provided context', someObj, this);
    return key + val;
  }, someObj);

  assertArrayEquals(['a0', 'b1', 'c2', 'd3'], result);
}

function testSome() {
  var m = new goog.structs.LinkedMap();
  fillLinkedMap(m);

  var result = m.some(function(val, key, linkedMap) {
    assertEquals('The LinkedMap object should get passed in', m, linkedMap);
    assertEquals('map should run in provided context', someObj, this);
    return val > 2;
  }, someObj);

  assertTrue(result);
  assertFalse(m.some(function(val) {return val > 3}));

  assertTrue(m.some(function(val, key) {return key == 'c';}));
  assertFalse(m.some(function(val, key) {return key == 'e';}));
}

function testEvery() {
  var m = new goog.structs.LinkedMap();
  fillLinkedMap(m);

  var result = m.every(function(val, key, linkedMap) {
    assertEquals('The LinkedMap object should get passed in', m, linkedMap);
    assertEquals('map should run in provided context', someObj, this);
    return val < 5;
  }, someObj);

  assertTrue(result);
  assertFalse(m.every(function(val) {return val < 2}));

  assertTrue(m.every(function(val, key) {return key.length == 1;}));
  assertFalse(m.every(function(val, key) {return key == 'b';}));
}

function testPeek() {
  var m = new goog.structs.LinkedMap();
  assertEquals(undefined, m.peek());
  assertEquals(undefined, m.peekLast());

  fillLinkedMap(m);
  assertEquals(0, m.peek());

  m.remove('a');
  assertEquals(1, m.peek());

  assertEquals(3, m.peekLast());

  assertEquals(3, m.peekValue('d'));
  assertEquals(1, m.peek());

  m.remove('d');
  assertEquals(2, m.peekLast());
}

function testPop() {
  var m = new goog.structs.LinkedMap();
  assertEquals(undefined, m.shift());
  assertEquals(undefined, m.pop());

  fillLinkedMap(m);
  assertEquals(4, m.getCount());

  assertEquals(0, m.shift());
  assertEquals(1, m.peek());

  assertEquals(3, m.pop());
  assertEquals(2, m.peekLast());

  assertEquals(2, m.getCount());
}

function testContains() {
  var m = new goog.structs.LinkedMap();
  fillLinkedMap(m);

  assertTrue(m.contains(2));
  assertFalse(m.contains(4));
}

function testContainsKey() {
  var m = new goog.structs.LinkedMap();
  fillLinkedMap(m);

  assertTrue(m.containsKey('b'));
  assertFalse(m.containsKey('elephant'));
  assertFalse(m.containsKey('undefined'));
}

function testRemoveNodeCalls() {
  var m = new goog.structs.LinkedMap(1);
  m.removeNode = goog.testing.recordFunction(m.removeNode);

  m.set('1', 1);
  assertEquals('removeNode not called after adding an element', 0,
      m.removeNode.getCallCount());
  m.set('1', 2);
  assertEquals('removeNode not called after updating an element', 0,
      m.removeNode.getCallCount());
  m.set('2', 2);
  assertEquals('removeNode called after adding an overflowing element', 1,
      m.removeNode.getCallCount());

  m.remove('3');
  assertEquals('removeNode not called after removing a non-existing element', 1,
      m.removeNode.getCallCount());
  m.remove('2');
  assertEquals('removeNode called after removing an existing element', 2,
      m.removeNode.getCallCount());

  m.set('1', 1);
  m.clear();
  assertEquals('removeNode called after clearing the map', 3,
      m.removeNode.getCallCount());
  m.clear();
  assertEquals('removeNode not called after clearing an empty map', 3,
      m.removeNode.getCallCount());

  m.set('1', 1);
  m.pop();
  assertEquals('removeNode called after calling pop', 4,
      m.removeNode.getCallCount());
  m.pop();
  assertEquals('removeNode not called after calling pop on an empty map', 4,
      m.removeNode.getCallCount());

  m.set('1', 1);
  m.shift();
  assertEquals('removeNode called after calling shift', 5,
      m.removeNode.getCallCount());
  m.shift();
  assertEquals('removeNode not called after calling shift on an empty map', 5,
      m.removeNode.getCallCount());

  m.setMaxCount(2);
  m.set('1', 1);
  m.set('2', 2);
  assertEquals('removeNode not called after increasing the maximum map size', 5,
      m.removeNode.getCallCount());
  m.setMaxCount(1);
  assertEquals('removeNode called after decreasing the maximum map size', 6,
      m.removeNode.getCallCount());
}

">n/a</td></tr>
<tr><td>structs_test.html</td><td>Fail</td><td> 51 passed, 14 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.object');
  goog.require('goog.structs');
  goog.require('goog.structs.Set');  // needed for filter
  goog.require('goog.structs.Map');
  goog.require('goog.testing.jsunit');



/*

 This one does not test Map or Set
 It tests Array, Object, String and a NodeList

*/



function stringifyObject(obj) {
  var sb = [];
  for (var key in obj) {
    sb.push(key + obj[key]);
  }
  return sb.join('');
}


function getTestElement() {
  return document.getElementById('test');
}


function getAll() {
  return getTestElement().getElementsByTagName('*')
}


var node;


function addNode() {
  node = document.createElement('span');
  getTestElement().appendChild(node);
}


function removeNode() {
  getTestElement().removeChild(node);
}


function nodeNames(nl) {
  var sb = [];
  for (var i = 0, n; n = nl[i]; i++) {
    sb.push(n.nodeName.toLowerCase());
  }
  return sb.join(',');
}


var allTagNames1 = 'hr,p,p,p,p,p,p,p,p,h1';
var allTagNames2 = allTagNames1 + ',span';


function testGetCount() {
  var arr = ['a', 'b', 'c'];
  assertEquals('count, should be 3', 3, goog.structs.getCount(arr));
  arr.push('d');
  assertEquals('count, should be 4', 4, goog.structs.getCount(arr));
  goog.array.remove(arr, 'd');
  assertEquals('count, should be 3', 3, goog.structs.getCount(arr));

  var obj = {a: 0, b: 1, c: 2};
  assertEquals('count, should be 3', 3, goog.structs.getCount(obj));
  obj.d = 3;
  assertEquals('count, should be 4', 4, goog.structs.getCount(obj));
  delete obj.d;
  assertEquals('count, should be 3', 3, goog.structs.getCount(obj));

  var s = 'abc';
  assertEquals('count, should be 3', 3, goog.structs.getCount(s));
  s += 'd';
  assertEquals('count, should be 4', 4, goog.structs.getCount(s));

  var all = getAll();
  assertEquals('count, should be 10', 10, goog.structs.getCount(all));
  addNode();
  assertEquals('count, should be 11', 11, goog.structs.getCount(all));
  removeNode();
  assertEquals('count, should be 10', 10, goog.structs.getCount(all));

  var aMap = new goog.structs.Map({a: 0, b: 1, c: 2});
  assertEquals('count, should be 3', 3, goog.structs.getCount(aMap));
  aMap.set('d', 3);
  assertEquals('count, should be 4', 4, goog.structs.getCount(aMap));
  aMap.remove('a');
  assertEquals('count, should be 3', 3, goog.structs.getCount(aMap));

  var aSet = new goog.structs.Set('abc');
  assertEquals('count, should be 3', 3, goog.structs.getCount(aSet));
  aSet.add('d');
  assertEquals('count, should be 4', 4, goog.structs.getCount(aSet));
  aSet.remove('a');
  assertEquals('count, should be 3', 3, goog.structs.getCount(aSet));
}


function testGetValues() {
  var arr = ['a', 'b', 'c', 'd'];
  assertEquals('abcd', goog.structs.getValues(arr).join(''));

  var obj = {a: 0, b: 1, c: 2, d: 3};
  assertEquals('0123', goog.structs.getValues(obj).join(''));

  var s = 'abc';
  assertEquals('abc', goog.structs.getValues(s).join(''));
  s += 'd';
  assertEquals('abcd', goog.structs.getValues(s).join(''));

  var all = getAll();
  assertEquals(allTagNames1, nodeNames(goog.structs.getValues(all)));
  addNode();
  assertEquals(allTagNames2, nodeNames(goog.structs.getValues(all)));
  removeNode();
  assertEquals(allTagNames1, nodeNames(goog.structs.getValues(all)));

  var aMap = new goog.structs.Map({a: 1, b: 2, c: 3});
  assertEquals('123', goog.structs.getValues(aMap).join(''));

  var aSet = new goog.structs.Set([1, 2, 3]);
  assertEquals('123', goog.structs.getValues(aMap).join(''));
}


function testGetKeys() {
  var arr = ['a', 'b', 'c', 'd'];
  assertEquals('0123', goog.structs.getKeys(arr).join(''));

  var obj = {a: 0, b: 1, c: 2, d: 3};
  assertEquals('abcd', goog.structs.getKeys(obj).join(''));

  var s = 'abc';
  assertEquals('012', goog.structs.getKeys(s).join(''));
  s += 'd';
  assertEquals('0123', goog.structs.getKeys(s).join(''));

  var all = getAll();
  assertEquals('0123456789', goog.structs.getKeys(all).join(''));
  addNode();
  assertEquals('012345678910', goog.structs.getKeys(all).join(''));
  removeNode();
  assertEquals('0123456789', goog.structs.getKeys(all).join(''));

  var aMap = new goog.structs.Map({a: 1, b: 2, c: 3});
  assertEquals('abc', goog.structs.getKeys(aMap).join(''));

  var aSet = new goog.structs.Set([1, 2, 3]);
  assertUndefined(goog.structs.getKeys(aSet));
}

function testContains() {
  var arr = ['a', 'b', 'c', 'd'];
  assertTrue("contains, Should contain 'a'", goog.structs.contains(arr, 'a'));
  assertFalse("contains, Should not contain 'e'", goog.structs.contains(arr, 'e'));

  var obj = {a: 0, b: 1, c: 2, d: 3};
  assertTrue("contains, Should contain '0'", goog.structs.contains(obj, 0));
  assertFalse("contains, Should not contain '4'", goog.structs.contains(obj, 4));

  var s = 'abc';
  assertTrue("contains, Should contain 'a'", goog.structs.contains(s, 'a'));
  assertFalse("contains, Should not contain 'd'", goog.structs.contains(s, 'd'));

  var all = getAll();
  assertTrue("contains, Should contain 'h1'",
             goog.structs.contains(all, document.getElementById('h1')));
  assertFalse("contains, Should not contain 'document.body'",
              goog.structs.contains(all, document.body));

  var aMap = new goog.structs.Map({a: 1, b: 2, c: 3});
  assertTrue("contains, Should contain '1'", goog.structs.contains(aMap, 1));
  assertFalse("contains, Should not contain '4'", goog.structs.contains(aMap, 4));

  var aSet = new goog.structs.Set([1, 2, 3]);
  assertTrue("contains, Should contain '1'", goog.structs.contains(aSet, 1));
  assertFalse("contains, Should not contain '4'", goog.structs.contains(aSet, 4));
}


function testClear() {
  var arr = ['a', 'b', 'c', 'd'];
  goog.structs.clear(arr);
  assertTrue('cleared so it should be empty', goog.structs.isEmpty(arr));
  assertFalse("cleared so it should not contain 'a'", goog.structs.contains(arr, 'a'));

  var obj = {a: 0, b: 1, c: 2, d: 3};
  goog.structs.clear(obj);
  assertTrue('cleared so it should be empty', goog.structs.isEmpty(obj));
  assertFalse("cleared so it should not contain 'a' key", goog.structs.contains(obj, 0));

  var aMap = new goog.structs.Map({a: 1, b: 2, c: 3});
  goog.structs.clear(aMap);
  assertTrue('cleared map so it should be empty', goog.structs.isEmpty(aMap));
  assertFalse("cleared map so it should not contain '1' value",
      goog.structs.contains(aMap, 1));

  var aSet = new goog.structs.Set([1, 2, 3]);
  goog.structs.clear(aSet);
  assertTrue('cleared set so it should be empty', goog.structs.isEmpty(aSet));
  assertFalse("cleared set so it should not contain '1'", goog.structs.contains(aSet, 1));

  // cannot clear a string or a NodeList
}



// Map

function testMap() {
  var RV = {};
  var obj = {
    map: function(g) {
      assertEquals(f, g);
      assertEquals(this, obj);
      return RV;
    }
  };
  function f() {}
  assertEquals(RV, goog.structs.map(obj, f));
}

function testMap2() {
  var THIS_OBJ = {};
  var RV = {};
  var obj = {
    map: function(g, obj2) {
      assertEquals(f, g);
      assertEquals(this, obj);
      assertEquals(THIS_OBJ, obj2);
      return RV;
    }
  };
  function f() {}
  assertEquals(RV, goog.structs.map(obj, f, THIS_OBJ));
}

function testMapArrayLike() {
  var col = [0, 1, 2];
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    return v * v;
  }
  assertArrayEquals([0, 1, 4], goog.structs.map(col, f));
}

function testMapArrayLike2() {
  var THIS_OBJ = {};
  var col = [0, 1, 2];
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    assertEquals(THIS_OBJ, this);
    return v * v;
  }
  assertArrayEquals([0, 1, 4], goog.structs.map(col, f, THIS_OBJ));
}

function testMapString() {
  var col = '012';
  function f(v, i, col2) {
    // Teh SpiderMonkey Array.map for strings turns the string into a String
    // so we cannot use assertEquals because it uses ===.
    assertTrue(col == col2);
    assertEquals('number', typeof i);
    return Number(v) * Number(v);
  }
  assertArrayEquals([0, 1, 4], goog.structs.map(col, f));
}

function testMapString2() {
  var THIS_OBJ = {};
  var col = '012';
  function f(v, i, col2) {
    // for some reason the strings are equal but identical???
    assertEquals(String(col), String(col2));
    assertEquals('number', typeof i);
    assertEquals(THIS_OBJ, this);
    return Number(v) * Number(v);
  }
  assertArrayEquals([0, 1, 4], goog.structs.map(col, f, THIS_OBJ));
}

function testMapMap() {
  var col = new goog.structs.Map({a: 0, b: 1, c: 2});
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('string', typeof key);
    return v * v;
  }
  assertObjectEquals({a: 0, b: 1, c: 4}, goog.structs.map(col, f));
}

function testMapMap2() {
  var THIS_OBJ = {};
  var col = new goog.structs.Map({a: 0, b: 1, c: 2});
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('string', typeof key);
    assertEquals(THIS_OBJ, this);
    return v * v;
  }
  assertObjectEquals({a: 0, b: 1, c: 4}, goog.structs.map(col, f, THIS_OBJ));
}

function testMapSet() {
  var col = new goog.structs.Set([0, 1, 2]);
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('undefined', typeof key);
    return v * v;
  }
  assertArrayEquals([0, 1, 4], goog.structs.map(col, f));
}

function testMapSet2() {
  var THIS_OBJ = {};
  var col = new goog.structs.Set([0, 1, 2]);
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('undefined', typeof key);
    assertEquals(THIS_OBJ, this);
    return v * v;
  }
  assertArrayEquals([0, 1, 4], goog.structs.map(col, f, THIS_OBJ));
}

function testMapNodeList() {
  var col = getAll();
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    return v.tagName;
  }
  assertEquals('HRPPPPPPPPH1', goog.structs.map(col, f).join(''));
}

function testMapNodeList2() {
  var THIS_OBJ = {};
  var col = getAll();
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    assertEquals(THIS_OBJ, this);
    return v.tagName;
  }
  assertEquals('HRPPPPPPPPH1', goog.structs.map(col, f, THIS_OBJ).join(''));
}

// Filter

function testFilter() {
  var RV = {};
  var obj = {
    filter: function(g) {
      assertEquals(f, g);
      assertEquals(this, obj);
      return RV;
    }
  };
  function f() {}
  assertEquals(RV, goog.structs.filter(obj, f));
}

function testFilter2() {
  var THIS_OBJ = {};
  var RV = {};
  var obj = {
    filter: function(g, obj2) {
      assertEquals(f, g);
      assertEquals(this, obj);
      assertEquals(THIS_OBJ, obj2);
      return RV;
    }
  };
  function f() {}
  assertEquals(RV, goog.structs.filter(obj, f, THIS_OBJ));
}

function testFilterArrayLike() {
  var col = [0, 1, 2];
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    return v > 0;
  }
  assertArrayEquals([1, 2], goog.structs.filter(col, f));
}

function testFilterArrayLike2() {
  var THIS_OBJ = {};
  var col = [0, 1, 2];
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    assertEquals(THIS_OBJ, this);
    return v > 0;
  }
  assertArrayEquals([1, 2], goog.structs.filter(col, f, THIS_OBJ));
}

function testFilterString() {
  var col = '012';
  function f(v, i, col2) {
    // for some reason the strings are equal but identical???
    assertEquals(String(col), String(col2));
    assertEquals('number', typeof i);
    return Number(v) > 0;
  }
  assertArrayEquals(['1', '2'], goog.structs.filter(col, f));
}

function testFilterString2() {
  var THIS_OBJ = {};
  var col = '012';
  function f(v, i, col2) {
    // for some reason the strings are equal but identical???
    assertEquals(String(col), String(col2));
    assertEquals('number', typeof i);
    assertEquals(THIS_OBJ, this);
    return Number(v) > 0;
  }
  assertArrayEquals(['1', '2'], goog.structs.filter(col, f, THIS_OBJ));
}

function testFilterMap() {
  var col = new goog.structs.Map({a: 0, b: 1, c: 2});
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('string', typeof key);
    return v > 0;
  }
  assertObjectEquals({b: 1, c: 2}, goog.structs.filter(col, f));
}

function testFilterMap2() {
  var THIS_OBJ = {};
  var col = new goog.structs.Map({a: 0, b: 1, c: 2});
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('string', typeof key);
    assertEquals(THIS_OBJ, this);
    return v > 0;
  }
  assertObjectEquals({b: 1, c: 2}, goog.structs.filter(col, f, THIS_OBJ));
}

function testFilterSet() {
  var col = new goog.structs.Set([0, 1, 2]);
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('undefined', typeof key);
    return v > 0;
  }
  assertArrayEquals([1, 2], goog.structs.filter(col, f));
}

function testFilterSet2() {
  var THIS_OBJ = {};
  var col = new goog.structs.Set([0, 1, 2]);
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('undefined', typeof key);
    assertEquals(THIS_OBJ, this);
    return v > 0;
  }
  assertArrayEquals([1, 2], goog.structs.filter(col, f, THIS_OBJ));
}

function testFilterNodeList() {
  var col = getAll();
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    return v.tagName == 'P';
  }
  assertEquals('p,p,p,p,p,p,p,p',
               nodeNames(goog.structs.filter(col, f)));
}

function testFilterNodeList2() {
  var THIS_OBJ = {};
  var col = getAll();
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    assertEquals(THIS_OBJ, this);
    return v.tagName == 'P';
  }
  assertEquals('p,p,p,p,p,p,p,p',
               nodeNames(goog.structs.filter(col, f, THIS_OBJ)));
}

// Some

function testSome() {
  var RV = {};
  var obj = {
    some: function(g) {
      assertEquals(f, g);
      assertEquals(this, obj);
      return RV;
    }
  };
  function f() {}
  assertEquals(RV, goog.structs.some(obj, f));
}

function testSome2() {
  var THIS_OBJ = {};
  var RV = {};
  var obj = {
    some: function(g, obj2) {
      assertEquals(f, g);
      assertEquals(this, obj);
      assertEquals(THIS_OBJ, obj2);
      return RV;
    }
  };
  function f() {}
  assertEquals(RV, goog.structs.some(obj, f, THIS_OBJ));
}

function testSomeArrayLike() {
  var limit = 0;
  var col = [0, 1, 2];
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    return v > limit;
  }
  assertTrue(goog.structs.some(col, f));
  limit = 2;
  assertFalse(goog.structs.some(col, f));
}

function testSomeArrayLike2() {
  var THIS_OBJ = {};
  var limit = 0;
  var col = [0, 1, 2];
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    assertEquals(THIS_OBJ, this);
    return v > limit;
  }
  assertTrue(goog.structs.some(col, f, THIS_OBJ));
  limit = 2;
  assertFalse(goog.structs.some(col, f, THIS_OBJ));
}

function testSomeString() {
  var limit = 0;
  var col = '012';
  function f(v, i, col2) {
    // for some reason the strings are equal but identical???
    assertEquals(String(col), String(col2));
    assertEquals('number', typeof i);
    return Number(v) > limit;
  }
  assertTrue(goog.structs.some(col, f));
  limit = 2;
  assertFalse(goog.structs.some(col, f));
}

function testSomeString2() {
  var THIS_OBJ = {};
  var limit = 0;
  var col = '012';
  function f(v, i, col2) {
    // for some reason the strings are equal but identical???
    assertEquals(String(col), String(col2));
    assertEquals('number', typeof i);
    assertEquals(THIS_OBJ, this);
    return Number(v) > limit;
  }
  assertTrue(goog.structs.some(col, f, THIS_OBJ));
  limit = 2;
  assertFalse(goog.structs.some(col, f, THIS_OBJ));
}

function testSomeMap() {
  var limit = 0;
  var col = new goog.structs.Map({a: 0, b: 1, c: 2});
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('string', typeof key);
    return v > limit;
  }
  assertObjectEquals(true, goog.structs.some(col, f));
  limit = 2;
  assertFalse(goog.structs.some(col, f));
}

function testSomeMap2() {
  var THIS_OBJ = {};
  var limit = 0;
  var col = new goog.structs.Map({a: 0, b: 1, c: 2});
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('string', typeof key);
    assertEquals(THIS_OBJ, this);
    return v > limit;
  }
  assertObjectEquals(true, goog.structs.some(col, f, THIS_OBJ));
  limit = 2;
  assertFalse(goog.structs.some(col, f, THIS_OBJ));
}

function testSomeSet() {
  var limit = 0;
  var col = new goog.structs.Set([0, 1, 2]);
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('undefined', typeof key);
    return v > limit;
  }
  assertTrue(goog.structs.some(col, f));
  limit = 2;
  assertFalse(goog.structs.some(col, f));
}

function testSomeSet2() {
  var THIS_OBJ = {};
  var limit = 0;
  var col = new goog.structs.Set([0, 1, 2]);
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('undefined', typeof key);
    assertEquals(THIS_OBJ, this);
    return v > limit;
  }
  assertTrue(goog.structs.some(col, f, THIS_OBJ));
  limit = 2;
  assertFalse(goog.structs.some(col, f, THIS_OBJ));
}

function testSomeNodeList() {
  var tagName = 'P';
  var col = getAll();
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    return v.tagName == tagName;
  }
  assertTrue(goog.structs.some(col, f));
  tagName = 'MARQUEE';
  assertFalse(goog.structs.some(col, f));
}

function testSomeNodeList2() {
  var THIS_OBJ = {};
  var tagName = 'P';
  var col = getAll();
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    assertEquals(THIS_OBJ, this);
    return v.tagName == tagName;
  }
  assertTrue(goog.structs.some(col, f, THIS_OBJ));
  tagName = 'MARQUEE';
  assertFalse(goog.structs.some(col, f, THIS_OBJ));
}

// Every

function testEvery() {
  var RV = {};
  var obj = {
    every: function(g) {
      assertEquals(f, g);
      assertEquals(this, obj);
      return RV;
    }
  };
  function f() {}
  assertEquals(RV, goog.structs.every(obj, f));
}

function testEvery2() {
  var THIS_OBJ = {};
  var RV = {};
  var obj = {
    every: function(g, obj2) {
      assertEquals(f, g);
      assertEquals(this, obj);
      assertEquals(THIS_OBJ, obj2);
      return RV;
    }
  };
  function f() {}
  assertEquals(RV, goog.structs.every(obj, f, THIS_OBJ));
}

function testEveryArrayLike() {
  var limit = -1;
  var col = [0, 1, 2];
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    return v > limit;
  }
  assertTrue(goog.structs.every(col, f));
  limit = 1;
  assertFalse(goog.structs.every(col, f));
}

function testEveryArrayLike2() {
  var THIS_OBJ = {};
  var limit = -1;
  var col = [0, 1, 2];
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    assertEquals(THIS_OBJ, this);
    return v > limit;
  }
  assertTrue(goog.structs.every(col, f, THIS_OBJ));
  limit = 1;
  assertFalse(goog.structs.every(col, f, THIS_OBJ));
}

function testEveryString() {
  var limit = -1;
  var col = '012';
  function f(v, i, col2) {
    // for some reason the strings are equal but identical???
    assertEquals(String(col), String(col2));
    assertEquals('number', typeof i);
    return Number(v) > limit;
  }
  assertTrue(goog.structs.every(col, f));
  limit = 1;
  assertFalse(goog.structs.every(col, f));
}

function testEveryString2() {
  var THIS_OBJ = {};
  var limit = -1;
  var col = '012';
  function f(v, i, col2) {
    // for some reason the strings are equal but identical???
    assertEquals(String(col), String(col2));
    assertEquals('number', typeof i);
    assertEquals(THIS_OBJ, this);
    return Number(v) > limit;
  }
  assertTrue(goog.structs.every(col, f, THIS_OBJ));
  limit = 1;
  assertFalse(goog.structs.every(col, f, THIS_OBJ));
}

function testEveryMap() {
  var limit = -1;
  var col = new goog.structs.Map({a: 0, b: 1, c: 2});
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('string', typeof key);
    return v > limit;
  }
  assertObjectEquals(true, goog.structs.every(col, f));
  limit = 1;
  assertFalse(goog.structs.every(col, f));
}

function testEveryMap2() {
  var THIS_OBJ = {};
  var limit = -1;
  var col = new goog.structs.Map({a: 0, b: 1, c: 2});
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('string', typeof key);
    assertEquals(THIS_OBJ, this);
    return v > limit;
  }
  assertObjectEquals(true, goog.structs.every(col, f, THIS_OBJ));
  limit = 1;
  assertFalse(goog.structs.every(col, f, THIS_OBJ));
}

function testEverySet() {
  var limit = -1;
  var col = new goog.structs.Set([0, 1, 2]);
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('undefined', typeof key);
    return v > limit;
  }
  assertTrue(goog.structs.every(col, f));
  limit = 1;
  assertFalse(goog.structs.every(col, f));
}

function testEverySet2() {
  var THIS_OBJ = {};
  var limit = -1;
  var col = new goog.structs.Set([0, 1, 2]);
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('undefined', typeof key);
    assertEquals(THIS_OBJ, this);
    return v > limit;
  }
  assertTrue(goog.structs.every(col, f, THIS_OBJ));
  limit = 1;
  assertFalse(goog.structs.every(col, f, THIS_OBJ));
}

function testEveryNodeList() {
  var nodeType = 1; // ELEMENT
  var col = getAll();
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    return v.nodeType == nodeType;
  }
  assertTrue(goog.structs.every(col, f));
  nodeType = 3; // TEXT
  assertFalse(goog.structs.every(col, f));
}

function testEveryNodeList2() {
  var THIS_OBJ = {};
  var nodeType = 1; // ELEMENT
  var col = getAll();
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    assertEquals(THIS_OBJ, this);
    return v.nodeType == nodeType;
  }
  assertTrue(goog.structs.every(col, f, THIS_OBJ));
  nodeType = 3; // TEXT
  assertFalse(goog.structs.every(col, f, THIS_OBJ));
}

// For each

function testForEach() {
  var called = false;
  var obj = {
    forEach: function(g) {
      assertEquals(f, g);
      assertEquals(this, obj);
      called = true;
    }
  };
  function f() {}
  goog.structs.forEach(obj, f);
  assertTrue(called);
}

function testForEach2() {
  var called = false;
  var THIS_OBJ = {};
  var obj = {
    forEach: function(g, obj2) {
      assertEquals(f, g);
      assertEquals(this, obj);
      assertEquals(THIS_OBJ, obj2);
      called = true;
    }
  };
  function f() {}
  goog.structs.forEach(obj, f, THIS_OBJ);
  assertTrue(called);
}

function testForEachArrayLike() {
  var col = [0, 1, 2];
  var values = [];
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    values.push(v * v);
  }
  goog.structs.forEach(col, f)
  assertArrayEquals([0, 1, 4], values);
}

function testForEachArrayLike2() {
  var THIS_OBJ = {};
  var col = [0, 1, 2];
  var values = [];
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    assertEquals(THIS_OBJ, this);
    values.push(v * v);
  }
  goog.structs.forEach(col, f, THIS_OBJ);
  assertArrayEquals([0, 1, 4], values);
}

function testForEachString() {
  var col = '012';
  var values = [];
  function f(v, i, col2) {
    // for some reason the strings are equal but identical???
    assertEquals(String(col), String(col2));
    assertEquals('number', typeof i);
    values.push(Number(v) * Number(v));
  }
  goog.structs.forEach(col, f);
  assertArrayEquals([0, 1, 4], values);
}

function testForEachString2() {
  var THIS_OBJ = {};
  var col = '012';
  var values = [];
  function f(v, i, col2) {
    // for some reason the strings are equal but identical???
    assertEquals(String(col), String(col2));
    assertEquals('number', typeof i);
    assertEquals(THIS_OBJ, this);
    values.push(Number(v) * Number(v));
  }
  goog.structs.forEach(col, f, THIS_OBJ);
  assertArrayEquals([0, 1, 4], values);
}

function testForEachMap() {
  var col = new goog.structs.Map({a: 0, b: 1, c: 2});
  var values = [];
  var keys = [];
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('string', typeof key);
    values.push(v * v);
    keys.push(key);
  }
  goog.structs.forEach(col, f);
  assertArrayEquals([0, 1, 4], values);
  assertArrayEquals(['a', 'b', 'c'], keys);
}

function testForEachMap2() {
  var THIS_OBJ = {};
  var col = new goog.structs.Map({a: 0, b: 1, c: 2});
  var values = [];
  var keys = [];
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('string', typeof key);
    assertEquals(THIS_OBJ, this);
    values.push(v * v);
    keys.push(key);
  }
  goog.structs.forEach(col, f, THIS_OBJ);
  assertArrayEquals([0, 1, 4], values);
  assertArrayEquals(['a', 'b', 'c'], keys);
}

function testForEachSet() {
  var col = new goog.structs.Set([0, 1, 2]);
  var values = [];
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('undefined', typeof key);
    values.push(v * v);
  }
  goog.structs.forEach(col, f);
  assertArrayEquals([0, 1, 4], values);
}

function testForEachSet2() {
  var THIS_OBJ = {};
  var col = new goog.structs.Set([0, 1, 2]);
  var values = [];
  function f(v, key, col2) {
    assertEquals(col, col2);
    assertEquals('undefined', typeof key);
    assertEquals(THIS_OBJ, this);
    values.push(v * v);
  }
  goog.structs.forEach(col, f, THIS_OBJ);
  assertArrayEquals([0, 1, 4], values);
}

function testForEachNodeList() {
  var values = [];
  var col = getAll();
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    values.push(v.tagName);
  }
  goog.structs.forEach(col, f);
  assertEquals('HRPPPPPPPPH1', values.join(''));
}

function testForEachNodeList2() {
  var THIS_OBJ = {};
  var values = [];
  var col = getAll();
  function f(v, i, col2) {
    assertEquals(col, col2);
    assertEquals('number', typeof i);
    assertEquals(THIS_OBJ, this);
    values.push(v.tagName);
  }
  goog.structs.forEach(col, f, THIS_OBJ);
  assertEquals('HRPPPPPPPPH1', values.join(''));
}

">65 of 65 tests run in 28ms.<br />51 passed, 14 failed.<br />0 ms/test. 1 files loaded.<br />ERROR in testContains<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testEveryNodeList<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testEveryNodeList2<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testFilterNodeList<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testFilterNodeList2<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testForEachNodeList<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testForEachNodeList2<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testGetCount<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testGetKeys<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testGetValues<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testMapNodeList<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testMapNodeList2<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testSomeNodeList<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testSomeNodeList2<br />Object #<Object> has no method 'getElementsByTagName'<br /></td></tr>
<tr><td>prioritypool_test.html</td><td>Success</td><td> 17 passed, 0 failed.</td><td title="

  goog.require('goog.structs');
  goog.require('goog.structs.PriorityPool');
  goog.require('goog.testing.jsunit');



// Implementation of the Pool class with isObjectDead() always returning TRUE,
// so that the the Pool will not reuse any objects.
function NoObjectReusePriorityPool(opt_min, opt_max) {
  goog.structs.PriorityPool.call(this, opt_min, opt_max);
};
goog.inherits(NoObjectReusePriorityPool, goog.structs.PriorityPool);

NoObjectReusePriorityPool.prototype.objectCanBeReused = function(obj) {
  return false;
};


function testExceedMax1() {
  var p = new goog.structs.PriorityPool(0, 3);

  var getCount1 = 0;
  var callback1 = function(obj) {
    assertNotNull(obj);
    getCount1++;
  };

  var getCount2 = 0;
  var callback2 = function(obj) {
    getCount2++;
  };

  p.getObject(callback1);
  p.getObject(callback1);
  p.getObject(callback1);
  p.getObject(callback2);
  p.getObject(callback2);
  p.getObject(callback2);

  assertEquals('getCount for allocated, Should be 3', getCount1, 3);
  assertEquals('getCount for unallocated, Should be 0', getCount2, 0);
}


function testExceedMax2() {
  var p = new goog.structs.PriorityPool(0, 1);

  var getCount1 = 0;
  var callback1 = function(obj) {
    assertNotNull(obj);
    getCount1++;
  };

  var getCount2 = 0;
  var callback2 = function(obj) {
    getCount2++;
  };

  p.getObject(callback1);
  p.getObject(callback2);
  p.getObject(callback2);
  p.getObject(callback2);
  p.getObject(callback2);
  p.getObject(callback2);

  assertEquals('getCount for allocated, Should be 1', getCount1, 1);
  assertEquals('getCount for unallocated, Should be 0', getCount2, 0);
}

function testExceedMax3() {
  var p = new goog.structs.PriorityPool(0, 2);

  var obj1 = null;
  var callback1 = function(obj) {
    obj1 = obj;
  };

  var obj2 = null;
  var callback2 = function(obj) {
    obj2 = obj;
  };

  var obj3 = null;
  var callback3 = function(obj) {
    obj3 = obj;
  };

  p.getObject(callback1);
  p.getObject(callback2);
  p.getObject(callback3);

  assertNotNull(obj1);
  assertNotNull(obj2);
  assertNull(obj3);
}

function testExceedMax4() {
  var p = new goog.structs.PriorityPool(); // default: 10
  var objs = [];

  var getCount1 = 0;
  var callback1 = function(obj) {
    assertNotNull(obj);
    getCount1++;
  };

  var getCount2 = 0;
  var callback2 = function(obj) {
    getCount2++;
  };

  for (var i = 0; i < 12; i++) {
    p.getObject(i < 10 ? callback1 : callback2);
  }

  assertEquals('getCount for allocated, Should be 10', getCount1, 10);
  assertEquals('getCount for unallocated, Should be 0', getCount2, 0);
}


function testReleaseAndGet1() {
  var p = new goog.structs.PriorityPool(0, 10);

  var o = null;
  var callback = function(obj) {
    o = obj;
  };

  p.getObject(callback);
  assertEquals(1, p.getCount());
  assertEquals(1, p.getInUseCount());
  assertEquals(0, p.getFreeCount());
  assertTrue('Result should be true', p.releaseObject(o));
  assertEquals(1, p.getCount());
  assertEquals(0, p.getInUseCount());
  assertEquals(1, p.getFreeCount());
}


function testReleaseAndGet2() {
  var p = new NoObjectReusePriorityPool(0, 10);

  var o = null;
  var callback = function(obj) {
    o = obj;
  };

  p.getObject(callback);
  assertEquals(1, p.getCount());
  assertEquals(1, p.getInUseCount());
  assertEquals(0, p.getFreeCount());
  assertTrue('Result should be true', p.releaseObject(o));
  assertEquals(0, p.getCount());
  assertEquals(0, p.getInUseCount());
  assertEquals(0, p.getFreeCount());
}


function testReleaseAndGet3() {
  var p = new goog.structs.PriorityPool(0, 10);
  var o1 = null;
  var callback1 = function(obj) {
    o1 = obj;
  };

  var o2 = null;
  var callback2 = function(obj) {
    o2 = obj;
  };

  var o3 = null;
  var callback3 = function(obj) {
    o3 = obj;
  };

  var o4 = {};

  p.getObject(callback1);
  p.getObject(callback2);
  p.getObject(callback3);

  assertEquals(3, p.getCount());
  assertEquals(3, p.getInUseCount());
  assertEquals(0, p.getFreeCount());
  assertTrue('Result should be true', p.releaseObject(o1));
  assertTrue('Result should be true', p.releaseObject(o2));
  assertFalse('Result should be false', p.releaseObject(o4));
  assertEquals(3, p.getCount());
  assertEquals(1, p.getInUseCount());
  assertEquals(2, p.getFreeCount());
}


function testReleaseAndGet4() {
  var p = new NoObjectReusePriorityPool(0, 10);

  var o1 = null;
  var callback1 = function(obj) {
    o1 = obj;
  };

  var o2 = null;
  var callback2 = function(obj) {
    o2 = obj;
  };

  var o3 = null;
  var callback3 = function(obj) {
    o3 = obj;
  };

  var o4 = {};

  p.getObject(callback1);
  p.getObject(callback2);
  p.getObject(callback3);
  assertEquals(3, p.getCount());
  assertEquals(3, p.getInUseCount());
  assertEquals(0, p.getFreeCount());
  assertTrue('Result should be true', p.releaseObject(o1));
  assertTrue('Result should be true', p.releaseObject(o2));
  assertFalse('Result should be false', p.releaseObject(o4));
  assertEquals(1, p.getCount());
  assertEquals(1, p.getInUseCount());
  assertEquals(0, p.getFreeCount());
}


function testIsInPool1() {
  var p = new goog.structs.PriorityPool();
  var o1 = null;
  var callback1 = function(obj) {
    o1 = obj;
  };

  var o2 = null;
  var callback2 = function(obj) {
    o2 = obj;
  };

  var o3 = null;
  var callback3 = function(obj) {
    o3 = obj;
  };

  var o4 = {};
  var o5 = {};

  p.getObject(callback1);
  p.getObject(callback2);
  p.getObject(callback3);
  var o6 = o1;

  assertTrue(p.contains(o1));
  assertTrue(p.contains(o2));
  assertTrue(p.contains(o3));
  assertFalse(p.contains(o4));
  assertFalse(p.contains(o5));
  assertTrue(p.contains(o6));
}


function testSetMin1() {
  var p = new goog.structs.PriorityPool(0, 10);

  assertEquals(0, p.getCount());
  assertEquals(0, p.getInUseCount());
  assertEquals(0, p.getFreeCount());

  p.setMinimumCount(10);

  assertEquals(10, p.getCount());
  assertEquals(0, p.getInUseCount());
  assertEquals(10, p.getFreeCount());
}


function testSetMin2() {
  var p = new goog.structs.PriorityPool(0, 10);

  assertEquals(0, p.getCount());
  assertEquals(0, p.getInUseCount());
  assertEquals(0, p.getFreeCount());

  var o1 = null;
  var callback1 = function(obj) {
    o1 = obj;
  };
  p.getObject(callback1);

  assertEquals(1, p.getCount());
  assertEquals(1, p.getInUseCount());
  assertEquals(0, p.getFreeCount());

  p.setMinimumCount(10);

  assertEquals(10, p.getCount());
  assertEquals(1, p.getInUseCount());
  assertEquals(9, p.getFreeCount());
}


function testSetMax1() {
  var p = new goog.structs.PriorityPool(0, 10);

  assertEquals(0, p.getCount());
  assertEquals(0, p.getInUseCount());
  assertEquals(0, p.getFreeCount());

  var o1 = null;
  var callback1 = function(obj) {
    o1 = obj;
  };

  var o2 = null;
  var callback2 = function(obj) {
    o2 = obj;
  };

  var o3 = null;
  var callback3 = function(obj) {
    o3 = obj;
  };

  var o4 = null;
  var callback4 = function(obj) {
    o4 = obj;
  };

  var o5 = null;
  var callback5 = function(obj) {
    o5 = obj;
  };

  p.getObject(callback1);
  p.getObject(callback2);
  p.getObject(callback3);
  p.getObject(callback4);
  p.getObject(callback5);

  assertEquals(5, p.getCount());
  assertEquals(5, p.getInUseCount());
  assertEquals(0, p.getFreeCount());

  assertTrue('Result should be true', p.releaseObject(o5));

  assertEquals(5, p.getCount());
  assertEquals(4, p.getInUseCount());
  assertEquals(1, p.getFreeCount());

  p.setMaximumCount(4);

  assertEquals(4, p.getCount());
  assertEquals(4, p.getInUseCount());
  assertEquals(0, p.getFreeCount());
}


function testInvalidMinMax1() {
  var p = new goog.structs.PriorityPool(0, 10);

  assertEquals(0, p.getCount());
  assertEquals(0, p.getInUseCount());
  assertEquals(0, p.getFreeCount());

  assertThrows(function() {
    p.setMinimumCount(11);
  });
}


function testInvalidMinMax2() {
  var p = new goog.structs.PriorityPool(5, 10);

  assertEquals(5, p.getCount());
  assertEquals(0, p.getInUseCount());
  assertEquals(5, p.getFreeCount());

  assertThrows(function() {
    p.setMaximumCount(4);
  });
}


function testInvalidMinMax3() {
  assertThrows(function() {
    new goog.structs.PriorityPool(10, 1);
  });
}

function testQueue1() {
  var p = new goog.structs.PriorityPool(0, 2);

  var o1 = null;
  var callback1 = function(obj) {
    o1 = obj;
  };

  var o2 = null;
  var callback2 = function(obj) {
    o2 = obj;
  };

  var o3 = null;
  var callback3 = function(obj) {
    o3 = obj;
  };

  p.getObject(callback1);
  p.getObject(callback2);
  p.getObject(callback3);

  assertNotNull(o1);
  assertNotNull(o2);
  assertNull(o3);

  p.releaseObject(o1);
  assertNotNull(o3);
}


function testPriority1() {
  var p = new goog.structs.PriorityPool(0, 2);

  var o1 = null;
  var callback1 = function(obj) {
    o1 = obj;
  };

  var o2 = null;
  var callback2 = function(obj) {
    o2 = obj;
  };

  var o3 = null;
  var callback3 = function(obj) {
    o3 = obj;
  };

  var o4 = null;
  var callback4 = function(obj) {
    o4 = obj;
  };

  p.getObject(callback1);
  p.getObject(callback2);
  p.getObject(callback3, 10);
  p.getObject(callback4, 5);

  assertNotNull(o1);
  assertNotNull(o2);
  assertNull(o3);
  assertNull(o4);

  p.releaseObject(o1);
  assertNull(o3);
  assertNotNull(o4);
}


">n/a</td></tr>
<tr><td>stringset_test.html</td><td>Success</td><td> 23 passed, 0 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.iter');
  goog.require('goog.structs.StringSet');
  goog.require('goog.testing.asserts');
  goog.require('goog.testing.jsunit');



// Test how overwritten object prototype affects StringSet.
Object.prototype.evil1 = null;
Object.prototype.evil2 = null;

var TEST_VALUES = [
  '', ' ', '  ', 'true', 'null', 'undefined', '0', 'new', 'constructor',
  'prototype', '__proto__', 'set', 'hasOwnProperty', 'toString', 'valueOf',
  'evil1'
];

var TEST_VALUES_WITH_DUPLICATES = [
  '', '', ' ', '  ', 'true', true, 'null', null, 'undefined', undefined, '0', 0,
  'new', 'constructor', 'prototype', '__proto__', 'set', 'hasOwnProperty',
  'toString', 'valueOf', 'evil1'
];

function testConstructor() {
  var empty = new goog.structs.StringSet;
  assertSameElements('elements in empty set', [], empty.getValues());

  var s = new goog.structs.StringSet(TEST_VALUES_WITH_DUPLICATES);
  assertSameElements('duplicates are filtered out by their string value',
      TEST_VALUES, s.getValues());
}

function testAdd() {
  var s = new goog.structs.StringSet;
  goog.array.forEach(TEST_VALUES_WITH_DUPLICATES, s.add, s);
  assertSameElements(TEST_VALUES, s.getValues());
}

function testAddArray() {
  var s = new goog.structs.StringSet;
  s.addArray(TEST_VALUES_WITH_DUPLICATES);
  assertSameElements('added elements from array', TEST_VALUES, s.getValues());
}

function testAddSet() {
  var s = new goog.structs.StringSet;
  s.addSet(new goog.structs.StringSet([1, 2]));
  assertSameElements('empty set + {1, 2}', ['1', '2'], s.getValues());
  s.addSet(new goog.structs.StringSet([2, 3]));
  assertSameElements('{1, 2} + {2, 3}', ['1', '2', '3'], s.getValues());
}

function testClear() {
  var s = new goog.structs.StringSet([1, 2]);
  s.clear();
  assertSameElements('cleared set', [], s.getValues());
}

function testClone() {
  var s = new goog.structs.StringSet([1, 2]);
  var c = s.clone();
  assertSameElements('elements in clone', ['1', '2'], c.getValues());
  s.add(3);
  assertSameElements('changing the original set does not affect the clone',
      ['1', '2'], c.getValues());
}

function testContains() {
  var e = new goog.structs.StringSet;
  goog.array.forEach(TEST_VALUES, function(element) {
    assertFalse('empty set does not contain ' + element, e.contains(element));
  });

  var s = new goog.structs.StringSet(TEST_VALUES);
  goog.array.forEach(TEST_VALUES_WITH_DUPLICATES, function(element) {
    assertTrue('s contains ' + element, s.contains(element));
  });
  assertFalse('s does not contain 42', s.contains(42));

  Object.prototype[' a'] = 'a';
  Object.prototype['  a'] = 'a';
  assertFalse('empty set does not contain elements defined in Object.prototype',
      new goog.structs.StringSet().contains(' a'));
}

function testContainsArray() {
  var s = new goog.structs.StringSet(TEST_VALUES);
  assertTrue('set contains empty array', s.containsArray([]));
  assertTrue('set contains all elements of itself with some duplication',
      s.containsArray(TEST_VALUES_WITH_DUPLICATES));
  assertFalse('set does not contain 42', s.containsArray([42]));
}

function testEquals() {
  var s = new goog.structs.StringSet([1, 2]);
  assertTrue('set equals to itself', s.equals(s));
  assertTrue('set equals to its clone', s.equals(s.clone()));
  assertFalse('set does not equal to its subset',
      s.equals(new goog.structs.StringSet([1])));
  assertFalse('set does not equal to its superset',
      s.equals(new goog.structs.StringSet([1, 2, 3])));
}

function testForEach() {
  var s = new goog.structs.StringSet(TEST_VALUES);
  var values = [];
  var context = {};
  s.forEach(function(value, key, stringSet) {
    assertEquals('context of forEach callback', context, this);
    values.push(value);
    assertUndefined('key argument of forEach callback', key);
    assertEquals('set argument of forEach callback', s, stringSet);
  }, context);
  assertSameElements('values passed to forEach callback', TEST_VALUES, values);
}

function testGetCount() {
  var empty = new goog.structs.StringSet;
  assertEquals('count(empty set)', 0, empty.getCount());

  var s = new goog.structs.StringSet(TEST_VALUES);
  assertEquals('count(non-empty set)', TEST_VALUES.length, s.getCount());
}

function testGetDifference() {
  var s1 = new goog.structs.StringSet([1, 2]);
  var s2 = new goog.structs.StringSet([2, 3]);
  assertSameElements('{1, 2} - {2, 3}', ['1'],
      s1.getDifference(s2).getValues());
}

function testGetIntersection() {
  var s1 = new goog.structs.StringSet([1, 2]);
  var s2 = new goog.structs.StringSet([2, 3]);
  assertSameElements('{1, 2} * {2, 3}', ['2'],
      s1.getIntersection(s2).getValues());
}

function testGetSymmetricDifference() {
  var s1 = new goog.structs.StringSet([1, 2]);
  var s2 = new goog.structs.StringSet([2, 3]);
  assertSameElements('{1, 2} sym.diff. {2, 3}', ['1', '3'],
      s1.getSymmetricDifference(s2).getValues());
}

function testGetUnion() {
  var s1 = new goog.structs.StringSet([1, 2]);
  var s2 = new goog.structs.StringSet([2, 3]);
  assertSameElements('{1, 2} + {2, 3}', ['1', '2', '3'],
      s1.getUnion(s2).getValues());
}

function testIsDisjoint() {
  var s = new goog.structs.StringSet;
  var s12 = new goog.structs.StringSet([1, 2]);
  var s23 = new goog.structs.StringSet([2, 3]);
  var s34 = new goog.structs.StringSet([3, 4]);

  assertTrue('{} and {1, 2} are disjoint', s.isDisjoint(s12));
  assertTrue('{1, 2} and {3, 4} are disjoint', s12.isDisjoint(s34));
  assertFalse('{1, 2} and {2, 3} are not disjoint', s12.isDisjoint(s23));
}

function testIsEmpty() {
  assertTrue('empty set', new goog.structs.StringSet().isEmpty());
  assertFalse('non-empty set', new goog.structs.StringSet(['']).isEmpty());
}

function testIsSubsetOf() {
  var s1 = new goog.structs.StringSet([1]);
  var s12 = new goog.structs.StringSet([1, 2]);
  var s123 = new goog.structs.StringSet([1, 2, 3]);
  var s23 = new goog.structs.StringSet([2, 3]);

  assertTrue('{1, 2} is subset of {1, 2}', s12.isSubsetOf(s12));
  assertTrue('{1, 2} is subset of {1, 2, 3}', s12.isSubsetOf(s123));
  assertFalse('{1, 2} is not subset of {1}', s12.isSubsetOf(s1));
  assertFalse('{1, 2} is not subset of {2, 3}', s12.isSubsetOf(s23));
}

function testIsSupersetOf() {
  var s1 = new goog.structs.StringSet([1]);
  var s12 = new goog.structs.StringSet([1, 2]);
  var s123 = new goog.structs.StringSet([1, 2, 3]);
  var s23 = new goog.structs.StringSet([2, 3]);

  assertTrue('{1, 2} is superset of {1}', s12.isSupersetOf(s1));
  assertTrue('{1, 2} is superset of {1, 2}', s12.isSupersetOf(s12));
  assertFalse('{1, 2} is not superset of {1, 2, 3}', s12.isSupersetOf(s123));
  assertFalse('{1, 2} is not superset of {2, 3}', s12.isSupersetOf(s23));
}

function testRemove() {
  var n = new goog.structs.StringSet([1, 2]);
  assertFalse('3 not removed from {1, 2}', n.remove(3));
  assertSameElements('set == {1, 2}', ['1', '2'], n.getValues());
  assertTrue('2 removed from {1, 2}', n.remove(2));
  assertSameElements('set == {1}', ['1'], n.getValues());
  assertTrue('"1" removed from {1}', n.remove('1'));
  assertSameElements('set == {}', [], n.getValues());

  var s = new goog.structs.StringSet(TEST_VALUES);
  goog.array.forEach(TEST_VALUES, s.remove, s);
  assertSameElements('all special values have been removed', [], s.getValues());
}

function testRemoveArray() {
  var s = new goog.structs.StringSet(TEST_VALUES);
  s.removeArray(TEST_VALUES.slice(0, TEST_VALUES.length - 2));
  assertSameElements('removed elements from array',
      TEST_VALUES.slice(TEST_VALUES.length - 2), s.getValues());
}

function testRemoveSet() {
  var s1 = new goog.structs.StringSet([1, 2]);
  var s2 = new goog.structs.StringSet([2, 3]);
  s1.removeSet(s2);
  assertSameElements('{1, 2} - {2, 3}', ['1'], s1.getValues());
}

function testIterator() {
  var s = new goog.structs.StringSet(TEST_VALUES_WITH_DUPLICATES);
  var values = []
  goog.iter.forEach(s, function(value) {
    values.push(value);
  });
  assertSameElements('__iterator__ takes all elements once',
      TEST_VALUES, values);
}

">n/a</td></tr>
<tr><td>inversionmap_test.html</td><td>Success</td><td> 8 passed, 0 failed.</td><td title="

  goog.require('goog.structs.InversionMap');
  goog.require('goog.testing.jsunit');


  function testInversionWithDelta() {
    var alphabetNames = new goog.structs.InversionMap(
        [ 0, 97, 1, 1, 1, 20, 1, 1, 1 ],
        [ null,
          'LATIN SMALL LETTER A',
          'LATIN SMALL LETTER B',
          'LATIN SMALL LETTER C',
          null,
          'LATIN SMALL LETTER X',
          'LATIN SMALL LETTER Y',
          'LATIN SMALL LETTER Z',
          null ],
        true);

    assertEquals('LATIN SMALL LETTER A', alphabetNames.at(97));
    assertEquals('LATIN SMALL LETTER Y', alphabetNames.at(121));
    assertEquals(null, alphabetNames.at(140));
    assertEquals(null, alphabetNames.at(0));
  }

  function testInversionWithoutDelta() {
    var alphabetNames = new goog.structs.InversionMap(
        [ 0, 97, 98, 99, 100, 120, 121, 122, 123 ],
        [ null,
          'LATIN SMALL LETTER A',
          'LATIN SMALL LETTER B',
          'LATIN SMALL LETTER C',
          null,
          'LATIN SMALL LETTER X',
          'LATIN SMALL LETTER Y',
          'LATIN SMALL LETTER Z',
          null ],
        false);

    assertEquals('LATIN SMALL LETTER A', alphabetNames.at(97));
    assertEquals('LATIN SMALL LETTER Y', alphabetNames.at(121));
    assertEquals(null, alphabetNames.at(140));
    assertEquals(null, alphabetNames.at(0));
  }

  function testInversionWithoutDeltaNoOpt() {
    var alphabetNames = new goog.structs.InversionMap(
        [ 0, 97, 98, 99, 100, 120, 121, 122, 123 ],
        [ null,
          'LATIN SMALL LETTER A',
          'LATIN SMALL LETTER B',
          'LATIN SMALL LETTER C',
          null,
          'LATIN SMALL LETTER X',
          'LATIN SMALL LETTER Y',
          'LATIN SMALL LETTER Z',
          null ]);

    assertEquals('LATIN SMALL LETTER A', alphabetNames.at(97));
    assertEquals('LATIN SMALL LETTER Y', alphabetNames.at(121));
    assertEquals(null, alphabetNames.at(140));
    assertEquals(null, alphabetNames.at(0));
  }

  function testInversionMapSplice1() {
    var alphabetNames = newAsciiMap();
    alphabetNames.spliceInversion(
        [ 99, 105, 114 ], [ 'XXX', 'YYY', 'ZZZ' ]);
    assertEquals('LATIN SMALL LETTER B', alphabetNames.at(98));
    assertEquals('XXX', alphabetNames.at(100));
    assertEquals('ZZZ', alphabetNames.at(114));
    assertEquals('ZZZ', alphabetNames.at(119));
    assertEquals('LATIN SMALL LETTER X', alphabetNames.at(120));
  }

  function testInversionMapSplice2() {
    var alphabetNames = newAsciiMap();
    alphabetNames.spliceInversion(
        [ 105, 114, 121 ], [ 'XXX', 'YYY', 'ZZZ' ]);
    assertEquals(null, alphabetNames.at(104));
    assertEquals('XXX', alphabetNames.at(105));
    assertEquals('YYY', alphabetNames.at(120));
    assertEquals('ZZZ', alphabetNames.at(121));
    assertEquals('LATIN SMALL LETTER Z', alphabetNames.at(122));
  }

  function testInversionMapSplice3() {
    var alphabetNames = newAsciiMap();
    alphabetNames.spliceInversion(
        [ 98, 99 ], [ 'CHANGED LETTER B', 'CHANGED LETTER C' ]);
    assertEquals('LATIN SMALL LETTER A', alphabetNames.at(97));
    assertEquals('CHANGED LETTER B', alphabetNames.at(98));
    assertEquals('CHANGED LETTER C', alphabetNames.at(99));
    assertEquals('LATIN SMALL LETTER D', alphabetNames.at(100));
    assertEquals(null, alphabetNames.at(101));
  }

  function testInversionMapSplice4() {
    var alphabetNames = newAsciiMap();
    alphabetNames.spliceInversion(
        [ 98, 1 ], [ 'CHANGED LETTER B', 'CHANGED LETTER C' ],
        true /* delta mode */);
    assertEquals('LATIN SMALL LETTER A', alphabetNames.at(97));
    assertEquals('CHANGED LETTER B', alphabetNames.at(98));
    assertEquals('CHANGED LETTER C', alphabetNames.at(99));
    assertEquals('LATIN SMALL LETTER D', alphabetNames.at(100));
    assertEquals(null, alphabetNames.at(101));
  }

  function testInversionMapSplice5() {
    var map = new goog.structs.InversionMap(
        [0, 97, 98, 99],
        [null,
         'LATIN SMALL LETTER A',
         'LATIN SMALL LETTER B',
         'LATIN SMALL LETTER C']);
    map.spliceInversion(
        [98], ['CHANGED LETTER B']);
    assertEquals('LATIN SMALL LETTER A', map.at(97));
    assertEquals('CHANGED LETTER B', map.at(98));
    assertEquals('LATIN SMALL LETTER C', map.at(99));

    assertArrayEquals([0, 97, 98, 99], map.rangeArray);
  }

  function newAsciiMap() {
    return new goog.structs.InversionMap(
        [ 0, 97, 98, 99, 100, 101, 120, 121, 122, 123 ],
        [ null,
          'LATIN SMALL LETTER A',
          'LATIN SMALL LETTER B',
          'LATIN SMALL LETTER C',
          'LATIN SMALL LETTER D',
          null,
          'LATIN SMALL LETTER X',
          'LATIN SMALL LETTER Y',
          'LATIN SMALL LETTER Z',
          null ]);
  }

">n/a</td></tr>
<tr><td>map_test.html</td><td>Success</td><td> 28 passed, 0 failed.</td><td title="

  goog.require('goog.iter');
  goog.require('goog.structs');
  goog.require('goog.structs.Map');
  goog.require('goog.testing.jsunit');



function stringifyMap(m) {
  var keys = goog.structs.getKeys(m);
  var s = '';
  for (var i = 0; i < keys.length; i++) {
    s += keys[i] + m[keys[i]];
  }
  return s;
}

function getMap() {
  var m = new goog.structs.Map;
  m.set('a', 0);
  m.set('b', 1);
  m.set('c', 2);
  m.set('d', 3);
  return m;
}

function testGetCount() {
  var m = getMap();
  assertEquals('count, should be 4', m.getCount(), 4);
  m.remove('d');
  assertEquals('count, should be 3', m.getCount(), 3);
}

function testKeys() {
  var m = getMap();
  assertEquals('getKeys, The keys should be a,b,c', m.getKeys().join(','),
      'a,b,c,d');
}

function testValues() {
  var m = getMap();
  assertEquals('getValues, The values should be 0,1,2',
      m.getValues().join(','), '0,1,2,3');
}

function testContainsKey() {
  var m = getMap();
  assertTrue("containsKey, Should contain the 'a' key", m.containsKey('a'));
  assertFalse("containsKey, Should not contain the 'e' key",
      m.containsKey('e'));
}

function testClear() {
  var m = getMap();
  m.clear();
  assertTrue('cleared so it should be empty', m.isEmpty());
  assertTrue("cleared so it should not contain 'a' key", !m.containsKey('a'));
}

function testAddAll() {
  var m = new goog.structs.Map;
  m.addAll({a:0,b:1,c:2,d:3});
  assertTrue('addAll so it should not be empty', !m.isEmpty());
  assertTrue("addAll so it should contain 'c' key", m.containsKey('c'));

  var m2 = new goog.structs.Map;
  m2.addAll(m);
  assertTrue('addAll so it should not be empty', !m2.isEmpty());
  assertTrue("addAll so it should contain 'c' key", m2.containsKey('c'));
}

function testConstructor() {
  var m = getMap();
  var m2 = new goog.structs.Map(m);
  assertTrue('constr with Map so it should not be empty', !m2.isEmpty());
  assertTrue("constr with Map so it should contain 'c' key",
      m2.containsKey('c'));
}


function testConstructorWithVarArgs() {
  var m = new goog.structs.Map('a', 1);
  assertTrue('constr with var_args so it should not be empty', !m.isEmpty());
  assertEquals('constr with var_args', 1, m.get('a'));

  m = new goog.structs.Map('a', 1, 'b', 2);
  assertTrue('constr with var_args so it should not be empty', !m.isEmpty());
  assertEquals('constr with var_args', 1, m.get('a'));
  assertEquals('constr with var_args', 2, m.get('b'));

  assertThrows('Odd number of arguments is not allowed', function() {
    var m = new goog.structs.Map('a', 1, 'b');
  });
}

function testClone() {
  var m = getMap();
  var m2 = m.clone();
  assertTrue('clone so it should not be empty', !m2.isEmpty());
  assertTrue("clone so it should contain 'c' key", m2.containsKey('c'));
}


function testRemove() {
  var m = new goog.structs.Map();
  for (var i = 0; i < 1000; i++) {
    m.set(i, 'foo');
  }

  for (var i = 0; i < 1000; i++) {
    assertTrue(m.keys_.length <= 2 * m.getCount());
    m.remove(i);
 }
 assertTrue(m.isEmpty());
 assertEquals('', m.getKeys().join(''));
}


function testForEach() {
  var m = getMap();
  var s = '';
  goog.structs.forEach(m, function(val, key, m2) {
    assertNotUndefined(key);
    assertEquals(m, m2);
    s += key + val;
  });
  assertEquals(s, 'a0b1c2d3');
}

function testFilter() {
  var m = getMap();

  var m2 = goog.structs.filter(m, function (val, key, m3) {
    assertNotUndefined(key);
    assertEquals(m, m3);
    return val > 1;
  });
  assertEquals(stringifyMap(m2), 'c2d3');
}


function testMap() {
  var m = getMap();
  var m2 = goog.structs.map(m, function (val, key, m3) {
    assertNotUndefined(key);
    assertEquals(m, m3);
    return val * val;
  });
  assertEquals(stringifyMap(m2), 'a0b1c4d9');
}

function testSome() {
  var m = getMap();
  var b = goog.structs.some(m, function (val, key, m2) {
    assertNotUndefined(key);
    assertEquals(m, m2);
    return val > 1;
  });
  assertTrue(b);
  var b = goog.structs.some(m, function (val, key, m2) {
    assertNotUndefined(key);
    assertEquals(m, m2);
    return val > 100;
  });
  assertFalse(b);
}

function testEvery() {
  var m = getMap();
  var b = goog.structs.every(m, function (val, key, m2) {
    assertNotUndefined(key);
    assertEquals(m, m2);
    return val >= 0;
  });
  assertTrue(b);
  b = goog.structs.every(m, function (val, key, m2) {
    assertNotUndefined(key);
    assertEquals(m, m2);
    return val > 1;
  });
  assertFalse(b);
}

function testContainsValue() {
  var m = getMap();
  assertTrue(m.containsValue(3));
  assertFalse(m.containsValue(4));
}

function testObjectProperties() {
  var m = new goog.structs.Map;

  assertEquals(m.get('toString'), undefined);
  assertEquals(m.get('valueOf'), undefined);
  assertEquals(m.get('eval'), undefined);
  assertEquals(m.get('toSource'), undefined);
  assertEquals(m.get('prototype'), undefined);
  assertEquals(m.get(':foo'), undefined);

  m.set('toString', 'once');
  m.set('valueOf', 'upon');
  m.set('eval', 'a');
  m.set('toSource', 'midnight');
  m.set('prototype', 'dreary');
  m.set('hasOwnProperty', 'dark');
  m.set(':foo', 'happy');

  assertEquals(m.get('toString'), 'once');
  assertEquals(m.get('valueOf'), 'upon');
  assertEquals(m.get('eval'), 'a');
  assertEquals(m.get('toSource'), 'midnight');
  assertEquals(m.get('prototype'), 'dreary');
  assertEquals(m.get('hasOwnProperty'), 'dark');
  assertEquals(m.get(':foo'), 'happy');

  var keys = m.getKeys().join(',');
  assertEquals(keys,
      'toString,valueOf,eval,toSource,prototype,hasOwnProperty,:foo');

  var values = m.getValues().join(',');
  assertEquals(values, 'once,upon,a,midnight,dreary,dark,happy');
}

function testDuplicateKeys() {
  var m = new goog.structs.Map;

  m.set('a', 1);
  m.set('b', 2);
  m.set('c', 3);
  m.set('d', 4);
  m.set('e', 5);
  m.set('f', 6);
  assertEquals(6, m.getKeys().length);
  m.set('foo', 1);
  assertEquals(7, m.getKeys().length);
  m.remove('foo');
  assertEquals(6, m.getKeys().length);
  m.set('foo', 2);
  assertEquals(7, m.getKeys().length);
  m.remove('foo');
  m.set('foo', 3);
  m.remove('foo');
  m.set('foo', 4);
  assertEquals(7, m.getKeys().length);
}

function testGetKeyIterator() {
  var m = new goog.structs.Map;
  m.set('a', 1);
  m.set('b', 2);
  m.set('c', 3);
  m.set('d', 4);
  m.set('e', 5);

  var iter = m.getKeyIterator();
  assertEquals('Should contain the keys', 'abcde', goog.iter.join(iter, ''));

  m.remove('b');
  m.remove('d');
  iter = m.getKeyIterator();
  assertEquals('Should not contain the removed keys',
               'ace', goog.iter.join(iter, ''));
}

function testGetValueIterator() {
  var m = new goog.structs.Map;
  m.set('a', 1);
  m.set('b', 2);
  m.set('c', 3);
  m.set('d', 4);
  m.set('e', 5);

  var iter = m.getValueIterator();
  assertEquals('Should contain the values', '12345', goog.iter.join(iter, ''));

  m.remove('b');
  m.remove('d');
  iter = m.getValueIterator();
  assertEquals('Should not contain the removed keys',
               '135', goog.iter.join(iter, ''));
}

function testDefaultIterator() {
  // The default iterator should behave like the value iterator

  var m = new goog.structs.Map;
  m.set('a', 1);
  m.set('b', 2);
  m.set('c', 3);
  m.set('d', 4);
  m.set('e', 5);

  assertEquals('Should contain the values', '12345', goog.iter.join(m, ''));

  m.remove('b');
  m.remove('d');
  assertEquals('Should not contain the removed keys',
               '135', goog.iter.join(m, ''));
}

function testMutatedIterator() {
  var message = 'The map has changed since the iterator was created';

  var m = new goog.structs.Map;
  m.set('a', 1);
  m.set('b', 2);
  m.set('c', 3);
  m.set('d', 4);

  var iter = m.getValueIterator();
  m.set('e', 5);
  var ex = assertThrows('Expected an exception since the map has changed',
      function() {
        iter.next();
      });
  assertEquals(message, ex.message);

  m = new goog.structs.Map;
  m.set('a', 1);
  m.set('b', 2);
  m.set('c', 3);
  m.set('d', 4);

  iter = m.getValueIterator();
  m.remove('d');
  var ex = assertThrows('Expected an exception since the map has changed',
      function() {
        iter.next();
      });
  assertEquals(message, ex.message);

  m = new goog.structs.Map;
  m.set('a', 1);
  m.set('b', 2);
  m.set('c', 3);
  m.set('d', 4);

  iter = m.getValueIterator();
  m.set('d', 5);
  iter.next();
  // Changing an existing value is OK.
  iter.next();
};

function testTranspose() {
  var m = new goog.structs.Map;
  m.set('a', 1);
  m.set('b', 2);
  m.set('c', 3);
  m.set('d', 4);
  m.set('e', 5);

  var transposed = m.transpose();
  assertEquals('Should contain the keys', 'abcde',
      goog.iter.join(transposed, ''));
}

function testToObject() {
  Object.prototype.b = 0;
  try {
    var map = new goog.structs.Map();
    map.set('a', 0);
    var obj = map.toObject();
    assertTrue('object representation has key "a"', obj.hasOwnProperty('a'));
    assertFalse('object representation does not have key "b"',
        obj.hasOwnProperty('b'));
    assertEquals('value for key "a"', 0, obj['a']);
  } finally {
    delete Object.prototype.b;
  }
}

function testEqualsWithSameObject() {
  var map1 = getMap();
  assertTrue('maps are the same object', map1.equals(map1));
}

function testEqualsWithDifferentSizeMaps() {
  var map1 = getMap();
  var map2 = new goog.structs.Map();

  assertFalse('maps are different sizes', map1.equals(map2));
}

function testEqualsWithDefaultEqualityFn() {
  var map1 = new goog.structs.Map();
  var map2 = new goog.structs.Map();

  assertTrue('maps are both empty', map1.equals(map2));

  map1 = getMap();
  map2 = getMap();
  assertTrue('maps are the same', map1.equals(map2));

  map2.set('d', '3');
  assertFalse('maps have 3 and \'3\'', map1.equals(map2));
}

function testEqualsWithCustomEqualityFn() {
  var map1 = new goog.structs.Map();
  var map2 = new goog.structs.Map();

  map1.set('a', 0);
  map1.set('b', 1);

  map2.set('a', '0');
  map2.set('b', '1');

  var equalsFn = function(a, b) { return a == b };

  assertTrue('maps are equal with ==', map1.equals(map2, equalsFn));
}

">n/a</td></tr>
<tr><td>avltree_test.html</td><td>Success</td><td> 7 passed, 0 failed.</td><td title="

  goog.require('goog.structs');
  goog.require('goog.structs.AvlTree');
  goog.require('goog.testing.jsunit');



  /**
   * This test verifies that we can insert strings into the AvlTree and have 
   * them be stored and sorted correctly by the default comparator.
   */
  function testInsertsWithDefaultComparator() {
    var tree = new goog.structs.AvlTree();
    var values = ['bill', 'blake', 'elliot', 'jacob', 'john', 'myles', 'ted'];
    
    // Insert strings into tree out of order
    tree.add(values[4]);
    tree.add(values[3]);
    tree.add(values[0]);
    tree.add(values[6]);
    tree.add(values[5]);
    tree.add(values[1]);
    tree.add(values[2]);
    
    // Verify strings are stored in sorted order
    var i = 0;
    tree.inOrderTraverse(function(value) {
      assertEquals(values[i], value);
      i += 1;
    });
    assertEquals(i, values.length);
  };

  /**
   * This test verifies that we can insert strings into and remove strings from
   * the AvlTree and have the only the non-removed values be stored and sorted 
   * correctly by the default comparator.
   */
  function testRemovesWithDefaultComparator() {
    var tree = new goog.structs.AvlTree();
    var values = ['bill', 'blake', 'elliot', 'jacob', 'john', 'myles', 'ted'];
    
    // Insert strings into tree out of order
    tree.add('frodo');
    tree.add(values[4]);
    tree.add(values[3]);
    tree.add(values[0]);
    tree.add(values[6]);
    tree.add('samwise');        
    tree.add(values[5]);
    tree.add(values[1]);
    tree.add(values[2]);
    tree.add('pippin');
    
    // Remove strings from tree
    assertEquals(tree.remove('samwise'), 'samwise');
    assertEquals(tree.remove('pippin'), 'pippin');
    assertEquals(tree.remove('frodo'), 'frodo');
    assertEquals(tree.remove('merry'), null);
    
    
    // Verify strings are stored in sorted order
    var i = 0;
    tree.inOrderTraverse(function(value) {
      assertEquals(values[i], value);
      i += 1;
    });
    assertEquals(i, values.length);
  };

  /**
   * This test verifies that we can insert values into and remove values from 
   * the AvlTree and have them be stored and sorted correctly by a custom 
   * comparator.
   */
  function testInsertsAndRemovesWithCustomComparator() {
    var tree = new goog.structs.AvlTree(function(a, b) {
      return a - b;
    });
        
    var NUM_TO_INSERT = 37;
    var valuesToRemove = [1, 0, 6, 7, 36];
        
    // Insert ints into tree out of order
    var values = [];
    for (var i = 0; i < NUM_TO_INSERT; i += 1) {
      tree.add(i);
      values.push(i);
    }    
    
    for (var i = 0; i < valuesToRemove.length; i += 1) {
      assertEquals(tree.remove(valuesToRemove[i]), valuesToRemove[i]); 
      goog.array.remove(values, valuesToRemove[i]);
    }
    assertEquals(tree.remove(-1), null);
    assertEquals(tree.remove(37), null);
    
    // Verify strings are stored in sorted order
    var i = 0;
    tree.inOrderTraverse(function(value) {
      assertEquals(values[i], value);
      i += 1;
    });
    assertEquals(i, values.length);    
  };
  
  /**
   * This test verifies that we can insert values into and remove values from 
   * the AvlTree and have it maintain the AVL-Tree upperbound on its height.
   */
  function testAvlTreeHeight() {
    var tree = new goog.structs.AvlTree(function(a, b) {
      return a - b;
    });
        
    var NUM_TO_INSERT = 2000;
    var NUM_TO_REMOVE = 500;
        
    // Insert ints into tree out of order
    for (var i = 0; i < NUM_TO_INSERT; i += 1) {
      tree.add(i);
    }    
    
    // Remove valuse
    for (var i = 0; i < NUM_TO_REMOVE; i += 1) {
      tree.remove(i);
    }    
    
    assertTrue(tree.getHeight() <= 1.4405 * 
        (Math.log(NUM_TO_INSERT - NUM_TO_REMOVE + 2) / Math.log(2)) - 1.3277);    
  };  

  /**
   * This test verifies that we can insert values into and remove values from 
   * the AvlTree and have its contains method correctly determine the values it
   * is contains.
   */
  function testAvlTreeContains() {
    var tree = new goog.structs.AvlTree();    
    var values = ['bill', 'blake', 'elliot', 'jacob', 'john', 'myles', 'ted'];
    
    // Insert strings into tree out of order
    tree.add('frodo');
    tree.add(values[4]);
    tree.add(values[3]);
    tree.add(values[0]);
    tree.add(values[6]);
    tree.add('samwise');        
    tree.add(values[5]);
    tree.add(values[1]);
    tree.add(values[2]);
    tree.add('pippin');
    
    // Remove strings from tree
    assertEquals(tree.remove('samwise'), 'samwise');
    assertEquals(tree.remove('pippin'), 'pippin');
    assertEquals(tree.remove('frodo'), 'frodo');    
    
    for (var i = 0; i < values.length; i += 1) {
      assertTrue(tree.contains(values[i]));
    }
    assertFalse(tree.contains('samwise'));
    assertFalse(tree.contains('pippin'));
    assertFalse(tree.contains('frodo'));    
  };  
  
  /**
   * This test verifies that we can insert values into and remove values from 
   * the AvlTree and have its minValue and maxValue routines return the correct
   * min and max values contained by the tree.
   */
  function testMinAndMaxValues() {
    var tree = new goog.structs.AvlTree(function(a, b) {
      return a - b;
    });
        
    var NUM_TO_INSERT = 2000;
    var NUM_TO_REMOVE = 500;
        
    // Insert ints into tree out of order
    for (var i = 0; i < NUM_TO_INSERT; i += 1) {
      tree.add(i);
    }    
    
    // Remove valuse
    for (var i = 0; i < NUM_TO_REMOVE; i += 1) {
      tree.remove(i);
    }    
    
    assertEquals(tree.getMinimum(), NUM_TO_REMOVE);   
    assertEquals(tree.getMaximum(), NUM_TO_INSERT - 1);   
  };  

  /**
   * This test verifies that we can insert values into and remove values from 
   * the AvlTree and traverse the tree in reverse order using the 
   * reverseOrderTraverse routine.
   */
  function testReverseOrderTraverse() {
    var tree = new goog.structs.AvlTree(function(a, b) {
      return a - b;
    });
        
    var NUM_TO_INSERT = 2000;
    var NUM_TO_REMOVE = 500;
        
    // Insert ints into tree out of order
    for (var i = 0; i < NUM_TO_INSERT; i += 1) {
      tree.add(i);
    }    
    
    // Remove valuse
    for (var i = 0; i < NUM_TO_REMOVE; i += 1) {
      tree.remove(i);
    }    
    
    var i = NUM_TO_INSERT - 1;
    tree.reverseOrderTraverse(function(value) {
      assertEquals(value, i);
      i -= 1;
    });    
    assertEquals(i, NUM_TO_REMOVE - 1);
  };  

">n/a</td></tr>
<tr><td>textrangeiterator_test.html</td><td>Fail</td><td> 0 passed, 8 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.TagName');
  goog.require('goog.dom.TextRangeIterator');
  goog.require('goog.testing.dom');
  goog.require('goog.testing.jsunit');


  var test = goog.dom.getElement('test');
  var test2 = goog.dom.getElement('test2');

  function testBasic() {
    goog.testing.dom.assertNodesMatch(
        new goog.dom.TextRangeIterator(test, 0, test, 2),
        ['#a1', 'T', '#b1', 'e', '#b1', 'xt', '#a1', '#span1',
          '#span1', '#p1']);
  }

  function testAdjustStart() {
    var iterator = new goog.dom.TextRangeIterator(test, 0, test, 2);
    iterator.setStartNode(goog.dom.getElement('span1'));

    goog.testing.dom.assertNodesMatch(iterator,
        ['#span1', '#span1', '#p1']);
  }

  function testAdjustEnd() {
    var iterator = new goog.dom.TextRangeIterator(test, 0, test, 2);
    iterator.setEndNode(goog.dom.getElement('span1'));

    goog.testing.dom.assertNodesMatch(iterator,
        ['#a1', 'T', '#b1', 'e', '#b1', 'xt', '#a1', '#span1']);
  }

  function testOffsets() {
    var iterator = new goog.dom.TextRangeIterator(test2.firstChild, 1,
        test2.lastChild, 2);

    // foo
    var node = iterator.next();
    assertEquals('Should have start offset at iteration step 1', 1,
        iterator.getStartTextOffset());
    assertEquals('Should not have end offset at iteration step 1',
        node.nodeValue.length, iterator.getEndTextOffset());

    // <br>
    node = iterator.next();
    assertEquals('Should not have start offset at iteration step 2', -1,
        iterator.getStartTextOffset());
    assertEquals('Should not have end offset at iteration step 2', -1,
        iterator.getEndTextOffset());

    // </br>
    node = iterator.next();
    assertEquals('Should not have start offset at iteration step 3', -1,
        iterator.getStartTextOffset());
    assertEquals('Should not have end offset at iteration step 3', -1,
        iterator.getEndTextOffset());

    // bar
    node = iterator.next();
    assertEquals('Should not have start offset at iteration step 4', 0,
        iterator.getStartTextOffset());
    assertEquals('Should have end offset at iteration step 4', 2,
        iterator.getEndTextOffset());
  }

  function testSingleNodeOffsets() {
    var iterator = new goog.dom.TextRangeIterator(test2.firstChild, 1,
        test2.firstChild, 2);

    iterator.next();
    assertEquals('Should have start offset', 1, iterator.getStartTextOffset());
    assertEquals('Should have end offset', 2, iterator.getEndTextOffset());
  }

  function testEndNodeOffsetAtEnd() {
    var iterator = new goog.dom.TextRangeIterator(
        goog.dom.getElement('b1').firstChild, 0, goog.dom.getElement('b1'), 1);
    goog.testing.dom.assertNodesMatch(iterator, ['e', '#b1']);
  }

  function testSkipTagDoesNotSkipEnd() {
    // Iterate over 'Tex'.
    var iterator = new goog.dom.TextRangeIterator(
        test.firstChild.firstChild, 0,
        test.firstChild.lastChild, 1);

    var node = iterator.next();
    assertEquals('T', node.nodeValue);

    node = iterator.next();
    assertEquals(goog.dom.TagName.B, node.tagName);

    iterator.skipTag();

    node = iterator.next();
    assertEquals('xt', node.nodeValue);
  }

  function testSkipTagSkipsEnd() {
    // Iterate over 'Te'.
    var iterator = new goog.dom.TextRangeIterator(
        test.firstChild.firstChild, 0,
        test.getElementsByTagName(goog.dom.TagName.B)[0].firstChild, 1);

    var node = iterator.next();
    assertEquals('T', node.nodeValue);

    node = iterator.next();
    assertEquals(goog.dom.TagName.B, node.tagName);

    var ex = assertThrows('Should stop iteration when skipping B', function() {
      iterator.skipTag();
    });
    assertEquals(goog.iter.StopIteration, ex);
  }
">8 of 8 tests run in 9ms.<br />0 passed, 8 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testAdjustEnd<br />Expected element at position 0<br />Expected <1> (Number) but was <undefined><br />> assertEquals at testing/asserts.js:289:3<br />> anonymous at testing/dom.js:72:<br />> Object.forEach at iter/iter.js:164:11<br />> Object.assertNodesMatch at testing/dom.js:59:13<br />> testAdjustEnd at _tmpclosuretest.js:32:22<br />ERROR in testAdjustStart<br />Expected element at position 0<br />Expected <1> (Number) but was <undefined><br />> assertEquals at testing/asserts.js:289:3<br />> anonymous at testing/dom.js:72:<br />> Object.forEach at iter/iter.js:164:11<br />> Object.assertNodesMatch at testing/dom.js:59:13<br />> testAdjustStart at _tmpclosuretest.js:24:22<br />ERROR in testBasic<br />Expected element at position 0<br />Expected <1> (Number) but was <undefined><br />> assertEquals at testing/asserts.js:289:3<br />> anonymous at testing/dom.js:72:<br />> Object.forEach at iter/iter.js:164:11<br />> Object.assertNodesMatch at testing/dom.js:59:13<br />> testBasic at _tmpclosuretest.js:14:22<br />ERROR in testEndNodeOffsetAtEnd<br />Used entire match array<br />Expected <2> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> Object.assertNodesMatch at testing/dom.js:88:3<br />> testEndNodeOffsetAtEnd at _tmpclosuretest.js:81:22<br />ERROR in testOffsets<br />StopIteration<br />ERROR in testSingleNodeOffsets<br />StopIteration<br />ERROR in testSkipTagDoesNotSkipEnd<br />Cannot read property 'firstChild' of undefined<br />ERROR in testSkipTagSkipsEnd<br />Cannot read property 'firstChild' of undefined<br /></td></tr>
<tr><td>annotate_test.html</td><td>Fail</td><td> 4 passed, 7 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.annotate');
  goog.require('goog.testing.jsunit');

var variable;

  var $ = goog.dom.getElement;

  var TEXT = 'This little piggy cried "Wee! Wee! Wee!" all the way home.';

  function doAnnotation(termIndex, termHtml) {
    return '<span class="c' + termIndex + '">' + termHtml + '</span>';
  }

  // goog.dom.annotate.annotateText tests

  function testAnnotateText() {
    var terms = [['pig', true]];
    var html = goog.dom.annotate.annotateText(TEXT, terms, doAnnotation);
    assertEquals(null, html);

    terms = [['pig', false]];
    html = goog.dom.annotate.annotateText(TEXT, terms, doAnnotation);
    assertEquals('This little <span class="c0">pig</span>gy cried ' +
                 '&quot;Wee! Wee! Wee!&quot; all the way home.', html);

    terms = [[' piggy ', true]];
    html = goog.dom.annotate.annotateText(TEXT, terms, doAnnotation);
    assertEquals(null, html);

    terms = [[' piggy ', false]];
    html = goog.dom.annotate.annotateText(TEXT, terms, doAnnotation);
    assertEquals('This little<span class="c0"> piggy </span>cried ' +
                 '&quot;Wee! Wee! Wee!&quot; all the way home.', html);

    terms = [['goose', true], ['piggy', true]];
    html = goog.dom.annotate.annotateText(TEXT, terms, doAnnotation);
    assertEquals('This little <span class="c1">piggy</span> cried ' +
                 '&quot;Wee! Wee! Wee!&quot; all the way home.', html);
  }

  function testAnnotateTextHtmlEscaping() {
    var terms = [['a', false]];
    var html = goog.dom.annotate.annotateText('&a', terms, doAnnotation)
    assertEquals('&amp;<span class="c0">a</span>', html);

    terms = [['a', false]];
    html = goog.dom.annotate.annotateText('a&', terms, doAnnotation)
    assertEquals('<span class="c0">a</span>&amp;', html);

    terms = [['&', false]];
    html = goog.dom.annotate.annotateText('&', terms, doAnnotation)
    assertEquals('<span class="c0">&amp;</span>', html);
  }

  function testAnnotateTextIgnoreCase() {
    var terms = [['wEe', true]];
    var html = goog.dom.annotate.annotateText(TEXT, terms, doAnnotation, true);
    assertEquals('This little piggy cried &quot;<span class="c0">Wee</span>! ' +
                 '<span class="c0">Wee</span>! <span class="c0">Wee</span>!' +
                 '&quot; all the way home.', html);

    terms = [['WEE!', true], ['HE', false]];
    html = goog.dom.annotate.annotateText(TEXT, terms, doAnnotation, true);
    assertEquals('This little piggy cried &quot;<span class="c0">Wee!</span> ' +
                 '<span class="c0">Wee!</span> <span class="c0">Wee!</span>' +
                 '&quot; all t<span class="c1">he</span> way home.', html);
  }

  function testAnnotateTextOverlappingTerms() {
    var terms = [['tt', false], ['little', false]];
    var html = goog.dom.annotate.annotateText(TEXT, terms, doAnnotation);
    assertEquals('This <span class="c1">little</span> piggy cried &quot;Wee! ' +
                 'Wee! Wee!&quot; all the way home.', html);
  }

  // goog.dom.annotate.annotateTerms tests

  function testAnnotateTerms() {
    var terms = [['pig', true]];
    assertFalse(goog.dom.annotate.annotateTerms($('p'), terms, doAnnotation));
    assertEquals('Tom &amp; Jerry', $('p').innerHTML);

    terms = [['Tom', true]];
    assertTrue(goog.dom.annotate.annotateTerms($('p'), terms, doAnnotation));
    var spans = goog.dom.getElementsByTagNameAndClass('SPAN', 'c0', $('p'));
    assertEquals(1, spans.length);
    assertEquals('Tom', spans[0].innerHTML);
    assertEquals(' & Jerry', spans[0].nextSibling.nodeValue);
  }

  function testAnnotateTermsInTable() {
    var terms = [['pig', false]];
    assertTrue(goog.dom.annotate.annotateTerms($('q'), terms, doAnnotation));
    var spans = goog.dom.getElementsByTagNameAndClass('SPAN', 'c0', $('q'));
    assertEquals(2, spans.length);
    assertEquals('pig', spans[0].innerHTML);
    assertEquals('gy', spans[0].nextSibling.nodeValue);
    assertEquals('pig', spans[1].innerHTML);
    assertEquals('I', spans[1].parentNode.tagName);
  }

  function testAnnotateTermsWithClassExclusions() {
    var terms = [['pig', false]];
    var classesToIgnore = ['s'];
    assertTrue(goog.dom.annotate.annotateTerms($('r'), terms, doAnnotation,
                                               false, classesToIgnore));
    var spans = goog.dom.getElementsByTagNameAndClass('SPAN', 'c0', $('r'));
    assertEquals(1, spans.length);
    assertEquals('pig', spans[0].innerHTML);
    assertEquals('gy', spans[0].nextSibling.nodeValue);
  }

  function testAnnotateTermsInObject() {
    var terms = [['object', true]];
    assertTrue(goog.dom.annotate.annotateTerms($('o'), terms, doAnnotation));
    var spans = goog.dom.getElementsByTagNameAndClass('SPAN', 'c0', $('o'));
    assertEquals(1, spans.length);
    assertEquals('object', spans[0].innerHTML);
  }

  function testAnnotateTermsInScript() {
    var terms = [['variable', true]];
    assertFalse(goog.dom.annotate.annotateTerms($('script'), terms,
                                                doAnnotation));
  }

  function testAnnotateTermsInStyle() {
    var terms = [['color', true]];
    assertFalse(goog.dom.annotate.annotateTerms($('style'), terms,
                                                doAnnotation));
  }

  function testAnnotateTermsInHtmlComment() {
    var terms = [['note', true]];
    assertFalse(goog.dom.annotate.annotateTerms($('comment'), terms,
                                                doAnnotation));
  }

">11 of 11 tests run in 17ms.<br />4 passed, 7 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testAnnotateTerms<br />Object #<Object> has no method 'hasChildNodes'<br />ERROR in testAnnotateTermsInHtmlComment<br />Object #<Object> has no method 'hasChildNodes'<br />ERROR in testAnnotateTermsInObject<br />Object #<Object> has no method 'hasChildNodes'<br />ERROR in testAnnotateTermsInScript<br />Object #<Object> has no method 'hasChildNodes'<br />ERROR in testAnnotateTermsInStyle<br />Object #<Object> has no method 'hasChildNodes'<br />ERROR in testAnnotateTermsInTable<br />Object #<Object> has no method 'hasChildNodes'<br />ERROR in testAnnotateTermsWithClassExclusions<br />Object #<Object> has no method 'hasChildNodes'<br /></td></tr>
<tr><td>dom_test.html</td><td>Fail</td><td> 0 passed, 18 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.dom.TagName');
    goog.require('goog.functions');
    goog.require('goog.testing.editor.dom');
    goog.require('goog.testing.jsunit');
  

  var root = goog.dom.getElement('root');
  var parentNode, childNode1, childNode2, childNode3;
  var first, middle, last;

  function tearDown() {
    root.innerHTML = '';
  }

  function setUpNonEmptyTests() {
    childNode1 = goog.dom.createElement(goog.dom.TagName.DIV);
    childNode2 = goog.dom.createElement(goog.dom.TagName.DIV);
    childNode3 = goog.dom.createElement(goog.dom.TagName.DIV);
    parentNode = goog.dom.createDom(goog.dom.TagName.DIV,
        null,
        childNode1,
        childNode2,
        childNode3);
    goog.dom.appendChild(root, parentNode);

    childNode1.appendChild(goog.dom.createTextNode('One'));
    childNode1.appendChild(goog.dom.createTextNode(''));

    childNode2.appendChild(goog.dom.createElement(goog.dom.TagName.BR));
    childNode2.appendChild(goog.dom.createTextNode('TwoA'));
    childNode2.appendChild(goog.dom.createTextNode('TwoB'));
    childNode2.appendChild(goog.dom.createElement(goog.dom.TagName.BR));

    childNode3.appendChild(goog.dom.createTextNode(''));
    childNode3.appendChild(goog.dom.createTextNode('Three'));
  }

  function testGetNextNonEmptyTextNode() {
    setUpNonEmptyTests();

    var nodeOne =
        goog.testing.editor.dom.getNextNonEmptyTextNode(parentNode);
    assertEquals('Should have found the next non-empty text node',
                 'One',
                 nodeOne.nodeValue);
    var nodeTwoA =
        goog.testing.editor.dom.getNextNonEmptyTextNode(nodeOne);
    assertEquals('Should have found the next non-empty text node',
                 'TwoA',
                 nodeTwoA.nodeValue);
    var nodeTwoB =
        goog.testing.editor.dom.getNextNonEmptyTextNode(nodeTwoA);
    assertEquals('Should have found the next non-empty text node',
                 'TwoB',
                 nodeTwoB.nodeValue);
    var nodeThree =
        goog.testing.editor.dom.getNextNonEmptyTextNode(nodeTwoB);
    assertEquals('Should have found the next non-empty text node',
                 'Three',
                 nodeThree.nodeValue);
    var nodeNull =
        goog.testing.editor.dom.getNextNonEmptyTextNode(nodeThree, parentNode);
    assertNull('Should not have found any non-empty text node', nodeNull);

    var nodeStop =
        goog.testing.editor.dom.getNextNonEmptyTextNode(nodeOne, childNode1);
    assertNull('Should have stopped before finding a node', nodeStop);

    var nodeBeforeStop =
        goog.testing.editor.dom.getNextNonEmptyTextNode(nodeTwoA, childNode2);
    assertEquals('Should have found the next non-empty text node',
                 'TwoB',
                 nodeBeforeStop.nodeValue);
  }

  function testGetPreviousNonEmptyTextNode() {
    setUpNonEmptyTests();

    var nodeThree =
        goog.testing.editor.dom.getPreviousNonEmptyTextNode(parentNode);
    assertEquals('Should have found the previous non-empty text node',
                 'Three',
                 nodeThree.nodeValue);
    var nodeTwoB =
        goog.testing.editor.dom.getPreviousNonEmptyTextNode(nodeThree);
    assertEquals('Should have found the previous non-empty text node',
                 'TwoB',
                 nodeTwoB.nodeValue);
    var nodeTwoA =
        goog.testing.editor.dom.getPreviousNonEmptyTextNode(nodeTwoB);
    assertEquals('Should have found the previous non-empty text node',
                 'TwoA',
                 nodeTwoA.nodeValue);
    var nodeOne =
        goog.testing.editor.dom.getPreviousNonEmptyTextNode(nodeTwoA);
    assertEquals('Should have found the previous non-empty text node',
                 'One',
                 nodeOne.nodeValue);
    var nodeNull =
        goog.testing.editor.dom.getPreviousNonEmptyTextNode(nodeOne,
                                                            parentNode);
    assertNull('Should not have found any non-empty text node', nodeNull);

    var nodeStop =
        goog.testing.editor.dom.getPreviousNonEmptyTextNode(nodeThree,
                                                            childNode3);
    assertNull('Should have stopped before finding a node', nodeStop);

    var nodeBeforeStop =
        goog.testing.editor.dom.getPreviousNonEmptyTextNode(nodeTwoB,
                                                            childNode2);
    assertEquals('Should have found the previous non-empty text node',
                 'TwoA',
                 nodeBeforeStop.nodeValue);
  }


  function setUpAssertRangeBetweenText() {
    // Create the following structure: <[01]><[]><[23]>
    // Where <> delimits spans, [] delimits text nodes, 01 and 23 are text.
    // We will test all 10 positions in between 0 and 2. All should pass.
    first = goog.dom.createDom(goog.dom.TagName.SPAN, null, '01');
    middle = goog.dom.createElement(goog.dom.TagName.SPAN);
    var emptyTextNode = goog.dom.createTextNode('');
    goog.dom.appendChild(middle, emptyTextNode);
    last = goog.dom.createDom(goog.dom.TagName.SPAN, null, '23');
    goog.dom.appendChild(root, first);
    goog.dom.appendChild(root, middle);
    goog.dom.appendChild(root, last);
  }

  function createFakeRange(startNode, startOffset, opt_endNode, opt_endOffset) {
    opt_endNode = opt_endNode || startNode;
    opt_endOffset = opt_endOffset || startOffset;
    return {
      getStartNode: goog.functions.constant(startNode),
      getStartOffset: goog.functions.constant(startOffset),
      getEndNode: goog.functions.constant(opt_endNode),
      getEndOffset: goog.functions.constant(opt_endOffset)
    };
  }

  function testAssertRangeBetweenText0() {
    setUpAssertRangeBetweenText();
    goog.testing.editor.dom.assertRangeBetweenText('0', '1',
        createFakeRange(first.firstChild, 1));
  }

  function testAssertRangeBetweenText1() {
    setUpAssertRangeBetweenText();
    goog.testing.editor.dom.assertRangeBetweenText('1', '2',
        createFakeRange(first.firstChild, 2));
  }

  function testAssertRangeBetweenText2() {
    setUpAssertRangeBetweenText();
    goog.testing.editor.dom.assertRangeBetweenText('1', '2',
        createFakeRange(first, 1));
  }

  function testAssertRangeBetweenText3() {
    setUpAssertRangeBetweenText();
    goog.testing.editor.dom.assertRangeBetweenText('1', '2',
        createFakeRange(root, 1));
  }

  function testAssertRangeBetweenText4() {
    setUpAssertRangeBetweenText();
    goog.testing.editor.dom.assertRangeBetweenText('1', '2',
        createFakeRange(middle, 0));
  }

  function testAssertRangeBetweenText5() {
    setUpAssertRangeBetweenText();
    goog.testing.editor.dom.assertRangeBetweenText('1', '2',
        createFakeRange(middle.firstChild, 0));
  }

  function testAssertRangeBetweenText6() {
    setUpAssertRangeBetweenText();
    goog.testing.editor.dom.assertRangeBetweenText('1', '2',
        createFakeRange(middle, 1));
  }

  function testAssertRangeBetweenText7() {
    setUpAssertRangeBetweenText();
    goog.testing.editor.dom.assertRangeBetweenText('1', '2',
        createFakeRange(root, 2));
  }

  function testAssertRangeBetweenText8() {
    setUpAssertRangeBetweenText();
    goog.testing.editor.dom.assertRangeBetweenText('1', '2',
        createFakeRange(last, 0));
  }

  function testAssertRangeBetweenText9() {
    setUpAssertRangeBetweenText();
    goog.testing.editor.dom.assertRangeBetweenText('1', '2',
        createFakeRange(last.firstChild, 0));
  }


  function testAssertRangeBetweenTextBefore() {
    setUpAssertRangeBetweenText();
    // Test that it works when the cursor is at the beginning of all text.
    goog.testing.editor.dom.assertRangeBetweenText('', '0',
        createFakeRange(first.firstChild, 0),
        root); // Restrict to root div so it won't find /n's and script.
  }

  function testAssertRangeBetweenTextAfter() {
    setUpAssertRangeBetweenText();
    // Test that it works when the cursor is at the end of all text.
    goog.testing.editor.dom.assertRangeBetweenText('3', '',
        createFakeRange(last.firstChild, 2),
        root); // Restrict to root div so it won't find /n's and script.
  }


  function testAssertRangeBetweenTextFail1() {
    setUpAssertRangeBetweenText();
    var e = assertThrows('assertRangeBetweenText should have failed',
        function() {
          goog.testing.editor.dom.assertRangeBetweenText('1', '3',
              createFakeRange(first.firstChild, 2));
        });
    assertContains('Assert reason incorrect',
        'Expected <3> after range but found <23>', e.message);
  }

  function testAssertRangeBetweenTextFail2() {
    setUpAssertRangeBetweenText();
    var e = assertThrows('assertRangeBetweenText should have failed',
        function() {
          goog.testing.editor.dom.assertRangeBetweenText('1', '2',
              createFakeRange(first.firstChild, 2, last.firstChild, 1));
        });
    assertContains('Assert reason incorrect',
        'Expected <2> after range but found <3>', e.message);
  }

  function testAssertRangeBetweenTextBeforeFail() {
    setUpAssertRangeBetweenText();
    // Test that it gives the right message when the cursor is at the beginning
    // of all text but you're expecting something before it.
    var e = assertThrows('assertRangeBetweenText should have failed',
        function() {
          goog.testing.editor.dom.assertRangeBetweenText('-1', '0',
              createFakeRange(first.firstChild, 0),
              root); // Restrict to root div so it won't find /n's and script.
        });
    assertContains('Assert reason incorrect',
        'Expected <-1> before range but found nothing', e.message);
  }

  function testAssertRangeBetweenTextAfterFail() {
    setUpAssertRangeBetweenText();
    // Test that it gives the right message when the cursor is at the end
    // of all text but you're expecting something after it.
    var e = assertThrows('assertRangeBetweenText should have failed',
        function() {
          goog.testing.editor.dom.assertRangeBetweenText('3', '4',
              createFakeRange(last.firstChild, 2),
              root); // Restrict to root div so it won't find /n's and script.
        });
    assertContains('Assert reason incorrect',
        'Expected <4> after range but found nothing', e.message);
  }


">18 of 18 tests run in 11ms.<br />0 passed, 18 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testAssertRangeBetweenText0<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertRangeBetweenText1<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertRangeBetweenText2<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertRangeBetweenText3<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertRangeBetweenText4<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertRangeBetweenText5<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertRangeBetweenText6<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertRangeBetweenText7<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertRangeBetweenText8<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertRangeBetweenText9<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertRangeBetweenTextAfter<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertRangeBetweenTextAfterFail<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertRangeBetweenTextBefore<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertRangeBetweenTextBeforeFail<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertRangeBetweenTextFail1<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertRangeBetweenTextFail2<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetNextNonEmptyTextNode<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetPreviousNonEmptyTextNode<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>selection_test.html</td><td>Fail</td><td> 0 passed, 14 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.selection');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');



  var input;
  var hiddenInput;
  var textarea;
  var hiddenTextarea;

  function setUp() {
    input = goog.dom.createDom('input', {type: 'text'});
    textarea = goog.dom.createDom('textarea');
    hiddenInput = goog.dom.createDom(
        'input', {type: 'text', style: 'display: none'});
    hiddenTextarea = goog.dom.createDom(
        'textarea', {style: 'display: none'});

    document.body.appendChild(input);
    document.body.appendChild(textarea);
    document.body.appendChild(hiddenInput);
    document.body.appendChild(hiddenTextarea);
  }

  function tearDown() {
    goog.dom.removeNode(input);
    goog.dom.removeNode(textarea);
    goog.dom.removeNode(hiddenInput);
    goog.dom.removeNode(hiddenTextarea);
  }

  /**
   * Tests getStart routine in both input and textarea.
   */
  function testGetStartInput() {
    getStartHelper(input, hiddenInput);
  }

  function testGetStartTextarea() {
    getStartHelper(textarea, hiddenTextarea);
  }

  function getStartHelper(field, hiddenField) {
    assertEquals(0, goog.dom.selection.getStart(field));
    assertEquals(0, goog.dom.selection.getStart(hiddenField));

    field.focus();
    assertEquals(0, goog.dom.selection.getStart(field));
  }

  /**
   * Tests the setText routine for both input and textarea
   * with a single line of text.
   */
  function testSetTextInput() {
    setTextHelper(input);
  }

  function testSetTextTextarea() {
    setTextHelper(textarea);
  }

  function setTextHelper(field) {
    // Test one line string only
    select(field);
    assertEquals('', goog.dom.selection.getText(field));

    goog.dom.selection.setText(field, 'Get Behind Me Satan');
    assertEquals('Get Behind Me Satan', goog.dom.selection.getText(field));
  }

  /**
   * Tests the setText routine for textarea with multiple lines of text.
   */
  function testSetTextMultipleLines() {
    select(textarea);
    assertEquals('', goog.dom.selection.getText(textarea));
    var message = goog.userAgent.IE ?
                  'Get Behind Me\r\nSatan' :
                  'Get Behind Me\nSatan';
    goog.dom.selection.setText(textarea, message);
    assertEquals(message, goog.dom.selection.getText(textarea));

    // Select the text upto the point just after the \r\n combination
    // or \n in GECKO.
    var endOfNewline = goog.userAgent.IE ? 15 : 14;
    var selectedMessage = message.substring(0, endOfNewline);
    goog.dom.selection.setStart(textarea, 0);
    goog.dom.selection.setEnd(textarea, endOfNewline);
    assertEquals(selectedMessage, goog.dom.selection.getText(textarea));

    selectedMessage = goog.userAgent.IE ? '\r\n' : '\n';
    goog.dom.selection.setStart(textarea, 13);
    goog.dom.selection.setEnd(textarea, endOfNewline);
    assertEquals(selectedMessage, goog.dom.selection.getText(textarea));
  }

  /**
   * Tests the setCursor routine for both input and textarea.
   */
  function testSetCursorInput() {
    setCursorHelper(input);
  }

  function testSetCursorTextarea() {
    setCursorHelper(textarea);
  }

  function setCursorHelper(field) {
    select(field);
    // try to set the cursor beyond the length of the content
    goog.dom.selection.setStart(field, 5);
    goog.dom.selection.setEnd(field, 15);
    assertEquals(0, goog.dom.selection.getStart(field));
    assertEquals(0, goog.dom.selection.getEnd(field));

    select(field);
    var message = 'Get Behind Me Satan';
    goog.dom.selection.setText(field, message);
    goog.dom.selection.setStart(field, 5);
    goog.dom.selection.setEnd(field, message.length);
    assertEquals(5, goog.dom.selection.getStart(field));
    assertEquals(message.length, goog.dom.selection.getEnd(field));

    // Set the end before the start, and see if getEnd returns the start
    // position itself.
    goog.dom.selection.setStart(field, 5);
    goog.dom.selection.setEnd(field, 3);
    assertEquals(3, goog.dom.selection.getEnd(field));
  }

  /**
   * Tests the getText and setText routines acting on selected text in
   * both input and textarea.
   */
  function testGetAndSetSelectedTextInput() {
    getAndSetSelectedTextHelper(input);
  }

  function testGetAndSetSelectedTextTextarea() {
    getAndSetSelectedTextHelper(textarea);
  }

  function getAndSetSelectedTextHelper(field) {
    select(field);
    goog.dom.selection.setText(field, 'Get Behind Me Satan');

    // select 'Behind'
    goog.dom.selection.setStart(field, 4);
    goog.dom.selection.setEnd(field, 10);
    assertEquals('Behind', goog.dom.selection.getText(field));

    goog.dom.selection.setText(field, 'In Front Of');
    goog.dom.selection.setStart(field, 0);
    goog.dom.selection.setEnd(field, 100);
    assertEquals('Get In Front Of Me Satan', goog.dom.selection.getText(field));
  }

  /**
   * Test setStart on hidden input and hidden textarea.
   */
  function testSetCursorOnHiddenInput() {
    setCursorOnHiddenInputHelper(hiddenInput);
  }

  function testSetCursorOnHiddenTextarea() {
    setCursorOnHiddenInputHelper(hiddenTextarea);
  }

  function setCursorOnHiddenInputHelper(hiddenField) {
    goog.dom.selection.setStart(hiddenField, 0);
    assertEquals(0, goog.dom.selection.getStart(hiddenField));
  }

  /**
   * Test setStart, setEnd, getStart and getEnd in textarea with text
   * containing line breaks.
   */
  function testSetAndGetCursorWithLineBreaks() {
    select(textarea);
    var newline = goog.userAgent.IE ? '\r\n' : '\n';
    var message = 'Hello' + newline + 'World';
    goog.dom.selection.setText(textarea, message);

    // Test setEnd and getEnd, by setting the cursor somewhere after the
    // \r\n combination.
    goog.dom.selection.setEnd(textarea, 9);
    assertEquals(9, goog.dom.selection.getEnd(textarea));

    // Test basic setStart and getStart
    goog.dom.selection.setStart(textarea, 10);
    assertEquals(10, goog.dom.selection.getStart(textarea));

    // Test setEnd and getEnd, by setting the cursor exactly after the
    // \r\n combination in IE or after \n in GECKO.
    var endOfNewline = goog.userAgent.IE ? 7 : 6;
    checkSetAndGetTextarea(endOfNewline, endOfNewline);

    // Select a \r\n combination in IE or \n in GECKO and see if
    // getStart and getEnd work correctly.
    clearField(textarea);
    message = 'Hello' + newline + newline + 'World';
    goog.dom.selection.setText(textarea, message);
    var startOfNewline = goog.userAgent.IE ? 7 : 6;
    endOfNewline = goog.userAgent.IE ? 9 : 7;
    checkSetAndGetTextarea(startOfNewline, endOfNewline);

    // Select 2 \r\n combinations in IE or 2 \ns in GECKO and see if getStart
    // and getEnd work correctly.
    checkSetAndGetTextarea(5, endOfNewline);

    // Position cursor b/w 2 \r\n combinations in IE or 2 \ns in GECKO and see
    // if getStart and getEnd work correctly.
    clearField(textarea);
    message = 'Hello' + newline + newline + newline + newline + 'World';
    goog.dom.selection.setText(textarea, message);
    var middleOfNewlines = goog.userAgent.IE ? 9 : 7;
    checkSetAndGetTextarea(middleOfNewlines, middleOfNewlines);

    // Position cursor at end of a textarea which ends with \r\n in IE or \n in
    // GECKO.
    clearField(textarea);
    message = 'Hello' + newline + newline;
    goog.dom.selection.setText(textarea, message);
    var endOfTextarea = message.length;
    checkSetAndGetTextarea(endOfTextarea, endOfTextarea);

    // Position cursor at the end of the 2 starting \r\ns in IE or \ns in GECKO
    // within a textarea.
    clearField(textarea);
    message = newline + newline + 'World';
    goog.dom.selection.setText(textarea, message);
    var endOfTwoNewlines = goog.userAgent.IE ? 4 : 2;
    checkSetAndGetTextarea(endOfTwoNewlines, endOfTwoNewlines);

    // Position cursor at the end of the first \r\n in IE or \n in
    // GECKO within a textarea.
    endOfOneNewline = goog.userAgent.IE ? 2 : 1;
    checkSetAndGetTextarea(endOfOneNewline, endOfOneNewline);
  }

  /**
   * Test to make sure there's no error when getting the range of an unselected
   * textarea. See bug 1274027.
   */
  function testGetStartOnUnfocusedTextarea() {
    input.value = 'White Blood Cells';
    input.focus();
    goog.dom.selection.setCursorPosition(input, 5);

    assertEquals('getStart on input should return where we put the cursor',
        5, goog.dom.selection.getStart(input));

    assertEquals('getStart on unfocused textarea should succeed without error',
        0, goog.dom.selection.getStart(textarea));
  }

  /**
   * Test to make sure there's no error setting cursor position within a
   * textarea after a newline. This is problematic on IE because of the
   * '\r\n' vs '\n' issue.
   */
  function testSetCursorPositionTextareaWithNewlines() {
    textarea.value = 'Hello\nWorld';
    textarea.focus();

    // Set the selection point between 'W' and 'o'. Position is computed this
    // way instead of being hard-coded because it's different in IE due to \r\n
    // vs \n.
    goog.dom.selection.setCursorPosition(textarea, textarea.value.length - 4);

    var linebreak = goog.userAgent.IE ? '\r\n' : '\n';
    var expectedLeftString = 'Hello' + linebreak + 'W';

    assertEquals('getStart on input should return after the newline',
        expectedLeftString.length, goog.dom.selection.getStart(textarea));
    assertEquals('getEnd on input should return after the newline',
        expectedLeftString.length, goog.dom.selection.getEnd(textarea));

    goog.dom.selection.setEnd(textarea, textarea.value.length);
    assertEquals('orld', goog.dom.selection.getText(textarea));
  }

  /**
   * Helper function to clear the textfield contents.
   */
  function clearField(field) {
    field.value = '';
  }

  /**
   * Helper function to set the start and end and assert the getter values.
   */
  function checkSetAndGetTextarea(start, end) {
    goog.dom.selection.setStart(textarea, start);
    goog.dom.selection.setEnd(textarea, end);
    assertEquals(start, goog.dom.selection.getStart(textarea));
    assertEquals(end, goog.dom.selection.getEnd(textarea));
  }

  /**
   * Helper function to focus and select a field. In IE8, selected
   * fields need focus.
   */
  function select(field) {
    field.focus();
    field.select();
  }
">14 of 14 tests run in 15ms.<br />0 passed, 14 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testGetAndSetSelectedTextInput<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetAndSetSelectedTextTextarea<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetStartInput<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetStartOnUnfocusedTextarea<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetStartTextarea<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetAndGetCursorWithLineBreaks<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetCursorInput<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetCursorOnHiddenInput<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetCursorOnHiddenTextarea<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetCursorPositionTextareaWithNewlines<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetCursorTextarea<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetTextInput<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetTextMultipleLines<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetTextTextarea<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>dataset_test.html</td><td>Fail</td><td> 0 passed, 4 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.dataset');
  goog.require('goog.testing.jsunit');




var $ = goog.dom.getElement;
var dataset = goog.dom.dataset;


function setUp() {
  var el = $('el2');
  el.setAttribute('data-dynamic-key', 'dynamic');
}


function testHas() {
  var el = $('el1');

  assertTrue('Dataset should have an existing key',
             dataset.has(el, 'basicKey'));
  assertTrue('Dataset should have an existing (unusual) key',
             dataset.has(el, 'UnusualKey1'));
  assertTrue('Dataset should have an existing (unusual) key',
             dataset.has(el, 'unusual-Key2'));
  assertTrue('Dataset should have an existing (bizarre) key',
             dataset.has(el, '-Bizarre--Key'));
  assertFalse('Dataset should not have a non-existent key',
              dataset.has(el, 'bogusKey'));
}


function testGet() {
  var el = $('el1');

  assertEquals('Dataset should return the proper value for an existing key',
               dataset.get(el, 'basicKey'), 'basic');
  assertEquals('Dataset should have an existing (unusual) key',
               dataset.get(el, 'UnusualKey1'), 'unusual1');
  assertEquals('Dataset should have an existing (unusual) key',
               dataset.get(el, 'unusual-Key2'), 'unusual2');
  assertEquals('Dataset should have an existing (bizarre) key',
               dataset.get(el, '-Bizarre--Key'), 'bizarre');
  assertFalse('Dataset should return null or an empty string for a non-existent key',
              !!dataset.get(el, 'bogusKey'));

  el = $('el2');
  assertEquals('Dataset should return the proper value for an existing key',
               dataset.get(el, 'dynamicKey'), 'dynamic');
}


function testSet() {
  var el = $('el2');

  dataset.set(el, 'newKey', 'newValue');
  assertTrue('Dataset should have a newly created key',
             dataset.has(el, 'newKey'));
  assertEquals('Dataset should return the proper value for a newly created key',
               dataset.get(el, 'newKey'), 'newValue');

  dataset.set(el, 'dynamicKey', 'customValue');
  assertTrue('Dataset should have a modified, existing key',
             dataset.has(el, 'dynamicKey'));
  assertEquals('Dataset should return the proper value for a modified key',
               dataset.get(el, 'dynamicKey'), 'customValue');
}


function testRemove() {
  var el = $('el2');

  dataset.remove(el, 'dynamicKey');
  assertFalse('Dataset should not have a removed key',
              dataset.has(el, 'dynamicKey'));
  assertFalse('Dataset should return null or an empty string for removed key',
              !!dataset.get(el, 'dynamicKey'));
}


">4 of 4 tests run in 10ms.<br />0 passed, 4 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testGet<br />Object #<Object> has no method 'setAttribute'<br />ERROR in testHas<br />Object #<Object> has no method 'setAttribute'<br />ERROR in testRemove<br />Object #<Object> has no method 'setAttribute'<br />ERROR in testSet<br />Object #<Object> has no method 'setAttribute'<br /></td></tr>
<tr><td>tagname_test.html</td><td>Success</td><td> 2 passed, 0 failed.</td><td title="

  goog.require('goog.dom.TagName');
  goog.require('goog.object');
  goog.require('goog.testing.jsunit');



  function testCorrectNumberOfTagNames() {
    assertEquals(92, goog.object.getCount(goog.dom.TagName));
  }

  function testPropertyNamesEqualValues() {
    for (var propertyName in goog.dom.TagName) {
      assertEquals(propertyName, goog.dom.TagName[propertyName]);
    }
  }

">n/a</td></tr>
<tr><td>viewportsizemonitor_test.html</td><td>Fail</td><td> 3 passed, 1 failed.</td><td title="

  goog.require('goog.dom.ViewportSizeMonitor');
  goog.require('goog.events.Event');
  goog.require('goog.events.EventTarget');
  goog.require('goog.events.EventType');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.PropertyReplacer');


  var propertyReplacer, fakeWindow, viewportSizeMonitor, mockClock;


  function FakeWindow() {
  };
  goog.inherits(FakeWindow, goog.events.EventTarget);


  FakeWindow.prototype.fireResize = function() {
    return this.dispatchEvent(new FakeResizeEvent());
  };


  function FakeResizeEvent(obj) {
    this.type = goog.events.EventType.RESIZE;
  }
  goog.inherits(FakeResizeEvent, goog.events.Event);


  function getViewportSize() {
    return viewportSize;
  };


  function setViewportSize(w, h, fireEvent) {
    this.viewportSize = new goog.math.Size(w, h);
    if (fireEvent) {
      fakeWindow.fireResize();
    }
  };


  var eventWasFired = {};
  function getListenerFn(id) {
    return function() {
      propertyReplacer.set(eventWasFired, id, true);
    };
  };


  function listenerWasCalled(id) {
    return !!eventWasFired[id];
  };


  function setUp() {
    propertyReplacer = new goog.testing.PropertyReplacer();
    propertyReplacer.set(goog.dom, 'getViewportSize', getViewportSize);
    mockClock = new goog.testing.MockClock();
    mockClock.install();
    fakeWindow = new FakeWindow();
    setViewportSize(300, 300);
    viewportSizeMonitor = new goog.dom.ViewportSizeMonitor(fakeWindow);
  };


  function tearDown() {
    propertyReplacer.reset();
    mockClock.uninstall();
  };


  function testResizeEvent() {
    goog.events.listen(viewportSizeMonitor, goog.events.EventType.RESIZE,
        getListenerFn(1));
    assertFalse('Listener should not be called if window was not resized',
        listenerWasCalled(1));
    setViewportSize(300, 300, true);
    assertFalse('Listener should not be called for bogus resize event',
        listenerWasCalled(1));
    setViewportSize(301, 301, true);
    assertTrue('Listener should be called for valid resize event',
        listenerWasCalled(1));
  };


  function testPollingEvent() {
    propertyReplacer.set(goog.dom.ViewportSizeMonitor.prototype,
        'isPollingRequired_', function() { return true; });
    viewportSizeMonitor = new goog.dom.ViewportSizeMonitor(fakeWindow);
    goog.events.listen(viewportSizeMonitor, goog.events.EventType.RESIZE,
        getListenerFn(1));
    assertFalse('Listener should not be called if window was not resized',
        listenerWasCalled(1));
    mockClock.tick(goog.dom.ViewportSizeMonitor.WINDOW_SIZE_POLL_RATE);
    assertFalse('Listener should not be called if window was not resized ' +
        'during polling', listenerWasCalled(1));
    setViewportSize(301, 301, false);
    mockClock.tick(goog.dom.ViewportSizeMonitor.WINDOW_SIZE_POLL_RATE);
    assertTrue('Listener should be called for valid resize during polling',
        listenerWasCalled(1));
  };


  function testIsPollingRequired() {
    propertyReplacer.set(goog.userAgent, 'WEBKIT', false);
    propertyReplacer.set(goog.userAgent, 'OPERA', false);
    assertFalse('Polling should not be required except for WebKit and Opera',
        viewportSizeMonitor.isPollingRequired_());
    propertyReplacer.set(goog.userAgent, 'WEBKIT', true);
    propertyReplacer.set(goog.userAgent, 'WINDOWS', true);
    assertTrue('WebKit on Windows should require polling',
        viewportSizeMonitor.isPollingRequired_());
    propertyReplacer.set(goog.userAgent, 'WEBKIT', false);
    propertyReplacer.set(goog.userAgent, 'OPERA', true);

    // window.top and window.self are read-only in Opera
    fakeWindow.self = fakeWindow;
    fakeWindow.top = {};
    assertEquals('Opera should require polling if window.top != window.self',
        viewportSizeMonitor.isPollingRequired_(), true);
    fakeWindow.self = fakeWindow;
    fakeWindow.top = fakeWindow;
    assertEquals(
        'Opera should not require polling if window.top == window.self',
        viewportSizeMonitor.isPollingRequired_(), false);
  };


  function testInstanceGetter() {
    var fakeWindow1 = new FakeWindow();
    var monitor1 = goog.dom.ViewportSizeMonitor.getInstanceForWindow(
        fakeWindow1);
    var monitor2 = goog.dom.ViewportSizeMonitor.getInstanceForWindow(
        fakeWindow1);
    assertEquals('The same window should give us the same instance monitor',
        monitor1, monitor2);

    var fakeWindow2 = new FakeWindow();
    var monitor3 = goog.dom.ViewportSizeMonitor.getInstanceForWindow(
        fakeWindow2);
    assertNotEquals('Different windows should give different instances',
        monitor1, monitor3);

    assertEquals('Monitors should match if opt_window is not provided',
        goog.dom.ViewportSizeMonitor.getInstanceForWindow(),
        goog.dom.ViewportSizeMonitor.getInstanceForWindow());
  }

">4 of 4 tests run in 8ms.<br />3 passed, 1 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testInstanceGetter<br />Object #<Object> has no method 'attachEvent'<br /></td></tr>
<tr><td>nodeiterator_test.html</td><td>Fail</td><td> 0 passed, 3 failed.</td><td title="

  goog.require('goog.dom.NodeIterator');
  goog.require('goog.testing.dom');
  goog.require('goog.testing.jsunit');


  function testBasic() {
    goog.testing.dom.assertNodesMatch(
        new goog.dom.NodeIterator(goog.dom.getElement('test')),
        ['#test', '#a1', 'T', '#b1', 'e', 'xt', '#span1', '#p1', 'Text']);
  }

  function testUnclosed() {
    goog.testing.dom.assertNodesMatch(
        new goog.dom.NodeIterator(goog.dom.getElement('test2')),
        ['#test2', '#li1', 'Not', '#li2', 'Closed']);
  }

  function testReverse() {
    goog.testing.dom.assertNodesMatch(
        new goog.dom.NodeIterator(goog.dom.getElement('test'), true),
        ['Text', '#p1', '#span1', 'xt', 'e', '#b1', 'T', '#a1', '#test']);
  }

">3 of 3 tests run in 5ms.<br />0 passed, 3 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testBasic<br />Expected element at position 0<br />Expected <1> (Number) but was <undefined><br />> assertEquals at testing/asserts.js:289:3<br />> anonymous at testing/dom.js:72:<br />> Object.forEach at iter/iter.js:164:11<br />> Object.assertNodesMatch at testing/dom.js:59:13<br />> testBasic at _tmpclosuretest.js:9:22<br />ERROR in testReverse<br />Expected text node at position 0<br />Expected <3> (Number) but was <undefined><br />> assertEquals at testing/asserts.js:289:3<br />> anonymous at testing/dom.js:79:<br />> Object.forEach at iter/iter.js:164:11<br />> Object.assertNodesMatch at testing/dom.js:59:13<br />> testReverse at _tmpclosuretest.js:21:22<br />ERROR in testUnclosed<br />Expected element at position 0<br />Expected <1> (Number) but was <undefined><br />> assertEquals at testing/asserts.js:289:3<br />> anonymous at testing/dom.js:72:<br />> Object.forEach at iter/iter.js:164:11<br />> Object.assertNodesMatch at testing/dom.js:59:13<br />> testUnclosed at _tmpclosuretest.js:15:22<br /></td></tr>
<tr><td>multirange_test.html</td><td>Fail</td><td> 0 passed, 3 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.MultiRange');
  goog.require('goog.dom.Range');
  goog.require('goog.testing.jsunit');


  var range;
  function setUp() {
    range = new goog.dom.MultiRange.createFromTextRanges([
      goog.dom.Range.createFromNodeContents(goog.dom.getElement('test2')),
      goog.dom.Range.createFromNodeContents(goog.dom.getElement('test1'))
    ]);
  }

  function testStartAndEnd() {
    assertEquals(goog.dom.getElement('test1').firstChild, range.getStartNode());
    assertEquals(0, range.getStartOffset());
    assertEquals(goog.dom.getElement('test2').firstChild, range.getEndNode());
    assertEquals(6, range.getEndOffset());
  }

  function testStartAndEndIterator() {
    var it = goog.iter.toIterator(range);
    assertEquals(goog.dom.getElement('test1').firstChild, it.getStartNode());
    assertEquals(0, it.getStartTextOffset());
    assertEquals(goog.dom.getElement('test2').firstChild, it.getEndNode());
    assertEquals(3, it.getEndTextOffset());

    it.next();
    it.next();
    assertEquals(6, it.getEndTextOffset());
  }

  function testIteration() {
    var tags = goog.iter.toArray(range);
    assertEquals(2, tags.length);

    assertEquals(goog.dom.getElement('test1').firstChild, tags[0]);
    assertEquals(goog.dom.getElement('test2').firstChild, tags[1]);
  }
">3 of 3 tests run in 5ms.<br />0 passed, 3 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testIteration<br />Cannot call method 'createRange' of undefined<br />ERROR in testStartAndEnd<br />Cannot call method 'createRange' of undefined<br />ERROR in testStartAndEndIterator<br />Cannot call method 'createRange' of undefined<br /></td></tr>
<tr><td>textrange_test.html</td><td>Fail</td><td> 1 passed, 3 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.Range');
  goog.require('goog.dom.ControlRange');
  goog.require('goog.dom.TextRange');
  goog.require('goog.testing.dom');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');


  var logo = goog.dom.getElement('logo');
  var logo2 = goog.dom.getElement('logo2');
  var table = goog.dom.getElement('table');
  var table2 = goog.dom.getElement('table2');
  var table2div = goog.dom.getElement('table2div');

  function testCreateFromNodeContents() {
    assertNotNull('Text range object can be created for element node',
        goog.dom.TextRange.createFromNodeContents(logo));
    assertNotNull('Text range object can be created for text node',
        goog.dom.TextRange.createFromNodeContents(logo2.previousSibling));
  }

  function testMoveToNodes() {
    var range = goog.dom.TextRange.createFromNodeContents(table2);
    range.moveToNodes(table2div, 0, table2div, 1, false);
    assertEquals('Range should start in table2div',
                 table2div,
                 range.getStartNode());
    assertEquals('Range should end in table2div',
                 table2div,
                 range.getEndNode());
    assertEquals('Range start offset should be 0',
                 0,
                 range.getStartOffset());
    assertEquals('Range end offset should be 0',
                 1,
                 range.getEndOffset());
    assertFalse('Range should not be reversed',
                range.isReversed());
    range.moveToNodes(table2div, 0, table2div, 1, true);
    assertTrue('Range should be reversed',
               range.isReversed());
    assertEquals('Range text should be "foo"',
                 'foo',
                 range.getText());
  }

  function testContainsTextRange() {
    var range = goog.dom.TextRange.createFromNodeContents(table2);
    var range2 = goog.dom.TextRange.createFromNodeContents(table2div);
    assertTrue('TextRange contains other TextRange',
            range.containsRange(range2));
    assertFalse('TextRange does not contain other TextRange',
            range2.containsRange(range));

    range = goog.dom.Range.createFromNodes(
            table2div.firstChild, 1, table2div.lastChild, 1);
    range2 = goog.dom.TextRange.createFromNodes(
            table2div.firstChild, 0, table2div.lastChild, 0);
    if (!goog.userAgent.WEBKIT) {
      // TODO(user): Figure out why this fails, fix it, and get the WebKit
      // folks to fix it :-)
      assertTrue('TextRange partially contains other TextRange',
              range2.containsRange(range, true));
    }
    assertFalse('TextRange does not fully contain other TextRange',
            range2.containsRange(range, false));
    
  }

  function testContainsControlRange() {
    if (goog.userAgent.IE) {
      var range = goog.dom.ControlRange.createFromElements(table2);       
      var range2 = goog.dom.TextRange.createFromNodeContents(table2div);
      assertFalse('TextRange does not contain ControlRange',
              range2.containsRange(range));
      range = goog.dom.ControlRange.createFromElements(logo2);
      assertTrue('TextRange contains ControlRange',
              range2.containsRange(range));
      range = goog.dom.TextRange.createFromNodeContents(table2);
      range2 = goog.dom.ControlRange.createFromElements(logo, logo2);
      assertTrue('TextRange partially contains ControlRange',
              range2.containsRange(range, true));
      assertFalse('TextRange does not fully contain ControlRange',
              range2.containsRange(range, false));
    }
  }

">4 of 4 tests run in 6ms.<br />1 passed, 3 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testContainsTextRange<br />Cannot call method 'createRange' of undefined<br />ERROR in testCreateFromNodeContents<br />Cannot call method 'createRange' of undefined<br />ERROR in testMoveToNodes<br />Cannot call method 'createRange' of undefined<br /></td></tr>
<tr><td>browserrange_test.html</td><td>Fail</td><td> 0 passed, 25 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.browserrange');
  goog.require('goog.dom.Range');

  goog.require('goog.userAgent');
  goog.require('goog.testing.dom');
  goog.require('goog.testing.jsunit');


  var test1 = goog.dom.getElement('test1');
  var test2 = goog.dom.getElement('test2');
  var cetest = goog.dom.getElement('cetest');
  var empty = goog.dom.getElement('empty');
  var dynamic = goog.dom.getElement('dynamic');
  var onlybrdiv = goog.dom.getElement('onlybr');


  function testCreate() {
    assertNotNull('Browser range object can be created for node',
        goog.dom.browserrange.createRangeFromNodeContents(test1));
  }

  function testRangeEndPoints() {
    var container = cetest.firstChild;
    var range = goog.dom.browserrange.createRangeFromNodes(
        container, 2, container, 2);
    range.select();

    var selRange = goog.dom.Range.createFromWindow();
    var startNode = selRange.getStartNode();
    var endNode = selRange.getEndNode();
    var startOffset = selRange.getStartOffset();
    var endOffset = selRange.getEndOffset();
    if (goog.userAgent.WEBKIT) {
      assertEquals('Start node should have text: abc',
          'abc', startNode.nodeValue);
      assertEquals('End node should have text: abc', 'abc', endNode.nodeValue);
      assertEquals('Start offset should be 3', 3, startOffset);
      assertEquals('End offset should be 3', 3, endOffset);
    } else {
      assertEquals('Start node should be the first div', container, startNode);
      assertEquals('End node should be the first div', container, endNode);
      assertEquals('Start offset should be 2', 2, startOffset);
      assertEquals('End offset should be 2', 2, endOffset);
    }
  }

  function testCreateFromNodeContents() {
    var range = goog.dom.Range.createFromNodeContents(onlybrdiv);
    goog.testing.dom.assertRangeEquals(onlybrdiv, 0, onlybrdiv, 1, range);
  }

  function normalizeHtml(str) {
    return str.toLowerCase().replace(/[\n\r\f"]/g, '');
  }

  // TODO(robbyw): We really need tests for (and code fixes for)
  // createRangeFromNodes in the following cases:
  // * BR boundary (before + after)

  function testCreateFromNodes() {
    var start = test1.firstChild;
    var range = goog.dom.browserrange.createRangeFromNodes(start, 2,
        test2.firstChild, 2);
    assertNotNull('Browser range object can be created for W3C node range',
        range);

    assertEquals('Start node should be selected at start endpoint', start,
        range.getStartNode());
    assertEquals('Selection should start at offset 2', 2,
        range.getStartOffset());

    assertEquals('Text node should be selected at end endpoint',
        test2.firstChild, range.getEndNode());
    assertEquals('Selection should end at offset 2', 2, range.getEndOffset());

    assertTrue('Text content should be "xt\\s*ab"',
        /xt\s*ab/.test(range.getText()));
    assertFalse('Nodes range is not collapsed', range.isCollapsed());
    assertEquals('Should contain correct html fragment',
        'xt</div><div id=test2>ab',
        normalizeHtml(range.getHtmlFragment()));
    assertEquals('Should contain correct valid html',
        '<div id=test1>xt</div><div id=test2>ab</div>',
        normalizeHtml(range.getValidHtml()));
  }


  function testTextNode() {
    var range = goog.dom.browserrange.createRangeFromNodeContents(
        test1.firstChild);

    assertEquals('Text node should be selected at start endpoint', 'Text',
        range.getStartNode().nodeValue);
    assertEquals('Selection should start at offset 0', 0,
        range.getStartOffset());

    assertEquals('Text node should be selected at end endpoint', 'Text',
        range.getEndNode().nodeValue);
    assertEquals('Selection should end at offset 4', 'Text'.length,
        range.getEndOffset());

    assertEquals('Container should be text node', goog.dom.NodeType.TEXT,
        range.getContainer().nodeType);

    assertEquals('Text content should be "Text"', 'Text', range.getText());
    assertFalse('Text range is not collapsed', range.isCollapsed());
    assertEquals('Should contain correct html fragment', 'Text',
        range.getHtmlFragment());
    assertEquals('Should contain correct valid html',
        'Text', range.getValidHtml());

  }

  function testTextNodes() {
    goog.dom.removeChildren(dynamic);
    dynamic.appendChild(goog.dom.createTextNode('Part1'));
    dynamic.appendChild(goog.dom.createTextNode('Part2'));
    var range = goog.dom.browserrange.createRangeFromNodes(
        dynamic.firstChild, 0, dynamic.lastChild, 5);

    assertEquals('Text node 1 should be selected at start endpoint', 'Part1',
        range.getStartNode().nodeValue);
    assertEquals('Selection should start at offset 0', 0,
        range.getStartOffset());

    assertEquals('Text node 2 should be selected at end endpoint', 'Part2',
        range.getEndNode().nodeValue);
    assertEquals('Selection should end at offset 5', 'Part2'.length,
        range.getEndOffset());

    assertEquals('Container should be DIV', goog.dom.TagName.DIV,
        range.getContainer().tagName);

    assertEquals('Text content should be "Part1Part2"', 'Part1Part2',
        range.getText());
    assertFalse('Text range is not collapsed', range.isCollapsed());
    assertEquals('Should contain correct html fragment', 'Part1Part2',
        range.getHtmlFragment());
    assertEquals('Should contain correct valid html',
        'part1part2',
        normalizeHtml(range.getValidHtml()));

  }

  function testDiv() {
    var range = goog.dom.browserrange.createRangeFromNodeContents(test2);

    assertEquals('Text node "abc" should be selected at start endpoint', 'abc',
        range.getStartNode().nodeValue);
    assertEquals('Selection should start at offset 0', 0,
        range.getStartOffset());

    assertEquals('Text node "def" should be selected at end endpoint', 'def',
        range.getEndNode().nodeValue);
    assertEquals('Selection should end at offset 3', 'def'.length,
        range.getEndOffset());

    assertEquals('Container should be DIV', 'DIV',
        range.getContainer().tagName);

    assertTrue('Div text content should be "abc\\s*def"',
        /abc\s*def/.test(range.getText()));
    assertEquals('Should contain correct html fragment', 'abc<br id=br>def',
        normalizeHtml(range.getHtmlFragment()));
    assertEquals('Should contain correct valid html',
        '<div id=test2>abc<br id=br>def</div>',
        normalizeHtml(range.getValidHtml()));
    assertFalse('Div range is not collapsed', range.isCollapsed());
  }

  function testEmptyNodeHtmlInsert() {
    var range = goog.dom.browserrange.createRangeFromNodeContents(empty);
    var html = '<b>hello</b>';
    range.insertNode(goog.dom.htmlToDocumentFragment(html));
    assertEquals('Html is not inserted correctly', html,
      normalizeHtml(empty.innerHTML));
    goog.dom.removeChildren(empty);
  }

  function testEmptyNode() {
    var range = goog.dom.browserrange.createRangeFromNodeContents(empty);

    assertEquals('DIV be selected at start endpoint', 'DIV',
        range.getStartNode().tagName);
    assertEquals('Selection should start at offset 0', 0,
        range.getStartOffset());

    assertEquals('DIV should be selected at end endpoint', 'DIV',
        range.getEndNode().tagName);
    assertEquals('Selection should end at offset 0', 0,
        range.getEndOffset());

    assertEquals('Container should be DIV', 'DIV',
        range.getContainer().tagName);

    assertEquals('Empty text content should be ""', '', range.getText());
    assertTrue('Empty range is collapsed', range.isCollapsed());
    assertEquals('Should contain correct valid html', '<div id=empty></div>',
        normalizeHtml(range.getValidHtml()));
    assertEquals('Should contain no html fragment', '',
        range.getHtmlFragment());
  }


  function testRemoveContents() {
    var outer = goog.dom.getElement('removeTest');
    var range = goog.dom.browserrange.createRangeFromNodeContents(
        outer.firstChild);

    range.removeContents();

    assertEquals('Removed range content should be ""', '', range.getText());
    assertTrue('Removed range is now collapsed', range.isCollapsed());
    assertEquals('Outer div has 1 child now', 1, outer.childNodes.length);
    assertEquals('Inner div is empty', 0, outer.firstChild.childNodes.length);
  }


  function testCollapse() {
    var range = goog.dom.browserrange.createRangeFromNodeContents(test2);
    assertFalse('Div range is not collapsed', range.isCollapsed());
    range.collapse();
    assertTrue('Div range is collapsed after call to empty()',
        range.isCollapsed());

    range = goog.dom.browserrange.createRangeFromNodeContents(empty);
    assertTrue('Empty range is collapsed', range.isCollapsed());
    range.collapse();
    assertTrue('Empty range is still collapsed', range.isCollapsed());
  }


  function testIdWithSpecialCharacters() {
    goog.dom.removeChildren(dynamic);
    dynamic.appendChild(goog.dom.createTextNode('1'));
    dynamic.appendChild(goog.dom.createDom('div', {id: '<>'}));
    dynamic.appendChild(goog.dom.createTextNode('2'));
    var range = goog.dom.browserrange.createRangeFromNodes(
        dynamic.firstChild, 0, dynamic.lastChild, 1);

    // Difference in special character handling is ok.
    assertContains('Should have correct html fragment',
        normalizeHtml(range.getHtmlFragment()),
        [
          '1<div id=<>></div>2', // IE
          '1<div id=&lt;>></div>2', // WebKit
          '1<div id=&lt;&gt;></div>2' // Others
        ]);
  }

  function testEndOfChildren() {
    dynamic.innerHTML =
        '<span id="a">123<br>456</span><span id="b">text</span>';
    var range = goog.dom.browserrange.createRangeFromNodes(
        goog.dom.getElement('a'), 3, goog.dom.getElement('b'), 1);
    assertEquals('Should have correct text.', 'text', range.getText());
  }

  function testEndOfDiv() {
    dynamic.innerHTML = '<div id="a">abc</div><div id="b">def</div>';
    var a = goog.dom.getElement('a');
    var range = goog.dom.browserrange.createRangeFromNodes(a, 1, a, 1);
    var expectedStartNode = a;
    var expectedStartOffset = 1;
    var expectedEndNode = a;
    var expectedEndOffset = 1;
    assertEquals('startNode is wrong', expectedStartNode, range.getStartNode());
    assertEquals('startOffset is wrong',
        expectedStartOffset, range.getStartOffset());
    assertEquals('endNode is wrong', expectedEndNode, range.getEndNode());
    assertEquals('endOffset is wrong', expectedEndOffset, range.getEndOffset());
  }

  function testRangeEndingWithBR() {
    dynamic.innerHTML = '<span id="a">123<br>456</span>';
    var spanElem = goog.dom.getElement('a');
    var range = goog.dom.browserrange.createRangeFromNodes(
        spanElem, 0, spanElem, 2);
    var htmlText = range.getValidHtml().toLowerCase();
    assertContains('Should include BR in HTML.', 'br', htmlText);
    assertEquals('Should have correct text.', '123', range.getText());

    range.select();

    var selRange = goog.dom.Range.createFromWindow();
    var startNode = selRange.getStartNode();
    if (goog.userAgent.GECKO ||
        (goog.userAgent.IE && goog.userAgent.isVersion('9'))) {
      assertEquals('Start node should be span', spanElem, startNode);
    } else {
      assertEquals('Startnode should have text:123',
          '123', startNode.nodeValue);
    }
    assertEquals('Startoffset should be 0', 0, selRange.getStartOffset());
    var endNode = selRange.getEndNode();
    assertEquals('Endnode should be span', spanElem, endNode);
    assertEquals('Endoffset should be 2', 2, selRange.getEndOffset());
  }

  function testRangeEndingWithBR2() {
    dynamic.innerHTML = '<span id="a">123<br></span>';
    var spanElem = goog.dom.getElement('a');
    var range = goog.dom.browserrange.createRangeFromNodes(
        spanElem, 0, spanElem, 2);
    var htmlText = range.getValidHtml().toLowerCase();
    assertContains('Should include BR in HTML.', 'br', htmlText);
    assertEquals('Should have correct text.', '123', range.getText());

    range.select();

    var selRange = goog.dom.Range.createFromWindow();
    var startNode = selRange.getStartNode();
    if (goog.userAgent.GECKO ||
        (goog.userAgent.IE && goog.userAgent.isVersion('9'))) {
      assertEquals('Start node should be span', spanElem, startNode);
    } else {
      assertEquals('Start node should have text:123',
          '123', startNode.nodeValue);
    }
    assertEquals('Startoffset should be 0', 0, selRange.getStartOffset());
    var endNode = selRange.getEndNode();
    if (goog.userAgent.WEBKIT) {
      assertEquals('Endnode should have text', '123', endNode.nodeValue);
      assertEquals('Endoffset should be 3', 3, selRange.getEndOffset());
    } else {
      assertEquals('Endnode should be span', spanElem, endNode);
      assertEquals('Endoffset should be 2', 2, selRange.getEndOffset());
    }
  }

  function testRangeEndingBeforeBR() {
    dynamic.innerHTML = '<span id="a">123<br>456</span>';
    var spanElem = goog.dom.getElement('a');
    var range = goog.dom.browserrange.createRangeFromNodes(
        spanElem, 0, spanElem, 1);
    var htmlText = range.getValidHtml().toLowerCase();
    assertNotContains('Should not include BR in HTML.', 'br', htmlText);
    assertEquals('Should have correct text.', '123', range.getText());
    range.select();

    var selRange = goog.dom.Range.createFromWindow();
    var startNode = selRange.getStartNode();
    if (goog.userAgent.GECKO ||
        (goog.userAgent.IE && goog.userAgent.isVersion('9'))) {
      assertEquals('Start node should be span', spanElem, startNode);
    } else {
      assertEquals('Startnode should have text:123',
          '123', startNode.nodeValue);
    }
    assertEquals('Startoffset should be 0', 0, selRange.getStartOffset());
    var endNode = selRange.getEndNode();
    if (goog.userAgent.GECKO ||
        (goog.userAgent.IE && goog.userAgent.isVersion('9'))) {
      assertEquals('Endnode should be span', spanElem, endNode);
      assertEquals('Endoffset should be 1', 1, selRange.getEndOffset());
    } else {
      assertEquals('Endnode should have text:123', '123', endNode.nodeValue);
      assertEquals('Endoffset should be 3', 3, selRange.getEndOffset());
    }
  }

  function testRangeStartingWithBR() {
    dynamic.innerHTML = '<span id="a">123<br>456</span>';
    var spanElem = goog.dom.getElement('a');
    var range = goog.dom.browserrange.createRangeFromNodes(
        spanElem, 1, spanElem, 3);
    var htmlText = range.getValidHtml().toLowerCase();
    assertContains('Should include BR in HTML.', 'br', htmlText);
    // Firefox returns '456' as the range text while IE returns '\r\n456'.
    // Therefore skipping the text check.

    range.select();
    var selRange = goog.dom.Range.createFromWindow();
    var startNode = selRange.getStartNode();
    assertEquals('Start node should be span', spanElem, startNode);
    assertEquals('Startoffset should be 1', 1, selRange.getStartOffset());
    var endNode = selRange.getEndNode();
    if (goog.userAgent.GECKO ||
        (goog.userAgent.IE && goog.userAgent.isVersion('9'))) {
      assertEquals('Endnode should be span', spanElem, endNode);
      assertEquals('Endoffset should be 3', 3, selRange.getEndOffset());
    } else {
      assertEquals('Endnode should have text:456', '456', endNode.nodeValue);
      assertEquals('Endoffset should be 3', 3, selRange.getEndOffset());
    }
  }

  function testRangeStartingAfterBR() {
    dynamic.innerHTML = '<span id="a">123<br>4567</span>';
    var spanElem = goog.dom.getElement('a');
    var range = goog.dom.browserrange.createRangeFromNodes(
        spanElem, 2, spanElem, 3);
    var htmlText = range.getValidHtml().toLowerCase();
    assertNotContains('Should not include BR in HTML.', 'br', htmlText);
    assertEquals('Should have correct text.', '4567', range.getText());

    range.select();

    var selRange = goog.dom.Range.createFromWindow();
    var startNode = selRange.getStartNode();
    if (goog.userAgent.GECKO ||
        (goog.userAgent.IE && goog.userAgent.isVersion('9'))) {
      assertEquals('Start node should be span', spanElem, startNode);
      assertEquals('Startoffset should be 2', 2, selRange.getStartOffset());
    } else {
      assertEquals('Startnode should have text:4567',
          '4567', startNode.nodeValue);
      assertEquals('Startoffset should be 0', 0, selRange.getStartOffset());
    }
    var endNode = selRange.getEndNode();
    if (goog.userAgent.GECKO ||
        (goog.userAgent.IE && goog.userAgent.isVersion('9'))) {
      assertEquals('Endnode should be span', spanElem, endNode);
      assertEquals('Endoffset should be 3', 3, selRange.getEndOffset());
    } else {
      assertEquals('Endnode should have text:4567', '4567', endNode.nodeValue);
      assertEquals('Endoffset should be 4', 4, selRange.getEndOffset());
    }

  }

  function testCollapsedRangeBeforeBR() {
    dynamic.innerHTML = '<span id="a">123<br>456</span>';
    var range = goog.dom.browserrange.createRangeFromNodes(
        goog.dom.getElement('a'), 1, goog.dom.getElement('a'), 1);
    // Firefox returns <span id="a"></span> as the range HTML while IE returns
    // empty string. Therefore skipping the HTML check.
    assertEquals('Should have no text.', '', range.getText());
  }

  function testCollapsedRangeAfterBR() {
    dynamic.innerHTML = '<span id="a">123<br>456</span>';
    var range = goog.dom.browserrange.createRangeFromNodes(
        goog.dom.getElement('a'), 2, goog.dom.getElement('a'), 2);
    // Firefox returns <span id="a"></span> as the range HTML while IE returns
    // empty string. Therefore skipping the HTML check.
    assertEquals('Should have no text.', '', range.getText());
  }

  function testCompareBrowserRangeEndpoints() {
    var outer = goog.dom.getElement('outer');
    var inner = goog.dom.getElement('inner');
    var range_outer = goog.dom.browserrange.createRangeFromNodeContents(outer);
    var range_inner = goog.dom.browserrange.createRangeFromNodeContents(inner);

    assertEquals(
        "The start of the inner selection should be after the outer.",
        1,
        range_inner.compareBrowserRangeEndpoints(
            range_outer.getBrowserRange(),
            goog.dom.RangeEndpoint.START,
            goog.dom.RangeEndpoint.START));

    assertEquals(
        "The start of the inner selection should be before the outer's end.",
        -1,
        range_inner.compareBrowserRangeEndpoints(
            range_outer.getBrowserRange(),
            goog.dom.RangeEndpoint.START,
            goog.dom.RangeEndpoint.END));

    assertEquals(
        "The end of the inner selection should be after the outer's start.",
        1,
        range_inner.compareBrowserRangeEndpoints(
            range_outer.getBrowserRange(),
            goog.dom.RangeEndpoint.END,
            goog.dom.RangeEndpoint.START));

    assertEquals(
        "The end of the inner selection should be before the outer's end.",
        -1,
        range_inner.compareBrowserRangeEndpoints(
            range_outer.getBrowserRange(),
            goog.dom.RangeEndpoint.END,
            goog.dom.RangeEndpoint.END));

  }

  /**
   * Regression test for a bug in IeRange.insertNode_ where if the node to be
   * inserted was not an element (e.g. a text node), it would clone the node
   * in the inserting process but return the original node instead of the newly
   * created and inserted node.
   */
  function testInsertNodeNonElement() {
    dynamic.innerHTML = 'beforeafter';
    var range = goog.dom.browserrange.createRangeFromNodes(
            dynamic.firstChild, 6, dynamic.firstChild, 6);
    var newNode = goog.dom.createTextNode('INSERTED');
    var inserted = range.insertNode(newNode, false);

    assertEquals('Text should be inserted between "before" and "after"',
                 'beforeINSERTEDafter',
                 goog.dom.getRawTextContent(dynamic));
    assertEquals('Node returned by insertNode() should be a child of the div' +
                 ' containing the text',
                 dynamic,
                 inserted.parentNode)
  }

  function testSelectOverwritesOldSelection() {
    goog.dom.browserrange.createRangeFromNodes(test1, 0, test1, 1).select();
    goog.dom.browserrange.createRangeFromNodes(test2, 0, test2, 1).select();
    assertEquals('The old selection must be replaced with the new one',
                 'abc', goog.dom.Range.createFromWindow().getText());
  }

  // Following testcase is special for IE. The comparison of ranges created in
  // testcases with a range over empty span using native inRange fails. So the
  // fallback mechanism is needed.
  function testGetContainerInTextNodesAroundEmptySpan() {
      dynamic.innerHTML = 'abc<span></span>def';
      var abc = dynamic.firstChild;
      var def = dynamic.lastChild;

      var range;
      range = goog.dom.browserrange.createRangeFromNodes(abc, 1, abc, 1);
      assertEquals('textNode abc should be the range container',
              abc, range.getContainer());
      assertEquals('textNode abc should be the range start node',
              abc, range.getStartNode());
      assertEquals('textNode abc should be the range end node',
              abc, range.getEndNode());

      range = goog.dom.browserrange.createRangeFromNodes(def, 1, def, 1);
      assertEquals('textNode def should be the range container',
              def, range.getContainer());
      assertEquals('textNode def should be the range start node',
              def, range.getStartNode());
      assertEquals('textNode def should be the range end node',
              def, range.getEndNode());
  }

">25 of 25 tests run in 20ms.<br />0 passed, 25 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testCollapse<br />Cannot call method 'createRange' of undefined<br />ERROR in testCollapsedRangeAfterBR<br />Cannot call method 'createRange' of undefined<br />ERROR in testCollapsedRangeBeforeBR<br />Cannot call method 'createRange' of undefined<br />ERROR in testCompareBrowserRangeEndpoints<br />Cannot call method 'createRange' of undefined<br />ERROR in testCreate<br />Cannot call method 'createRange' of undefined<br />ERROR in testCreateFromNodeContents<br />Cannot call method 'createRange' of undefined<br />ERROR in testCreateFromNodes<br />Cannot read property 'nodeType' of undefined<br />ERROR in testDiv<br />Cannot call method 'createRange' of undefined<br />ERROR in testEmptyNode<br />Cannot call method 'createRange' of undefined<br />ERROR in testEmptyNodeHtmlInsert<br />Cannot call method 'createRange' of undefined<br />ERROR in testEndOfChildren<br />Cannot call method 'createRange' of undefined<br />ERROR in testEndOfDiv<br />Cannot call method 'createRange' of undefined<br />ERROR in testGetContainerInTextNodesAroundEmptySpan<br />Cannot read property 'nodeType' of undefined<br />ERROR in testIdWithSpecialCharacters<br />Object #<Object> has no method 'createTextNode'<br />ERROR in testInsertNodeNonElement<br />Cannot read property 'nodeType' of undefined<br />ERROR in testRangeEndPoints<br />Cannot read property 'nodeType' of undefined<br />ERROR in testRangeEndingBeforeBR<br />Cannot call method 'createRange' of undefined<br />ERROR in testRangeEndingWithBR<br />Cannot call method 'createRange' of undefined<br />ERROR in testRangeEndingWithBR2<br />Cannot call method 'createRange' of undefined<br />ERROR in testRangeStartingAfterBR<br />Cannot call method 'createRange' of undefined<br />ERROR in testRangeStartingWithBR<br />Cannot call method 'createRange' of undefined<br />ERROR in testRemoveContents<br />Cannot read property 'nodeType' of undefined<br />ERROR in testSelectOverwritesOldSelection<br />Cannot call method 'createRange' of undefined<br />ERROR in testTextNode<br />Cannot read property 'nodeType' of undefined<br />ERROR in testTextNodes<br />Object #<Object> has no method 'createTextNode'<br /></td></tr>
<tr><td>iframe_test.html</td><td>Fail</td><td> 0 passed, 3 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.iframe');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');



  var domHelper = goog.dom.getDomHelper();
  var sandbox = domHelper.getElement('sandbox');

  function setUp() {
    goog.dom.removeChildren(sandbox);
  }

  function testCreateWithContent() {
    var iframe = goog.dom.iframe.createWithContent(sandbox,
        '<title>Foo Title</title>', '<div id="blah">Test</div>',
        'position: absolute',
        false /* opt_quirks */);

    var doc = goog.dom.getFrameContentDocument(iframe);
    assertNotNull(doc.getElementById('blah'));
    assertEquals('Foo Title', doc.title);
    assertEquals('absolute', iframe.style.position);
  };

  function testCreateBlankYieldsIframeWithNoBorderOrPadding() {
    var iframe = goog.dom.iframe.createBlank(domHelper);
    iframe.style.width = '350px';
    iframe.style.height = '250px';
    var blankElement = domHelper.getElement('blank');
    blankElement.appendChild(iframe);
    assertEquals(
        'Width should be as styled: no extra borders, padding, etc.',
        350, blankElement.offsetWidth);
    assertEquals(
        'Height should be as styled: no extra borders, padding, etc.',
        250, blankElement.offsetHeight);
  };

  function testCreateBlankWithStyles() {
    var iframe = goog.dom.iframe.createBlank(domHelper, 'position:absolute');
    assertEquals('absolute', iframe.style.position);
    assertEquals('bottom', iframe.style.verticalAlign);
  };
">3 of 3 tests run in 10ms.<br />0 passed, 3 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testCreateBlankWithStyles<br />Object #<Object> has no method 'createElement'<br />ERROR in testCreateBlankYieldsIframeWithNoBorderOrPadding<br />Object #<Object> has no method 'createElement'<br />ERROR in testCreateWithContent<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>xml_test.html</td><td>Fail</td><td> 4 passed, 1 failed.</td><td title="

  goog.require('goog.dom.xml');
  goog.require('goog.string');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');



function testSerialize() {
  var doc = goog.dom.xml.createDocument();
  var node = doc.createElement('root');
  doc.appendChild(node);

  var serializedNode = goog.dom.xml.serialize(node);
  assertTrue(/<root ?\/>/.test(serializedNode));

  var serializedDoc = goog.dom.xml.serialize(doc);
  assertTrue(/(<\?xml version="1.0"\?>)?<root ?\/>/.test(serializedDoc));
}

function testBelowMaxDepthInIE() {
  if (goog.userAgent.IE) {
    goog.dom.xml.MAX_ELEMENT_DEPTH = 5;
    var junk = '<a><b><c><d><e>Hello</e></d></c></b></a>';
    var doc = goog.dom.xml.loadXml(junk);
    assertEquals('Should not have caused a parse error', 0,
        Number(doc.parseError));
  }
}

function testAboveMaxDepthInIE() {
  if (goog.userAgent.IE) {
    goog.dom.xml.MAX_ELEMENT_DEPTH = 4;
    var junk = '<a><b><c><d><e>Hello</e></d></c></b></a>';
    var doc = goog.dom.xml.loadXml(junk);
    assertNotEquals('Should have caused a parse error', 0,
        Number(doc.parseError));
  }
}

function testBelowMaxSizeInIE() {
  if (goog.userAgent.IE) {
    goog.dom.xml.MAX_XML_SIZE_KB = 1;
    var junk = '<a>' + new Array(50).join('<b>junk</b>') + '</a>';
    var doc = goog.dom.xml.loadXml(junk);
    assertEquals('Should not have caused a parse error',
        0, Number(doc.parseError));
  }
}

function testMaxSizeInIE() {
  if (goog.userAgent.IE) {
    goog.dom.xml.MAX_XML_SIZE_KB = 1;
    var junk = '<a>' + new Array(1000).join('<b>junk</b>') + '</a>';
    var doc = goog.dom.xml.loadXml(junk);
    assertNotEquals('Should have caused a parse error', 0,
        Number(doc.parseError));
  }
}

">5 of 5 tests run in 9ms.<br />4 passed, 1 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testSerialize<br />Your browser does not support creating new documents<br /></td></tr>
<tr><td>pattern_test.html</td><td>Fail</td><td> 1 passed, 18 failed.</td><td title="

  goog.require('goog.testing.jsunit');

  goog.require('goog.dom.TagWalkType');
  goog.require('goog.dom.pattern.AllChildren');
  goog.require('goog.dom.pattern.ChildMatches');
  goog.require('goog.dom.pattern.EndTag');
  goog.require('goog.dom.pattern.FullTag');
  goog.require('goog.dom.pattern.MatchType');
  goog.require('goog.dom.pattern.NodeType');
  goog.require('goog.dom.pattern.Repeat');
  goog.require('goog.dom.pattern.Sequence');
  goog.require('goog.dom.pattern.StartTag');
  goog.require('goog.dom.pattern.Text');


  // TODO(robbyw): write a test that checks if backtracking works in Sequence

  function testStartTag() {
    var pattern = new goog.dom.pattern.StartTag('DIV');
    assertEquals(
        'StartTag(div) should match div',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'StartTag(div) should not match span',
        goog.dom.pattern.MatchType.NO_MATCH,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'StartTag(div) should not match /div',
        goog.dom.pattern.MatchType.NO_MATCH,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.END_TAG));
  }

  function testStartTagCase() {
    var pattern = new goog.dom.pattern.StartTag('diV');
    assertEquals(
        'StartTag(diV) should match div',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'StartTag(diV) should not match span',
        goog.dom.pattern.MatchType.NO_MATCH,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.START_TAG));
  }

  function testStartTagRegex() {
    var pattern = new goog.dom.pattern.StartTag(/D/);
    assertEquals(
        'StartTag(/D/) should match div',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'StartTag(/D/) should not match span',
        goog.dom.pattern.MatchType.NO_MATCH,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'StartTag(/D/) should not match /div',
        goog.dom.pattern.MatchType.NO_MATCH,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.END_TAG));
  }

  function testStartTagAttributes() {
    var pattern = new goog.dom.pattern.StartTag('DIV',{id: 'div1'});
    assertEquals(
        'StartTag(div,id:div1) should match div1',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals('StartTag(div,id:div2) should not match div1',
        goog.dom.pattern.MatchType.NO_MATCH,
        pattern.matchToken(
            goog.dom.getElement('div2'),
            goog.dom.TagWalkType.START_TAG));
  }

  function testStartTagStyle() {
    var pattern = new goog.dom.pattern.StartTag('SPAN',null,{color: 'red'});
    assertEquals(
        'StartTag(span,null,color:red) should match span1',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'StartTag(span,null,color:blue) should not match span1',
        goog.dom.pattern.MatchType.NO_MATCH,
        pattern.matchToken(
            goog.dom.getElement('span2'),
            goog.dom.TagWalkType.START_TAG));
  }

  function testStartTagAttributeRegex() {
    var pattern = new goog.dom.pattern.StartTag('SPAN',{id: /span\d/});
    assertEquals(
        'StartTag(span,id:/span\\d/) should match span1',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'StartTag(span,id:/span\\d/) should match span2',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.START_TAG));
  }

  function testEndTag() {
    var pattern = new goog.dom.pattern.EndTag('DIV');
    assertEquals(
        'EndTag should match div',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.END_TAG));
  }

  function testEndTagRegex() {
    var pattern = new goog.dom.pattern.EndTag(/D/);
    assertEquals(
        'EndTag(/D/) should match /div',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.END_TAG));
    assertEquals(
        'EndTag(/D/) should not match /span',
        goog.dom.pattern.MatchType.NO_MATCH,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.END_TAG));
    assertEquals(
        'EndTag(/D/) should not match div',
        goog.dom.pattern.MatchType.NO_MATCH,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.START_TAG));
  }

  function testChildMatches() {
    var pattern = new goog.dom.pattern.ChildMatches(
        new goog.dom.pattern.StartTag('DIV'), 2);

    assertEquals(
        'ChildMatches should match div',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'ChildMatches should match /div',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.END_TAG));
    assertEquals(
        'ChildMatches should match div',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('div2'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'ChildMatches should match /div',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('div2'),
            goog.dom.TagWalkType.END_TAG));
    assertEquals(
        'ChildMatches should finish match at /body',
        goog.dom.pattern.MatchType.BACKTRACK_MATCH,
        pattern.matchToken(
            document.body,
            goog.dom.TagWalkType.END_TAG));

    assertEquals(
        'ChildMatches should match div',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('div2'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'ChildMatches should match /div',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('div2'),
            goog.dom.TagWalkType.END_TAG));
    assertEquals(
        'ChildMatches should fail to match at /body: not enough child matches',
        goog.dom.pattern.MatchType.NO_MATCH,
        pattern.matchToken(
            document.body,
            goog.dom.TagWalkType.END_TAG));
  }

  function testFullTag() {
    var pattern = new goog.dom.pattern.FullTag('DIV');
    assertEquals(
        'FullTag(div) should match div',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'FullTag(div) should match /div',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.END_TAG));

    assertEquals(
        'FullTag(div) should start match at div',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'FullTag(div) should continue to match span',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'FullTag(div) should continue to match /span',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.END_TAG));
    assertEquals(
        'FullTag(div) should finish match at /div',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.END_TAG));
  }

  function testAllChildren() {
    var pattern = new goog.dom.pattern.AllChildren();
    assertEquals(
        'AllChildren(div) should match div',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'AllChildren(div) should match /div',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.END_TAG));
    assertEquals(
        'AllChildren(div) should match at /body',
        goog.dom.pattern.MatchType.BACKTRACK_MATCH,
        pattern.matchToken(
            document.body,
            goog.dom.TagWalkType.END_TAG));

    assertEquals(
        'AllChildren(div) should start match at div',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'AllChildren(div) should continue to match span',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'AllChildren(div) should continue to match /span',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.END_TAG));
    assertEquals(
        'AllChildren(div) should continue to match at /div',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.END_TAG));
    assertEquals(
        'AllChildren(div) should finish match at /body',
        goog.dom.pattern.MatchType.BACKTRACK_MATCH,
        pattern.matchToken(
            document.body,
            goog.dom.TagWalkType.END_TAG));
  }

  function testText() {
    var pattern = new goog.dom.pattern.Text('Text');
    assertEquals(
        'Text should match div3/text()',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('div3').firstChild,
            goog.dom.TagWalkType.OTHER));
    assertEquals(
        'Text should not match div4/text()',
        goog.dom.pattern.MatchType.NO_MATCH,
        pattern.matchToken(
            goog.dom.getElement('div4').firstChild,
            goog.dom.TagWalkType.OTHER));
    assertEquals(
        'Text should not match div3',
        goog.dom.pattern.MatchType.NO_MATCH,
        pattern.matchToken(
            goog.dom.getElement('div3'),
            goog.dom.TagWalkType.START_TAG));

  }

  function testTextRegex() {
    var pattern = new goog.dom.pattern.Text(/Text/);
    assertEquals(
        'Text(regex) should match div3/text()',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('div3').firstChild,
            goog.dom.TagWalkType.OTHER));
    assertEquals(
        'Text(regex) should match div4/text()',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('div4').firstChild,
            goog.dom.TagWalkType.OTHER));
  }

  function testNodeType() {
    var pattern = new goog.dom.pattern.NodeType(goog.dom.NodeType.COMMENT);
    assertEquals('Comment matcher should match a comment',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('nodeTypes').firstChild,
            goog.dom.TagWalkType.OTHER));
    assertEquals('Comment matcher should not match a text node',
        goog.dom.pattern.MatchType.NO_MATCH,
        pattern.matchToken(
            goog.dom.getElement('nodeTypes').lastChild,
            goog.dom.TagWalkType.OTHER));
  }

  function testSequence() {
    var pattern = new goog.dom.pattern.Sequence([
        new goog.dom.pattern.StartTag('DIV'),
        new goog.dom.pattern.StartTag('SPAN'),
        new goog.dom.pattern.EndTag('SPAN'),
        new goog.dom.pattern.EndTag('DIV')]);

    assertEquals(
        'Sequence[0] should match div1',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Sequence[1] should match span1',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Sequence[2] should match /span1',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.END_TAG));
    assertEquals(
        'Sequence[3] should match /div1',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.END_TAG));

    assertEquals(
        'Sequence[0] should match div1 again',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Sequence[1] should match span1 again',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Sequence[2] should match /span1 again',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.END_TAG));
    assertEquals(
        'Sequence[3] should match /div1 again',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.END_TAG));

    assertEquals(
        'Sequence[0] should match div1',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Sequence[1] should not match div1',
        goog.dom.pattern.MatchType.NO_MATCH,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.START_TAG));

    assertEquals(
        'Sequence[0] should match div1 after failure',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Sequence[1] should match span1 after failure',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Sequence[2] should match /span1 after failure',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('span1'),
            goog.dom.TagWalkType.END_TAG));
    assertEquals(
        'Sequence[3] should match /div1 after failure',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('div1'),
            goog.dom.TagWalkType.END_TAG));
  }

  function testRepeat() {
    var pattern = new goog.dom.pattern.Repeat(
        new goog.dom.pattern.StartTag('B'));

    // Note: this test does not mimic an actual matcher because it is only
    // passing the START_TAG events.

    assertEquals(
        'Repeat[B] should match b1',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('b1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Repeat[B] should match b2',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('b2'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Repeat[B] should backtrack match i1',
        goog.dom.pattern.MatchType.BACKTRACK_MATCH,
        pattern.matchToken(
            goog.dom.getElement('i1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Repeat[B] should have match count of 2',
        2,
        pattern.count);

    assertEquals(
        'Repeat[B] should backtrack match i1 even with no b matches',
        goog.dom.pattern.MatchType.BACKTRACK_MATCH,
        pattern.matchToken(
            goog.dom.getElement('i1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Repeat[B] should have match count of 0',
        0,
        pattern.count);
  }

  function testRepeatWithMinimum() {
    var pattern = new goog.dom.pattern.Repeat(
        new goog.dom.pattern.StartTag('B'), 1);

    // Note: this test does not mimic an actual matcher because it is only
    // passing the START_TAG events.

    assertEquals(
        'Repeat[B,1] should match b1',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('b1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Repeat[B,1] should match b2',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(
            goog.dom.getElement('b2'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Repeat[B,1] should backtrack match i1',
        goog.dom.pattern.MatchType.BACKTRACK_MATCH,
        pattern.matchToken(
            goog.dom.getElement('i1'),
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Repeat[B,1] should have match count of 2',
        2,
        pattern.count);

    assertEquals(
        'Repeat[B,1] should not match i1',
        goog.dom.pattern.MatchType.NO_MATCH,
        pattern.matchToken(
            goog.dom.getElement('i1'),
            goog.dom.TagWalkType.START_TAG));
  }

  function testRepeatWithMaximum() {
    var pattern = new goog.dom.pattern.Repeat(
        new goog.dom.pattern.StartTag('B'), 1, 1);

    // Note: this test does not mimic an actual matcher because it is only
    // passing the START_TAG events.

    assertEquals(
        'Repeat[B,1] should match b1',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(
            goog.dom.getElement('b1'),
            goog.dom.TagWalkType.START_TAG));
  }

  function testSequenceBacktrack() {
    var pattern = new goog.dom.pattern.Sequence([
        new goog.dom.pattern.Repeat(new goog.dom.pattern.StartTag('SPAN')),
        new goog.dom.pattern.Text('X')]);

    var root = goog.dom.getElement('span3');
    assertEquals(
        'Sequence[Repeat[SPAN],"X"] should match span3',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(root, goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Sequence[Repeat[SPAN],"X"] should match span3.firstChild',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(root.firstChild,
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Sequence[Repeat[SPAN],"X"] should match span3.firstChild.firstChild',
        goog.dom.pattern.MatchType.MATCHING,
        pattern.matchToken(root.firstChild.firstChild,
            goog.dom.TagWalkType.START_TAG));
    assertEquals(
        'Sequence[Repeat[SPAN],"X"] should finish match text node',
        goog.dom.pattern.MatchType.MATCH,
        pattern.matchToken(root.firstChild.firstChild.firstChild,
            goog.dom.TagWalkType.OTHER));
  }
">19 of 19 tests run in 18ms.<br />1 passed, 18 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testChildMatches<br />ChildMatches should finish match at /body<br />Expected <3> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testChildMatches at _tmpclosuretest.js:187:5<br />ERROR in testEndTag<br />EndTag should match div<br />Expected <2> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testEndTag at _tmpclosuretest.js:129:5<br />ERROR in testEndTagRegex<br />EndTag(/D/) should match /div<br />Expected <2> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testEndTagRegex at _tmpclosuretest.js:139:5<br />ERROR in testFullTag<br />FullTag(div) should match div<br />Expected <1> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testFullTag at _tmpclosuretest.js:216:5<br />ERROR in testNodeType<br />Cannot read property 'nodeType' of undefined<br />ERROR in testRepeat<br />Repeat[B] should match b1<br />Expected <1> (Number) but was <3> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testRepeat at _tmpclosuretest.js:464:5<br />ERROR in testRepeatWithMaximum<br />Repeat[B,1] should match b1<br />Expected <2> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testRepeatWithMaximum at _tmpclosuretest.js:544:5<br />ERROR in testRepeatWithMinimum<br />Repeat[B,1] should match b1<br />Expected <1> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testRepeatWithMinimum at _tmpclosuretest.js:506:5<br />ERROR in testSequence<br />Sequence[0] should match div1<br />Expected <1> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testSequence at _tmpclosuretest.js:368:5<br />ERROR in testSequenceBacktrack<br />Sequence[Repeat[SPAN],"X"] should match span3<br />Expected <1> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testSequenceBacktrack at _tmpclosuretest.js:558:5<br />ERROR in testStartTag<br />StartTag(div) should match div<br />Expected <2> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testStartTag at _tmpclosuretest.js:22:5<br />ERROR in testStartTagAttributeRegex<br />StartTag(span,id:/span\d/) should match span1<br />Expected <2> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testStartTagAttributeRegex at _tmpclosuretest.js:113:5<br />ERROR in testStartTagAttributes<br />StartTag(div,id:div1) should match div1<br />Expected <2> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testStartTagAttributes at _tmpclosuretest.js:82:5<br />ERROR in testStartTagCase<br />StartTag(diV) should match div<br />Expected <2> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testStartTagCase at _tmpclosuretest.js:44:5<br />ERROR in testStartTagRegex<br />StartTag(/D/) should match div<br />Expected <2> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testStartTagRegex at _tmpclosuretest.js:60:5<br />ERROR in testStartTagStyle<br />StartTag(span,null,color:red) should match span1<br />Expected <2> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testStartTagStyle at _tmpclosuretest.js:97:5<br />ERROR in testText<br />Cannot read property 'nodeType' of undefined<br />ERROR in testTextRegex<br />Cannot read property 'nodeType' of undefined<br /></td></tr>
<tr><td>matcher_test.html</td><td>Fail</td><td> 0 passed, 9 failed.</td><td title="

  goog.require('goog.testing.jsunit');

  goog.require('goog.dom.pattern.EndTag');
  goog.require('goog.dom.pattern.FullTag');
  goog.require('goog.dom.pattern.Matcher');
  goog.require('goog.dom.pattern.Repeat');
  goog.require('goog.dom.pattern.Sequence');
  goog.require('goog.dom.pattern.StartTag');
  goog.require('goog.dom.pattern.callback.Counter');
  goog.require('goog.dom.pattern.callback.Test');


  function testMatcherAndStartTag() {
    var pattern = new goog.dom.pattern.StartTag('P');

    var counter = new goog.dom.pattern.callback.Counter();
    var matcher = new goog.dom.pattern.Matcher();
    matcher.addPattern(pattern, counter.getCallback());
    matcher.match(document.body);

    assertEquals('StartTag(p) should match 5 times in body', 5,
        counter.count);
  }

  function testMatcherAndStartTagTwice() {
    var pattern = new goog.dom.pattern.StartTag('P');

    var counter = new goog.dom.pattern.callback.Counter();
    var matcher = new goog.dom.pattern.Matcher();
    matcher.addPattern(pattern, counter.getCallback());
    matcher.match(document.body);

    assertEquals('StartTag(p) should match 5 times in body', 5,
        counter.count);

    // Make sure no state got mangled.
    counter.reset();
    matcher.match(document.body);

    assertEquals('StartTag(p) should match 5 times in body again', 5,
        counter.count);
  }

  function testMatcherAndStartTagAttributes() {
    var pattern = new goog.dom.pattern.StartTag('SPAN', {id: /./});

    var counter = new goog.dom.pattern.callback.Counter();
    var matcher = new goog.dom.pattern.Matcher();
    matcher.addPattern(pattern, counter.getCallback());
    matcher.match(document.body);

    assertEquals('StartTag(span,id) should match 2 times in body', 2,
        counter.count);
  }

  function testMatcherWithTwoPatterns() {
    var pattern1 = new goog.dom.pattern.StartTag('SPAN');
    var pattern2 = new goog.dom.pattern.StartTag('P');

    var counter = new goog.dom.pattern.callback.Counter();

    var matcher = new goog.dom.pattern.Matcher();
    matcher.addPattern(pattern1, counter.getCallback());
    matcher.addPattern(pattern2, counter.getCallback());

    matcher.match(document.body);

    assertEquals('StartTag(span|p) should match 8 times in body', 8,
        counter.count);
  }

  function testMatcherWithQuit() {
    var pattern1 = new goog.dom.pattern.StartTag('SPAN');
    var pattern2 = new goog.dom.pattern.StartTag('P');

    var count = 0;
    var callback = function(node, position) {
      if (node.nodeName == 'SPAN') {
        throw goog.iter.StopIteration;
        return true;
      }
      count++;
    };

    var matcher = new goog.dom.pattern.Matcher();
    matcher.addPattern(pattern1, callback);
    matcher.addPattern(pattern2, callback);

    matcher.match(document.body);

    assertEquals('Stopped span|p should match 1 time in body', 1, count);
  }

  function testMatcherWithReplace() {
    var pattern1 = new goog.dom.pattern.StartTag('B');
    var pattern2 = new goog.dom.pattern.StartTag('I');

    var count = 0;
    var callback = function(node, position) {
      count++;
      if (node.nodeName == 'B') {
        var i = goog.dom.createDom('I');
        node.parentNode.insertBefore(i, node);
        goog.dom.removeNode(node);

        position.setPosition(i);

        return true;
      }
    };

    var matcher = new goog.dom.pattern.Matcher();
    matcher.addPattern(pattern1, callback);
    matcher.addPattern(pattern2, callback);

    matcher.match(goog.dom.getElement('div1'));

    assertEquals('i|b->i should match 5 times in div1', 5, count);
  }

  function testMatcherAndFullTag() {
    var pattern = new goog.dom.pattern.FullTag('P');

    var test = new goog.dom.pattern.callback.Test();

    var matcher = new goog.dom.pattern.Matcher();
    matcher.addPattern(pattern, test.getCallback());

    matcher.match(goog.dom.getElement('p1'));

    assert('FullTag(p) should match on p1', test.matched);

    test.reset();
    matcher.match(goog.dom.getElement('div1'));

    assert('FullTag(p) should not match on div1', !test.matched);
  }

  function testMatcherAndSequence() {
    var pattern = new goog.dom.pattern.Sequence([
      new goog.dom.pattern.StartTag('P'),
      new goog.dom.pattern.StartTag('SPAN'),
      new goog.dom.pattern.EndTag('SPAN'),
      new goog.dom.pattern.EndTag('P')
    ], true);

    var counter = new goog.dom.pattern.callback.Counter();
    var matcher = new goog.dom.pattern.Matcher();
    matcher.addPattern(pattern, counter.getCallback());
    matcher.match(document.body);

    assertEquals('Sequence should match 1 times in body', 1, counter.count);
  }

  function testMatcherAndRepeatFullTag() {
    var pattern = new goog.dom.pattern.Repeat(
        new goog.dom.pattern.FullTag('P'), 1);

    var count = 0;
    var tcount = 0;
    var matcher = new goog.dom.pattern.Matcher();
    matcher.addPattern(pattern, function() {
      count++;
      tcount += pattern.count;
    });
    matcher.match(document.body);

    assertEquals('Repeated p should match 2 times in body', 2, count);
    assertEquals('Repeated p should match 5 total times in body', 5, tcount);
  }
">9 of 9 tests run in 12ms.<br />0 passed, 9 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testMatcherAndFullTag<br />FullTag(p) should match on p1<br />Call to assert(boolean) with false<br />> assert at testing/asserts.js:161:3<br />> testMatcherAndFullTag at _tmpclosuretest.js:133:5<br />ERROR in testMatcherAndRepeatFullTag<br />Repeated p should match 2 times in body<br />Expected <2> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testMatcherAndRepeatFullTag at _tmpclosuretest.js:170:5<br />ERROR in testMatcherAndSequence<br />Sequence should match 1 times in body<br />Expected <1> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testMatcherAndSequence at _tmpclosuretest.js:154:5<br />ERROR in testMatcherAndStartTag<br />StartTag(p) should match 5 times in body<br />Expected <5> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testMatcherAndStartTag at _tmpclosuretest.js:23:5<br />ERROR in testMatcherAndStartTagAttributes<br />StartTag(span,id) should match 2 times in body<br />Expected <2> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testMatcherAndStartTagAttributes at _tmpclosuretest.js:54:5<br />ERROR in testMatcherAndStartTagTwice<br />StartTag(p) should match 5 times in body<br />Expected <5> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testMatcherAndStartTagTwice at _tmpclosuretest.js:35:5<br />ERROR in testMatcherWithQuit<br />Stopped span|p should match 1 time in body<br />Expected <1> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testMatcherWithQuit at _tmpclosuretest.js:93:5<br />ERROR in testMatcherWithReplace<br />i|b->i should match 5 times in div1<br />Expected <5> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testMatcherWithReplace at _tmpclosuretest.js:120:5<br />ERROR in testMatcherWithTwoPatterns<br />StartTag(span|p) should match 8 times in body<br />Expected <8> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testMatcherWithTwoPatterns at _tmpclosuretest.js:70:5<br /></td></tr>
<tr><td>controlrange_test.html</td><td>Success</td><td> 12 passed, 0 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.ControlRange');
  goog.require('goog.dom.TextRange');
  goog.require('goog.testing.dom');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');


  var logo = goog.dom.getElement('logo');
  var table = goog.dom.getElement('table');

  function testCreateFromElement() {
    if (!goog.userAgent.IE) {
      return;
    }
    assertNotNull('Control range object can be created for element',
        goog.dom.ControlRange.createFromElements(logo));
  }

  function testCreateFromRange() {
    if (!goog.userAgent.IE) {
      return;
    }
    var range = document.body.createControlRange();
    range.addElement(table);
    assertNotNull('Control range object can be created for element',
        goog.dom.ControlRange.createFromBrowserRange(range));
  }

  function testSelect() {
    if (!goog.userAgent.IE) {
      return;
    }

    var range = goog.dom.ControlRange.createFromElements(table);
    range.select();

    assertEquals('Control range should be selected', 'Control',
        document.selection.type);
    assertEquals('Control range should have length 1', 1,
        document.selection.createRange().length);
    assertEquals('Control range should select table', table,
        document.selection.createRange().item(0));
  }

  function testControlRangeIterator() {
    if (!goog.userAgent.IE) {
      return;
    }
    var range = goog.dom.ControlRange.createFromElements(logo, table);
    // Each node is included twice - once as a start tag, once as an end.
    goog.testing.dom.assertNodesMatch(range, ['#logo', '#logo', '#table',
      '#tbody', '#tr1', '#td11', 'a', '#td11', '#td12', 'b', '#td12', '#tr1',
      '#tr2', '#td21', 'c', '#td21', '#td22', 'd', '#td22', '#tr2', '#tbody',
      '#table']);
  }

  function testBounds() {
    if (!goog.userAgent.IE) {
      return;
    }

    // Initialize in both orders.
    helpTestBounds(goog.dom.ControlRange.createFromElements(logo, table));
    helpTestBounds(goog.dom.ControlRange.createFromElements(table, logo));
  }

  function helpTestBounds(range) {
    assertEquals('Start node is logo', logo, range.getStartNode());
    assertEquals('Start offset is 0', 0, range.getStartOffset());
    assertEquals('End node is table', table, range.getEndNode());
    assertEquals('End offset is 1', 1, range.getEndOffset());
  }

  function testCollapse() {
    if (!goog.userAgent.IE) {
      return;
    }

    var range = goog.dom.ControlRange.createFromElements(logo, table);
    assertFalse('Not initially collapsed', range.isCollapsed());
    range.collapse();
    assertTrue('Successfully collapsed', range.isCollapsed());
  }

  function testGetContainer() {
    if (!goog.userAgent.IE) {
      return;
    }

    var range = goog.dom.ControlRange.createFromElements(logo);
    assertEquals('Single element range is contained by itself', logo,
        range.getContainer());

    range = goog.dom.ControlRange.createFromElements(logo, table);
    assertEquals('Two element range is contained by body', document.body,
        range.getContainer());
  }

  function testSave() {
    if (!goog.userAgent.IE) {
      return;
    }

    var range = goog.dom.ControlRange.createFromElements(logo, table);
    var savedRange = range.saveUsingDom();

    range.collapse();
    assertTrue('Successfully collapsed', range.isCollapsed());

    range = savedRange.restore();
    assertEquals('Restored a control range', goog.dom.RangeType.CONTROL,
        range.getType());
    assertFalse('Not collapsed after restore', range.isCollapsed());
    helpTestBounds(range);
  }

  function testRemoveContents() {
    if (!goog.userAgent.IE) {
      return;
    }

    var img = goog.dom.createDom('IMG');
    img.src = logo.src;

    var div = goog.dom.getElement('test1');
    div.innerHTML = '';
    div.appendChild(img);
    assertEquals('Div has 1 child', 1, div.childNodes.length);

    var range = goog.dom.ControlRange.createFromElements(img);
    range.removeContents();
    assertEquals('Div has 0 children', 0, div.childNodes.length);
    assertTrue('Range is collapsed', range.isCollapsed());
  }

  function testReplaceContents() {
    // Test a control range.
    if (!goog.userAgent.IE) {
      return;
    }

    var outer = goog.dom.getElement('test1');
    outer.innerHTML =
        '<div contentEditable="true">' +
        'Hello <input type="text" value="World">' +
        '</div>';
    range = goog.dom.ControlRange.createFromElements(
        outer.getElementsByTagName(goog.dom.TagName.INPUT)[0]);
    goog.dom.ControlRange.createFromElements(table)
    range.replaceContentsWithNode(goog.dom.createTextNode('World'));
    assertEquals('Hello World', outer.firstChild.innerHTML);
  }

  function testContainsRange() {
    if (!goog.userAgent.IE) {
      return;
    }

    var table2 = goog.dom.getElement('table2');
    var table2td = goog.dom.getElement('table2td');
    var logo2 = goog.dom.getElement('logo2');

    var range = goog.dom.ControlRange.createFromElements(logo, table);
    var range2 = goog.dom.ControlRange.createFromElements(logo);
    assertTrue('Control range contains the other control range',
            range.containsRange(range2));
    assertTrue('Control range partially contains the other control range',
            range2.containsRange(range, true));

    range2 = goog.dom.ControlRange.createFromElements(table2);
    assertFalse('Control range does not contain the other control range',
            range.containsRange(range2));

    range = goog.dom.ControlRange.createFromElements(table2);
    range2 = goog.dom.TextRange.createFromNodeContents(table2td);
    assertTrue('Control range contains text range',
            range.containsRange(range2));

    range2 = goog.dom.TextRange.createFromNodeContents(table);
    assertFalse('Control range does not contain text range',
            range.containsRange(range2));

    range = goog.dom.ControlRange.createFromElements(logo2);
    range2 = goog.dom.TextRange.createFromNodeContents(table2);
    assertFalse('Control range does not fully contain text range',
            range.containsRange(range2, false));

    range2 = goog.dom.ControlRange.createFromElements(table2);
    assertTrue('Control range contains the other control range (2)',
            range2.containsRange(range));
  }

  function testCloneRange() {
    if (!goog.userAgent.IE) {
      return;
    }
    var range = goog.dom.ControlRange.createFromElements(logo);
    assertNotNull('Control range object created for element', range);

    var cloneRange = range.clone();
    assertNotNull('Cloned control range object', cloneRange);
    assertArrayEquals('Control range and clone have same elements',
        range.getElements(), cloneRange.getElements());
  }

">n/a</td></tr>
<tr><td>fontsizemonitor_test.html</td><td>Fail</td><td> undefined</td><td title="


goog.require('goog.dom');
goog.require('goog.dom.FontSizeMonitor');
goog.require('goog.events');
goog.require('goog.testing.PropertyReplacer');
goog.require('goog.testing.events');
goog.require('goog.testing.jsunit');
goog.require('goog.userAgent');




function isBuggyGecko() {
  return goog.userAgent.GECKO && !goog.userAgent.isVersion('1.9');
}

var monitor;

function setUp() {
  monitor = new goog.dom.FontSizeMonitor();
}

function tearDown() {
  monitor.dispose();
}

function getResizeTarget() {
  return goog.userAgent.IE ? monitor.sizeElement_ :
        goog.dom.getFrameContentWindow(monitor.sizeElement_);
}

function testFontSizeNoChange() {
  // This tests that firing the resize event without changing the font-size
  // does not trigger the event.

  var fired = false;
  goog.events.listen(monitor, goog.dom.FontSizeMonitor.EventType.CHANGE,
                     function(e) {
                       fired = true;
                     });

  var resizeEvent = new goog.events.Event('resize', getResizeTarget());
  goog.testing.events.fireBrowserEvent(resizeEvent);

  assertFalse('The font size should not have changed', fired);
}

function testFontSizeChanged() {
  // One can trigger the iframe resize by changing the
  // document.body.style.fontSize but the event is fired asynchronously in
  // Firefox.  Instead, we just override the lastWidth_ to simulate that the
  // size changed.

  var fired = false;
  goog.events.listen(monitor, goog.dom.FontSizeMonitor.EventType.CHANGE,
                     function(e) {
                       fired = true;
                     });

  monitor.lastWidth_--;

  var resizeEvent = new goog.events.Event('resize', getResizeTarget());
  goog.testing.events.fireBrowserEvent(resizeEvent);

  assertTrue('The font size should have changed', fired);
}

function testCreateAndDispose() {
  var frameCount = window.frames.length;
  var iframeElementCount = document.getElementsByTagName('iframe').length;
  var divElementCount = document.getElementsByTagName('div').length;

  var monitor = new goog.dom.FontSizeMonitor();
  monitor.dispose();

  var newFrameCount = window.frames.length;
  var newIframeElementCount = document.getElementsByTagName('iframe').length;
  var newDivElementCount = document.getElementsByTagName('div').length;

  assertEquals('There should be no trailing frames',
               frameCount + isBuggyGecko(), newFrameCount);
  assertEquals('There should be no trailing iframe elements',
               iframeElementCount + isBuggyGecko(),
               newIframeElementCount);
  assertEquals('There should be no trailing div elements',
               divElementCount, newDivElementCount);
}

function testWithDomHelper() {
  var frameCount = window.frames.length;
  var iframeElementCount = document.getElementsByTagName('iframe').length;
  var divElementCount = document.getElementsByTagName('div').length;

  var monitor = new goog.dom.FontSizeMonitor(goog.dom.getDomHelper());

  var newFrameCount = window.frames.length;
  var newIframeElementCount = document.getElementsByTagName('iframe').length;
  var newDivElementCount = document.getElementsByTagName('div').length;

  if (goog.userAgent.IE) {
      assertEquals('There should be one new div element',
                 divElementCount + 1, newDivElementCount);
  } else {
    assertEquals('There should be one new frame',
                 frameCount + 1, newFrameCount);
    assertEquals('There should be one new iframe element',
                 iframeElementCount + 1, newIframeElementCount);
  }

  // Use the first iframe in the doc.  This is added in the HTML markup.
  var win = window.frames[0];
  var doc = win.document;
  doc.open();
  doc.write('<html><body></body></html>');
  doc.close();
  var domHelper = goog.dom.getDomHelper(doc);

  var frameCount2 = win.frames.length;
  var iframeElementCount2 = doc.getElementsByTagName('iframe').length;
  var divElementCount2 = doc.getElementsByTagName('div').length;

  var monitor2 = new goog.dom.FontSizeMonitor(domHelper);

  var newFrameCount2 = win.frames.length;
  var newIframeElementCount2 = doc.getElementsByTagName('iframe').length;
  var newDivElementCount2 = doc.getElementsByTagName('div').length;

  if (goog.userAgent.IE) {
    assertEquals('There should be one new div element',
                 divElementCount2 + 1, newDivElementCount2);
  } else {
    assertEquals('There should be one new frame', frameCount2 + 1,
                 newFrameCount2);
    assertEquals('There should be one new iframe element',
                 iframeElementCount2 + 1, newIframeElementCount2);
  }

  monitor.dispose();
  monitor2.dispose();
}

function testEnsureThatDocIsOpenedForGecko() {

  var pr = new goog.testing.PropertyReplacer();
  pr.set(goog.userAgent, 'GECKO', true);
  pr.set(goog.userAgent, 'IE', false);

  var openCalled = false;
  var closeCalled = false;
  var instance = {
    document: {
      open: function() {
        openCalled = true;
      },
      close: function() {
        closeCalled = true;
      }
    },
    attachEvent: function() {}
  };

  pr.set(goog.dom, 'getFrameContentWindow', function() {
    return instance;
  });

  try {
    var monitor = new goog.dom.FontSizeMonitor();

    assertTrue('doc.open should have been called', openCalled);
    assertTrue('doc.close should have been called', closeCalled);

    monitor.dispose();
  } finally {
    pr.reset();
  }
}

function testFirefox2WorkAroundFirefox3() {
  var pr = new goog.testing.PropertyReplacer();
  pr.set(goog.userAgent, 'GECKO', true);
  pr.set(goog.userAgent, 'IE', false);

  try {
    // 1.9 should clear iframes
    pr.set(goog.userAgent, 'VERSION', '1.9');
    goog.userAgent.isVersionCache_ = {};

    var frameCount = window.frames.length;
    var iframeElementCount = document.getElementsByTagName('iframe').length;
    var divElementCount = document.getElementsByTagName('div').length;

    var monitor = new goog.dom.FontSizeMonitor();
    monitor.dispose();

    var newFrameCount = window.frames.length;
    var newIframeElementCount = document.getElementsByTagName('iframe').length;
    var newDivElementCount = document.getElementsByTagName('div').length;

    assertEquals('There should be no trailing frames',
                 frameCount, newFrameCount);
    assertEquals('There should be no trailing iframe elements',
                 iframeElementCount,
                 newIframeElementCount);
    assertEquals('There should be no trailing div elements',
                 divElementCount, newDivElementCount);
  } finally {
    pr.reset();
  }
}


function testFirefox2WorkAroundFirefox2() {
  var pr = new goog.testing.PropertyReplacer();
  pr.set(goog.userAgent, 'GECKO', true);
  pr.set(goog.userAgent, 'IE', false);

  try {
    // 1.8 should NOT clear iframes
    pr.set(goog.userAgent, 'VERSION', '1.8');
    goog.userAgent.isVersionCache_ = {};

    var frameCount = window.frames.length;
    var iframeElementCount = document.getElementsByTagName('iframe').length;
    var divElementCount = document.getElementsByTagName('div').length;

    var monitor = new goog.dom.FontSizeMonitor();
    monitor.dispose();

    var newFrameCount = window.frames.length;
    var newIframeElementCount = document.getElementsByTagName('iframe').length;
    var newDivElementCount = document.getElementsByTagName('div').length;

    assertEquals('There should be no trailing frames',
                 frameCount + 1, newFrameCount);
    assertEquals('There should be no trailing iframe elements',
                 iframeElementCount + 1,
                 newIframeElementCount);
    assertEquals('There should be no trailing div elements',
                 divElementCount, newDivElementCount);
  } finally {
    pr.reset();
  }
}



    var operationAbortTester = new goog.dom.FontSizeMonitor();
    // Close script tag before disposing.
  

    operationAbortTester.dispose();
  ">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at [object Object].<anonymous> (dom/dom.js:2043:19)
    at new <anonymous> (dom/fontsizemonitor.js:60:27)
    at _tmpclosuretest.js:249:32
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
</td></tr>
<tr><td>forms_test.html</td><td>Fail</td><td> 8 passed, 37 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.forms');
  goog.require('goog.testing.jsunit');



  function testGetFormDataString() {
    var el = goog.dom.getElement('testform1');
    var result = goog.dom.forms.getFormDataString(el);
    assertEquals('in1=foo&in2=bar&in2=baaz&in3=&pass=bar&textarea=foo%20bar%20baz&select1=1&select2=a&select2=c&select3=&checkbox1=on&radio=X&radio2=Y', result);
  }

  function testGetFormDataMap() {
    var el = goog.dom.getElement('testform1');
    var result = goog.dom.forms.getFormDataMap(el);

    assertArrayEquals(['foo'], result.get('in1'));
    assertArrayEquals(['bar', 'baaz'], result.get('in2'));
    assertArrayEquals(['1'], result.get('select1'));
    assertArrayEquals(['a', 'c'], result.get('select2'));
    assertArrayEquals(['on'], result.get('checkbox1'));
    assertUndefined(result.get('select6'));
    assertUndefined(result.get('checkbox2'));
    assertArrayEquals(['X'], result.get('radio'));
    assertArrayEquals(['Y'], result.get('radio2'));
  }

  function testHasFileInput() {
    var el = goog.dom.getElement('testform1');
    assertFalse(goog.dom.forms.hasFileInput(el));
    el = goog.dom.getElement('testform2');
    assertTrue(goog.dom.forms.hasFileInput(el));
  }


  function testGetValueOnAtypicalValueElements() {
    var el = goog.dom.getElement('testdiv1');
    var result = goog.dom.forms.getValue(el);
    assertNull(result);
    var el = goog.dom.getElement('testfieldset1');
    var result = goog.dom.forms.getValue(el);
    assertNull(result);
    var el = goog.dom.getElement('testlegend1');
    var result = goog.dom.forms.getValue(el);
    assertNull(result);
  }

  function testHasValueInput() {
    var el = goog.dom.getElement('in1');
    var result = goog.dom.forms.hasValue(el);
    assertTrue(result);
  }

  function testHasValueByNameInput() {
    var form = goog.dom.getElement('testform1');
    var result = goog.dom.forms.hasValueByName(form, 'in1');
    assertTrue(result);
  }

  function testHasValueInputEmpty() {
    var el = goog.dom.getElement('in3');
    var result = goog.dom.forms.hasValue(el);
    assertFalse(result);
  }

  function testHasValueByNameEmpty() {
    var form = goog.dom.getElement('testform1');
    var result = goog.dom.forms.hasValueByName(form, 'in3');
    assertFalse(result);
  }

  function testHasValueRadio() {
    var el = goog.dom.getElement('radio1');
    var result = goog.dom.forms.hasValue(el);
    assertTrue(result);
  }

  function testHasValueByNameRadio() {
    var form = goog.dom.getElement('testform1');
    var result = goog.dom.forms.hasValueByName(form, 'radio');
    assertTrue(result);
  }

  function testHasValueRadioNotChecked() {
    var el = goog.dom.getElement('radio2');
    var result = goog.dom.forms.hasValue(el);
    assertFalse(result);
  }

  function testHasValueByNameRadioNotChecked() {
    var form = goog.dom.getElement('testform3');
    var result = goog.dom.forms.hasValueByName(form, 'radio3');
    assertFalse(result);
  }

  function testHasValueSelectSingle() {
    var el = goog.dom.getElement('select1');
    var result = goog.dom.forms.hasValue(el);
    assertTrue(result);
  }

  function testHasValueByNameSelectSingle() {
    var form = goog.dom.getElement('testform1');
    var result = goog.dom.forms.hasValueByName(form, 'select1');
    assertTrue(result);
  }

  function testHasValueSelectMultiple() {
    var el = goog.dom.getElement('select2');
    var result = goog.dom.forms.hasValue(el);
    assertTrue(result);
  }

  function testHasValueByNameSelectMultiple() {
    var form = goog.dom.getElement('testform1');
    var result = goog.dom.forms.hasValueByName(form, 'select2');
    assertTrue(result);
  }

  function testHasValueSelectNotSelected() {
    // select without value
    var el = goog.dom.getElement('select3');
    var result = goog.dom.forms.hasValue(el);
    assertFalse(result);
  }

  function testHasValueByNameSelectNotSelected() {
    var form = goog.dom.getElement('testform1');
    var result = goog.dom.forms.hasValueByName(form, 'select3');
    assertFalse(result);
  }

  function testHasValueSelectMultipleNotSelected() {
    var el = goog.dom.getElement('select6');
    var result = goog.dom.forms.hasValue(el);
    assertFalse(result);
  }

  function testHasValueByNameSelectMultipleNotSelected() {
    var form = goog.dom.getElement('testform3');
    var result = goog.dom.forms.hasValueByName(form, 'select6');
    assertFalse(result);
  }

  // TODO(user): make this a meaningful selenium test
  function testSetDisabledFalse() {
  }
  function testSetDisabledTrue() {
  }

  // TODO(user): make this a meaningful selenium test
  function testFocusAndSelect() {
    var el = goog.dom.getElement('in1');
    goog.dom.forms.focusAndSelect(el);
  }

  function testGetValueInput() {
    var el = goog.dom.getElement('in1');
    var result = goog.dom.forms.getValue(el);
    assertEquals('foo', result);
  }

  function testSetValueInput() {
    var el = goog.dom.getElement('in3');
    goog.dom.forms.setValue(el, 'foo');
    assertEquals('foo', goog.dom.forms.getValue(el));

    goog.dom.forms.setValue(el, 3500);
    assertEquals('3500', goog.dom.forms.getValue(el));

    goog.dom.forms.setValue(el, 0);
    assertEquals('0', goog.dom.forms.getValue(el));

    goog.dom.forms.setValue(el, null);
    assertEquals('', goog.dom.forms.getValue(el));

    goog.dom.forms.setValue(el, undefined);
    assertEquals('', goog.dom.forms.getValue(el));

    goog.dom.forms.setValue(el, false);
    assertEquals('false', goog.dom.forms.getValue(el));

    goog.dom.forms.setValue(el, {});
    assertEquals({}.toString(), goog.dom.forms.getValue(el));

    goog.dom.forms.setValue(el, {
      toString: function() {
        return 'test';
      }
    });
    assertEquals('test', goog.dom.forms.getValue(el));

    // unset
    goog.dom.forms.setValue(el);
    assertEquals('', goog.dom.forms.getValue(el));
  }

  function testGetValuePassword() {
    var el = goog.dom.getElement('pass');
    var result = goog.dom.forms.getValue(el);
    assertEquals('bar', result);
  }

  function testGetValueByNamePassword() {
    var form = goog.dom.getElement('testform1');
    var result = goog.dom.forms.getValueByName(form, 'pass');
    assertEquals('bar', result);
  }

  function testGetValueTextarea() {
    var el = goog.dom.getElement('textarea1');
    var result = goog.dom.forms.getValue(el);
    assertEquals('foo bar baz', result);
  }

  function testGetValueByNameTextarea() {
    var form = goog.dom.getElement('testform1');
    var result = goog.dom.forms.getValueByName(form, 'textarea1');
    assertEquals('foo bar baz', result);
  }

  function testSetValueTextarea() {
    var el = goog.dom.getElement('textarea2');
    goog.dom.forms.setValue(el, 'foo bar baz');
    var result = goog.dom.forms.getValue(el);
    assertEquals('foo bar baz', result);
  }

  function testGetValueSelectSingle() {
    var el = goog.dom.getElement('select1');
    var result = goog.dom.forms.getValue(el);
    assertEquals('1', result);
  }

  function testGetValueByNameSelectSingle() {
    var form = goog.dom.getElement('testform1');
    var result = goog.dom.forms.getValueByName(form, 'select1');
    assertEquals('1', result);
  }

  function testSetValueSelectSingle() {
    var el = goog.dom.getElement('select4');
    goog.dom.forms.setValue(el, '2');
    var result = goog.dom.forms.getValue(el);
    assertEquals('2', result);
    // unset
    goog.dom.forms.setValue(el);
    var result = goog.dom.forms.getValue(el);
    assertNull(result);
  }

  function testSetValueSelectSingleEmptyString() {
    var el = goog.dom.getElement('select7');
    // unset
    goog.dom.forms.setValue(el);
    var result = goog.dom.forms.getValue(el);
    assertNull(result);
    goog.dom.forms.setValue(el, '');
    result = goog.dom.forms.getValue(el);
    assertEquals('', result);
  }

  function testGetValueSelectMultiple() {
    var el = goog.dom.getElement('select2');
    var result = goog.dom.forms.getValue(el);
    assertArrayEquals(['a', 'c'], result);
  }

  function testGetValueSelectMultipleNotSelected() {
    var el = goog.dom.getElement('select6');
    var result = goog.dom.forms.getValue(el);
    assertNull(result);
  }

  function testGetValueByNameSelectMultiple() {
    var form = goog.dom.getElement('testform1');
    var result = goog.dom.forms.getValueByName(form, 'select2');
    assertArrayEquals(['a', 'c'], result);
  }

  function testSetValueSelectMultiple() {
    var el = goog.dom.getElement('select5');
    goog.dom.forms.setValue(el, ['a', 'c']);
    var result = goog.dom.forms.getValue(el);
    assertArrayEquals(['a', 'c'], result);

    goog.dom.forms.setValue(el, 'a');
    var result = goog.dom.forms.getValue(el);
    assertArrayEquals(['a'], result);

    // unset
    goog.dom.forms.setValue(el);
    var result = goog.dom.forms.getValue(el);
    assertNull(result);
  }

  function testGetValueCheckbox() {
    var el = goog.dom.getElement('checkbox1');
    var result = goog.dom.forms.getValue(el);
    assertEquals('on', result);
    var el = goog.dom.getElement('checkbox2');
    var result = goog.dom.forms.getValue(el);
    assertNull(result);
  }

  function testGetValueByNameCheckbox() {
    var form = goog.dom.getElement('testform1');
    var result = goog.dom.forms.getValueByName(form, 'checkbox1');
    assertEquals('on', result);
    result = goog.dom.forms.getValueByName(form, 'checkbox2');
    assertNull(result);
  }

  function testGetValueRadio() {
    var el = goog.dom.getElement('radio1');
    var result = goog.dom.forms.getValue(el);
    assertEquals('X', result);
    var el = goog.dom.getElement('radio2');
    var result = goog.dom.forms.getValue(el);
    assertNull(result);
  }

  function testGetValueByNameRadio() {
    var form = goog.dom.getElement('testform1');
    var result = goog.dom.forms.getValueByName(form, 'radio');
    assertEquals('X', result);

    result = goog.dom.forms.getValueByName(form, 'radio2');
    assertEquals('Y', result);
  }

  function testGetValueButton() {
    var el = goog.dom.getElement('button');
    var result = goog.dom.forms.getValue(el);
    assertEquals('button', result);
  }

  function testGetValueSubmit() {
    var el = goog.dom.getElement('submit');
    var result = goog.dom.forms.getValue(el);
    assertEquals('submit', result);
  }

  function testGetValueReset() {
    var el = goog.dom.getElement('reset');
    var result = goog.dom.forms.getValue(el);
    assertEquals('reset', result);
  }
">45 of 45 tests run in 36ms.<br />8 passed, 37 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testFocusAndSelect<br />Object #<Object> has no method 'focus'<br />ERROR in testGetFormDataMap<br />Cannot read property '0' of undefined<br />ERROR in testGetFormDataString<br />Cannot read property '0' of undefined<br />ERROR in testGetValueButton<br />Expected <button> (String) but was <null><br />> assertEquals at testing/asserts.js:289:3<br />> testGetValueButton at _tmpclosuretest.js:337:5<br />ERROR in testGetValueByNameCheckbox<br />Cannot read property 'checkbox1' of undefined<br />ERROR in testGetValueByNamePassword<br />Cannot read property 'pass' of undefined<br />ERROR in testGetValueByNameRadio<br />Cannot read property 'radio' of undefined<br />ERROR in testGetValueByNameSelectMultiple<br />Cannot read property 'select2' of undefined<br />ERROR in testGetValueByNameSelectSingle<br />Cannot read property 'select1' of undefined<br />ERROR in testGetValueByNameTextarea<br />Cannot read property 'textarea1' of undefined<br />ERROR in testGetValueCheckbox<br />Expected <on> (String) but was <null><br />> assertEquals at testing/asserts.js:289:3<br />> testGetValueCheckbox at _tmpclosuretest.js:302:5<br />ERROR in testGetValueInput<br />Expected <foo> (String) but was <null><br />> assertEquals at testing/asserts.js:289:3<br />> testGetValueInput at _tmpclosuretest.js:162:5<br />ERROR in testGetValuePassword<br />Expected <bar> (String) but was <null><br />> assertEquals at testing/asserts.js:289:3<br />> testGetValuePassword at _tmpclosuretest.js:203:5<br />ERROR in testGetValueRadio<br />Expected <X> (String) but was <null><br />> assertEquals at testing/asserts.js:289:3<br />> testGetValueRadio at _tmpclosuretest.js:319:5<br />ERROR in testGetValueReset<br />Expected <reset> (String) but was <null><br />> assertEquals at testing/asserts.js:289:3<br />> testGetValueReset at _tmpclosuretest.js:349:5<br />ERROR in testGetValueSelectMultiple<br />Expected an array for assertArrayEquals but found a Null<br />> assertArrayEquals at testing/asserts.js:626:3<br />> testGetValueSelectMultiple at _tmpclosuretest.js:268:5<br />ERROR in testGetValueSelectSingle<br />Expected <1> (String) but was <null><br />> assertEquals at testing/asserts.js:289:3<br />> testGetValueSelectSingle at _tmpclosuretest.js:234:5<br />ERROR in testGetValueSubmit<br />Expected <submit> (String) but was <null><br />> assertEquals at testing/asserts.js:289:3<br />> testGetValueSubmit at _tmpclosuretest.js:343:5<br />ERROR in testGetValueTextarea<br />Expected <foo bar baz> (String) but was <null><br />> assertEquals at testing/asserts.js:289:3<br />> testGetValueTextarea at _tmpclosuretest.js:215:5<br />ERROR in testHasFileInput<br />Cannot read property '0' of undefined<br />ERROR in testHasValueByNameEmpty<br />Cannot read property 'in3' of undefined<br />ERROR in testHasValueByNameInput<br />Cannot read property 'in1' of undefined<br />ERROR in testHasValueByNameRadio<br />Cannot read property 'radio' of undefined<br />ERROR in testHasValueByNameRadioNotChecked<br />Cannot read property 'radio3' of undefined<br />ERROR in testHasValueByNameSelectMultiple<br />Cannot read property 'select2' of undefined<br />ERROR in testHasValueByNameSelectMultipleNotSelected<br />Cannot read property 'select6' of undefined<br />ERROR in testHasValueByNameSelectNotSelected<br />Cannot read property 'select3' of undefined<br />ERROR in testHasValueByNameSelectSingle<br />Cannot read property 'select1' of undefined<br />ERROR in testHasValueInput<br />Call to assertTrue(boolean) with false<br />> assertTrue at testing/asserts.js:261:3<br />> testHasValueInput at _tmpclosuretest.js:53:5<br />ERROR in testHasValueRadio<br />Call to assertTrue(boolean) with false<br />> assertTrue at testing/asserts.js:261:3<br />> testHasValueRadio at _tmpclosuretest.js:77:5<br />ERROR in testHasValueSelectMultiple<br />Call to assertTrue(boolean) with false<br />> assertTrue at testing/asserts.js:261:3<br />> testHasValueSelectMultiple at _tmpclosuretest.js:113:5<br />ERROR in testHasValueSelectSingle<br />Call to assertTrue(boolean) with false<br />> assertTrue at testing/asserts.js:261:3<br />> testHasValueSelectSingle at _tmpclosuretest.js:101:5<br />ERROR in testSetValueInput<br />Expected <foo> (String) but was <null><br />> assertEquals at testing/asserts.js:289:3<br />> testSetValueInput at _tmpclosuretest.js:168:5<br />ERROR in testSetValueSelectMultiple<br />Expected an array for assertArrayEquals but found a Null<br />> assertArrayEquals at testing/asserts.js:626:3<br />> testSetValueSelectMultiple at _tmpclosuretest.js:287:5<br />ERROR in testSetValueSelectSingle<br />Expected <2> (String) but was <null><br />> assertEquals at testing/asserts.js:289:3<br />> testSetValueSelectSingle at _tmpclosuretest.js:247:5<br />ERROR in testSetValueSelectSingleEmptyString<br />Expected <> (String) but was <null><br />> assertEquals at testing/asserts.js:289:3<br />> testSetValueSelectSingleEmptyString at _tmpclosuretest.js:262:5<br />ERROR in testSetValueTextarea<br />Expected <foo bar baz> (String) but was <null><br />> assertEquals at testing/asserts.js:289:3<br />> testSetValueTextarea at _tmpclosuretest.js:228:5<br /></td></tr>
<tr><td>dom_quirks_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.array');
  goog.require('goog.dom');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');

">0 of 0 tests run in 2ms.<br />No tests found.  Call G_testRunner.setStrict(false) if this is expected behavior.<br /></td></tr>
<tr><td>a11y_test.html</td><td>Fail</td><td> 0 passed, 3 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.dom.a11y');
    goog.require('goog.dom.a11y.Role');
    goog.require('goog.dom.a11y.State');
    goog.require('goog.testing.jsunit');
    goog.require('goog.userAgent');
  

    var sandbox = goog.dom.getElement('sandbox');
    var someDiv;
    var someSpan;

    function setUp() {
      someDiv = goog.dom.createDom('div', {id: 'someDiv'}, 'DIV');
      someSpan = goog.dom.createDom('span', {id: 'someSpan'}, 'SPAN');
      sandbox.appendChild(someDiv);
      someDiv.appendChild(someSpan);
    }
    
    function tearDown() {
      sandbox.innerHTML = '';
      someDiv = null;
      someSpan = null;
    }

    function testGetSetRole() {
      assertEquals('someDiv\'s role should be the empty string',
          '', goog.dom.a11y.getRole(someDiv));
      assertEquals('someSpan\'s role should be the empty string',
          '', goog.dom.a11y.getRole(someSpan));

      goog.dom.a11y.setRole(someDiv, goog.dom.a11y.Role.MENU);
      goog.dom.a11y.setRole(someSpan, goog.dom.a11y.Role.MENU_ITEM);

      assertEquals('someDiv\'s role should be MENU',
            goog.dom.a11y.Role.MENU, goog.dom.a11y.getRole(someDiv));
      assertEquals('someSpan\'s role should be MENU_ITEM',
            goog.dom.a11y.Role.MENU_ITEM, goog.dom.a11y.getRole(someSpan));
    }

    function testGetSetState() {
      assertEquals('someDiv\'s state should be the empty string',
          '', goog.dom.a11y.getState(someDiv));

      goog.dom.a11y.setState(someDiv, goog.dom.a11y.State.LABELLEDBY,
          'someSpan');

      assertEquals(
          'someDiv\'s labelledby state should be "someSpan"',
          'someSpan',
          goog.dom.a11y.getState(someDiv, goog.dom.a11y.State.LABELLEDBY));
    }

    function testGetSetActiveDescendant() {
      goog.dom.a11y.setActiveDescendant(someDiv, null);
      assertNull('someDiv\'s activedescendant should be null',
          goog.dom.a11y.getActiveDescendant(someDiv));

      goog.dom.a11y.setActiveDescendant(someDiv, someSpan);

      assertEquals(
          'someDiv\'s active descendant should be "someSpan"',
          someSpan,
          goog.dom.a11y.getActiveDescendant(someDiv));
    }
  ">3 of 3 tests run in 11ms.<br />0 passed, 3 failed.<br />4 ms/test. 1 files loaded.<br />ERROR in testGetSetActiveDescendant<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetSetRole<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetSetState<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>classes_test.html</td><td>Fail</td><td> 8 passed, 1 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.classes');
  goog.require('goog.testing.jsunit');



  var $ = goog.dom.getElement;
  var classes = goog.dom.classes;

  function testSetAddHasRemove() {
    var el = $('p1');
    classes.set(el, 'someclass');
    assertTrue('Should have someclass', classes.has(el, 'someclass'));

    classes.set(el, 'otherclass');
    assertTrue('Should have otherclass', classes.has(el, 'otherclass'));
    assertFalse('Should not have someclass', classes.has(el, 'someclass'));

    classes.add(el, 'wooclass');
    assertTrue('Should have otherclass', classes.has(el, 'otherclass'));
    assertTrue('Should have wooclass', classes.has(el, 'wooclass'));

    classes.add(el, 'aclass', 'bclass', 'cclass');
    assertTrue('Should have otherclass', classes.has(el, 'otherclass'));
    assertTrue('Should have wooclass', classes.has(el, 'wooclass'));
    assertTrue('Should have aclass', classes.has(el, 'aclass'));
    assertTrue('Should have bclass', classes.has(el, 'bclass'));
    assertTrue('Should have cclass', classes.has(el, 'cclass'));

    classes.remove(el, 'cclass');
    assertTrue('Should have otherclass', classes.has(el, 'otherclass'));
    assertTrue('Should have wooclass', classes.has(el, 'wooclass'));
    assertTrue('Should have aclass', classes.has(el, 'aclass'));
    assertTrue('Should have bclass', classes.has(el, 'bclass'));
    assertFalse('Should not have cclass', classes.has(el, 'cclass'));

    classes.remove(el, 'aclass', 'bclass');
    assertTrue('Should have otherclass', classes.has(el, 'otherclass'));
    assertTrue('Should have wooclass', classes.has(el, 'wooclass'));
    assertFalse('Should not have aclass', classes.has(el, 'aclass'));
    assertFalse('Should not have bclass', classes.has(el, 'bclass'));
  }

  function testSwap() {
    var el = $('p1');
    classes.set(el, 'someclass first');

    assertTrue('Should have first class', classes.has(el, 'first'));
    assertTrue('Should have first class', classes.has(el, 'someclass'));
    assertFalse('Should not have second class', classes.has(el, 'second'));

    classes.swap(el, 'first', 'second');

    assertFalse('Should not have first class', classes.has(el, 'first'));
    assertTrue('Should have first class', classes.has(el, 'someclass'));
    assertTrue('Should have second class', classes.has(el, 'second'));

    classes.swap(el, 'second', 'first');

    assertTrue('Should have first class', classes.has(el, 'first'));
    assertTrue('Should have first class', classes.has(el, 'someclass'));
    assertFalse('Should not have second class', classes.has(el, 'second'));
  }

  function testEnable() {
    var el = $('p1');
    classes.set(el, 'someclass first');

    assertTrue('Should have first class', classes.has(el, 'first'));
    assertTrue('Should have someclass class', classes.has(el, 'someclass'));

    classes.enable(el, 'first', false);

    assertFalse('Should not have first class', classes.has(el, 'first'));
    assertTrue('Should have someclass class', classes.has(el, 'someclass'));

    classes.enable(el, 'first', true);

    assertTrue('Should have first class', classes.has(el, 'first'));
    assertTrue('Should have someclass class', classes.has(el, 'someclass'));
  }

  function testToggle() {
    var el = $('p1');
    classes.set(el, 'someclass first');

    assertTrue('Should have first class', classes.has(el, 'first'));
    assertTrue('Should have someclass class', classes.has(el, 'someclass'));

    classes.toggle(el, 'first');

    assertFalse('Should not have first class', classes.has(el, 'first'));
    assertTrue('Should have someclass class', classes.has(el, 'someclass'));

    classes.toggle(el, 'first');

    assertTrue('Should have first class', classes.has(el, 'first'));
    assertTrue('Should have someclass class', classes.has(el, 'someclass'));
  }

  function testAddNotAddingMultiples() {
    var el = $('span6');
    classes.add(el, 'a');
    assertEquals('a', el.className);
    classes.add(el, 'a');
    assertEquals('a', el.className);
    classes.add(el, 'b', 'b');
    assertEquals('a b', el.className);
  }

  function testAddRemoveString() {
    var el = $('span6');
    el.className = 'a';

    goog.dom.classes.addRemove(el, 'a', 'b');
    assertEquals('b', el.className);

    goog.dom.classes.addRemove(el, null, 'c');
    assertEquals('b c', el.className);

    goog.dom.classes.addRemove(el, 'c', 'd');
    assertEquals('b d', el.className);

    goog.dom.classes.addRemove(el, 'd', null);
    assertEquals('b', el.className);
  }

  function testAddRemoveArray() {
    var el = $('span6');
    el.className = 'a';

    goog.dom.classes.addRemove(el, ['a'], ['b']);
    assertEquals('b', el.className);

    goog.dom.classes.addRemove(el, [], ['c']);
    assertEquals('b c', el.className);

    goog.dom.classes.addRemove(el, ['c'], ['d']);
    assertEquals('b d', el.className);

    goog.dom.classes.addRemove(el, ['d'], []);
    assertEquals('b', el.className);
  }

  function testAddRemoveMultiple() {
    var el = $('span6');
    el.className = 'a';

    goog.dom.classes.addRemove(el, ['a'], ['b', 'c', 'd']);
    assertEquals('b c d', el.className);

    goog.dom.classes.addRemove(el, [], ['e', 'f']);
    assertEquals('b c d e f', el.className);

    goog.dom.classes.addRemove(el, ['c', 'e'], []);
    assertEquals('b d f', el.className);

    goog.dom.classes.addRemove(el, ['b'], ['g']);
    assertEquals('d f g', el.className);
  }

  function testHasWithNewlines() {
    var el = $('p3');
    assertTrue('Should have someclass', classes.has(el, 'someclass'));
    assertTrue('Should also have otherclass', classes.has(el, 'otherclass'));
    assertFalse('Should not have weirdclass', classes.has(el, 'weirdclass'));
  }

">9 of 9 tests run in 15ms.<br />8 passed, 1 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testHasWithNewlines<br />Should have someclass<br />Call to assertTrue(boolean) with false<br />> assertTrue at testing/asserts.js:261:3<br />> testHasWithNewlines at _tmpclosuretest.js:166:5<br /></td></tr>
<tr><td>savedcaretrange_test.html</td><td>Fail</td><td> 0 passed, 5 failed.</td><td title="

  goog.require('goog.userAgent');
  goog.require('goog.dom');
  goog.require('goog.dom.Range');
  goog.require('goog.testing.dom');
  goog.require('goog.testing.jsunit');


  /** @bug 1480638 */
  function testSavedCaretRangeDoesntChangeSelection() {
    // NOTE(nicksantos): We cannot detect this bug programatically. The only
    // way to detect it is to run this test manually and look at the selection
    // when it ends.
    var div = goog.dom.getElement('bug1480638');
    var range = goog.dom.Range.createFromNodes(
        div.firstChild, 0, div.lastChild, 1);
    range.select();

    // Observe visible selection.  Then move to next line and see it change.
    // If the bug exists, it starts with "foo" selected and ends with
    // it not selected.
    //debugger;
    var saved = range.saveUsingCarets();
  }

  function testSavedCaretRange() {
    var parent = goog.dom.getElement('caretRangeTest');
    var def = goog.dom.getElement('def');
    var jkl = goog.dom.getElement('jkl');

    var range = goog.dom.Range.createFromNodes(
        def.firstChild, 1, jkl.firstChild, 2);
    range.select();

    var saved = range.saveUsingCarets();
    assertHTMLEquals(
        "d<span id='" + saved.startCaretId_ + "'></span>ef", def.innerHTML);
    assertHTMLEquals(
        "jk<span id='" + saved.endCaretId_ + "'></span>l", jkl.innerHTML);

    goog.testing.dom.assertRangeEquals(
        def.childNodes[1], 0, jkl.childNodes[1], 0,
        saved.toAbstractRange());

    def = goog.dom.getElement('def');
    jkl = goog.dom.getElement('jkl');

    var restoredRange = clearSelectionAndRestoreSaved(parent, saved);
    goog.testing.dom.assertRangeEquals(
        def, 1, jkl, 1, restoredRange);

    var selection = goog.dom.Range.createFromWindow(window);
    assertHTMLEquals('def', def.innerHTML);
    assertHTMLEquals('jkl', jkl.innerHTML);

    // def and jkl now contain fragmented text nodes.
    if (goog.userAgent.WEBKIT || goog.userAgent.IE) {
      goog.testing.dom.assertRangeEquals(
          def.childNodes[1], 0, jkl.childNodes[0], 2, selection);
    } else if (goog.userAgent.OPERA) {
      goog.testing.dom.assertRangeEquals(
          def.childNodes[1], 0, jkl.childNodes[1], 0, selection);
    } else {
      goog.testing.dom.assertRangeEquals(
          def, 1, jkl, 1, selection);
    }
  }


  /*
  TODO(user): Look into why removeCarets test doesn't pass.
  function testRemoveCarets() {
    var def = goog.dom.getElement('def');
    var jkl = goog.dom.getElement('jkl');

    var range = goog.dom.Range.createFromNodes(
        def.firstChild, 1, jkl.firstChild, 2);
    range.select();

    var saved = range.saveUsingCarets();
    assertHTMLEquals(
        "d<span id='" + saved.startCaretId_ + "'></span>ef", def.innerHTML);
    assertHTMLEquals(
        "jk<span id='" + saved.endCaretId_ + "'></span>l", jkl.innerHTML);

    saved.removeCarets();
    assertHTMLEquals("def", def.innerHTML);
    assertHTMLEquals("jkl", jkl.innerHTML);

    var selection = goog.dom.Range.createFromWindow(window);

    assertEquals('Wrong start node', def.firstChild, selection.getStartNode());
    assertEquals('Wrong end node', jkl.firstChild, selection.getEndNode());
    assertEquals('Wrong start offset', 1, selection.getStartOffset());
    assertEquals('Wrong end offset', 2, selection.getEndOffset());
  }
*/

  function testRemoveContents()  {
    var def = goog.dom.getElement('def-4');
    var jkl = goog.dom.getElement('jkl-4');

    // Sanity check.
    var container = goog.dom.getElement('removeContentsTest');
    assertEquals(7, container.childNodes.length);
    assertEquals('def', def.innerHTML);
    assertEquals('jkl', jkl.innerHTML);

    var range = goog.dom.Range.createFromNodes(
        def.firstChild, 1, jkl.firstChild, 2);
    range.select();

    var saved = range.saveUsingCarets();
    var restored = saved.restore();
      restored.removeContents();

    assertEquals(6, container.childNodes.length);
    assertEquals('d', def.innerHTML);
    assertEquals('l', jkl.innerHTML);
  }

  function testHtmlEqual() {
    var parent = goog.dom.getElement('caretRangeTest-2');
    var def = goog.dom.getElement('def-2');
    var jkl = goog.dom.getElement('jkl-2');

    var range = goog.dom.Range.createFromNodes(
        def.firstChild, 1, jkl.firstChild, 2);
    range.select();
    var saved = range.saveUsingCarets();
    var html1 = parent.innerHTML;
    saved.removeCarets();

    var saved2 = range.saveUsingCarets();
    var html2 = parent.innerHTML;
    saved2.removeCarets();

    assertNotEquals('Same selection with different saved caret range carets ' +
        'must have different html.', html1, html2);

    assertTrue('Same selection with different saved caret range carets must ' +
        'be considered equal by htmlEqual',
        goog.dom.SavedCaretRange.htmlEqual(html1, html2));

    saved.dispose();
    saved2.dispose();
  }

  function testStartCaretIsAtEndOfParent() {
    var parent = goog.dom.getElement('caretRangeTest-3');
    var def = goog.dom.getElement('def-3');
    var jkl = goog.dom.getElement('jkl-3');

    var range = goog.dom.Range.createFromNodes(
        def, 1, jkl, 1);
    range.select();
    var saved = range.saveUsingCarets();
    clearSelectionAndRestoreSaved(parent, saved);
    range = goog.dom.Range.createFromWindow();
    assertEquals('ghijkl', range.getText().replace(/\s/g, ''));
  }

  /**
   * Clear the selection by re-parsing the DOM. Then restore the saved
   * selection.
   * @param {Node} parent The node containing the current selection.
   * @param {goog.dom.SavedRange} saved The saved range.
   * @return {goog.dom.AbstractRange} Restored range.
   */
  function clearSelectionAndRestoreSaved(parent, saved) {
    goog.dom.Range.clearSelection();
    assertFalse(goog.dom.Range.hasSelection(window));
    var range = saved.restore();
    assertTrue(goog.dom.Range.hasSelection(window));
    return range;
  }
">5 of 5 tests run in 9ms.<br />0 passed, 5 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testHtmlEqual<br />Cannot read property 'tagName' of undefined<br />ERROR in testRemoveContents<br />Cannot read property 'length' of undefined<br />ERROR in testSavedCaretRange<br />Cannot read property 'tagName' of undefined<br />ERROR in testSavedCaretRangeDoesntChangeSelection<br />Cannot read property 'tagName' of undefined<br />ERROR in testStartCaretIsAtEndOfParent<br />Cannot call method 'createRange' of undefined<br /></td></tr>
<tr><td>abstractrange_test.html</td><td>Fail</td><td> 0 passed, 2 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.AbstractRange');
  goog.require('goog.dom.Range');

  goog.require('goog.testing.jsunit');


  function testCorrectDocument() {
    var a = goog.dom.getElement('a').contentWindow;
    var b = goog.dom.getElement('b').contentWindow;

    a.document.body.focus();
    var selection = goog.dom.AbstractRange.getBrowserSelectionForWindow(a);
    assertNotNull('Selection must not be null', selection);
    var range = goog.dom.Range.createFromBrowserSelection(selection);
    assertEquals('getBrowserSelectionForWindow must return selection in the ' +
                 'correct document', a.document, range.getDocument());

    // This is intended to trip up Internet Explorer --
    // see http://b/2048934
    b.document.body.focus();
    selection = goog.dom.AbstractRange.getBrowserSelectionForWindow(a);
    // Some (non-IE) browsers keep a separate selection state for each document
    // in the same browser window. That's fine, as long as the selection object
    // requested from the window object is correctly associated with that
    // window's document.
    if (selection) {
      range = goog.dom.Range.createFromBrowserSelection(selection);
      assertEquals('getBrowserSelectionForWindow must return selection in ' +
                   'the correct document', a.document, range.getDocument());
    } else {
      assertNull(selection);
    }
  }

  function testSelectionIsControlRange() {
    var c = goog.dom.getElement('c').contentWindow;
    // Only IE supports control ranges
    if (c.document.body.createControlRange) {
      var controlRange = c.document.body.createControlRange();
      controlRange.add(c.document.getElementsByTagName('img')[0]);
      controlRange.select();
      var selection = goog.dom.AbstractRange.getBrowserSelectionForWindow(c);
      assertNotNull('Selection must not be null', selection);
    }
  }
">2 of 2 tests run in 5ms.<br />0 passed, 2 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testCorrectDocument<br />Cannot read property 'document' of undefined<br />ERROR in testSelectionIsControlRange<br />Cannot read property 'document' of undefined<br /></td></tr>
<tr><td>dom_test.js</td><td>Fail</td><td> undefined</td><td title="// Copyright 2009 The Closure Library Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS-IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Shared code for dom_test.html and dom_quirks_test.html.
 */

goog.provide('goog.dom.dom_test');

goog.require('goog.dom');
goog.require('goog.dom.DomHelper');
goog.require('goog.dom.NodeType');
goog.require('goog.dom.TagName');
goog.require('goog.testing.asserts');
goog.require('goog.userAgent');
goog.require('goog.userAgent.product');
goog.require('goog.userAgent.product.isVersion');

var $ = goog.dom.getElement;

// Setup for the iframe
var myIframe = $('myIframe');
var myIframeDoc = goog.dom.getFrameContentDocument(
    /** @type {HTMLIFrameElement} */ (myIframe));

// Set up document for iframe: total height of elements in document is 65
// If the elements are not create like below, IE will get a wrong height for
// the document.
myIframeDoc.open();
// Make sure we progate the compat mode
myIframeDoc.write((goog.dom.isCss1CompatMode() ? '<!DOCTYPE html>' : '') +
    '<style>body{margin:0;padding:0}</style>' +
    '<div style="height:42px;font-size:1px;line-height:0;">hello world</div>' +
    '<div style="height:23px;font-size:1px;line-height:0;">hello world</div>');
myIframeDoc.close();

function testDom() {
  assert('Dom library exists', typeof goog.dom != 'undefined');
}

function testGetElement() {
  var el = $('testEl');
  assertEquals('Should be able to get id', el.id, 'testEl');

  assertEquals($, goog.dom.getElement);
  assertEquals(goog.dom.$, goog.dom.getElement);
}

function testGetElementsByTagNameAndClass() {
  assertEquals('Should get 6 spans',
      goog.dom.getElementsByTagNameAndClass('span').length, 6);
  assertEquals('Should get 6 spans',
      goog.dom.getElementsByTagNameAndClass('SPAN').length, 6);
  assertEquals('Should get 3 spans',
      goog.dom.getElementsByTagNameAndClass('span', 'test1').length, 3);
  assertEquals('Should get 1 span',
      goog.dom.getElementsByTagNameAndClass('span', 'test2').length, 1);
  assertEquals('Should get 1 span',
      goog.dom.getElementsByTagNameAndClass('SPAN', 'test2').length, 1);
  assertEquals('Should get lots of elements',
      goog.dom.getElementsByTagNameAndClass().length,
      document.getElementsByTagName('*').length);

  assertEquals('Should get 1 span',
      goog.dom.getElementsByTagNameAndClass('span', null, $('testEl')).length,
      1);

  // '*' as the tag name should be equivalent to all tags
  var container = goog.dom.getElement('span-container');
  assertEquals(5,
      goog.dom.getElementsByTagNameAndClass('*', undefined, container).length);
  assertEquals(3,
      goog.dom.getElementsByTagNameAndClass('*', 'test1', container).length);
  assertEquals(1,
      goog.dom.getElementsByTagNameAndClass('*', 'test2', container).length);

  // Some version of WebKit have problems with mixed-case class names
  assertEquals(1,
      goog.dom.getElementsByTagNameAndClass(
          undefined, 'mixedCaseClass').length);

  // Make sure that out of bounds indices are OK
  assertUndefined(
      goog.dom.getElementsByTagNameAndClass(undefined, 'noSuchClass')[0]);

  assertEquals(goog.dom.getElementsByTagNameAndClass,
      goog.dom.getElementsByTagNameAndClass);
}

function testGetElementsByClass() {
  assertEquals(3, goog.dom.getElementsByClass('test1').length);
  assertEquals(1, goog.dom.getElementsByClass('test2').length);
  assertEquals(0, goog.dom.getElementsByClass('nonexistant').length);

  var container = goog.dom.getElement('span-container');
  assertEquals(3, goog.dom.getElementsByClass('test1', container).length);
}

function testGetElementByClass() {
  assertNotNull(goog.dom.getElementByClass('test1'));
  assertNotNull(goog.dom.getElementByClass('test2'));
  // assertNull(goog.dom.getElementByClass('nonexistant'));

  var container = goog.dom.getElement('span-container');
  assertNotNull(goog.dom.getElementByClass('test1', container));
}

function testSetProperties() {
  var attrs = { 'name': 'test3', 'title': 'A title', 'random': 'woop' };
  var el = $('testEl');

  var res = goog.dom.setProperties(el, attrs);
  assertEquals('Should be equal', el.name, 'test3');
  assertEquals('Should be equal', el.title, 'A title');
  assertEquals('Should be equal', el.random, 'woop');
}

function testSetPropertiesDirectAttributeMap() {
  var attrs = {'usemap': '#myMap'};
  var el = goog.dom.createDom('img');

  var res = goog.dom.setProperties(el, attrs);
  assertEquals('Should be equal', '#myMap', el.getAttribute('usemap'));
}

function testSetTableProperties() {
  var attrs = {
    'style': 'padding-left: 10px;',
    'class': 'mytestclass',
    'height': '101',
    'cellpadding': '15'
  };
  var el = $('testTable1');

  var res = goog.dom.setProperties(el, attrs);
  assertEquals('Should be equal', el.style.paddingLeft, '10px');
  assertEquals('Should be equal', el.className, 'mytestclass');
  assertEquals('Should be equal', el.getAttribute('height'), '101');
  assertEquals('Should be equal', el.cellPadding, '15');
}

function testGetViewportSize() {
  // TODO: This is failing in the test runner now, fix later.
  //var dims = getViewportSize();
  //assertNotUndefined('Should be defined at least', dims.width);
  //assertNotUndefined('Should be defined at least', dims.height);
}

function testGetViewportSizeInIframe() {
  var iframe = /** @type {HTMLIFrameElement} */ (goog.dom.getElement('iframe'));
  var contentDoc = goog.dom.getFrameContentDocument(iframe);
  contentDoc.write('<body></body>');

  var outerSize = goog.dom.getViewportSize();
  var innerSize = (new goog.dom.DomHelper(contentDoc)).getViewportSize();
  assert('Viewport sizes must not match',
      innerSize.width != outerSize.width);
}

function testGetDocumentHeightInIframe() {
  var doc = goog.dom.getDomHelper(myIframeDoc).getDocument();
  var height = goog.dom.getDomHelper(myIframeDoc).getDocumentHeight();

  // Broken in webkit quirks mode and in IE8
  if ((goog.dom.isCss1CompatMode_(doc) || !goog.userAgent.WEBKIT) &&
      !isIE8()) {
    assertEquals('height should be 65', 42 + 23, height);
  }
}

function testCreateDom() {
  var el = goog.dom.$dom('div',
      {
        style: 'border: 1px solid black; width: 50%; background-color: #EEE;',
        onclick: "alert('woo')"
      },
      goog.dom.$dom('p', {style: 'font: normal 12px arial; color: red; '},
                    'Para 1'),
      goog.dom.$dom('p', {style: 'font: bold 18px garamond; color: blue; '},
                    'Para 2'),
      goog.dom.$dom('p', {style: 'font: normal 24px monospace; color: green'},
                    'Para 3 ',
                    goog.dom.$dom('a', {
                      name: 'link', href: 'http://bbc.co.uk'
                    },
                    'has a link'),
                    ', how cool is this?'));

  assertEquals('Tagname should be a DIV', 'DIV', el.tagName);
  assertEquals('Style width should be 50%', '50%', el.style.width);
  assertEquals('first child is a P tag', 'P', el.childNodes[0].tagName);
  assertEquals('second child .innerHTML', 'Para 2',
               el.childNodes[1].innerHTML);

  assertEquals(goog.dom.$dom, goog.dom.createDom);
}

function testCreateDomNoChildren() {
  var el;

  // Test unspecified children.
  el = goog.dom.$dom('div');
  assertNull('firstChild should be null', el.firstChild);

  // Test null children.
  el = goog.dom.$dom('div', null, null);
  assertNull('firstChild should be null', el.firstChild);

  // Test empty array of children.
  el = goog.dom.$dom('div', null, []);
  assertNull('firstChild should be null', el.firstChild);
}

function testCreateDomAcceptsArray() {
  var items = [
    goog.dom.$dom('li', {}, 'Item 1'),
    goog.dom.$dom('li', {}, 'Item 2')
  ];
  var ul = goog.dom.$dom('ul', {}, items);
  assertEquals('List should have two children', 2, ul.childNodes.length);
  assertEquals('First child should be an LI tag',
      'LI', ul.firstChild.tagName);
  assertEquals('Item 1', ul.childNodes[0].innerHTML);
  assertEquals('Item 2', ul.childNodes[1].innerHTML);
}

function testCreateDomStringArg() {
  var el;

  // Test string arg.
  el = goog.dom.$dom('div', null, 'Hello');
  assertEquals('firstChild should be a text node', goog.dom.NodeType.TEXT,
      el.firstChild.nodeType);
  assertEquals('firstChild should have node value "Hello"', 'Hello',
      el.firstChild.nodeValue);

  // Test text node arg.
  el = goog.dom.$dom('div', null, goog.dom.createTextNode('World'));
  assertEquals('firstChild should be a text node', goog.dom.NodeType.TEXT,
      el.firstChild.nodeType);
  assertEquals('firstChild should have node value "World"', 'World',
      el.firstChild.nodeValue);
}

function testCreateDomNodeListArg() {
  var el;
  var emptyElem = goog.dom.$dom('div');
  var simpleElem = goog.dom.$dom('div', null, 'Hello, world!');
  var complexElem = goog.dom.$dom('div', null, 'Hello, ',
                                  goog.dom.$dom('b', null, 'world'),
      goog.dom.createTextNode('!'));

  // Test empty node list.
  el = goog.dom.$dom('div', null, emptyElem.childNodes);
  assertNull('emptyElem.firstChild should be null', emptyElem.firstChild);
  assertNull('firstChild should be null', el.firstChild);

  // Test simple node list.
  el = goog.dom.$dom('div', null, simpleElem.childNodes);
  assertNull('simpleElem.firstChild should be null', simpleElem.firstChild);
  assertEquals('firstChild should be a text node with value "Hello, world!"',
      'Hello, world!', el.firstChild.nodeValue);

  // Test complex node list.
  el = goog.dom.$dom('div', null, complexElem.childNodes);
  assertNull('complexElem.firstChild should be null', complexElem.firstChild);
  assertEquals('Element should have 3 child nodes', 3, el.childNodes.length);
  assertEquals('childNodes[0] should be a text node with value "Hello, "',
      'Hello, ', el.childNodes[0].nodeValue);
  assertEquals('childNodes[1] should be an element node with tagName "B"',
      'B', el.childNodes[1].tagName);
  assertEquals('childNodes[2] should be a text node with value "!"', '!',
      el.childNodes[2].nodeValue);
}

function testCreateDomWithTypeAttribute() {
  var el = goog.dom.createDom('button', {'type': 'reset', 'id': 'cool-button'},
      'Cool button');
  assertNotNull('Button with type attribute was created successfully', el);
  assertEquals('Button has correct type attribute', 'reset', el.type);
  assertEquals('Button has correct id', 'cool-button', el.id);
}

function testCreateDomWithClassList() {
  var el = goog.dom.createDom('div', ['foo', 'bar']);
  assertEquals('foo bar', el.className);

  el = goog.dom.createDom('div', ['foo', 'foo']);
  assertEquals('foo', el.className);
}

function testContains() {
  assertTrue('HTML should contain BODY', goog.dom.contains(
      document.documentElement, document.body));
  assertTrue('Document should contain BODY', goog.dom.contains(
      document, document.body));

  var d = goog.dom.$dom('p', null, 'A paragraph');
  var t = d.firstChild;
  assertTrue('Same element', goog.dom.contains(d, d));
  assertTrue('Same text', goog.dom.contains(t, t));
  assertTrue('Nested text', goog.dom.contains(d, t));
  assertFalse('Nested text, reversed', goog.dom.contains(t, d));
  assertFalse('Disconnected element', goog.dom.contains(
      document, d));
  goog.dom.appendChild(document.body, d);
  assertTrue('Connected element', goog.dom.contains(
      document, d));
  goog.dom.removeNode(d);
}

function testCreateDomWithClassName() {
  var el = goog.dom.$dom('div', 'cls');
  assertNull('firstChild should be null', el.firstChild);
  assertEquals('Tagname should be a DIV', 'DIV', el.tagName);
  assertEquals('ClassName should be cls', 'cls', el.className);

  el = goog.dom.$dom('div', '');
  assertEquals('ClassName should be empty', '', el.className);
}

function testCompareNodeOrder() {
  var b1 = $('b1');
  var b2 = $('b2');
  var p2 = $('p2');

  assertEquals('equal nodes should compare to 0', 0,
      goog.dom.compareNodeOrder(b1, b1));

  assertTrue('parent should come before child',
      goog.dom.compareNodeOrder(p2, b1) < 0);
  assertTrue('child should come after parent',
      goog.dom.compareNodeOrder(b1, p2) > 0);

  assertTrue('parent should come before text child',
      goog.dom.compareNodeOrder(b1, b1.firstChild) < 0);
  assertTrue('text child should come after parent', goog.dom.compareNodeOrder(
      b1.firstChild, b1) > 0);

  assertTrue('first sibling should come before second',
      goog.dom.compareNodeOrder(b1, b2) < 0);
  assertTrue('second sibling should come after first',
      goog.dom.compareNodeOrder(b2, b1) > 0);

  assertTrue('text node after cousin element returns correct value',
      goog.dom.compareNodeOrder(b1.nextSibling, b1) > 0);
  assertTrue('text node before cousin element returns correct value',
      goog.dom.compareNodeOrder(b1, b1.nextSibling) < 0);

  assertTrue('text node is before once removed cousin element',
      goog.dom.compareNodeOrder(b1.firstChild, b2) < 0);
  assertTrue('once removed cousin element is before text node',
      goog.dom.compareNodeOrder(b2, b1.firstChild) > 0);

  assertTrue('text node is after once removed cousin text node',
      goog.dom.compareNodeOrder(b1.nextSibling, b1.firstChild) > 0);
  assertTrue('once removed cousin text node is before text node',
      goog.dom.compareNodeOrder(b1.firstChild, b1.nextSibling) < 0);

  assertTrue('first text node is before second text node',
      goog.dom.compareNodeOrder(b1.previousSibling, b1.nextSibling) < 0);
  assertTrue('second text node is after first text node',
      goog.dom.compareNodeOrder(b1.nextSibling, b1.previousSibling) > 0);

  assertTrue('grandchild is after grandparent',
      goog.dom.compareNodeOrder(b1.firstChild, b1.parentNode) > 0);
  assertTrue('grandparent is after grandchild',
      goog.dom.compareNodeOrder(b1.parentNode, b1.firstChild) < 0);

  assertTrue('grandchild is after grandparent',
      goog.dom.compareNodeOrder(b1.firstChild, b1.parentNode) > 0);
  assertTrue('grandparent is after grandchild',
      goog.dom.compareNodeOrder(b1.parentNode, b1.firstChild) < 0);

  assertTrue('second cousins compare correctly',
      goog.dom.compareNodeOrder(b1.firstChild, b2.firstChild) < 0);
  assertTrue('second cousins compare correctly in reverse',
      goog.dom.compareNodeOrder(b2.firstChild, b1.firstChild) > 0);

  assertTrue('testEl2 is after testEl',
      goog.dom.compareNodeOrder($('testEl2'), $('testEl')) > 0);
  assertTrue('testEl is before testEl2',
      goog.dom.compareNodeOrder($('testEl'), $('testEl2')) < 0);

  var p = $('order-test');
  var text1 = document.createTextNode('1');
  p.appendChild(text1);
  var text2 = document.createTextNode('1');
  p.appendChild(text2);

  assertEquals('Equal text nodes should compare to 0', 0,
      goog.dom.compareNodeOrder(text1, text1));
  assertTrue('First text node is before second',
      goog.dom.compareNodeOrder(text1, text2) < 0);
  assertTrue('Second text node is after first',
      goog.dom.compareNodeOrder(text2, text1) > 0);
  assertTrue('Late text node is after b1',
      goog.dom.compareNodeOrder(text1, $('b1')) > 0);
}

function testFindCommonAncestor() {
  var b1 = $('b1');
  var b2 = $('b2');
  var p1 = $('p1');
  var p2 = $('p2');
  var testEl2 = $('testEl2');

  assertNull('findCommonAncestor() = null', goog.dom.findCommonAncestor());
  assertEquals('findCommonAncestor(b1) = b1', b1,
      goog.dom.findCommonAncestor(b1));
  assertEquals('findCommonAncestor(b1, b1) = b1', b1,
      goog.dom.findCommonAncestor(b1, b1));
  assertEquals('findCommonAncestor(b1, b2) = p2', p2,
      goog.dom.findCommonAncestor(b1, b2));
  assertEquals('findCommonAncestor(p1, b2) = body', document.body,
      goog.dom.findCommonAncestor(p1, b2));
  assertEquals('findCommonAncestor(testEl2, b1, b2, p1, p2) = body',
      document.body, goog.dom.findCommonAncestor(testEl2, b1, b2, p1, p2));

  var outOfDoc = document.createElement('div');
  assertNull('findCommonAncestor(outOfDoc, b1) = null',
      goog.dom.findCommonAncestor(outOfDoc, b1));
}

function testRemoveNode() {
  var b = document.createElement('b');
  var el = $('p1');
  el.appendChild(b);
  goog.dom.removeNode(b);
  assertTrue('b should have been removed', el.lastChild != b);
}

function testReplaceNode() {
  var n = $('toReplace');
  var previousSibling = n.previousSibling;
  var goodNode = goog.dom.createDom('div', {'id': 'goodReplaceNode'});
  goog.dom.replaceNode(goodNode, n);

  assertEquals('n should have been replaced', previousSibling.nextSibling,
      goodNode);
  assertNull('n should no longer be in the DOM tree', $('toReplace'));

  var badNode = goog.dom.createDom('div', {'id': 'badReplaceNode'});
  goog.dom.replaceNode(badNode, n);
  assertNull('badNode should not be in the DOM tree', $('badReplaceNode'));
}

function testFlattenElement() {
  var text = document.createTextNode('Text');
  var br = document.createElement('br');
  var span = goog.dom.createDom('span', null, text, br);
  assertEquals('span should have 2 children', 2, span.childNodes.length);

  var el = $('p1');
  el.appendChild(span);

  var ret = goog.dom.flattenElement(span);

  assertTrue('span should have been removed', el.lastChild != span);
  assertFalse('span should have no parent', !!span.parentNode &&
      span.parentNode.nodeType != goog.dom.NodeType.DOCUMENT_FRAGMENT);
  assertEquals('span should have no children', 0, span.childNodes.length);
  assertEquals('Last child of p should be br', br, el.lastChild);
  assertEquals('Previous sibling of br should be text', text,
      br.previousSibling);

  var outOfDoc = goog.dom.createDom('span', null, '1 child');
  // Should do nothing.
  goog.dom.flattenElement(outOfDoc);
  assertEquals('outOfDoc should still have 1 child', 1,
      outOfDoc.childNodes.length);
}

function testIsNodeLike() {
  assertTrue('document should be node like', goog.dom.isNodeLike(document));
  assertTrue('document.body should be node like',
             goog.dom.isNodeLike(document.body));
  assertTrue('a text node should be node like', goog.dom.isNodeLike(
      document.createTextNode('')));

  assertFalse('null should not be node like', goog.dom.isNodeLike(null));
  assertFalse('a string should not be node like', goog.dom.isNodeLike('abcd'));

  assertTrue('custom object should be node like',
             goog.dom.isNodeLike({nodeType: 1}));
}

function testIsWindow() {
  var global = goog.global;
  var frame = window.frames['frame'];
  var otherWindow = window.open('', 'blank');
  var object = {window: goog.global};
  var nullVar = null;
  var notDefined;

  try {
    // Use try/finally to ensure that we clean up the window we open, even if an
    // assertion fails or something else goes wrong.
    assertTrue('global object in HTML context should be a window',
               goog.dom.isWindow(goog.global));
    assertTrue('iframe window should be a window', goog.dom.isWindow(frame));
    if (otherWindow) {
      assertTrue('other window should be a window',
                 goog.dom.isWindow(otherWindow));
    }
    assertFalse('object should not be a window', goog.dom.isWindow(object));
    assertFalse('null should not be a window', goog.dom.isWindow(nullVar));
    assertFalse('undefined should not be a window',
                goog.dom.isWindow(notDefined));
  } finally {
    if (otherWindow) {
      otherWindow.close();
    }
  }
}

function testGetOwnerDocument() {
  assertEquals(goog.dom.getOwnerDocument($('p1')), document);
  assertEquals(goog.dom.getOwnerDocument(document.body), document);
  assertEquals(goog.dom.getOwnerDocument(document.documentElement), document);
}

function testDomHelper() {
  var x = new goog.dom.DomHelper(window.frames['frame'].document);
  assertTrue('Should have some HTML',
             x.getDocument().body.innerHTML.length > 0);
}

function testGetFirstElementChild() {
  var p2 = $('p2');
  var b1 = goog.dom.getFirstElementChild(p2);
  assertNotNull('First element child of p2 should not be null', b1);
  assertEquals('First element child is b1', 'b1', b1.id);

  var c = goog.dom.getFirstElementChild(b1);
  assertNull('First element child of b1 should be null', c);
}

function testGetLastElementChild() {
  var p2 = $('p2');
  var b2 = goog.dom.getLastElementChild(p2);
  assertNotNull('Last element child of p2 should not be null', b2);
  assertEquals('Last element child is b2', 'b2', b2.id);

  var c = goog.dom.getLastElementChild(b2);
  assertNull('Last element child of b2 should be null', c);
}

function testGetNextElementSibling() {
  var b1 = $('b1');
  var b2 = goog.dom.getNextElementSibling(b1);
  assertNotNull('Next element sibling of b1 should not be null', b1);
  assertEquals('Next element sibling is b2', 'b2', b2.id);

  var c = goog.dom.getNextElementSibling(b2);
  assertNull('Next element sibling of b2 should be null', c);
}

function testGetPreviousElementSibling() {
  var b2 = $('b2');
  var b1 = goog.dom.getPreviousElementSibling(b2);
  assertNotNull('Previous element sibling of b2 should not be null', b1);
  assertEquals('Previous element sibling is b1', 'b1', b1.id);

  var c = goog.dom.getPreviousElementSibling(b1);
  assertNull('Previous element sibling of b1 should be null', c);
}

function testGetNextNode() {
  var tree = goog.dom.htmlToDocumentFragment(
      '<div>' +
      '<p>Some text</p>' +
      '<blockquote>Some <i>special</i> <b>text</b></blockquote>' +
      '<address><!-- comment -->Foo</address>' +
      '</div>');

  assertNull(goog.dom.getNextNode(null));

  var node = tree;
  var next = function() {
    return node = goog.dom.getNextNode(node);
  };

  assertEquals('P', next().tagName);
  assertEquals('Some text', next().nodeValue);
  assertEquals('BLOCKQUOTE', next().tagName);
  assertEquals('Some ', next().nodeValue);
  assertEquals('I', next().tagName);
  assertEquals('special', next().nodeValue);
  assertEquals(' ', next().nodeValue);
  assertEquals('B', next().tagName);
  assertEquals('text', next().nodeValue);
  assertEquals('ADDRESS', next().tagName);
  assertEquals(goog.dom.NodeType.COMMENT, next().nodeType);
  assertEquals('Foo', next().nodeValue);

  assertNull(next());
}

function testGetPreviousNode() {
  var tree = goog.dom.htmlToDocumentFragment(
      '<div>' +
      '<p>Some text</p>' +
      '<blockquote>Some <i>special</i> <b>text</b></blockquote>' +
      '<address><!-- comment -->Foo</address>' +
      '</div>');

  assertNull(goog.dom.getPreviousNode(null));

  var node = tree.lastChild.lastChild;
  var previous = function() {
    return node = goog.dom.getPreviousNode(node);
  };

  assertEquals(goog.dom.NodeType.COMMENT, previous().nodeType);
  assertEquals('ADDRESS', previous().tagName);
  assertEquals('text', previous().nodeValue);
  assertEquals('B', previous().tagName);
  assertEquals(' ', previous().nodeValue);
  assertEquals('special', previous().nodeValue);
  assertEquals('I', previous().tagName);
  assertEquals('Some ', previous().nodeValue);
  assertEquals('BLOCKQUOTE', previous().tagName);
  assertEquals('Some text', previous().nodeValue);
  assertEquals('P', previous().tagName);
  assertEquals('DIV', previous().tagName);

  if (!goog.userAgent.IE) {
    // Internet Explorer maintains a parentNode for Elements after they are
    // removed from the hierarchy. Everyone else agrees on a null parentNode.
    assertNull(previous());
  }
}

function testSetTextContent() {
  var p1 = $('p1');
  var s = 'hello world';
  goog.dom.setTextContent(p1, s);
  assertEquals('We should have one childNode after setTextContent', 1,
      p1.childNodes.length);
  assertEquals(s, p1.firstChild.data);
  assertEquals(s, p1.innerHTML);

  s = 'four elefants < five ants';
  var sHtml = 'four elefants &lt; five ants';
  goog.dom.setTextContent(p1, s);
  assertEquals('We should have one childNode after setTextContent', 1,
      p1.childNodes.length);
  assertEquals(s, p1.firstChild.data);
  assertEquals(sHtml, p1.innerHTML);

  // ensure that we remove existing children
  p1.innerHTML = 'a<b>b</b>c';
  s = 'hello world';
  goog.dom.setTextContent(p1, s);
  assertEquals('We should have one childNode after setTextContent', 1,
      p1.childNodes.length);
  assertEquals(s, p1.firstChild.data);

  // same but start with an element
  p1.innerHTML = '<b>a</b>b<i>c</i>';
  s = 'hello world';
  goog.dom.setTextContent(p1, s);
  assertEquals('We should have one childNode after setTextContent', 1,
      p1.childNodes.length);
  assertEquals(s, p1.firstChild.data);

  // clean up
  p1.innerHTML = '';
}

function testFindNode() {
  var expected = document.body;
  var result = goog.dom.findNode(document, function(n) {
    return n.nodeType == goog.dom.NodeType.ELEMENT && n.tagName == 'BODY';
  });
  assertEquals(expected, result);

  expected = document.getElementsByTagName('P')[0];
  result = goog.dom.findNode(document, function(n) {
    return n.nodeType == goog.dom.NodeType.ELEMENT && n.tagName == 'P';
  });
  assertEquals(expected, result);

  result = goog.dom.findNode(document, function(n) {
    return false;
  });
  assertUndefined(result);
}

function testFindNodes() {
  var expected = document.getElementsByTagName('P');
  var result = goog.dom.findNodes(document, function(n) {
    return n.nodeType == goog.dom.NodeType.ELEMENT && n.tagName == 'P';
  });
  assertEquals(expected.length, result.length);
  assertEquals(expected[0], result[0]);
  assertEquals(expected[1], result[1]);

  result = goog.dom.findNodes(document, function(n) {
    return false;
  }).length;
  assertEquals(0, result);
}

function createTestDom(txt) {
  var dom = goog.dom.createDom('div');
  dom.innerHTML = txt;
  return dom;
}

function testIsFocusableTabIndex() {
  assertFalse('isFocusableTabIndex() must be false for no tab index',
      goog.dom.isFocusableTabIndex(goog.dom.getElement('noTabIndex')));
  assertFalse('isFocusableTabIndex() must be false for tab index -2',
      goog.dom.isFocusableTabIndex(goog.dom.getElement('tabIndexNegative2')));
  assertFalse('isFocusableTabIndex() must be false for tab index -1',
      goog.dom.isFocusableTabIndex(goog.dom.getElement('tabIndexNegative1')));

  // WebKit on Mac doesn't support focusable DIVs until version 526 and later.
  if (!goog.userAgent.WEBKIT || !goog.userAgent.MAC ||
      goog.userAgent.isVersion('526')) {
    assertTrue('isFocusableTabIndex() must be true for tab index 0',
        goog.dom.isFocusableTabIndex(goog.dom.getElement('tabIndex0')));
    assertTrue('isFocusableTabIndex() must be true for tab index 1',
        goog.dom.isFocusableTabIndex(goog.dom.getElement('tabIndex1')));
    assertTrue('isFocusableTabIndex() must be true for tab index 2',
        goog.dom.isFocusableTabIndex(goog.dom.getElement('tabIndex2')));
  }
}

function testSetFocusableTabIndex() {
  // WebKit on Mac doesn't support focusable DIVs until version 526 and later.
  if (!goog.userAgent.WEBKIT || !goog.userAgent.MAC ||
      goog.userAgent.isVersion('526')) {
    // Test enabling focusable tab index.
    goog.dom.setFocusableTabIndex(goog.dom.getElement('noTabIndex'), true);
    assertTrue('isFocusableTabIndex() must be true after enabling tab index',
        goog.dom.isFocusableTabIndex(goog.dom.getElement('noTabIndex')));

    // Test disabling focusable tab index that was added programmatically.
    goog.dom.setFocusableTabIndex(goog.dom.getElement('noTabIndex'), false);
    assertFalse('isFocusableTabIndex() must be false after disabling tab ' +
        'index that was programmatically added',
        goog.dom.isFocusableTabIndex(goog.dom.getElement('noTabIndex')));

    // Test disabling focusable tab index that was specified in markup.
    goog.dom.setFocusableTabIndex(goog.dom.getElement('tabIndex0'), false);
    assertFalse('isFocusableTabIndex() must be false after disabling tab ' +
        'index that was specified in markup',
        goog.dom.isFocusableTabIndex(goog.dom.getElement('tabIndex0')));

    // Test re-enabling focusable tab index.
    goog.dom.setFocusableTabIndex(goog.dom.getElement('tabIndex0'), true);
    assertTrue('isFocusableTabIndex() must be true after reenabling tabindex',
        goog.dom.isFocusableTabIndex(goog.dom.getElement('tabIndex0')));
  }
}

function testGetTextContent() {
  function t(inp, out) {
    assertEquals(out.replace(/ /g, '_'),
                 goog.dom.getTextContent(
                     createTestDom(inp)).replace(/ /g, '_'));
  }

  t('abcde', 'abcde');
  t('a<b>bcd</b>efgh', 'abcdefgh');
  t('a<script type="text/javascript' + '">var a=1;<' + '/script>h', 'ah');
  t('<html><head><style type="text/css">' +
    'p{margin:100%;padding:5px}\n.class{background-color:red;}</style>' +
    '</head><body><h1>Hello</h1>\n<p>One two three</p>\n<table><tr><td>a' +
    '<td>b</table><' + 'script>var a = \'foo\';' +
    '</scrip' + 't></body></html>', 'HelloOne two threeab');
  t('abc<br>def', 'abc\ndef');
  t('abc<br>\ndef', 'abc\ndef');
  t('abc<br>\n\ndef', 'abc\ndef');
  t('abc<br><br>\ndef', 'abc\n\ndef');
  t(' <b>abcde  </b>   ', 'abcde ');
  t(' <b>abcde    </b> hi  ', 'abcde hi ');
  t(' \n<b>abcde  </b>   ', 'abcde ');
  t(' \n<b>abcde  </b>   \n\n\n', 'abcde ');
  t('<p>abcde</p>\nfg', 'abcdefg');
  t('\n <div>  <b>abcde  </b>   ', 'abcde ');
  t(' \n&shy;<b>abcde &shy; </b>   \n\n\n&shy;', 'abcde ');
  t(' \n&shy;\n\n&shy;\na   ', 'a ');
  t(' \n<wbr></wbr><b>abcde <wbr></wbr> </b>   \n\n\n<wbr></wbr>', 'abcde ');
  t('a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b',
      goog.userAgent.IE ? 'a     b' : 'a\xA0\xA0\xA0\xA0\xA0b');
}

function testGetNodeTextLength() {

  assertEquals(6, goog.dom.getNodeTextLength(createTestDom('abcdef')));
  assertEquals(8, goog.dom.getNodeTextLength(
      createTestDom('a<b>bcd</b>efgh')));
  assertEquals(2, goog.dom.getNodeTextLength(createTestDom(
      'a<script type="text/javascript' + '">var a = 1234;<' + '/script>h')));
  assertEquals(4, goog.dom.getNodeTextLength(createTestDom(
      'a<br>\n<!-- some comments -->\nfo')));
  assertEquals(20, goog.dom.getNodeTextLength(createTestDom(
      '<html><head><style type="text/css">' +
      'p{margin:100%;padding:5px}\n.class{background-color:red;}</style>' +
      '</head><body><h1>Hello</h1><p>One two three</p><table><tr><td>a<td>b' +
      '</table><' + 'script>var a = \'foo\';</scrip' +
      't></body></html>')));
  assertEquals(10, goog.dom.getNodeTextLength(createTestDom(
      'a<b>bcd</b><br />efghi')));
}

function testGetNodeTextOffset() {
  assertEquals(4, goog.dom.getNodeTextOffset($('offsetTest1'),
                                             $('offsetParent1')));
  assertEquals(12, goog.dom.getNodeTextOffset($('offsetTest1')));
}

function testGetNodeAtOffset() {
  var html = '<div id=a>123<b id=b>45</b><span id=c>67<b id=d>89<i id=e>01' +
             '</i>23<i id=f>45</i>67</b>890<i id=g>123</i><b id=h>456</b>' +
             '</span></div><div id=i>7890<i id=j>123</i></div>';
  var node = document.createElement('div');
  node.innerHTML = html;
  var rv = {};

  goog.dom.getNodeAtOffset(node, 2, rv);
  assertEquals('123', rv.node.nodeValue);
  assertEquals('a', rv.node.parentNode.id);
  assertEquals(1, rv.remainder);

  goog.dom.getNodeAtOffset(node, 3, rv);
  assertEquals('123', rv.node.nodeValue);
  assertEquals('a', rv.node.parentNode.id);
  assertEquals(2, rv.remainder);

  goog.dom.getNodeAtOffset(node, 5, rv);
  assertEquals('45', rv.node.nodeValue);
  assertEquals('b', rv.node.parentNode.id);
  assertEquals(1, rv.remainder);

  goog.dom.getNodeAtOffset(node, 6, rv);
  assertEquals('67', rv.node.nodeValue);
  assertEquals('c', rv.node.parentNode.id);
  assertEquals(0, rv.remainder);

  goog.dom.getNodeAtOffset(node, 23, rv);
  assertEquals('123', rv.node.nodeValue);
  assertEquals('g', rv.node.parentNode.id);
  assertEquals(2, rv.remainder);

  goog.dom.getNodeAtOffset(node, 30, rv);
  assertEquals('7890', rv.node.nodeValue);
  assertEquals('i', rv.node.parentNode.id);
  assertEquals(3, rv.remainder);

}

// IE inserts line breaks and capitalizes nodenames.
function assertEqualsCaseAndLeadingWhitespaceInsensitive(value1, value2) {
  value1 = value1.replace(/^\s+|\s+$/g, '').toLowerCase();
  value2 = value2.replace(/^\s+|\s+$/g, '').toLowerCase();
  assertEquals(value1, value2);
}

function testGetOuterHtml() {
  var contents = '<b>foo</b>';
  var node = document.createElement('div');
  node.setAttribute('foo', 'bar');
  node.innerHTML = contents;
  assertEqualsCaseAndLeadingWhitespaceInsensitive(
      goog.dom.getOuterHtml(node), '<div foo="bar">' + contents + '</div>');

  var imgNode = document.createElement('img');
  imgNode.setAttribute('foo', 'bar');
  assertEqualsCaseAndLeadingWhitespaceInsensitive(
      goog.dom.getOuterHtml(imgNode), '<img foo="bar">');
}


function testGetWindowFrame() {
  var frameWindow = window.frames['frame'];
  var frameDocument = frameWindow.document;
  var frameDomHelper = new goog.dom.DomHelper(frameDocument);

  // Cannot use assertEquals since IE fails on ===
  assertTrue(frameWindow == frameDomHelper.getWindow());
}

function testGetWindow() {
  var domHelper = new goog.dom.DomHelper();
  // Cannot use assertEquals since IE fails on ===
  assertTrue(window == domHelper.getWindow());
}

function testGetWindowStatic() {
  // Cannot use assertEquals since IE fails on ===
  assertTrue(window == goog.dom.getWindow());
}

function testIsNodeList() {
  var elem = document.getElementById('p2');
  var text = document.getElementById('b2').firstChild;

  assertTrue('NodeList should be a node list',
      goog.dom.isNodeList(elem.childNodes));
  assertFalse('TextNode should not be a node list',
      goog.dom.isNodeList(text));
  assertFalse('Array of nodes should not be a node list',
      goog.dom.isNodeList([elem.firstChild, elem.lastChild]));
}

function testGetFrameContentDocument() {
  var iframe = document.getElementsByTagName('iframe')[0];
  var name = iframe.name;
  var iframeDoc = goog.dom.getFrameContentDocument(iframe);
  assertEquals(window.frames[name].document, iframeDoc);
}

function testGetFrameContentWindow() {
  var iframe = document.getElementsByTagName('iframe')[0];
  var name = iframe.name;
  var iframeWin = goog.dom.getFrameContentWindow(iframe);
  assertEquals(window.frames[name], iframeWin);
}

function testCanHaveChildren() {
  for (var tag in goog.dom.TagName) {
    var expected = true;
    switch (tag) {
      case goog.dom.TagName.BASE:
      case goog.dom.TagName.APPLET:
      case goog.dom.TagName.AREA:
      case goog.dom.TagName.BR:
      case goog.dom.TagName.COL:
      case goog.dom.TagName.FRAME:
      case goog.dom.TagName.HR:
      case goog.dom.TagName.IMG:
      case goog.dom.TagName.INPUT:
      case goog.dom.TagName.IFRAME:
      case goog.dom.TagName.ISINDEX:
      case goog.dom.TagName.LINK:
      case goog.dom.TagName.NOFRAMES:
      case goog.dom.TagName.NOSCRIPT:
      case goog.dom.TagName.META:
      case goog.dom.TagName.OBJECT:
      case goog.dom.TagName.PARAM:
      case goog.dom.TagName.SCRIPT:
      case goog.dom.TagName.STYLE:
        expected = false;
        break;
    }
    var node = goog.dom.createDom(tag);
    assertEquals(tag + ' should ' + (expected ? '' : 'not ') +
        'have children', expected, goog.dom.canHaveChildren(node));

    // Make sure we can _actually_ add a child if we identify the node as
    // allowing children.
    if (goog.dom.canHaveChildren(node)) {
      node.appendChild(goog.dom.createDom('div', null, 'foo'));
    }
  }
}

function testGetAncestorNoMatch() {
  var elem = goog.dom.getElement('nestedElement');
  assertNull(goog.dom.getAncestor(elem, function() {return false;}));
}

function testGetAncestorMatchSelf() {
  var elem = goog.dom.getElement('nestedElement');
  var matched = goog.dom.getAncestor(elem, function() {return true;}, true);
  assertEquals(elem, matched);
}

function testGetAncestorNoMatchSelf() {
  var elem = goog.dom.getElement('nestedElement');
  var matched = goog.dom.getAncestor(elem, function() {return true;});
  assertEquals(elem.parentNode, matched);
}

function testGetAncestorWithMaxSearchStepsMatchSelf()  {
  var elem = goog.dom.getElement('nestedElement');
  var matched = goog.dom.getAncestor(
      elem, function() {return true;}, true, 2);
  assertEquals(elem, matched);
}

function testGetAncestorWithMaxSearchStepsMatch() {
  var elem = goog.dom.getElement('nestedElement');
  var searchEl = elem.parentNode.parentNode;
  var matched = goog.dom.getAncestor(
      elem, function(el) {return el == searchEl;}, false, 1);
  assertEquals(searchEl, matched);
}

function testGetAncestorWithMaxSearchStepsNoMatch() {
  var elem = goog.dom.getElement('nestedElement');
  var searchEl = elem.parentNode.parentNode;
  var matched = goog.dom.getAncestor(
      elem, function(el) {return el == searchEl;}, false, 0);
  assertNull(matched);
}

function testGetAncestorByTagNameNoMatch() {
  var elem = goog.dom.getElement('nestedElement');
  assertNull(
      goog.dom.getAncestorByTagNameAndClass(elem, goog.dom.TagName.IMG));
}

function testGetAncestorByTagNameOnly() {
  var elem = goog.dom.getElement('nestedElement');
  var expected = goog.dom.getElement('testAncestorDiv');
  assertEquals(expected,
      goog.dom.getAncestorByTagNameAndClass(elem, goog.dom.TagName.DIV));
  assertEquals(expected,
      goog.dom.getAncestorByTagNameAndClass(elem, 'div'));
}

function testGetAncestorByClassNameNoMatch() {
  var elem = goog.dom.getElement('nestedElement');
  assertNull(
      goog.dom.getAncestorByClass(elem, 'bogusClassName'));
}

function testGetAncestorByClassName() {
  var elem = goog.dom.getElement('nestedElement');
  var expected = goog.dom.getElement('testAncestorP');
  assertEquals(expected,
      goog.dom.getAncestorByClass(elem, 'testAncestor'));
}

function testGetAncestorByTagNameAndClass() {
  var elem = goog.dom.getElement('nestedElement');
  var expected = goog.dom.getElement('testAncestorDiv');
  assertEquals(expected,
      goog.dom.getAncestorByTagNameAndClass(elem, goog.dom.TagName.DIV,
          'testAncestor'));
}

function testCreateTable() {
  var table = goog.dom.createTable(2, 3, true);
  assertEquals(2, table.getElementsByTagName(goog.dom.TagName.TR).length);
  assertEquals(3,
      table.getElementsByTagName(goog.dom.TagName.TR)[0].childNodes.length);
  assertEquals(6, table.getElementsByTagName(goog.dom.TagName.TD).length);
  assertEquals(goog.string.Unicode.NBSP,
      table.getElementsByTagName(goog.dom.TagName.TD)[0].firstChild.nodeValue);

  table = goog.dom.createTable(2, 3, false);
  assertEquals(2, table.getElementsByTagName(goog.dom.TagName.TR).length);
  assertEquals(3,
      table.getElementsByTagName(goog.dom.TagName.TR)[0].childNodes.length);
  assertEquals(6, table.getElementsByTagName(goog.dom.TagName.TD).length);
  assertEquals(0,
      table.getElementsByTagName(goog.dom.TagName.TD)[0].childNodes.length);
}

function testHtmlToDocumentFragment() {
  var docFragment = goog.dom.htmlToDocumentFragment('<a>1</a><b>2</b>');
  assertNull(docFragment.parentNode);
  assertEquals(2, docFragment.childNodes.length);

  var div = goog.dom.htmlToDocumentFragment('<div>3</div>');
  assertEquals('DIV', div.tagName);

  var script = goog.dom.htmlToDocumentFragment('<script></script>');
  assertEquals('SCRIPT', script.tagName);

  if (goog.userAgent.IE && !goog.userAgent.isVersion('9')) {
    // Removing an Element from a DOM tree in IE sets its parentNode to a new
    // DocumentFragment. Bizarre!
    assertEquals(goog.dom.NodeType.DOCUMENT_FRAGMENT,
                 goog.dom.removeNode(div).parentNode.nodeType);
  } else {
    assertNull(div.parentNode);
  }
}

function testAppend() {
  var div = document.createElement('div');
  var b = document.createElement('b');
  var c = document.createTextNode('c');
  goog.dom.append(div, 'a', b, c);
  assertEqualsCaseAndLeadingWhitespaceInsensitive('a<b></b>c', div.innerHTML);
}

function testAppend2() {
  var div = myIframeDoc.createElement('div');
  var b = myIframeDoc.createElement('b');
  var c = myIframeDoc.createTextNode('c');
  goog.dom.append(div, 'a', b, c);
  assertEqualsCaseAndLeadingWhitespaceInsensitive('a<b></b>c', div.innerHTML);
}

function testAppend3() {
  var div = document.createElement('div');
  var b = document.createElement('b');
  var c = document.createTextNode('c');
  goog.dom.append(div, ['a', b, c]);
  assertEqualsCaseAndLeadingWhitespaceInsensitive('a<b></b>c', div.innerHTML);
}

function testAppend4() {
  var div = document.createElement('div');
  var div2 = document.createElement('div');
  div2.innerHTML = 'a<b></b>c';
  goog.dom.append(div, div2.childNodes);
  assertEqualsCaseAndLeadingWhitespaceInsensitive('a<b></b>c', div.innerHTML);
  assertFalse(div2.hasChildNodes());
}


/**
 * @return {boolean} Returns true if the userAgent is IE8.
 */
function isIE8() {
  return goog.userAgent.IE && goog.userAgent.product.isVersion('8') &&
      !goog.userAgent.product.isVersion('9');
}
">TypeError: Cannot read property 'document' of undefined
    at Object.getFrameContentDocument (dom/dom.js:1393:56)
    at _tmpclosuretest.js:34:28
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
    at Module.load (module.js:219:31)
</td></tr>
<tr><td>savedrange_test.html</td><td>Fail</td><td> 0 passed, 2 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.Range');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');


  function testSaved() {
    var node = goog.dom.getElement('test1');
    var range = goog.dom.Range.createFromNodeContents(node);
    var savedRange = range.saveUsingDom();

    range = savedRange.restore(true);
    assertEquals('Restored range should select "Text"', 'Text',
        range.getText());
    assertFalse('Restored range should not be reversed.', range.isReversed());
    assertFalse('Range should not have disposed itself.',
        savedRange.isDisposed());

    goog.dom.Range.clearSelection();
    assertFalse(goog.dom.Range.hasSelection(window));

    range = savedRange.restore();
    assertTrue('Range should have auto-disposed.', savedRange.isDisposed());
    assertEquals('Restored range should select "Text"', 'Text',
        range.getText());
    assertFalse('Restored range should not be reversed.', range.isReversed());
  }

  function testReversedSave() {
    var node = goog.dom.getElement('test1').firstChild;
    var range = goog.dom.Range.createFromNodes(node, 4, node, 0);
    var savedRange = range.saveUsingDom();

    range = savedRange.restore();
    assertEquals('Restored range should select "Text"', 'Text',
        range.getText());
    if (!goog.userAgent.IE) {
      assertTrue('Restored range should be reversed.', range.isReversed());
    }
  }

">2 of 2 tests run in 5ms.<br />0 passed, 2 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testReversedSave<br />Cannot read property 'tagName' of undefined<br />ERROR in testSaved<br />Cannot call method 'createRange' of undefined<br /></td></tr>
<tr><td>nodeoffset_test.html</td><td>Fail</td><td> 0 passed, 4 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.NodeOffset');
  goog.require('goog.dom.NodeType');
  goog.require('goog.dom.TagName');
  goog.require('goog.testing.jsunit');


  var test1 = goog.dom.getElement('test1');
  var i = goog.dom.getElement('i');

  var test2 = goog.dom.getElement('test2');
  test2.innerHTML = test1.innerHTML;

  var empty = goog.dom.getElement('empty');

  function testElementOffset() {
    var nodeOffset = new goog.dom.NodeOffset(i, test1);

    var recovered = nodeOffset.findTargetNode(test2);
    assertNotNull('Should recover a node.', recovered);
    assertEquals('Should recover an I node.', goog.dom.TagName.I,
        recovered.tagName);
    assertTrue('Should recover a child of test2',
        goog.dom.contains(test2, recovered));
    assertFalse('Should not recover a child of test1',
        goog.dom.contains(test1, recovered));

    nodeOffset.dispose();
  }

  function testNodeOffset() {
    var nodeOffset = new goog.dom.NodeOffset(i.firstChild, test1);

    var recovered = nodeOffset.findTargetNode(test2);
    assertNotNull('Should recover a node.', recovered);
    assertEquals('Should recover a text node.', goog.dom.NodeType.TEXT,
        recovered.nodeType);
    assertEquals('Should  have correct contents.', 'text.',
        recovered.nodeValue);
    assertTrue('Should recover a child of test2',
        goog.dom.contains(test2, recovered));
    assertFalse('Should not recover a child of test1',
        goog.dom.contains(test1, recovered));

    nodeOffset.dispose();
  }

  function testToString() {
    var nodeOffset = new goog.dom.NodeOffset(i.firstChild, test1);

    assertEquals('Should have correct string representation',
        '3,B\n1,I\n0,#text', nodeOffset.toString());

    nodeOffset.dispose();
  }

  function testBadRecovery() {
    var nodeOffset = new goog.dom.NodeOffset(i.firstChild, test1);

    var recovered = nodeOffset.findTargetNode(empty);
    assertNull('Should recover nothing.', recovered);

    nodeOffset.dispose();
  }

">4 of 4 tests run in 9ms.<br />0 passed, 4 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testBadRecovery<br />Should recover nothing.<br />Expected <null> but was <[object Object]> (Object)<br />> assertNull at testing/asserts.js:316:3<br />> testBadRecovery at _tmpclosuretest.js:63:5<br />ERROR in testElementOffset<br />Should recover an I node.<br />Expected <I> (String) but was <undefined><br />> assertEquals at testing/asserts.js:289:3<br />> testElementOffset at _tmpclosuretest.js:23:5<br />ERROR in testNodeOffset<br />Should recover a text node.<br />Expected <3> (Number) but was <undefined><br />> assertEquals at testing/asserts.js:289:3<br />> testNodeOffset at _tmpclosuretest.js:38:5<br />ERROR in testToString<br />Should have correct string representation<br />Expected <3,B<br />1,I<br />0,#text> (String) but was <> (String)<br />> assertEquals at testing/asserts.js:289:3<br />> testToString at _tmpclosuretest.js:53:5<br /></td></tr>
<tr><td>tagiterator_test.html</td><td>Fail</td><td> 0 passed, 21 failed.</td><td title="

  goog.require('goog.testing.dom');
  goog.require('goog.testing.jsunit');
  goog.require('goog.dom.TagIterator');


  var it;
  var pos;

  function assertStartTag(type) {
    assertEquals('Position ' + pos + ' should be start tag',
        goog.dom.TagWalkType.START_TAG, it.tagType);
    assertTrue('isStartTag should return true', it.isStartTag());
    assertFalse('isEndTag should return false', it.isEndTag());
    assertFalse('isNonElement should return false', it.isNonElement());
    assertEquals('Position ' + pos + ' should be ' + type, type,
        it.node.tagName);
  }

  function assertEndTag(type) {
    assertEquals('Position ' + pos + ' should be end tag',
        goog.dom.TagWalkType.END_TAG, it.tagType);
    assertFalse('isStartTag should return false', it.isStartTag());
    assertTrue('isEndTag should return true', it.isEndTag());
    assertFalse('isNonElement should return false', it.isNonElement());
    assertEquals('Position ' + pos + ' should be ' + type, type,
        it.node.tagName);
  }

  function assertTextNode(value) {
    assertEquals('Position ' + pos + ' should be text node',
        goog.dom.TagWalkType.OTHER, it.tagType);
    assertFalse('isStartTag should return false', it.isStartTag());
    assertFalse('isEndTag should return false', it.isEndTag());
    assertTrue('isNonElement should return true', it.isNonElement());
    assertEquals('Position ' + pos + ' should be "' + value + '"', value,
        it.node.nodeValue);
  }

  function testBasicHTML() {
    it = new goog.dom.TagIterator(goog.dom.getElement('test'));
    pos = 0;

    goog.iter.forEach(it, function() {
      pos++;
      switch (pos) {
        case 1:
          assertStartTag('DIV');
          break;
        case 2:
          assertStartTag('A');
          break;
        case 3:
          assertTextNode('T');
          break;
        case 4:
          assertStartTag('B');
          assertEquals('Depth at <B> should be 3', 3, it.depth);
          break;
        case 5:
          assertTextNode('e');
          break;
        case 6:
          assertEndTag('B');
          break;
        case 7:
          assertTextNode('xt');
          break;
        case 8:
          assertEndTag('A');
          break;
        case 9:
          assertStartTag('SPAN');
          break;
        case 10:
          assertEndTag('SPAN');
          break;
        case 11:
          assertStartTag('P');
          break;
        case 12:
          assertTextNode('Text');
          break;
        case 13:
          assertEndTag('P');
          break;
        case 14:
          assertEndTag('DIV');
          assertEquals('Depth at end should be 0', 0, it.depth);
          break;
        default:
          throw goog.iter.StopIteration;
      }
    });
  }

  function testSkipTag() {
    it = new goog.dom.TagIterator(goog.dom.getElement('test'));
    pos = 0;

    goog.iter.forEach(it, function() {
      pos++;
      switch (pos) {
        case 1:
          assertStartTag('DIV');
          break;
        case 2:
          assertStartTag('A');
          it.skipTag();
          break;
        case 3:
          assertStartTag('SPAN');
          break;
        case 4:
          assertEndTag('SPAN');
          break;
        case 5:
          assertStartTag('P');
          break;
        case 6:
          assertTextNode('Text');
          break;
        case 7:
          assertEndTag('P');
          break;
        case 8:
          assertEndTag('DIV');
          assertEquals('Depth at end should be 0', 0, it.depth);
          break;
        default:
          throw goog.iter.StopIteration;
      }
    });
  }

  function testRestartTag() {
    it = new goog.dom.TagIterator(goog.dom.getElement('test'));
    pos = 0;
    var done = false;

    goog.iter.forEach(it, function() {
      pos++;
      switch (pos) {
        case 1:
          assertStartTag('DIV');
          break;
        case 2:
          assertStartTag('A');
          it.skipTag();
          break;
        case 3:
          assertStartTag('SPAN');
          break;
        case 4:
          assertEndTag('SPAN');
          break;
        case 5:
          assertStartTag('P');
          break;
        case 6:
          assertTextNode('Text');
          break;
        case 7:
          assertEndTag('P');
          break;
        case 8:
          assertEndTag('DIV');
          assertEquals('Depth at end should be 0', 0, it.depth);

          // Do them all again, starting after this element.
          if (!done) {
            pos = 1;
            it.restartTag();
            done = true;
          }
          break;
        default:
          throw goog.iter.StopIteration;
      }
    });
  }


  function testSkipTagReverse() {
    it = new goog.dom.TagIterator(goog.dom.getElement('test'), true);
    pos = 9;

    goog.iter.forEach(it, function() {
      pos--;
      switch (pos) {
        case 1:
          assertStartTag('DIV');
          assertEquals('Depth at end should be 0', 0, it.depth);
          break;
        case 2:
          assertEndTag('A');
          it.skipTag();
          break;
        case 3:
          assertStartTag('SPAN');
          break;
        case 4:
          assertEndTag('SPAN');
          break;
        case 5:
          assertStartTag('P');
          break;
        case 6:
          assertTextNode('Text');
          break;
        case 7:
          assertEndTag('P');
          break;
        case 8:
          assertEndTag('DIV');
          break;
        default:
          throw goog.iter.StopIteration;
      }
    });
  }


  function testUnclosedLI() {
    it = new goog.dom.TagIterator(goog.dom.getElement('test2'));
    pos = 0;

    goog.iter.forEach(it, function() {
      pos++;
      switch (pos) {
        case 1:
          assertStartTag('UL');
          break;
        case 2:
          assertStartTag('LI');
          assertEquals('Depth at <LI> should be 2', 2, it.depth);
          break;
        case 3:
          assertTextNode('Not');
          break;
        case 4:
          assertEndTag('LI');
          break;
        case 5:
          assertStartTag('LI');
          assertEquals('Depth at second <LI> should be 2', 2, it.depth);
          break;
        case 6:
          assertTextNode('Closed');
          break;
        case 7:
          assertEndTag('LI');
          break;
        case 8:
          assertEndTag('UL');
          assertEquals('Depth at end should be 0', 0, it.depth);
          break;
        default:
          throw goog.iter.StopIteration;
      }
    });
  }

  function testReversedUnclosedLI() {
    it = new goog.dom.TagIterator(goog.dom.getElement('test2'), true);
    pos = 9;

    goog.iter.forEach(it, function() {
      pos--;
      switch (pos) {
        case 1:
          assertStartTag('UL');
          assertEquals('Depth at start should be 0', 0, it.depth);
          break;
        case 2:
          assertStartTag('LI');
          break;
        case 3:
          assertTextNode('Not');
          break;
        case 4:
          assertEndTag('LI');
          assertEquals('Depth at <LI> should be 2', 2, it.depth);
          break;
        case 5:
          assertStartTag('LI');
          break;
        case 6:
          assertTextNode('Closed');
          break;
        case 7:
          assertEndTag('LI');
          assertEquals('Depth at second <LI> should be 2', 2, it.depth);            
          break;
        case 8:
          assertEndTag('UL');
          break;
        default:
          throw goog.iter.StopIteration;
      }
    });
  }

  function testConstrained() {
    it = new goog.dom.TagIterator(goog.dom.getElement('test3'), false, false);
    pos = 0;

    goog.iter.forEach(it, function() {
      pos++;
      switch (pos) {
        case 1:
          assertStartTag('DIV');
          break;
        case 2:
          assertTextNode('text');
          break;
        case 3:
          assertEndTag('DIV');
          break;
      }
    });

    assertEquals('Constrained iterator should stop at position 3.', 3, pos);
  }

  function testUnconstrained() {
    it = new goog.dom.TagIterator(goog.dom.getElement('test3'), false, true);
    pos = 0;

    goog.iter.forEach(it, function() {
      pos++;
      switch (pos) {
        case 1:
          assertStartTag('DIV');
          break;
        case 2:
          assertTextNode('text');
          break;
        case 3:
          assertEndTag('DIV');
          break;
      }
    });

    assertNotEquals('Unonstrained iterator should not stop at position 3.', 3,
        pos);
  }

  function testConstrainedText() {
    it = new goog.dom.TagIterator(goog.dom.getElement('test3').firstChild,
        false, false);
    pos = 0;

    goog.iter.forEach(it, function() {
      pos++;
      switch (pos) {
        case 1:
          assertTextNode('text');
          break;
      }
    });

    assertEquals('Constrained text iterator should stop at position 1.', 1,
        pos);
  }

  function testReverseConstrained() {
    it = new goog.dom.TagIterator(goog.dom.getElement('test3'), true, false);
    pos = 4;

    goog.iter.forEach(it, function() {
      pos--;
      switch (pos) {
        case 1:
          assertStartTag('DIV');
          break;
        case 2:
          assertTextNode('text');
          break;
        case 3:
          assertEndTag('DIV');
          break;
      }
    });

    assertEquals('Constrained reversed iterator should stop at position 1.', 1,
        pos);
  }

  function testSpliceRemoveSingleNode() {
    var testDiv = goog.dom.getElement('testSplice');
    testDiv.innerHTML = '<br/>';
    it = new goog.dom.TagIterator(testDiv.firstChild);

    goog.iter.forEach(it, function(node, dummy, i) {
      i.splice();
    });

    assertEquals('Node not removed', 0, testDiv.childNodes.length);
  }

  function testSpliceRemoveFirstTextNode() {
    var testDiv = goog.dom.getElement('testSplice');
    testDiv.innerHTML = 'hello<b>world</b><em>goodbye</em>';
    it = new goog.dom.TagIterator(testDiv.firstChild, false, true);

    goog.iter.forEach(it, function(node, dummy, i) {
      if (node.nodeType == 3 && node.data == 'hello') {
        i.splice();
      }
      if (node.nodeName == 'EM') {
        i.splice(goog.dom.createDom('I', null, node.childNodes));
      }
    });

    goog.testing.dom.assertHtmlMatches('<b>world</b><i>goodbye</i>',
        testDiv.innerHTML);
  }

  function testSpliceReplaceFirstTextNode() {
    var testDiv = goog.dom.getElement('testSplice');
    testDiv.innerHTML = 'hello<b>world</b>';
    it = new goog.dom.TagIterator(testDiv.firstChild, false, true);

    goog.iter.forEach(it, function(node, dummy, i) {
      if (node.nodeType == 3 && node.data == 'hello') {
        i.splice(goog.dom.createDom('EM', null, 'HELLO'));
      } else if (node.nodeName == 'EM') {
        i.splice(goog.dom.createDom('I', null, node.childNodes));
      }
    });

    goog.testing.dom.assertHtmlMatches('<i>HELLO</i><b>world</b>',
        testDiv.innerHTML);
  }

  function testSpliceReplaceSingleNode() {
    var testDiv = goog.dom.getElement('testSplice');
    testDiv.innerHTML = '<br/>';
    it = new goog.dom.TagIterator(testDiv.firstChild);

    goog.iter.forEach(it, function(node, dummy, i) {
      i.splice(goog.dom.createDom('link'), goog.dom.createDom('img'));
    });

    goog.testing.dom.assertHtmlMatches('<link><img>', testDiv.innerHTML);
  }

  function testSpliceFlattenSingleNode() {
    var testDiv = goog.dom.getElement('testSplice');
    testDiv.innerHTML = '<div><b>one</b>two<i>three</i></div>';
    it = new goog.dom.TagIterator(testDiv.firstChild);

    goog.iter.forEach(it, function(node, dummy, i) {
      i.splice(node.childNodes);
    });

    goog.testing.dom.assertHtmlMatches('<b>one</b>two<i>three</i>',
        testDiv.innerHTML);
  }

  function testSpliceMiddleNode() {
    var testDiv = goog.dom.getElement('testSplice');
    testDiv.innerHTML = 'a<b>hello<span>world</span></b>c';
    it = new goog.dom.TagIterator(testDiv);

    goog.iter.forEach(it, function(node, dummy, i) {
      if (node.nodeName == 'B') {
        i.splice(goog.dom.createDom('IMG'));
      }
    });

    goog.testing.dom.assertHtmlMatches('a<img>c', testDiv.innerHTML);
  }

  function testSpliceMiddleNodeReversed() {
    var testDiv = goog.dom.getElement('testSplice');
    testDiv.innerHTML = 'a<b>hello<span>world</span></b>c';
    it = new goog.dom.TagIterator(testDiv, true);

    goog.iter.forEach(it, function(node, dummy, i) {
      if (node.nodeName == 'B') {
        i.splice(goog.dom.createDom('IMG'));
      }
    });

    goog.testing.dom.assertHtmlMatches('a<img>c', testDiv.innerHTML);
  }

  function testSpliceMiddleNodeAtEndTag() {
    var testDiv = goog.dom.getElement('testSplice');
    testDiv.innerHTML = 'a<b>hello<span>world</span></b>c';
    it = new goog.dom.TagIterator(testDiv);

    goog.iter.forEach(it, function(node, dummy, i) {
      if (node.tagName == 'B' && i.isEndTag()) {
        i.splice(goog.dom.createDom('IMG'));
      }
    });

    goog.testing.dom.assertHtmlMatches('a<img>c', testDiv.innerHTML);
  }

  function testSpliceMultipleNodes() {
    var testDiv = goog.dom.getElement('testSplice');
    testDiv.innerHTML = '<STRONG>this</STRONG> is <EM>from IE</EM>';
    it = new goog.dom.TagIterator(testDiv);

    goog.iter.forEach(it, function(node, dummy, i) {
      var replace = null;
      if (node.nodeName == 'STRONG') {
        replace = goog.dom.createDom('B', null, node.childNodes);
      } else if (node.nodeName == 'EM') {
        replace = goog.dom.createDom('I', null, node.childNodes);
      }
      if (replace) {
        i.splice(replace);
      }
    });

    goog.testing.dom.assertHtmlMatches('<b>this</b> is <i>from IE</i>',
        testDiv.innerHTML);
  }

  function testSpliceMultipleNodesAtEnd() {
    var testDiv = goog.dom.getElement('testSplice');
    testDiv.innerHTML = '<STRONG>this</STRONG> is <EM>from IE</EM>';
    it = new goog.dom.TagIterator(testDiv);

    goog.iter.forEach(it, function(node, dummy, i) {
      var replace = null;
      if (node.nodeName == 'STRONG' && i.isEndTag()) {
        replace = goog.dom.createDom('B', null, node.childNodes);
      } else if (node.nodeName == 'EM' && i.isEndTag()) {
        replace = goog.dom.createDom('I', null, node.childNodes);
      }
      if (replace) {
        i.splice(replace);
      }
    });

    goog.testing.dom.assertHtmlMatches('<b>this</b> is <i>from IE</i>',
        testDiv.innerHTML);
  }

  function testSpliceMultipleNodesReversed() {
    var testDiv = goog.dom.getElement('testSplice');
    testDiv.innerHTML = '<STRONG>this</STRONG> is <EM>from IE</EM>';
    it = new goog.dom.TagIterator(testDiv, true);

    goog.iter.forEach(it, function(node, dummy, i) {
      var replace = null;
      if (node.nodeName == 'STRONG') {
        replace = goog.dom.createDom('B', null, node.childNodes);
      } else if (node.nodeName == 'EM') {
        replace = goog.dom.createDom('I', null, node.childNodes);
      }
      if (replace) {
        i.splice(replace);
      }
    });

    goog.testing.dom.assertHtmlMatches('<b>this</b> is <i>from IE</i>',
        testDiv.innerHTML);
  }

">21 of 21 tests run in 15ms.<br />0 passed, 21 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testBasicHTML<br />Position 1 should be start tag<br />Expected <1> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> assertStartTag at _tmpclosuretest.js:12:5<br />> anonymous at _tmpclosuretest.js:49:1<br />> Object.forEach at iter/iter.js:164:11<br />> testBasicHTML at _tmpclosuretest.js:45:15<br />ERROR in testConstrained<br />Position 1 should be start tag<br />Expected <1> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> assertStartTag at _tmpclosuretest.js:12:5<br />> anonymous at _tmpclosuretest.js:313:1<br />> Object.forEach at iter/iter.js:164:11<br />> testConstrained at _tmpclosuretest.js:309:15<br />ERROR in testConstrainedText<br />Constrained text iterator should stop at position 1.<br />Expected <1> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> testConstrainedText at _tmpclosuretest.js:364:5<br />ERROR in testRestartTag<br />Position 1 should be start tag<br />Expected <1> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> assertStartTag at _tmpclosuretest.js:12:5<br />> anonymous at _tmpclosuretest.js:146:1<br />> Object.forEach at iter/iter.js:164:11<br />> testRestartTag at _tmpclosuretest.js:142:15<br />ERROR in testReverseConstrained<br />Position 3 should be end tag<br />Expected <-1> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> assertEndTag at _tmpclosuretest.js:22:5<br />> anonymous at _tmpclosuretest.js:382:1<br />> Object.forEach at iter/iter.js:164:11<br />> testReverseConstrained at _tmpclosuretest.js:372:15<br />ERROR in testReversedUnclosedLI<br />Position 8 should be end tag<br />Expected <-1> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> assertEndTag at _tmpclosuretest.js:22:5<br />> anonymous at _tmpclosuretest.js:297:1<br />> Object.forEach at iter/iter.js:164:11<br />> testReversedUnclosedLI at _tmpclosuretest.js:269:15<br />ERROR in testSkipTag<br />Position 1 should be start tag<br />Expected <1> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> assertStartTag at _tmpclosuretest.js:12:5<br />> anonymous at _tmpclosuretest.js:106:1<br />> Object.forEach at iter/iter.js:164:11<br />> testSkipTag at _tmpclosuretest.js:102:15<br />ERROR in testSkipTagReverse<br />Position 8 should be end tag<br />Expected <-1> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> assertEndTag at _tmpclosuretest.js:22:5<br />> anonymous at _tmpclosuretest.js:216:1<br />> Object.forEach at iter/iter.js:164:11<br />> testSkipTagReverse at _tmpclosuretest.js:189:15<br />ERROR in testSpliceFlattenSingleNode<br />Object #<Object> has no method 'createElement'<br />ERROR in testSpliceMiddleNode<br />Object #<Object> has no method 'createElement'<br />ERROR in testSpliceMiddleNodeAtEndTag<br />Object #<Object> has no method 'createElement'<br />ERROR in testSpliceMiddleNodeReversed<br />Object #<Object> has no method 'createElement'<br />ERROR in testSpliceMultipleNodes<br />Object #<Object> has no method 'createElement'<br />ERROR in testSpliceMultipleNodesAtEnd<br />Object #<Object> has no method 'createElement'<br />ERROR in testSpliceMultipleNodesReversed<br />Object #<Object> has no method 'createElement'<br />ERROR in testSpliceRemoveFirstTextNode<br />Object #<Object> has no method 'createElement'<br />ERROR in testSpliceRemoveSingleNode<br />Cannot read property 'length' of undefined<br />ERROR in testSpliceReplaceFirstTextNode<br />Object #<Object> has no method 'createElement'<br />ERROR in testSpliceReplaceSingleNode<br />Object #<Object> has no method 'createElement'<br />ERROR in testUnclosedLI<br />Position 1 should be start tag<br />Expected <1> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> assertStartTag at _tmpclosuretest.js:12:5<br />> anonymous at _tmpclosuretest.js:233:1<br />> Object.forEach at iter/iter.js:164:11<br />> testUnclosedLI at _tmpclosuretest.js:229:15<br />ERROR in testUnconstrained<br />Position 1 should be start tag<br />Expected <1> (Number) but was <0> (Number)<br />> assertEquals at testing/asserts.js:289:3<br />> assertStartTag at _tmpclosuretest.js:12:5<br />> anonymous at _tmpclosuretest.js:335:1<br />> Object.forEach at iter/iter.js:164:11<br />> testUnconstrained at _tmpclosuretest.js:331:15<br /></td></tr>
<tr><td>disposable_test.html</td><td>Fail</td><td> 9 passed, 1 failed.</td><td title="

    goog.require('goog.Disposable');
    goog.require('goog.testing.jsunit');
  

    var d1, d2;

    // Sample subclass of goog.Disposable.

    function DisposableTest() {
      goog.Disposable.call(this);
      this.element = document.getElementById('someElement');
    }
    goog.inherits(DisposableTest, goog.Disposable);

    DisposableTest.prototype.disposeInternal = function() {
      delete this.element;
    };

    // Class that doesn't inherit from goog.Disposable, but implements the
    // disposable interface via duck typing.

    function DisposableDuck() {
      this.element = document.getElementById('someElement');
    }

    DisposableDuck.prototype.dispose = function() {
      delete this.element;
    };

    // Class which calls dispose recursively.

    function RecursiveDisposable() {
      this.disposedCount = 0;
    }
    goog.inherits(RecursiveDisposable, goog.Disposable);

    RecursiveDisposable.prototype.disposeInternal = function() {
      ++this.disposedCount;
      assertEquals('Disposed too many times', 1, this.disposedCount);
      this.dispose();
    };

    // Test methods.

    function setUp() {
      d1 = new goog.Disposable();
      d2 = new DisposableTest();
    }

    function tearDown() {
      goog.Disposable.ENABLE_MONITORING = false;
      goog.Disposable.instances_ = {};
      d1.dispose();
      d2.dispose();
    }

    function testConstructor() {
      assertFalse(d1.isDisposed());
      assertFalse(d2.isDisposed());
      assertEquals(document.getElementById('someElement'), d2.element);
    }

    function testDispose() {
      assertFalse(d1.isDisposed());
      d1.dispose();
      assertTrue('goog.Disposable instance should have been disposed of',
          d1.isDisposed());

      assertFalse(d2.isDisposed());
      d2.dispose();
      assertTrue('goog.DisposableTest instance should have been disposed of',
          d2.isDisposed());
    }

    function testDisposeInternal() {
      assertNotUndefined(d2.element);
      d2.dispose();
      assertUndefined('goog.DisposableTest.prototype.disposeInternal should ' +
          'have deleted the element reference', d2.element);
    }

    function testDisposeAgain() {
      d2.dispose();
      assertUndefined('goog.DisposableTest.prototype.disposeInternal should ' +
          'have deleted the element reference', d2.element);
      // Manually reset the element to a non-null value, and call dispose().
      // Because the object is already marked disposed, disposeInternal won't
      // be called again.
      d2.element = document.getElementById('someElement');
      d2.dispose();
      assertNotUndefined('disposeInternal should not be called again if the ' +
          'object has already been marked disposed', d2.element);
    }

    function testDisposeWorksRecursively() {
      new RecursiveDisposable().dispose();
    }

    function testStaticDispose() {
      assertFalse(d1.isDisposed());
      goog.dispose(d1);
      assertTrue('goog.Disposable instance should have been disposed of',
          d1.isDisposed());

      assertFalse(d2.isDisposed());
      goog.dispose(d2);
      assertTrue('goog.DisposableTest instance should have been disposed of',
          d2.isDisposed());

      var duck = new DisposableDuck();
      assertNotUndefined(duck.element);
      goog.dispose(duck);
      assertUndefined('goog.dispose should have disposed of object that ' +
          'implements the disposable interface', duck.element);
    }

    function testStaticDisposeOnNonDisposableType() {
      // Call goog.dispose() with various types and make sure no errors are
      // thrown.
      goog.dispose(true);
      goog.dispose(false);
      goog.dispose(null);
      goog.dispose(undefined);
      goog.dispose('');
      goog.dispose([]);
      goog.dispose({});

      function A() {}
      goog.dispose(new A());
    }

    function testMonitoringFailure() {
      function BadDisposable() {};
      goog.inherits(BadDisposable, goog.Disposable);

      goog.Disposable.ENABLE_MONITORING = true;

      var badDisposable = new BadDisposable;
      assertArrayEquals('no disposable objects registered', [],
          goog.Disposable.getUndisposedObjects());
      assertThrows('the base ctor should have been called',
          goog.bind(badDisposable.dispose, badDisposable));
    }

    function testGetUndisposedObjects() {
      goog.Disposable.ENABLE_MONITORING = true;

      var d1 = new DisposableTest();
      var d2 = new DisposableTest();
      assertSameElements('the undisposed instances', [d1, d2],
          goog.Disposable.getUndisposedObjects());

      d1.dispose();
      assertSameElements('1 undisposed instance left', [d2],
          goog.Disposable.getUndisposedObjects());

      d1.dispose();
      assertSameElements('second disposal of the same object is no-op', [d2],
          goog.Disposable.getUndisposedObjects());

      d2.dispose();
      assertSameElements('all objects have been disposed of', [],
          goog.Disposable.getUndisposedObjects());
    }

    function testClearUndisposedObjects() {
      goog.Disposable.ENABLE_MONITORING = true;

      var d1 = new DisposableTest();
      var d2 = new DisposableTest();
      d2.dispose();
      goog.Disposable.clearUndisposedObjects()
      assertSameElements('no undisposed object in the registry', [],
          goog.Disposable.getUndisposedObjects());

      assertThrows('disposal after clearUndisposedObjects()', function() {
        d1.dispose();
      });

      // d2 is already disposed of, the redisposal shouldn't throw error.
      d2.dispose();
    }

  ">10 of 10 tests run in 7ms.<br />9 passed, 1 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testConstructor<br />Expected <[object Object]> (Object) but was <[object Object]> (Object)<br />> assertEquals at testing/asserts.js:289:3<br />> testConstructor at _tmpclosuretest.js:62:7<br /></td></tr>
<tr><td>useragent_test.html</td><td>Success</td><td> 8 passed, 0 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.userAgent');



var documentMode;
goog.userAgent.getDocumentMode_ = function() {
  return documentMode;
};


var propertyReplacer = new goog.testing.PropertyReplacer();

var UserAgents = {
  GECKO: 'GECKO',
  IE: 'IE',
  OPERA: 'OPERA',
  WEBKIT: 'WEBKIT'
};

/**
 * Rerun the initialization code to set all of the goog.userAgent constants.
 */
function reinitializeUserAgent() {
  goog.userAgent.init_();

  // Unfortunately we can't isolate the useragent setting in a function
  // we can call, because things rely on it compiling to nothing when
  // one of the ASSUME flags is set, and the compiler isn't smart enough
  // to do that when the setting is done inside a function that's inlined.
  goog.userAgent.OPERA = goog.userAgent.detectedOpera_;
  goog.userAgent.IE = goog.userAgent.detectedIe_;
  goog.userAgent.GECKO = goog.userAgent.detectedGecko_;
  goog.userAgent.WEBKIT = goog.userAgent.detectedWebkit_;
  goog.userAgent.MOBILE = goog.userAgent.detectedMobile_;
  goog.userAgent.SAFARI = goog.userAgent.WEBKIT;

  goog.userAgent.PLATFORM = goog.userAgent.determinePlatform_();
  goog.userAgent.initPlatform_();

  goog.userAgent.VERSION = goog.userAgent.determineVersion_();
}

function tearDown() {
  documentMode = undefined;
  propertyReplacer.reset();
}

/**
 * Test browser detection for a user agent configuration.
 * @param {Array.<number>} expectedAgents Array of expected userAgents.
 * @param {string} uaString User agent string.
 * @param {string=} opt_product Navigator product string.
 * @param {string=} opt_vendor Navigator vendor string.
 */
function assertUserAgent(expectedAgents, uaString, opt_product, opt_vendor) {
  //alert('mocking');
  var mockGlobal = {
    'navigator': {
      'userAgent': uaString,
      'product': opt_product,
      'vendor': opt_vendor
    }
  };
  propertyReplacer.set(goog, 'global', mockGlobal);
  reinitializeUserAgent();
  for (var ua in UserAgents) {
    var isExpected = goog.array.contains(expectedAgents, UserAgents[ua]);
    assertEquals(isExpected, getUserAgentDetected_(UserAgents[ua]));
  }
}

/**
 * Return whether a given user agent has been detected.
 * @param {number} agent Value in UserAgents.
 * @return {boolean} Whether the user agent has been detected.
 */
function getUserAgentDetected_(agent) {
  switch (agent) {
    case UserAgents.GECKO:
      return goog.userAgent.detectedGecko_;
    case UserAgents.IE:
      return goog.userAgent.detectedIe_;
    case UserAgents.OPERA:
      return goog.userAgent.detectedOpera_;
    case UserAgents.WEBKIT:
      return goog.userAgent.detectedWebkit_;
  }
  return null;
}

function testOperaInit() {
  propertyReplacer.set(goog.userAgent, 'getUserAgentString', function() {
    return 'Opera/9.20 (Windows NT 5.1; U; de),gzip(gfe)';
  });

  goog.global['opera'] = {
    version: function() {
      return '9.20';
    }
  };
  reinitializeUserAgent();
  assertTrue(goog.userAgent.detectedOpera_);
  assertEquals('9.20', goog.userAgent.VERSION);

  // What if 'opera' global has been overwritten?
  // We must degrade gracefully (rather than throwing JS errors).
  goog.global['opera'] = 'bobloblaw';
  reinitializeUserAgent();
  assertUndefined(goog.userAgent.VERSION);
}

function testCompare() {
  assertTrue('exact equality broken',
             goog.userAgent.compare('1.0', '1.0') == 0);
  assertTrue('mutlidot equality broken',
             goog.userAgent.compare('1.0.0.0', '1.0') == 0);
  assertTrue('less than broken',
             goog.userAgent.compare('1.0.2.1', '1.1') < 0);
  assertTrue('greater than broken',
             goog.userAgent.compare('1.1', '1.0.2.1') > 0);

  assertTrue('b broken', goog.userAgent.compare('1.1', '1.1b') > 0);
  assertTrue('b broken', goog.userAgent.compare('1.1b', '1.1') < 0);
  assertTrue('b broken', goog.userAgent.compare('1.1b', '1.1b') == 0);

  assertTrue('b>a broken', goog.userAgent.compare('1.1b', '1.1a') > 0);
  assertTrue('a<b broken', goog.userAgent.compare('1.1a', '1.1b') < 0);
}

function testGecko() {
  assertGecko('Mozilla/5.0 (Windows; U; Windows NT 5.1; nl-NL; rv:1.7.5)' +
      'Gecko/20041202 Gecko/1.0', '1.7.5');
  assertGecko('Mozilla/5.0 (X11; U; Linux x86_64; en-US; rv:1.7.6)' +
      'Gecko/20050512 Gecko', '1.7.6');
  assertGecko('Mozilla/5.0 (X11; U; FreeBSD i386; en-US; rv:1.7.8)' +
      'Gecko/20050609 Gecko/1.0.4', '1.7.8');
  assertGecko('Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.9)' +
      'Gecko/20050711 Gecko/1.0.5', '1.7.9');
  assertGecko('Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.10)' +
      'Gecko/20050716 Gecko/1.0.6', '1.7.10');
  assertGecko('Mozilla/5.0 (Macintosh; U; PPC Mac OS X Mach-O; en-GB;' +
        'rv:1.7.10) Gecko/20050717 Gecko/1.0.6', '1.7.10');
  assertGecko('Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.12)' +
      'Gecko/20050915 Gecko/1.0.7', '1.7.12');
  assertGecko('Mozilla/5.0 (Macintosh; U; PPC Mac OS X Mach-O; en-US;' +
        'rv:1.7.12) Gecko/20050915 Gecko/1.0.7', '1.7.12');
  assertGecko('Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8b4)' +
      'Gecko/20050908 Gecko/1.4', '1.8b4');
  assertGecko('Mozilla/5.0 (Windows; U; Windows NT 5.1; nl; rv:1.8)' +
      'Gecko/20051107 Gecko/1.5', '1.8');
  assertGecko('Mozilla/5.0 (Windows; U; Windows NT 5.1; en-GB; rv:1.8.0.1)' +
      'Gecko/20060111 Gecko/1.5.0.1', '1.8.0.1');
  assertGecko('Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.8.0.1)' +
      'Gecko/20060111 Gecko/1.5.0.1', '1.8.0.1');
  assertGecko('Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.0.2)' +
      'Gecko/20060308 Gecko/1.5.0.2', '1.8.0.2');
  assertGecko('Mozilla/5.0 (Macintosh; U; PPC Mac OS X Mach-O; en-US;' +
        'rv:1.8.0.3) Gecko/20060426 Gecko/1.5.0.3', '1.8.0.3');
  assertGecko('Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.0.3)' +
      'Gecko/20060426 Gecko/1.5.0.3', '1.8.0.3');
  assertGecko('Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.0.4)' +
      'Gecko/20060508 Gecko/1.5.0.4', '1.8.0.4');
  assertGecko('Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.4)' +
      'Gecko/20060508 Gecko/1.5.0.4', '1.8.0.4');
  assertGecko('Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.8.0.4)' +
      'Gecko/20060508 Gecko/1.5.0.4', '1.8.0.4');
  assertGecko('Mozilla/5.0 (Windows; U; Windows NT 5.1; es-ES; rv:1.8.0.6)' +
      'Gecko/20060728 Gecko/1.5.0.6', '1.8.0.6');
  assertGecko('Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.0.6)' +
      'Gecko/20060808 Fedora/1.5.0.6-2.fc5 Gecko/1.5.0.6 pango-text',
      '1.8.0.6');
  assertGecko('Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8)' +
      'Gecko/20060321 Gecko/2.0a1', '1.8');
}

function testIe() {
  assertIe('Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)', '5.01');
  assertIe('Mozilla/4.0 (compatible; MSIE 5.17; Mac_PowerPC)', '5.17');
  assertIe('Mozilla/4.0 (compatible; MSIE 5.23; Mac_PowerPC)', '5.23');
  assertIe('Mozilla/4.0 (compatible; MSIE 5.5; Windows NT 5.0)', '5.5');
  assertIe('Mozilla/4.0 (compatible; MSIE 6.0; MSN 2.5; Windows 98)', '6.0');
  assertIe('Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)', '6.0');
  assertIe('Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; ' +
      '.NET CLR 1.1.4322)', '6.0');
  assertIe('Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; ' +
      '.NET CLR 2.0.50727)', '6.0');
  assertIe('Mozilla/4.0 (compatible; MSIE 7.0b; Windows NT 5.1)', '7.0b');
  assertIe('Mozilla/4.0 (compatible; MSIE 7.0b; Win32)', '7.0b');
  assertIe('Mozilla/4.0 (compatible; MSIE 7.0b; Windows NT 6.0)', '7.0b');
  assertIe('Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; SV1;' +
      'Arcor 5.005; .NET CLR 1.0.3705; .NET CLR 1.1.4322)', '7.0');
}

function testIeDocumentModeOverride() {
  documentMode = 9;
  assertIe('Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.1; Trident/5.0',
           '9');
  assertIe('Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/5.0',
           '9');

  documentMode = 8;
  assertIe('Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/5.0',
          '8.0');
}

function testOpera() {
  var assertOpera = function(uaString) {
    assertUserAgent([UserAgents.OPERA], uaString);
  };
  var assertIe = function(uaString) {
    assertUserAgent([UserAgents.IE], uaString);
  };
  assertOpera('Opera/7.23 (Windows 98; U) [en]');
  assertOpera('Opera/8.00 (Windows NT 5.1; U; en)');
  assertOpera('Opera/8.0 (X11; Linux i686; U; cs)');
  assertOpera('Opera/8.02 (Windows NT 5.1; U; en)');
  assertOpera('Opera/8.50 (Windows NT 5.1; U; en)');
  assertOpera('Opera/8.5 (X11; Linux i686; U; cs)');
  assertOpera('Opera/8.51 (Windows NT 5.1; U; en)');
  assertOpera('Opera/9.0 (Windows NT 5.0; U; en)');
  assertOpera('Opera/9.00 (Macintosh; PPC Mac OS X; U; en)');
  assertOpera('Opera/9.00 (Windows NT 5.1; U; en)');
  assertOpera('Opera/9.00 (Windows NT 5.2; U; en)');
  assertOpera('Opera/9.00 (Windows NT 6.0; U; en)');
  // Test Opera spoofing as IE.  Currently detected as IE.
  assertIe('Mozilla/4.0 (compatible; MSIE 5.0; Windows 2000) Opera 6.03' +
      '[en]');
  assertIe('Mozilla/4.0 (compatible; MSIE 5.0; Mac_PowerPC) Opera 6.0' +
      '[en]');
  assertIe('Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; en) Opera' +
      '8.50');
  assertIe('Mozilla/4.0 (compatible; MSIE 6.0; Symbian OS; Nokia' +
        '6630/4.03.38; 6937) Opera 8.50 [es]');
}

function testUnknownBrowser() {
  assertUserAgent([], 'MyWebBrowser');
  assertUserAgent([], undefined);
}

function testNoNavigator() {
  // global object has no "navigator" property.
  var mockGlobal = {};
  propertyReplacer.set(goog, 'global', mockGlobal);
  reinitializeUserAgent();

  assertEquals('Platform should be the empty string', '',
      goog.userAgent.PLATFORM);
  assertEquals('Version should be the empty string', '',
      goog.userAgent.VERSION);
}

function assertIe(uaString, expectedVersion) {
  assertUserAgent([UserAgents.IE], uaString);
  assertEquals('User agent ' + uaString + ' should have had version ' +
      expectedVersion + ' but had ' + goog.userAgent.VERSION,
      expectedVersion,
      goog.userAgent.VERSION);
}

function assertGecko(uaString, expectedVersion) {
  assertUserAgent([UserAgents.GECKO], uaString, 'Gecko');
  assertEquals('User agent ' + uaString + ' should have had version ' +
      expectedVersion + ' but had ' + goog.userAgent.VERSION,
      expectedVersion,
     goog.userAgent.VERSION);
}

">n/a</td></tr>
<tr><td>adobereader_test.html</td><td>Success</td><td> 1 passed, 0 failed.</td><td title="

  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent.adobeReader');


  
  // For now, just test that the variables exist, the test runner will
  // pick up any runtime errors.
  // TODO(chrisn): Mock out each browser implementation and test the code path
  // correctly detects the version for each case.
  function testAdobeReader() {
    assertNotUndefined(goog.userAgent.adobeReader.HAS_READER);
    assertNotUndefined(goog.userAgent.adobeReader.VERSION);
    assertNotUndefined(goog.userAgent.adobeReader.SILENT_PRINT);
  }
      
      
">n/a</td></tr>
<tr><td>jscript_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="

// Mock JScript functions

function ScriptEngine() {
  return 'JScript';
}

function ScriptEngineMajorVersion() {
  return 1;
}

function ScriptEngineMinorVersion() {
  return 2;
}

function ScriptEngineBuildVersion() {
  return 3456;
}




  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent.jscript');



function testHasJscript() {
  assertTrue('Should have jscript', goog.userAgent.jscript.HAS_JSCRIPT);
}


function testVersion() {
  assertEquals('Version should be 1.2.3456', '1.2.3456',
               goog.userAgent.jscript.VERSION);
}

function testIsVersion() {
  assertTrue('Should be version 1.2.3456 or larger',
             goog.userAgent.jscript.isVersion('1.2.3456'));
  assertTrue('Should be version 1.2 or larger',
             goog.userAgent.jscript.isVersion('1.2'));
  assertFalse('Should not be version 8.9 or larger',
             goog.userAgent.jscript.isVersion('8.9'));
}

">n/a</td></tr>
<tr><td>platform_test.html</td><td>Success</td><td> 2 passed, 0 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.MockUserAgent');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.userAgent.platform');


  var mockAgent;

  function setUp() {
    mockAgent = new goog.testing.MockUserAgent();
    mockAgent.install();
  }

  function tearDown() {
    mockAgent.dispose();
    updateUserAgentUtils();
  }

  function updateUserAgentUtils() {
    goog.userAgent.PLATFORM = goog.userAgent.determinePlatform_();
    goog.userAgent.initPlatform_();

    // Unfortunately we can't isolate the useragent setting in a function
    // we can call, because things rely on it compiling to nothing when
    // one of the ASSUME flags is set, and the compiler isn't smart enough
    // to do that when the setting is done inside a function that's inlined.
    goog.userAgent.MAC = goog.userAgent.detectedMac_;
    goog.userAgent.WINDOWS = goog.userAgent.detectedWindows_;
    goog.userAgent.LINUX = goog.userAgent.detectedLinux_;
    goog.userAgent.X11 = goog.userAgent.detectedX11_;

    goog.userAgent.platform.VERSION =
        goog.userAgent.platform.determineVersion_();
  }

  function testWindows() {
    mockAgent.setNavigator({platform: 'Win32'});

    var win98 = 'Mozilla/4.0 (compatible; MSIE 6.0b; Windows 98; Win 9x 4.90)';
    var win2k = 'Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 5.0; en-US)';
    var xp = 'Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 5.1; en-US)';
    var vista = 'Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 6.0; en-US)';
    var win7 = 'Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 6.1; en-US)';

    mockAgent.setUserAgentString(win98);
    updateUserAgentUtils();
    assertEquals("0", goog.userAgent.platform.VERSION);

    mockAgent.setUserAgentString(win2k);
    updateUserAgentUtils();
    assertEquals("5.0", goog.userAgent.platform.VERSION);

    mockAgent.setUserAgentString(xp);
    updateUserAgentUtils();
    assertEquals("5.1", goog.userAgent.platform.VERSION);

    mockAgent.setUserAgentString(vista);
    updateUserAgentUtils();
    assertEquals("6.0", goog.userAgent.platform.VERSION);

    mockAgent.setUserAgentString(win7);
    updateUserAgentUtils();
    assertEquals("6.1", goog.userAgent.platform.VERSION);
  }

  function testMac() {
    // For some reason Chrome substitutes _ for . in the OS version.
    var chrome = "Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_5_8; en-US)" + 
    "AppleWebKit/532.5 (KHTML, like Gecko) Chrome/4.0.249.49 Safari/532.5"

    var ff = "Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US;" +
    "rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6"


    mockAgent.setNavigator({platform: 'IntelMac'});

    mockAgent.setUserAgentString(chrome);
    updateUserAgentUtils();
    assertEquals("10.5.8", goog.userAgent.platform.VERSION);

    mockAgent.setUserAgentString(ff);
    updateUserAgentUtils();
    assertEquals("10.5", goog.userAgent.platform.VERSION);
  }

">n/a</td></tr>
<tr><td>product_test.html</td><td>Success</td><td> 9 passed, 0 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.MockUserAgent');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.userAgent.product');
  goog.require('goog.userAgent.product.isVersion');


  var mockAgent;
  var replacer;

  function setUp() {
    mockAgent = new goog.testing.MockUserAgent();
    mockAgent.install();
    replacer = new goog.testing.PropertyReplacer();
  }

  function tearDown() {
    replacer.reset();
    mockAgent.dispose();
    updateUserAgentUtils();
  }

  function updateUserAgentUtils() {
    goog.userAgent.init_();

    // Unfortunately we can't isolate the useragent setting in a function
    // we can call, because things rely on it compiling to nothing when
    // one of the ASSUME flags is set, and the compiler isn't smart enough
    // to do that when the setting is done inside a function that's inlined.
    goog.userAgent.OPERA = goog.userAgent.detectedOpera_;
    goog.userAgent.IE = goog.userAgent.detectedIe_;
    goog.userAgent.GECKO = goog.userAgent.detectedGecko_;
    goog.userAgent.WEBKIT = goog.userAgent.detectedWebkit_;
    goog.userAgent.MOBILE = goog.userAgent.detectedMobile_;
    goog.userAgent.SAFARI = goog.userAgent.WEBKIT;

    goog.userAgent.VERSION = goog.userAgent.determineVersion_();

    goog.userAgent.product.init_();
    // In an ideal world, this assignment would be just a function in
    // product.js that we could call, but putting it into a function causes
    // the compiler to fail to compile product.js to nothing when one of
    // the ASSUME flags is set.
    goog.userAgent.product.OPERA = goog.userAgent.OPERA;
    goog.userAgent.product.IE = goog.userAgent.IE;
    goog.userAgent.product.FIREFOX = goog.userAgent.product.detectedFirefox_;
    goog.userAgent.product.CAMINO = goog.userAgent.product.detectedCamino_;
    goog.userAgent.product.IPHONE = goog.userAgent.product.detectedIphone_;
    goog.userAgent.product.IPAD = goog.userAgent.product.detectedIpad_;
    goog.userAgent.product.ANDROID = goog.userAgent.product.detectedAndroid_;
    goog.userAgent.product.CHROME = goog.userAgent.product.detectedChrome_;
    goog.userAgent.product.SAFARI = goog.userAgent.product.detectedSafari_;
    goog.userAgent.product.VERSION = goog.userAgent.product.determineVersion_();
  }

  // The set of products whose corresponding goog.userAgent.product value is set
  // in goog.userAgent.product.init_().
  var DETECTED_BROWSER_KEYS =
      ['FIREFOX', 'CAMINO', 'IPHONE', 'IPAD', 'ANDROID', 'CHROME', 'SAFARI'];

  function assertIsBrowser(browser) {
    function createDetectedBrowserKey(browser) {
      switch (browser) {
        case 'FIREFOX': return 'detectedFirefox_';
        case 'CAMINO': return 'detectedCamino_';
        case 'IPHONE': return 'detectedIphone_';
        case 'IPAD': return 'detectedIpad_';
        case 'ANDROID': return 'detectedAndroid_';
        case 'CHROME': return 'detectedChrome_';
        case 'SAFARI': return 'detectedSafari_';
        case 'IE': return 'IE';
        case 'OPERA': return 'OPERA';
      }
      throw Error('Unknown browser: ' + browser);
    }

    var productKey = createDetectedBrowserKey(browser);
    assertTrue(goog.userAgent.product[productKey]);
    // Make sure we don't have any false positives for other browsers.
    goog.array.forEach(DETECTED_BROWSER_KEYS, function(el) {
      if (el != browser) {
        assertFalse('useragent should not match: ' + el,
            goog.userAgent.product[createDetectedBrowserKey(el)]);
      }
    });
  }

  /**
   * @param {Array.<{
   *           ua: string,
   *           versions: Array.<{
   *             num: {string|number}, truth: boolean}>}>} userAgents
   * @param {string} browser
   */
  function checkEachUserAgentDetected(userAgents, browser) {
    goog.array.forEach(userAgents, function(ua) {
      mockAgent.setUserAgentString(ua.ua);
      updateUserAgentUtils();
      assertIsBrowser(browser);
      goog.array.forEach(ua.versions, function(v) {
        assertEquals(
            'Expected version ' + v.num + ' from ' + ua.ua + ' but got ' +
                goog.userAgent.product.VERSION,
            v.truth, goog.userAgent.product.isVersion(v.num));
      });
    });
  }

  function testInternetExplorer() {
    var userAgents = [
      {ua: 'Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; GTB6; ' +
           'chromeframe; .NET CLR 1.1.4322; InfoPath.1; ' +
           '.NET CLR 3.0.04506.30; .NET CLR 3.0.04506.648; ' +
           '.NET CLR 3.0.4506.2152; .NET CLR 3.5.30729; .NET CLR 2.0.50727)',
       versions: [
         {num: 6, truth: true},
         {num: '7.0', truth: true},
         {num: 7.1, truth: false},
         {num: 8, truth: false}
       ]
      }
    ];
    // hide any navigator.product value by putting in a navigator with no
    // properties.
    mockAgent.setNavigator({});
    checkEachUserAgentDetected(userAgents, 'IE');
  }

  function testOpera() {
    var opera = {};
    var userAgents = [
      {ua: 'Opera/9.80 (Windows NT 5.1; U; en) Presto/2.2.15 Version/10.01',
       versions: [
         {num: 9, truth: true},
         {num: '10.1', truth: true},
         {num: 11, truth: false}
       ]}
    ];
    replacer.set(goog.global, 'opera', opera);
    opera.version = '10.01';
    checkEachUserAgentDetected(userAgents, 'OPERA');
    userAgents = [
      {ua: 'Opera/9.63 (Windows NT 5.1; U; en) Presto/2.1.1',
       versions: [
         {num: 9, truth: true},
         {num: '10.1', truth: false},
         {num: '9.80', truth: false},
         {num: '9.60', truth: true}
       ]}
    ];
    opera.version = '9.63';
    checkEachUserAgentDetected(userAgents, 'OPERA');
  }

  function testFirefox() {
    var userAgents = [
      {ua: 'Mozilla/6.0 (Macintosh; U; PPC Mac OS X Mach-O; en-US; ' +
           'rv:2.0.0.0) Gecko/20061028 Firefox/3.0',
       versions: [
         {num: 2, truth: true},
         {num: '3.0', truth: true},
         {num: '3.5.3', truth: false}
       ]},
      {ua: 'Mozilla/5.0 (Macintosh; U; PPC Mac OS X Mach-O; en-US; ' +
           'rv:1.8.1.4) Gecko/20070515 Firefox/2.0.4',
       versions: [
         {num: 2, truth: true},
         {num: '2.0.4', truth: true},
         {num: 3, truth: false},
         {num: '3.5.3', truth: false}
       ]}
    ];
    checkEachUserAgentDetected(userAgents, 'FIREFOX');
  }

  function testCamino() {
    var userAgents = [
      {ua: 'Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en; rv:1.8.1.11) ' +
           'Gecko/20071128 Camino/1.5.4',
       versions: [
         {num: '1.5.4', truth: true},
         {num: 1, truth: true},
         {num: '2.0', truth: false}
       ]},
      {ua: 'Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en-US; rv:1.8.0.10) ' +
           'Gecko/20070228 Camino/1.0.4',
       versions: [
         {num: '1.5.4', truth: false},
         {num: 1, truth: true},
         {num: '2.0', truth: false}
       ]}
    ];
    mockAgent.setNavigator({vendor: 'Camino', product: 'Gecko'});
    checkEachUserAgentDetected(userAgents, 'CAMINO');
  }

  function testChrome() {
    var userAgents = [
      {ua: 'Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US) ' +
           'AppleWebKit/525.19 (KHTML, like Gecko) Chrome/0.2.153.0 ' +
           'Safari/525.19',
       versions: [
         {num: '0.2.153', truth: true},
         {num: 1, truth: false}
       ]},
      {ua: 'Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US) ' +
           'AppleWebKit/532.3 (KHTML, like Gecko) Chrome/4.0.223.11 ' +
           'Safari/532.3',
       versions: [
         {num: 4, truth: true},
         {num: '0.2.153', truth: true},
         {num: '4.1.223.13', truth: false},
         {num: '4.0.223.10', truth: true}
       ]}
    ];
    checkEachUserAgentDetected(userAgents, 'CHROME');
  }

  function testSafari() {
    var userAgents = [
      {ua: 'Mozilla/5.0 (Windows; U; Windows NT 6.0; pl-PL) ' +
           'AppleWebKit/525.19 (KHTML, like Gecko) Version/3.1.2 Safari/525.21',
       versions: [
         {num: 525, truth: true},
         {num: '532.3', truth: false}
       ]},
      {ua: 'Mozilla/5.0 (Macintosh; U; PPC Mac OS X 10_5_3; en-us) ' +
           'AppleWebKit/525.18 (KHTML, like Gecko) Version/3.1.1 Safari/525.20',
       versions: [
         {num: '525.21', truth: false},
         {num: 518, truth: true}
       ]}
    ];
    checkEachUserAgentDetected(userAgents, 'SAFARI');
  }

  function testIphone() {
    var userAgents = [
      {ua: 'Mozilla/5.0 (iPhone; U; CPU like Mac OS X; en) AppleWebKit/420+ ' +
           '(KHTML, like Gecko) Version/3.0 Mobile/1A543a Safari/419.3',
       versions: [
        {num: '3.0.1A543a', truth: true},
        {num: '3.0', truth: true},
        {num: '3.0.1B543a', truth: false},
        {num: '3.1.1A543a', truth: false},
        {num: '3.0.1A320c', truth: true},
        {num: '3.0.3A100a', truth: false}
       ]},
      {ua: 'Mozilla/5.0 (iPod; U; CPU like Mac OS X; en) AppleWebKit/420.1 ' +
           '(KHTML, like Gecko) Version/3.0 Mobile/3A100a Safari/419.3',
       versions: [
         {num: '3.0.1A543a', truth: true},
         {num: '3.0.3A100a', truth: true}
       ]}
    ];
    checkEachUserAgentDetected(userAgents, 'IPHONE');
  }

  function testIpad() {
    var userAgents = [
      {ua: 'Mozilla/5.0 (iPad; U; CPU OS 3_2 like Mac OS X; en-us) ' +
           'AppleWebKit/531.21.10 (KHTML, like Gecko) Version/4.0.4 ' +
           'Mobile/7B334b Safari/531.21.10',
       versions: [
        {num: '4.0.4.7B334b', truth: true},
        {num: '4.0', truth: true},
        {num: '4.0.4.7C334b', truth: false},
        {num: '4.1.7B334b', truth: false},
        {num: '4.0.4.7B320c', truth: true},
        {num: '4.0.4.8B334b', truth: false}
       ]}
    ];
    checkEachUserAgentDetected(userAgents, 'IPAD');
  }

  function testAndroid() {
    var userAgents = [
      {ua: 'Mozilla/5.0 (Linux; U; Android 0.5; en-us) AppleWebKit/522+ ' +
           '(KHTML, like Gecko) Safari/419.3',
       versions: [
         {num: 0.5, truth: true},
         {num: '1.0', truth: false}
       ]},
      {ua: 'Mozilla/5.0 (Linux; U; Android 1.0; en-us; dream) ' +
           'AppleWebKit/525.10+ (KHTML, like Gecko) Version/3.0.4 Mobile ' +
           'Safari/523.12.2',
       versions: [
         {num: 0.5, truth: true},
         {num: 3, truth: true},
         {num: '3.0.4', truth: true},
         {num: '3.0.12', truth: false}
       ]}
    ];
    checkEachUserAgentDetected(userAgents, 'ANDROID');
  }
">n/a</td></tr>
<tr><td>flash_test.html</td><td>Success</td><td> 1 passed, 0 failed.</td><td title="

  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent.flash');


  
  // For now, just test that the flash variables exist, the test runner will
  // pick up any runtime errors.
  // TODO(user): Mock out each browser implementation and test the code path
  // correctly detects the flash version for each case.
  function testFlash() {
    assertNotUndefined(goog.userAgent.flash.HAS_FLASH);
    assertNotUndefined(goog.userAgent.flash.VERSION);
    assertEquals(typeof goog.userAgent.flash.isVersion('5'), 'boolean');
  }
      
      
">n/a</td></tr>
<tr><td>sha1_test.html</td><td>Success</td><td> 1 passed, 0 failed.</td><td title="

  goog.require('goog.crypt.Sha1');
  goog.require('goog.testing.jsunit');



/**
 * Helper function to convert a byte array to a hex string
 */
function bytesToHex(bytes) {
  var hexchars = '0123456789abcdef';
  var hexrep = new Array(bytes.length * 2);

  for (var i = 0; i < bytes.length; ++i) {
    hexrep[i * 2] = hexchars.charAt((bytes[i] >> 4) & 15);
    hexrep[i * 2 + 1] = hexchars.charAt(bytes[i] & 15);
  }
  return hexrep.join('');
}

function testHashing() {
  // Test basic hashing.
  var byteArray = [0x61, 0x62, 0x63]
  var sha1 = new goog.crypt.Sha1();
  sha1.update(byteArray);

  assertEquals('a9993e364706816aba3e25717850c26c9cd0d89d',
               bytesToHex(sha1.digest()));
}

">n/a</td></tr>
<tr><td>crypt_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="

  goog.require('goog.crypt');
  goog.require('goog.testing.jsunit');



var UTF8_RANGES_BYTE_ARRAY = [
    0x00,
    0x7F,
    0xC2, 0x80,
    0xDF, 0xBF,
    0xE0, 0xA0, 0x80,
    0xEF, 0xBF, 0xBF];

var UTF8_RANGES_STRING = '\u0000\u007F\u0080\u07FF\u0800\uFFFF';

function testStringToUtf8ByteArray() {
  // Known encodings taken from Java's String.getBytes("UTF8")

  assertArrayEquals('ASCII',
      [72, 101, 108, 108, 111, 44, 32, 119, 111, 114, 108, 100],
      goog.crypt.stringToUtf8ByteArray('Hello, world'));

  assertArrayEquals('Latin',
      [83, 99, 104, 195, 182, 110],
      goog.crypt.stringToUtf8ByteArray('Sch\u00f6n'));

  assertArrayEquals('limits of the first 3 UTF-8 character ranges',
      UTF8_RANGES_BYTE_ARRAY,
      goog.crypt.stringToUtf8ByteArray(UTF8_RANGES_STRING));
}

function testUtf8ByteArrayToString() {
  // Known encodings taken from Java's String.getBytes("UTF8")

  assertEquals('ASCII', 'Hello, world', goog.crypt.utf8ByteArrayToString(
      [72, 101, 108, 108, 111, 44, 32, 119, 111, 114, 108, 100]));

  assertEquals('Latin', 'Sch\u00f6n', goog.crypt.utf8ByteArrayToString(
      [83, 99, 104, 195, 182, 110]));

  assertEquals('limits of the first 3 UTF-8 character ranges',
      UTF8_RANGES_STRING,
      goog.crypt.utf8ByteArrayToString(UTF8_RANGES_BYTE_ARRAY));
}

function testByteArrayToString() {
  assertEquals('', goog.crypt.byteArrayToString([]));
  assertEquals('abc', goog.crypt.byteArrayToString([97, 98, 99]));
}

">n/a</td></tr>
<tr><td>hash32_test.html</td><td>Success</td><td> 8 passed, 0 failed.</td><td title="

  goog.require('goog.crypt.hash32');
  goog.require('goog.testing.jsunit');



  // NOTE: This test uses a custom test case, see end of script block

  // Test data based on known input/output pairs generated using
  // http://go/hash.java

  function testEncodeInteger() {
    assertEquals(898813988, goog.crypt.hash32.encodeInteger(305419896));
  }

  function testEncodeByteArray() {
    assertEquals(-1497024495,
        goog.crypt.hash32.encodeByteArray([10, 20, 30, 40]));
    assertEquals(-961586214,
        goog.crypt.hash32.encodeByteArray([3, 1, 4, 1, 5, 9]));
    assertEquals(-1482202299,
        goog.crypt.hash32.encodeByteArray([127, 0, 0, 0, 123, 45]));
    assertEquals(170907881,
        goog.crypt.hash32.encodeByteArray([9, 1, 1]));
  }

  function testKnownByteArrays() {
    for (var i = 0; i < byteArrays.length; i++) {
      assertEquals(byteArrays[i],
          goog.crypt.hash32.encodeByteArray(createByteArray(i)));
    }
  }

  function testEncodeString() {
    assertEquals(-937588052, goog.crypt.hash32.encodeString('Hello, world'));
    assertEquals(62382810, goog.crypt.hash32.encodeString('Sch\xF6n'));
  }

  function testEncodeStringUtf8() {
    assertEquals(-937588052,
        goog.crypt.hash32.encodeStringUtf8('Hello, world'));
    assertEquals(-833263351, goog.crypt.hash32.encodeStringUtf8('Sch\xF6n'));

    assertEquals(-1771620293, goog.crypt.hash32.encodeStringUtf8(
        '\u043A\u0440'));
  }

  function testEncodeString_ascii() {
    assertEquals('For ascii characters UTF8 should be the same',
        goog.crypt.hash32.encodeStringUtf8('abc123'),
        goog.crypt.hash32.encodeString('abc123'));

    assertEquals('For ascii characters UTF8 should be the same',
        goog.crypt.hash32.encodeStringUtf8('The,quick.brown-fox'),
        goog.crypt.hash32.encodeString('The,quick.brown-fox'));

    assertNotEquals('For non-ascii characters UTF-8 encoding is different',
        goog.crypt.hash32.encodeStringUtf8('Sch\xF6n'),
        goog.crypt.hash32.encodeString('Sch\xF6n'));
  }

  function testEncodeString_poe() {
    var poe = "Once upon a midnight dreary, while I pondered weak and weary," +
        "Over many a quaint and curious volume of forgotten lore," +
        "While I nodded, nearly napping, suddenly there came a tapping," +
        "As of some one gently rapping, rapping at my chamber door." +
        "`'Tis some visitor,' I muttered, `tapping at my chamber door -" +
        "Only this, and nothing more.'" +
        "Ah, distinctly I remember it was in the bleak December," +
        "And each separate dying ember wrought its ghost upon the floor." +
        "Eagerly I wished the morrow; - vainly I had sought to borrow" +
        "From my books surcease of sorrow - sorrow for the lost Lenore -" +
        "For the rare and radiant maiden whom the angels named Lenore -" +
        "Nameless here for evermore." +
        "And the silken sad uncertain rustling of each purple curtain" +
        "Thrilled me - filled me with fantastic terrors never felt before;" +
        "So that now, to still the beating of my heart, I stood repeating" +
        "`'Tis some visitor entreating entrance at my chamber door -" +
        "Some late visitor entreating entrance at my chamber door; -" +
        "This it is, and nothing more,'" +
        "Presently my soul grew stronger; hesitating then no longer," +
        "`Sir,' said I, `or Madam, truly your forgiveness I implore;" +
        "But the fact is I was napping, and so gently you came rapping," +
        "And so faintly you came tapping, tapping at my chamber door," +
        "That I scarce was sure I heard you' - here I opened wide the door; -" +
        "Darkness there, and nothing more." +
        "Deep into that darkness peering, long I stood there wondering, " +
        "fearing," +
        "Doubting, dreaming dreams no mortal ever dared to dream before" +
        "But the silence was unbroken, and the darkness gave no token," +
        "And the only word there spoken was the whispered word, `Lenore!'" +
        "This I whispered, and an echo murmured back the word, `Lenore!'" +
        "Merely this and nothing more." +
        "Back into the chamber turning, all my soul within me burning," +
        "Soon again I heard a tapping somewhat louder than before." +
        "`Surely,\' said I, `surely that is something at my window lattice;" +
        "Let me see then, what thereat is, and this mystery explore -" +
        "Let my heart be still a moment and this mystery explore; -" +
        "'Tis the wind and nothing more!'";

    assertEquals(147608747, goog.crypt.hash32.encodeString(poe));
    assertEquals(147608747, goog.crypt.hash32.encodeStringUtf8(poe));
  }

  function testBenchmarking() {
    if (!testCase) return;
    // Not a real test, just outputs some timing
    function makeString(n) {
      var str = [];
      for (var i = 0; i < n; i++) {
        str.push(String.fromCharCode(Math.round(Math.random() * 500)));
      }
      return str.join('');
    }
    for (var i = 0; i < 50000; i+= 10000) {
      var str = makeString(i);
      var start = goog.now();
      var hash = goog.crypt.hash32.encodeString(str);
      var diff = goog.now() - start;
      testCase.saveMessage(
          'testBenchmarking : hashing ' + i + ' chars in ' + diff + 'ms');
    }
  }

  function createByteArray(n) {
    var arr = [];
    for (var i = 0; i < n; i++) {
      arr.push(i);
    }
    return arr;
  }

  var byteArrays = {
    0: 1539411136,
    1: 1773524747,
    2: -254958930,
    3: 1532114172,
    4: 1923165449,
    5: 1611874589,
    6: 1502126780,
    7: -751745251,
    8: -292491321,
    9: 1106193218,
    10: -722791438,
    11: -2130666060,
    12: -259304553,
    13: 871461192,
    14: 865773084,
    15: 1615738330,
    16: -1836636447,
    17: -485722519,
    18: -120832227,
    19: 1954449704,
    20: 491312921,
    21: -1955462668,
    22: 168565425,
    23: -105893922,
    24: 620486614,
    25: -1789602428,
    26: 1765793554,
    27: 1723370948,
    28: -1275405721,
    29: 140421019,
    30: -1438726307,
    31: 538438903,
    32: -729123980,
    33: 1213490939,
    34: -1814248478,
    35: 1943703398,
    36: 1603073219,
    37: -2139639543,
    38: -694153941,
    39: 137511516,
    40: -249943726,
    41: -1166126060,
    42: 53464833,
    43: -915350862,
    44: 1306585409,
    45: 1064798289,
    46: 335555913,
    47: 224485496,
    48: 275599760,
    49: 409559869,
    50: 673770580,
    51: -2113819879,
    52: -791338727,
    53: -1716479479,
    54: 1795018816,
    55: 2020139343,
    56: -1652827750,
    57: -1509632558,
    58: 751641995,
    59: -217881377,
    60: -476546900,
    61: -1893349644,
    62: -729290332,
    63: 1359899321,
    64: 1811814306,
    65: 2100363086,
    66: -794920327,
    67: -1667555017,
    68: -549980099,
    69: -21170740,
    70: -1324143722,
    71: 1406730195,
    72: 2111381574,
    73: -1667480052,
    74: 1071811178,
    75: -1080194099,
    76: -181186882,
    77: 268677507,
    78: -546766334,
    79: 555953522,
    80: -981311675,
    81: 1988867392,
    82: 773172547,
    83: 1160806722,
    84: -1455460187,
    85: 83493600,
    86: 155365142,
    87: 1714618071,
    88: 1487712615,
    89: -810670278,
    90: 2031655097,
    91: 1286349470,
    92: -1873594211,
    93: 1875867480,
    94: -1096259787,
    95: -1054968610,
    96: -1723043458,
    97: 1278708307,
    98: -601104085,
    99: 1497928579,
    100: 1329732615,
    101: -1281696190,
    102: 1471511953,
    103: -62666299,
    104: 807569747,
    105: -1927974759,
    106: 1462243717,
    107: -862975602,
    108: 824369927,
    109: -1448816781,
    110: 1434162022,
    111: -881501413,
    112: -1554381107,
    113: -1730883204,
    114: 431236217,
    115: 1877278608,
    116: -673864625,
    117: 143000665,
    118: -596902829,
    119: 1038860559,
    120: 805884326,
    121: -1536181710,
    122: -1357373256,
    123: 1405134250,
    124: -860816481,
    125: 1393578269,
    126: -810682545,
    127: -635515639
  };

  var testCase;
  if (G_testRunner) {
    testCase = new goog.testing.TestCase(document.title);
    testCase.autoDiscoverTests();
    G_testRunner.initialize(testCase);
  }

">n/a</td></tr>
<tr><td>basen_test.html</td><td>Success</td><td> 10 passed, 0 failed.</td><td title="

goog.require('goog.crypt.baseN');
goog.require('goog.testing.jsunit');


/**
 * @fileoverview Tests for arbitrary base conversion library baseconversion.js.
 */

function testDecToHex() {
  verifyConversion(goog.crypt.baseN.BASE_DECIMAL, '0',
                   goog.crypt.baseN.BASE_LOWERCASE_HEXADECIMAL, '0');
  verifyConversion(goog.crypt.baseN.BASE_DECIMAL, '9',
                   goog.crypt.baseN.BASE_UPPERCASE_HEXADECIMAL, '9');
  verifyConversion(goog.crypt.baseN.BASE_DECIMAL, '13',
                   goog.crypt.baseN.BASE_LOWERCASE_HEXADECIMAL, 'd');
  verifyConversion(goog.crypt.baseN.BASE_DECIMAL, '255',
                   goog.crypt.baseN.BASE_UPPERCASE_HEXADECIMAL, 'FF');
  verifyConversion(goog.crypt.baseN.BASE_DECIMAL,
                   '53425987345897',
                   goog.crypt.baseN.BASE_LOWERCASE_HEXADECIMAL,
                   '309734ff5de9');
  verifyConversion(goog.crypt.baseN.BASE_DECIMAL,
                   '987080888',
                   goog.crypt.baseN.BASE_UPPERCASE_HEXADECIMAL,
                   '3AD5A8B8');
  verifyConversion(goog.crypt.baseN.BASE_DECIMAL,
                   '009341587237',
                   goog.crypt.baseN.BASE_LOWERCASE_HEXADECIMAL,
                   '22ccd4f25');
}

function testBinToDec() {
  verifyConversion(
      goog.crypt.baseN.BASE_BINARY,
      '11101010101000100010010000010010010000111101000100110111000000100001' +
      '01100100111110110010000010110100111101000010010100001011111011111100' +
      '00000010000010000101010101000000000101100000000100011111011101111001' +
      '10000001000000000100101110001001001101101001101111010101111100010001' +
      '11011100000110111000000100111011100100010010011001111011001111001011' +
      '10001000101111001010011101101100110110011110010000011100101011110010' +
      '11010001001111110011000000001001011011111011010000110011010000010111' +
      '10111100000001100010111100000100000000110001011101011110100000011010' +
      '0110000100011111',
      goog.crypt.baseN.BASE_DECIMAL,
      '34589745906769047354795784390596748934723904739085568907689045723489' +
      '05745789789078907890789023447892365623589745678902348976234598723459' +
      '087523496723486089723459078349087');
}

function testDecToBin() {
  verifyConversion(
      goog.crypt.baseN.BASE_DECIMAL,
      '00342589674590347859734908573490568347534805468907960579056785605496' +
      '83475873465859072390486756098742380573908572390463805745656623475234' +
      '82345670247851902784123897349486238502378940637925807378946358964328' +
      '57906148572346857346409823758034763928401296023947234784623765456367' +
      '764623627623574',
      goog.crypt.baseN.BASE_BINARY,
      '10010011011100101010001111100111001100110000110111111110010110101000' +
      '01010110110010000111000001100110100101010000101001100001011000101111' +
      '01011101111100101101010010000111011110011110010101111001110010100100' +
      '10111110000101111011010000000111111011110010011110101011100101000001' +
      '00011000101010011001101000011101001010001101011110101001011011100101' +
      '11100000101000010010101001011001100100101110111101010000011010001010' +
      '01011100100111110001100111100100011001001001100011011100100111011111' +
      '01000100101001000100110001011010010000011010111101111111111111110100' +
      '01100101001111001111100110101000001100100000111111100101110010111011' +
      '10110110001100100011101010110110100001001000101011001001100011010110' +
      '10110100000110000110010111110100000100110110010010010101111001001111' +
      '11100100000010101111110100011010011101011010001101110011100110111111' +
      '11000100001111010000000101011011000010010000000100111111010110111100' +
      '00101111010011011010011010010001000101100001111001110010010110');
}

function test7To9() {
  verifyConversion(
      '0123456',    // Base 7.
      '60625646056660665666066534602566346056634560665606666656465634265434' +
      '66563465664566346406366534664656650660665623456663456654360665',
      '012345678',  // Base 9.
      '11451222686557606458341381287142358175337801548087003804852781764284' +
      '273762357630423116743334671762638240652740158536');
}

function testZeros() {
  verifyConversion(goog.crypt.baseN.BASE_DECIMAL, '0',
                   goog.crypt.baseN.BASE_LOWERCASE_HEXADECIMAL, '0');
  verifyConversion(goog.crypt.baseN.BASE_DECIMAL, '000',
                   goog.crypt.baseN.BASE_LOWERCASE_HEXADECIMAL, '0');
  verifyConversion(goog.crypt.baseN.BASE_DECIMAL, '0000007',
                   goog.crypt.baseN.BASE_LOWERCASE_HEXADECIMAL, '7');
}

function testArbitraryBases() {
  verifyConversion('X9(',    // Base 3.
                   '9(XX((9X(XX9(9X9(X9(',
                   'a:*o9',  // Base 5.
                   ':oa**:9o9**9oo');
}

function testEmptyBases() {
  var e = assertThrows(function() {
    goog.crypt.baseN.recodeString('1230', '', '0123');
  });
  assertEquals('Exception message', 'Number 1230 contains a character ' +
      'not found in base , which is 0', e.message);

  e = assertThrows(function() {
    goog.crypt.baseN.recodeString('1230', '0123', '');
  });
  assertEquals('Exception message', 'Empty output base', e.message);
}

function testInvalidDigits() {
  var e = assertThrows(function() {
    goog.crypt.baseN.recodeString('123x456', '01234567', '01234567');
  });
  assertEquals('Exception message', 'Number 123x456 contains a character ' +
      'not found in base 01234567, which is x', e.message);
}

function makeHugeBase() {
  // Number of digits in the base.
  // Tests break if this is set to 200'000.  The reason for that is
  // String.fromCharCode(196609) == String.fromCharCode(1).
  var baseSize = 20000;
  var tab = [];
  for (var i = 0; i < baseSize; i++) {
    tab.push(String.fromCharCode(i));
  }
  return tab.join('');
}

function testHugeInputBase() {
  verifyConversion(makeHugeBase(), String.fromCharCode(12345),
                   goog.crypt.baseN.BASE_DECIMAL, '12345');
}

function testHugeOutputBase() {
  verifyConversion(goog.crypt.baseN.BASE_DECIMAL, '12345',
                   makeHugeBase(), String.fromCharCode(12345));
}

function verifyConversion(inputBase, inputNumber, outputBase, outputNumber) {
  assertEquals(outputNumber,
               goog.crypt.baseN.recodeString(inputNumber,
                                             inputBase,
                                             outputBase));
}
">n/a</td></tr>
<tr><td>base64_test.html</td><td>Success</td><td> 4 passed, 0 failed.</td><td title="

goog.require('goog.crypt.base64');
  goog.require('goog.testing.jsunit');



// Static test data
var tests =
[ "", "",
  "f", "Zg==",
  "fo", "Zm8=",
  "foo", "Zm9v",
  "foob", "Zm9vYg==",
  "fooba", "Zm9vYmE=",
  "foobar", "Zm9vYmFy",

  // Testing non-ascii characters (1-10 in chinese)
  "\xe4\xb8\x80\xe4\xba\x8c\xe4\xb8\x89\xe5\x9b\x9b\xe4\xba\x94\xe5" +
  "\x85\xad\xe4\xb8\x83\xe5\x85\xab\xe4\xb9\x9d\xe5\x8d\x81",
  "5LiA5LqM5LiJ5Zub5LqU5YWt5LiD5YWr5Lmd5Y2B"];

function testByteArrayEncoding() {
  // Let's see if it's sane by feeding it some well-known values. Index i
  // has the input and index i+1 has the expected value.
  for (var i = 0; i < tests.length; i += 2) {
    var enc = goog.crypt.base64.encodeByteArray(
        goog.crypt.stringToByteArray(tests[i]));
    assertEquals(tests[i + 1], enc);
    var dec = goog.crypt.byteArrayToString(
        goog.crypt.base64.decodeStringToByteArray(enc));
    assertEquals(tests[i], dec);
  }
}

function testShortcutPathEncoding() {
  // Test the higher-level API (tests the btoa/atob shortcut path)
  for (var i = 0; i < tests.length; i += 2) {
    var enc = goog.crypt.base64.encodeString(tests[i]);
    assertEquals(tests[i + 1], enc);
    var dec = goog.crypt.base64.decodeString(enc);
    assertEquals(tests[i], dec);
  }
}

function testMultipleIterations() {
  // Now run it through its paces

  var numIterations = 100;
  for (var i = 0; i < numIterations; i++) {

    var input = [];
    for (var j = 0; j < i; j++)
      input[j] = j % 256;

    var encoded = goog.crypt.base64.encodeByteArray(input);
    var decoded = goog.crypt.base64.decodeStringToByteArray(encoded);
    assert("Encoded length not a multiple of 4?", !(encoded.length % 4));
    assertEquals("Decoded length not equal to input length?",
        input.length, decoded.length);

    for (var j = 0; j < i; j++)
      assertEquals("Values differ at position " + j, input[j], decoded[j]);
  }
}

function testWebSafeEncoding() {
  // Test non-websafe / websafe difference
  var test = ">>>???>>>???=/+";
  var enc = goog.crypt.base64.encodeByteArray(
      goog.crypt.stringToByteArray(test));
  assertEquals("Non-websafe broken?", "Pj4+Pz8/Pj4+Pz8/PS8r", enc);
  enc = goog.crypt.base64.encodeString(test);
  assertEquals("Non-websafe broken?", "Pj4+Pz8/Pj4+Pz8/PS8r", enc);
  enc = goog.crypt.base64.encodeByteArray(
      goog.crypt.stringToByteArray(test), true /* websafe */);
  assertEquals("Websafe encoding broken", "Pj4-Pz8_Pj4-Pz8_PS8r", enc);
  enc = goog.crypt.base64.encodeString(test, true);
  assertEquals("Non-websafe broken?", "Pj4-Pz8_Pj4-Pz8_PS8r", enc);
  var dec = goog.crypt.byteArrayToString(
      goog.crypt.base64.decodeStringToByteArray(enc, true /* websafe */));
  assertEquals("Websafe decoding broken", test, dec);
  dec = goog.crypt.base64.decodeString(enc, true /* websafe */);
  assertEquals("Websafe decoding broken", test, dec);

  // Test parsing malformed characters
  assertThrows("Didn't throw on malformed input", function() {
    goog.crypt.base64.decodeStringToByteArray("foooooo+oooo", true /*websafe*/);
  });
}
">n/a</td></tr>
<tr><td>arc4_test.html</td><td>Success</td><td> 1 passed, 0 failed.</td><td title="

  goog.require('goog.crypt.Arc4');
  goog.require('goog.testing.jsunit');



function testEncryptionDecryption() {
  var key = [0x25, 0x26, 0x27, 0x28];
  var startArray = [0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67];
  var byteArray = [0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67];

  var arc4 = new goog.crypt.Arc4();
  arc4.setKey(key);
  arc4.crypt(byteArray);

  assertArrayEquals(byteArray, [0x51, 0xBB, 0xDD, 0x95, 0x9B, 0x42, 0x34]);

  // The same key and crypt call should unencrypt the data back to its original
  // state
  arc4 = new goog.crypt.Arc4();
  arc4.setKey(key);
  arc4.crypt(byteArray);
  assertArrayEquals(byteArray, startArray);
}

">n/a</td></tr>
<tr><td>pubsub_test.html</td><td>Success</td><td> 18 passed, 0 failed.</td><td title="

    goog.require('goog.array');
    goog.require('goog.pubsub.PubSub');
    goog.require('goog.testing.jsunit');
  

    var pubsub;

    function setUp() {
      pubsub = new goog.pubsub.PubSub();
    }

    function tearDown() {
      pubsub.dispose();
    }

    function testConstructor() {
      assertNotNull('PubSub instance must not be null', pubsub);
      assertTrue('PubSub instance must have the expected type',
          pubsub instanceof goog.pubsub.PubSub);
    }

    function testDispose() {
      assertFalse('PubSub instance must not have been disposed of',
          pubsub.isDisposed());
      pubsub.dispose();
      assertTrue('PubSub instance must have been disposed of',
          pubsub.isDisposed());
    }

    function testSubscribeUnsubscribe() {
      function foo1() {
      }
      function bar1() {
      }
      function foo2() {
      }
      function bar2() {
      }

      assertEquals('Topic "foo" must not have any subscribers', 0,
          pubsub.getCount('foo'));
      assertEquals('Topic "bar" must not have any subscribers', 0,
          pubsub.getCount('bar'));

      pubsub.subscribe("foo", foo1);
      assertEquals('Topic "foo" must have 1 subscriber', 1,
          pubsub.getCount('foo'));
      assertEquals('Topic "bar" must not have any subscribers', 0,
          pubsub.getCount('bar'));

      pubsub.subscribe("bar", bar1);
      assertEquals('Topic "foo" must have 1 subscriber', 1,
          pubsub.getCount('foo'));
      assertEquals('Topic "bar" must have 1 subscriber', 1,
          pubsub.getCount('bar'));

      pubsub.subscribe("foo", foo2);
      assertEquals('Topic "foo" must have 2 subscribers', 2,
          pubsub.getCount('foo'));
      assertEquals('Topic "bar" must have 1 subscriber', 1,
          pubsub.getCount('bar'));

      pubsub.subscribe("bar", bar2);
      assertEquals('Topic "foo" must have 2 subscribers', 2,
          pubsub.getCount('foo'));
      assertEquals('Topic "bar" must have 2 subscribers', 2,
          pubsub.getCount('bar'));

      assertTrue(pubsub.unsubscribe("foo", foo1));
      assertEquals('Topic "foo" must have 1 subscriber', 1,
          pubsub.getCount('foo'));
      assertEquals('Topic "bar" must have 2 subscribers', 2,
          pubsub.getCount('bar'));

      assertTrue(pubsub.unsubscribe("foo", foo2));
      assertEquals('Topic "foo" must have no subscribers', 0,
          pubsub.getCount('foo'));
      assertEquals('Topic "bar" must have 2 subscribers', 2,
          pubsub.getCount('bar'));

      assertTrue(pubsub.unsubscribe("bar", bar1));
      assertEquals('Topic "foo" must have no subscribers', 0,
          pubsub.getCount('foo'));
      assertEquals('Topic "bar" must have 1 subscriber', 1,
          pubsub.getCount('bar'));

      assertTrue(pubsub.unsubscribe("bar", bar2));
      assertEquals('Topic "foo" must have no subscribers', 0,
          pubsub.getCount('foo'));
      assertEquals('Topic "bar" must have no subscribers', 0,
          pubsub.getCount('bar'));

      assertFalse('Unsubscribing a nonexistent topic must return false',
          pubsub.unsubscribe("baz", foo1));

      assertFalse('Unsubscribing a nonexistent function must return false',
          pubsub.unsubscribe("foo", function() {}));
    }

    function testSubscribeUnsubscribeWithContext() {
      function foo() {
      }
      function bar() {
      }

      var contextA = {};
      var contextB = {};

      assertEquals('Topic "X" must not have any subscribers', 0,
          pubsub.getCount('X'));

      pubsub.subscribe('X', foo, contextA);
      assertEquals('Topic "X" must have 1 subscriber', 1,
          pubsub.getCount('X'));

      pubsub.subscribe('X', bar);
      assertEquals('Topic "X" must have 2 subscribers', 2,
          pubsub.getCount('X'));

      pubsub.subscribe('X', bar, contextB);
      assertEquals('Topic "X" must have 3 subscribers', 3,
          pubsub.getCount('X'));

      assertFalse('Unknown function/context combination return false',
          pubsub.unsubscribe('X', foo, contextB));

      assertTrue(pubsub.unsubscribe('X', foo, contextA));
      assertEquals('Topic "X" must have 2 subscribers', 2,
          pubsub.getCount('X'));

      assertTrue(pubsub.unsubscribe('X', bar));
      assertEquals('Topic "X" must have 1 subscriber', 1,
          pubsub.getCount('X'));

      assertTrue(pubsub.unsubscribe('X', bar, contextB));
      assertEquals('Topic "X" must have no subscribers', 0,
          pubsub.getCount('X'));
    }

    function testSubscribeOnce() {
      var called, context;

      called = false;
      pubsub.subscribeOnce('someTopic', function() {
        called = true;
      });
      assertEquals('Topic must have one subscriber', 1,
          pubsub.getCount('someTopic'));
      assertFalse('Subscriber must not have been called yet', called);

      pubsub.publish('someTopic');
      assertEquals('Topic must have no subscribers', 0,
          pubsub.getCount('someTopic'));
      assertTrue('Subscriber must have been called', called);

      context = {called: false};
      pubsub.subscribeOnce('someTopic', function() {
        this.called = true;
      }, context);
      assertEquals('Topic must have one subscriber', 1,
          pubsub.getCount('someTopic'));
      assertFalse('Subscriber must not have been called yet', context.called);

      pubsub.publish('someTopic');
      assertEquals('Topic must have no subscribers', 0,
          pubsub.getCount('someTopic'));
      assertTrue('Subscriber must have been called', context.called);

      context = {called: false, value: 0};
      pubsub.subscribeOnce('someTopic', function(value) {
        this.called = true;
        this.value = value;
      }, context);
      assertEquals('Topic must have one subscriber', 1,
          pubsub.getCount('someTopic'));
      assertFalse('Subscriber must not have been called yet', context.called);
      assertEquals('Value must have expected value', 0, context.value);

      pubsub.publish('someTopic', 17);
      assertEquals('Topic must have no subscribers', 0,
          pubsub.getCount('someTopic'));
      assertTrue('Subscriber must have been called', context.called);
      assertEquals('Value must have been updated', 17, context.value);
    }

    function testSubscribeOnce_boundFn() {
      var context = {called: false, value: 0};

      function subscriber(value) {
        this.called = true;
        this.value = value;
      }

      pubsub.subscribeOnce('someTopic', goog.bind(subscriber, context));
      assertEquals('Topic must have one subscriber', 1,
          pubsub.getCount('someTopic'));
      assertFalse('Subscriber must not have been called yet', context.called);
      assertEquals('Value must have expected value', 0, context.value);

      pubsub.publish('someTopic', 17);
      assertEquals('Topic must have no subscribers', 0,
          pubsub.getCount('someTopic'));
      assertTrue('Subscriber must have been called', context.called);
      assertEquals('Value must have been updated', 17, context.value);
    }

    function testSubscribeOnce_partialFn() {
      var called = false;
      var value = 0;

      function subscriber(hasBeenCalled, newValue) {
        called = hasBeenCalled;
        value = newValue;
      }

      pubsub.subscribeOnce('someTopic', goog.partial(subscriber, true));
      assertEquals('Topic must have one subscriber', 1,
          pubsub.getCount('someTopic'));
      assertFalse('Subscriber must not have been called yet', called);
      assertEquals('Value must have expected value', 0, value);

      pubsub.publish('someTopic', 17);
      assertEquals('Topic must have no subscribers', 0,
          pubsub.getCount('someTopic'));
      assertTrue('Subscriber must have been called', called);
      assertEquals('Value must have been updated', 17, value);
    }

    function testSelfResubscribe() {
      var value = null;

      function resubscribe(iteration, newValue) {
        pubsub.subscribeOnce('someTopic',
            goog.partial(resubscribe, iteration + 1));
        value = newValue + ':' + iteration;
      }

      pubsub.subscribeOnce('someTopic', goog.partial(resubscribe, 0));
      assertEquals('Topic must have 1 subscriber', 1,
          pubsub.getCount('someTopic'));
      assertNull('Value must be null', value);

      pubsub.publish('someTopic', 'foo');
      assertEquals('Topic must have 1 subscriber', 1,
          pubsub.getCount('someTopic'));
      assertEquals('Pubsub must not have any pending unsubscribe keys', 0,
          pubsub.pendingKeys_.length);
      assertEquals('Value be as expected', 'foo:0', value);

      pubsub.publish('someTopic', 'bar');
      assertEquals('Topic must have 1 subscriber', 1,
          pubsub.getCount('someTopic'));
      assertEquals('Pubsub must not have any pending unsubscribe keys', 0,
          pubsub.pendingKeys_.length);
      assertEquals('Value be as expected', 'bar:1', value);

      pubsub.publish('someTopic', 'baz');
      assertEquals('Topic must have 1 subscriber', 1,
          pubsub.getCount('someTopic'));
      assertEquals('Pubsub must not have any pending unsubscribe keys', 0,
          pubsub.pendingKeys_.length);
      assertEquals('Value be as expected', 'baz:2', value);
    }

    function testUnsubscribeByKey() {
      var key1, key2, key3;

      key1 = pubsub.subscribe('X', function() {});
      key2 = pubsub.subscribe('Y', function() {});

      assertEquals('Topic "X" must have 1 subscriber', 1,
          pubsub.getCount('X'));
      assertEquals('Topic "Y" must have 1 subscriber', 1,
          pubsub.getCount('Y'));
      assertNotEquals('Subscription keys must be distinct', key1, key2);

      pubsub.unsubscribeByKey(key1);
      assertEquals('Topic "X" must have no subscribers', 0,
          pubsub.getCount('X'));
      assertEquals('Topic "Y" must have 1 subscriber', 1,
          pubsub.getCount('Y'));

      key3 = pubsub.subscribe('X', function() {});
      assertEquals('Topic "X" must have 1 subscriber', 1,
          pubsub.getCount('X'));
      assertEquals('Topic "Y" must have 1 subscriber', 1,
          pubsub.getCount('Y'));
      assertNotEquals('Subscription keys must be distinct', key1, key3);
      assertNotEquals('Subscription keys must be distinct', key2, key3);

      pubsub.unsubscribeByKey(key1); // Obsolete key; should be no-op.
      assertEquals('Topic "X" must have 1 subscriber', 1,
          pubsub.getCount('X'));
      assertEquals('Topic "Y" must have 1 subscriber', 1,
          pubsub.getCount('Y'));

      pubsub.unsubscribeByKey(key2);
      assertEquals('Topic "X" must have 1 subscriber', 1,
          pubsub.getCount('X'));
      assertEquals('Topic "Y" must have no subscribers', 0,
          pubsub.getCount('Y'));

      pubsub.unsubscribeByKey(key3);
      assertEquals('Topic "X" must have no subscribers', 0,
          pubsub.getCount('X'));
      assertEquals('Topic "Y" must have no subscribers', 0,
          pubsub.getCount('Y'));
    }

    function testSubscribeUnsubscribeMultiple() {
      function foo() {
      }
      function bar() {
      }

      var context = {};

      assertEquals('Pubsub channel must not have any subscribers', 0,
          pubsub.getCount());

      assertEquals('Topic "X" must not have any subscribers', 0,
          pubsub.getCount('X'));
      assertEquals('Topic "Y" must not have any subscribers', 0,
          pubsub.getCount('Y'));
      assertEquals('Topic "Z" must not have any subscribers', 0,
          pubsub.getCount('Z'));

      goog.array.forEach(['X', 'Y', 'Z'], function(topic) {
        pubsub.subscribe(topic, foo);
      });
      assertEquals('Topic "X" must have 1 subscriber', 1,
          pubsub.getCount('X'));
      assertEquals('Topic "Y" must have 1 subscriber', 1,
          pubsub.getCount('Y'));
      assertEquals('Topic "Z" must have 1 subscriber', 1,
          pubsub.getCount('Z'));

      goog.array.forEach(['X', 'Y', 'Z'], function(topic) {
        pubsub.subscribe(topic, bar, context);
      });
      assertEquals('Topic "X" must have 2 subscribers', 2,
          pubsub.getCount('X'));
      assertEquals('Topic "Y" must have 2 subscribers', 2,
          pubsub.getCount('Y'));
      assertEquals('Topic "Z" must have 2 subscribers', 2,
          pubsub.getCount('Z'));

      assertEquals('Pubsub channel must have a total of 6 subscribers', 6,
          pubsub.getCount());

      goog.array.forEach(['X', 'Y', 'Z'], function(topic) {
        pubsub.unsubscribe(topic, foo);
      });
      assertEquals('Topic "X" must have 1 subscriber', 1,
          pubsub.getCount('X'));
      assertEquals('Topic "Y" must have 1 subscriber', 1,
          pubsub.getCount('Y'));
      assertEquals('Topic "Z" must have 1 subscriber', 1,
          pubsub.getCount('Z'));

      goog.array.forEach(['X', 'Y', 'Z'], function(topic) {
        pubsub.unsubscribe(topic, bar, context);
      });
      assertEquals('Topic "X" must not have any subscribers', 0,
          pubsub.getCount('X'));
      assertEquals('Topic "Y" must not have any subscribers', 0,
          pubsub.getCount('Y'));
      assertEquals('Topic "Z" must not have any subscribers', 0,
          pubsub.getCount('Z'));

      assertEquals('Pubsub channel must not have any subscribers', 0,
          pubsub.getCount());
    }

    function testPublish() {
      var context = {};
      var fooCalled = false;
      var barCalled = false;

      function foo(x, y) {
        fooCalled = true;
        assertEquals('x must have expected value', 'x', x);
        assertEquals('y must have expected value', 'y', y);
      }

      function bar(x, y) {
        barCalled = true;
        assertEquals('Context must have expected value', context, this);
        assertEquals('x must have expected value', 'x', x);
        assertEquals('y must have expected value', 'y', y);
      }

      pubsub.subscribe('someTopic', foo);
      pubsub.subscribe('someTopic', bar, context);

      assertTrue(pubsub.publish('someTopic', 'x', 'y'));
      assertTrue('foo() must have been called', fooCalled);
      assertTrue('bar() must have been called', barCalled);

      fooCalled = false;
      barCalled = false;
      assertTrue(pubsub.unsubscribe('someTopic', foo));

      assertTrue(pubsub.publish('someTopic', 'x', 'y'));
      assertFalse('foo() must not have been called', fooCalled);
      assertTrue('bar() must have been called', barCalled);

      fooCalled = false;
      barCalled = false;
      pubsub.subscribe('differentTopic', foo);

      assertTrue(pubsub.publish('someTopic', 'x', 'y'));
      assertFalse('foo() must not have been called', fooCalled);
      assertTrue('bar() must have been called', barCalled);
    }

    function testPublishEmptyTopic() {
      var fooCalled = false;
      function foo() {
        fooCalled = true;
      }

      assertFalse('Publishing to nonexistent topic must return false',
          pubsub.publish('someTopic'));

      pubsub.subscribe('someTopic', foo);
      assertTrue('Publishing to topic with subscriber must return true',
          pubsub.publish('someTopic'));
      assertTrue('Foo must have been called', fooCalled);

      pubsub.unsubscribe('someTopic', foo);
      fooCalled = false;
      assertFalse('Publishing to topic without subscribers must return false',
          pubsub.publish('someTopic'));
      assertFalse('Foo must nothave been called', fooCalled);
    }

    function testSubscribeWhilePublishing() {
      // It's OK for a subscriber to add a new subscriber to its own topic,
      // but the newly added subscriber shouldn't be called until the next
      // publish cycle.

      var firstCalled = false;
      var secondCalled = false;

      pubsub.subscribe('someTopic', function() {
        pubsub.subscribe('someTopic', function() {
          secondCalled = true;
        });
        firstCalled = true;
      });
      assertEquals('Topic must have one subscriber', 1,
          pubsub.getCount('someTopic'));
      assertFalse('No subscriber must have been called yet',
          firstCalled || secondCalled);

      pubsub.publish('someTopic');
      assertEquals('Topic must have two subscribers', 2,
          pubsub.getCount('someTopic'));
      assertTrue('The first subscriber must have been called',
          firstCalled);
      assertFalse('The second subscriber must not have been called yet',
          secondCalled);

      pubsub.publish('someTopic');
      assertEquals('Topic must have three subscribers', 3,
          pubsub.getCount('someTopic'));
      assertTrue('The first subscriber must have been called',
          firstCalled);
      assertTrue('The second subscriber must also have been called',
          secondCalled);
    }

    function testUnsubscribeWhilePublishing() {
      // It's OK for a subscriber to unsubscribe another subscriber from its
      // own topic, but the subscriber in question won't actually be removed
      // until after publishing is complete.

      var firstCalled = false;
      var secondCalled = false;
      var thirdCalled = false;

      function first() {
        assertFalse('unsubscribe() must return false during publishing',
            pubsub.unsubscribe('X', second));
        assertEquals('Topic "X" must still have 3 subscribers', 3,
            pubsub.getCount('X'));
        firstCalled = true;
      }
      pubsub.subscribe('X', first);

      function second() {
        assertEquals('Topic "X" must still have 3 subscribers', 3,
            pubsub.getCount('X'));
        secondCalled = true;
      }
      pubsub.subscribe('X', second);

      function third() {
        assertFalse('unsubscribe() must return false during publishing',
            pubsub.unsubscribe('X', first));
        assertEquals('Topic "X" must still have 3 subscribers', 3,
            pubsub.getCount('X'));
        thirdCalled = true;
      }
      pubsub.subscribe('X', third);

      assertEquals('Topic "X" must have 3 subscribers', 3,
          pubsub.getCount('X'));
      assertFalse('No subscribers must have been called yet',
          firstCalled || secondCalled || thirdCalled);

      assertTrue(pubsub.publish('X'));
      assertTrue('First function must have been called', firstCalled);
      assertTrue('Second function must have been called', secondCalled);
      assertTrue('Third function must have been called', thirdCalled);
      assertEquals('Topic "X" must have 1 subscriber after publishing', 1,
          pubsub.getCount('X'));
      assertEquals('PubSub must not have any subscriptions pending removal', 0,
          pubsub.pendingKeys_.length);
    }

    function testUnsubscribeSelfWhilePublishing() {
      // It's OK for a subscriber to unsubscribe itself, but it won't actually
      // be removed until after publishing is complete.

      var selfDestructCalled = false;

      function selfDestruct() {
        assertFalse('unsubscribe() must return false during publishing',
            pubsub.unsubscribe('someTopic', arguments.callee));
        assertEquals('Topic must still have 1 subscriber', 1,
            pubsub.getCount('someTopic'));
        selfDestructCalled = true;
      }

      pubsub.subscribe('someTopic', selfDestruct);
      assertEquals('Topic must have 1 subscriber', 1,
          pubsub.getCount('someTopic'));
      assertFalse('selfDestruct() must not have been called yet',
          selfDestructCalled);

      pubsub.publish('someTopic');
      assertTrue('selfDestruct() must have been called', selfDestructCalled);
      assertEquals('Topic must have no subscribers after publishing', 0,
          pubsub.getCount('someTopic'));
      assertEquals('PubSub must not have any subscriptions pending removal', 0,
          pubsub.pendingKeys_.length);
    }

    function testPublishReturnValue() {
      pubsub.subscribe('X', function() {
        pubsub.unsubscribe('X', arguments.callee);
      });
      assertTrue('publish() must return true even if the only subscriber ' +
          'removes itself during publishing', pubsub.publish('X'));
    }

    function testNestedPublish() {
      var x1 = false;
      var x2 = false;
      var y1 = false;
      var y2 = false;

      pubsub.subscribe('X', function() {
        pubsub.publish('Y');
        pubsub.unsubscribe('X', arguments.callee);
        x1 = true;
      });

      pubsub.subscribe('X', function() {
        x2 = true;
      });

      pubsub.subscribe('Y', function() {
        pubsub.unsubscribe('Y', arguments.callee);
        y1 = true;
      });

      pubsub.subscribe('Y', function() {
        y2 = true;
      });

      pubsub.publish('X');

      assertTrue('x1 must be true', x1);
      assertTrue('x2 must be true', x2);
      assertTrue('y1 must be true', y1);
      assertTrue('y2 must be true', y2);
    }

    function testClear() {
      function fn() {
      }

      goog.array.forEach(['W', 'X', 'Y', 'Z'], function(topic) {
        pubsub.subscribe(topic, fn);
      });
      assertEquals('Pubsub channel must have 4 subscribers', 4,
          pubsub.getCount());

      pubsub.clear('W');
      assertEquals('Pubsub channel must have 3 subscribers', 3,
          pubsub.getCount());

      goog.array.forEach(['X', 'Y'], function(topic) {
        pubsub.clear(topic);
      });
      assertEquals('Pubsub channel must have 1 subscriber', 1,
          pubsub.getCount());

      pubsub.clear();
      assertEquals('Pubsub channel must have no subscribers', 0,
          pubsub.getCount());
    }
  ">n/a</td></tr>
<tr><td>throttle_test.html</td><td>Success</td><td> 1 passed, 0 failed.</td><td title="

  goog.require('goog.async.Throttle');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.jsunit');



function testThrottle() {
  var clock = new goog.testing.MockClock(true);

  var callBackCount = 0;
  var callBackFunction = function() {
    callBackCount++;
  }

  var throttle = new goog.async.Throttle(callBackFunction, 100);
  assertEquals(0, callBackCount);
  throttle.fire();
  assertEquals(1, callBackCount);
  throttle.fire();
  assertEquals(1, callBackCount);
  throttle.fire();
  throttle.fire();
  assertEquals(1, callBackCount);
  clock.tick(101);
  assertEquals(2, callBackCount);
  clock.tick(101);
  assertEquals(2, callBackCount);

  throttle.fire();
  assertEquals(3, callBackCount);
  throttle.fire();
  assertEquals(3, callBackCount);
  throttle.stop();
  clock.tick(101);
  assertEquals(3, callBackCount);
  throttle.fire();
  assertEquals(4, callBackCount);
  clock.tick(101);
  assertEquals(4, callBackCount);

  throttle.fire();
  throttle.fire();
  assertEquals(5, callBackCount);
  throttle.pause();
  throttle.resume();
  assertEquals(5, callBackCount);
  throttle.pause();
  clock.tick(101);
  assertEquals(5, callBackCount);
  throttle.resume();
  assertEquals(6, callBackCount);
  clock.tick(101);
  assertEquals(6, callBackCount);
  throttle.pause();
  throttle.fire();
  assertEquals(6, callBackCount);
  clock.tick(101);
  assertEquals(6, callBackCount);
  throttle.resume();
  assertEquals(7, callBackCount);

  throttle.pause();
  throttle.pause();
  clock.tick(101);
  throttle.fire();
  throttle.resume();
  assertEquals(7, callBackCount);
  throttle.resume();
  assertEquals(8, callBackCount);

  throttle.pause();
  throttle.pause();
  throttle.fire();
  throttle.resume();
  clock.tick(101);
  assertEquals(8, callBackCount);
  throttle.resume();
  assertEquals(9, callBackCount);

  clock.uninstall();
}

">n/a</td></tr>
<tr><td>delay_test.html</td><td>Success</td><td> 8 passed, 0 failed.</td><td title="

  goog.require('goog.async.Delay');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.jsunit');




var invoked = false;
var delay = null;
var clock = null;


function callback() {
  invoked = true;
}


function setUp() {
  clock = new goog.testing.MockClock(true);
  invoked = false;
  delay = new goog.async.Delay(callback, 200);
}

function tearDown() {
  clock.dispose();
  delay.dispose();
}


function testDelay() {
  delay.start();
  assertFalse(invoked);

  clock.tick(100);
  assertFalse(invoked);

  clock.tick(100);
  assertTrue(invoked);
}


function testStop() {
  delay.start();

  clock.tick(100);
  assertFalse(invoked);

  delay.stop();
  clock.tick(100);
  assertFalse(invoked);
}


function testIsActive() {
  assertFalse(delay.isActive());
  delay.start();
  assertTrue(delay.isActive());
  clock.tick(200);
  assertFalse(delay.isActive());
}


function testRestart() {
  delay.start();
  clock.tick(100);

  delay.stop();
  assertFalse(invoked);

  delay.start();
  clock.tick(199);
  assertFalse(invoked);

  clock.tick(1);
  assertTrue(invoked);

  invoked = false;
  delay.start();
  clock.tick(200);
  assertTrue(invoked);
}


function testOverride() {
  delay.start(50);
  clock.tick(49);
  assertFalse(invoked);

  clock.tick(1);
  assertTrue(invoked);
}


function testDispose() {
  delay.start();
  delay.dispose();
  assertTrue(delay.isDisposed());

  clock.tick(500);
  assertFalse(invoked);
}


function testFire() {
  delay.start();

  clock.tick(50);
  delay.fire();
  assertTrue(invoked);
  assertFalse(delay.isActive());

  invoked = false;
  clock.tick(200);
  assertFalse('Delay fired early with fire call, timeout should have been ' +
     'cleared', invoked);    
}

function testFireIfActive() {
  delay.fireIfActive();
  assertFalse(invoked);

  delay.start();
  delay.fireIfActive();
  assertTrue(invoked);
  invoked = false;
  clock.tick(300);
  assertFalse('Delay fired early with fireIfActive, timeout should have been ' +
     'cleared', invoked);    
}

">n/a</td></tr>
<tr><td>conditionaldelay_test.html</td><td>Success</td><td> 9 passed, 0 failed.</td><td title="

  goog.require('goog.async.ConditionalDelay');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.jsunit');



var invoked = false;
var delay = null;
var clock = null;
var returnValue = true;
var onSuccessCalled = false;
var onFailureCalled = false;


function callback() {
  invoked = true;
  return returnValue;
}


function setUp() {
  clock = new goog.testing.MockClock(true);
  invoked = false;
  returnValue = true;
  onSuccessCalled = false;
  onFailureCalled = false;
  delay = new goog.async.ConditionalDelay(callback);
  delay.onSuccess = function() {
    onSuccessCalled = true;
  }
  delay.onFailure = function() {
    onFailureCalled = true;
  }
}


function tearDown() {
  clock.dispose();
  delay.dispose();
}


function testDelay() {
  delay.start(200, 200);
  assertFalse(invoked);

  clock.tick(100);
  assertFalse(invoked);

  clock.tick(100);
  assertTrue(invoked);
}


function testStop() {
  delay.start(200, 500);
  assertTrue(delay.isActive());

  clock.tick(100);
  assertFalse(invoked);

  delay.stop();
  clock.tick(100);
  assertFalse(invoked);

  assertFalse(delay.isActive());
}


function testIsActive() {
  assertFalse(delay.isActive());
  delay.start(200, 200);
  assertTrue(delay.isActive());
  clock.tick(200);
  assertFalse(delay.isActive());
}


function testRestart() {
  delay.start(200, 50000);
  clock.tick(100);

  delay.stop();
  assertFalse(invoked);

  delay.start(200, 50000);
  clock.tick(199);
  assertFalse(invoked);

  clock.tick(1);
  assertTrue(invoked);

  invoked = false;
  delay.start(200, 200);
  clock.tick(200);
  assertTrue(invoked);

  assertFalse(delay.isActive());
}


function testDispose() {
  delay.start(200, 200);
  delay.dispose();
  assertTrue(delay.isDisposed());

  clock.tick(500);
  assertFalse(invoked);
}


function testConditionalDelay_Success() {
  returnValue = false;
  delay.start(100, 300);

  clock.tick(99);
  assertFalse(invoked);
  clock.tick(1);
  assertTrue(invoked);

  assertTrue(delay.isActive());
  assertFalse(delay.isDone());
  assertFalse(onSuccessCalled);
  assertFalse(onFailureCalled);

  returnValue = true;

  invoked = false;
  clock.tick(100);
  assertTrue(invoked);

  assertFalse(delay.isActive());
  assertTrue(delay.isDone());
  assertTrue(onSuccessCalled);
  assertFalse(onFailureCalled);

  invoked = false;
  clock.tick(200);
  assertFalse(invoked);
}


function testConditionalDelay_Failure() {
  returnValue = false;
  delay.start(100, 300);

  clock.tick(99);
  assertFalse(invoked);
  clock.tick(1);
  assertTrue(invoked);

  assertTrue(delay.isActive());
  assertFalse(delay.isDone());
  assertFalse(onSuccessCalled);
  assertFalse(onFailureCalled);

  invoked = false;
  clock.tick(100);
  assertTrue(invoked);
  assertFalse(onSuccessCalled);
  assertFalse(onFailureCalled);

  invoked = false;
  clock.tick(90);
  assertFalse(invoked);
  clock.tick(10);
  assertTrue(invoked);

  assertFalse(delay.isActive());
  assertFalse(delay.isDone());
  assertFalse(onSuccessCalled);
  assertTrue(onFailureCalled);
}


function testInfiniteDelay() {
  returnValue = false;
  delay.start(100, -1);

  // Test in a big enough loop.
  for (var i = 0; i < 1000; ++i) {
    clock.tick(80);
    assertTrue(delay.isActive());
    assertFalse(delay.isDone());
    assertFalse(onSuccessCalled);
    assertFalse(onFailureCalled);
  }

  delay.stop();
  assertFalse(delay.isActive());
  assertFalse(delay.isDone());
  assertFalse(onSuccessCalled);
  assertFalse(onFailureCalled);
}

function testCallbackScope() {
  var callbackCalled = false;
  var scopeObject = {};
  function internalCallback() {
    assertEquals(this, scopeObject);
    callbackCalled = true;
    return true;
  }
  delay = new goog.async.ConditionalDelay(internalCallback, scopeObject);
  delay.start(200, 200);
  clock.tick(201);
  assertTrue(callbackCalled);
}

">n/a</td></tr>
<tr><td>jsxmlhttpdatasource_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="

  goog.require('goog.ds.JsXmlHttpDataSource');
  goog.require('goog.net.MockXhrLite');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.TestQueue');



  var TEXT_PREFIX = null;
  var TEXT_POSTFIX = null;

  var INDEX_OF_URI_ENTRY = 1;
  var INDEX_OF_CONTENT_ENTRY = 3;

  function setUp() {
  };

  function tearDown() {
  };

  function testLoad_WithPostAndQueryDataSet() {

    var USE_POST = true;
    var dataSource =
      new goog.ds.JsXmlHttpDataSource("uri", "namne", TEXT_PREFIX, TEXT_POSTFIX, USE_POST);

    var testQueue = new goog.testing.TestQueue();
    dataSource.xhr_ = new goog.net.MockXhrLite(testQueue);

    var expectedContent = "Some test content";
    dataSource.setQueryData(expectedContent);
    dataSource.load();

    assertFalse(testQueue.isEmpty());

    var actualRequest = testQueue.dequeue();
    assertEquals(expectedContent, actualRequest[INDEX_OF_CONTENT_ENTRY]);
    assertTrue(testQueue.isEmpty());
  };

  function testLoad_WithPostAndNoQueryDataSet() {

    var USE_POST = true;
    var dataSource =
      new goog.ds.JsXmlHttpDataSource("uri?a=1&b=2", "namne", TEXT_PREFIX, TEXT_POSTFIX, USE_POST);

    var testQueue = new goog.testing.TestQueue();
    dataSource.xhr_ = new goog.net.MockXhrLite(testQueue);

    dataSource.load();

    assertFalse(testQueue.isEmpty());

    var actualRequest = testQueue.dequeue();
    assertEquals("a=1&b=2", actualRequest[INDEX_OF_CONTENT_ENTRY].toString());
    assertTrue(testQueue.isEmpty());
  };

  function testLoad_WithGet() {

    var USE_GET = false;
    var expectedUri = "uri?a=1&b=2";
    var dataSource =
      new goog.ds.JsXmlHttpDataSource(expectedUri, "namne", TEXT_PREFIX, TEXT_POSTFIX, USE_GET);

    var testQueue = new goog.testing.TestQueue();
    dataSource.xhr_ = new goog.net.MockXhrLite(testQueue);

    dataSource.load();

    assertFalse(testQueue.isEmpty());

    var actualRequest = testQueue.dequeue();
    assertEquals(expectedUri, actualRequest[INDEX_OF_URI_ENTRY].toString());
    assertTrue(testQueue.isEmpty());
  };

">n/a</td></tr>
<tr><td>expr_test.html</td><td>Success</td><td> 4 passed, 0 failed.</td><td title="

  goog.require('goog.ds.JsonDataSource');
  goog.require('goog.ds.XmlDataSource');
  goog.require('goog.ds.Expr');
  goog.require('goog.testing.jsunit');


  var jsDs;
  var jsObj = {
    Success: true,
    Errors: [],
    Body: {
      Contacts: [
        {
          Name: 'John Doe',
          Email: 'john@gmail.com',
          EmailCount: 300
        },
        {
          Name: 'Jane Doh',
          Email: 'jane@gmail.com'
        },
        {
          Name: 'Steve Smith',
          Email: 'steve@gmail.com',
          EmailCount: 305
        },
        {
          Name: 'John Smith',
          Email: 'smith@gmail.com'
        },
        {
          Name: 'Homer Simpson',
          Email: 'homer@gmail.com'
        },
        {
          Name: 'Bart Simpson',
          Email: 'bart@gmail.com'
        }
      ]
    }
	};

  function setUp() {
    jsDs = new goog.ds.JsDataSource(jsObj, 'JS', null);
    var dm = goog.ds.DataManager.getInstance();
    dm.addDataSource(jsDs, true);
  }

  function testBasicStuff() {
    assertNotNull('Get Body', goog.ds.Expr.create('$JS/Body').getNode());
  }
  
  function testArrayExpressions() {
    assertEquals(6, goog.ds.Expr.create('$JS/Body/Contacts/*').getNodes().getCount());
    assertEquals('John Doe',
        goog.ds.Expr.create('$JS/Body/Contacts/[0]/Name').getValue());
    assertEquals(305, goog.ds.Expr.create('$JS/Body/Contacts/[2]/EmailCount').getValue());
    assertEquals(6, goog.ds.Expr.create('$JS/Body/Contacts/*/count()').getValue());
    assertEquals(0, goog.ds.Expr.create('$JS/Errors/*/count()').getValue());
  }
  
  function testCommonExpressions() {
    assertTrue(goog.ds.Expr.create('.').isCurrent_);
    assertFalse(goog.ds.Expr.create('Bob').isCurrent_);
    assertTrue(goog.ds.Expr.create('*|text()').isAllChildNodes_);
    assertFalse(goog.ds.Expr.create('Bob').isAllChildNodes_);
    assertTrue(goog.ds.Expr.create('@*').isAllAttributes_);
    assertFalse(goog.ds.Expr.create('Bob').isAllAttributes_);
    assertTrue(goog.ds.Expr.create('*').isAllElements_);
    assertFalse(goog.ds.Expr.create('Bob').isAllElements_);
  }
  
  function testIndexExpressions() {
    assertEquals(goog.ds.Expr.create('node/[5]').getNext().size_, 1);
    assertEquals(goog.ds.Expr.create('node/[5]').getNext().parts_[0], '[5]');
  }
 

">n/a</td></tr>
<tr><td>datasource_test.html</td><td>Fail</td><td> 0 passed, 9 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.dom.xml');
  goog.require('goog.ds.DataManager');
  goog.require('goog.ds.JsDataSource');
  goog.require('goog.ds.SortedNodeList');
  goog.require('goog.ds.XmlDataSource');
  goog.require('goog.testing.jsunit');


  var xmlDs;
  var jsDs;

  function setUp() {
    var xmltext ='<test><node value="5">some data</node></test>';
    var doc = goog.dom.xml.loadXml(xmltext);
    xmlDs = new goog.ds.XmlDataSource(doc.documentElement, null, null);

    var jsObj = { node: { '@value': 5, '#text': 'some data', name: 'bob',
        age: 35, alive: true, aliases: ['bobbo', 'robbo']} };
    jsDs = new goog.ds.JsDataSource(jsObj, 'JSDS', null);
  }

  function testJsDataSource() {
    var child = jsDs.getChildNode('node');
    var attr = child.getChildNode('@value');
    var text = child.getChildNode('#text');
    var name = child.getChildNode('name');
    var age = child.getChildNode('age');
    var alive = child.getChildNode('alive');
    var aliases = child.getChildNode('aliases');

    assertEquals('Attribute get', attr.get(), 5);
    assertEquals('Text get', text.get(), 'some data');
    assertEquals('string node get', name.get(), 'bob');
    assertEquals('Number get', age.get(), 35);
    assertEquals('Boolean get', alive.get(), true);
    assertEquals('Array value', aliases.get().getByIndex(1).get(), 'robbo');
    assertEquals('Array length', aliases.get().getCount(), 2);

    assertEquals('Datasource name', jsDs.getDataName(), 'JSDS');
  }

  function testXmlDataSource(){
    var child = xmlDs.getChildNode('node');
    var attr = child.getChildNode('@value');
    var text = child.getChildNode('#text');

    assertEquals('Attribute get', attr.get(), '5');
    assertEquals('Text get', text.get(), 'some data');
    assertEquals('Attr child node value', child.getChildNodeValue('@value'), '5');
  }

  function testChildNodeValue() {
    var child = jsDs.getChildNode('node');
    assertEquals('Child node value', child.getChildNodeValue('age'), 35);
  }

  function testJsSet() {
    assertNull('Get new child node is null', jsDs.getChildNode('Newt'));

    jsDs.setChildNode('Newt', 'A newt');
    assertEquals('New string child node',
        jsDs.getChildNode('Newt').get(), 'A newt');

    jsDs.setChildNode('Number', 35);
    assertEquals('New number child node', jsDs.getChildNodeValue('Number'), 35);

    var numNode = jsDs.getChildNode('Number');
    jsDs.getChildNode('Number').set(38);
    assertEquals('Changed number child node', numNode.get(), 38);

    assertThrows('Shouldn\'t be able to set a group node yet', function() {
      jsDs.set(5);
    });
  }

  function testDataManager() {
    var dm = goog.ds.DataManager.getInstance();
    assertNotNull('DataManager exists', dm);
    assertTrue('No datasources yet', dm.getChildNodes().getCount() == 0);
    dm.addDataSource(jsDs, true);
    assertTrue('One data source', dm.getChildNodes().getCount() == 1);
    assertEquals('Renamed to global prefix',
                 '$JSDS',
                 dm.getChildNodes().getByIndex(0).getDataName());
  }

  /**
   * Constructs an array of data nodes from a javascript array.
   */
  function createDataNodesArrayFromJs(jsObj) {
    var jsds = new goog.ds.JsDataSource(jsObj, 'MYJSDS', null);
    var dataNodes = jsds.getChildNodes();
    var dataNodesArray = [];
    var dataNodesCount = dataNodes.getCount();
    for(var i = 0; i < dataNodesCount; i++) {
      dataNodesArray[i] = dataNodes.getByIndex(i);
    }
    return dataNodesArray;
  }


  function testSortedNodeListConstruction() {

    var dataNodesArray = createDataNodesArrayFromJs(
        [{'Value': 2, 'id': "C"},
         {'Value': 0, 'id': "A"},
         {'Value': 1, 'id': "B"},
         {'Value': 3, 'id': "D"}]
      );

    var sortedNodeList = new goog.ds.SortedNodeList(
        valueSort, dataNodesArray);

    assertEquals(
        "SortedNodeList count", 4, sortedNodeList.getCount());

    var expectedValues = [0, 1, 2, 3];
    for (var i = 0; i < expectedValues.length; i++) {
      assertEquals(
          "SortedNodeList position after construction",
          expectedValues[i],
          sortedNodeList.getByIndex(i).getChildNode('Value').get());
    }
  }


  function testSortedNodeListAdd() {

    var sortedNodeList = new goog.ds.SortedNodeList(valueSort);

    var dataNodesArray = createDataNodesArrayFromJs(
        [{'Value': 2, 'id': "C"},
         {'Value': 0, 'id': "A"},
         {'Value': 1, 'id': "B"},
         {'Value': 3, 'id': "D"}]
    );

    for (var i = 0; i < dataNodesArray.length; i++) {
      sortedNodeList.add(dataNodesArray[i]);
    }

    assertEquals(
        "SortedNodeList count", 4, sortedNodeList.getCount());

    var expectedValues = [0, 1, 2, 3];
    for (var i = 0; i < expectedValues.length; i++) {
      assertEquals(
          "SortedNodeList position after construction",
          expectedValues[i],
          sortedNodeList.getByIndex(i).getChildNode('Value').get());
    }
  }


  function testSortedNodeListAppend() {
    var sortedNodeList = new goog.ds.SortedNodeList(valueSort);

    var dataNodesArray = createDataNodesArrayFromJs(
        [{'Value': 2, 'id': "C"},
         {'Value': 0, 'id': "A"},
         {'Value': 1, 'id': "B"},
         {'Value': 3, 'id': "D"}]
    );

    for (var i = 0; i < dataNodesArray.length; i++) {
      sortedNodeList.append(dataNodesArray[i]);
    }

    assertEquals(
        "SortedNodeList count",
        dataNodesArray.length,
        sortedNodeList.getCount());

    var expectedValues = [2, 0, 1, 3];
    for (var i = 0; i < expectedValues.length; i++) {
      assertEquals(
          "SortedNodeList position after construction",
          expectedValues[i],
          sortedNodeList.getByIndex(i).getChildNode('Value').get());
    }

  }

  function testSortedNodeListSet() {
    var dataNodesArray = createDataNodesArrayFromJs(
      [{'Value': 4, 'id': "C"},
       {'Value': 0, 'id': "A"},
       {'Value': 2, 'id': "B"},
       {'Value': 6, 'id': "D"}]
    );

    var sortedNodeList = new goog.ds.SortedNodeList(
        valueSort, dataNodesArray);

    assertEquals(
        "SortedNodeList count", 4, sortedNodeList.getCount());

    // test set that replaces an existing node
    var replaceNode = createDataNodesArrayFromJs([{'Value': 5, 'id': "B"}])[0];
    sortedNodeList.setNode("B", replaceNode);

    assertEquals(
        "SortedNodeList count", 4, sortedNodeList.getCount());
    assertEquals(
        "SortedNodeList replacement node correct",
        replaceNode,
        sortedNodeList.get("B"));

    var expectedValues = [0,4,5,6];
    for (var i = 0; i < expectedValues.length; i++) {
      assertEquals(
          "SortedNodeList position after set",
          expectedValues[i],
          sortedNodeList.getByIndex(i).getChildNode('Value').get());
    }

    // test a set that adds a new node
    var addedNode = createDataNodesArrayFromJs([{'Value': 1, 'id': "E"}])[0];
    sortedNodeList.setNode("E", addedNode);

    assertEquals(
        "SortedNodeList count", 5 , sortedNodeList.getCount());
    assertEquals(
        "SortedNodeList added node correct",
        addedNode,
        sortedNodeList.get("E"));

    var expectedValues = [0, 1, 4, 5, 6];
    for (var i = 0; i < expectedValues.length; i++) {
      assertEquals(
          "SortedNodeList position after set",
          expectedValues[i],
          sortedNodeList.getByIndex(i).getChildNode('Value').get());
    }
  }


  function valueSort(a,b) {
    var valueA = a.getChildNode('Value').get();
    var valueB = b.getChildNode('Value').get();

    return (valueA - valueB);
  }



">9 of 9 tests run in 10ms.<br />0 passed, 9 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testChildNodeValue<br />Your browser does not support loading xml documents<br />ERROR in testDataManager<br />Your browser does not support loading xml documents<br />ERROR in testJsDataSource<br />Your browser does not support loading xml documents<br />ERROR in testJsSet<br />Your browser does not support loading xml documents<br />ERROR in testSortedNodeListAdd<br />Your browser does not support loading xml documents<br />ERROR in testSortedNodeListAppend<br />Your browser does not support loading xml documents<br />ERROR in testSortedNodeListConstruction<br />Your browser does not support loading xml documents<br />ERROR in testSortedNodeListSet<br />Your browser does not support loading xml documents<br />ERROR in testXmlDataSource<br />Your browser does not support loading xml documents<br /></td></tr>
<tr><td>fastdatanode_test.html</td><td>Success</td><td> 20 passed, 0 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.ds.DataManager');
  goog.require('goog.ds.Expr');
  goog.require('goog.ds.FastDataNode');
  goog.require('goog.ds.JsDataSource');
  goog.require('goog.testing.jsunit');


  var simpleObject;
  var complexObject;
  var dataChangeEvents;

  function setUp() {
    simpleObject = {Name: "Jon Doe", Email: "jon.doe@gmail.com"};
    complexObject = {Name: "Jon Doe", Email: "jon.doe@gmail.com",
      Emails: [{Address: "jon.doe@gmail.com", Type: "Home"},
               {Address: "jon.doe@workplace.com", Type: "Work"}],
      GroupIds: [23, 42]};
    var dm = goog.ds.DataManager.getInstance();
    dataChangeEvents = [];
    dm.fireDataChange = function(dataPath) {
      dataChangeEvents.push(dataPath);
    };
  };

  function tearDown() {
    goog.ds.DataManager.clearInstance();
  };

  function testGetChildNodeValue() {
    var node = new goog.ds.FastDataNode(simpleObject, "Simple");
    var value = node.getChildNodeValue("Name");
    assert(goog.isString(value));
    assertEquals("Jon Doe", value);
  };

  function testDataNameAndPath() {
    var node = new goog.ds.FastDataNode(simpleObject, "Simple");
    assertEquals("DataName should be 'Simple'", "Simple", node.getDataName());
    assertEquals("DataPath should be 'Simple'", "Simple", node.getDataPath());
  };

  function testStringChildNode() {
    var node = goog.ds.FastDataNode.fromJs(simpleObject, "Simple");
    var name = node.getChildNode("Name");
    var email = node.getChildNode("Email");
    assertEquals("Jon Doe", name.get());
    assertEquals("jon.doe@gmail.com", email.get());

    assertEquals("Name", name.getDataName());
    assertEquals("Simple/Name", name.getDataPath());

    assertEquals("Email", email.getDataName());
    assertEquals("Simple/Email", email.getDataPath());
  };

  function testGetChildNodes() {
    var node = goog.ds.FastDataNode.fromJs(simpleObject, "Simple");
    var children = node.getChildNodes();
    assertEquals(2, children.getCount());
    var childValues = [];
    for (var i=0; i < 2; ++i) {
      childValues.push(children.getByIndex(i).get());
    }
    goog.array.sort(childValues);
    assertEquals("Jon Doe", childValues[0]);
    assertEquals("jon.doe@gmail.com", childValues[1]);
  };


  function testGetDistinguishesBetweenOverloads() {
    var node = goog.ds.FastDataNode.fromJs(simpleObject, "Simple");
    assertEquals(node, node.get());
    assertEquals("Jon Doe", node.getChildNodes().get("Name").get());
  };


  function testGetChildNodesForPrimitiveNodes() {
    var node = goog.ds.FastDataNode.fromJs(simpleObject, "Simple");
    var children = node.getChildNode("Name").getChildNodes();
    assertEquals(0, children.getCount());
  };


  function testFastListNode() {
    var node = goog.ds.FastDataNode.fromJs(complexObject, "Object");
    assertEquals("Jon Doe", node.getChildNodeValue("Name"));
    var emails = node.getChildNode("Emails");
    assertEquals("jon.doe@gmail.com",
      emails.getChildNode("[0]").getChildNodeValue("Address"));
    assertEquals("jon.doe@workplace.com",
      emails.getChildNode("[1]").getChildNodeValue("Address"));

    assertEquals("Object/Emails/[0]/Address",
      emails.getChildNode("[0]").getChildNode("Address").getDataPath());

    var groups = node.getChildNode("GroupIds");
    assertEquals(23, groups.getChildNode("[0]").get());
    assertEquals(42, groups.getChildNodeValue("[1]"));

    var childValues = emails.getChildNodes();
    assertEquals(2, childValues.getCount());
    assertEquals("jon.doe@gmail.com",
      childValues.getByIndex(0).getChildNodeValue("Address"));
  };


  function testChildNodeValueForNonexistantAttribute() {
   var node = goog.ds.FastDataNode.fromJs(complexObject, "Object");
   assertNull(node.getChildNodeValue("DoesNotExist"));
   assertNull(node.getChildNode("Emails").getChildNodeValue("[666]"));
  };


  function testAllChildrenSelector() {
    var node = goog.ds.FastDataNode.fromJs(complexObject, "Object");
    var allChildren = node.getChildNodes("*");
    assertEquals(4, allChildren.getCount());

    // not implemented, yet
    // var nameChild = node.getChildNodes("Name");
    // assertEquals(1, allChildren.getCount());
  };

  function testExpression() {
    var node = goog.ds.FastDataNode.fromJs(complexObject, "Object");
    assertEquals("Jon Doe",
      goog.ds.Expr.create("Name").getValue(node));
    assertEquals("jon.doe@workplace.com",
      goog.ds.Expr.create("Emails/[1]/Address").getNode(node).get());
    var emails = goog.ds.Expr.create("Emails/*").getNodes(node);
    assertEquals(2, emails.getCount());
    assertEquals("jon.doe@workplace.com",
      emails.getByIndex(1).getChildNodeValue("Address"));
  };

  function testModifyNode() {
    var node = goog.ds.FastDataNode.fromJs(complexObject, "Object");
    node.getChildNode("Name").set("Foo Bar");
    assertEquals("Foo Bar", node.getChildNodeValue("Name"));
  };

  function testClone() {
    var node = goog.ds.FastDataNode.fromJs(complexObject, "Object");
    var clone = node.clone();
    node.getChildNode("Name").set("Foo Bar");
    assertEquals("Jon Doe", clone.getChildNodeValue("Name"));
    var expr = goog.ds.Expr.create("Emails/[1]/Address");
    expr.getNode(clone).set("jon@doe.com");
    assertEquals("jon.doe@workplace.com", expr.getValue(node));
    assertEquals("jon@doe.com", expr.getValue(clone));
  };

  function testSetChildNodeOnList() {
    var list = goog.ds.FastDataNode.fromJs([], "list");
    var node = goog.ds.FastDataNode.fromJs({Id: "42", Name: "Foo"}, "42",
      list);
    list.setChildNode("42", node);

    assertEquals(node, list.getChildNode("42"));
    assertEquals(node, list.getChildNodes().getByIndex(0));
    assertEquals(node, list.getChildNodes().get("42"));
  }

  function testCreateNewValueWithSetChildNode() {
    var node = goog.ds.FastDataNode.fromJs({}, "object");
    node.setChildNode("Foo", "Bar");
    assertEquals("Bar", node.getChildNodeValue("Foo"));
  };


  function testSetChildNotWithNull_object() {
    var node = new goog.ds.FastDataNode({Foo: "Bar"}, "test");
    node.setChildNode("Foo", null);
    assertNull("node should not have a Foo child", node.getChildNode("Foo"));
    assertEquals("node should not have any children",
      0, node.getChildNodes().getCount());
  };

  function testSetChildNotWithNull_list() {
    var list = goog.ds.FastDataNode.fromJs([], "list");
    list.setChildNode("foo", "bar");
    list.setChildNode("gee", "wizz");
    assertEquals("bar", list.getChildNodeValue("foo"));
    assertEquals("wizz", list.getChildNodes().getByIndex(1).get());
    list.setChildNode("foo", null);
    assertEquals(1, list.getChildNodes().getCount());
    assertEquals("wizz", list.getChildNodeValue("gee"));
    assertEquals("wizz", list.getChildNodes().getByIndex(0).get());
  };

  function testNodeListIndexesOnId() {
    var list = goog.ds.FastDataNode.fromJs([
      {id: "^Freq", value: "foo"}], "list");
    assertEquals("foo",
      list.getChildNode("^Freq").getChildNodeValue("value"));
    list.setChildNode("^Temp", {id: "^Temp", value: "bar"});
    assertEquals("bar",
      list.getChildNode("^Temp").getChildNodeValue("value"));
  };

  function verifyDataChangeEvents(expected) {
    assertEquals(expected.length, dataChangeEvents.length);
    for (var i=0; i < expected.length; ++i) {
      assertEquals(expected[i], dataChangeEvents[i]);
    }
    dataChangeEvents = [];
  };

  function testFireDataChangeOnSet() {
    var node = new goog.ds.FastDataNode(simpleObject, "Simple");
    node.getChildNode("Name").set("Foo Bar");
    verifyDataChangeEvents(["Simple/Name"]);
  };

  function testFireDataChangeOnSetChildNode_object() {
    var node = new goog.ds.FastDataNode(simpleObject, "Simple");
    node.setChildNode("Name", "Foo Bar");
    node.setChildNode("Email", null);
    verifyDataChangeEvents(["Simple/Name", "Simple/Email"]);
  };

  function testFireDataChangeOnSetChildNode_list() {
    var node = new goog.ds.FastDataNode(complexObject, "Node");
    node.getChildNode("GroupIds").setChildNode("[0]", 1001);
    verifyDataChangeEvents(["Node/GroupIds/[0]"]);

    node.getChildNode("GroupIds").getChildNodes().add(1002);
    verifyDataChangeEvents(["Node/GroupIds/[2]", "Node/GroupIds",
        "Node/GroupIds/count()"]);

    node.getChildNode("GroupIds").setChildNode("foo", 1003);
    verifyDataChangeEvents(["Node/GroupIds/foo", "Node/GroupIds",
        "Node/GroupIds/count()"]);
  };

">n/a</td></tr>
<tr><td>hovercard_test.html</td><td>Fail</td><td> 0 passed, 10 failed.</td><td title="

    goog.require('goog.ui.HoverCard');
    goog.require('goog.dom');
    goog.require('goog.testing.MockClock');
    goog.require('goog.testing.events');
    goog.require('goog.testing.jsunit');
  


    var timer = new goog.testing.MockClock();
    var card;

    // Variables for mocks
    var triggeredElement;
    var cancelledElement;
    var showDelay;
    var shownCard;
    var hideDelay;

    // spans
    var john = goog.dom.getElement('john');
    var jane = goog.dom.getElement('jane');
    var james = goog.dom.getElement('james');
    var bill = goog.dom.getElement('bill');
    var child = goog.dom.getElement('child');

    // Inactive
    var elsewhere;
    var offAnchor;

    function setUp() {
      timer.install();
      triggeredElement = null;
      cancelledElement = null;
      showDelay = null;
      shownCard = null;
      hideDelay = null;
      elsewhere = goog.dom.getElement('notpopup');
      offAnchor = new goog.math.Coordinate(1, 1);
    }

    function initCard(opt_isAnchor, opt_checkChildren, opt_maxSearchSteps) {
      var isAnchor = opt_isAnchor || {SPAN: 'email'};
      card = new goog.ui.HoverCard(isAnchor, opt_checkChildren);
      card.setText('Test hovercard');

      if (opt_maxSearchSteps != null) {
        card.setMaxSearchSteps(opt_maxSearchSteps);
      }

      goog.events.listen(card, goog.ui.HoverCard.EventType.TRIGGER, onTrigger);
      goog.events.listen(card, goog.ui.HoverCard.EventType.CANCEL_TRIGGER,
                         onCancel);
      goog.events.listen(card, goog.ui.HoverCard.EventType.BEFORE_SHOW,
                         onBeforeShow);

      // This gets around the problem where AdvancedToolTip thinks it's
      // receiving a ghost event because cursor position hasn't moved off of
      // (0, 0).
      card.cursorPosition = new goog.math.Coordinate(1, 1);
    }

    // Event handlers
    function onTrigger(event) {
      triggeredElement = event.anchor;
      if (showDelay) {
        card.setShowDelayMs(showDelay);
      }
      return true;
    }

    function onCancel(event) {
      cancelledElement = event.anchor;
    }

    function onBeforeShow() {
      shownCard = card.getAnchorElement();
      if (hideDelay) {
        card.setHideDelayMs(hideDelay);
      }
      return true;
    }

    function tearDown() {
      card.dispose();
      timer.uninstall();
    }

    /**
     * Verify that hovercard displays and goes away under normal circumstances.
     */
    function testTrigger() {
      initCard();

      // Mouse over correct element fires trigger
      showDelay = 500;
      goog.testing.events.fireMouseOverEvent(john, elsewhere);
      assertEquals('Hovercard should have triggered', john,
                   triggeredElement);

      // Show card after delay
      timer.tick(showDelay - 1);
      assertNull('Card should not have shown', shownCard);
      assertFalse(card.isVisible());
      hideDelay = 5000;
      timer.tick(1);
      assertEquals('Card should have shown', john, shownCard);
      assertTrue(card.isVisible());

      // Mouse out leads to hide delay
      goog.testing.events.fireMouseOutEvent(john, elsewhere);
      goog.testing.events.fireMouseMoveEvent(document, offAnchor);
      timer.tick(hideDelay - 1);
      assertTrue('Card should still be visible', card.isVisible());
      timer.tick(10);
      assertFalse('Card should be hidden', card.isVisible());
    }

    /**
     * Verify that CANCEL_TRIGGER event occurs when mouse goes out of
     * triggering element before hovercard is shown.
     */
    function testOnCancel() {
      initCard();

      showDelay = 500;
      goog.testing.events.fireMouseOverEvent(john, elsewhere);
      timer.tick(showDelay - 1);
      goog.testing.events.fireMouseOutEvent(john, elsewhere);
      goog.testing.events.fireMouseMoveEvent(document, offAnchor);
      timer.tick(10);
      assertFalse('Card should be hidden', card.isVisible());
      assertEquals('Should have cancelled trigger', john, cancelledElement);
    }

    /**
     * Verify that mousing over non-triggering elements don't interfere.
     */
    function testMouseOverNonTrigger() {
      initCard();

      // Mouse over correct element fires trigger
      showDelay = 500;
      goog.testing.events.fireMouseOverEvent(john, elsewhere);
      timer.tick(showDelay);

      // Mouse over and out other element does nothing
      triggeredElement = null;
      goog.testing.events.fireMouseOverEvent(jane, elsewhere);
      timer.tick(showDelay + 1);
      assertNull(triggeredElement);
    }

    /**
     * Verify that a mouse over event with no target will not break
     * hover card.
     */
    function testMouseOverNoTarget() {
      initCard();
      card.handleTriggerMouseOver_(new goog.testing.events.Event());
    }

    /**
     * Verify that mousing over a second trigger before the first one shows
     * will correctly cancel the first and show the second.
     */
    function testMultipleTriggers() {
      initCard();

      // Test second trigger when first one still pending
      showDelay = 500;
      hideDelay = 1000;
      goog.testing.events.fireMouseOverEvent(john, elsewhere);
      timer.tick(250);
      goog.testing.events.fireMouseOutEvent(john, james);
      goog.testing.events.fireMouseOverEvent(james, john);
      // First trigger should cancel because it isn't showing yet
      assertEquals('Should cancel first trigger', john, cancelledElement);
      timer.tick(300);
      assertFalse(card.isVisible());
      timer.tick(250);
      assertEquals('Should show second card', james, shownCard);
      assertTrue(card.isVisible());

      goog.testing.events.fireMouseOutEvent(james, john);
      goog.testing.events.fireMouseOverEvent(john, james);
      assertEquals('Should still show second card', james,
                   card.getAnchorElement());
      assertTrue(card.isVisible());

      shownCard = null;
      timer.tick(501);
      assertEquals('Should show first card again', john, shownCard);
      assertTrue(card.isVisible());

      // Test that cancelling while another is showing gives correct cancel
      // information
      cancelledElement = null;
      goog.testing.events.fireMouseOutEvent(john, james);
      goog.testing.events.fireMouseOverEvent(james, john);
      goog.testing.events.fireMouseOutEvent(james, elsewhere);
      assertEquals('Should cancel second card', james, cancelledElement);
    }

    /**
     * Verify manual triggering.
     */
    function testManualTrigger() {
      initCard();

      // Doesn't normally trigger for div tag
      showDelay = 500;
      goog.testing.events.fireMouseOverEvent(bill, elsewhere);
      timer.tick(showDelay);
      assertFalse(card.isVisible());

      // Manually trigger element
      card.triggerForElement(bill);
      hideDelay = 600;
      timer.tick(showDelay);
      assertTrue(card.isVisible());
      goog.testing.events.fireMouseOutEvent(bill, elsewhere);
      goog.testing.events.fireMouseMoveEvent(document, offAnchor);
      timer.tick(hideDelay);
      assertFalse(card.isVisible());
    }

    /**
     * Verify creating with isAnchor function.
     */
    function testIsAnchor() {
      // Initialize card so only bill triggers it.
      initCard(function(element) {
        return element == bill;
      });

      showDelay = 500;
      goog.testing.events.fireMouseOverEvent(bill, elsewhere);
      timer.tick(showDelay);
      assertTrue('Should trigger card', card.isVisible());

      hideDelay = 300;
      goog.testing.events.fireMouseOutEvent(bill, elsewhere);
      goog.testing.events.fireMouseMoveEvent(document, offAnchor);
      timer.tick(hideDelay);
      assertFalse(card.isVisible());

      goog.testing.events.fireMouseOverEvent(john, elsewhere);
      timer.tick(showDelay);
      assertFalse('Should not trigger card', card.isVisible());
    }

    /**
     * Verify mouse over child of anchor triggers hovercard.
     */
    function testAnchorWithChildren() {
      initCard();

      showDelay = 500;
      goog.testing.events.fireMouseOverEvent(james, elsewhere);
      timer.tick(250);

      // Moving from an anchor to a child of that anchor shouldn't cancel
      // or retrigger.
      var childBounds = goog.style.getBounds(child);
      var inChild = new goog.math.Coordinate(childBounds.left + 1,
                                             childBounds.top + 1);
      goog.testing.events.fireMouseOutEvent(james, child);
      goog.testing.events.fireMouseMoveEvent(child, inChild);
      assertNull("Shouldn't cancel trigger", cancelledElement);
      triggeredElement = null;
      goog.testing.events.fireMouseOverEvent(child, james);
      assertNull("Shouldn't retrigger card", triggeredElement);
      timer.tick(250);
      assertTrue('Card should show with original delay', card.isVisible());

      hideDelay = 300;
      goog.testing.events.fireMouseOutEvent(child, elsewhere);
      goog.testing.events.fireMouseMoveEvent(child, offAnchor);
      timer.tick(hideDelay);
      assertFalse(card.isVisible());

      goog.testing.events.fireMouseOverEvent(child, elsewhere);
      timer.tick(showDelay);
      assertTrue('Mouse over child should trigger card', card.isVisible());
    }

    function testNoTriggerWithMaxSearchSteps() {
      initCard(undefined, true, 0);

      showDelay = 500;
      goog.testing.events.fireMouseOverEvent(child, elsewhere);
      timer.tick(showDelay);
      assertFalse('Should not trigger card', card.isVisible());
    }

    function testTriggerWithMaxSearchSteps() {
      initCard(undefined, true, 2);

      showDelay = 500;
      goog.testing.events.fireMouseOverEvent(child, elsewhere);
      timer.tick(showDelay);
      assertTrue('Should trigger card', card.isVisible());
    }

  ">10 of 10 tests run in 17ms.<br />0 passed, 10 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testAnchorWithChildren<br />Object #<Object> has no method 'createElement'<br />ERROR in testIsAnchor<br />Object #<Object> has no method 'createElement'<br />ERROR in testManualTrigger<br />Object #<Object> has no method 'createElement'<br />ERROR in testMouseOverNoTarget<br />Object #<Object> has no method 'createElement'<br />ERROR in testMouseOverNonTrigger<br />Object #<Object> has no method 'createElement'<br />ERROR in testMultipleTriggers<br />Object #<Object> has no method 'createElement'<br />ERROR in testNoTriggerWithMaxSearchSteps<br />Object #<Object> has no method 'createElement'<br />ERROR in testOnCancel<br />Object #<Object> has no method 'createElement'<br />ERROR in testTrigger<br />Object #<Object> has no method 'createElement'<br />ERROR in testTriggerWithMaxSearchSteps<br />Object #<Object> has no method 'createElement'<br />ERROR in _tmpclosuretest.js<br />ERROR: Test did not restore setTimeout<br /></td></tr>
<tr><td>filteredmenu_test.html</td><td>Fail</td><td> 0 passed, 7 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.events.Event');
  goog.require('goog.style');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.FilteredMenu');
  goog.require('goog.ui.MenuItem');



var sandbox;

function setUp() {
  sandbox = goog.dom.getElement('sandbox');
}


function tearDown() {
  sandbox.innerHTML = '';
}


function testRender() {
  menu = new goog.ui.FilteredMenu();
  menu.addItem(new goog.ui.MenuItem('Menu Item 1'));
  menu.addItem(new goog.ui.MenuItem('Menu Item 2'));
  menu.render(sandbox);

  assertEquals('Menu should contain two items.', 2, menu.getChildCount());
  assertEquals('Caption of first menu item should match supplied value.',
               'Menu Item 1',
               menu.getItemAt(0).getCaption());
  assertEquals('Caption of second menu item should match supplied value.',
               'Menu Item 2',
               menu.getItemAt(1).getCaption());
  assertTrue('Caption of first item should be in document.',
              sandbox.innerHTML.indexOf('Menu Item 1') != -1);
  assertTrue('Caption of second item should be in document.',
              sandbox.innerHTML.indexOf('Menu Item 2') != -1);

  menu.dispose();
}


function testDecorate() {
  menu = new goog.ui.FilteredMenu();
  menu.decorate(goog.dom.getElement('testmenu'));

  assertEquals('Menu should contain four items.', 4, menu.getChildCount());
  assertEquals('Caption of menu item should match decorated element',
               'Apple',
               menu.getItemAt(0).getCaption());
  assertEquals('Caption of menu item should match decorated element',
               'Lemon',
               menu.getItemAt(1).getCaption());
  assertEquals('Caption of menu item should match decorated element',
               'Orange',
               menu.getItemAt(2).getCaption());
  assertEquals('Caption of menu item should match decorated element',
               'Strawberry',
               menu.getItemAt(3).getCaption());

  menu.dispose();
}


function testDisposeClearsAllListeners() {
  menu = new goog.ui.FilteredMenu();
  menu.addItem(new goog.ui.MenuItem('Menu Item 1'));
  menu.addItem(new goog.ui.MenuItem('Menu Item 2'));
  menu.render(sandbox);
  menu.dispose();

  assertEquals('Dispose should clear all listeners.',
               0,
               goog.events.getTotalListenerCount());
}


function testFilter() {
  menu = new goog.ui.FilteredMenu();
  menu.addItem(new goog.ui.MenuItem('Family'));
  menu.addItem(new goog.ui.MenuItem('Friends'));
  menu.addItem(new goog.ui.MenuItem('Photos'));
  menu.addItem(new goog.ui.MenuItem('Work'));

  menu.render(sandbox);

  // Check menu items.
  assertEquals('Family should be the first label in the move to menu',
               'Family', menu.getChildAt(0).getCaption());
  assertEquals('Friends should be the second label in the move to menu',
               'Friends', menu.getChildAt(1).getCaption());
  assertEquals('Photos should be the third label in the move to menu',
               'Photos', menu.getChildAt(2).getCaption());
  assertEquals('Work should be the fourth label in the move to menu',
               'Work', menu.getChildAt(3).getCaption());

  // Filter menu.
  menu.setFilter('W');
  assertFalse('Family should not be visible when the menu is filtered',
              menu.getChildAt(0).isVisible());
  assertFalse('Friends should not be visible when the menu is filtered',
              menu.getChildAt(1).isVisible());
  assertFalse('Photos should not be visible when the menu is filtered',
              menu.getChildAt(2).isVisible());
  assertTrue('Work should be visible when the menu is filtered',
             menu.getChildAt(3).isVisible());

  menu.setFilter('W,');
  for (var i = 0; i < menu.getChildCount(); i++) {
    assertFalse('W, should not match anything with allowMultiple set to false',
               menu.getChildAt(i).isVisible());
  }

  // Clear filter.
  menu.setFilter('');
  for (var i = 0; i < menu.getChildCount(); i++) {
    assertTrue('All items should be visible', menu.getChildAt(i).isVisible());
  }

  menu.dispose();
}


function testFilterAllowMultiple() {
  menu = new goog.ui.FilteredMenu();
  menu.setAllowMultiple(true);
  menu.addItem(new goog.ui.MenuItem('Family'));
  menu.addItem(new goog.ui.MenuItem('Friends'));
  menu.addItem(new goog.ui.MenuItem('Photos'));
  menu.addItem(new goog.ui.MenuItem('Work'));

  menu.render(sandbox);

  // Filter menu.
  menu.setFilter('W,');
  for (var i = 0; i < menu.getChildCount(); i++) {
    assertTrue('W, should show all items with allowMultiple set to true',
               menu.getChildAt(i).isVisible());
  }

  // Filter second label.
  menu.setFilter('Work,P');
  assertFalse('Family should not be visible when the menu is filtered',
              menu.getChildAt(0).isVisible());
  assertFalse('Friends should not be visible when the menu is filtered',
              menu.getChildAt(1).isVisible());
  assertTrue('Photos should be visible when the menu is filtered',
             menu.getChildAt(2).isVisible());
  assertFalse('Work should not be visible when the menu is filtered',
              menu.getChildAt(3).isVisible());

  // Clear filter.
  menu.setFilter('');
  for (var i = 0; i < menu.getChildCount(); i++) {
    assertTrue('All items should be visible', menu.getChildAt(i).isVisible());
  }

  menu.dispose();
}


function testFilterWordBoundary() {
  menu = new goog.ui.FilteredMenu();
  menu.addItem(new goog.ui.MenuItem('Vacation Photos'));
  menu.addItem(new goog.ui.MenuItem('Work'));
  menu.addItem(new goog.ui.MenuItem('Receipts & Invoices'));
  menu.addItem(new goog.ui.MenuItem('Invitations'));
  menu.addItem(new goog.ui.MenuItem('3.Family'));
  menu.addItem(new goog.ui.MenuItem('No:Farm'));
  menu.addItem(new goog.ui.MenuItem('Syd/Family'));

  menu.render(sandbox);

  // Filter menu.
  menu.setFilter('Photos');
  assertTrue('Vacation Photos should be visible when the menu is filtered',
             menu.getChildAt(0).isVisible());
  assertFalse('Work should not be visible when the menu is filtered',
              menu.getChildAt(1).isVisible());
  assertFalse('Receipts & Invoices should not be visible when the menu is ' +
              'filtered',
              menu.getChildAt(2).isVisible());
  assertFalse('Invitations should not be visible when the menu is filtered',
              menu.getChildAt(3).isVisible());

  menu.setFilter('I');
  assertFalse('Vacation Photos should not be visible when the menu is filtered',
             menu.getChildAt(0).isVisible());
  assertFalse('Work should not be visible when the menu is filtered',
              menu.getChildAt(1).isVisible());
  assertTrue('Receipts & Invoices should be visible when the menu is filtered',
             menu.getChildAt(2).isVisible());
  assertTrue('Invitations should be visible when the menu is filtered',
             menu.getChildAt(3).isVisible());

  menu.setFilter('Fa');
  assertTrue('3.Family should be visible when the menu is filtered',
             menu.getChildAt(4).isVisible());
  assertTrue('No:Farm should be visible when the menu is filtered',
             menu.getChildAt(5).isVisible());
  assertTrue('Syd/Family should be visible when the menu is filtered',
             menu.getChildAt(6).isVisible());

  menu.dispose();
}


function testScrollIntoView() {
  menu = new goog.ui.FilteredMenu();
  menu.addItem(new goog.ui.MenuItem('Family'));
  menu.addItem(new goog.ui.MenuItem('Friends'));
  menu.addItem(new goog.ui.MenuItem('Photos'));
  menu.addItem(new goog.ui.MenuItem('Work'));
  menu.render(sandbox);

  menu.setHighlightedIndex(0);
  assertTrue('Highlighted item should be visible', isHighlightedVisible(menu));
  menu.setHighlightedIndex(1);
  assertTrue('Highlighted item should be visible', isHighlightedVisible(menu));
  menu.setHighlightedIndex(2);
  assertTrue('Highlighted item should be visible', isHighlightedVisible(menu));
  menu.setHighlightedIndex(3);
  assertTrue('Highlighted item should be visible', isHighlightedVisible(menu));
  menu.setHighlightedIndex(0);
  assertTrue('Highlighted item should be visible', isHighlightedVisible(menu));

  menu.dispose();
}


function isHighlightedVisible(menu) {
  var contRect = goog.style.getBounds(menu.getContentElement());
  var itemRect = goog.style.getBounds(menu.getHighlighted().getElement());
  return contRect.contains(itemRect);
}

">7 of 7 tests run in 24ms.<br />0 passed, 7 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testDecorate<br />Invalid element to decorate<br />ERROR in testDisposeClearsAllListeners<br />Object #<Object> has no method 'createElement'<br />ERROR in testFilter<br />Object #<Object> has no method 'createElement'<br />ERROR in testFilterAllowMultiple<br />Object #<Object> has no method 'createElement'<br />ERROR in testFilterWordBoundary<br />Object #<Object> has no method 'createElement'<br />ERROR in testRender<br />Object #<Object> has no method 'createElement'<br />ERROR in testScrollIntoView<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>container_test.html</td><td>Fail</td><td> 0 passed, 20 failed.</td><td title="

    goog.require('goog.Disposable');
    goog.require('goog.dom');
    goog.require('goog.dom.classes');
    goog.require('goog.testing.events');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.Container');
    goog.require('goog.ui.Container.EventType');
    goog.require('goog.ui.Control');
  

    var sandbox = goog.dom.getElement('sandbox');
    var containerElement;
    var container;
    var keyContainer;
    var listContainer;

    function setUp() {
      container = new goog.ui.Container();
      keyContainer = null;
      listContainer = null;

      sandbox.innerHTML =
          '<div id="containerElement" class="goog-container">\n' +
          '  <div class="goog-control">Hello</div>\n' +
          '  <div class="goog-control">World</div>\n' +
          '</div>';
      containerElement = goog.dom.getElement('containerElement');
    }

    function tearDown() {
      goog.dom.removeChildren(sandbox);
      container.dispose();
      goog.events.removeAll();
      goog.dispose(keyContainer);
      goog.dispose(listContainer);
    }

    function testDecorateHidden() {
      containerElement.style.display = 'none';

      assertTrue('Container must be visible', container.isVisible());
      container.decorate(containerElement);
      assertFalse('Container must be hidden', container.isVisible());
      container.forEachChild(function(control) {
        assertTrue('Child control ' + control.getId() + ' must report being ' +
            'visible, even if in a hidden container', control.isVisible());
      });
    }

    function testDecorateDisabled() {
      goog.dom.classes.add(containerElement, 'goog-container-disabled');

      assertTrue('Container must be enabled', container.isEnabled());
      container.decorate(containerElement);
      assertFalse('Container must be disabled', container.isEnabled());
      container.forEachChild(function(control) {
        assertFalse('Child control ' + control.getId() + ' must be disabled, ' +
            'because the host container is disabled', control.isEnabled());
      });
    }

    function testDecorateFocusableContainer() {
      container.decorate(containerElement);
      assertTrue('Container must be focusable', container.isFocusable());
      container.forEachChild(function(control) {
        assertFalse('Child control ' + control.getId() + ' must not be ' +
            'focusable',
            control.isSupportedState(goog.ui.Component.State.FOCUSED));
      });
    }

    function testDecorateFocusableChildrenContainer() {
      container.setFocusable(false);
      container.setFocusableChildrenAllowed(true);
      container.decorate(containerElement);
      assertFalse('Container must not be focusable', container.isFocusable());
      container.forEachChild(function(control) {
        assertTrue('Child control ' + control.getId() + ' must be ' +
            'focusable',
            control.isSupportedState(goog.ui.Component.State.FOCUSED));
      });
    }

    function testHighlightOnEnter() {
      // This interaction test ensures that containers enforce that children
      // get highlighted on mouseover, and that one and only one child may
      // be highlighted at a time.  Although integration tests aren't the
      // best, it's difficult to test these event-based interactions due to
      // their disposition toward the "misunderstood contract" problem.

      container.decorate(containerElement);
      assertFalse('Child 0 should initially not be highlighted',
          container.getChildAt(0).isHighlighted());

      goog.testing.events.fireMouseOverEvent(
          container.getChildAt(0).getElement(), sandbox);
      assertTrue('Child 0 should become highlighted after a mouse over',
          container.getChildAt(0).isHighlighted());

      goog.testing.events.fireMouseOverEvent(
          container.getChildAt(1).getElement(),
          container.getChildAt(0).getElement());
      assertFalse('Child 0 should lose highlight when child 1 is moused ' +
          'over, even if no mouseout occurs.',
          container.getChildAt(0).isHighlighted());
      assertTrue('Child 1 should now be highlighted.',
          container.getChildAt(1).isHighlighted());
    }

    function testHighlightOnEnterPreventable() {
      container.decorate(containerElement);
      goog.events.listen(container, goog.ui.Component.EventType.ENTER,
          function(event) {
            event.preventDefault();
          });
      goog.testing.events.fireMouseOverEvent(
          container.getChildAt(0).getElement(), sandbox);
      assertFalse('Child 0 should not be highlighted if preventDefault called',
          container.getChildAt(0).isHighlighted());
    }

    function testHighlightDisabled() {
      // Another interaction test.  Already tested in control_test.
      container.decorate(containerElement);
      container.getChildAt(0).setEnabled(false);
      goog.testing.events.fireMouseOverEvent(
          container.getChildAt(0).getElement(), sandbox);
      assertFalse('Disabled children should not be highlighted',
          container.getChildAt(0).isHighlighted());
    }

    function testGetOwnerControl() {
      container.decorate(containerElement);

      assertEquals('Must return appropriate control given an element in the ' +
          'control.',
          container.getChildAt(1),
          container.getOwnerControl(container.getChildAt(1).getElement()));

      assertNull('Must return null for element not associated with control.',
          container.getOwnerControl(document.body));
      assertNull('Must return null if given null node',
          container.getOwnerControl(null));
    }

    function testShowEvent() {
      container.decorate(containerElement);
      container.setVisible(false);
      var eventFired = false;
      goog.events.listen(container, goog.ui.Component.EventType.SHOW,
          function() {
            assertFalse('Container must not be visible when SHOW event is ' +
                        'fired',
                        container.isVisible());
            eventFired = true;
          });
      container.setVisible(true);
      assertTrue('SHOW event expected', eventFired);
    }

    function testAfterShowEvent() {
      container.decorate(containerElement);
      container.setVisible(false);
      var eventFired = false;
      goog.events.listen(container, goog.ui.Container.EventType.AFTER_SHOW,
          function() {
            assertTrue('Container must be visible when AFTER_SHOW event is ' +
                       'fired',
                       container.isVisible());
            eventFired = true;
          });
      container.setVisible(true);
      assertTrue('AFTER_SHOW event expected', eventFired);
    }

    function testHideEvents() {
      var events = [];
      container.decorate(containerElement);
      container.setVisible(true);
      var eventFired = false;
      goog.events.listen(container, goog.ui.Component.EventType.HIDE,
          function(e) {
            assertTrue(
                'Container must be visible when HIDE event is fired',
                container.isVisible());
            events.push(e.type);
          });
      goog.events.listen(container, goog.ui.Container.EventType.AFTER_HIDE,
          function(e) {
            assertFalse(
                'Container must not be visible when AFTER_HIDE event is fired',
                container.isVisible());
            events.push(e.type);
          });
      container.setVisible(false);
      assertArrayEquals('HIDE event followed by AFTER_HIDE expected', [
            goog.ui.Component.EventType.HIDE,
            goog.ui.Container.EventType.AFTER_HIDE
          ], events);
    }

    /**
     * Test container to which the elements have to be added with
     * {@code container.addChild(element, false)}
     * @constructor
     * @extends {goog.ui.Container}
     */
    function ListContainer() {
      goog.ui.Container.call(this);
    }
    goog.inherits(ListContainer, goog.ui.Container);

    /** @inheritDoc */
    ListContainer.prototype.createDom = function() {
      ListContainer.superClass_.createDom.call(this);
      var ul = this.getDomHelper().createDom('ul');
      this.forEachChild(function(child) {
        child.createDom();
        var childEl = child.getElement();
        ul.appendChild(this.getDomHelper().createDom('li', {}, childEl));
      }, this);
      this.getContentElement().appendChild(ul);
    };

    function testGetOwnerControlWithNoRenderingInAddChild() {
      listContainer = new ListContainer();
      var control = new goog.ui.Control('item');
      listContainer.addChild(control);
      listContainer.render();
      var ownerControl = listContainer.getOwnerControl(control.getElement());

      assertEquals('Control was added with addChild(control, false)',
          control, ownerControl);
    }

    /**
     * Test container for tracking key events being handled.
     * @constructor
     * @extends {goog.ui.Container}
     */
    function KeyHandlingContainer() {
      goog.ui.Container.call(this);
      this.keyEventsHandled = 0;
    }
    goog.inherits(KeyHandlingContainer, goog.ui.Container);

    /** @inheritDoc */
    KeyHandlingContainer.prototype.handleKeyEventInternal = function() {
      this.keyEventsHandled++;
      return false;
    };

    function testHandleKeyEvent_onlyHandlesWhenVisible() {
      keyContainer = new KeyHandlingContainer();
      keyContainer.decorate(containerElement);

      keyContainer.setVisible(false);
      keyContainer.handleKeyEvent(new goog.events.Event());
      assertEquals('No key events should be handled',
          0, keyContainer.keyEventsHandled);

      keyContainer.setVisible(true);
      keyContainer.handleKeyEvent(new goog.events.Event());
      assertEquals('One key event should be handled',
          1, keyContainer.keyEventsHandled);
    }

    function testHandleKeyEvent_onlyHandlesWhenEnabled() {
      keyContainer = new KeyHandlingContainer();
      keyContainer.decorate(containerElement);
      keyContainer.setVisible(true);

      keyContainer.setEnabled(false);
      keyContainer.handleKeyEvent(new goog.events.Event());
      assertEquals('No key events should be handled',
          0, keyContainer.keyEventsHandled);

      keyContainer.setEnabled(true);
      keyContainer.handleKeyEvent(new goog.events.Event());
      assertEquals('One key event should be handled',
          1, keyContainer.keyEventsHandled);
    }

    function testHandleKeyEvent_childlessContainersIgnoreKeyEvents() {
      keyContainer = new KeyHandlingContainer();
      keyContainer.render();
      keyContainer.setVisible(true);

      keyContainer.handleKeyEvent(new goog.events.Event());
      assertEquals('No key events should be handled',
          0, keyContainer.keyEventsHandled);

      keyContainer.addChild(new goog.ui.Control());
      keyContainer.handleKeyEvent(new goog.events.Event());
      assertEquals('One key event should be handled',
          1, keyContainer.keyEventsHandled);
    }

    function testHandleKeyEvent_alwaysHandlesWithKeyEventTarget() {
      keyContainer = new KeyHandlingContainer();
      keyContainer.render();
      keyContainer.setKeyEventTarget(goog.dom.createDom('div'));
      keyContainer.setVisible(true);

      keyContainer.handleKeyEvent(new goog.events.Event());
      assertEquals('One key events should be handled',
          1, keyContainer.keyEventsHandled);
    }

    function testHandleKeyEventInternal_onlyHandlesUnmodified() {
      container.setKeyEventTarget(sandbox);
      var event = new goog.events.KeyEvent(
          goog.events.KeyCodes.ESC, 0, false, null);

      var propertyNames = [
        'shiftKey',
        'altKey',
        'ctrlKey',
        'metaKey'
      ];

      // Verify that the event is not handled whenever a modifier key is true.
      for (var i = 0, propertyName; propertyName = propertyNames[i]; i++) {
        assertTrue('Event should be handled when modifer key is not pressed.',
            container.handleKeyEventInternal(event));
        event[propertyName] = true;
        assertFalse('Event should not be handled when modifer key is pressed.',
            container.handleKeyEventInternal(event));
        event[propertyName] = false;
      }
    }

    function testOpenFollowsHighlight() {
      container.decorate(containerElement);
      container.setOpenFollowsHighlight(true);
      assertTrue('isOpenFollowsHighlight should return true',
          container.isOpenFollowsHighlight());

      // Make the children openable.
      container.forEachChild(function(child) {
        child.setSupportedState(goog.ui.Component.State.OPENED, true);
      });
      // Open child 1 initially.
      container.getChildAt(1).setOpen(true);

      assertFalse('Child 0 should initially not be highlighted',
          container.getChildAt(0).isHighlighted());
      goog.testing.events.fireMouseOverEvent(
          container.getChildAt(0).getElement(), sandbox);
      assertTrue('Child 0 should become highlighted after a mouse over',
          container.getChildAt(0).isHighlighted());
      assertTrue('Child 0 should become open after higlighted',
          container.getChildAt(0).isOpen());
      assertFalse('Child 1 should become closed once 0 is open',
          container.getChildAt(1).isOpen());
      assertEquals('OpenItem should be child 0',
          container.getChildAt(0), container.getOpenItem());
    }

    function testOpenNotFollowsHighlight() {
      container.decorate(containerElement);
      container.setOpenFollowsHighlight(false);
      assertFalse('isOpenFollowsHighlight should return false',
          container.isOpenFollowsHighlight());

      // Make the children openable.
      container.forEachChild(function(child) {
        child.setSupportedState(goog.ui.Component.State.OPENED, true);
      });
      // Open child 1 initially.
      container.getChildAt(1).setOpen(true);

      assertFalse('Child 0 should initially not be highlighted',
          container.getChildAt(0).isHighlighted());
      goog.testing.events.fireMouseOverEvent(
          container.getChildAt(0).getElement(), sandbox);
      assertTrue('Child 0 should become highlighted after a mouse over',
          container.getChildAt(0).isHighlighted());
      assertFalse('Child 0 should remain closed after higlighted',
          container.getChildAt(0).isOpen());
      assertTrue('Child 1 should remain open',
          container.getChildAt(1).isOpen());
      assertEquals('OpenItem should be child 1',
          container.getChildAt(1), container.getOpenItem());
    }

    function testRemoveChild() {
      goog.dom.removeChildren(containerElement);
      container.decorate(containerElement);

      var a = new goog.ui.Control('A');
      var b = new goog.ui.Control('B');
      var c = new goog.ui.Control('C');

      a.setId('a');
      b.setId('b');
      c.setId('c');

      container.addChild(a, true);
      container.addChild(b, true);
      container.addChild(c, true);

      container.setHighlightedIndex(2);

      assertEquals('Parent must remove and return child by ID', b,
          container.removeChild('b'));
      assertNull('Parent must no longer contain this child',
          container.getChild('b'));
      assertEquals('Highlighted index must be decreased', 1,
          container.getHighlightedIndex());
      assertTrue('The removed control must handle its own mouse events',
          b.isHandleMouseEvents());

      assertEquals('Parent must remove and return child', c,
          container.removeChild(c));
      assertNull('Parent must no longer contain this child',
          container.getChild('c'));
      assertFalse('This child must no longer be highlighted',
          c.isHighlighted());
      assertTrue('The removed control must handle its own mouse events',
          c.isHandleMouseEvents());

      assertEquals('Parent must remove and return child by index', a,
          container.removeChildAt(0));
      assertNull('Parent must no longer contain this child',
          container.getChild('a'));
      assertTrue('The removed control must handle its own mouse events',
          a.isHandleMouseEvents());
    }
  ">20 of 20 tests run in 26ms.<br />0 passed, 20 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testAfterShowEvent<br />Invalid element to decorate<br />ERROR in testDecorateDisabled<br />Invalid element to decorate<br />ERROR in testDecorateFocusableChildrenContainer<br />Invalid element to decorate<br />ERROR in testDecorateFocusableContainer<br />Invalid element to decorate<br />ERROR in testDecorateHidden<br />Cannot set property 'display' of undefined<br />ERROR in testGetOwnerControl<br />Invalid element to decorate<br />ERROR in testGetOwnerControlWithNoRenderingInAddChild<br />Object #<Object> has no method 'createElement'<br />ERROR in testHandleKeyEventInternal_onlyHandlesUnmodified<br />Object #<Object> has no method 'blur'<br />ERROR in testHandleKeyEvent_alwaysHandlesWithKeyEventTarget<br />Object #<Object> has no method 'createElement'<br />ERROR in testHandleKeyEvent_childlessContainersIgnoreKeyEvents<br />Object #<Object> has no method 'createElement'<br />ERROR in testHandleKeyEvent_onlyHandlesWhenEnabled<br />Invalid element to decorate<br />ERROR in testHandleKeyEvent_onlyHandlesWhenVisible<br />Invalid element to decorate<br />ERROR in testHideEvents<br />Invalid element to decorate<br />ERROR in testHighlightDisabled<br />Invalid element to decorate<br />ERROR in testHighlightOnEnter<br />Invalid element to decorate<br />ERROR in testHighlightOnEnterPreventable<br />Invalid element to decorate<br />ERROR in testOpenFollowsHighlight<br />Invalid element to decorate<br />ERROR in testOpenNotFollowsHighlight<br />Invalid element to decorate<br />ERROR in testRemoveChild<br />Invalid element to decorate<br />ERROR in testShowEvent<br />Invalid element to decorate<br /></td></tr>
<tr><td>menu_test.html</td><td>Fail</td><td> 0 passed, 3 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.events.Event');
  goog.require('goog.math');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.Component.EventType');
  goog.require('goog.ui.Menu');



var menu;
var clonedMenuDom;
    
function setUp() {
  clonedMenuDom = goog.dom.getElement('demoMenu').cloneNode(true);
  
  menu = new goog.ui.Menu();
}

function tearDown() {
  menu.dispose();

  var element = goog.dom.getElement('demoMenu');
  element.parentNode.replaceChild(clonedMenuDom, element);
}

/** @bug 1463524 */
function testMouseupDoesntActivateMenuItemImmediately() {
  menu.decorate(goog.dom.getElement('demoMenu'));

  var fakeEvent = {clientX: 42, clientY: 42};
  var itemElem = goog.dom.getElement('menuItem2');
  var coords = new goog.math.Coordinate(42, 42);

  var menuItem = menu.getChildAt(1);
  var actionDispatched = false;
  goog.events.listen(menuItem, goog.ui.Component.EventType.ACTION,
      function(e) {
        actionDispatched = true;
      });

  menu.setVisible(true, false, fakeEvent);
  // Makes the menu item active so it can be selected on mouseup.
  menuItem.setActive(true);

  goog.testing.events.fireMouseUpEvent(itemElem, undefined, coords);
  assertFalse('ACTION should not be dispatched after the initial mouseup',
              actionDispatched);

  goog.testing.events.fireMouseUpEvent(itemElem, undefined, coords);
  assertTrue('ACTION should be dispatched after the second mouseup',
             actionDispatched);

}

function testHoverBehavior() {
  menu.decorate(goog.dom.getElement('demoMenu'));

  goog.testing.events.fireMouseOverEvent(goog.dom.getElement('menuItem2'),
      document.body);
  assertEquals(1, menu.getHighlightedIndex());

  menu.exitDocument();
  assertEquals(-1, menu.getHighlightedIndex());
}

function testIndirectionDecoration() {
  menu.decorate(goog.dom.getElement('complexMenu'));
  
  goog.testing.events.fireMouseOverEvent(goog.dom.getElement('complexItem3'),
      document.body);
  assertEquals(2, menu.getHighlightedIndex());
  
  menu.exitDocument();
  assertEquals(-1, menu.getHighlightedIndex());
}

">3 of 3 tests run in 6ms.<br />0 passed, 3 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testHoverBehavior<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testIndirectionDecoration<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testMouseupDoesntActivateMenuItemImmediately<br />Object #<Object> has no method 'cloneNode'<br /></td></tr>
<tr><td>prompt_test.html</td><td>Fail</td><td> 0 passed, 1 failed.</td><td title="

  goog.require('goog.dom.selection');
  goog.require('goog.ui.Prompt');
  goog.require('goog.userAgent.product');
  goog.require('goog.testing.jsunit');



var prompt;

function setUp() {
  document.body.focus();
}

function tearDown() {
  goog.dispose(prompt);
}

function testFocusOnInputElement() {
  var promptResult = undefined;
  prompt = new goog.ui.Prompt('title', 'Prompt:', function(result) {
    promptResult = result;
  }, 'defaultValue');
  prompt.setVisible(true);

  if (goog.userAgent.product.CHROME) {
    // For some reason, this test fails non-deterministically on Chrome,
    // but only on the test farm.
    return;
  }
  assertEquals('defaultValue',
      goog.dom.selection.getText(prompt.userInputEl_));
}

// An interactive test so we can manually see what it looks like.
function newPrompt() {
  prompt = new goog.ui.Prompt('title', 'Prompt:', function(result) {
    alert('Result: ' + result);
    goog.dispose(prompt);
  }, 'defaultValue');
  prompt.setVisible(true);
}

">1 of 1 tests run in 6ms.<br />0 passed, 1 failed.<br />6 ms/test. 1 files loaded.<br />ERROR in testFocusOnInputElement<br />Cannot call method 'focus' of undefined<br /></td></tr>
<tr><td>component_test.html</td><td>Fail</td><td> 24 passed, 15 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.dom.DomHelper');
    goog.require('goog.dom.NodeType');
    goog.require('goog.dom.TagName');
    goog.require('goog.string.StringBuffer');
    goog.require('goog.testing.PropertyReplacer');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.Component');
  

    var component;
    var propertyReplacer = new goog.testing.PropertyReplacer();
    var sandbox = goog.dom.getElement('sandbox');

    function setUp() {
      component = new goog.ui.Component();
    }

    function tearDown() {
      component.dispose();
      goog.dom.removeChildren(sandbox);
      propertyReplacer.reset();
    }

    function testConstructor() {
      assertTrue('Instance must be non-null and have the expected class',
          component instanceof goog.ui.Component);
      assertTrue('DOM helper must be non-null and have the expected class',
          component.dom_ instanceof goog.dom.DomHelper);

      var fakeDom = {};
      var otherComponent = new goog.ui.Component(fakeDom);
      assertEquals('DOM helper must refer to expected object', fakeDom,
          otherComponent.dom_);

      otherComponent.dispose();
    }

    function testGetId() {
      assertNull('Component ID should be initialized to null', component.id_);
      var id = component.getId();
      assertNotNull('Component ID should be generated on demand', id);
      assertEquals('Subsequent calls to getId() must return same value', id,
          component.getId());
    }

    function testSetId() {
      component.setId('myId');
      assertEquals('getId() must return explicitly set ID', 'myId',
          component.getId());

      var child = new goog.ui.Component();
      var childId = child.getId();
      component.addChild(child);
      assertEquals('Parent component must find child by ID', child,
          component.getChild(childId));

      child.setId('someNewId');
      assertEquals('Parent component must find child by new ID', child,
          component.getChild('someNewId'));

      child.dispose();
    }

    function testGetSetElement() {
      assertNull('Element must be null by default', component.getElement());
      var element = goog.dom.createElement(goog.dom.TagName.DIV);
      component.setElementInternal(element);
      assertEquals('getElement() must return expected element', element,
          component.getElement());
    }

    function testGetSetParent() {
      assertNull('Parent must be null by default', component.getParent());

      var parent = new goog.ui.Component();
      component.setParent(parent);
      assertEquals('getParent() must return expected component', parent,
          component.getParent());

      component.setParent(null);
      assertNull('Parent must be null', component.getParent());

      assertThrows('Setting a component\'s parent to itself must throw error',
          function() {
            component.setParent(component);
          });

      parent.addChild(component);
      assertEquals('getParent() must return expected component', parent,
          component.getParent());
      assertThrows('Changing a child component\'s parent must throw error',
          function() {
            component.setParent(new goog.ui.Component());
          });

      parent.dispose();
    }

    function testGetParentEventTarget() {
      assertNull('Parent event target must be null by default',
          component.getParentEventTarget());

      var parent = new goog.ui.Component();
      component.setParent(parent);
      assertEquals('Parent event target must be the parent component', parent,
          component.getParentEventTarget());
      assertThrows('Directly setting the parent event target to other than ' +
          'the parent component when the parent component is set must throw ' +
          'error',
          function() {
            component.setParentEventTarget(new goog.ui.Component());
          });

      parent.dispose();
    }

    function testSetParentEventTarget() {
      var parentEventTarget = new goog.events.EventTarget();
      component.setParentEventTarget(parentEventTarget);
      assertEquals('Parent component must be null', null,
          component.getParent());

      parentEventTarget.dispose();
    }

    function testGetDomHelper() {
      var domHelper = new goog.dom.DomHelper();
      var component = new goog.ui.Component(domHelper);
      assertEquals('Component must return the same DomHelper passed', domHelper,
          component.getDomHelper());
    }

    function testIsInDocument() {
      assertFalse('Component must not be in the document by default',
          component.isInDocument());
      component.enterDocument();
      assertTrue('Component must be in the document', component.isInDocument());
    }

    function testCreateDom() {
      assertNull('Component must not have DOM by default',
          component.getElement());
      component.createDom();
      assertEquals('Component\'s DOM must be an element node',
          goog.dom.NodeType.ELEMENT, component.getElement().nodeType);
    }

    function testRender() {
      assertFalse('Component must not be in the document by default',
          component.isInDocument());
      assertNull('Component must not have DOM by default',
          component.getElement());
      assertFalse('wasDecorated() must be false before component is rendered',
          component.wasDecorated());

      component.render(sandbox);
      assertTrue('Rendered component must be in the document',
          component.isInDocument());
      assertEquals('Component\'s element must be a child of the parent element',
          sandbox, component.getElement().parentNode);
      assertFalse('wasDecorated() must still be false for rendered component',
          component.wasDecorated());

      assertThrows('Trying to re-render component must throw error',
          function() {
            component.render();
          });
    }

    function testRender_NoParent() {
      component.render();
      assertTrue('Rendered component must be in the document',
          component.isInDocument());
      assertEquals('Component\'s element must be a child of the document body',
          document.body, component.getElement().parentNode);
    }

    function testRender_ParentNotInDocument() {
      var parent = new goog.ui.Component();
      component.setParent(parent);

      assertFalse('Parent component must not be in the document',
          parent.isInDocument());
      assertFalse('Child component must not be in the document',
          component.isInDocument());
      assertNull('Child component must not have DOM', component.getElement());

      component.render();
      assertFalse('Parent component must not be in the document',
          parent.isInDocument());
      assertFalse('Child component must not be in the document',
          component.isInDocument());
      assertNotNull('Child component must have DOM', component.getElement());

      parent.dispose();
    }


    function testRenderBefore() {
      var sibling = goog.dom.createElement(goog.dom.TagName.DIV);
      sandbox.appendChild(sibling);

      component.renderBefore(sibling);
      assertTrue('Rendered component must be in the document',
          component.isInDocument());
      assertEquals('Component\'s element must be a child of the parent element',
          sandbox, component.getElement().parentNode);
      assertEquals('Component\'s element must have expected nextSibling',
          sibling, component.getElement().nextSibling);
    }


    function testRenderChild() {
      var parent = new goog.ui.Component();

      parent.createDom();
      assertFalse('Parent must not be in the document', parent.isInDocument());
      assertNotNull('Parent must have a DOM', parent.getElement());

      parent.addChild(component);
      assertFalse('Child must not be in the document',
          component.isInDocument());
      assertNull('Child must not have a DOM', component.getElement());

      component.render(parent.getElement());
      assertFalse('Parent must not be in the document', parent.isInDocument());
      assertFalse('Child must not be in the document if the parent isn\'t',
          component.isInDocument());
      assertNotNull('Child must have a DOM', component.getElement());
      assertEquals('Child\'s element must be a child of the parent\'s element',
          parent.getElement(), component.getElement().parentNode);

      parent.render(sandbox);
      assertTrue('Parent must be in the document', parent.isInDocument());
      assertTrue('Child must be in the document', component.isInDocument());

      parent.dispose();
    }

    function testDecorate() {
      sandbox.innerHTML = '<div id="foo">Foo</div>';
      var foo = goog.dom.getElement('foo');

      assertFalse('wasDecorated() must be false by default',
          component.wasDecorated());

      component.decorate(foo);
      assertTrue('Component must be in the document', component.isInDocument());
      assertEquals('Component\'s element must be the decorated element', foo,
          component.getElement());
      assertTrue('wasDecorated() must be true for decorated component',
          component.wasDecorated());

      assertThrows('Trying to decorate with a control already in the document' +
          ' must throw error',
          function() {
            component.decorate(foo);
          });
    }

    function testCannotDecorate() {
      sandbox.innerHTML = '<div id="foo">Foo</div>';
      var foo = goog.dom.getElement('foo');

      // Have canDecorate() return false.
      propertyReplacer.set(component, 'canDecorate', function() {
        return false;
      });

      assertThrows('Trying to decorate an element for which canDecorate()' +
          ' returns false must throw error',
          function() {
            component.decorate(foo);
          });
    }

    function testCanDecorate() {
      assertTrue('canDecorate() must return true by default',
          component.canDecorate(sandbox));
    }

    function testWasDecorated() {
      assertFalse('wasDecorated() must return false by default',
          component.wasDecorated());
    }

    function testDecorateInternal() {
      assertNull('Element must be null by default', component.getElement());
      var element = goog.dom.createElement(goog.dom.TagName.DIV);
      component.decorateInternal(element);
      assertEquals('Element must have expected value', element,
          component.getElement());
    }

    function testEnterExitDocument() {
      var c1 = new goog.ui.Component();
      var c2 = new goog.ui.Component();

      component.addChild(c1);
      component.addChild(c2);

      component.createDom();
      c1.createDom();
      c2.createDom();

      assertFalse('Parent must not be in the document',
          component.isInDocument());
      assertFalse('Neither child must be in the document',
          c1.isInDocument() || c2.isInDocument());

      component.enterDocument();
      assertTrue('Parent must be in the document', component.isInDocument());
      assertTrue('Both children must be in the document',
          c1.isInDocument() && c2.isInDocument());

      component.exitDocument();
      assertFalse('Parent must not be in the document',
          component.isInDocument());
      assertFalse('Neither child must be in the document',
          c1.isInDocument() || c2.isInDocument());

      c1.dispose();
      c2.dispose();
    }

    function testDispose() {
      var c1, c2;

      component.createDom();
      component.addChild((c1 = new goog.ui.Component()), true);
      component.addChild((c2 = new goog.ui.Component()), true);

      var element = component.getElement();
      var c1Element = c1.getElement();
      var c2Element = c2.getElement();

      component.render(sandbox);
      assertTrue('Parent must be in the document', component.isInDocument());
      assertEquals('Parent\'s element must be a child of the sandbox element',
          sandbox, element.parentNode);
      assertTrue('Both children must be in the document',
          c1.isInDocument() && c2.isInDocument());
      assertEquals('First child\'s element must be a child of the parent\'s' +
          ' element', element, c1Element.parentNode);
      assertEquals('Second child\'s element must be a child of the parent\'s' +
          ' element', element, c2Element.parentNode);

      assertFalse('Parent must not have been disposed of',
          component.isDisposed());
      assertFalse('Neither child must have been disposed of',
          c1.isDisposed() || c2.isDisposed());

      component.dispose();
      assertTrue('Parent must have been disposed of', component.isDisposed());
      assertFalse('Parent must not be in the document',
          component.isInDocument());
      assertNotEquals('Parent\'s element must no longer be a child of the' +
          ' sandbox element', sandbox, element.parentNode);
      assertTrue('Both children must have been disposed of',
          c1.isDisposed() && c2.isDisposed());
      assertFalse('Neither child must be in the document',
          c1.isInDocument() || c2.isInDocument());
      assertNotEquals('First child\'s element must no longer be a child of' +
          ' the parent\'s element', element, c1Element.parentNode);
      assertNotEquals('Second child\'s element must no longer be a child of' +
          ' the parent\'s element', element, c2Element.parentNode);
    }

    function testDispose_Decorated() {
      sandbox.innerHTML = '<div id="foo">Foo</div>';
      var foo = goog.dom.getElement('foo');

      component.decorate(foo);
      assertTrue('Component must be in the document', component.isInDocument());
      assertFalse('Component must not have been disposed of',
          component.isDisposed());
      assertEquals('Component\'s element must have expected value', foo,
          component.getElement());
      assertEquals('Decorated element must be a child of the sandbox', sandbox,
          foo.parentNode);

      component.dispose();
      assertFalse('Component must not be in the document',
          component.isInDocument());
      assertTrue('Component must have been disposed of',
          component.isDisposed());
      assertNull('Component\'s element must be null', component.getElement());
      assertEquals('Previously decorated element must still be a child of the' +
          ' sandbox', sandbox, foo.parentNode);
    }

    function testMakeIdAndGetFragmentFromId() {
      assertEquals('Unique id must have expected value',
          component.getId() + '.foo', component.makeId('foo'));
      assertEquals('Fragment must have expected value', 'foo',
          component.getFragmentFromId(component.makeId('foo')));
    }

    function testGetElementByFragment() {
      component.render(sandbox);

      var element = component.dom_.createDom('DIV', {
        id: component.makeId('foo')
      }, 'Hello');
      sandbox.appendChild(element);

      assertEquals('Element must have expected value', element,
          component.getElementByFragment('foo'));
    }

    function testGetSetModel() {
      assertNull('Model must be null by default', component.getModel());

      var model = 'someModel';
      component.setModel(model);
      assertEquals('Model must have expected value', model,
          component.getModel());

      component.setModel(null);
      assertNull('Model must be null', component.getModel());
    }

    function testAddChild() {
      var child = new goog.ui.Component();
      child.setId('child');

      assertFalse('Parent must not be in the document',
          component.isInDocument());

      component.addChild(child);
      assertTrue('Parent must have children.', component.hasChildren());
      assertEquals('Child must have expected parent', component,
          child.getParent());
      assertEquals('Parent must find child by ID', child,
          component.getChild('child'));
    }

    function testAddChild_Render() {
      var child = new goog.ui.Component();

      component.render(sandbox);
      assertTrue('Parent must be in the document', component.isInDocument());
      assertEquals('Parent must be in the sandbox', sandbox,
          component.getElement().parentNode);

      component.addChild(child, true);
      assertTrue('Child must be in the document', child.isInDocument());
      assertEquals('Child element must be a child of the parent element',
          component.getElement(), child.getElement().parentNode);
    }

    function testAddChild_DomOnly() {
      var child = new goog.ui.Component();

      component.createDom();
      assertNotNull('Parent must have a DOM', component.getElement());
      assertFalse('Parent must not be in the document',
          component.isInDocument());

      component.addChild(child, true);
      assertNotNull('Child must have a DOM', child.getElement());
      assertEquals('Child element must be a child of the parent element',
          component.getElement(), child.getElement().parentNode);
      assertFalse('Child must not be in the document', child.isInDocument());
    }

    function testAddChildAt() {
      var a = new goog.ui.Component();
      var b = new goog.ui.Component();
      var c = new goog.ui.Component();
      var d = new goog.ui.Component();

      a.setId('a');
      b.setId('b');
      c.setId('c');
      d.setId('d');

      component.addChildAt(b, 0);
      assertEquals('b', component.getChildIds().join(''));
      component.addChildAt(d, 1);
      assertEquals('bd', component.getChildIds().join(''));
      component.addChildAt(a, 0);
      assertEquals('abd', component.getChildIds().join(''));
      component.addChildAt(c, 2);
      assertEquals('abcd', component.getChildIds().join(''));

      assertEquals(a, component.getChildAt(0));
      assertEquals(b, component.getChildAt(1));
      assertEquals(c, component.getChildAt(2));
      assertEquals(d, component.getChildAt(3));

      assertThrows('Adding child at out-of-bounds index must throw error',
          function() {
            component.addChildAt(new goog.ui.Component(), 5);
          });
    }

    function testHasChildren() {
      assertFalse('Component must not have children', component.hasChildren());

      component.addChildAt(new goog.ui.Component(), 0);
      assertTrue('Component must have children', component.hasChildren());

      component.removeChildAt(0);
      assertFalse('Component must not have children', component.hasChildren());
    }

    function testGetChildCount() {
      assertEquals('Component must have 0 children', 0,
          component.getChildCount());

      component.addChild(new goog.ui.Component());
      assertEquals('Component must have 1 child', 1,
          component.getChildCount());

      component.addChild(new goog.ui.Component());
      assertEquals('Component must have 2 children', 2,
          component.getChildCount());

      component.removeChildAt(1);
      assertEquals('Component must have 1 child', 1,
          component.getChildCount());

      component.removeChildAt(0);
      assertEquals('Component must have 0 children', 0,
          component.getChildCount());
    }

    function testGetChildIds() {
      var a = new goog.ui.Component();
      var b = new goog.ui.Component();

      a.setId('a');
      b.setId('b');

      component.addChild(a);
      assertEquals('a', component.getChildIds().join(''));

      component.addChild(b);
      assertEquals('ab', component.getChildIds().join(''));

      var ids = component.getChildIds();
      ids.push('c');
      assertEquals('Changes to the array returned by getChildIds() must not' +
          ' affect the component', 'ab', component.getChildIds().join(''));
    }

    function testGetChild() {
      assertNull('Parent must have no children', component.getChild('myId'));

      var c = new goog.ui.Component();
      c.setId('myId');
      component.addChild(c);
      assertEquals('Parent must find child by ID', c,
          component.getChild('myId'));

      c.setId('newId');
      assertNull('Parent must not find child by old ID',
          component.getChild('myId'));
      assertEquals('Parent must find child by new ID', c,
          component.getChild('newId'));
    }

    function testGetChildAt() {
      var a = new goog.ui.Component();
      var b = new goog.ui.Component();

      a.setId('a');
      b.setId('b');

      component.addChildAt(a, 0);
      assertEquals('Parent must find child by index', a,
          component.getChildAt(0));

      component.addChildAt(b, 1);
      assertEquals('Parent must find child by index', b,
          component.getChildAt(1));

      assertNull('Parent must return null for out-of-bounds index',
          component.getChildAt(3));
    }

    function testForEachChild() {
      var invoked = false;
      component.forEachChild(function(child) {
        assertNotNull('Child must never be null', child);
        invoked = true;
      });
      assertFalse('forEachChild must not call its argument if the parent has ' +
          'no children', invoked);

      component.addChild(new goog.ui.Component());
      component.addChild(new goog.ui.Component());
      component.addChild(new goog.ui.Component());
      var sb = new goog.string.StringBuffer();
      component.forEachChild(function(child, index) {
        // Note: This is just to test that 'this' is set correctly.
        var count = this.getChildCount();
        sb.append(index + 1).append(' of ').append(count);
        if (index < count - 1) {
          sb.append(', ');
        }
      }, component);
      assertEquals('1 of 3, 2 of 3, 3 of 3', sb.toString());
    }

    function testIndexOfChild() {
      var a = new goog.ui.Component();
      var b = new goog.ui.Component();
      var c = new goog.ui.Component();

      a.setId('a');
      b.setId('b');
      c.setId('c');

      component.addChild(a);
      assertEquals(0, component.indexOfChild(a));

      component.addChild(b);
      assertEquals(1, component.indexOfChild(b));

      component.addChild(c);
      assertEquals(2, component.indexOfChild(c));

      assertEquals('indexOfChild must return -1 for nonexistent child', -1,
          component.indexOfChild(new goog.ui.Component()));
    }

    function testRemoveChild() {
      var a = new goog.ui.Component();
      var b = new goog.ui.Component();
      var c = new goog.ui.Component();

      a.setId('a');
      b.setId('b');
      c.setId('c');

      component.addChild(a);
      component.addChild(b);
      component.addChild(c);

      assertEquals('Parent must remove and return child', c,
          component.removeChild(c));
      assertNull('Parent must no longer contain this child',
          component.getChild('c'));

      assertEquals('Parent must remove and return child by ID', b,
          component.removeChild('b'));
      assertNull('Parent must no longer contain this child',
          component.getChild('b'));

      assertEquals('Parent must remove and return child by index', a,
          component.removeChildAt(0));
      assertNull('Parent must no longer contain this child',
          component.getChild('a'));
    }

    function testMovingChildrenUsingAddChildAt() {
      component.render(sandbox);

      var a = new goog.ui.Component();
      var b = new goog.ui.Component();
      var c = new goog.ui.Component();
      var d = new goog.ui.Component();
      a.setElementInternal(goog.dom.createElement('a'));
      b.setElementInternal(goog.dom.createElement('b'));
      c.setElementInternal(goog.dom.createElement('c'));
      d.setElementInternal(goog.dom.createElement('d'));

      a.setId('a');
      b.setId('b');
      c.setId('c');
      d.setId('d');

      component.addChild(a);
      component.addChild(b);
      component.addChild(c);
      component.addChild(d);

      assertEquals('abcd', component.getChildIds().join(''));
      assertEquals(a, component.getChildAt(0));
      assertEquals(b, component.getChildAt(1));
      assertEquals(c, component.getChildAt(2));
      assertEquals(d, component.getChildAt(3));

      // Move child d to the top and b to the bottom.
      component.addChildAt(d, 0);
      component.addChildAt(b, 3);

      assertEquals('dacb', component.getChildIds().join(''));
      assertEquals(d, component.getChildAt(0));
      assertEquals(a, component.getChildAt(1));
      assertEquals(c, component.getChildAt(2));
      assertEquals(b, component.getChildAt(3));

      // Move child a to the top, and check that DOM nodes are in correct order.
      component.addChildAt(a, 0);
      assertEquals('adcb', component.getChildIds().join(''));
      assertEquals(a, component.getChildAt(0));
      assertEquals(a.getElement(), component.getElement().childNodes[0]);
    }
  ">39 of 39 tests run in 23ms.<br />24 passed, 15 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testAddChild_DomOnly<br />Object #<Object> has no method 'createElement'<br />ERROR in testAddChild_Render<br />Object #<Object> has no method 'createElement'<br />ERROR in testCreateDom<br />Object #<Object> has no method 'createElement'<br />ERROR in testDecorateInternal<br />Object #<Object> has no method 'createElement'<br />ERROR in testDispose<br />Object #<Object> has no method 'createElement'<br />ERROR in testDispose_Decorated<br />Decorated element must be a child of the sandbox<br />Expected <[object Object]> (Object) but was <undefined><br />> assertEquals at testing/asserts.js:289:3<br />> testDispose_Decorated at _tmpclosuretest.js:382:7<br />ERROR in testEnterExitDocument<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetElementByFragment<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetSetElement<br />Object #<Object> has no method 'createElement'<br />ERROR in testMovingChildrenUsingAddChildAt<br />Object #<Object> has no method 'createElement'<br />ERROR in testRender<br />Object #<Object> has no method 'createElement'<br />ERROR in testRenderBefore<br />Object #<Object> has no method 'createElement'<br />ERROR in testRenderChild<br />Object #<Object> has no method 'createElement'<br />ERROR in testRender_NoParent<br />Object #<Object> has no method 'createElement'<br />ERROR in testRender_ParentNotInDocument<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>roundedpanel_test.html</td><td>Fail</td><td> 0 passed, 1 failed.</td><td title="

    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.RoundedPanel');
    goog.require('goog.userAgent');
  

    /**
     * Tests goog.ui.RoundedPanel.create(), ensuring that the proper instance is
     * created based on user-agent
     */
    function testRoundedPanelCreate() {
      var rcp = goog.ui.RoundedPanel.create(15,
                                            5,
                                            '#cccccc',
                                            '#cccccc',
                                            goog.ui.RoundedPanel.Corner.ALL);

      if (goog.userAgent.GECKO && goog.userAgent.isVersion('1.9a')) {
        assertTrue('For Firefox 3.0+ (uses Gecko 1.9+), an instance of ' +
            'goog.ui.CssRoundedPanel should be returned.',
            rcp instanceof goog.ui.CssRoundedPanel);
      } else if (goog.userAgent.WEBKIT && goog.userAgent.isVersion('500')) {
        assertTrue('For Safari 3.0+, an instance of goog.ui.CssRoundedPanel ' +
            'should be returned.', rcp instanceof goog.ui.CssRoundedPanel);
      } else if (goog.userAgent.GECKO ||
                 goog.userAgent.IE ||
                 goog.userAgent.OPERA ||
                 goog.userAgent.WEBKIT) {
        assertTrue('For Gecko 1.8- (ex. Firefox 2.0-, Camino 1.5-, etc.), ' +
            'IE, Opera, and Safari 2.0-, an instance of ' +
            'goog.ui.GraphicsRoundedPanel should be returned.',
            rcp instanceof goog.ui.GraphicsRoundedPanel);
      } else {
        assertNull('For non-supported user-agents, null is returned.', rcp);
      }
    };
  ">1 of 1 tests run in 5ms.<br />0 passed, 1 failed.<br />5 ms/test. 1 files loaded.<br />ERROR in testRoundedPanelCreate<br />For non-supported user-agents, null is returned.<br />Expected <null> but was <[object Object]> (Object)<br />> assertNull at testing/asserts.js:316:3<br />> testRoundedPanelCreate at _tmpclosuretest.js:35:9<br /></td></tr>
<tr><td>plaintextspellchecker_test.html</td><td>Fail</td><td> 0 passed, 3 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.string.StringBuffer');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.PlainTextSpellChecker');



var missspelling = 'missspelling';
var iggnore = 'iggnore';
var vocabulary = ['test', 'words', 'a', 'few', missspelling, iggnore];

// We don't use Math.random() to make test predictable. Math.random is not
// repeatable, so a success on the dev machine != success in the lab (or on
// other dev machines). This is the same pseudorandom logic that CRT rand()
// uses.
var rseed = 1;
function random(range) {
  rseed = (rseed * 1103515245 + 12345) & 0xffffffff;
  return ((rseed >> 16) & 0x7fff) % range;
};

function localSpellCheckingFunction(words, spellChecker, callback) {
  var len = words.length;
  var results = [];
  for (var i = 0; i < len; i++) {
    var word = words[i];
    var found = false;
    // Last two words are considered misspellings
    for (var j = 0 ; j < vocabulary.length - 2 ; ++j) {
      if (vocabulary[j] == word) {
        found = true;
        break;
      }
    }
    if (found) {
      results.push([word, goog.spell.SpellCheck.WordStatus.VALID]);
    } else {
      results.push([word, goog.spell.SpellCheck.WordStatus.INVALID,
          ['foo','bar']]);
    }
  }
  callback.call(spellChecker, results);
};

function generateRandomSpace() {
  var string = '';
  var nSpace = 1 + random(4);
  for (var i = 0; i < nSpace ; ++i) {
    string += ' ';
  }
  return string;
};

function generateRandomString(maxWords, doQuotes) {
  var x = random(10);
  var string = '';
  if (doQuotes) {
    if (x == 0) {
      string = 'On xxxxx yyyy wrote:\n> ';
    } else if (x < 3) {
      string = '> ';
    }
  }

  var nWords = 1 + random(maxWords);
  for (var i = 0; i < nWords ; ++i) {
    string += vocabulary[random(vocabulary.length)];
    string += generateRandomSpace();
  }
  return string;
};

var timerQueue = [];
function processTimerQueue() {
  while (timerQueue.length > 0) {
    var fn = timerQueue.shift();
    fn();
  }
};

function localTimer(fn, delay, obj) {
  if (obj) {
    fn = goog.bind(fn, obj);
  }
  timerQueue.push(fn);
  return timerQueue.length;
};

function testPlainTextSpellCheckerNoQuotes() {
  var handler = new goog.spell.SpellCheck(localSpellCheckingFunction);
  var s = new goog.ui.PlainTextSpellChecker(handler);
  s.asyncWordsPerBatch_ = 100;
  var el = document.getElementById('test1');
  s.decorate(el);
  var text = '';
  for (var i = 0 ; i < 10 ; ++i) {
    text += generateRandomString(10, false) + '\n';
  }
  el.value = text;
  // Yes this looks bizzare. This is for '\n' processing.
  // They get converted to CRLF as part of the above statement.
  text = el.value;

  var timerSav = goog.Timer.callOnce;
  goog.Timer.callOnce = localTimer;

  s.check();
  processTimerQueue();
  s.ignoreWord(iggnore);
  processTimerQueue();
  s.check();
  processTimerQueue();
  s.resume();
  processTimerQueue();

  goog.Timer.callOnce = timerSav;

  assertEquals('Spell checker run should not change the underlying element.',
               text, el.value);
  s.dispose();
};

function testPlainTextSpellCheckerWithQuotes() {
  var handler = new goog.spell.SpellCheck(localSpellCheckingFunction);
  var s = new goog.ui.PlainTextSpellChecker(handler);
  s.asyncWordsPerBatch_ = 100;
  var el = document.getElementById('test2');
  s.decorate(el);
  var text = '';
  for (var i = 0 ; i < 10; ++i) {
    text += generateRandomString(10, true) + '\n';
  }
  el.value = text;
  // Yes this looks bizzare. This is for '\n' processing.
  // They get converted to CRLF as part of the above statement.
  text = el.value;

  var timerSav = goog.Timer.callOnce;
  goog.Timer.callOnce = localTimer;

  s.setExcludeMarker(new RegExp('\nOn .* wrote:\n(> .*\n)+|\n(> .*\n)', 'g'));
  s.check();
  processTimerQueue();
  s.ignoreWord(iggnore);
  processTimerQueue();
  s.check();
  processTimerQueue();
  s.resume();
  processTimerQueue();

  goog.Timer.callOnce = timerSav;

  assertEquals('Spell checker run should not change the underlying element.',
               text, el.value);
  s.dispose();
};

function testPlainTextSpellCheckerWordReplacement() {
  var handler = new goog.spell.SpellCheck(localSpellCheckingFunction);
  var s = new goog.ui.PlainTextSpellChecker(handler);
  s.asyncWordsPerBatch_ = 100;
  var el = document.getElementById('test3');
  s.decorate(el);
  var text = '';
  for (var i = 0 ; i < 10 ; ++i) {
    text += generateRandomString(10, false) + '\n';
  }
  el.value = text;

  var timerSav = goog.Timer.callOnce;
  goog.Timer.callOnce = localTimer;

  s.check();
  processTimerQueue();

  var container = s.overlay_;
  var wordEl = container.firstChild;
  while (wordEl) {
    if (goog.dom.getTextContent(wordEl) == missspelling) {
      break;
    }
    wordEl = wordEl.nextSibling;
  }

  if (!wordEl) {
    assertTrue('Cannot find the world that should have been here.'
               + 'Please revise the test', false);
    return;
  }

  s.activeWord_ = missspelling;
  s.activeElement_ = wordEl;
  var suggestions = s.getSuggestions_();
  s.replaceWord(wordEl, missspelling, 'foo');
  assertEquals('Should have set the original word attribute!',
      wordEl.getAttribute(goog.ui.AbstractSpellChecker.ORIGINAL_),
      missspelling);

  s.activeWord_ = goog.dom.getTextContent(wordEl);
  s.activeElement_ = wordEl;
  var newSuggestions = s.getSuggestions_();
  assertEquals('Suggestion list should still be present even if the word '
      + 'is now correct!', suggestions, newSuggestions);

  s.resume();
  processTimerQueue();

  goog.Timer.callOnce = timerSav;
  s.dispose();
};



">3 of 3 tests run in 7ms.<br />0 passed, 3 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testPlainTextSpellCheckerNoQuotes<br />Object #<Object> has no method 'createElement'<br />ERROR in testPlainTextSpellCheckerWithQuotes<br />Object #<Object> has no method 'createElement'<br />ERROR in testPlainTextSpellCheckerWordReplacement<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>dimensionpicker_test.html</td><td>Fail</td><td> 2 passed, 5 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.dom.TagName');
    goog.require('goog.math.Size');
    goog.require('goog.testing.jsunit');
    goog.require('goog.testing.events');
    goog.require('goog.testing.ui.rendererasserts');
    goog.require('goog.ui.DimensionPicker');
    goog.require('goog.ui.DimensionPickerRenderer');
  

    var picker;
    var render = goog.dom.getElement('render');
    var decorate = goog.dom.getElement('decorate');

    function setUp() {
      picker = new goog.ui.DimensionPicker();
      render.innerHTML = '';
      decorate.innerHTML = '';
    }

    function tearDown() {
      picker.dispose();
    }

    function testConstructor() {
      assertNotNull('Should have successful construction', picker);
      assertNull('Should not be in document', picker.getElement());
    }

    function testRender() {
      picker.render(render);

      assertEquals('Should create 1 child', 1, render.childNodes.length);
      assertEquals('Should be a div', goog.dom.TagName.DIV,
          render.firstChild.tagName);
    }

    function testDecorate() {
      picker.decorate(decorate);

      assertNotEquals('Should add several children', decorate.firstChild,
          decorate.lastChild);
    }

    function testHighlightedSize() {
      picker.render(render);

      var size = picker.getValue();
      assertEquals('Should have 0 columns highlighted', 0, size.width);
      assertEquals('Should have 0 rows highlighted', 0, size.height);

      picker.setValue(1, 2);

      size = picker.getValue();
      assertEquals('Should have 1 column highlighted', 1, size.width);
      assertEquals('Should have 2 rows highlighted', 2, size.height);

      picker.setValue(new goog.math.Size(3, 4));
      size = picker.getValue();
      assertEquals('Should have 3 columns highlighted', 3, size.width);
      assertEquals('Should have 4 rows highlighted', 4, size.height);
    }

    function testHandleMove() {
      picker.render(render);
      var renderer = picker.getRenderer();
      var mouseMoveElem = renderer.getMouseMoveElement(picker);

      picker.rightToLeft_ = false;
      var e = {
        target: mouseMoveElem,
        offsetX: 18, // Each grid square currently a magic 18px.
        offsetY: 36
      };

      picker.handleMouseMove(e);
      var size = picker.getValue();
      assertEquals('Should have 1 column highlighted', 1, size.width);
      assertEquals('Should have 2 rows highlighted', 2, size.height);

      picker.rightToLeft_ = true;

      picker.handleMouseMove(e);
      var size = picker.getValue();
      // In RTL we pick from the right side of the picker, so an offsetX of 0
      // would actually mean select all columns.
      assertEquals('Should have columns to the right of the mouse highlighted',
          Math.ceil((mouseMoveElem.offsetWidth - e.offsetX) / 18), size.width);
      assertEquals('Should have 2 rows highlighted', 2, size.height);
    }

    function testDispose() {
      var element = picker.getElement();
      picker.render(render);
      picker.dispose();
      assertTrue('Picker should have been disposed of', picker.isDisposed());
      assertNull('Picker element reference should have been nulled out',
          picker.getElement());
    }

    function testRendererDoesntCallGetCssClassInConstructor() {
      goog.testing.ui.rendererasserts.
          assertNoGetCssClassCallsInConstructor(
              goog.ui.DimensionPickerRenderer);
    }
  ">7 of 7 tests run in 12ms.<br />2 passed, 5 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testDecorate<br />Invalid element to decorate<br />ERROR in testDispose<br />Object #<Object> has no method 'createElement'<br />ERROR in testHandleMove<br />Object #<Object> has no method 'createElement'<br />ERROR in testHighlightedSize<br />Object #<Object> has no method 'createElement'<br />ERROR in testRender<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>containerrenderer_test.html</td><td>Fail</td><td> undefined</td><td title="

    goog.require('goog.dom');
    goog.require('goog.testing.ExpectedFailures');
    goog.require('goog.testing.PropertyReplacer');
    goog.require('goog.testing.jsunit');
    goog.require('goog.testing.ui.rendererasserts');
    goog.require('goog.ui.Container');
    goog.require('goog.ui.ContainerRenderer');
    goog.require('goog.ui.Control');
    goog.require('goog.ui.ControlRenderer');
  

    var renderer;
    var expectedFailures = new goog.testing.ExpectedFailures();
    var stubs = new goog.testing.PropertyReplacer();

    function setUp() {
      var sandbox = goog.dom.getElement('sandbox');

      sandbox.appendChild(goog.dom.createDom('span', {
        id: 'noTabIndex'
      }, 'Test'));
      sandbox.appendChild(goog.dom.createDom('div', {
        id: 'container',
        'class': 'goog-container-horizontal'
      }, goog.dom.createDom('div', {
        id: 'control',
        'class': 'goog-control'
      }, 'Hello, world!')));

      renderer = goog.ui.ContainerRenderer.getInstance();
    }

    function tearDown() {
      goog.dom.getElement('sandbox').innerHTML = '';
      stubs.reset();
      expectedFailures.handleTearDown();
    }

    function testGetInstance() {
      assertTrue('getInstance() must return a ContainerRenderer',
          renderer instanceof goog.ui.ContainerRenderer);
      assertEquals('getInstance() must return the same object each time',
          renderer, goog.ui.ContainerRenderer.getInstance());
    }

    function testGetCustomRenderer() {
      var cssClass = 'special-css-class';
      var containerRenderer = goog.ui.ContainerRenderer.getCustomRenderer(
          goog.ui.ContainerRenderer, cssClass);
      assertEquals(
          'Renderer should have returned the custom CSS class.',
          cssClass,
          containerRenderer.getCssClass());
    }

    function testGetAriaRole() {
      assertUndefined('ARIA role must be undefined', renderer.getAriaRole());
    }

    function testEnableTabIndex() {
      var container = goog.dom.getElement('container');
      assertFalse('Container must not have any tab index',
          goog.dom.isFocusableTabIndex(container));

      // WebKit on Mac doesn't support tabIndex for arbitrary DOM elements
      // until version 527 or later.
      expectedFailures.expectFailureFor(goog.userAgent.WEBKIT &&
          goog.userAgent.MAC && !goog.userAgent.isVersion('527'));
      try {
        renderer.enableTabIndex(container, true);
        assertTrue('Container must have a tab index',
            goog.dom.isFocusableTabIndex(container));
        assertEquals('Container\'s tab index must be 0', 0, container.tabIndex);

        renderer.enableTabIndex(container, false);
        assertFalse('Container must not have a tab index',
            goog.dom.isFocusableTabIndex(container));
        assertEquals('Container\'s tab index must be -1', -1,
            container.tabIndex);
      } catch (e) {
        expectedFailures.handleException(e);
      }
    }

    function testCreateDom() {
      var horizontal = new goog.ui.Container(
          goog.ui.Container.Orientation.HORIZONTAL);
      var element1 = renderer.createDom(horizontal);
      assertEquals('Element must be a DIV', 'DIV', element1.tagName);
      assertEquals('Element must have the expected class name',
          'goog-container goog-container-horizontal',
          element1.className);

      var vertical = new goog.ui.Container(
          goog.ui.Container.Orientation.VERTICAL);
      var element2 = renderer.createDom(vertical);
      assertEquals('Element must be a DIV', 'DIV', element2.tagName);
      assertEquals('Element must have the expected class name',
          'goog-container goog-container-vertical',
          element2.className);
    }

    function testGetContentElement() {
      assertNull('getContentElement() must return null if element is null',
          renderer.getContentElement(null));
      var element = goog.dom.getElement('container');
      assertEquals('getContentElement() must return its argument',
          element, renderer.getContentElement(element));
    }

    function testCanDecorate() {
      assertFalse('canDecorate() must return false for a SPAN',
          renderer.canDecorate(goog.dom.getElement('noTabIndex')));
      assertTrue('canDecorate() must return true for a DIV',
          renderer.canDecorate(goog.dom.getElement('container')));
    }

    function testDecorate() {
      var container = new goog.ui.Container();
      var element = goog.dom.getElement('container');

      assertFalse('Container must not be in the document',
          container.isInDocument());
      container.decorate(element);
      assertTrue('Container must be in the document',
          container.isInDocument());

      assertEquals('Container\'s ID must match the decorated element\'s ID',
          element.id, container.getId());
      assertEquals('Element must have the expected class name',
          'goog-container-horizontal goog-container', element.className);
      assertEquals('Container must have one child', 1,
          container.getChildCount());
      assertEquals('Child component\'s ID must be as expected', 'control',
          container.getChildAt(0).getId());

      assertThrows('Redecorating must throw error', function() {
        container.decorate(element);
      });
    }
    
    function testDecorateWithCustomContainerElement() {
      var element = goog.dom.getElement('container');
      var alternateContainerElement = goog.dom.createElement('div');
      element.appendChild(alternateContainerElement);
      
      var container = new goog.ui.Container();
      stubs.set(renderer, 'getContentElement', function() {
        return alternateContainerElement;
      });

      assertFalse('Container must not be in the document',
          container.isInDocument());
      container.decorate(element);
      assertTrue('Container must be in the document',
          container.isInDocument());

      assertEquals('Container\'s ID must match the decorated element\'s ID',
          element.id, container.getId());
      assertEquals('Element must have the expected class name',
          'goog-container-horizontal goog-container', element.className);
      assertEquals('Container must have 0 children', 0,
          container.getChildCount());

      assertThrows('Redecorating must throw error', function() {
        container.decorate(element);
      });
    }

    function testSetStateFromClassName() {
      var container = new goog.ui.Container();

      assertEquals('Container must be vertical',
          goog.ui.Container.Orientation.VERTICAL, container.getOrientation());
      renderer.setStateFromClassName(container, 'goog-container-horizontal',
          'goog-container');
      assertEquals('Container must be horizontal',
          goog.ui.Container.Orientation.HORIZONTAL, container.getOrientation());
      renderer.setStateFromClassName(container, 'goog-container-vertical',
          'goog-container');
      assertEquals('Container must be vertical',
          goog.ui.Container.Orientation.VERTICAL, container.getOrientation());

      assertTrue('Container must be enabled', container.isEnabled());
      renderer.setStateFromClassName(container, 'goog-container-disabled',
          'goog-container');
      assertFalse('Container must be disabled', container.isEnabled());
    }

    function testInitializeDom() {
      var container = new goog.ui.Container();
      var element = goog.dom.getElement('container');
      container.decorate(element);

      assertTrue('Container\'s root element must be unselectable',
          goog.style.isUnselectable(container.getElement()));

      assertEquals('On IE, container\'s root element must have hideFocus=true',
          goog.userAgent.IE, !!container.getElement().hideFocus);
    }

    function testDoesntCallGetCssClassInConstructor() {
      goog.testing.ui.rendererasserts.
          assertNoGetCssClassCallsInConstructor(goog.ui.ContainerRenderer);
    }
  ">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:15:28
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>sliderbase_test.html</td><td>Fail</td><td> 0 passed, 3 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.ui.SliderBase');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.recordFunction');


var oneThumbSlider;
var oneChangeEventCount;

var twoThumbSlider;
var twoChangeEventCount;

/**
 * A basic class to implement the abstract goog.ui.SliderBase for testing.
 * @constructor
 * @extends {goog.ui.SliderBase}
 */
function OneThumbSlider() {
  goog.ui.SliderBase.call(this);
}
goog.inherits(OneThumbSlider, goog.ui.SliderBase);


/** {@inheritDoc} */
OneThumbSlider.prototype.createThumbs = function() {
  this.valueThumb = this.extentThumb = goog.dom.getElement('thumb');
};


/** {@inheritDoc} */
OneThumbSlider.prototype.getCssClass = function() {
  return 'dummyCssClass';
};


/**
 * A basic class to implement the abstract goog.ui.SliderBase for testing.
 * @constructor
 * @extends {goog.ui.SliderBase}
 */
function TwoThumbSlider() {
  goog.ui.SliderBase.call(this);
}
goog.inherits(TwoThumbSlider, goog.ui.SliderBase);


/** {@inheritDoc} */
TwoThumbSlider.prototype.createThumbs = function() {
  this.valueThumb = goog.dom.getElement('valueThumb');
  this.extentThumb = goog.dom.getElement('extentThumb');
};


/** {@inheritDoc} */
TwoThumbSlider.prototype.getCssClass = function() {
  return 'dummyCssClass';
};


function setUp() {
  var sandBox = goog.dom.getElement('sandbox');

  var oneThumbElem = goog.dom.createDom(
      'div', {'id': 'oneThumbSlider'},
      goog.dom.createDom('span', {'id': 'thumb'}));
  sandBox.appendChild(oneThumbElem);
  oneThumbSlider = new OneThumbSlider();
  oneThumbSlider.decorate(oneThumbElem);
  oneChangeEventCount = 0;
  goog.events.listen(oneThumbSlider, goog.ui.Component.EventType.CHANGE,
      function() {
        oneChangeEventCount++;
      });

 var twoThumbElem = goog.dom.createDom(
     'div', {'id': 'oneThumbSlider'},
     goog.dom.createDom('span', {'id': 'valueThumb'}),
     goog.dom.createDom('span', {'id': 'extentThumb'}));
  sandBox.appendChild(twoThumbElem);
  twoThumbSlider = new TwoThumbSlider();
  twoThumbSlider.decorate(twoThumbElem);
  twoChangeEventCount = 0;
  goog.events.listen(twoThumbSlider, goog.ui.Component.EventType.CHANGE,
      function() {
        twoChangeEventCount++;
      });

}

function tearDown() {
  goog.events.removeAll();
  oneThumbSlider.dispose();
  twoThumbSlider.dispose();
  goog.dom.getElement('sandbox').innerHTML = '';
}

function testGetAndSetValue() {
  oneThumbSlider.setValue(30);
  assertEquals(30, oneThumbSlider.getValue());
  assertEquals('Setting valid value must dispatch only a single change event.',
      1, oneChangeEventCount);

  oneThumbSlider.setValue(30);
  assertEquals(30, oneThumbSlider.getValue());
  assertEquals('Setting to same value must not dispatch change event.',
      1, oneChangeEventCount);

  oneThumbSlider.setValue(-30);
  assertEquals('Setting invalid value must not change value.',
      30, oneThumbSlider.getValue());
  assertEquals('Setting invalid value must not dispatch change event.',
      1, oneChangeEventCount);


  // Value thumb can't go past extent thumb, so we must move that first to
  // allow setting value.
  twoThumbSlider.setExtent(70);
  twoChangeEventCount = 0;
  twoThumbSlider.setValue(60);
  assertEquals(60, twoThumbSlider.getValue());
  assertEquals('Setting valid value must dispatch only a single change event.',
      1, twoChangeEventCount);

  twoThumbSlider.setValue(60);
  assertEquals(60, twoThumbSlider.getValue());
  assertEquals('Setting to same value must not dispatch change event.',
      1, twoChangeEventCount);

  twoThumbSlider.setValue(-60);
  assertEquals('Setting invalid value must not change value.',
      60, twoThumbSlider.getValue());
  assertEquals('Setting invalid value must not dispatch change event.',
      1, twoChangeEventCount);
}

function testGetAndSetExtent() {
  // Note(ajp): With a one thumb slider the API only really makes sense if you
  // always use setValue since there is no extent.

  twoThumbSlider.setExtent(7);
  assertEquals(7, twoThumbSlider.getExtent());
  assertEquals('Setting valid value must dispatch only a single change event.',
      1, twoChangeEventCount);

  twoThumbSlider.setExtent(7);
  assertEquals(7, twoThumbSlider.getExtent());
  assertEquals('Setting to same value must not dispatch change event.',
      1, twoChangeEventCount);

  twoThumbSlider.setExtent(-7);
  assertEquals('Setting invalid value must not change value.',
      7, twoThumbSlider.getExtent());
  assertEquals('Setting invalid value must not dispatch change event.',
      1, twoChangeEventCount);
}

function testRangeListener() {
  var slider = new goog.ui.SliderBase;
  slider.updateUi_= slider.updateAriaStates = function() {};
  slider.rangeModel.setValue(0);

  var f = goog.testing.recordFunction();
  goog.events.listen(slider, goog.ui.Component.EventType.CHANGE, f);

  slider.rangeModel.setValue(50);
  assertEquals(1, f.getCallCount());

  slider.exitDocument();
  slider.rangeModel.setValue(0);
  assertEquals('The range model listener should not have been removed so we ' +
               'should have gotten a second event dispatch',
               2, f.getCallCount());
}

">3 of 3 tests run in 7ms.<br />0 passed, 3 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testGetAndSetExtent<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetAndSetValue<br />Object #<Object> has no method 'createElement'<br />ERROR in testRangeListener<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>hsvpalette_test.html</td><td>Fail</td><td> 5 passed, 7 failed.</td><td title="


    goog.require('goog.color');
    goog.require('goog.events');
    goog.require('goog.math.Rect');
    goog.require('goog.style');
    goog.require('goog.testing.PropertyReplacer');
    goog.require('goog.testing.events');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.HsvPalette');
  

    var samplePalette;
    var eventWasFired = false;
    var stubs = new goog.testing.PropertyReplacer();
    
    function setUp() {
      samplePalette = new goog.ui.HsvPalette();
    }

    function tearDown() {
      samplePalette.dispose();
      stubs.reset();
    }
    
    function testOptionalInitialColor() {
      var initialColor = '#0000ff';
      var customInitialPalette = new goog.ui.HsvPalette(null, initialColor);
      assertEquals(initialColor,
                   goog.color.parse(customInitialPalette.getColor()).hex);
    }
    
    function testCustomClassName() {
      var customClassName = 'custom-plouf';
      var customClassPalette =
          new goog.ui.HsvPalette(null, null, customClassName);
      customClassPalette.createDom();
      assertTrue(goog.dom.classes.has(customClassPalette.getElement(),
                                      customClassName));
    }
    
    function testCannotDecorate() {
      assertFalse(samplePalette.canDecorate());
    }
    
    function testSetColor() {
      var color = '#abcdef';
      samplePalette.setColor(color);
      assertEquals(color, goog.color.parse(samplePalette.getColor()).hex);
    }
    
    function testChangeEvent() {
      // TODO(user): Add functionality to goog.testing.events to assert
      // an event was fired.
      goog.events.listen(samplePalette, goog.ui.Component.EventType.ACTION,
          function() {eventWasFired = true;});
      samplePalette.setColor('#123456');
      assertTrue(eventWasFired);
    }
    
    function testSetHsv() {
      // Start from red.
      samplePalette.setColor('#ff0000');
      
      // Setting hue to 0.5 should yield cyan.
      samplePalette.setHsv(0.5, null, null);
      assertEquals('#00ffff', goog.color.parse(samplePalette.getColor()).hex);

      // Setting saturation to 0 should yield white.
      samplePalette.setHsv(null, 0, null);
      assertEquals('#ffffff',
                   goog.color.parse(samplePalette.getColor()).hex);

      // Setting value/brightness to 0 should yield black.
      samplePalette.setHsv(null, null, 0);
      assertEquals('#000000', goog.color.parse(samplePalette.getColor()).hex);
    }
    
    function testRender() {
      samplePalette.render(document.getElementById('sandbox'));

      assertTrue(samplePalette.isInDocument());

      var elem = samplePalette.getElement();
      assertNotNull(elem);
      assertEquals(goog.dom.TagName.DIV, elem.tagName);

      if (goog.userAgent.IE && !goog.userAgent.isVersion('7')) {
        assertSameElements('On IE6, the noalpha class must be present',
            ['goog-hsv-palette', 'goog-hsv-palette-noalpha'],
            goog.dom.classes.get(elem));
      } else {
        assertEquals('The noalpha class must not be present',
           'goog-hsv-palette', elem.className);
      }
    }
    
    function testNoLeftOverListenersAfterDispose() {
      var initialListenerCount = goog.events.getTotalListenerCount();
      samplePalette.render(document.getElementById('sandbox'));
      samplePalette.dispose();
      assertEquals(initialListenerCount, goog.events.getTotalListenerCount());
    }
    
    function testSwatchTextIsReadable() {
      samplePalette.render(document.getElementById('sandbox'));
    
      // Text should be black when background is light.
      samplePalette.setColor('#ccffff');
      assertEquals('#000000', 
                   goog.color.parse(goog.style.getStyle(samplePalette.swatchEl_,
                                                        'color')).hex);

      // Text should be white when background is dark.
      samplePalette.setColor('#410800');
      assertEquals('#ffffff', 
                   goog.color.parse(goog.style.getStyle(samplePalette.swatchEl_,
                                                        'color')).hex);
    }
    
    function testInputColor() {
      samplePalette.render(document.getElementById('sandbox'));
      var color = '#001122';
      samplePalette.inputEl_.value = color;
      samplePalette.handleInput_(null);
      assertEquals(color, goog.color.parse(samplePalette.getColor()).hex);
    }
    
    function testHandleMouseMoveValue() {
      samplePalette.render(document.getElementById('sandbox'));
      stubs.set(goog.dom, 'getPageScroll', function() {
        return new goog.math.Coordinate(0, 0);
      });
      
      // Raising the value/brightness of a dark red should yield a lighter red.
      samplePalette.setColor('#630c00');
      goog.style.setPageOffset(samplePalette.vImageEl_, 0, 0);
      goog.style.setSize(samplePalette.vImageEl_, 10, 100);
      var boundaries = goog.style.getBounds(samplePalette.vImageEl_);

      var event = new goog.events.Event();
      event.clientY = -50;
      // TODO(user): Use
      // goog.testing.events.fireMouseDownEvent(samplePalette.vImageEl_);
      // when google.testing.events support specifying properties of the event
      // or find out how tod o it if it already supports it.
      samplePalette.handleMouseMoveV_(boundaries, event);
      assertEquals('#ff1e00', goog.color.parse(samplePalette.getColor()).hex);
    }
    
    function testHandleMouseMoveHueSaturation() {
      samplePalette.render(document.getElementById('sandbox'));
      stubs.set(goog.dom, 'getPageScroll', function() {
        return new goog.math.Coordinate(0, 0);
      });
      
      // The following hue/saturation selection should yield a light yellow.
      goog.style.setPageOffset(samplePalette.hsImageEl_, 0, 0);
      goog.style.setSize(samplePalette.hsImageEl_, 100, 100);
      var boundaries = goog.style.getBounds(samplePalette.hsImageEl_);

      var event = new goog.events.Event();
      event.clientX = 20;
      event.clientY = 85;
      // TODO(user): Use goog.testing.events when appropriate (see above).
      samplePalette.handleMouseMoveHs_(boundaries, event);
      // TODO(user): Fix the main code for this, see bug #1324469.
      // NOTE(user): It's a little better than before due to the
      // goog.style getBoundingClientRect fix, but still not the same. :-(
      if (goog.userAgent.IE) {
        var expectedColor = '#ffe0b2';
      } else {
        var expectedColor = '#ffeec4';
      }

      assertEquals(expectedColor,
                   goog.color.parse(samplePalette.getColor()).hex);
    }
  ">12 of 12 tests run in 16ms.<br />5 passed, 7 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testCustomClassName<br />Object #<Object> has no method 'createElement'<br />ERROR in testHandleMouseMoveHueSaturation<br />Object #<Object> has no method 'createElement'<br />ERROR in testHandleMouseMoveValue<br />Object #<Object> has no method 'createElement'<br />ERROR in testInputColor<br />Object #<Object> has no method 'createElement'<br />ERROR in testNoLeftOverListenersAfterDispose<br />Object #<Object> has no method 'createElement'<br />ERROR in testRender<br />Object #<Object> has no method 'createElement'<br />ERROR in testSwatchTextIsReadable<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>colorbutton_test.html</td><td>Fail</td><td> 0 passed, 2 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.dom');
  goog.require('goog.dom.classes');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.ColorButton');
  goog.require('goog.ui.decorate');



var button, button2;
var buttonDiv;

function setUp() {
  buttonDiv = goog.dom.getElement('buttonDiv');
}

function tearDown() {
  goog.dom.removeChildren(buttonDiv);
  goog.dispose(button);
  goog.dispose(button2);
  button = null;
  button2 = null;
}

function testRender() {
  button = new goog.ui.ColorButton('test');
  assertNotNull('button should be valid', button);
  button.render(buttonDiv);
  assertColorButton(button.getElement());
}

function testDecorate() {
  var colorDiv = goog.dom.createDom('div', 'goog-color-button');
  goog.dom.appendChild(buttonDiv, colorDiv);
  button2 = goog.ui.decorate(colorDiv);
  assertNotNull('button should be valid', button2);
  assertColorButton(button2.getElement());
}

function assertColorButton(div) {
  assertTrue('button className contains goog-color-button',
      goog.array.contains(goog.dom.classes.get(div), 'goog-color-button'));
  var caption = div.firstChild.firstChild.firstChild;
  assertTrue('caption className contains goog-color-button',
      goog.array.contains(goog.dom.classes.get(caption), 'goog-color-button'));
}

">2 of 2 tests run in 8ms.<br />0 passed, 2 failed.<br />4 ms/test. 1 files loaded.<br />ERROR in testDecorate<br />Object #<Object> has no method 'createElement'<br />ERROR in testRender<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>popupcolorpicker_test.html</td><td>Fail</td><td> 0 passed, 3 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.PopupColorPicker');



// Unittest to ensure that the popup gets created in createDom().
function testPopupCreation() {
  var picker = new goog.ui.PopupColorPicker();
  picker.createDom();
  assertNotNull(picker.getPopup());
}

function testAutoHideIsSetProperly() {
  var picker = new goog.ui.PopupColorPicker();
  picker.createDom();
  picker.setAutoHide(true);
  var containingDiv = goog.dom.getElement('containingDiv');
  picker.setAutoHideRegion(containingDiv);
  assertTrue(picker.getAutoHide());
  assertEquals(containingDiv, picker.getAutoHideRegion());
}

// Unittest to ensure the popup opens with a custom color picker.
function testCustomColorPicker() {
  var button1 = document.getElementById('button1');
  var domHelper = goog.dom.getDomHelper();
  var colorPicker = new goog.ui.ColorPicker();
  colorPicker.setColors(["#ffffff", "#000000"]);
  var picker = new goog.ui.PopupColorPicker(domHelper, colorPicker);
  picker.render();
  picker.attach(button1);
  assertNotNull(picker.getColorPicker());
  assertNotNull(picker.getPopup().getElement());
  assertNull(picker.getSelectedColor());

  var changeEvents = 0;
  goog.events.listen(picker, goog.ui.ColorPicker.EventType.CHANGE, function(e) {
    changeEvents++;
  });

  // Select the first color.
  goog.testing.events.fireClickSequence(button1);
  goog.testing.events.fireClickSequence(
      document.getElementById('goog-palette-cell-0').firstChild);
  assertEquals("#ffffff", picker.getSelectedColor());
  assertEquals(1, changeEvents);
}

">3 of 3 tests run in 8ms.<br />0 passed, 3 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testAutoHideIsSetProperly<br />Object #<Object> has no method 'createElement'<br />ERROR in testCustomColorPicker<br />Object #<Object> has no method 'createElement'<br />ERROR in testPopupCreation<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>menubutton_test.html</td><td>Fail</td><td> 0 passed, 11 failed.</td><td title="

  goog.require('goog.Timer');
  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.events.Event');
  goog.require('goog.events.EventType');
  goog.require('goog.events.KeyCodes');
  goog.require('goog.positioning');
  goog.require('goog.positioning.Overflow');
  goog.require('goog.style');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.recordFunction');
  goog.require('goog.ui.Menu');
  goog.require('goog.ui.MenuButton');
  goog.require('goog.ui.MenuItem');



var menuButton;
var clonedMenuButtonDom;

// Mock out goog.positioning.positionAtCoordinate to always ignore failure when
// the window is too small, since we don't care about the viewport size on
// the selenium farm.
// TODO(nicksantos): Move this into a common location if we ever have enough
// code for a general goog.testing.ui library.
var originalPositionAtCoordinate = goog.positioning.positionAtCoordinate;
goog.positioning.positionAtCoordinate = function(absolutePos, movableElement,
    movableElementCorner, opt_margin, opt_viewport, opt_overflow,
    opt_preferredSize) {
  return originalPositionAtCoordinate.call(this, absolutePos, movableElement,
      movableElementCorner, opt_margin, opt_viewport,
      goog.positioning.Overflow.IGNORE, opt_preferredSize);
};

function MyFakeEvent(keyCode) {
  this.type = goog.events.KeyHandler.EventType.KEY;
  this.keyCode = keyCode;
  this.preventDefault = goog.nullFunction;
  this.stopPropagation = goog.nullFunction;
}

function setUp() {
  clonedMenuButtonDom = goog.dom.getElement('demoMenuButton').cloneNode(true);

  menuButton = new goog.ui.MenuButton();
}

function tearDown() {
  menuButton.dispose();

  var element = goog.dom.getElement('demoMenuButton');
  element.parentNode.replaceChild(clonedMenuButtonDom, element);
}

/**
 * Open the menu and click on the menu item inside.
 */
function testBasicButtonBehavior() {
  var node = goog.dom.getElement('demoMenuButton');
  menuButton.decorate(node);
  goog.testing.events.fireClickSequence(node);

  assertTrue('Menu must open after click', menuButton.isOpen());

  var menuItemClicked = 0;
  var lastMenuItemClicked = null;
  goog.events.listen(menuButton.getMenu(),
    goog.ui.Component.EventType.ACTION,
    function(e) {
      menuItemClicked++;
      lastMenuItemClicked = e.target
    });

  var menuItem2 = goog.dom.getElement('menuItem2');
  goog.testing.events.fireClickSequence(menuItem2);
  assertFalse('Menu must close on clicking when open', menuButton.isOpen());
  assertEquals('Number of menu items clicked should be 1', 1, menuItemClicked);
  assertEquals('menuItem2 should be the last menuitem clicked', menuItem2,
      lastMenuItemClicked.getElement());
}

/**
 * Open the menu, highlight first menuitem and then the second.
 * Check if the aria-activedescendant property is set correctly.
 */
function testHighlightItemBehavior() {
    var node = goog.dom.getElement('demoMenuButton');
    menuButton.decorate(node);
    goog.testing.events.fireClickSequence(node);

    assertTrue('Menu must open after click', menuButton.isOpen());

    menuButton.handleKeyEvent(new MyFakeEvent(goog.events.KeyCodes.DOWN));
    assertEquals('First menuitem must be the aria-activedescendant',
        'menuItem1', goog.dom.a11y.getState(menuButton.getElement(),
        goog.dom.a11y.State.ACTIVEDESCENDANT));

    menuButton.handleKeyEvent(new MyFakeEvent(goog.events.KeyCodes.DOWN));
    assertEquals('Second menuitem must be the aria-activedescendant',
        'menuItem2', goog.dom.a11y.getState(menuButton.getElement(),
        goog.dom.a11y.State.ACTIVEDESCENDANT));
}

/**
 * Open the menu and click on the menu item inside after exiting and entering
 * the document once, to test proper setup/teardown behavior of MenuButton.
 */
function testButtonAfterEnterDocument() {
  var node = goog.dom.getElement('demoMenuButton');
  menuButton.decorate(node);

  menuButton.exitDocument();
  menuButton.enterDocument();

  goog.testing.events.fireClickSequence(node);
  assertTrue('Menu must open after click', menuButton.isOpen());

  var menuItem2 = goog.dom.getElement('menuItem2');
  goog.testing.events.fireClickSequence(menuItem2);
  assertFalse('Menu must close on clicking when open', menuButton.isOpen());
}

/**
 * Renders the menu button, moves its menu and then repositions to make sure the
 * position is more or less ok.
 */
function testPositionMenu() {
  var node = goog.dom.getElement('demoMenuButton');
  menuButton.decorate(node);
  var menu = menuButton.getMenu();
  menu.setVisible(true, true);

  // Move to 500, 500
  menu.setPosition(500, 500);

  // Now reposition and make sure position is more or less ok.
  menuButton.positionMenu();
  var menuNode = goog.dom.getElement('demoMenu');
  assertRoughlyEquals(menuNode.offsetTop, node.offsetTop + node.offsetHeight,
      20);
  assertRoughlyEquals(menuNode.offsetLeft, node.offsetLeft, 20);
}

/**
 * Tests that calling positionMenu when the menu is not in the document does not
 * throw an exception.
 */
function testPositionMenuNotInDocument() {
  var menu = new goog.ui.Menu();
  menu.createDom();
  menuButton.setMenu(menu);
  menuButton.positionMenu();
}

/**
 * Shows the menu and moves the menu button, a timer correct the menu position.
 */
function testOpenedMenuPositionCorrection() {
  var iframe = goog.dom.getElement('iframe1');
  var iframeDoc = goog.dom.getFrameContentDocument(iframe);
  var iframeDom = goog.dom.getDomHelper(iframeDoc);
  var iframeWindow = goog.dom.getWindow(iframeDoc);

  var button = new goog.ui.MenuButton();
  iframeWindow.scrollTo(0, 0);
  var node = iframeDom.getElement('demoMenuButton');
  button.decorate(node);
  var mockTimer = new goog.Timer();
  // Don't start the timer.  We manually dispatch the Tick event.
  mockTimer.start = goog.nullFunction;
  button.timer_ = mockTimer;

  var replacer = new goog.testing.PropertyReplacer();
  var positionMenuCalled;
  var origPositionMenu = goog.bind(button.positionMenu, button);
  replacer.set(button, 'positionMenu', function() {
    positionMenuCalled = true;
    origPositionMenu();
  });

  // Show the menu.
  button.setOpen(true);

  // Confirm the menu position
  var menuNode = iframeDom.getElement('demoMenu');
  assertRoughlyEquals(menuNode.offsetTop, node.offsetTop + node.offsetHeight,
      20);
  assertRoughlyEquals(menuNode.offsetLeft, node.offsetLeft, 20);

  positionMenuCalled = false;
  // A Tick event is dispatched.
  mockTimer.dispatchEvent(goog.Timer.TICK);
  assertFalse('positionMenu() shouldn\'t be called.', positionMenuCalled);

  // Move the menu button by DOM structure change
  var p1 = iframeDom.createDom('p', null, iframeDom.createTextNode('foo'));
  var p2 = iframeDom.createDom('p', null, iframeDom.createTextNode('foo'));
  var p3 = iframeDom.createDom('p', null, iframeDom.createTextNode('foo'));
  iframeDom.insertSiblingBefore(p1, node);
  iframeDom.insertSiblingBefore(p2, node);
  iframeDom.insertSiblingBefore(p3, node);

  // Confirm the menu is detached from the button.
  assertTrue(Math.abs(node.offsetTop + node.offsetHeight -
      menuNode.offsetTop) > 20);

  positionMenuCalled = false;
  // A Tick event is dispatched.
  mockTimer.dispatchEvent(goog.Timer.TICK);
  assertTrue('positionMenu() should be called.', positionMenuCalled);

  // The menu is moved to appropriate position again.
  assertRoughlyEquals(menuNode.offsetTop, node.offsetTop + node.offsetHeight,
      20);

  // Make the frame page scrollable.
  var viewportHeight = iframeDom.getViewportSize().height;
  var footer = iframeDom.getElement('footer');
  goog.style.setSize(footer, 1, viewportHeight * 2);
  // Change the viewport offset.
  iframeWindow.scrollTo(0, viewportHeight);
  // A Tick event is dispatched and positionMenu() should be called.
  positionMenuCalled = false;
  mockTimer.dispatchEvent(goog.Timer.TICK);
  assertTrue('positionMenu() should be called.', positionMenuCalled);
  goog.style.setSize(footer, 1, 1);

  // Tear down.
  iframeDom.removeNode(p1);
  iframeDom.removeNode(p2);
  iframeDom.removeNode(p3);
  replacer.reset();
  button.dispose();
}

/**
 * Use a different button to position the menu and make sure it does so
 * correctly.
 */
function testAlternatePositioningElement() {
  var node = goog.dom.getElement('demoMenuButton');
  menuButton.decorate(node);

  var posElement = goog.dom.getElement('positionElement');
  menuButton.setPositionElement(posElement);

  // Show the menu.
  menuButton.setOpen(true);

  // Confirm the menu position
  var menuNode = menuButton.getMenu().getElement();
  assertRoughlyEquals(menuNode.offsetTop, posElement.offsetTop
      + posElement.offsetHeight, 20);
  assertRoughlyEquals(menuNode.offsetLeft, posElement.offsetLeft, 20);
}

/**
 * Tests that space, and only space, fire on key up.
 */
function testSpaceFireOnKeyUp() {
  var node = goog.dom.getElement('demoMenuButton');
  menuButton.decorate(node);

  e = new goog.events.Event(goog.events.KeyHandler.EventType.KEY, menuButton);
  e.preventDefault = goog.testing.recordFunction();
  e.keyCode = goog.events.KeyCodes.SPACE;
  menuButton.handleKeyEvent(e);
  assertFalse('Menu must not have been triggered by Space keypress',
      menuButton.isOpen());
  assertNotNull('Page scrolling is prevented', e.preventDefault.getLastCall());

  e = new goog.events.Event(goog.events.EventType.KEYUP, menuButton);
  e.keyCode = goog.events.KeyCodes.SPACE;
  menuButton.handleKeyEvent(e);
  assertTrue('Menu must have been triggered by Space keyup',
      menuButton.isOpen());
  menuButton.getMenu().setHighlightedIndex(0);
  e = new goog.events.Event(goog.events.KeyHandler.EventType.KEY, menuButton);
  e.keyCode = goog.events.KeyCodes.DOWN;
  menuButton.handleKeyEvent(e);
  assertEquals('Highlighted menu item must have hanged by Down keypress',
      1,
      menuButton.getMenu().getHighlightedIndex());

  menuButton.getMenu().setHighlightedIndex(0);
  e = new goog.events.Event(goog.events.EventType.KEYUP, menuButton);
  e.keyCode = goog.events.KeyCodes.DOWN;
  menuButton.handleKeyEvent(e);
  assertEquals('Highlighted menu item must not have changed by Down keyup',
      0,
      menuButton.getMenu().getHighlightedIndex());
}


/**
 * Tests that preventing the button from closing also prevents the menu from
 * being hidden.
 */
function testPreventHide() {
  var node = goog.dom.getElement('demoMenuButton');
  menuButton.decorate(node);
  menuButton.setDispatchTransitionEvents(goog.ui.Component.State.OPENED, true);

  // Show the menu.
  menuButton.setOpen(true);
  assertTrue('Menu button should be open.', menuButton.isOpen());
  assertTrue('Menu should be visible.', menuButton.getMenu().isVisible());

  var key = goog.events.listen(menuButton,
                               goog.ui.Component.EventType.CLOSE,
                               function(event) { event.preventDefault(); });

  // Try to hide the menu.
  menuButton.setOpen(false);
  assertTrue('Menu button should still be open.', menuButton.isOpen());
  assertTrue('Menu should still be visible.', menuButton.getMenu().isVisible());

  // Remove listener and try again.
  goog.events.unlistenByKey(key);
  menuButton.setOpen(false);
  assertFalse('Menu button should not be open.', menuButton.isOpen());
  assertFalse('Menu should not be visible.', menuButton.getMenu().isVisible());
}


/**
 * Tests that opening and closing the menu does not affect how adding or
 * removing menu items changes the size of the menu.
 */
function testResizeOnItemAddOrRemove() {
  var node = goog.dom.getElement('demoMenuButton');
  menuButton.decorate(node);
  var menu = menuButton.getMenu();

  // Show the menu.
  menuButton.setOpen(true);
  var originalSize = goog.style.getSize(menu.getElement());

  // Check that removing an item while the menu is left open correctly changes
  // the size of the menu.
  // Remove an item using a method on Menu.
  var item = menu.removeChildAt(0, true);
  // Confirm size of menu changed.
  var afterRemoveSize = goog.style.getSize(menu.getElement());
  assertTrue('Height of menu must decrease after removing a menu item.',
      afterRemoveSize.height < originalSize.height);

  // Check that removing an item while the menu is closed, then opened
  // (so that reposition is called) correctly changes the size of the menu.
  // Hide menu.
  menuButton.setOpen(false);
  var item2 = menu.removeChildAt(0, true);
  menuButton.setOpen(true);
  // Confirm size of menu changed.
  var afterRemoveAgainSize = goog.style.getSize(menu.getElement());
  assertTrue('Height of menu must decrease after removing a second menu item.',
      afterRemoveAgainSize.height < afterRemoveSize.height);

  // Check that adding an item while the menu is opened, then closed, then
  // opened, correctly changes the size of the menu.
  // Add an item, this time using a MenuButton method.
  menuButton.setOpen(true);
  menuButton.addItem(item2);
  menuButton.setOpen(false);
  menuButton.setOpen(true);
  // Confirm size of menu changed.
  var afterAddSize = goog.style.getSize(menu.getElement());
  assertTrue('Height of menu must increase after adding a menu item.',
      afterRemoveAgainSize.height < afterAddSize.height);
  assertEquals(
      'Removing and adding back items must not change the height of a menu.',
      afterRemoveSize.height, afterAddSize.height);

  // Add back the last item to keep state consistent.
  menuButton.addItem(item);
}

/**
 * Try rendering the menu as a sibling rather than as a child of the dom.
 */
function testRenderMenuAsSibling() {
  menuButton.setRenderMenuAsSibling(true);
  menuButton.addItem(new goog.ui.MenuItem('Menu item 1'));
  menuButton.addItem(new goog.ui.MenuItem('Menu item 2'));
  // By default the menu is rendered into the top level dom and the button
  // is rendered into whatever parent we provide.  If we don't provide a
  // parent then we aren't really testing anything, since both would be, by
  // default, rendered into the top level dom, and therefore siblings.
  menuButton.render(goog.dom.getElement('siblingTest'));
  menuButton.setOpen(true);
  assertEquals(
      menuButton.getElement().parentNode,
      menuButton.getMenu().getElement().parentNode);
}
">11 of 11 tests run in 11ms.<br />0 passed, 11 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testAlternatePositioningElement<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testBasicButtonBehavior<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testButtonAfterEnterDocument<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testHighlightItemBehavior<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testOpenedMenuPositionCorrection<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testPositionMenu<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testPositionMenuNotInDocument<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testPreventHide<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testRenderMenuAsSibling<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testResizeOnItemAddOrRemove<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testSpaceFireOnKeyUp<br />Object #<Object> has no method 'cloneNode'<br /></td></tr>
<tr><td>select_test.html</td><td>Fail</td><td> 0 passed, 5 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.Component.EventType');
    goog.require('goog.ui.MenuItem');
    goog.require('goog.ui.Select');
  


var defaultCaption = 'initial caption';
var sandbox = goog.dom.getElement('sandbox');
var select;

function setUp() {
  select = new goog.ui.Select(defaultCaption);
}

function tearDown() {
  select.dispose();
  goog.dom.removeChildren(sandbox);
}

/**
 * Checks that the default caption passed in the constructor and in the setter
 * is returned by getDefaultCaption, and acts as a default caption, i.e. is
 * shown as a caption when no items are selected.
 */
function testDefaultCaption() {
  select.render(sandbox);
  var item1 = new goog.ui.MenuItem("item 1");
  select.addItem(item1);
  select.addItem(new goog.ui.MenuItem("item 2"));
  assertEquals(defaultCaption, select.getDefaultCaption());
  assertEquals(defaultCaption, select.getCaption());

  var newCaption = 'new caption';
  select.setDefaultCaption(newCaption);
  assertEquals(newCaption, select.getDefaultCaption());
  assertEquals(newCaption, select.getCaption());

  select.setSelectedItem(item1);
  assertNotEquals(newCaption, select.getCaption());

  select.setSelectedItem(null);
  assertEquals(newCaption, select.getCaption());
}

/**
 * Checks that the select control handles ACTION events from its items.
 */
function testHandlesItemActions() {
  select.render(sandbox);
  var item1 = new goog.ui.MenuItem("item 1");
  var item2 = new goog.ui.MenuItem("item 2");
  select.addItem(item1);
  select.addItem(item2);

  item1.dispatchEvent(goog.ui.Component.EventType.ACTION);
  assertEquals(item1, select.getSelectedItem());
  assertEquals(item1.getCaption(), select.getCaption());

  item2.dispatchEvent(goog.ui.Component.EventType.ACTION);
  assertEquals(item2, select.getSelectedItem());
  assertEquals(item2.getCaption(), select.getCaption());
}

/**
 * Tests goog.ui.Select.prototype.setValue.
 */
function testSetValue() {
  select.render(sandbox);
  var item1 = new goog.ui.MenuItem("item 1", 1);
  var item2 = new goog.ui.MenuItem("item 2", 2);
  select.addItem(item1);
  select.addItem(item2);

  select.setValue(1);
  assertEquals(item1, select.getSelectedItem());

  select.setValue(2);
  assertEquals(item2, select.getSelectedItem());

  select.setValue(3);
  assertNull(select.getSelectedItem());
}

/**
 * Checks that the current selection is cleared when the selected item is
 * removed.
 */
function testSelectionIsClearedWhenSelectedItemIsRemoved() {
  select.render(sandbox);
  var item1 = new goog.ui.MenuItem("item 1");
  select.addItem(item1);
  select.addItem(new goog.ui.MenuItem("item 2"));

  select.setSelectedItem(item1);
  select.removeItem(item1);
  assertNull(select.getSelectedItem());
}

/**
 * Check that the select control is subscribed to its selection model events
 * after being added, removed and added back again into the document.
 */
function testExitAndEnterDocument() {
  var component = new goog.ui.Component();
  component.render(sandbox);

  var item1 = new goog.ui.MenuItem("item 1");
  var item2 = new goog.ui.MenuItem("item 2");
  var item3 = new goog.ui.MenuItem("item 3");

  select.addItem(item1);
  select.addItem(item2);
  select.addItem(item3);

  component.addChild(select, true);
  item2.dispatchEvent(goog.ui.Component.EventType.ACTION);
  assertEquals(item2.getCaption(), select.getCaption());

  component.removeChild(select, true);
  item1.dispatchEvent(goog.ui.Component.EventType.ACTION);
  assertEquals(item2.getCaption(), select.getCaption());

  component.addChild(select, true);
  item3.dispatchEvent(goog.ui.Component.EventType.ACTION);
  assertEquals(item3.getCaption(), select.getCaption());
}

">5 of 5 tests run in 17ms.<br />0 passed, 5 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testDefaultCaption<br />Object #<Object> has no method 'createElement'<br />ERROR in testExitAndEnterDocument<br />Object #<Object> has no method 'createElement'<br />ERROR in testHandlesItemActions<br />Object #<Object> has no method 'createElement'<br />ERROR in testSelectionIsClearedWhenSelectedItemIsRemoved<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetValue<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>mp3_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.debug.Logger');
  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.LooseMock');
  goog.require('goog.ui.Component');
  goog.require('goog.ui.Control');
  goog.require('goog.ui.ControlRenderer');
  goog.require('goog.ui.media.FlashObject');
  goog.require('goog.ui.media.MediaModel');
  goog.require('goog.ui.media.MediaModel.Player');
  goog.require('goog.ui.media.Mp3');



  var mp3;
  var control;
  var MP3_URL = 'http://www.shellworld.net/~davidsky/surf-oxy.mp3';
  var parent = goog.dom.createElement('div');

  function setUp() {
    mp3 = goog.ui.media.Mp3.getInstance();
    var flashUrl = goog.ui.media.Mp3.buildFlashUrl(MP3_URL);
    var model = new goog.ui.media.MediaModel(MP3_URL, 'mp3 caption', '');
    model.setPlayer(new goog.ui.media.MediaModel.Player(flashUrl));
    control = new goog.ui.media.Media(model, mp3);
    control.setSelected(true);
  }

  function tearDown() {
    control.dispose();
  }

  function testBasicRendering() {
    control.render(parent);
    var el = goog.dom.getElementsByTagNameAndClass(
        'div', goog.ui.media.Mp3.CSS_CLASS, parent);
    assertEquals(1, el.length);
  }

  function testParsingUrl() {
    assertTrue(goog.ui.media.Mp3.MATCHER.test(MP3_URL));
    assertFalse(
        goog.ui.media.Mp3.MATCHER.test('http://invalidUrl/filename.doc'));
  }

  function testCreatingDomOnInitialState() {
    control.render(parent);
    var caption = goog.dom.getElementsByTagNameAndClass(
        'div',
        goog.ui.media.Mp3.CSS_CLASS + '-caption',
        parent);
    assertEquals(1, caption.length);

    var flash = goog.dom.getElementsByTagNameAndClass(
        undefined, goog.ui.media.FlashObject.CSS_CLASS, parent);
    assertEquals(1, flash.length);
  }
">TypeError: Object #<Object> has no method 'createElement'
    at Object.createElement (dom/dom.js:755:19)
    at _tmpclosuretest.js:21:25
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
    at Module.load (module.js:219:31)
</td></tr>
<tr><td>picasa_test.html</td><td>Fail</td><td> 2 passed, 2 failed.</td><td title="

  goog.require('goog.debug.Logger');
  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.LooseMock');
  goog.require('goog.ui.Component');
  goog.require('goog.ui.Control');
  goog.require('goog.ui.ControlRenderer');
  goog.require('goog.ui.media.FlashObject');
  goog.require('goog.ui.media.PicasaAlbum');
  goog.require('goog.ui.media.PicasaAlbumModel');



  var picasa;
  var control;
  var PICASA_USERNAME = 'username';
  var PICASA_ALBUM = 'albumname';
  var PICASA_URL = 'http://picasaweb.google.com/' + PICASA_USERNAME + '/' +
      PICASA_ALBUM;
  
  function setUp() {
    picasa = new goog.ui.media.PicasaAlbum();
    var model = new goog.ui.media.PicasaAlbumModel(PICASA_USERNAME,
        PICASA_ALBUM, null, 'album title');
    control = new goog.ui.media.Media(model, picasa);
    control.setSelected(true);    
  }

  function tearDown() {
    control.dispose();
  }

  function testBasicRendering() {
    control.render();
    var el = goog.dom.getElementsByTagNameAndClass('div',
        goog.ui.media.PicasaAlbum.CSS_CLASS);
    assertEquals(1, el.length);
  }

  function testParsingUrl() {
    var metadata = goog.ui.media.PicasaAlbumModel.newInstance(PICASA_URL);

    var expected = new goog.ui.media.PicasaAlbumModel(PICASA_USERNAME,
        PICASA_ALBUM);
    var model = goog.ui.media.PicasaAlbumModel.newInstance(PICASA_URL); 
    assertEquals(expected.getUserId(), model.getUserId());
    assertEquals(expected.getAlbumId(), model.getAlbumId());

    expected = new goog.ui.media.PicasaAlbumModel('foo', 'bar');
    model = goog.ui.media.PicasaAlbumModel.newInstance(
        'https://picasaweb.google.com/foo/bar'); 
    assertEquals(expected.getUserId(), model.getUserId());
    assertEquals(expected.getAlbumId(), model.getAlbumId());

    expected = new goog.ui.media.PicasaAlbumModel('foo', 'bar');
    model = goog.ui.media.PicasaAlbumModel.newInstance(
        'https://www.picasaweb.google.com/foo/bar'); 
    assertEquals(expected.getUserId(), model.getUserId());
    assertEquals(expected.getAlbumId(), model.getAlbumId());

    expected = new goog.ui.media.PicasaAlbumModel('foo', 'bar');
    model = goog.ui.media.PicasaAlbumModel.newInstance(
        'https://www.picasaweb.com/foo/bar'); 
    assertEquals(expected.getUserId(), model.getUserId());
    assertEquals(expected.getAlbumId(), model.getAlbumId());

    expected = new goog.ui.media.PicasaAlbumModel('foo', 'bar', '8Hzg1CUUAZM');
    model = goog.ui.media.PicasaAlbumModel.newInstance(
        'https://www.picasaweb.com/foo/bar' +
        '?authkey=8Hzg1CUUAZM#'); 
    assertEquals(expected.getUserId(), model.getUserId());
    assertEquals(expected.getAlbumId(), model.getAlbumId());
    assertEquals(expected.getAuthKey(), model.getAuthKey());

    expected = new goog.ui.media.PicasaAlbumModel('foo', 'bar', '8Hzg1CUUAZM');
    model = goog.ui.media.PicasaAlbumModel.newInstance(
        'https://www.picasaweb.com/foo/bar' +
        '?foo=bar&authkey=8Hzg1CUUAZM#'); 
    assertEquals(expected.getUserId(), model.getUserId());
    assertEquals(expected.getAlbumId(), model.getAlbumId());
    assertEquals(expected.getAuthKey(), model.getAuthKey());

    expected = new goog.ui.media.PicasaAlbumModel('foo', 'bar', '8Hzg1CUUAZM');
    model = goog.ui.media.PicasaAlbumModel.newInstance(
        'https://www.picasaweb.com/foo/bar' +
        '?foo=bar&authkey=8Hzg1CUUAZM&hello=world#'); 

    assertThrows('invalid urls parsing should fail', function() {
      goog.ui.media.PicasaAlbumModel.newInstance(
          'http://invalidUrl/watch?v=dMH0bHeiRNg');
    });
  }

  function testBuildingUrl() {
    assertEquals(PICASA_URL,
        goog.ui.media.PicasaAlbumModel.buildUrl(PICASA_USERNAME, PICASA_ALBUM));
  }

  function testCreatingDomOnInitialState() {
    control.render();

    var caption = goog.dom.getElementsByTagNameAndClass(
        'div',
        goog.ui.media.PicasaAlbum.CSS_CLASS + '-caption');
    assertEquals(1, caption.length);

    var flash = goog.dom.getElementsByTagNameAndClass('div',
        goog.ui.media.FlashObject.CSS_CLASS);
    assertEquals(1, flash.length);
  }
">4 of 4 tests run in 10ms.<br />2 passed, 2 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testBasicRendering<br />Object #<Object> has no method 'createElement'<br />ERROR in testCreatingDomOnInitialState<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>flashobject_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.debug.Logger');
  goog.require('goog.dom');
  goog.require('goog.dom.DomHelper');
  goog.require('goog.events');
  goog.require('goog.events.EventTarget');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.LooseMock');
  goog.require('goog.testing.MockControl');
  goog.require('goog.testing.MockClassFactory');
  goog.require('goog.ui.Component');
  goog.require('goog.ui.media.FlashObject');



  var FLASH_URL = 'http://www.youtube.com/v/RbI7cCp0v6w&hl=en&fs=1';
  var control = new goog.testing.MockControl();
  var domHelper = control.createLooseMock(goog.dom.DomHelper);
  // TODO(user): mocking window.document throws exceptions in FF2. find out how
  // to mock it.
  var documentHelper  = {body: control.createLooseMock(goog.dom.DomHelper)};
  var element = goog.dom.createElement('div');

  function setUp() {
    control.$resetAll();
    domHelper.getDocument().$returns(documentHelper).$anyTimes();
    domHelper.createElement('div').$returns(element).$anyTimes();
    documentHelper.body.appendChild(element).$anyTimes();
  }

  function tearDown() {
    control.$verifyAll();
  }

  function getFlashVarsFromElement(flash) {
    var el = flash.getFlashElement();

    // This should work in everything except IE:
    if (el.hasAttribute && el.hasAttribute('flashvars'))
      return el.getAttribute('flashvars');

    // For IE: find and return the value of the correct param element:
    el = el.firstChild;
    while (el) {
      if (el.name == 'FlashVars') {
        return el.value;
      }
      el = el.nextSibling;
    }
    return '';
  }

  function testInstantiationAndRendering() {
    control.$replayAll();

    var flash = new goog.ui.media.FlashObject(FLASH_URL, domHelper);
    flash.render();
    flash.dispose();
  }

  function testSetFlashVar() {
    control.$replayAll();

    var flash = new goog.ui.media.FlashObject(FLASH_URL, domHelper);

    assertTrue(flash.getFlashVars().isEmpty());
    flash.setFlashVar('foo', 'bar');
    flash.setFlashVar('hello', 'world');
    assertFalse(flash.getFlashVars().isEmpty());

    flash.render();

    assertEquals('foo=bar&hello=world', getFlashVarsFromElement(flash));
    flash.dispose();
  }

  function testAddFlashVars() {
    control.$replayAll();

    var flash = new goog.ui.media.FlashObject(FLASH_URL, domHelper);

    assertTrue(flash.getFlashVars().isEmpty());
    flash.addFlashVars({
      'using': 'an',
      'object': 'literal'
    });
    assertFalse(flash.getFlashVars().isEmpty());

    flash.render();

    assertEquals('using=an&object=literal', getFlashVarsFromElement(flash));
    flash.dispose();
  }

  /**
   * @deprecated Remove once setFlashVars is removed.
   */
  function testSetFlashVarsUsingFalseAsTheValue() {
    control.$replayAll();

    var flash = new goog.ui.media.FlashObject(FLASH_URL, domHelper);

    assertTrue(flash.getFlashVars().isEmpty());
    flash.setFlashVars('beEvil', false);
    assertFalse(flash.getFlashVars().isEmpty());

    flash.render();

    assertEquals('beEvil=false', getFlashVarsFromElement(flash));
    flash.dispose();
  }

  /**
   * @deprecated Remove once setFlashVars is removed.
   */
  function testSetFlashVarsWithWrongArgument() {
    control.$replayAll();

    assertThrows(function() {
      var flash = new goog.ui.media.FlashObject(FLASH_URL, domHelper);
      flash.setFlashVars('foo=bar');
      flash.dispose();
    });
  }

  function testSetFlashVarUrlEncoding() {
    control.$replayAll();

    var flash = new goog.ui.media.FlashObject(FLASH_URL, domHelper);
    flash.setFlashVar('foo', 'bar and some extra spaces');
    flash.render();
    assertEquals('foo=bar%20and%20some%20extra%20spaces',
        getFlashVarsFromElement(flash));
    flash.dispose();
  }

  function testThrowsRequiredVersionOfFlashNotAvailable() {
    control.$replayAll();

    var flash = new goog.ui.media.FlashObject(FLASH_URL, domHelper);
    flash.setRequiredVersion('999.999.999');

    assertTrue(flash.hasRequiredVersion());

    assertThrows(function() {
      flash.render();
    });

    flash.dispose();
  }

  function testIsLoadedAfterDispose() {
    control.$replayAll();

    var flash = new goog.ui.media.FlashObject(FLASH_URL, domHelper);
    flash.render();
    // TODO(user): find out a way to test the loadness of flash movies on
    // asynchronous tests. if debugger; is left here, the test pass. if removed
    // the test fails. that happens because flash needs some time to be
    // considered loaded, after flash.render() is called (like img.src i guess).
    //debugger;
    //assertTrue(flash.isLoaded());
    flash.dispose();
    assertFalse(flash.isLoaded());
  }

  function testXssAttacks() {
    control.$replayAll();

    called = false;
    var injection = ''
      + '">'
      + '</embed>'
      + '<script>called = true; // evil arbitrary js injected here<\/script>'
      + '<embed src="';
    var flash = new goog.ui.media.FlashObject(injection, domHelper);
    flash.render();
    // Makes sure FlashObject html escapes user input.
    // NOTE(user): this test fails if the URL is not HTML escaped, showing that
    // html escaping is necessary to avoid attacks.
    assertFalse(called);
  }

  function testPropagatesEventsConsistently() {
    var event = control.createLooseMock(goog.events.Event);

    // we expect any event to have its propagation stopped.
    event.stopPropagation();

    control.$replayAll();

    var flash = new goog.ui.media.FlashObject(FLASH_URL, domHelper);
    flash.render();
    event.target = flash.getElement();
    event.type = goog.events.EventType.CLICK;
    goog.testing.events.fireBrowserEvent(event);
    flash.dispose();
  }

  function testEventsGetsSinked() {
    var called = false;
    var flash = new goog.ui.media.FlashObject(FLASH_URL);
    var parent = goog.dom.createElement('div');
    flash.render(parent);

    goog.events.listen(parent, goog.events.EventType.CLICK, function(e) {
      called = true;
    });

    assertFalse(called);

    goog.testing.events.fireClickSequence(flash.getElement());

    assertFalse(called);
    flash.dispose();
  }
">TypeError: Object #<Object> has no method 'createElement'
    at Object.createElement (dom/dom.js:755:19)
    at _tmpclosuretest.js:25:26
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
    at Module.load (module.js:219:31)
</td></tr>
<tr><td>youtube_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.debug.Logger');
  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.LooseMock');
  goog.require('goog.ui.Component');
  goog.require('goog.ui.Control');
  goog.require('goog.ui.ControlRenderer');
  goog.require('goog.ui.media.FlashObject');
  goog.require('goog.ui.media.Media');
  goog.require('goog.ui.media.Youtube');
  goog.require('goog.ui.media.YoutubeModel');



  var youtube;
  var control;
  var YOUTUBE_VIDEO_ID = 'dMH0bHeiRNg';
  var YOUTUBE_URL = 'http://www.youtube.com/watch?v=' + YOUTUBE_VIDEO_ID;
  var parent = goog.dom.createElement('div');

  function setUp() {
    var model = new goog.ui.media.YoutubeModel(
        YOUTUBE_VIDEO_ID, 'evolution of dance');
    control = goog.ui.media.Youtube.newControl(model);
  }

  function tearDown() {
    control.dispose();
  }

  function testBasicRendering() {
    control.render(parent);
    var el = goog.dom.getElementsByTagNameAndClass('div',
        goog.ui.media.Youtube.CSS_CLASS, parent);
    assertEquals(1, el.length);
  }

  function testParsingUrl() {
    var model = goog.ui.media.YoutubeModel.newInstance(YOUTUBE_URL);
    assertEquals('dMH0bHeiRNg', model.getVideoId());

    var model = goog.ui.media.YoutubeModel.newInstance(
        'http://br.youtube.com/watch?v=dMH0bHeiRNg');
    assertEquals('dMH0bHeiRNg', model.getVideoId());

    assertEquals('dMH0bHeiRNg', goog.ui.media.YoutubeModel.newInstance(
        'https://br.youtube.com/watch?v=dMH0bHeiRNg').getVideoId());

    assertEquals('dMH0bHeiRNg', goog.ui.media.YoutubeModel.newInstance(
        'https://br.youtube.com/watch?v=dMH0bHeiRNg&featured=dir')
        .getVideoId());

    assertEquals('dMH0bHeiRNg', goog.ui.media.YoutubeModel.newInstance(
        'https://br.youtube.com/watch?featured=dir&amp;v=dMH0bHeiRNg')
        .getVideoId());

    assertEquals('qbce2yN81mE', goog.ui.media.YoutubeModel.newInstance(
        'http://www.youtube.com/watch?usg=AFQjCNFf90gdVBmPp-Wgya5_CTSaw&amp;' +
        'v=qbce2yN81mE&amp;source=video&amp;vgc=rss').getVideoId());

    assertThrows('youtube parser expects a well formed URL', function() {
      var videoId = goog.ui.media.YoutubeModel.newInstance(
          'http://invalidUrl/watch?v=dMH0bHeiRNg').getVideoId();
    });
  }

  function testBuildingUrl() {
    assertEquals(
        YOUTUBE_URL, goog.ui.media.YoutubeModel.buildUrl(YOUTUBE_VIDEO_ID));
  }

  function testCreatingModel() {
    var model = new goog.ui.media.YoutubeModel(YOUTUBE_VIDEO_ID);
    assertEquals(YOUTUBE_VIDEO_ID, model.getVideoId());
    assertEquals(YOUTUBE_URL, model.getUrl());
    assertUndefined(model.getCaption());
  }

  function testCreatingDomOnInitialState() {
    control.render(parent);
    var preview = goog.dom.getElementsByTagNameAndClass(
        'img',
        goog.ui.media.Youtube.CSS_CLASS + '-thumbnail0',
        parent);
    assertEquals(1, preview.length);

    var caption = goog.dom.getElementsByTagNameAndClass(
        'div',
        goog.ui.media.Youtube.CSS_CLASS + '-caption',
        parent);
    assertEquals(1, caption.length);

    var flash = goog.dom.getElementsByTagNameAndClass('div',
        goog.ui.media.FlashObject.CSS_CLASS);
    assertEquals(0, flash.length);
  }

  function testCreatingDomOnSelectedState() {
    control.render(parent);
    control.setSelected(true);
    var preview = goog.dom.getElementsByTagNameAndClass(
        'img',
        goog.ui.media.Youtube.CSS_CLASS + '-preview',
        parent);
    assertEquals(0, preview.length);

    var caption = goog.dom.getElementsByTagNameAndClass(
        'div',
        goog.ui.media.Youtube.CSS_CLASS + '-caption',
        parent);
    assertEquals(1, caption.length);

    var flash = goog.dom.getElementsByTagNameAndClass('div',
        goog.ui.media.FlashObject.CSS_CLASS, parent);
    assertEquals(1, flash.length);
  }

  function testSettingSelectedStateAfterRender() {
    control.render(parent);
    control.setSelected(true);

    var preview = goog.dom.getElementsByTagNameAndClass(
        'img',
        goog.ui.media.Youtube.CSS_CLASS + '-preview',
        parent);
    assertEquals(0, preview.length);

    var caption = goog.dom.getElementsByTagNameAndClass(
        'div',
        goog.ui.media.Youtube.CSS_CLASS + '-caption',
        parent);
    assertEquals(1, caption.length);

    var flash = goog.dom.getElementsByTagNameAndClass('div',
        goog.ui.media.FlashObject.CSS_CLASS. parent);
    assertEquals(1, flash.length);

    control.setSelected(false);

    var preview = goog.dom.getElementsByTagNameAndClass(
        'img',
        goog.ui.media.Youtube.CSS_CLASS + '-thumbnail0',
        parent);
    assertEquals(1, preview.length);

    var caption = goog.dom.getElementsByTagNameAndClass(
        'div',
        goog.ui.media.Youtube.CSS_CLASS + '-caption',
        parent);
    assertEquals(1, caption.length);

    // setting select as false doesn't actually remove the flash movie from
    // the DOM tree, which means that setting selected to true won't actually
    // restart the movie. TODO(user): fix this.
    var flash = goog.dom.getElementsByTagNameAndClass('div',
        goog.ui.media.FlashObject.CSS_CLASS, parent);
    assertEquals(1, flash.length);

    control.setSelected(true);

    var flash = goog.dom.getElementsByTagNameAndClass('div',
        goog.ui.media.FlashObject.CSS_CLASS, parent);
    assertEquals(1, flash.length);
  }
">TypeError: Object #<Object> has no method 'createElement'
    at Object.createElement (dom/dom.js:755:19)
    at _tmpclosuretest.js:22:25
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
    at Module.load (module.js:219:31)
</td></tr>
<tr><td>vimeo_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.debug.Logger');
  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.LooseMock');
  goog.require('goog.ui.Component');
  goog.require('goog.ui.Control');
  goog.require('goog.ui.ControlRenderer');
  goog.require('goog.ui.media.FlashObject');
  goog.require('goog.ui.media.Vimeo');
  goog.require('goog.ui.media.VimeoModel');



  var vimeo;
  var control;
  var VIMEO_ID = '3001295';
  var VIMEO_URL = 'http://vimeo.com/' + VIMEO_ID;
  var parent = goog.dom.createElement('div');

  function setUp() {
    vimeo = new goog.ui.media.Vimeo();
    var model = new goog.ui.media.VimeoModel(VIMEO_ID, 'vimeo caption');
    control = new goog.ui.media.Media(model, vimeo);
    control.setSelected(true);
  }

  function tearDown() {
    control.dispose();
  }

  function testBasicRendering() {
    control.render(parent);
    var el = goog.dom.getElementsByTagNameAndClass('div',
        goog.ui.media.Vimeo.CSS_CLASS, parent);
    assertEquals(1, el.length);
    assertEquals(VIMEO_URL, control.getDataModel().getUrl());
  }

  function testParsingUrl() {
    var player1 = goog.ui.media.VimeoModel.newInstance(VIMEO_URL);

    assertThrows(function() {
      goog.ui.media.Vimeo.parseUrl('http://invalidUrl/filename.doc');
    });
  }

  function testCreatingDomOnInitialState() {
    control.render(parent);
    var caption = goog.dom.getElementsByTagNameAndClass(
        'div',
        goog.ui.media.Vimeo.CSS_CLASS + '-caption',
        parent);
    assertEquals(1, caption.length);

    var flash = goog.dom.getElementsByTagNameAndClass('div',
        goog.ui.media.FlashObject.CSS_CLASS, parent);
    assertEquals(1, flash.length);
  }
">TypeError: Object #<Object> has no method 'createElement'
    at Object.createElement (dom/dom.js:755:19)
    at _tmpclosuretest.js:21:25
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
    at Module.load (module.js:219:31)
</td></tr>
<tr><td>media_test.html</td><td>Fail</td><td> 3 passed, 2 failed.</td><td title="

  goog.require('goog.debug.Logger');
  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.math.Size');
  goog.require('goog.testing.LooseMock');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.Component');
  goog.require('goog.ui.Control');
  goog.require('goog.ui.ControlRenderer');
  goog.require('goog.ui.media.Media');
  goog.require('goog.ui.media.MediaModel');
  goog.require('goog.ui.media.MediaModel.Player');
  goog.require('goog.ui.media.MediaModel.Thumbnail');



  var control;  // The name 'media' collides with a built-in var in Chrome.
  var renderer;
  var model;

  function setUp() {
    renderer = new goog.ui.media.MediaRenderer();
    model = new goog.ui.media.MediaModel(
        'http://url.com', 'a caption', 'a description');
    control = new goog.ui.media.Media(model, renderer);
  }

  function tearDown() {
    control.dispose();
  }

  function testBasicElements() {
    var model = new goog.ui.media.MediaModel(
        'http://url.com', 'a caption', 'a description');
    var thumb1 = new goog.ui.media.MediaModel.Thumbnail(
        'http://thumb.com/small.jpg', new goog.math.Size(320, 288))
    var thumb2 = new goog.ui.media.MediaModel.Thumbnail(
        'http://thumb.com/big.jpg', new goog.math.Size(800, 600))
    model.setThumbnails([thumb1, thumb2]);
    model.setPlayer(new goog.ui.media.MediaModel.Player(
        'http://media/player.swf'));
    var control = new goog.ui.media.Media(model, renderer);
    control.render();

    var caption = goog.dom.getElementsByTagNameAndClass(
        undefined,
        goog.ui.ControlRenderer.CSS_CLASS + '-caption');
    var description = goog.dom.getElementsByTagNameAndClass(
        undefined,
        goog.ui.ControlRenderer.CSS_CLASS + '-description');
    var thumbnail0 = goog.dom.getElementsByTagNameAndClass(
        'img',
        goog.ui.ControlRenderer.CSS_CLASS + '-thumbnail0');
    var thumbnail1 = goog.dom.getElementsByTagNameAndClass(
        'img',
        goog.ui.ControlRenderer.CSS_CLASS + '-thumbnail1');
    var player = goog.dom.getElementsByTagNameAndClass(
        'iframe',
        goog.ui.ControlRenderer.CSS_CLASS + '-player');

    assertNotNull(caption);
    assertEquals(1, caption.length);
    assertNotNull(description);
    assertEquals(1, description.length);
    assertNotNull(thumbnail0);
    assertEquals(1, thumbnail0.length);
    assertEquals('320px', thumbnail0[0].style.width);
    assertEquals('288px', thumbnail0[0].style.height);
    assertEquals('http://thumb.com/small.jpg', thumbnail0[0].src);
    assertNotNull(thumbnail1);
    assertEquals(1, thumbnail1.length);
    assertEquals('800px', thumbnail1[0].style.width);
    assertEquals('600px', thumbnail1[0].style.height);
    assertEquals('http://thumb.com/big.jpg', thumbnail1[0].src);
    // players are only shown when media is selected
    assertNotNull(player);
    assertEquals(0, player.length);

    control.dispose();
  }

  function testDoesntCreatesCaptionIfUnavailable() {
    var incompleteModel = new goog.ui.media.MediaModel(
        'http://url.com', undefined, 'a description');
    incompleteMedia = new goog.ui.media.Media('', renderer);
    incompleteMedia.setDataModel(incompleteModel);
    incompleteMedia.render();
    var caption = goog.dom.getElementsByTagNameAndClass(
        undefined,
        goog.ui.ControlRenderer.CSS_CLASS + '-caption');
    var description = goog.dom.getElementsByTagNameAndClass(
        undefined,
        goog.ui.ControlRenderer.CSS_CLASS + '-description');
    assertEquals(0, caption.length);
    assertNotNull(description);
    incompleteMedia.dispose();
  }

  function testMediaModel() {
    assertEquals('http://url.com', model.getUrl());
    assertEquals('a caption', model.getCaption());
    assertEquals('a description', model.getDescription());

    var incompleteModel = new goog.ui.media.MediaModel(
        'http://foo.bar',
        undefined,
        'This media has no caption but has a description and a URL');
    assertEquals('http://foo.bar', incompleteModel.getUrl());
    assertUndefined(incompleteModel.getCaption());
    assertEquals('This media has no caption but has a description and a URL',
        incompleteModel.getDescription());
    assertArrayEquals([], incompleteModel.getThumbnails());
  }

  function testMediaModelFindCategoryWithScheme() {
    assertNull(model.findCategoryWithScheme('no such scheme'));

    model.setCategories([
        new goog.ui.media.MediaModel.Category('scheme-a', 'value-a'),
        new goog.ui.media.MediaModel.Category('scheme-b', 'value-b')
    ]);
    assertNull(model.findCategoryWithScheme('no such scheme'));
    assertEquals('value-a',
        model.findCategoryWithScheme('scheme-a').getValue());
    assertEquals('value-b',
        model.findCategoryWithScheme('scheme-b').getValue());
  }

  function testMediaModelFindCreditWithRole() {
    assertNull(model.findCreditWithRole('no such role'));

    model.setCredits([
        new goog.ui.media.MediaModel.Credit('value-a', 'role-a'),
        new goog.ui.media.MediaModel.Credit('value-b', 'role-b')
    ]);
    assertNull(model.findCreditWithRole('no such role'));
    assertEquals('value-a',
        model.findCreditWithRole('role-a').getValue());
    assertEquals('value-b',
        model.findCreditWithRole('role-b').getValue());
  }
">5 of 5 tests run in 10ms.<br />3 passed, 2 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testBasicElements<br />Object #<Object> has no method 'createElement'<br />ERROR in testDoesntCreatesCaptionIfUnavailable<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>photo_test.html</td><td>Fail</td><td> 0 passed, 1 failed.</td><td title="

  goog.require('goog.debug.Logger');
  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.LooseMock');
  goog.require('goog.ui.Component');
  goog.require('goog.ui.Control');
  goog.require('goog.ui.ControlRenderer');
  goog.require('goog.ui.media.MediaModel');
  goog.require('goog.ui.media.MediaModel.Player');
  goog.require('goog.ui.media.Photo');



  var control;
  var PHOTO_URL = 'http://foo/bar.jpg';

  function setUp() {
    var photo = new goog.ui.media.MediaModel(PHOTO_URL, 'title', 'description');
    photo.setPlayer(new goog.ui.media.MediaModel.Player(PHOTO_URL));
    control = goog.ui.media.Photo.newControl(photo);
  }

  function tearDown() {
    control.dispose();
  }

  function testBasicRendering() {
    control.render();
    var el = goog.dom.getElementsByTagNameAndClass('div',
        goog.ui.media.Photo.CSS_CLASS);
    assertEquals(1, el.length);
    var img = goog.dom.getElementsByTagNameAndClass('img',
        goog.ui.media.Photo.CSS_CLASS + '-image');
    assertEquals(1, img.length);
    var caption = goog.dom.getElementsByTagNameAndClass('div',
        goog.ui.media.Photo.CSS_CLASS + '-caption');
    assertEquals(1, caption.length);
    var content = goog.dom.getElementsByTagNameAndClass('div',
        goog.ui.media.Photo.CSS_CLASS + '-description');
    assertEquals(1, content.length);
  }
">1 of 1 tests run in 7ms.<br />0 passed, 1 failed.<br />7 ms/test. 1 files loaded.<br />ERROR in testBasicRendering<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>flickr_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.debug.Logger');
  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.LooseMock');
  goog.require('goog.ui.Component');
  goog.require('goog.ui.Control');
  goog.require('goog.ui.ControlRenderer');
  goog.require('goog.ui.media.FlashObject');
  goog.require('goog.ui.media.FlickrSet');
  goog.require('goog.ui.media.FlickrSetModel');


  var flickr;
  var control;
  var FLICKR_USER = 'ingawalker';
  var FLICKR_SET = '72057594102831547';
  var FLICKRSET_URL =
      'http://www.flickr.com/photos/' + FLICKR_USER + '/sets/' + FLICKR_SET;
  var parent = goog.dom.createElement('div');

  function setUp() {
    flickr = new goog.ui.media.FlickrSet();
    var set = new goog.ui.media.FlickrSetModel(FLICKR_USER, FLICKR_SET,
        'caption');
    control = new goog.ui.media.Media(set, flickr);
  }

  function tearDown() {
    control.dispose();
  }

  function testBasicRendering() {
    control.render(parent);
    var el = goog.dom.getElementsByTagNameAndClass(
        'div', goog.ui.media.FlickrSet.CSS_CLASS, parent);
    assertEquals(1, el.length);
  }

  function testParsingUrl() {
    assertEquals(
        FLICKR_USER,
        goog.ui.media.FlickrSetModel.newInstance(FLICKRSET_URL).getUserId());

    assertEquals(
        FLICKR_SET,
        goog.ui.media.FlickrSetModel.newInstance(FLICKRSET_URL).getSetId());

    assertThrows('', function() {
      goog.ui.media.FlickrSet.parseUrl('http://invalidUrl/filename.doc');
    });
  }

  function testSettingWhichFlashUrlToUse() {
    goog.ui.media.FlickrSet.setFlashUrl('http://foo');
    assertEquals(goog.ui.media.FlickrSet.flashUrl_, 'http://foo');
  }

  function testCreatingDomOnInitialState() {
    control.render(parent);
    var caption = goog.dom.getElementsByTagNameAndClass(
        'div',
        goog.ui.media.FlickrSet.CSS_CLASS + '-caption',
        parent);
    assertEquals(1, caption.length);

    var flash = goog.dom.getElementsByTagNameAndClass(
        'div', goog.ui.media.FlashObject.CSS_CLASS, parent);
    assertEquals(1, flash.length);
  }
">TypeError: Object #<Object> has no method 'createElement'
    at Object.createElement (dom/dom.js:755:19)
    at _tmpclosuretest.js:22:25
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
    at Module.load (module.js:219:31)
</td></tr>
<tr><td>popup_test.html</td><td>Fail</td><td> 0 passed, 2 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.math.Box');
  goog.require('goog.math.Coordinate');
  goog.require('goog.positioning');
  goog.require('goog.positioning.Corner');
  goog.require('goog.positioning.AnchoredPosition');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.Popup');



/**
 * This is used to round pixel values on FF3 Mac.
 */
function assertRoundedEquals(a, b, c) {
  function round(x) {
    return goog.userAgent.GECKO && (goog.userAgent.MAC || goog.userAgent.X11) &&
        goog.userAgent.isVersion('1.9') ? Math.round(x) : x;
  }
  if (arguments.length == 3) {
    assertEquals(a, round(b), round(c));
  } else {
    assertEquals(round(a), round(b));
  }
}

function testCreateAndReposition() {
  var anchorEl = document.getElementById('anchor');
  var popupEl = document.getElementById('popup');
  var corner = goog.positioning.Corner;

  var pos = new goog.positioning.AnchoredPosition(anchorEl,
                                                  corner.BOTTOM_START);
  var popup = new goog.ui.Popup(popupEl, pos);
  popup.setVisible(true);

  var anchorRect = goog.style.getBounds(anchorEl);
  var popupRect = goog.style.getBounds(popupEl);
  assertRoundedEquals('Left edge of popup should line up with left edge ' +
                      'of anchor.',
                      anchorRect.left,
                      popupRect.left);
  assertRoundedEquals('Popup should be positioned just below the anchor.',
                      anchorRect.top + anchorRect.height,
                      popupRect.top);

  // Reposition.
  anchorEl.style.marginTop = '7px';
  popup.reposition();

  anchorRect = goog.style.getBounds(anchorEl);
  popupRect = goog.style.getBounds(popupEl);
  assertRoundedEquals('Popup should be positioned just below the anchor.',
                      anchorRect.top + anchorRect.height,
                      popupRect.top);
}


function testSetPinnedCorner() {
  var anchorEl = document.getElementById('anchor');
  var popupEl = document.getElementById('popup');
  var corner = goog.positioning.Corner;

  var pos = new goog.positioning.AnchoredPosition(anchorEl,
                                                  corner.BOTTOM_START);
  var popup = new goog.ui.Popup(popupEl, pos);
  popup.setVisible(true);

  var anchorRect = goog.style.getBounds(anchorEl);
  var popupRect = goog.style.getBounds(popupEl);
  assertRoundedEquals('Left edge of popup should line up with left edge ' +
                      'of anchor.',
                      anchorRect.left,
                      popupRect.left);
  assertRoundedEquals('Popup should be positioned just below the anchor.',
                      anchorRect.top + anchorRect.height,
                      popupRect.top);

  // Change pinned corner.
  popup.setPinnedCorner(corner.BOTTOM_END);

  anchorRect = goog.style.getBounds(anchorEl);
  popupRect = goog.style.getBounds(popupEl);
  assertRoundedEquals('Right edge of popup should line up with left edge ' +
                      'of anchor.',
                      anchorRect.left,
                      popupRect.left + popupRect.width);
  assertRoundedEquals('Bottom edge of popup should line up with bottom ' +
                      'of anchor.',
                      anchorRect.top + anchorRect.height,
                      popupRect.top + popupRect.height);

  // Position outside the viewport.
  anchorEl.style.marginLeft = '0';
  popup.reposition();

  anchorRect = goog.style.getBounds(anchorEl);
  popupRect = goog.style.getBounds(popupEl);

  assertRoundedEquals('Right edge of popup should line up with left edge ' +
                      'of anchor.',
                      anchorRect.left,
                      popupRect.left + popupRect.width);

  anchorEl.style.marginLeft = '';
}

">2 of 2 tests run in 7ms.<br />0 passed, 2 failed.<br />4 ms/test. 1 files loaded.<br />ERROR in testCreateAndReposition<br />Cannot set property 'visibility' of undefined<br />ERROR in testSetPinnedCorner<br />Cannot set property 'visibility' of undefined<br /></td></tr>
<tr><td>scrollfloater_test.html</td><td>Fail</td><td> 0 passed, 1 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.ScrollFloater');



  function testScrollFloater() {
    var scrollFloater = new goog.ui.ScrollFloater();
    var floater = goog.dom.getElement('floater');
    scrollFloater.decorate(floater);

    assertTrue('Default state is enabled', scrollFloater.isScrollingEnabled());
    assertFalse('On unscrolled page should not be floating',
                scrollFloater.isFloating());

    scrollFloater.setScrollingEnabled(false);

    assertFalse('We can disable the floater',
                scrollFloater.isScrollingEnabled());
  }

">1 of 1 tests run in 6ms.<br />0 passed, 1 failed.<br />6 ms/test. 1 files loaded.<br />ERROR in testScrollFloater<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>submenu_test.html</td><td>Fail</td><td> 0 passed, 12 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.classes');
  goog.require('goog.events');
  goog.require('goog.style');
  goog.require('goog.positioning');
  goog.require('goog.positioning.Overflow');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.Component.EventType');
  goog.require('goog.ui.Menu');
  goog.require('goog.ui.MenuItem');
  goog.require('goog.ui.Popup');
  goog.require('goog.ui.SubMenu');
  goog.require('goog.ui.SubMenuRenderer');



var menu;
var clonedMenuDom;

var mockClock;

// mock out goog.positioning.positionAtCoordinate so that
// the menu always fits. (we don't care about testing the
// dynamic menu positioning if the menu doesn't fit in the window.)
var oldPositionFn = goog.positioning.positionAtCoordinate;
goog.positioning.positionAtCoordinate = function(absolutePos, movableElement,
                                                 movableElementCorner,
                                                 opt_margin, opt_overflow) {
  return oldPositionFn.call(null, absolutePos, movableElement,
      movableElementCorner, opt_margin, goog.positioning.Overflow.IGNORE);
};

function setUp() {
  clonedMenuDom = goog.dom.getElement('demoMenu').cloneNode(true);

  menu = new goog.ui.Menu();
}

function tearDown() {
  document.body.style.direction = 'ltr';
  menu.dispose();

  var element = goog.dom.getElement('demoMenu');
  element.parentNode.replaceChild(clonedMenuDom, element);

  goog.dom.getElement('sandbox').innerHTML = '';

  if (mockClock) {
    mockClock.uninstall();
    mockClock = null;
  }
}

function testNormalLtrSubMenu() {
  menu.decorate(goog.dom.getElement('demoMenu'));
  var subMenu = menu.getChildAt(1);
  assertArrowDirection(subMenu, false);
  assertRenderDirection(subMenu, false);
  assertArrowPosition(subMenu, false);
}

function testNormalRtlSubMenu() {
  document.body.style.direction = 'rtl';
  menu.decorate(goog.dom.getElement('demoMenu'));
  var subMenu = menu.getChildAt(1);
  assertArrowDirection(subMenu, true);
  assertRenderDirection(subMenu, true);
  assertArrowPosition(subMenu, true);
}

function testLtrSubMenuAlignedToStart() {
  menu.decorate(goog.dom.getElement('demoMenu'));
  var subMenu = menu.getChildAt(1);
  subMenu.setAlignToEnd(false);
  assertArrowDirection(subMenu, true);
  assertRenderDirection(subMenu, true);
  assertArrowPosition(subMenu, false);
}

function testRtlSubMenuAlignedToStart() {
  document.body.style.direction = 'rtl';
  menu.decorate(goog.dom.getElement('demoMenu'));
  var subMenu = menu.getChildAt(1);
  subMenu.setAlignToEnd(false);
  assertArrowDirection(subMenu, false);
  assertRenderDirection(subMenu, false);
  assertArrowPosition(subMenu, true);
}

function testExitDocument() {
  menu.decorate(goog.dom.getElement('demoMenu'));
  var subMenu = menu.getChildAt(1);
  var innerMenu = subMenu.getMenu();

  assertTrue('Top-level menu was not in document', menu.isInDocument());
  assertTrue('Submenu was not in document', subMenu.isInDocument());
  assertTrue('Inner menu was not in document', innerMenu.isInDocument());

  menu.exitDocument();

  assertFalse('Top-level menu was in document', menu.isInDocument());
  assertFalse('Submenu was in document', subMenu.isInDocument());
  assertFalse('Inner menu was in document', innerMenu.isInDocument());
}

function testDisposal() {
  menu.decorate(goog.dom.getElement('demoMenu'));
  var subMenu = menu.getChildAt(1);
  var innerMenu = subMenu.getMenu();
  menu.dispose();

  assert('Top-level menu was not disposed', menu.getDisposed());
  assert('Submenu was not disposed', subMenu.getDisposed());
  assert('Inner menu was not disposed', innerMenu.getDisposed());
}

function testShowAndDismissSubMenu() {
  var openEventDispatched = false;
  var closeEventDispatched = false;

  function handleEvent(e) {
    switch (e.type) {
      case goog.ui.Component.EventType.OPEN:
        openEventDispatched = true;
        break;
      case goog.ui.Component.EventType.CLOSE:
        closeEventDispatched = true;
        break;
      default:
        fail('Invalid event type: ' + e.type);
    }
  }

  menu.decorate(goog.dom.getElement('demoMenu'));
  var subMenu = menu.getChildAt(1);
  subMenu.setHighlighted(true);

  goog.events.listen(subMenu, [
    goog.ui.Component.EventType.OPEN,
    goog.ui.Component.EventType.CLOSE
  ], handleEvent);

  assertFalse('Submenu must not have "-open" CSS class',
      goog.dom.classes.has(subMenu.getElement(), 'goog-submenu-open'));
  assertFalse('Popup menu must not be visible',
      subMenu.getMenu().isVisible());
  assertFalse('No OPEN event must have been dispatched', openEventDispatched);
  assertFalse('No CLOSE event must have been dispatched', closeEventDispatched);

  subMenu.showSubMenu();
  assertTrue('Submenu must have "-open" CSS class',
      goog.dom.classes.has(subMenu.getElement(), 'goog-submenu-open'));
  assertTrue('Popup menu must be visible',
      subMenu.getMenu().isVisible());
  assertTrue('OPEN event must have been dispatched', openEventDispatched);
  assertFalse('No CLOSE event must have been dispatched', closeEventDispatched);

  subMenu.dismissSubMenu();
  assertFalse('Submenu must not have "-open" CSS class',
      goog.dom.classes.has(subMenu.getElement(), 'goog-submenu-open'));
  assertFalse('Popup menu must not be visible',
      subMenu.getMenu().isVisible());
  assertTrue('CLOSE event must have been dispatched', closeEventDispatched);

  goog.events.unlisten(subMenu, [
    goog.ui.Component.EventType.OPEN,
    goog.ui.Component.EventType.CLOSE
  ], handleEvent);
}

function testLazyInstantiateSubMenu() {
  menu.decorate(goog.dom.getElement('demoMenu'));
  var subMenu = menu.getChildAt(1);
  subMenu.setHighlighted(true);

  var lazyMenu;

  var key = goog.events.listen(subMenu, goog.ui.Component.EventType.OPEN,
      function(e) {
        lazyMenu = new goog.ui.Menu();
        lazyMenu.addItem(new goog.ui.MenuItem('foo'));
        lazyMenu.addItem(new goog.ui.MenuItem('bar'));
        subMenu.setMenu(lazyMenu, /* opt_internal */ false);
      });

  subMenu.showSubMenu();
  assertNotNull('Popup menu must have been created', lazyMenu);
  assertEquals('Popup menu must be a child of the submenu', subMenu,
      lazyMenu.getParent());
  assertTrue('Popup menu must have been rendered', lazyMenu.isInDocument());
  assertTrue('Popup menu must be visible', lazyMenu.isVisible());

  menu.dispose();
  assertTrue('Submenu must have been disposed of', subMenu.isDisposed());
  assertFalse('Popup menu must not have been disposed of',
      lazyMenu.isDisposed());

  lazyMenu.dispose();

  goog.events.unlistenByKey(key);
}

function testReusableMenu() {
  var subMenuOne = new goog.ui.SubMenu('SubMenu One');
  var subMenuTwo = new goog.ui.SubMenu('SubMenu Two');
  menu.addItem(subMenuOne);
  menu.addItem(subMenuTwo);
  menu.render(goog.dom.getElement('sandbox'));

  // It is possible for the same popup menu to be shared between different
  // submenus.
  var sharedMenu = new goog.ui.Menu();
  sharedMenu.addItem(new goog.ui.MenuItem('Hello'));
  sharedMenu.addItem(new goog.ui.MenuItem('World'));

  assertNull('Shared menu must not have a parent', sharedMenu.getParent());

  subMenuOne.setMenu(sharedMenu);
  assertEquals('SubMenuOne must point to the shared menu', sharedMenu,
      subMenuOne.getMenu());
  assertEquals('SubMenuOne must be the shared menu\'s parent', subMenuOne,
      sharedMenu.getParent());

  subMenuTwo.setMenu(sharedMenu);
  assertEquals('SubMenuTwo must point to the shared menu', sharedMenu,
      subMenuTwo.getMenu());
  assertEquals('SubMenuTwo must be the shared menu\'s parent', subMenuTwo,
      sharedMenu.getParent());
  assertEquals('SubMenuOne must still point to the shared menu', sharedMenu,
      subMenuOne.getMenu());

  menu.setHighlighted(subMenuOne);
  subMenuOne.showSubMenu();
  assertEquals('SubMenuOne must point to the shared menu', sharedMenu,
      subMenuOne.getMenu());
  assertEquals('SubMenuOne must be the shared menu\'s parent', subMenuOne,
      sharedMenu.getParent());
  assertEquals('SubMenuTwo must still point to the shared menu', sharedMenu,
      subMenuTwo.getMenu());
  assertTrue('Shared menu must be visible', sharedMenu.isVisible());

  menu.setHighlighted(subMenuTwo);
  subMenuTwo.showSubMenu();
  assertEquals('SubMenuTwo must point to the shared menu', sharedMenu,
      subMenuTwo.getMenu());
  assertEquals('SubMenuTwo must be the shared menu\'s parent', subMenuTwo,
      sharedMenu.getParent());
  assertEquals('SubMenuOne must still point to the shared menu', sharedMenu,
      subMenuOne.getMenu());
  assertTrue('Shared menu must be visible', sharedMenu.isVisible());
}

/**
 * If you remove a submenu in the interval between when a mouseover event
 * is fired on it, and showSubMenu() is called, showSubMenu causes a null
 * value to be dereferenced. This test validates that the fix for this works.
 * (See bug 1823144).
 */
function testDeleteItemDuringSubmenuDisplayInterval() {
  mockClock = new goog.testing.MockClock(true);

  var submenu = new goog.ui.SubMenu('submenu');
  submenu.addItem(new goog.ui.MenuItem("submenu item 1"));
  menu.addItem(submenu);

  // Trigger mouseover, and remove item before showSubMenu can be called.
  var e = new goog.events.Event();
  submenu.handleMouseOver(e);
  menu.removeItem(submenu);
  mockClock.tick(goog.ui.SubMenu.MENU_DELAY_MS);
  // (No JS error should occur.)
}

function testShowSubMenuAfterRemoval() {
  var submenu = new goog.ui.SubMenu('submenu');
  menu.addItem(submenu);
  menu.removeItem(submenu);
  submenu.showSubMenu();
  // (No JS error should occur.)
}

function testSubmenuSelectable() {
  var submenu = new goog.ui.SubMenu('submenu');
  submenu.addItem(new goog.ui.MenuItem('submenu item 1'));
  menu.addItem(submenu);
  submenu.setSelectable(true);

  var numClicks = 0;
  var menuClickedFn = function(e) {
    numClicks++;
  }

  goog.events.listen(submenu, goog.ui.Component.EventType.ACTION,
      menuClickedFn);
  submenu.performActionInternal(null);
  submenu.performActionInternal(null);

  assertEquals('The submenu should have fired an event', 2, numClicks);

  submenu.setSelectable(false);
  submenu.performActionInternal(null);

  assertEquals('The submenu should not have fired any further events', 2,
      numClicks);
}

/**
 * Asserts that this sub menu renders in the right direction relative to
 * the parent menu.
 * @param {goog.ui.SubMenu} subMenu The sub menu.
 * @param {boolean} left True for left-pointing, false for right-pointing.
 */
function assertRenderDirection(subMenu, left) {
  subMenu.getParent().setHighlighted(subMenu);
  subMenu.showSubMenu();
  var menuItemPosition = goog.style.getPageOffset(subMenu.getElement());
  var menuPosition = goog.style.getPageOffset(subMenu.getMenu().getElement());
  assert(Math.abs(menuItemPosition.y - menuPosition.y) < 5);
  assertEquals(
      "Menu at: " + menuPosition.x +
      ", submenu item at: " + menuItemPosition.x,
      left, menuPosition.x < menuItemPosition.x);
}

/**
 * Asserts that this sub menu has a properly-oriented arrow.
 * @param {goog.ui.SubMenu} subMenu The sub menu.
 * @param {boolean} left True for left-pointing, false for right-pointing.
 */
function assertArrowDirection(subMenu, left) {
  assertEquals(
      left ? goog.ui.SubMenuRenderer.LEFT_ARROW_ :
      goog.ui.SubMenuRenderer.RIGHT_ARROW_,
      getArrowElement(subMenu).innerHTML);
}

/**
 * Asserts that the arrow position is correct.
 * @param {goog.ui.SubMenu} subMenu The sub menu.
 * @param {boolean} leftAlign True for left-aligned, false for right-aligned.
 */
function assertArrowPosition(subMenu, left) {
  var arrow = getArrowElement(subMenu);
  var expectedLeft =
      left ? 0 : arrow.offsetParent.offsetWidth - arrow.offsetWidth;
  var actualLeft = arrow.offsetLeft;
  assertTrue('Expected left offset: ' + expectedLeft + '\n' +
             'Actual left offset: ' + actualLeft + '\n',
             Math.abs(expectedLeft - actualLeft) < 5);
}

/**
 * Gets the arrow element of a sub menu.
 * @param {goog.ui.SubMenu} subMenu The sub menu.
 * @return {Element} The arrow.
 */
function getArrowElement(subMenu) {
  return subMenu.getContentElement().lastChild;
}

">12 of 12 tests run in 11ms.<br />0 passed, 12 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testDeleteItemDuringSubmenuDisplayInterval<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testDisposal<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testExitDocument<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testLazyInstantiateSubMenu<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testLtrSubMenuAlignedToStart<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testNormalLtrSubMenu<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testNormalRtlSubMenu<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testReusableMenu<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testRtlSubMenuAlignedToStart<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testShowAndDismissSubMenu<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testShowSubMenuAfterRemoval<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testSubmenuSelectable<br />Object #<Object> has no method 'cloneNode'<br /></td></tr>
<tr><td>activitymonitor_test.html</td><td>Fail</td><td> 0 passed, 1 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.ActivityMonitor');



  // Override goog.now in order to test idle timer.
  var testTime = 0;
  goog.now = function() {
    return testTime;
  };


  function testIdle() {
    var activityMonitor = new goog.ui.ActivityMonitor();
    assertEquals(activityMonitor.getLastEventTime(), 0);

    testTime = 1000;
    activityMonitor.resetTimer();
    assertEquals(activityMonitor.getLastEventTime(), 1000);
    assertEquals(activityMonitor.getIdleTime(), 0);

    testTime = 2000;
    assertEquals(activityMonitor.getLastEventTime(), 1000);
    assertEquals(activityMonitor.getIdleTime(), 1000);
  }
">1 of 1 tests run in 5ms.<br />0 passed, 1 failed.<br />5 ms/test. 1 files loaded.<br />ERROR in testIdle<br />Object #<Object> has no method 'attachEvent'<br /></td></tr>
<tr><td>inputdatepicker_test.html</td><td>Fail</td><td> 0 passed, 3 failed.</td><td title="

    goog.require('goog.ui.InputDatePicker');
    goog.require('goog.testing.jsunit');
  

  var dateTimeFormatter = new goog.i18n.DateTimeFormat('MM/dd/yyyy');
  var dateTimeParser = new goog.i18n.DateTimeParse('MM/dd/yyyy');

  var inputDatePicker;
  var popupDatePicker;

  function setUp() {
  }

  function tearDown() {
    if (inputDatePicker) {
      inputDatePicker.dispose();
    }
    if (popupDatePicker) {
      popupDatePicker.dispose();
    }
    goog.dom.getElement('renderElement').innerHTML = '';
    goog.dom.getElement('popupParent').innerHTML = '';
  }

  /**
   * Ensure that if setPopupParentElement is not called, that the
   * PopupDatePicker is parented to the body element.
   */
  function test_setPopupParentElementDefault() {
    setPopupParentElement_(null);
    assertEquals('PopupDatePicker should be parented to the body element',
        document.body,
        popupDatePicker.getElement().parentNode);
  }

  /**
   * Ensure that if setPopupParentElement is called, that the
   * PopupDatePicker is parented to the specified element.
   */
  function test_setPopupParentElement() {
    var popupParentElement = goog.dom.getElement('popupParent');
    setPopupParentElement_(popupParentElement);
    assertEquals('PopupDatePicker should be parented to the popupParent DIV',
        popupParentElement,
        popupDatePicker.getElement().parentNode);
  }

  /**
   * Creates a new InputDatePicker and calls setPopupParentElement with the
   * specified element, if provided. If el is null, then setPopupParentElement
   * is not called.
   * @param {Element} el If non-null, the argument to pass to
   *     inputDatePicker.setPopupParentElement().
   * @private
   */
  function setPopupParentElement_(el) {
    inputDatePicker = new goog.ui.InputDatePicker(
        dateTimeFormatter,
        dateTimeParser);

    if (el) {
      inputDatePicker.setPopupParentElement(el);
    }

    inputDatePicker.render(goog.dom.getElement('renderElement'));
    popupDatePicker = inputDatePicker.popupDatePicker_;
  }


  function test_ItParsesDataCorrectly() {
    inputDatePicker = new goog.ui.InputDatePicker(
        dateTimeFormatter,
        dateTimeParser);
    inputDatePicker.render(goog.dom.getElement('renderElement'));

    inputDatePicker.createDom();
    inputDatePicker.setInputValue('8/9/2009');

    var parsedDate = inputDatePicker.getInputValueAsDate_();
    assertEquals(2009, parsedDate.getYear());
    assertEquals(7, parsedDate.getMonth()); // Months start from 0
    assertEquals(9, parsedDate.getDate());
  }
">3 of 3 tests run in 30ms.<br />0 passed, 3 failed.<br />10 ms/test. 1 files loaded.<br />ERROR in test_ItParsesDataCorrectly<br />Object #<Object> has no method 'createElement'<br />ERROR in test_setPopupParentElement<br />Object #<Object> has no method 'createElement'<br />ERROR in test_setPopupParentElementDefault<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>tablesorter_test.html</td><td>Fail</td><td> 0 passed, 7 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.testing.jsunit');
    goog.require('goog.testing.events');
    goog.require('goog.ui.TableSorter');
  

    var oldHtml = goog.dom.getElement('content').innerHTML;
    var alphaHeader, numberHeader, notSortableHeader, table, tableSorter;

    function setUp() {
      goog.dom.getElement('content').innerHTML = oldHtml;
      table = goog.dom.getElement('sortable');
      alphaHeader = table.getElementsByTagName('TH')[0];
      numberHeader = table.getElementsByTagName('TH')[1];
      notSortableHeader = table.getElementsByTagName('TH')[2];

      tableSorter = new goog.ui.TableSorter();
      tableSorter.setSortFunction(0, goog.ui.TableSorter.alphaSort);
          tableSorter.setSortFunction(2, goog.ui.TableSorter.noSort);
      tableSorter.decorate(table);
    }

    function tearDown() {
      tableSorter.dispose();
      table = null;
    }

    function testConstructor() {
      assertNotNull('Should have successful construction', tableSorter);
      assertNotNull('Should be in document', tableSorter);
    }

    function testForwardAlpha() {
      goog.testing.events.fireClickEvent(alphaHeader);
      assertOrder(['A', '10', 'B', '0', 'C', '10', 'C', '17', 'C', '3']);
      assertTrue(goog.dom.classes.has(alphaHeader, 'goog-tablesorter-sorted'));
      assertEquals(0, tableSorter.getSortColumn());
      assertFalse(tableSorter.isSortReversed());
    }

    function testBackwardAlpha() {
      goog.testing.events.fireClickEvent(alphaHeader);
      goog.testing.events.fireClickEvent(alphaHeader);
      assertOrder(['C', '10', 'C', '17', 'C', '3', 'B', '0', 'A', '10']);
      assertTrue(goog.dom.classes.has(alphaHeader,
          'goog-tablesorter-sorted-reverse'));
      assertEquals(0, tableSorter.getSortColumn());
      assertTrue(tableSorter.isSortReversed());
    }

    function testForwardNumeric() {
      goog.testing.events.fireClickEvent(numberHeader);
      assertOrder(['B', '0', 'C', '3', 'C', '10', 'A', '10', 'C', '17']);
      assertTrue(goog.dom.classes.has(numberHeader, 'goog-tablesorter-sorted'));
      assertEquals(1, tableSorter.getSortColumn());
      assertFalse(tableSorter.isSortReversed());
    }

    function testBackwardNumeric() {
      goog.testing.events.fireClickEvent(numberHeader);
      goog.testing.events.fireClickEvent(numberHeader);
      assertOrder(['C', '17', 'C', '10', 'A', '10', 'C', '3', 'B', '0']);
      assertTrue(goog.dom.classes.has(numberHeader,
          'goog-tablesorter-sorted-reverse'));
      assertEquals(1, tableSorter.getSortColumn());
      assertTrue(tableSorter.isSortReversed());
    }

    function testAlphaThenNumeric() {
      testForwardAlpha();
      goog.testing.events.fireClickEvent(numberHeader);
      assertOrder(['B', '0', 'C', '3', 'A', '10', 'C', '10', 'C', '17']);
      assertFalse(goog.dom.classes.has(alphaHeader, 'goog-tablesorter-sorted'));
      assertEquals(1, tableSorter.getSortColumn());
      assertFalse(tableSorter.isSortReversed());
    }

    function testNotSortableUnchanged() {
      goog.testing.events.fireClickEvent(notSortableHeader);
      assertEquals(0, goog.dom.classes.get(notSortableHeader).length);
      assertEquals(-1, tableSorter.getSortColumn());
    }

    function assertOrder(arr) {
      var actual = [];
      goog.array.forEach(table.getElementsByTagName('TD'), function(td, idx) {
        var txt = goog.dom.getTextContent(td);
        if (txt) {
          actual.push(txt);
        }
      });
      assertArrayEquals(arr, actual);
    }

  ">7 of 7 tests run in 8ms.<br />0 passed, 7 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testAlphaThenNumeric<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testBackwardAlpha<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testBackwardNumeric<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testConstructor<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testForwardAlpha<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testForwardNumeric<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testNotSortableUnchanged<br />Object #<Object> has no method 'getElementsByTagName'<br /></td></tr>
<tr><td>zippy_test.html</td><td>Fail</td><td> 0 passed, 9 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.events');
    goog.require('goog.testing.events');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.Zippy');
    goog.require('goog.ui.ZippyEvent');
  


  var zippy, fakeZippy1, fakeZippy2, contentlessZippy, headerlessZippy;
  var lazyZippy;
  var lazyZippyCallCount;
  var lazyZippyContentEl;
  var dualHeaderZippy;
  var dualHeaderZippyCollapsedHeaderEl;
  var dualHeaderZippyExpandedHeaderEl;

  function setUp() {
    zippy = new goog.ui.Zippy(goog.dom.getElement('t1'),
        goog.dom.getElement('c1'));

    var fakeControlEl = document.createElement('button');
    var fakeContentEl = document.createElement('div');

    fakeZippy1 = new goog.ui.Zippy(fakeControlEl.cloneNode(true),
        fakeContentEl.cloneNode(true), true);
    fakeZippy2 = new goog.ui.Zippy(fakeControlEl.cloneNode(true),
        fakeContentEl.cloneNode(true), false);
    contentlessZippy = new goog.ui.Zippy(fakeControlEl.cloneNode(true),
        undefined, true);
    headerlessZippy = new goog.ui.Zippy(null, fakeContentEl.cloneNode(true),
        true);

    lazyZippyCallCount = 0;
    lazyZippyContentEl = fakeContentEl.cloneNode(true);
    lazyZippy = new goog.ui.Zippy(goog.dom.getElement('t1'), function() {
      lazyZippyCallCount++;
      return lazyZippyContentEl;
    });
    dualHeaderZippyCollapsedHeaderEl = fakeControlEl.cloneNode(true);
    dualHeaderZippyExpandedHeaderEl = fakeControlEl.cloneNode(true);
    dualHeaderZippy = new goog.ui.Zippy(dualHeaderZippyCollapsedHeaderEl,
        fakeContentEl.cloneNode(true), false, dualHeaderZippyExpandedHeaderEl);
  }

  function testConstructor() {
    assertNotNull('must not be null', zippy);
  }

  function testIsExpanded() {
    assertEquals("Default expanded must be false", false, zippy.isExpanded());
    assertEquals("Expanded must be true", true, fakeZippy1.isExpanded());
    assertEquals("Expanded must be false", false, fakeZippy2.isExpanded());
    assertEquals("Expanded must be true", true, headerlessZippy.isExpanded());
    assertEquals("Expanded must be false", false, lazyZippy.isExpanded());
    assertEquals("Expanded must be false", false, dualHeaderZippy.isExpanded());
  }

  function tearDown() {
    zippy.disposeInternal();
    fakeZippy1.disposeInternal();
    fakeZippy2.disposeInternal();
    contentlessZippy.disposeInternal();
    headerlessZippy.disposeInternal();
    lazyZippy.disposeInternal();
    dualHeaderZippy.disposeInternal();
  }

  function testExpandCollapse() {
    zippy.expand();
    headerlessZippy.expand();
    assertEquals("expanded must be true", true, zippy.isExpanded());
    assertEquals("expanded must be true", true, headerlessZippy.isExpanded());

    zippy.collapse();
    headerlessZippy.collapse();
    assertEquals("expanded must be false", false, zippy.isExpanded());
    assertEquals("expanded must be false", false, headerlessZippy.isExpanded());
  }

  function testExpandCollapse_lazyZippy() {
    assertEquals("callback should not be called #1.", 0, lazyZippyCallCount);
    lazyZippy.collapse();
    assertEquals("callback should not be called #2.", 0, lazyZippyCallCount);

    lazyZippy.expand();
    assertEquals("callback should be called once #1.", 1, lazyZippyCallCount);
    assertEquals("expanded must be true", true, lazyZippy.isExpanded());
    assertEquals("contentEl should be visible", "",
        lazyZippyContentEl.style.display);

    lazyZippy.collapse();
    assertEquals("callback should be called once #2.", 1, lazyZippyCallCount);
    assertEquals("expanded must be false", false, lazyZippy.isExpanded());
    assertEquals("contentEl should not be visible", "none",
        lazyZippyContentEl.style.display);

    lazyZippy.expand();
    assertEquals("callback should be called once #3.", 1, lazyZippyCallCount);
    assertEquals("expanded must be true #2", true, lazyZippy.isExpanded());
    assertEquals("contentEl should be visible #2", "",
        lazyZippyContentEl.style.display);
  }

  function testExpandCollapse_dualHeaderZippy() {
    dualHeaderZippy.expand();
    assertEquals("expanded must be true", true, dualHeaderZippy.isExpanded());
    assertEquals("collapsed header should not have a class name #1", "",
        dualHeaderZippyCollapsedHeaderEl.className);
    assertEquals("expanded header should not have a class name #1", "",
        dualHeaderZippyExpandedHeaderEl.className);

    dualHeaderZippy.collapse();
    assertEquals("expanded must be false", false, dualHeaderZippy.isExpanded());
    assertEquals("collapsed header should not have a class name #2", "",
        dualHeaderZippyCollapsedHeaderEl.className);
    assertEquals("expanded header should not have a class name #2", "",
        dualHeaderZippyExpandedHeaderEl.className);
  }

  function testSetExpand() {
    var expanded = !zippy.isExpanded();
    zippy.setExpanded(expanded);
    assertEquals("expanded must be " + expanded, expanded, zippy.isExpanded());
  }

  function testToggle() {
    var expanded = !zippy.isExpanded();
    zippy.toggle();
    assertEquals("expanded must be " + expanded, expanded, zippy.isExpanded());
  }

  function testCustomEventTOGGLE() {
    var dispatchedActionCount;
    var handleAction = function() {
      dispatchedActionCount++;
    }

    var doTest = function (zippyObj) {
      dispatchedActionCount = 0;
      goog.events.listen(zippyObj, goog.ui.Zippy.Events.TOGGLE, handleAction);
      zippy.toggle();
      assertEquals("Custom Event must be called ", 1, dispatchedActionCount);
    }

    doTest(zippy);
    doTest(fakeZippy1);
    doTest(contentlessZippy);
    doTest(headerlessZippy);
  }

  function testBasicZippyBehavior() {
    var dispatchedActionCount = 0;
    var handleAction = function() {
      dispatchedActionCount++;
    }

    goog.events.listen(zippy, goog.ui.Zippy.Events.TOGGLE, handleAction);
    goog.testing.events.fireClickSequence(zippy.elHeader_);
    assertEquals('Zippy  must have dispatched TOGGLE on click', 1,
        dispatchedActionCount);

  }
">9 of 9 tests run in 9ms.<br />0 passed, 9 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testBasicZippyBehavior<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testConstructor<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testCustomEventTOGGLE<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testExpandCollapse<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testExpandCollapse_dualHeaderZippy<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testExpandCollapse_lazyZippy<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testIsExpanded<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testSetExpand<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testToggle<br />Object #<Object> has no method 'attachEvent'<br /></td></tr>
<tr><td>button_test.html</td><td>Fail</td><td> 0 passed, 9 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.events');
    goog.require('goog.testing.events');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.Button');
    goog.require('goog.ui.ButtonSide');
    goog.require('goog.ui.ButtonRenderer');
    goog.require('goog.ui.NativeButtonRenderer');
  

    var sandbox = goog.dom.getElement('sandbox');
    var button;
    var clonedButtonDom;
    var demoButtonElement;

    function setUp() {
      button = new goog.ui.Button();
      demoButtonElement = goog.dom.getElement('demoButton');
      clonedButtonDom = demoButtonElement.cloneNode(true);
    }

    function tearDown() {
      button.dispose();
      demoButtonElement.parentNode.replaceChild(clonedButtonDom,
          demoButtonElement);
      goog.dom.removeChildren(sandbox);
    }

    function testConstructor() {
      assertNotNull('Button must not be null', button);
      assertEquals('Renderer must default to expected value',
          goog.ui.NativeButtonRenderer.getInstance(), button.getRenderer());

      var fakeDomHelper = {};
      var testButton = new goog.ui.Button('Hello',
          goog.ui.ButtonRenderer.getInstance(), fakeDomHelper);
      assertEquals('Content must have expected value', 'Hello',
          testButton.getContent());
      assertEquals('Renderer must have expected value',
          goog.ui.ButtonRenderer.getInstance(), testButton.getRenderer());
      assertEquals('DOM helper must have expected value', fakeDomHelper,
          testButton.getDomHelper());
      testButton.dispose();
    }

    function testGetSetValue() {
      assertUndefined('Button\'s value must default to undefined',
          button.getValue());
      button.setValue(17);
      assertEquals('Button must have expected value', 17, button.getValue());
      button.render(sandbox);
      assertEquals('Button element must have expected value', '17',
          button.getElement().value);
      button.setValue('foo');
      assertEquals('Button element must have updated value', 'foo',
          button.getElement().value);
      button.setValueInternal('bar');
      assertEquals('Button must have new internal value', 'bar',
          button.getValue());
      assertEquals('Button element must be unchanged', 'foo',
          button.getElement().value);
    }

    function testGetSetTooltip() {
      assertUndefined('Button\'s tooltip must default to undefined',
          button.getTooltip());
      button.setTooltip('Hello');
      assertEquals('Button must have expected tooltip', 'Hello',
          button.getTooltip());
      button.render(sandbox);
      assertEquals('Button element must have expected title', 'Hello',
          button.getElement().title);
      button.setTooltip('Goodbye');
      assertEquals('Button element must have updated title', 'Goodbye',
          button.getElement().title);
      button.setTooltipInternal('World');
      assertEquals('Button must have new internal tooltip', 'World',
          button.getTooltip());
      assertEquals('Button element must be unchanged', 'Goodbye',
          button.getElement().title);
    }

    function testSetCollapsed() {
      assertNull('Button must not have any collapsed styling by default',
          button.getExtraClassNames());
      button.setCollapsed(goog.ui.ButtonSide.START);
      assertSameElements('Button must have the start side collapsed',
          ['goog-button-collapse-left'], button.getExtraClassNames());
      button.render(sandbox);
      assertSameElements('Button element must have the start side collapsed',
          ['goog-button', 'goog-button-collapse-left'],
          goog.dom.classes.get(button.getElement()));
      button.setCollapsed(goog.ui.ButtonSide.BOTH);
      assertSameElements('Button must have both sides collapsed',
          ['goog-button-collapse-left', 'goog-button-collapse-right'],
          button.getExtraClassNames());
      assertSameElements('Button element must have both sides collapsed', [
        'goog-button',
        'goog-button-collapse-left',
        'goog-button-collapse-right'
      ], goog.dom.classes.get(button.getElement()));
    }

    function testDispose() {
      assertFalse('Button must not have been disposed of', button.isDisposed());
      button.render(sandbox);
      button.setValue('foo');
      button.setTooltip('bar');
      button.dispose();
      assertTrue('Button must have been disposed of', button.isDisposed());
      assertUndefined('Button\'s value must have been deleted',
          button.getValue());
      assertUndefined('Button\'s tooltip must have been deleted',
          button.getTooltip());
    }

    function testBasicButtonBehavior() {
      var dispatchedActionCount = 0;
      var handleAction = function() {
        dispatchedActionCount++;
      };
      goog.events.listen(button, goog.ui.Component.EventType.ACTION,
          handleAction);

      button.decorate(demoButtonElement);
      goog.testing.events.fireClickSequence(demoButtonElement);
      assertEquals('Button must have dispatched ACTION on click', 1,
          dispatchedActionCount);

      dispatchedActionCount = 0;
      var e = new goog.events.Event(goog.events.KeyHandler.EventType.KEY,
          button);
      e.keyCode = goog.events.KeyCodes.ENTER;
      button.handleKeyEvent(e);
      assertEquals('Enabled button must have dispatched ACTION on Enter key', 1,
          dispatchedActionCount);

      dispatchedActionCount = 0;
      e = new goog.events.Event(goog.events.EventType.KEYUP, button);
      e.keyCode = goog.events.KeyCodes.SPACE;
      button.handleKeyEvent(e);
      assertEquals('Enabled button must have dispatched ACTION on Space key', 1,
          dispatchedActionCount);

      goog.events.unlisten(button, goog.ui.Component.EventType.ACTION,
          handleAction);
    }

    function testDisabledButtonBehavior() {
      var dispatchedActionCount = 0;
      var handleAction = function() {
        dispatchedActionCount++;
      };
      goog.events.listen(button, goog.ui.Component.EventType.ACTION,
          handleAction);

      button.setEnabled(false);

      dispatchedActionCount = 0;
      button.handleKeyEvent({keyCode: goog.events.KeyCodes.ENTER});
      assertEquals('Disabled button must have dispatched ACTION on Enter key',
          0, dispatchedActionCount);

      dispatchedActionCount = 0;
      button.handleKeyEvent({
        keyCode: goog.events.KeyCodes.SPACE,
        type: goog.events.EventType.KEYUP
      });
      assertEquals('Disabled button must not have dispatched ACTION on Space',
          0, dispatchedActionCount);

      goog.events.unlisten(button, goog.ui.Component.EventType.ACTION,
          handleAction);
    }

    function testSpaceFireActionOnKeyUp() {
      var dispatchedActionCount = 0;
      var handleAction = function() {
        dispatchedActionCount++;
      };
      goog.events.listen(button, goog.ui.Component.EventType.ACTION,
          handleAction);

      dispatchedActionCount = 0;
      e = new goog.events.Event(goog.events.KeyHandler.EventType.KEY, button);
      e.keyCode = goog.events.KeyCodes.SPACE;
      button.handleKeyEvent(e);
      assertEquals('Button must not have dispatched ACTION on Space keypress',
          0, dispatchedActionCount);
      assertEquals('The default action (scrolling) must have been prevented ' +
                   'for Space keypress',
                   false,
                   e.returnValue_);


      dispatchedActionCount = 0;
      e = new goog.events.Event(goog.events.EventType.KEYUP, button);
      e.keyCode = goog.events.KeyCodes.SPACE;
      button.handleKeyEvent(e);
      assertEquals('Button must have dispatched ACTION on Space keyup',
          1, dispatchedActionCount);

      goog.events.unlisten(button, goog.ui.Component.EventType.ACTION,
          handleAction);
    }

    function testEnterFireActionOnKeyPress() {
      var dispatchedActionCount = 0;
      var handleAction = function() {
        dispatchedActionCount++;
      };
      goog.events.listen(button, goog.ui.Component.EventType.ACTION,
          handleAction);

      dispatchedActionCount = 0;
      e = new goog.events.Event(goog.events.KeyHandler.EventType.KEY, button);
      e.keyCode = goog.events.KeyCodes.ENTER;
      button.handleKeyEvent(e);
      assertEquals('Button must have dispatched ACTION on Enter keypress',
          1, dispatchedActionCount);

      dispatchedActionCount = 0;
      e = new goog.events.Event(goog.events.EventType.KEYUP, button);
      e.keyCode = goog.events.KeyCodes.ENTER;
      button.handleKeyEvent(e);
      assertEquals('Button must not have dispatched ACTION on Enter keyup',
          0, dispatchedActionCount);

      goog.events.unlisten(button, goog.ui.Component.EventType.ACTION,
          handleAction);
    }

  ">9 of 9 tests run in 13ms.<br />0 passed, 9 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testBasicButtonBehavior<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testConstructor<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testDisabledButtonBehavior<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testDispose<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testEnterFireActionOnKeyPress<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testGetSetTooltip<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testGetSetValue<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testSetCollapsed<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testSpaceFireActionOnKeyUp<br />Object #<Object> has no method 'cloneNode'<br /></td></tr>
<tr><td>menuitem_test.html</td><td>Fail</td><td> 6 passed, 25 failed.</td><td title="

    goog.require('goog.dom.classes');
    goog.require('goog.dom');
    goog.require('goog.dom.NodeType');
    goog.require('goog.testing.events');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.Component.State');
    goog.require('goog.ui.MenuItem');
    goog.require('goog.ui.MenuItemRenderer');
  

    var sandbox = goog.dom.getElement('sandbox');
    var item;

    function setUp() {
      item = new goog.ui.MenuItem('Item');
    }

    function tearDown() {
      item.dispose();
      goog.dom.removeChildren(sandbox);
    }

    function testMenuItem() {
      assertNotNull('Instance must not be null', item);
      assertEquals('Renderer must default to MenuItemRenderer singleton',
          goog.ui.MenuItemRenderer.getInstance(), item.getRenderer());
      assertEquals('Content must have expected value', 'Item',
          item.getContent());
      assertEquals('Caption must default to the content', item.getContent(),
          item.getCaption());
      assertEquals('Value must default to the caption', item.getCaption(),
          item.getValue());
    }

    function testMenuItemConstructor() {
      var model = 'Hello';
      var fakeDom = {};
      var fakeRenderer = {};

      var menuItem = new goog.ui.MenuItem('Item', model, fakeDom, fakeRenderer);
      assertEquals('Content must have expected value', 'Item',
          menuItem.getContent());
      assertEquals('Caption must default to the content', menuItem.getContent(),
          menuItem.getCaption());
      assertEquals('Model must be set', model, menuItem.getModel());
      assertNotEquals('Value must not equal the caption', menuItem.getCaption(),
          menuItem.getValue());
      assertEquals('Value must equal the model', model, menuItem.getValue());
      assertEquals('DomHelper must be set', fakeDom, menuItem.getDomHelper());
      assertEquals('Renderer must be set', fakeRenderer,
          menuItem.getRenderer());
    }

    function testGetValue() {
      assertUndefined('Model must be undefined by default', item.getModel());
      assertEquals('Without a model, value must default to the caption',
          item.getCaption(), item.getValue());
      item.setModel('Foo');
      assertEquals('With a model, value must default to the model',
          item.getModel(), item.getValue());
    }

    function testSetValue() {
      assertUndefined('Model must be undefined by default', item.getModel());
      assertEquals('Without a model, value must default to the caption',
          item.getCaption(), item.getValue());
      item.setValue(17);
      assertEquals('Value must be set', 17, item.getValue());
      assertEquals('Value and model must be the same', item.getValue(),
          item.getModel());
    }

    function testGetSetContent() {
      assertEquals('Content must have expected value', 'Item',
          item.getContent());
      item.setContent(goog.dom.createDom('div', 'foo', 'Foo'));
      assertEquals('Content must be an element', goog.dom.NodeType.ELEMENT,
          item.getContent().nodeType);
      assertHTMLEquals('Content must be the expected element',
          '<div class="foo">Foo</div>',
          goog.dom.getOuterHtml(item.getContent()));
    }

    function testGetSetCaption() {
      assertEquals('Caption must have expected value', 'Item',
          item.getCaption());
      item.setCaption('Hello, world!');
      assertTrue('Caption must be a string', goog.isString(item.getCaption()));
      assertEquals('Caption must have expected value', 'Hello, world!',
          item.getCaption());
      item.setContent(goog.dom.createDom('div', 'foo', 'Foo'));
      assertTrue('Caption must be a string', goog.isString(item.getCaption()));
      assertEquals('Caption must have expected value', 'Foo',
          item.getCaption());
    }

    function testGetSetContentAfterCreateDom() {
      item.createDom();
      assertEquals('Content must have expected value', 'Item',
          item.getContent());
      item.setContent(goog.dom.createDom('div', 'foo', 'Foo'));
      assertEquals('Content must be an element', goog.dom.NodeType.ELEMENT,
          item.getContent().nodeType);
      assertHTMLEquals('Content must be the expected element',
          '<div class="foo">Foo</div>',
          goog.dom.getOuterHtml(item.getContent()));
    }

    function testGetSetCaptionAfterCreateDom() {
      item.createDom();
      assertEquals('Caption must have expected value', 'Item',
          item.getCaption());
      item.setCaption('Hello, world!');
      assertTrue('Caption must be a string', goog.isString(item.getCaption()));
      assertEquals('Caption must have expected value', 'Hello, world!',
          item.getCaption());
      item.setContent(goog.dom.createDom('div', 'foo', 'Foo'));
      assertTrue('Caption must be a string', goog.isString(item.getCaption()));
      assertEquals('Caption must have expected value', 'Foo',
          item.getCaption());
    }

    function testSetSelectable() {
      assertFalse('Item must not be selectable by default',
          item.isSupportedState(goog.ui.Component.State.SELECTED));
      item.setSelectable(true);
      assertTrue('Item must be selectable',
          item.isSupportedState(goog.ui.Component.State.SELECTED));
      item.setSelected(true);
      assertTrue('Item must be selected', item.isSelected());
      assertFalse('Item must not be checked', item.isChecked());
      item.setSelectable(false);
      assertFalse('Item must not no longer be selectable',
          item.isSupportedState(goog.ui.Component.State.SELECTED));
      assertFalse('Item must no longer be selected', item.isSelected());
      assertFalse('Item must not be checked', item.isChecked());
    }

    function testSetCheckable() {
      assertFalse('Item must not be checkable by default',
          item.isSupportedState(goog.ui.Component.State.CHECKED));
      item.setCheckable(true);
      assertTrue('Item must be checkable',
          item.isSupportedState(goog.ui.Component.State.CHECKED));
      item.setChecked(true);
      assertTrue('Item must be checked', item.isChecked());
      assertFalse('Item must not be selected', item.isSelected());
      item.setCheckable(false);
      assertFalse('Item must not no longer be checkable',
          item.isSupportedState(goog.ui.Component.State.CHECKED));
      assertFalse('Item must no longer be checked', item.isChecked());
      assertFalse('Item must not be selected', item.isSelected());
    }

    function testSetSelectableBeforeCreateDom() {
      item.setSelectable(true);
      item.createDom();
      assertTrue('Item must have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
      item.setSelectable(false);
      assertFalse('Item must no longer have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
    }

    function testSetCheckableBeforeCreateDom() {
      item.setCheckable(true);
      item.createDom();
      assertTrue('Item must have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
      item.setCheckable(false);
      assertFalse('Item must no longer have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
    }

    function testSetSelectableAfterCreateDom() {
      item.createDom();
      item.setSelectable(true);
      assertTrue('Item must have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
      item.setSelectable(false);
      assertFalse('Item must no longer have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
    }

    function testSetCheckableAfterCreateDom() {
      item.createDom();
      item.setCheckable(true);
      assertTrue('Item must have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
      item.setCheckable(false);
      assertFalse('Item must no longer have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
    }

    function testSelectableBehavior() {
      item.setSelectable(true);
      item.render(sandbox);
      assertFalse('Item must not be selected by default', item.isSelected());
      item.performActionInternal();
      assertTrue('Item must be selected', item.isSelected());
      item.performActionInternal();
      assertTrue('Item must still be selected', item.isSelected());
    }

    function testCheckableBehavior() {
      item.setCheckable(true);
      item.render(sandbox);
      assertFalse('Item must not be checked by default', item.isChecked());
      item.performActionInternal();
      assertTrue('Item must be checked', item.isChecked());
      item.performActionInternal();
      assertFalse('Item must no longer be checked', item.isChecked());
    }

    function testGetSetContentForItemWithCheckBox() {
      item.setSelectable(true);
      item.createDom();

      assertTrue('Item must have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
      assertEquals('getContent() must not return the checkbox structure',
          'Item', item.getContent());

      item.setContent('Hello');
      assertEquals('getContent() must not return the checkbox structure',
          'Hello', item.getContent());
      assertTrue('Item must still have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));

      item.setContent(goog.dom.createDom('span', 'foo', 'Foo'));
      assertEquals('getContent() must return element', goog.dom.NodeType.ELEMENT,
          item.getContent().nodeType);
      assertTrue('Item must still have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));

      item.setContent(null);
      assertNull('getContent() must return null', item.getContent());
      assertTrue('Item must still have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
    }

    function testGetSetCaptionForItemWithCheckBox() {
      item.setCheckable(true);
      item.createDom();

      assertTrue('Item must have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
      assertEquals('getCaption() must not return the checkbox structure',
          'Item', item.getCaption());

      item.setCaption('Hello');
      assertEquals('getCaption() must not return the checkbox structure',
          'Hello', item.getCaption());
      assertTrue('Item must still have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));

      item.setContent(goog.dom.createDom('span', 'foo', 'Foo'));
      assertEquals('getCaption() must return text content', 'Foo',
          item.getCaption());
      assertTrue('Item must still have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));

      item.setCaption(null);
      assertNull('getCaption() must return null', item.getCaption());
      assertTrue('Item must still have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
    }

    function testGetSetCaptionForItemWithAccelerators() {
      var contentArr = [];
      contentArr.push(goog.dom.createDom('span',
          goog.getCssName('goog-menuitem-accel'), 'Ctrl+1'));
      contentArr.push(goog.dom.createTextNode('Hello'));
      item.setCaption(contentArr);
      assertEquals('getCaption() must not return the accelerator', 'Hello',
          item.getCaption());

      item.setCaption(null);
      assertNull('getCaption() must return null', item.getCaption());
    }

    function testRender() {
      item.render(sandbox);
      var contentElement = item.getContentElement();
      assertNotNull('Content element must exist', contentElement);
      assertTrue('Content element must have expected class name',
          goog.dom.classes.has(contentElement,
              item.getRenderer().getStructuralCssClass() + '-content'));
      assertHTMLEquals('Content element must have expected structure',
          'Item', contentElement.innerHTML);
    }

    function testRenderSelectableItem() {
      item.setSelectable(true);
      item.render(sandbox);
      assertTrue('Item must have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
      assertEquals('getCaption() return expected value', 'Item',
          item.getCaption());
    }

    function testRenderSelectedItem() {
      item.setSelectable(true);
      item.setSelected(true);
      item.render(sandbox);
      assertTrue('Item must have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
      assertTrue('Item must have selected style',
          goog.dom.classes.has(item.getElement(),
              item.getRenderer().getClassForState(
                  goog.ui.Component.State.SELECTED)));
    }

    function testRenderCheckableItem() {
      item.setCheckable(true);
      item.render(sandbox);
      assertTrue('Item must have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
      assertEquals('getCaption() return expected value', 'Item',
          item.getCaption());
    }

    function testRenderCheckedItem() {
      item.setCheckable(true);
      item.setChecked(true);
      item.render(sandbox);
      assertTrue('Item must have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
      assertTrue('Item must have checked style',
          goog.dom.classes.has(item.getElement(),
              item.getRenderer().getClassForState(
                  goog.ui.Component.State.CHECKED)));
    }

    function testDecorate() {
      sandbox.innerHTML = '<div id="foo">Foo</div>';
      var foo = goog.dom.getElement('foo');
      item.decorate(foo);
      assertEquals('Decorated element must be as expected', foo,
          item.getElement());
      assertTrue('Decorated element must have expected class name',
          goog.dom.classes.has(item.getElement(),
              item.getRenderer().getCssClass()));
      assertEquals('Content element must be the decorated element\'s child',
          item.getContentElement(), item.getElement().firstChild);
      assertHTMLEquals('Content must have expected structure', 'Foo',
          item.getContentElement().innerHTML);
    }

    function testDecorateCheckableItem() {
      sandbox.innerHTML = '<div id="foo" class="goog-option">Foo</div>';
      var foo = goog.dom.getElement('foo');
      item.decorate(foo);
      assertEquals('Decorated element must be as expected', foo,
          item.getElement());
      assertTrue('Decorated element must have expected class name',
          goog.dom.classes.has(item.getElement(),
              item.getRenderer().getCssClass()));
      assertEquals('Content element must be the decorated element\'s child',
          item.getContentElement(), item.getElement().firstChild);
      assertTrue('Item must have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
      assertFalse('Item must not be checked', item.isChecked());
    }

    function testDecorateCheckedItem() {
      sandbox.innerHTML =
          '<div id="foo" class="goog-option goog-option-selected">Foo</div>';
      var foo = goog.dom.getElement('foo');
      item.decorate(foo);
      assertEquals('Decorated element must be as expected', foo,
          item.getElement());
      assertSameElements('Decorated element must have expected class names',
          ['goog-menuitem', 'goog-option', 'goog-option-selected'],
          goog.dom.classes.get(item.getElement()));
      assertEquals('Content element must be the decorated element\'s child',
          item.getContentElement(), item.getElement().firstChild);
      assertTrue('Item must have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
      assertTrue('Item must be checked', item.isChecked());
    }

    function testDecorateTemplate() {
      sandbox.innerHTML = '<div id="foo" class="goog-menuitem">' +
          '<div class="goog-menuitem-content">Foo</div></div>';
      var foo = goog.dom.getElement('foo');
      item.decorate(foo);
      assertEquals('Decorated element must be as expected', foo,
          item.getElement());
      assertTrue('Decorated element must have expected class name',
          goog.dom.classes.has(item.getElement(),
              item.getRenderer().getCssClass()));
      assertEquals('Content element must be the decorated element\'s child',
          item.getContentElement(), item.getElement().firstChild);
      assertHTMLEquals('Content must have expected structure', 'Foo',
          item.getContentElement().innerHTML);
    }

    function testDecorateCheckableItemTemplate() {
      sandbox.innerHTML = '<div id="foo" class="goog-menuitem goog-option">' +
          '<div class="goog-menuitem-content">' +
          '<div class="goog-menuitem-checkbox"></div>' +
          'Foo</div></div>';
      var foo = goog.dom.getElement('foo');
      item.decorate(foo);
      assertEquals('Decorated element must be as expected', foo,
          item.getElement());
      assertTrue('Decorated element must have expected class name',
          goog.dom.classes.has(item.getElement(),
              item.getRenderer().getCssClass()));
      assertEquals('Content element must be the decorated element\'s child',
          item.getContentElement(), item.getElement().firstChild);
      assertTrue('Item must have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
      assertEquals('Item must have exactly one checkbox structure', 1,
          goog.dom.getElementsByTagNameAndClass('div', 'goog-menuitem-checkbox',
              item.getElement()).length);
      assertFalse('Item must not be checked', item.isChecked());
    }

    function testDecorateCheckedItemTemplate() {
      sandbox.innerHTML = '<div id="foo" ' +
          'class="goog-menuitem goog-option goog-option-selected">' +
          '<div class="goog-menuitem-content">' +
          '<div class="goog-menuitem-checkbox"></div>' +
          'Foo</div></div>';
      var foo = goog.dom.getElement('foo');
      item.decorate(foo);
      assertEquals('Decorated element must be as expected', foo,
          item.getElement());
      assertSameElements('Decorated element must have expected class names',
          ['goog-menuitem', 'goog-option', 'goog-option-selected'],
          goog.dom.classes.get(item.getElement()));
      assertEquals('Content element must be the decorated element\'s child',
          item.getContentElement(), item.getElement().firstChild);
      assertTrue('Item must have checkbox structure',
          item.getRenderer().hasCheckBoxStructure(item.getElement()));
      assertEquals('Item must have exactly one checkbox structure', 1,
          goog.dom.getElementsByTagNameAndClass('div', 'goog-menuitem-checkbox',
              item.getElement()).length);
      assertTrue('Item must be checked', item.isChecked());
    }

    /** @bug 1463524 */
    function testHandleMouseUp() {
      var COORDS_1 = new goog.math.Coordinate(1, 1);
      var COORDS_2 = new goog.math.Coordinate(2, 2);
      item.setActive(true);
      // Override performActionInternal() for testing purposes.
      var actionPerformed;
      item.performActionInternal = function() {
        actionPerformed = true;
        return true;
      };
      item.render(sandbox);

      // Scenario 1: item has no parent.
      actionPerformed = false;
      item.setActive(true);
      goog.testing.events.fireMouseUpEvent(item.getElement());
      assertTrue('Action should be performed on mouseup', actionPerformed);

      // Scenario 2: item has a parent.
      actionPerformed = false;
      item.setActive(true);
      var parent = new goog.ui.Component();
      var parentElem = goog.dom.getElement('parentComponent');
      parent.render(parentElem);
      parent.addChild(item);
      parent.openingCoords = COORDS_1;
      goog.testing.events.fireMouseUpEvent(
          item.getElement(), undefined, COORDS_2);
      assertTrue('Action should be performed on mouseup', actionPerformed);

      // Scenario 3: item has a parent which was opened during mousedown, and
      // item, and now the mouseup fires at the same coords.
      actionPerformed = false;
      item.setActive(true);
      parent.openingCoords = COORDS_2;
      goog.testing.events.fireMouseUpEvent(
          item.getElement(), undefined, COORDS_2);
      assertFalse('Action should not be performed on mouseup', actionPerformed);
    }

  ">31 of 31 tests run in 47ms.<br />6 passed, 25 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testCheckableBehavior<br />Object #<Object> has no method 'createElement'<br />ERROR in testDecorate<br />Object #<Object> has no method 'createElement'<br />ERROR in testDecorateCheckableItem<br />Object #<Object> has no method 'createElement'<br />ERROR in testDecorateCheckableItemTemplate<br />Object #<Object> has no method 'createElement'<br />ERROR in testDecorateCheckedItem<br />Object #<Object> has no method 'createElement'<br />ERROR in testDecorateCheckedItemTemplate<br />Object #<Object> has no method 'createElement'<br />ERROR in testDecorateTemplate<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetSetCaption<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetSetCaptionAfterCreateDom<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetSetCaptionForItemWithAccelerators<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetSetCaptionForItemWithCheckBox<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetSetContent<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetSetContentAfterCreateDom<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetSetContentForItemWithCheckBox<br />Object #<Object> has no method 'createElement'<br />ERROR in testHandleMouseUp<br />Object #<Object> has no method 'createElement'<br />ERROR in testRender<br />Object #<Object> has no method 'createElement'<br />ERROR in testRenderCheckableItem<br />Object #<Object> has no method 'createElement'<br />ERROR in testRenderCheckedItem<br />Object #<Object> has no method 'createElement'<br />ERROR in testRenderSelectableItem<br />Object #<Object> has no method 'createElement'<br />ERROR in testRenderSelectedItem<br />Object #<Object> has no method 'createElement'<br />ERROR in testSelectableBehavior<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetCheckableAfterCreateDom<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetCheckableBeforeCreateDom<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetSelectableAfterCreateDom<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetSelectableBeforeCreateDom<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>menuitemrenderer_test.html</td><td>Fail</td><td> 2 passed, 10 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.dom.classes');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.MenuItem');
    goog.require('goog.ui.MenuItemRenderer');
    goog.require('goog.testing.ui.rendererasserts');
  

    var sandbox = goog.dom.getElement('sandbox');
    var item, renderer;

    function setUp() {
      item = new goog.ui.MenuItem('Hello');
      renderer = goog.ui.MenuItemRenderer.getInstance();
    }
    
    function tearDown() {
      item.dispose();
      goog.dom.removeChildren(sandbox);
    }

    function testMenuItemRenderer() {
      assertNotNull('Instance must not be null', renderer);
      assertEquals('Singleton getter must always return same instance',
          renderer, goog.ui.MenuItemRenderer.getInstance());
    }

    function testCreateDom() {
      var element = renderer.createDom(item);
      assertNotNull('Element must not be null', element);
      assertSameElements('Element must have the expected class names',
          ['goog-menuitem'], goog.dom.classes.get(element));
      assertEquals('Element must have exactly one child element', 1,
          element.childNodes.length);
      assertHTMLEquals('Child element must have the expected structure',
          '<div class="goog-menuitem-content">Hello</div>',
          element.innerHTML);
    }

    function testCreateDomWithHoverState() {
      item.setHighlighted(true);
      var element = renderer.createDom(item);
      assertSameElements('Element must have the expected class names',
          ['goog-menuitem', 'goog-menuitem-highlight'],
          goog.dom.classes.get(element));
    }

    function testCreateDomForCheckableItem() {
      item.setSupportedState(goog.ui.Component.State.CHECKED, true);
      var element = renderer.createDom(item);
      assertSameElements('Element must have the expected class names',
          ['goog-menuitem', 'goog-option'],
          goog.dom.classes.get(element));
      assertHTMLEquals('Child element must have the expected structure',
          '<div class="goog-menuitem-content">' +
              '<div class="goog-menuitem-checkbox"></div>Hello</div>',
          element.innerHTML);

      item.setChecked(true);
      element = renderer.createDom(item);
      assertSameElements('Checked item must have the expected class names',
          ['goog-menuitem', 'goog-option', 'goog-option-selected'],
          goog.dom.classes.get(element));
    }

    function testCreateDomForSelectableItem() {
      item.setSupportedState(goog.ui.Component.State.SELECTED, true);
      var element = renderer.createDom(item);
      assertSameElements('Element must have the expected class names',
          ['goog-menuitem', 'goog-option'],
          goog.dom.classes.get(element));
      assertHTMLEquals('Child element must have the expected structure',
          '<div class="goog-menuitem-content">' +
              '<div class="goog-menuitem-checkbox"></div>Hello</div>',
          element.innerHTML);

      item.setSelected(true);
      element = renderer.createDom(item);
      assertSameElements('Selected item must have the expected class names',
          ['goog-menuitem', 'goog-option', 'goog-option-selected'],
          goog.dom.classes.get(element));
    }

    function testGetContentElement() {
      assertNull('Content element must be the null initially',
          item.getContentElement());
      item.createDom();
      assertEquals('Content element must be the element\'s first child',
          item.getElement().firstChild, item.getContentElement());
    }

    function testDecorate() {
      sandbox.innerHTML = '<div id="foo">Hello</div>';
      var foo = goog.dom.getElement('foo');

      var element = renderer.decorate(item, foo);
      assertSameElements('Element must have the expected class names',
          ['goog-menuitem'], goog.dom.classes.get(element));
      assertEquals('Element must have exactly one child element', 1,
          element.childNodes.length);
      assertHTMLEquals('Child element must have the expected structure',
          '<div class="goog-menuitem-content">Hello</div>',
          element.innerHTML);
    }

    function testDecorateWithContentStructure() {
      sandbox.innerHTML =
          '<div id="foo"><div class="goog-menuitem-content">Hello</div></div>';
      var foo = goog.dom.getElement('foo');

      var element = renderer.decorate(item, foo);
      assertSameElements('Element must have the expected class names',
          ['goog-menuitem'], goog.dom.classes.get(element));
      assertEquals('Element must have exactly one child element', 1,
          element.childNodes.length);
      assertHTMLEquals('Child element must have the expected structure',
          '<div class="goog-menuitem-content">Hello</div>',
          element.innerHTML);
    }

    function testDecorateWithHoverState() {
      sandbox.innerHTML =
          '<div id="foo" class="goog-menuitem-highlight">Hello</div>';
      var foo = goog.dom.getElement('foo');

      assertFalse('Item must not be highlighted', item.isHighlighted());
      var element = renderer.decorate(item, foo);
      assertSameElements('Element must have the expected class names',
          ['goog-menuitem', 'goog-menuitem-highlight'],
          goog.dom.classes.get(element));
      assertTrue('Item must be highlighted', item.isHighlighted());
    }

    function testDecorateCheckableItem() {
      sandbox.innerHTML = '<div id="foo" class="goog-option">Hello</div>';
      var foo = goog.dom.getElement('foo');

      assertFalse('Item must not be checkable',
          item.isSupportedState(goog.ui.Component.State.CHECKED));
      var element = renderer.decorate(item, foo);
      assertSameElements('Element must have the expected class names',
          ['goog-menuitem', 'goog-option'], goog.dom.classes.get(element));
      assertTrue('Item must be checkable',
          item.isSupportedState(goog.ui.Component.State.CHECKED));
      assertHTMLEquals('Child element must have the expected structure',
          '<div class="goog-menuitem-content">' +
              '<div class="goog-menuitem-checkbox"></div>Hello</div>',
          element.innerHTML);
    }

    function testSetContent() {
      item.setSupportedState(goog.ui.Component.State.CHECKED, true);
      var element = renderer.createDom(item);
      assertHTMLEquals('Child element must have the expected structure',
          '<div class="goog-menuitem-content">' +
              '<div class="goog-menuitem-checkbox"></div>Hello</div>',
          element.innerHTML);

      renderer.setContent(element, 'Goodbye');
      assertHTMLEquals('Child element must have the expected structure',
          '<div class="goog-menuitem-content">' +
              '<div class="goog-menuitem-checkbox"></div>Goodbye</div>',
          element.innerHTML);
    }

    function testDoesntCallGetCssClassInConstructor() {
      goog.testing.ui.rendererasserts.
          assertNoGetCssClassCallsInConstructor(goog.ui.MenuItemRenderer);
    }
  ">12 of 12 tests run in 16ms.<br />2 passed, 10 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testCreateDom<br />Object #<Object> has no method 'createElement'<br />ERROR in testCreateDomForCheckableItem<br />Object #<Object> has no method 'createElement'<br />ERROR in testCreateDomForSelectableItem<br />Object #<Object> has no method 'createElement'<br />ERROR in testCreateDomWithHoverState<br />Object #<Object> has no method 'createElement'<br />ERROR in testDecorate<br />Object #<Object> has no method 'createElement'<br />ERROR in testDecorateCheckableItem<br />Object #<Object> has no method 'createElement'<br />ERROR in testDecorateWithContentStructure<br />Object #<Object> has no method 'createElement'<br />ERROR in testDecorateWithHoverState<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetContentElement<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetContent<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>control_test.html</td><td>Fail</td><td> undefined</td><td title="

    goog.require('goog.dom');
    goog.require('goog.dom.classes');
    goog.require('goog.events');
    goog.require('goog.events.KeyCodes');
    goog.require('goog.events.BrowserEvent.MouseButton');
    goog.require('goog.object');
    goog.require('goog.style');
    goog.require('goog.testing.ExpectedFailures');
    goog.require('goog.testing.events');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.Component.EventType');
    goog.require('goog.ui.Component.State');
    goog.require('goog.ui.Control');
    goog.require('goog.ui.ControlRenderer');
    goog.require('goog.ui.registry');
    goog.require('goog.userAgent');
  


    // Disabled due to problems on farm.
    var testFocus = false;

    var control;

    var ALL_EVENTS = goog.object.getValues(goog.ui.Component.EventType);
    var events = {};
    var expectedFailures = new goog.testing.ExpectedFailures();
    var sandbox = document.getElementById('sandbox');

    /**
     * A dummy renderer, for testing purposes.
     * @constructor
     * @extends {goog.ui.ControlRenderer}
     */
    function TestRenderer() {
      goog.ui.ControlRenderer.call(this);
    }
    goog.inherits(TestRenderer, goog.ui.ControlRenderer);

    /**
     * Initializes the testcase prior to execution.
     */
    function setUp() {
      control = new goog.ui.Control('Hello');
      control.setDispatchTransitionEvents(goog.ui.Component.State.ALL, true);
      goog.events.listen(control, ALL_EVENTS, countEvent);
    }

    /**
     * Cleans up after executing the testcase.
     */
    function tearDown() {
      control.dispose();
      expectedFailures.handleTearDown();
      goog.dom.removeChildren(sandbox);
      goog.events.removeAll();
      resetEventCount();
    }

    /**
     * Resets the global counter for events dispatched by test objects.
     */
    function resetEventCount() {
      goog.object.clear(events);
    }

    /**
     * Increments the global counter for events of this type.
     * @param {goog.events.Event} e Event to count.
     */
    function countEvent(e) {
      var type = e.type;
      var target = e.target;

      if (!events[target]) {
        events[target] = {};
      }

      if (events[target][type]) {
        events[target][type]++;
      } else {
        events[target][type] = 1;
      }
    }

    /**
     * Returns the number of times test objects dispatched events of the given
     * type since the global counter was last reset.
     * @param {goog.ui.Control} target Event target.
     * @param {string} type Event type.
     * @return {number} Number of events of this type.
     */
    function getEventCount(target, type) {
      return events[target] && events[target][type] || 0;
    }

    /**
     * Returns true if no events were dispatched since the last reset.
     * @return {boolean} Whether no events have been dispatched since the last
     *     reset.
     */
    function noEventsDispatched() {
      return !events || goog.object.isEmpty(events);
    }

    /**
     * Returns the number of event listeners created by the control.
     * @param {goog.ui.Control} control Control whose event listers are to be
     *     counted.
     * @return {number} Number of event listeners.
     */
    function getListenerCount(control) {
      return control.googUiComponentHandler_ ?
          goog.object.getCount(control.getHandler().keys_) : 0;
    }

    /**
     * Simulates a mousedown event on the given element, including focusing it.
     * @param {Element} element Element on which to simulate mousedown.
     * @param {goog.events.BrowserEvent.MouseButton=} opt_button Mouse button;
     *     defaults to {@code goog.events.BrowserEvent.MouseButton.LEFT}.
     * @return {boolean} Whether the event was allowed to proceed.
     */
    function fireMouseDownAndFocus(element, opt_button) {
      var result = goog.testing.events.fireMouseDownEvent(element, opt_button);
      if (result) {
        // Browsers move focus for all buttons, not just the left button.
        element.focus();
      }
      return result;
    }


    /**
     * @return {boolean} Whether we're on Mac Safari 3.x.
     */
    function isMacSafari3() {
      return goog.userAgent.WEBKIT && goog.userAgent.MAC &&
          !goog.userAgent.isVersion('527');
    }

    /**
     * Tests the {@link goog.ui.Control} constructor.
     */
    function testConstructor() {
      assertNotNull('Constructed control must not be null', control);
      assertEquals('Content must have expected value', 'Hello',
          control.getContent());
      assertEquals('Renderer must default to the registered renderer',
          goog.ui.registry.getDefaultRenderer(goog.ui.Control),
          control.getRenderer());

      var content = goog.dom.createDom('div', null, 'Hello',
          goog.dom.createDom('b', null, 'World'));
      var testRenderer = new TestRenderer();
      var fakeDomHelper = {};
      var foo = new goog.ui.Control(content, testRenderer, fakeDomHelper);
      assertNotNull('Constructed object must not be null', foo);
      assertEquals('Content must have expected value', content,
          foo.getContent());
      assertEquals('Renderer must have expected value', testRenderer,
          foo.getRenderer());
      assertEquals('DOM helper must have expected value', fakeDomHelper,
          foo.getDomHelper());
      foo.dispose();
    }

    /**
     * Tests {@link goog.ui.Control#getHandler}.
     */
    function testGetHandler() {
      assertUndefined('Event handler must be undefined before getHandler() ' +
          'is called', control.googUiComponentHandler_);
      var handler = control.getHandler();
      assertNotNull('Event handler must not be null', handler);
      assertEquals('getHandler() must return the same instance if called again',
          handler, control.getHandler());
    }

    /**
     * Tests {@link goog.ui.Control#isHandleMouseEvents}.
     */
    function testIsHandleMouseEvents() {
      assertTrue('Controls must handle their own mouse events by default',
          control.isHandleMouseEvents());
    }

    /**
     * Tests {@link goog.ui.Control#setHandleMouseEvents}.
     */
    function testSetHandleMouseEvents() {
      assertTrue('Control must handle its own mouse events by default',
          control.isHandleMouseEvents());
      control.setHandleMouseEvents(false);
      assertFalse('Control must no longer handle its own mouse events',
          control.isHandleMouseEvents());
      control.setHandleMouseEvents(true);
      assertTrue('Control must once again handle its own mouse events',
          control.isHandleMouseEvents());
      control.render(sandbox);
      assertTrue('Rendered control must handle its own mouse events',
          control.isHandleMouseEvents());
      control.setHandleMouseEvents(false);
      assertFalse('Rendered control must no longer handle its own mouse events',
          control.isHandleMouseEvents());
      control.setHandleMouseEvents(true);
      assertTrue('Rendered control must once again handle its own mouse events',
          control.isHandleMouseEvents());
    }

    /**
     * Tests {@link goog.ui.Control#getKeyEventTarget}.
     */
    function testGetKeyEventTarget() {
      assertNull('Key event target of control without DOM must be null',
          control.getKeyEventTarget());
      control.createDom();
      assertEquals('Key event target of control with DOM must be its element',
          control.getElement(), control.getKeyEventTarget());
    }

    /**
     * Tests {@link goog.ui.Control#getKeyHandler}.
     */
    function testGetKeyHandler() {
      assertUndefined('Key handler must be undefined before getKeyHandler() ' +
          'is called', control.keyHandler_);
      var keyHandler = control.getKeyHandler();
      assertNotNull('Key handler must not be null', keyHandler);
      assertEquals('getKeyHandler() must return the same instance if called ' +
          'again', keyHandler, control.getKeyHandler());
    }

    /**
     * Tests {@link goog.ui.Control#getRenderer}.
     */
    function testGetRenderer() {
      assertEquals('Renderer must be the default registered renderer',
          goog.ui.registry.getDefaultRenderer(goog.ui.Control),
          control.getRenderer());
    }

    /**
     * Tests {@link goog.ui.Control#setRenderer}.
     */
    function testSetRenderer() {
      control.createDom();
      assertNotNull('Control must have a DOM', control.getElement());
      assertFalse('Control must not be in the document',
          control.isInDocument());
      assertEquals('Renderer must be the default registered renderer',
          goog.ui.registry.getDefaultRenderer(goog.ui.Control),
          control.getRenderer());

      var testRenderer = new TestRenderer();
      control.setRenderer(testRenderer);
      assertNull('Control must not have a DOM after its renderer is reset',
          control.getElement());
      assertFalse('Control still must not be in the document',
          control.isInDocument());
      assertEquals('Renderer must have expected value', testRenderer,
          control.getRenderer());

      control.render(sandbox);
      assertTrue('Control must be in the document', control.isInDocument());

      assertThrows('Resetting the renderer after the control has entered ' +
          'the document must throw error',
          function() {
            control.setRenderer({});
          });
    }

    /**
     * Tests {@link goog.ui.Control#getExtraClassNames}.
     */
    function testGetExtraClassNames() {
      assertNull('Control must not have any extra class names by default',
          control.getExtraClassNames());
    }

    /**
      * Tests {@link goog.ui.Control#addExtraClassName} and
      * {@link goog.ui.Control#removeExtraClassName}.
      */
    function testAddRemoveClassName() {
      assertNull('Control must not have any extra class names by default',
          control.getExtraClassNames());
      control.addClassName('foo');
      assertArrayEquals('Control must have expected extra class names',
          ['foo'], control.getExtraClassNames());
      assertNull('Control must not have a DOM', control.getElement());

      control.createDom();
      assertSameElements('Control\'s element must have expected class names',
          ['goog-control', 'foo'],
          goog.dom.classes.get(control.getElement()));

      control.addClassName('bar');
      assertArrayEquals('Control must have expected extra class names',
          ['foo', 'bar'], control.getExtraClassNames());
      assertSameElements('Control\'s element must have expected class names',
          ['goog-control', 'foo', 'bar'],
          goog.dom.classes.get(control.getElement()));

      control.addClassName('bar');
      assertArrayEquals('Adding the same class name again must be a no-op',
          ['foo', 'bar'], control.getExtraClassNames());
      assertSameElements('Adding the same class name again must be a no-op',
          ['goog-control', 'foo', 'bar'],
          goog.dom.classes.get(control.getElement()));

      control.addClassName(null);
      assertArrayEquals('Adding null class name must be a no-op',
          ['foo', 'bar'], control.getExtraClassNames());
      assertSameElements('Adding null class name must be a no-op',
          ['goog-control', 'foo', 'bar'],
          goog.dom.classes.get(control.getElement()));

      control.removeClassName(null);
      assertArrayEquals('Removing null class name must be a no-op',
          ['foo', 'bar'], control.getExtraClassNames());
      assertSameElements('Removing null class name must be a no-op',
          ['goog-control', 'foo', 'bar'],
          goog.dom.classes.get(control.getElement()));

      control.removeClassName('foo');
      assertArrayEquals('Control must have expected extra class names',
          ['bar'], control.getExtraClassNames());
      assertSameElements('Control\'s element must have expected class names',
          ['goog-control', 'bar'],
          goog.dom.classes.get(control.getElement()));

      control.removeClassName('bar');
      assertNull('Control must not have any extra class names',
          control.getExtraClassNames());
      assertSameElements('Control\'s element must have expected class names',
          ['goog-control'],
          goog.dom.classes.get(control.getElement()));
    }

    /**
     * Tests {@link goog.ui.Control#enableClassName}.
     */
    function testEnableClassName() {
      assertNull('Control must not have any extra class names by default',
          control.getExtraClassNames());

      control.enableClassName('foo', true);
      assertArrayEquals('Control must have expected extra class names',
          ['foo'], control.getExtraClassNames());

      control.enableClassName('bar', true);
      assertArrayEquals('Control must have expected extra class names',
          ['foo', 'bar'], control.getExtraClassNames());

      control.enableClassName('bar', true);
      assertArrayEquals('Enabling the same class name again must be a no-op',
          ['foo', 'bar'], control.getExtraClassNames());

      control.enableClassName(null);
      assertArrayEquals('Enabling null class name must be a no-op',
          ['foo', 'bar'], control.getExtraClassNames());

      control.enableClassName('foo', false);
      assertArrayEquals('Control must have expected extra class names',
          ['bar'], control.getExtraClassNames());

      control.enableClassName('bar', false);
      assertNull('Control must not have any extra class names',
          control.getExtraClassNames());
    }

    /**
     * Tests {@link goog.ui.Control#createDom}.
     */
    function testCreateDom() {
      assertNull('Control must not have a DOM by default',
          control.getElement());
      assertFalse('Control must not allow text selection by default',
          control.isAllowTextSelection());
      assertTrue('Control must be visible by default', control.isVisible());

      control.createDom();
      assertNotNull('Control must have a DOM', control.getElement());
      assertTrue('Control\'s element must be unselectable',
          goog.style.isUnselectable(control.getElement()));
      assertTrue('Control\'s element must be visible',
          control.getElement().style.display != 'none');

      control.setAllowTextSelection(true);
      control.createDom();
      assertFalse('Control\'s element must be selectable',
          goog.style.isUnselectable(control.getElement()));

      control.setVisible(false);
      control.createDom();
      assertTrue('Control\'s element must be hidden',
          control.getElement().style.display == 'none');
    }

    /**
     * Tests {@link goog.ui.Control#getContentElement}.
     */
    function testGetContentElement() {
      assertNull('Unrendered control must not have a content element',
          control.getContentElement());
      control.createDom();
      assertEquals('Control\'s content element must equal its root element',
          control.getElement(), control.getContentElement());
    }

    /**
     * Tests {@link goog.ui.Control#canDecorate}.
     */
    function testCanDecorate() {
      assertTrue(control.canDecorate(goog.dom.createElement('div')));
    }

    /**
     * Tests {@link goog.ui.Control#decorateInternal}.
     */
    function testDecorateInternal() {
      sandbox.innerHTML = '<div id="foo">Hello, <b>World</b>!</div>';
      var foo = goog.dom.getElement('foo');
      control.decorate(foo);
      assertEquals('Decorated control\'s element must have expected value',
          foo, control.getElement());
      assertTrue('Element must be unselectable',
          goog.style.isUnselectable(control.getElement()));
      assertTrue('Element must be visible',
          control.getElement().style.display != 'none');
    }

    /**
     * Tests {@link goog.ui.Control#decorateInternal} with a control that
     * allows text selection.
     */
    function testDecorateInternalForSelectableControl() {
      sandbox.innerHTML = '<div id="foo">Hello, <b>World</b>!</div>';
      var foo = goog.dom.getElement('foo');
      control.setAllowTextSelection(true);
      control.decorate(foo);
      assertEquals('Decorated control\'s element must have expected value',
          foo, control.getElement());
      assertFalse('Element must be selectable',
          goog.style.isUnselectable(control.getElement()));
      assertTrue('Control must be visible', control.isVisible());
    }

    /**
     * Tests {@link goog.ui.Control#decorateInternal} with a hidden element.
     */
    function testDecorateInternalForHiddenElement() {
      sandbox.innerHTML = '<div id="foo" style="display:none">Hello!</div>';
      var foo = goog.dom.getElement('foo');
      control.decorate(foo);
      assertEquals('Decorated control\'s element must have expected value',
          foo, control.getElement());
      assertTrue('Element must be unselectable',
          goog.style.isUnselectable(control.getElement()));
      assertFalse('Control must be hidden', control.isVisible());
    }

    /**
     * Tests {@link goog.ui.Control#enterDocument}.
     */
    function testEnterDocument() {
      control.render(sandbox);
      assertTrue('Control must be in the document', control.isInDocument());
      if (goog.userAgent.IE) {
        assertEquals('Control must have 5 mouse & 3 key event listeners on IE',
            8, getListenerCount(control));
      } else {
        assertEquals('Control must have 4 mouse and 3 key event listeners', 7,
            getListenerCount(control));
      }
      assertEquals('Control\'s key event handler must be attached to its ' +
          'key event target', control.getKeyEventTarget(),
          control.getKeyHandler().element_);
    }

    /**
     * Tests {@link goog.ui.Control#enterDocument} for a control that doesn't
     * handle mouse events.
     */
    function testEnterDocumentForControlWithoutMouseHandling() {
      control.setHandleMouseEvents(false);
      control.render(sandbox);
      assertTrue('Control must be in the document', control.isInDocument());
      assertEquals('Control must have 3 key event listeners', 3,
          getListenerCount(control));
      assertEquals('Control\'s key event handler must be attached to its ' +
          'key event target', control.getKeyEventTarget(),
          control.getKeyHandler().element_);
    }

    /**
     * Tests {@link goog.ui.Control#enterDocument} for a control that isn't
     * focusable.
     */
    function testEnterDocumentForNonFocusableControl() {
      control.setSupportedState(goog.ui.Component.State.FOCUSED, false);
      control.render(sandbox);
      assertTrue('Control must be in the document', control.isInDocument());
      if (goog.userAgent.IE) {
        assertEquals('Control must have 5 mouse event listeners on IE', 5,
            getListenerCount(control));
      } else {
        assertEquals('Control must have 4 mouse event listeners', 4,
            getListenerCount(control));
      }
      assertUndefined('Control must not have a key event handler',
          control.keyHandler_);
    }

    /**
     * Tests {@link goog.ui.Control#enterDocument} for a control that doesn't
     * need to do any event handling.
     */
    function testEnterDocumentForControlWithoutEventHandlers() {
      control.setHandleMouseEvents(false);
      control.setSupportedState(goog.ui.Component.State.FOCUSED, false);
      control.render(sandbox);
      assertTrue('Control must be in the document', control.isInDocument());
      assertEquals('Control must have 0 event listeners', 0,
          getListenerCount(control));
      assertUndefined('Control must not have an event handler',
          control.googUiComponentHandler_);
      assertUndefined('Control must not have a key event handler',
          control.keyHandler_);
    }

    /**
     * Tests {@link goog.ui.Control#exitDocument}.
     */
    function testExitDocument() {
      control.render(sandbox);
      assertTrue('Control must be in the document', control.isInDocument());
      if (goog.userAgent.IE) {
        assertEquals('Control must have 5 mouse & 3 key event listeners on IE',
            8, getListenerCount(control));
      } else {
        assertEquals('Control must have 4 mouse and 3 key event listeners', 7,
            getListenerCount(control));
      }
      assertEquals('Control\'s key event handler must be attached to its ' +
          'key event target', control.getKeyEventTarget(),
          control.getKeyHandler().element_);
      // Expected to fail on Mac Safari prior to version 527.
      expectedFailures.expectFailureFor(isMacSafari3());
      try {
        assertTrue('Control\'s element must support keyboard focus',
            goog.dom.isFocusableTabIndex(control.getKeyEventTarget()));
      } catch (e) {
        expectedFailures.handleException(e);
      }

      control.exitDocument();
      assertFalse('Control must no longer be in the document',
          control.isInDocument());
      assertEquals('Control must have no event listeners', 0,
          getListenerCount(control));
      assertNull('Control\'s key event handler must be unattached',
          control.getKeyHandler().element_);
      assertFalse('Control\'s element must no longer support keyboard focus',
          goog.dom.isFocusableTabIndex(control.getKeyEventTarget()));
    }

    /**
     * Tests {@link goog.ui.Control#dispose}.
     */
    function testDispose() {
      control.render(sandbox);
      var handler = control.getHandler();
      var keyHandler = control.getKeyHandler();
      control.dispose();
      assertFalse('Control must no longer be in the document',
          control.isInDocument());
      assertTrue('Control must have been disposed of', control.isDisposed());
      assertUndefined('Renderer must have been deleted', control.getRenderer());
      assertNull('Content must be nulled out', control.getContent());
      assertTrue('Event handler must have been disposed of',
          handler.isDisposed());
      assertUndefined('Event handler must have been deleted',
          control.googUiComponentHandler_);
      assertTrue('Key handler must have been disposed of',
          keyHandler.isDisposed());
      assertUndefined('Key handler must have been deleted', control.keyHandler_);
      assertNull('Extra class names must have been nulled out',
          control.getExtraClassNames());
    }

    /**
     * Tests {@link goog.ui.Control#getContent}.
     */
    function testGetContent() {
      assertNull('Empty control must have null content',
          (new goog.ui.Control(null)).getContent());
      assertEquals('Control must have expected content', 'Hello',
          control.getContent());
      control.render(sandbox);
      assertEquals('Control must have expected content after rendering',
          'Hello', control.getContent());
    }


    /**
     * Tests {@link goog.ui.Control#getContent}.
     */
    function testGetContentForDecoratedControl() {
      sandbox.innerHTML =
          '<div id="empty"></div>\n' +
          '<div id="text">Hello, world!</div>\n' +
          '<div id="element"><span>Foo</span></div>\n' +
          '<div id="nodelist">Hello, <b>world</b>!</div>\n';

      var empty = new goog.ui.Control(null);
      empty.decorate(goog.dom.getElement('empty'));
      assertNull('Content of control decorating empty DIV must be null',
          empty.getContent());
      empty.dispose();

      var text = new goog.ui.Control(null);
      text.decorate(goog.dom.getElement('text'));
      assertEquals('Content of control decorating DIV with text contents ' +
          'must be as expected', 'Hello, world!', text.getContent().nodeValue);
      text.dispose();

      var element = new goog.ui.Control(null);
      element.decorate(goog.dom.getElement('element'));
      assertEquals('Content of control decorating DIV with element child ' +
          'must be as expected', goog.dom.getElement('element').firstChild,
          element.getContent());
      element.dispose();

      var nodelist = new goog.ui.Control(null);
      nodelist.decorate(goog.dom.getElement('nodelist'));
      assertSameElements('Content of control decorating DIV with mixed ' +
          'contents must be as expected',
          goog.dom.getElement('nodelist').childNodes, nodelist.getContent());
      nodelist.dispose();
    }

    /**
     * Tests {@link goog.ui.Control#setContent}.
     */
    function testSetContent() {
      control.setContent('Bye');
      assertEquals('Unrendered control control must have expected contents',
          'Bye', control.getContent());
      assertNull('No DOM must be created by setContent', control.getElement());

      control.createDom();
      assertEquals('Rendered control\'s DOM must have expected contents',
          'Bye', control.getElement().innerHTML);

      control.setContent(null);
      assertNull('Rendered control must have expected contents',
          control.getContent());
      assertEquals('Rendered control\'s DOM must have expected contents',
          '', control.getElement().innerHTML);

      control.setContent([goog.dom.createDom('div', null,
          goog.dom.createDom('span', null, 'Hello')), 'World']);
      assertHTMLEquals('Control\'s DOM must be updated',
          '<div><span>Hello</span></div>World', control.getElement().innerHTML);
    }

    /**
     * Tests {@link goog.ui.Control#setContentInternal}.
     */
    function testSetContentInternal() {
      control.render(sandbox);
      assertEquals('Control must have expected content after rendering',
          'Hello', control.getContent());
      control.setContentInternal('Bye');
      assertEquals('Control must have expected contents',
          'Bye', control.getContent());
      assertEquals('Control\'s DOM must be unchanged', 'Hello',
          control.getElement().innerHTML);
    }

    /**
     * Tests {@link goog.ui.Control#getCaption}.
     */
    function testGetCaption() {
      assertNull('Empty control\'s caption must be null',
          (new goog.ui.Control(null)).getCaption());

      assertEquals('Caption must have expected value', 'Hello',
          control.getCaption());

      sandbox.innerHTML = '<div id="nodelist">Hello, <b>world</b>!</div>';
      control.decorate(goog.dom.getElement('nodelist'));
      assertEquals('Caption must have expected value', 'Hello, world!',
          control.getCaption());
    }

    /**
     * Tests {@link goog.ui.Control#setCaption}.
     */
    function testSetCaption() {
      control.setCaption('Hello, world!');
      assertEquals('Control must have a string caption "Hello, world!"',
          'Hello, world!', control.getCaption());
    }

    /**
     * Tests {@link goog.ui.Control#setRightToLeft}.
     */
    function testSetRightToLeft() {
      control.createDom();
      assertFalse('Control\'s element must not have right-to-left class',
          goog.dom.classes.has(control.getElement(), 'goog-control-rtl'));
      control.setRightToLeft(true);
      assertTrue('Control\'s element must have right-to-left class',
          goog.dom.classes.has(control.getElement(), 'goog-control-rtl'));
      control.render(sandbox);
      assertThrows('Changing the render direction of a control already in ' +
          'the document is an error',
          function() {
            control.setRightToLeft(false);
          });
    }

    /**
     * Tests {@link goog.ui.Control#isAllowTextSelection}.
     */
    function testIsAllowTextSelection() {
      assertFalse('Controls must not allow text selection by default',
          control.isAllowTextSelection());
    }

    /**
     * Tests {@link goog.ui.Control#setAllowTextSelection}.
     */
    function testSetAllowTextSelection() {
      assertFalse('Controls must not allow text selection by default',
          control.isAllowTextSelection());

      control.setAllowTextSelection(true);
      assertTrue('Control must allow text selection',
          control.isAllowTextSelection());

      control.setAllowTextSelection(false);
      assertFalse('Control must no longer allow text selection',
          control.isAllowTextSelection());

      control.render(sandbox);

      assertFalse('Control must not allow text selection even after rendered',
          control.isAllowTextSelection());

      control.setAllowTextSelection(true);
      assertTrue('Control must once again allow text selection',
          control.isAllowTextSelection());
    }

    /**
     * Tests {@link goog.ui.Control#isVisible}.
     */
    function testIsVisible() {
      assertTrue('Controls must be visible by default', control.isVisible());
    }

    /**
     * Tests {@link goog.ui.Control#setVisible} before it is rendered.
     */
    function testSetVisible() {
      assertFalse('setVisible(true) must return false if already visible',
          control.setVisible(true));
      assertTrue('No events must have been dispatched', noEventsDispatched());

      assertTrue('setVisible(false) must return true if previously visible',
          control.setVisible(false));
      assertEquals('One HIDE event must have been dispatched',
          1, getEventCount(control, goog.ui.Component.EventType.HIDE));
      assertFalse('Control must no longer be visible', control.isVisible());

      assertTrue('setVisible(true) must return true if previously hidden',
          control.setVisible(true));
      assertEquals('One SHOW event must have been dispatched',
          1, getEventCount(control, goog.ui.Component.EventType.SHOW));
      assertTrue('Control must be visible', control.isVisible());
    }

    /**
     * Tests {@link goog.ui.Control#setVisible} after it is rendered.
     */
    function testSetVisibleForRenderedControl() {
      control.render(sandbox);
      assertTrue('No events must have been dispatched during rendering',
          noEventsDispatched());

      assertFalse('setVisible(true) must return false if already visible',
          control.setVisible(true));
      assertTrue('No events must have been dispatched', noEventsDispatched());
      assertTrue('Control\'s element must be visible',
          control.getElement().style.display != 'none');

      assertTrue('setVisible(false) must return true if previously visible',
          control.setVisible(false));
      assertEquals('One HIDE event must have been dispatched',
          1, getEventCount(control, goog.ui.Component.EventType.HIDE));
      assertFalse('Control must no longer be visible', control.isVisible());
      assertTrue('Control\'s element must be hidden',
          control.getElement().style.display == 'none');

      assertTrue('setVisible(true) must return true if previously hidden',
          control.setVisible(true));
      assertEquals('One SHOW event must have been dispatched',
          1, getEventCount(control, goog.ui.Component.EventType.SHOW));
      assertTrue('Control must be visible', control.isVisible());
      assertTrue('Control\'s element must be visible',
          control.getElement().style.display != 'none');
    }

    /**
     * Tests {@link goog.ui.Control#setVisible} for disabled non-focusable
     * controls.
     */
    function testSetVisibleForDisabledNonFocusableControl() {
      // Hidden, disabled, non-focusable control becoming visible.
      control.setEnabled(false);
      control.setSupportedState(goog.ui.Component.State.FOCUSED, false);
      control.render(sandbox);
      assertTrue('Control must be visible', control.isVisible());
      assertFalse('Control must not have a tab index',
          goog.dom.isFocusableTabIndex(control.getKeyEventTarget()));

      // Visible, disabled, non-focusable control becoming hidden.
      control.getKeyEventTarget().focus();
      assertEquals('Control must not have dispatched FOCUS', 0,
          getEventCount(control, goog.ui.Component.EventType.FOCUS));
      assertFalse('Control must not have keyboard focus', control.isFocused());
      control.setVisible(false);
      assertFalse('Control must be hidden', control.isVisible());
      assertFalse('Control must not have a tab index',
          goog.dom.isFocusableTabIndex(control.getKeyEventTarget()));
      assertEquals('Control must have dispatched HIDE', 1,
          getEventCount(control, goog.ui.Component.EventType.HIDE));
      assertEquals('Control must not have dispatched BLUR', 0,
          getEventCount(control, goog.ui.Component.EventType.BLUR));
    }

    /**
     * Tests {@link goog.ui.Control#setVisible} for disabled focusable controls.
     */
    function testSetVisibleForDisabledFocusableControl() {
      // Hidden, disabled, focusable control becoming visible.
      control.setEnabled(false);
      control.setSupportedState(goog.ui.Component.State.FOCUSED, true);
      control.render(sandbox);
      assertTrue('Control must be visible', control.isVisible());
      assertFalse('Control must not have a tab index',
          goog.dom.isFocusableTabIndex(control.getKeyEventTarget()));

      // Visible, disabled, focusable control becoming hidden.
      control.getKeyEventTarget().focus();
      assertEquals('Control must not have dispatched FOCUS', 0,
          getEventCount(control, goog.ui.Component.EventType.FOCUS));
      assertFalse('Control must not have keyboard focus', control.isFocused());
      control.setVisible(false);
      assertFalse('Control must be hidden', control.isVisible());
      assertFalse('Control must not have a tab index',
          goog.dom.isFocusableTabIndex(control.getKeyEventTarget()));
      assertEquals('Control must have dispatched HIDE', 1,
          getEventCount(control, goog.ui.Component.EventType.HIDE));
      assertEquals('Control must not have dispatched BLUR', 0,
          getEventCount(control, goog.ui.Component.EventType.BLUR));
    }

    /**
     * Tests {@link goog.ui.Control#setVisible} for enabled non-focusable
     * controls.
     */
    function testSetVisibleForEnabledNonFocusableControl() {
      // Hidden, enabled, non-focusable control becoming visible.
      control.setEnabled(true);
      control.setSupportedState(goog.ui.Component.State.FOCUSED, false);
      control.render(sandbox);
      assertTrue('Control must be visible', control.isVisible());
      assertFalse('Control must not have a tab index',
          goog.dom.isFocusableTabIndex(control.getKeyEventTarget()));

      if (testFocus) {
        // Visible, enabled, non-focusable control becoming hidden.
        control.getKeyEventTarget().focus();
        assertEquals('Control must not have dispatched FOCUS', 0,
            getEventCount(control, goog.ui.Component.EventType.FOCUS));
        assertFalse('Control must not have keyboard focus', control.isFocused());
        control.setVisible(false);
        assertFalse('Control must be hidden', control.isVisible());
        assertFalse('Control must not have a tab index',
            goog.dom.isFocusableTabIndex(control.getKeyEventTarget()));
        assertEquals('Control must have dispatched HIDE', 1,
            getEventCount(control, goog.ui.Component.EventType.HIDE));
        assertEquals('Control must not have dispatched BLUR', 0,
          getEventCount(control, goog.ui.Component.EventType.BLUR));
      }
    }

    /**
     * Tests {@link goog.ui.Control#setVisible} for enabled focusable controls.
     */
    function testSetVisibleForEnabledFocusableControl() {
      // Hidden, enabled, focusable control becoming visible.
      control.setEnabled(true);
      control.setSupportedState(goog.ui.Component.State.FOCUSED, true);
      control.render(sandbox);
      assertTrue('Control must be visible', control.isVisible());

      if (testFocus) {
        // Expected to fail on Mac Safari prior to version 527.
        expectedFailures.expectFailureFor(isMacSafari3());
        try {
          // Mac Safari currently doesn't support tabIndex on arbitrary elements.
          assertTrue('Control must have a tab index',
              goog.dom.isFocusableTabIndex(control.getKeyEventTarget()));
        } catch (e) {
          expectedFailures.handleException(e);
        }

        // Visible, enabled, focusable control becoming hidden.
        control.getKeyEventTarget().focus();

        // Expected to fail on IE.
        expectedFailures.expectFailureFor(goog.userAgent.IE);
        try {
          // IE dispatches focus and blur events asynchronously!
          assertEquals('Control must have dispatched FOCUS', 1,
              getEventCount(control, goog.ui.Component.EventType.FOCUS));
          assertTrue('Control must have keyboard focus', control.isFocused());
        } catch (e) {
          expectedFailures.handleException(e);
        }

        control.setVisible(false);
        assertFalse('Control must be hidden', control.isVisible());
        assertFalse('Control must not have a tab index',
            goog.dom.isFocusableTabIndex(control.getKeyEventTarget()));
        assertEquals('Control must have dispatched HIDE', 1,
            getEventCount(control, goog.ui.Component.EventType.HIDE));

        // Expected to fail on IE.
        expectedFailures.expectFailureFor(goog.userAgent.IE);
        try {
          // IE dispatches focus and blur events asynchronously!
          assertEquals('Control must have dispatched BLUR', 1,
              getEventCount(control, goog.ui.Component.EventType.BLUR));
          assertFalse('Control must no longer have keyboard focus',
              control.isFocused());
        } catch (e) {
          expectedFailures.handleException(e);
        }
      }
    }

    /**
     * Tests {@link goog.ui.Control#isEnabled}.
     */
    function testIsEnabled() {
      assertTrue('Controls must be enabled by default', control.isEnabled());
    }

    /**
     * Tests {@link goog.ui.Control#setEnabled}.
     */
    function testSetEnabled() {
      control.render(sandbox);
      control.setHighlighted(true);
      control.setActive(true);
      control.getKeyEventTarget().focus();

      resetEventCount();

      control.setEnabled(true);
      assertTrue('No events must have been dispatched', noEventsDispatched());
      assertTrue('Control must be enabled', control.isEnabled());
      assertTrue('Control must be highlighted', control.isHighlighted());
      assertTrue('Control must be active', control.isActive());

      if (testFocus) {
        // Expected to fail on IE and Mac Safari 3.  IE calls focus handlers
        // asynchronously, and Mac Safari 3 doesn't support keyboard focus.
        expectedFailures.expectFailureFor(goog.userAgent.IE);
        expectedFailures.expectFailureFor(isMacSafari3());
        try {
          assertTrue('Control must be focused', control.isFocused());
        } catch (e) {
          expectedFailures.handleException(e);
        }
      }

      resetEventCount();

      control.setEnabled(false);
      assertEquals('One DISABLE event must have been dispatched', 1,
          getEventCount(control, goog.ui.Component.EventType.DISABLE));
      assertFalse('Control must be disabled', control.isEnabled());
      assertFalse('Control must not be highlighed', control.isHighlighted());
      assertFalse('Control must not be active', control.isActive());
      assertFalse('Control must not be focused', control.isFocused());
    }

    /**
     * Tests {@link goog.ui.Control#setEnabled} when the control has a parent.
     */
    function testSetEnabledWithParent() {
      var child = new goog.ui.Control(null);
      child.setDispatchTransitionEvents(goog.ui.Component.State.ALL, true);
      control.addChild(child, true /* opt_render */);
      control.setEnabled(false);

      resetEventCount();

      assertFalse('Parent must be disabled', control.isEnabled());
      assertTrue('Child must be enabled', child.isEnabled());

      child.setEnabled(false);
      assertTrue('No events must have been dispatched when child is disabled',
          noEventsDispatched());
      assertTrue('Child must still be enabled', child.isEnabled());

      resetEventCount();

      control.setEnabled(true);
      assertEquals('One ENABLE event must have been dispatched by the parent',
          1, getEventCount(control, goog.ui.Component.EventType.ENABLE));
      assertTrue('Parent must be enabled', control.isEnabled());
      assertTrue('Child must still be enabled', child.isEnabled());

      resetEventCount();

      child.setEnabled(false);
      assertEquals('One DISABLE event must have been dispatched by the child',
          1, getEventCount(child, goog.ui.Component.EventType.DISABLE));
      assertTrue('Parent must still be enabled', control.isEnabled());
      assertFalse('Child must now be disabled', child.isEnabled());

      resetEventCount();

      control.setEnabled(false);
      assertEquals('One DISABLE event must have been dispatched by the parent',
          1, getEventCount(control, goog.ui.Component.EventType.DISABLE));
      assertFalse('Parent must now be disabled', control.isEnabled());
      assertFalse('Child must still be disabled', child.isEnabled());

      child.dispose();
    }

    /**
     * Tests {@link goog.ui.Control#isHighlighted}.
     */
    function testIsHighlighted() {
      assertFalse('Controls must not be highlighted by default',
          control.isHighlighted());
    }

    /**
     * Tests {@link goog.ui.Control#setHighlighted}.
     */
    function testSetHighlighted() {
      control.setSupportedState(goog.ui.Component.State.HOVER, false);

      control.setHighlighted(true);
      assertFalse('Control must not be highlighted, because it isn\'t ' +
          'highlightable', control.isHighlighted());
      assertTrue('Control must not have dispatched any events',
          noEventsDispatched());

      control.setSupportedState(goog.ui.Component.State.HOVER, true);

      control.setHighlighted(true);
      assertTrue('Control must be highlighted', control.isHighlighted());
      assertEquals('Control must have dispatched a HIGHLIGHT event', 1,
          getEventCount(control, goog.ui.Component.EventType.HIGHLIGHT));

      control.setHighlighted(true);
      assertTrue('Control must still be highlighted', control.isHighlighted());
      assertEquals('Control must not dispatch more HIGHLIGHT events', 1,
          getEventCount(control, goog.ui.Component.EventType.HIGHLIGHT));

      control.setHighlighted(false);
      assertFalse('Control must not be highlighted', control.isHighlighted());
      assertEquals('Control must have dispatched an UNHIGHLIGHT event', 1,
          getEventCount(control, goog.ui.Component.EventType.UNHIGHLIGHT));
      control.setEnabled(false);
      assertFalse('Control must be disabled', control.isEnabled());

      control.setHighlighted(true);
      assertTrue('Control must be highlighted, even when disabled',
          control.isHighlighted());
      assertEquals('Control must have dispatched another HIGHLIGHT event', 2,
          getEventCount(control, goog.ui.Component.EventType.HIGHLIGHT));
    }

    /**
     * Tests {@link goog.ui.Control#isActive}.
     */
    function testIsActive() {
      assertFalse('Controls must not be active by default', control.isActive());
    }

    /**
     * Tests {@link goog.ui.Control#setActive}.
     */
    function testSetActive() {
      control.setSupportedState(goog.ui.Component.State.ACTIVE, false);

      control.setActive(true);
      assertFalse('Control must not be active, because it isn\'t activateable',
          control.isActive());
      assertTrue('Control must not have dispatched any events',
          noEventsDispatched());

      control.setSupportedState(goog.ui.Component.State.ACTIVE, true);

      control.setActive(true);
      assertTrue('Control must be active', control.isActive());
      assertEquals('Control must have dispatched an ACTIVATE event', 1,
          getEventCount(control, goog.ui.Component.EventType.ACTIVATE));

      control.setActive(true);
      assertTrue('Control must still be active', control.isActive());
      assertEquals('Control must not dispatch more ACTIVATE events', 1,
          getEventCount(control, goog.ui.Component.EventType.ACTIVATE));

      control.setEnabled(false);
      assertFalse('Control must be disabled', control.isEnabled());
      assertFalse('Control must not be active', control.isActive());
      assertEquals('Control must have dispatched a DEACTIVATE event', 1,
          getEventCount(control, goog.ui.Component.EventType.DEACTIVATE));
    }

    /**
     * Tests disposing the control from an action event handler.
     */
    function testDisposeOnAction() {
      goog.events.listen(control, goog.ui.Component.EventType.ACTION,
          function(e) {
            control.dispose();
          });

      // Control must not throw an exception if disposed of in an ACTION event
      // handler.
      control.performActionInternal();
      control.setActive(true);
      assertTrue('Control should have been disposed of', control.isDisposed());
    }

    /**
     * Tests {@link goog.ui.Control#isSelected}.
     */
    function testIsSelected() {
      assertFalse('Controls must not be selected by default',
          control.isSelected());
    }

    /**
     * Tests {@link goog.ui.Control#setSelected}.
     */
    function testSetSelected() {
      control.setSupportedState(goog.ui.Component.State.SELECTED, false);

      control.setSelected(true);
      assertFalse('Control must not be selected, because it isn\'t selectable',
          control.isSelected());
      assertTrue('Control must not have dispatched any events',
          noEventsDispatched());

      control.setSupportedState(goog.ui.Component.State.SELECTED, true);

      control.setSelected(true);
      assertTrue('Control must be selected', control.isSelected());
      assertEquals('Control must have dispatched a SELECT event', 1,
          getEventCount(control, goog.ui.Component.EventType.SELECT));

      control.setSelected(true);
      assertTrue('Control must still be selected', control.isSelected());
      assertEquals('Control must not dispatch more SELECT events', 1,
          getEventCount(control, goog.ui.Component.EventType.SELECT));

      control.setSelected(false);
      assertFalse('Control must not be selected', control.isSelected());
      assertEquals('Control must have dispatched an UNSELECT event', 1,
          getEventCount(control, goog.ui.Component.EventType.UNSELECT));
      control.setEnabled(false);
      assertFalse('Control must be disabled', control.isEnabled());

      control.setSelected(true);
      assertTrue('Control must be selected, even when disabled',
          control.isSelected());
      assertEquals('Control must have dispatched another SELECT event', 2,
          getEventCount(control, goog.ui.Component.EventType.SELECT));
    }

    /**
     * Tests {@link goog.ui.Control#isChecked}.
     */
    function testIsChecked() {
      assertFalse('Controls must not be checked by default',
          control.isChecked());
    }

    /**
     * Tests {@link goog.ui.Control#setChecked}.
     */
    function testSetChecked() {
      control.setSupportedState(goog.ui.Component.State.CHECKED, false);

      control.setChecked(true);
      assertFalse('Control must not be checked, because it isn\'t checkable',
          control.isChecked());
      assertTrue('Control must not have dispatched any events',
          noEventsDispatched());

      control.setSupportedState(goog.ui.Component.State.CHECKED, true);

      control.setChecked(true);
      assertTrue('Control must be checked', control.isChecked());
      assertEquals('Control must have dispatched a CHECK event', 1,
          getEventCount(control, goog.ui.Component.EventType.CHECK));

      control.setChecked(true);
      assertTrue('Control must still be checked', control.isChecked());
      assertEquals('Control must not dispatch more CHECK events', 1,
          getEventCount(control, goog.ui.Component.EventType.CHECK));

      control.setChecked(false);
      assertFalse('Control must not be checked', control.isChecked());
      assertEquals('Control must have dispatched an UNCHECK event', 1,
          getEventCount(control, goog.ui.Component.EventType.UNCHECK));
      control.setEnabled(false);
      assertFalse('Control must be disabled', control.isEnabled());

      control.setChecked(true);
      assertTrue('Control must be checked, even when disabled',
          control.isChecked());
      assertEquals('Control must have dispatched another CHECK event', 2,
          getEventCount(control, goog.ui.Component.EventType.CHECK));
    }

    /**
     * Tests {@link goog.ui.Control#isFocused}.
     */
    function testIsFocused() {
      assertFalse('Controls must not be focused by default',
          control.isFocused());
    }

    /**
     * Tests {@link goog.ui.Control#setFocused}.
     */
    function testSetFocused() {
      control.setSupportedState(goog.ui.Component.State.FOCUSED, false);

      control.setFocused(true);
      assertFalse('Control must not be focused, because it isn\'t focusable',
          control.isFocused());
      assertTrue('Control must not have dispatched any events',
          noEventsDispatched());

      control.setSupportedState(goog.ui.Component.State.FOCUSED, true);

      control.setFocused(true);
      assertTrue('Control must be focused', control.isFocused());
      assertEquals('Control must have dispatched a FOCUS event', 1,
          getEventCount(control, goog.ui.Component.EventType.FOCUS));

      control.setFocused(true);
      assertTrue('Control must still be focused', control.isFocused());
      assertEquals('Control must not dispatch more FOCUS events', 1,
          getEventCount(control, goog.ui.Component.EventType.FOCUS));

      control.setFocused(false);
      assertFalse('Control must not be focused', control.isFocused());
      assertEquals('Control must have dispatched an BLUR event', 1,
          getEventCount(control, goog.ui.Component.EventType.BLUR));
      control.setEnabled(false);
      assertFalse('Control must be disabled', control.isEnabled());

      control.setFocused(true);
      assertTrue('Control must be focused, even when disabled',
          control.isFocused());
      assertEquals('Control must have dispatched another FOCUS event', 2,
          getEventCount(control, goog.ui.Component.EventType.FOCUS));
    }

    /**
     * Tests {@link goog.ui.Control#isOpen}.
     */
    function testIsOpen() {
      assertFalse('Controls must not be open by default', control.isOpen());
    }

    /**
     * Tests {@link goog.ui.Control#setOpen}.
     */
    function testSetOpen() {
      control.setSupportedState(goog.ui.Component.State.OPENED, false);

      control.setOpen(true);
      assertFalse('Control must not be opened, because it isn\'t openable',
          control.isOpen());
      assertTrue('Control must not have dispatched any events',
          noEventsDispatched());

      control.setSupportedState(goog.ui.Component.State.OPENED, true);

      control.setOpen(true);
      assertTrue('Control must be opened', control.isOpen());
      assertEquals('Control must have dispatched a OPEN event', 1,
          getEventCount(control, goog.ui.Component.EventType.OPEN));

      control.setOpen(true);
      assertTrue('Control must still be opened', control.isOpen());
      assertEquals('Control must not dispatch more OPEN events', 1,
          getEventCount(control, goog.ui.Component.EventType.OPEN));

      control.setOpen(false);
      assertFalse('Control must not be opened', control.isOpen());
      assertEquals('Control must have dispatched an CLOSE event', 1,
          getEventCount(control, goog.ui.Component.EventType.CLOSE));
      control.setEnabled(false);
      assertFalse('Control must be disabled', control.isEnabled());

      control.setOpen(true);
      assertTrue('Control must be opened, even when disabled',
          control.isOpen());
      assertEquals('Control must have dispatched another OPEN event', 2,
          getEventCount(control, goog.ui.Component.EventType.OPEN));
    }

    /**
     * Tests {@link goog.ui.Control#getState}.
     */
    function testGetState() {
      assertEquals('Controls must be in the default state', 0x00,
          control.getState());
    }

    /**
     * Tests {@link goog.ui.Control#hasState}.
     */
    function testHasState() {
      assertFalse('Control must not be disabled',
          control.hasState(goog.ui.Component.State.DISABLED));
      assertFalse('Control must not be in the HOVER state',
          control.hasState(goog.ui.Component.State.HOVER));
      assertFalse('Control must not be active',
          control.hasState(goog.ui.Component.State.ACTIVE));
      assertFalse('Control must not be selected',
          control.hasState(goog.ui.Component.State.SELECTED));
      assertFalse('Control must not be checked',
          control.hasState(goog.ui.Component.State.CHECKED));
      assertFalse('Control must not be focused',
          control.hasState(goog.ui.Component.State.FOCUSED));
      assertFalse('Control must not be open',
          control.hasState(goog.ui.Component.State.OPEN));
    }

    /**
     * Tests {@link goog.ui.Control#setState}.
     */
    function testSetState() {
      control.createDom();
      control.setSupportedState(goog.ui.Component.State.ACTIVE, false);

      assertFalse('Control must not be active',
          control.hasState(goog.ui.Component.State.ACTIVE));
      control.setState(goog.ui.Component.State.ACTIVE, true);
      assertFalse('Control must still be inactive (because it doesn\'t ' +
          'support the ACTIVE state)',
          control.hasState(goog.ui.Component.State.ACTIVE));

      control.setSupportedState(goog.ui.Component.State.ACTIVE, true);

      control.setState(goog.ui.Component.State.ACTIVE, true);
      assertTrue('Control must be active',
          control.hasState(goog.ui.Component.State.ACTIVE));
      assertTrue('Control must have the active CSS style',
          goog.dom.classes.has(control.getElement(), 'goog-control-active'));

      control.setState(goog.ui.Component.State.ACTIVE, true);
      assertTrue('Control must still be active',
          control.hasState(goog.ui.Component.State.ACTIVE));
      assertTrue('Control must still have the active CSS style',
          goog.dom.classes.has(control.getElement(), 'goog-control-active'));

      assertTrue('No events must have been dispatched', noEventsDispatched());
    }

    /**
     * Tests {@link goog.ui.Control#setStateInternal}.
     */
    function testSetStateInternal() {
      control.setStateInternal(0x00);
      assertEquals('State should be 0x00', 0x00, control.getState());
      control.setStateInternal(0x17);
      assertEquals('State should be 0x17', 0x17, control.getState());
    }

    /**
     * Tests {@link goog.ui.Control#isSupportedState}.
     */
    function testIsSupportedState() {
      assertTrue('Control must support DISABLED',
          control.isSupportedState(goog.ui.Component.State.DISABLED));
      assertTrue('Control must support HOVER',
          control.isSupportedState(goog.ui.Component.State.HOVER));
      assertTrue('Control must support ACTIVE',
          control.isSupportedState(goog.ui.Component.State.ACTIVE));
      assertTrue('Control must support FOCUSED',
          control.isSupportedState(goog.ui.Component.State.FOCUSED));
      assertFalse('Control must no support SELECTED',
          control.isSupportedState(goog.ui.Component.State.SELECTED));
      assertFalse('Control must no support CHECKED',
          control.isSupportedState(goog.ui.Component.State.CHECKED));
      assertFalse('Control must no support OPENED',
          control.isSupportedState(goog.ui.Component.State.OPENED));
    }

    /**
     * Tests {@link goog.ui.Control#setSupportedState}.
     */
    function testSetSupportedState() {
      control.setSupportedState(goog.ui.Component.State.HOVER, true);
      assertTrue('Control must still support HOVER',
          control.isSupportedState(goog.ui.Component.State.HOVER));

      control.setSupportedState(goog.ui.Component.State.HOVER, false);
      assertFalse('Control must no longer support HOVER',
          control.isSupportedState(goog.ui.Component.State.HOVER));

      control.setState(goog.ui.Component.State.ACTIVE, true);
      control.setSupportedState(goog.ui.Component.State.ACTIVE, false);
      assertFalse('Control must no longer support ACTIVE',
          control.isSupportedState(goog.ui.Component.State.ACTIVE));
      assertFalse('Control must no longer be in the ACTIVE state',
          control.hasState(goog.ui.Component.State.ACTIVE));

      control.render(sandbox);

      control.setSupportedState(goog.ui.Component.State.FOCUSED, true);
      control.setState(goog.ui.Component.State.FOCUSED, true);

      assertThrows('Must not be able to disable support for the FOCUSED ' +
          "state for a control that's already in the document and focused",
          function() {
            control.setSupportedState(goog.ui.Component.State.FOCUSED, false);
          });

      assertTrue('No events must have been dispatched', noEventsDispatched());
    }


    /**
     * Tests {@link goog.ui.Control#isAutoState}.
     */
    function testIsAutoState() {
      assertTrue('Control must have DISABLED as an auto-state',
          control.isAutoState(goog.ui.Component.State.DISABLED));
      assertTrue('Control must have HOVER as an auto-state',
          control.isAutoState(goog.ui.Component.State.HOVER));
      assertTrue('Control must have ACTIVE as an auto-state',
          control.isAutoState(goog.ui.Component.State.ACTIVE));
      assertTrue('Control must have FOCUSED as an auto-state',
          control.isAutoState(goog.ui.Component.State.FOCUSED));

      assertFalse('Control must not have SELECTED as an auto-state',
          control.isAutoState(goog.ui.Component.State.SELECTED));
      assertFalse('Control must not have CHECKED as an auto-state',
          control.isAutoState(goog.ui.Component.State.CHECKED));
      assertFalse('Control must not have OPENED as an auto-state',
          control.isAutoState(goog.ui.Component.State.OPENED));

      assertTrue('No events must have been dispatched', noEventsDispatched());
    }

    /**
     * Tests {@link goog.ui.Control#setAutoStates}.
     */
    function testSetAutoStates() {
      control.setAutoStates(goog.ui.Component.State.HOVER, false);
      assertFalse('Control must not have HOVER as an auto-state',
          control.isAutoState(goog.ui.Component.State.HOVER));

      control.setAutoStates(goog.ui.Component.State.ACTIVE |
          goog.ui.Component.State.FOCUSED, false);
      assertFalse('Control must not have ACTIVE as an auto-state',
          control.isAutoState(goog.ui.Component.State.ACTIVE));
      assertFalse('Control must not have FOCUSED as an auto-state',
          control.isAutoState(goog.ui.Component.State.FOCUSED));

      control.setSupportedState(goog.ui.Component.State.FOCUSED, false);
      control.setAutoStates(goog.ui.Component.State.FOCUSED, true);
      assertFalse('Control must not have FOCUSED as an auto-state if it no ' +
          'longer supports FOCUSED',
          control.isAutoState(goog.ui.Component.State.FOCUSED));

      assertTrue('No events must have been dispatched', noEventsDispatched());
    }

    /**
     * Tests {@link goog.ui.Control#isDispatchTransitionEvents}.
     */
    function testIsDispatchTransitionEvents() {
      assertTrue('Control must dispatch DISABLED transition events',
          control.isDispatchTransitionEvents(goog.ui.Component.State.DISABLED));
      assertTrue('Control must dispatch HOVER transition events',
          control.isDispatchTransitionEvents(goog.ui.Component.State.HOVER));
      assertTrue('Control must dispatch ACTIVE transition events',
          control.isDispatchTransitionEvents(goog.ui.Component.State.ACTIVE));
      assertTrue('Control must dispatch FOCUSED transition events',
          control.isDispatchTransitionEvents(goog.ui.Component.State.FOCUSED));

      assertFalse('Control must not dispatch SELECTED transition events',
          control.isDispatchTransitionEvents(goog.ui.Component.State.SELECTED));
      assertFalse('Control must not dispatch CHECKED transition events',
          control.isDispatchTransitionEvents(goog.ui.Component.State.CHECKED));
      assertFalse('Control must not dispatch OPENED transition events',
          control.isDispatchTransitionEvents(goog.ui.Component.State.OPENED));

      assertTrue('No events must have been dispatched', noEventsDispatched());
    }

    /**
     * Tests {@link goog.ui.Control#setDispatchTransitionEvents}.
     */
    function testSetDispatchTransitionEvents() {
      control.setDispatchTransitionEvents(goog.ui.Component.State.HOVER, false);
      assertFalse('Control must not dispatch HOVER transition events',
          control.isDispatchTransitionEvents(goog.ui.Component.State.HOVER));

      control.setSupportedState(goog.ui.Component.State.SELECTED, true);
      control.setDispatchTransitionEvents(goog.ui.Component.State.SELECTED,
          true);
      assertTrue('Control must dispatch SELECTED transition events',
          control.isDispatchTransitionEvents(goog.ui.Component.State.SELECTED));

      assertTrue('No events must have been dispatched', noEventsDispatched());
    }

    /**
     * Tests {@link goog.ui.Control#isTransitionAllowed}.
     */
    function testIsTransitionAllowed() {
      assertTrue('Control must support the HOVER state',
          control.isSupportedState(goog.ui.Component.State.HOVER));
      assertFalse('Control must not be in the HOVER state',
          control.hasState(goog.ui.Component.State.HOVER));
      assertTrue('Control must dispatch HOVER transition events',
          control.isDispatchTransitionEvents(goog.ui.Component.State.HOVER));

      assertTrue('Control must be allowed to transition to the HOVER state',
          control.isTransitionAllowed(goog.ui.Component.State.HOVER, true));
      assertEquals('Control must have dispatched one HIGHLIGHT event', 1,
          getEventCount(control, goog.ui.Component.EventType.HIGHLIGHT));
      assertFalse('Control must not be highlighted',
          control.hasState(goog.ui.Component.State.HOVER));

      control.setState(goog.ui.Component.State.HOVER, true);
      control.setDispatchTransitionEvents(goog.ui.Component.State.HOVER, false);

      assertTrue('Control must be allowed to transition from the HOVER state',
          control.isTransitionAllowed(goog.ui.Component.State.HOVER, false));
      assertEquals('Control must not have dispatched any UNHIGHLIGHT events', 0,
          getEventCount(control, goog.ui.Component.EventType.UNHIGHLIGHT));
      assertTrue('Control must still be highlighted',
          control.hasState(goog.ui.Component.State.HOVER));

      control.setSupportedState(goog.ui.Component.State.FOCUSED, false);
      resetEventCount();

      assertFalse('Control doesn\'t support the FOCUSED state',
          control.isSupportedState(goog.ui.Component.State.FOCUSED));
      assertFalse('Control must not be FOCUSED',
          control.hasState(goog.ui.Component.State.FOCUSED));
      assertFalse('Control must not be allowed to transition to the FOCUSED ' +
          'state',
          control.isTransitionAllowed(goog.ui.Component.State.FOCUSED, true));
      assertEquals('Control must not have dispatched any FOCUS events', 0,
          getEventCount(control, goog.ui.Component.EventType.FOCUS));

      control.setEnabled(false);
      resetEventCount();

      assertTrue('Control must support the DISABLED state',
          control.isSupportedState(goog.ui.Component.State.DISABLED));
      assertTrue('Control must be DISABLED',
          control.hasState(goog.ui.Component.State.DISABLED));
      assertFalse('Control must not be allowed to transition to the DISABLED ' +
          'state, because it is already there',
          control.isTransitionAllowed(goog.ui.Component.State.DISABLED, true));
      assertEquals('Control must not have dispatched any ENABLE events', 0,
          getEventCount(control, goog.ui.Component.EventType.ENABLE));
    }

    /**
     * Tests {@link goog.ui.Control#handleKeyEvent}.
     */
    function testHandleKeyEvent() {
      control.render()
      control.isVisible = control.isEnabled = function() {
        return true;
      };


      goog.testing.events.fireKeySequence(
          control.getKeyEventTarget(), goog.events.KeyCodes.A);

      assertEquals('Control must not have dispatched an ACTION event', 0,
          getEventCount(control, goog.ui.Component.EventType.ACTION));

      goog.testing.events.fireKeySequence(
          control.getKeyEventTarget(), goog.events.KeyCodes.ENTER);
      assertEquals('Control must have dispatched an ACTION event', 1,
          getEventCount(control, goog.ui.Component.EventType.ACTION));
    }


    /**
     * Tests {@link goog.ui.Control#performActionInternal}.
     */
    function testPerformActionInternal() {
      assertFalse('Control must not be checked', control.isChecked());
      assertFalse('Control must not be selected', control.isSelected());
      assertFalse('Control must not be open', control.isOpen());

      control.performActionInternal();

      assertFalse('Control must not be checked', control.isChecked());
      assertFalse('Control must not be selected', control.isSelected());
      assertFalse('Control must not be open', control.isOpen());
      assertEquals('Control must have dispatched an ACTION event', 1,
          getEventCount(control, goog.ui.Component.EventType.ACTION));

      control.setSupportedState(goog.ui.Component.State.CHECKED, true);
      control.setSupportedState(goog.ui.Component.State.SELECTED, true);
      control.setSupportedState(goog.ui.Component.State.OPENED, true);

      control.performActionInternal();

      assertTrue('Control must be checked', control.isChecked());
      assertTrue('Control must be selected', control.isSelected());
      assertTrue('Control must be open', control.isOpen());
      assertEquals('Control must have dispatched a CHECK event', 1,
          getEventCount(control, goog.ui.Component.EventType.CHECK));
      assertEquals('Control must have dispatched a SELECT event', 1,
          getEventCount(control, goog.ui.Component.EventType.SELECT));
      assertEquals('Control must have dispatched a OPEN event', 1,
          getEventCount(control, goog.ui.Component.EventType.OPEN));
      assertEquals('Control must have dispatched another ACTION event', 2,
          getEventCount(control, goog.ui.Component.EventType.ACTION));

      control.performActionInternal();

      assertFalse('Control must not be checked', control.isChecked());
      assertTrue('Control must be selected', control.isSelected());
      assertFalse('Control must not be open', control.isOpen());
      assertEquals('Control must have dispatched an UNCHECK event', 1,
          getEventCount(control, goog.ui.Component.EventType.UNCHECK));
      assertEquals('Control must not have dispatched an UNSELECT event', 0,
          getEventCount(control, goog.ui.Component.EventType.UNSELECT));
      assertEquals('Control must have dispatched a CLOSE event', 1,
          getEventCount(control, goog.ui.Component.EventType.CLOSE));
      assertEquals('Control must have dispatched another ACTION event', 3,
          getEventCount(control, goog.ui.Component.EventType.ACTION));
    }

    /**
     * Tests {@link goog.ui.Control#handleMouseOver}.
     */
    function testHandleMouseOver() {
      control.setContent(goog.dom.createDom('span', {id: 'caption'}, 'Hello'));
      control.render(sandbox);

      var element = control.getElement();
      var caption = goog.dom.getElement('caption');

      // Verify baseline assumptions.
      assertTrue('Caption must be contained within the control',
          goog.dom.contains(element, caption));
      assertTrue('Control must be enabled', control.isEnabled());
      assertTrue('HOVER must be an auto-state',
          control.isAutoState(goog.ui.Component.State.HOVER));
      assertFalse('Control must not start out highlighted',
          control.isHighlighted());

      // Scenario 1:  relatedTarget is contained within the control's DOM.
      goog.testing.events.fireMouseOverEvent(element, caption);
      assertTrue('No events must have been dispatched for internal mouse move',
          noEventsDispatched());
      assertFalse('Control must not be highlighted for internal mouse move',
          control.isHighlighted());
      resetEventCount();

      // Scenario 2:  preventDefault() is called on the ENTER event.
      var key = goog.events.listen(control, goog.ui.Component.EventType.ENTER,
          function(e) {
            e.preventDefault();
          });
      goog.testing.events.fireMouseOverEvent(element, sandbox);
      assertEquals('Control must have dispatched 1 ENTER event', 1,
          getEventCount(control, goog.ui.Component.EventType.ENTER));
      assertFalse('Control must not be highlighted if ENTER is canceled',
          control.isHighlighted());
      goog.events.unlistenByKey(key);
      resetEventCount();

      // Scenario 3:  Control is disabled.
      control.setEnabled(false);
      goog.testing.events.fireMouseOverEvent(element, sandbox);
      assertEquals('Control must dispatch ENTER event on mouseover even if ' +
          'disabled', 1,
          getEventCount(control, goog.ui.Component.EventType.ENTER));
      assertFalse('Control must not be highlighted if it is disabled',
          control.isHighlighted());
      control.setEnabled(true);
      resetEventCount();

      // Scenario 4:  HOVER is not an auto-state.
      control.setAutoStates(goog.ui.Component.State.HOVER, false);
      goog.testing.events.fireMouseOverEvent(element, sandbox);
      assertEquals('Control must dispatch ENTER event on mouseover even if ' +
          'HOVER is not an auto-state', 1,
          getEventCount(control, goog.ui.Component.EventType.ENTER));
      assertFalse('Control must not be highlighted if HOVER isn\'t an auto-' +
          'state', control.isHighlighted());
      control.setAutoStates(goog.ui.Component.State.HOVER, true);
      resetEventCount();

      // Scenario 5:  All is well.
      goog.testing.events.fireMouseOverEvent(element, sandbox);
      assertEquals('Control must dispatch ENTER event on mouseover', 1,
          getEventCount(control, goog.ui.Component.EventType.ENTER));
      assertEquals('Control must dispatch HIGHLIGHT event on mouseover', 1,
          getEventCount(control, goog.ui.Component.EventType.HIGHLIGHT));
      assertTrue('Control must be highlighted', control.isHighlighted());
      resetEventCount();

      // Scenario 6: relatedTarget is null
      control.setHighlighted(false);
      goog.testing.events.fireMouseOverEvent(element, null);
      assertEquals('Control must dispatch ENTER event on mouseover', 1,
          getEventCount(control, goog.ui.Component.EventType.ENTER));
      assertEquals('Control must dispatch HIGHLIGHT event on mouseover', 1,
          getEventCount(control, goog.ui.Component.EventType.HIGHLIGHT));
      assertTrue('Control must be highlighted', control.isHighlighted());
      resetEventCount();
    }

    /**
     * Tests {@link goog.ui.Control#handleMouseOut}.
     */
    function testHandleMouseOut() {
      control.setContent(goog.dom.createDom('span', {id: 'caption'}, 'Hello'));
      control.setHighlighted(true);
      control.setActive(true);

      resetEventCount();

      control.render(sandbox);

      var element = control.getElement();
      var caption = goog.dom.getElement('caption');

      // Verify baseline assumptions.
      assertTrue('Caption must be contained within the control',
          goog.dom.contains(element, caption));
      assertTrue('Control must be enabled', control.isEnabled());
      assertTrue('HOVER must be an auto-state',
          control.isAutoState(goog.ui.Component.State.HOVER));
      assertTrue('ACTIVE must be an auto-state',
          control.isAutoState(goog.ui.Component.State.ACTIVE));
      assertTrue('Control must start out highlighted', control.isHighlighted());
      assertTrue('Control must start out active', control.isActive());

      // Scenario 1:  relatedTarget is contained within the control's DOM.
      goog.testing.events.fireMouseOutEvent(element, caption);
      assertTrue('No events must have been dispatched for internal mouse move',
          noEventsDispatched());
      assertTrue('Control must not be un-highlighted for internal mouse move',
          control.isHighlighted());
      assertTrue('Control must not be deactivated for internal mouse move',
          control.isActive());
      resetEventCount();

      // Scenario 2:  preventDefault() is called on the LEAVE event.
      var key = goog.events.listen(control, goog.ui.Component.EventType.LEAVE,
          function(e) {
            e.preventDefault();
          });
      goog.testing.events.fireMouseOutEvent(element, sandbox);
      assertEquals('Control must have dispatched 1 LEAVE event', 1,
          getEventCount(control, goog.ui.Component.EventType.LEAVE));
      assertTrue('Control must not be un-highlighted if LEAVE is canceled',
          control.isHighlighted());
      assertTrue('Control must not be deactivated if LEAVE is canceled',
          control.isActive());
      goog.events.unlistenByKey(key);
      resetEventCount();

      // Scenario 3:  ACTIVE is not an auto-state.
      control.setAutoStates(goog.ui.Component.State.ACTIVE, false);
      goog.testing.events.fireMouseOutEvent(element, sandbox);
      assertEquals('Control must dispatch LEAVE event on mouseout even if ' +
          'ACTIVE is not an auto-state', 1,
          getEventCount(control, goog.ui.Component.EventType.LEAVE));
      assertTrue('Control must not be deactivated if ACTIVE isn\'t an auto-' +
          'state', control.isActive());
      assertFalse('Control must be un-highlighted even if ACTIVE isn\'t an ' +
          'auto-state', control.isHighlighted());
      control.setAutoStates(goog.ui.Component.State.ACTIVE, true);
      control.setHighlighted(true);
      resetEventCount();

      // Scenario 4:  HOVER is not an auto-state.
      control.setAutoStates(goog.ui.Component.State.HOVER, false);
      goog.testing.events.fireMouseOutEvent(element, sandbox);
      assertEquals('Control must dispatch LEAVE event on mouseout even if ' +
          'HOVER is not an auto-state', 1,
          getEventCount(control, goog.ui.Component.EventType.LEAVE));
      assertFalse('Control must be deactivated even if HOVER isn\'t an auto-' +
          'state', control.isActive());
      assertTrue('Control must not be un-highlighted if HOVER isn\'t an auto-' +
          'state', control.isHighlighted());
      control.setAutoStates(goog.ui.Component.State.HOVER, true);
      control.setActive(true);
      resetEventCount();

      // Scenario 5:  All is well.
      goog.testing.events.fireMouseOutEvent(element, sandbox);
      assertEquals('Control must dispatch LEAVE event on mouseout', 1,
          getEventCount(control, goog.ui.Component.EventType.LEAVE));
      assertEquals('Control must dispatch DEACTIVATE event on mouseout', 1,
          getEventCount(control, goog.ui.Component.EventType.DEACTIVATE));
      assertEquals('Control must dispatch UNHIGHLIGHT event on mouseout', 1,
          getEventCount(control, goog.ui.Component.EventType.UNHIGHLIGHT));
      assertFalse('Control must be deactivated', control.isActive());
      assertFalse('Control must be unhighlighted', control.isHighlighted());
      resetEventCount();

      // Scenario 6: relatedTarget is null
      control.setActive(true);
      control.setHighlighted(true);
      goog.testing.events.fireMouseOutEvent(element, null);
      assertEquals('Control must dispatch LEAVE event on mouseout', 1,
          getEventCount(control, goog.ui.Component.EventType.LEAVE));
      assertEquals('Control must dispatch DEACTIVATE event on mouseout', 1,
          getEventCount(control, goog.ui.Component.EventType.DEACTIVATE));
      assertEquals('Control must dispatch UNHIGHLIGHT event on mouseout', 1,
          getEventCount(control, goog.ui.Component.EventType.UNHIGHLIGHT));
      assertFalse('Control must be deactivated', control.isActive());
      assertFalse('Control must be unhighlighted', control.isHighlighted());
      resetEventCount();
    }

    function testIsMouseEventWithinElement() {
      var child = goog.dom.createElement('div');
      var parent = goog.dom.createDom('div', null, child);
      var notChild = goog.dom.createElement('div');

      var event = new goog.testing.events.Event('mouseout');
      event.relatedTarget = child;
      assertTrue('Event is within element',
                 goog.ui.Control.isMouseEventWithinElement_(event, parent));

      var event = new goog.testing.events.Event('mouseout');
      event.relatedTarget = notChild;
      assertFalse('Event is not within element',
                  goog.ui.Control.isMouseEventWithinElement_(event, parent));
    }

    function testHandleMouseDown() {
      control.render(sandbox);
      assertFalse('preventDefault() must have been called for control that ' +
          'doesn\'t support text selection',
          fireMouseDownAndFocus(control.getElement()));
      assertTrue('Control must be highlighted', control.isHighlighted());
      assertTrue('Control must be active', control.isActive());

      if (testFocus) {
        // Expected to fail on IE and Mac Safari 3.  IE calls focus handlers
        // asynchronously, and Mac Safari 3 doesn't support keyboard focus.
        expectedFailures.expectFailureFor(goog.userAgent.IE);
        expectedFailures.expectFailureFor(isMacSafari3());
        try {
          assertTrue('Control must be focused', control.isFocused());
        } catch (e) {
          expectedFailures.handleException(e);
        }
      }
    }

    function testHandleMouseDownForDisabledControl() {
      control.setEnabled(false);
      control.render(sandbox);
      assertFalse('preventDefault() must have been called for control that ' +
          'doesn\'t support text selection',
          fireMouseDownAndFocus(control.getElement()));
      assertFalse('Control must not be highlighted', control.isHighlighted());
      assertFalse('Control must not be active', control.isActive());
      if (testFocus) {
        assertFalse('Control must not be focused', control.isFocused());
      }
    }

    function testHandleMouseDownForNoHoverAutoState() {
      control.setAutoStates(goog.ui.Component.State.HOVER, false);
      control.render(sandbox);
      assertFalse('preventDefault() must have been called for control that ' +
          'doesn\'t support text selection',
          fireMouseDownAndFocus(control.getElement()));
      assertFalse('Control must not be highlighted', control.isHighlighted());
      assertTrue('Control must be active', control.isActive());

      if (testFocus) {
        // Expected to fail on IE and Mac Safari 3.  IE calls focus handlers
        // asynchronously, and Mac Safari 3 doesn't support keyboard focus.
        expectedFailures.expectFailureFor(goog.userAgent.IE);
        expectedFailures.expectFailureFor(isMacSafari3());
        try {
          assertTrue('Control must be focused', control.isFocused());
        } catch (e) {
          expectedFailures.handleException(e);
        }
      }
    }

    function testHandleMouseDownForRightMouseButton() {
      control.render(sandbox);
      assertTrue('preventDefault() must not have been called for right ' +
          'mouse button', fireMouseDownAndFocus(control.getElement(),
          goog.events.BrowserEvent.MouseButton.RIGHT));
      assertTrue('Control must be highlighted', control.isHighlighted());
      assertFalse('Control must not be active', control.isActive());

      if (testFocus) {
        // Expected to fail on IE and Mac Safari 3.  IE calls focus handlers
        // asynchronously, and Mac Safari 3 doesn't support keyboard focus.
        expectedFailures.expectFailureFor(goog.userAgent.IE);
        expectedFailures.expectFailureFor(isMacSafari3());
        try {
          assertTrue('Control must be focused', control.isFocused());
        } catch (e) {
          expectedFailures.handleException(e);
        }
      }
    }

    function testHandleMouseDownForNoActiveAutoState() {
      control.setAutoStates(goog.ui.Component.State.ACTIVE, false);
      control.render(sandbox);
      assertFalse('preventDefault() must have been called for control that ' +
          'doesn\'t support text selection',
          fireMouseDownAndFocus(control.getElement()));
      assertTrue('Control must be highlighted', control.isHighlighted());
      assertFalse('Control must not be active', control.isActive());

      if (testFocus) {
        // Expected to fail on IE and Mac Safari 3.  IE calls focus handlers
        // asynchronously, and Mac Safari 3 doesn't support keyboard focus.
        expectedFailures.expectFailureFor(goog.userAgent.IE);
        expectedFailures.expectFailureFor(isMacSafari3());
        try {
          assertTrue('Control must be focused', control.isFocused());
        } catch (e) {
          expectedFailures.handleException(e);
        }
      }
    }

    function testHandleMouseDownForNonFocusableControl() {
      control.setSupportedState(goog.ui.Component.State.FOCUSED, false);
      control.render(sandbox);
      assertFalse('preventDefault() must have been called for control that ' +
          'doesn\'t support text selection',
          fireMouseDownAndFocus(control.getElement()));
      assertTrue('Control must be highlighted', control.isHighlighted());
      assertTrue('Control must be active', control.isActive());
      assertFalse('Control must not be focused', control.isFocused());
    }

    // TODO(user): Find out why this is flaky on FF2/Linux and FF1.5/Win.
    //function testHandleMouseDownForSelectableControl() {
    //  control.setAllowTextSelection(true);
    //  control.render(sandbox);
    //  assertTrue('preventDefault() must not have been called for control ' +
    //      'that supports text selection',
    //      fireMouseDownAndFocus(control.getElement()));
    //  assertTrue('Control must be highlighted', control.isHighlighted());
    //  assertTrue('Control must be active', control.isActive());
    //  // Expected to fail on IE and Mac Safari 3.  IE calls focus handlers
    //  // asynchronously, and Mac Safari 3 doesn't support keyboard focus.
    //  expectedFailures.expectFailureFor(goog.userAgent.IE);
    //  expectedFailures.expectFailureFor(isMacSafari3());
    //  try {
    //    assertTrue('Control must be focused', control.isFocused());
    //  } catch (e) {
    //    expectedFailures.handleException(e);
    //  }
    //}


    /**
     * Tests {@link goog.ui.Control#handleMouseUp}.
     */
    function testHandleMouseUp() {
      control.setActive(true);

      // Override performActionInternal() for testing purposes.
      var actionPerformed = false;
      control.performActionInternal = function() {
        actionPerformed = true;
        return true;
      };

      resetEventCount();

      control.render(sandbox);
      var element = control.getElement();

      // Verify baseline assumptions.
      assertTrue('Control must be enabled', control.isEnabled());
      assertTrue('HOVER must be an auto-state',
          control.isAutoState(goog.ui.Component.State.HOVER));
      assertTrue('ACTIVE must be an auto-state',
          control.isAutoState(goog.ui.Component.State.ACTIVE));
      assertFalse('Control must not start out highlighted',
          control.isHighlighted());
      assertTrue('Control must start out active', control.isActive());

      // Scenario 1:  Control is disabled.
      control.setEnabled(false);
      goog.testing.events.fireMouseUpEvent(element);
      assertFalse('Disabled control must not highlight on mouseup',
          control.isHighlighted());
      assertFalse('No action must have been performed', actionPerformed);
      control.setActive(true);
      control.setEnabled(true);

      // Scenario 2:  HOVER is not an auto-state.
      control.setAutoStates(goog.ui.Component.State.HOVER, false);
      goog.testing.events.fireMouseUpEvent(element);
      assertFalse('Control must not highlight on mouseup if HOVER isn\'t an ' +
          'auto-state', control.isHighlighted());
      assertTrue('Action must have been performed even if HOVER isn\'t an ' +
          'auto-state', actionPerformed);
      assertFalse('Control must have been deactivated on mouseup even if ' +
          'HOVER isn\'t an auto-state', control.isActive());
      actionPerformed = false;
      control.setActive(true);
      control.setAutoStates(goog.ui.Component.State.HOVER, true);

      // Scenario 3:  Control is not active.
      control.setActive(false);
      goog.testing.events.fireMouseUpEvent(element);
      assertTrue('Control must highlight on mouseup, even if inactive',
          control.isHighlighted());
      assertFalse('No action must have been performed if control is inactive',
          actionPerformed);
      assertFalse('Inactive control must remain inactive after mouseup',
          control.isActive());
      control.setHighlighted(false);
      control.setActive(true);

      // Scenario 4:  performActionInternal() returns false.
      control.performActionInternal = function() {
        actionPerformed = true;
        return false;
      };
      goog.testing.events.fireMouseUpEvent(element);
      assertTrue('Control must highlight on mouseup, even if no action is ' +
          'performed', control.isHighlighted());
      assertTrue('performActionInternal must have been called',
          actionPerformed);
      assertTrue('Control must not deactivate if performActionInternal ' +
          'returns false', control.isActive());
      control.setHighlighted(false);
      actionPerformed = false;
      control.performActionInternal = function() {
        actionPerformed = true;
        return true;
      };

      // Scenario 5:  ACTIVE is not an auto-state.
      control.setAutoStates(goog.ui.Component.State.ACTIVE, false);
      goog.testing.events.fireMouseUpEvent(element);
      assertTrue('Control must highlight on mouseup even if ACTIVE isn\'t an ' +
          'auto-state', control.isHighlighted());
      assertTrue('Action must have been performed even if ACTIVE isn\'t an ' +
          'auto-state', actionPerformed);
      assertTrue('Control must not have been deactivated on mouseup if ' +
          'ACTIVE isn\'t an auto-state', control.isActive());
      actionPerformed = false;
      control.setHighlighted(false);
      control.setAutoStates(goog.ui.Component.State.ACTIVE, true);

      // Scenario 6:  All is well.
      goog.testing.events.fireMouseUpEvent(element);
      assertTrue('Control must highlight on mouseup', control.isHighlighted());
      assertTrue('Action must have been performed', actionPerformed);
      assertFalse('Control must have been deactivated', control.isActive());
    }
  ">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:29:28
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>toolbarcolormenubuttonrenderer_test.html</td><td>Fail</td><td> 1 passed, 1 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.ui.RendererHarness');
  goog.require('goog.ui.ToolbarColorMenuButton');
  goog.require('goog.ui.ToolbarColorMenuButtonRenderer');
  goog.require('goog.testing.ui.rendererasserts');



var harness;

function setUp() {
  harness = new goog.testing.ui.RendererHarness(
      goog.ui.ToolbarColorMenuButtonRenderer.getInstance(),
      goog.dom.getElement('parent'),
      goog.dom.getElement('decoratedButton'));
}

function tearDown() {
  harness.dispose();
}

function testEquality() {
  harness.attachControlAndRender(
      new goog.ui.ToolbarColorMenuButton('Foo'));
  harness.attachControlAndDecorate(
      new goog.ui.ToolbarColorMenuButton());
  harness.assertDomMatches();
}

function testDoesntCallGetCssClassInConstructor() {
  goog.testing.ui.rendererasserts.
      assertNoGetCssClassCallsInConstructor(
          goog.ui.ToolbarColorMenuButtonRenderer);
}
">2 of 2 tests run in 8ms.<br />1 passed, 1 failed.<br />4 ms/test. 1 files loaded.<br />ERROR in testEquality<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>tab_test.html</td><td>Success</td><td> 2 passed, 0 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.Component.State');
    goog.require('goog.ui.Tab');
    goog.require('goog.ui.TabRenderer');
  

    var sandbox = goog.dom.getElement('sandbox');
    var tab;

    function setUp() {
      tab = new goog.ui.Tab('Hello');
    }
    
    function tearDown() {
      tab.dispose();
      goog.dom.removeChildren(sandbox);
    }

    function testConstructor() {
      assertNotNull('Tab must not be null', tab);
      assertEquals('Tab must have expected content', 'Hello', tab.getContent());
      assertEquals('Tab\'s renderer must default to TabRenderer',
          goog.ui.TabRenderer.getInstance(), tab.getRenderer());
      assertTrue('Tab must support the SELECTED state',
          tab.isSupportedState(goog.ui.Component.State.SELECTED));
      assertTrue('SELECTED must be an auto-state',
          tab.isAutoState(goog.ui.Component.State.SELECTED));
      assertTrue('Tab must dispatch transition events for the DISABLED state',
          tab.isDispatchTransitionEvents(goog.ui.Component.State.DISABLED));
      assertTrue('Tab must dispatch transition events for the SELECTED state',
          tab.isDispatchTransitionEvents(goog.ui.Component.State.SELECTED));
    }

    function testGetSetTooltip() {
      assertUndefined('Tooltip must be undefined by default', tab.getTooltip());
      tab.setTooltip('Hello, world!');
      assertEquals('Tooltip must have expected value', 'Hello, world!',
          tab.getTooltip());
    }
  ">n/a</td></tr>
<tr><td>splitbehavior_test.html</td><td>Fail</td><td> 0 passed, 9 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.Component.EventType');
  goog.require('goog.ui.CustomButton');
  goog.require('goog.ui.Menu');
  goog.require('goog.ui.MenuButton');
  goog.require('goog.ui.MenuItem');
  goog.require('goog.ui.SplitBehavior');
  goog.require('goog.ui.decorate');



var splitbehavior;
var button;
var menuValues;
var menu;
var menuButton;
var splitDiv;

function setUp() {
  splitDiv = document.getElementById('split');
  button = new goog.ui.CustomButton('text');
  menu = new goog.ui.Menu();
  menuValues = ['a', 'b', 'c'];
  goog.array.forEach(menuValues, function(val) {
    menu.addItem(new goog.ui.MenuItem(val));
  });
  menuButton = new goog.ui.MenuButton('text', menu);
  splitbehavior = new goog.ui.SplitBehavior(button, menuButton);
}

function tearDown() {
  button.dispose();
  menu.dispose();
  menuButton.dispose();
  splitbehavior.dispose();
  splitDiv.innerHTML = '';
  splitDiv.className = '';
}

function testRender() {
  assertEquals('no elements in doc with goog-split-behavior class',
      0, goog.dom.getElementsByTagNameAndClass('div',
      'goog-split-behavior').length);
  splitbehavior.render(splitDiv);
  assertEquals('two childs are rendered', 2, splitDiv.childNodes.length);
  assertEquals('one element in doc with goog-split-behavior class',
      1, goog.dom.getElementsByTagNameAndClass('div',
      'goog-split-behavior').length);
  assertEquals('one goog-custom-button',
      1, goog.dom.getElementsByTagNameAndClass('div',
      'goog-custom-button', splitDiv).length);
  assertEquals('one goog-menu-button',
      1, goog.dom.getElementsByTagNameAndClass('div',
      'goog-menu-button', splitDiv).length);
}

function testDecorate() {
  var decorateDiv = goog.dom.createDom('div', 'goog-split-behavior',
      goog.dom.createDom('div', 'goog-custom-button'),
      goog.dom.createDom('div', 'goog-menu-button'));
  goog.dom.appendChild(splitDiv, decorateDiv);
  var split = goog.ui.decorate(decorateDiv);
  assertNotNull(split);
  assertTrue('instance of SplitBehavior',
      split.constructor == goog.ui.SplitBehavior);
  assertNotNull(split.first_);
  assertTrue('instance of CustomButton',
      split.first_.constructor == goog.ui.CustomButton);
  assertNotNull(split.second_);
  assertTrue('instance of MenuButton',
      split.second_.constructor == goog.ui.MenuButton);
}

function testBehaviorDefault() {
  splitbehavior.render(splitDiv);
  assertEquals('original caption is "text"', 'text', button.getCaption());
  var menuItem = menuButton.getMenu().getChildAt(0);
  var type = goog.ui.Component.EventType.ACTION;
  goog.events.dispatchEvent(menuButton, new goog.events.Event(type, menuItem));
  assertEquals('caption is updated to "a"','a', button.getCaption());
}

function testBehaviorCustomEvent() {
  splitbehavior.render(splitDiv);
  assertEquals('original caption is "text"', 'text', button.getCaption());
  var type = goog.ui.Component.EventType.ENTER;
  splitbehavior.setEventType(type);
  var menuItem = menuButton.getMenu().getChildAt(0);
  goog.events.dispatchEvent(menuButton, new goog.events.Event(type, menuItem));
  assertEquals('caption is updated to "a"', 'a', button.getCaption());
}

function testBehaviorCustomHandler() {
  splitbehavior.render(splitDiv);
  var called = false;
  splitbehavior.setHandler(function() { called = true; });
  goog.events.dispatchEvent(menuButton, goog.ui.Component.EventType.ACTION);
  assertTrue('custom handler is called', called);
}

function testSetActive() {
  splitbehavior.render(splitDiv, false);
  assertEquals('original caption is "text"', 'text', button.getCaption());
  var menuItem = menuButton.getMenu().getChildAt(0);
  var type = goog.ui.Component.EventType.ACTION;
  goog.events.dispatchEvent(menuButton, new goog.events.Event(type, menuItem));
  assertEquals('caption remains "text"', 'text', button.getCaption());

  splitbehavior.setActive(true);
  goog.events.dispatchEvent(menuButton, new goog.events.Event(type, menuItem));
  assertEquals('caption is updated to "a"', 'a', button.getCaption());
}

function testDispose() {
  goog.dispose(splitbehavior);
  assertTrue(splitbehavior.isDisposed());
  assertTrue(splitbehavior.first_.isDisposed());
  assertTrue(splitbehavior.second_.isDisposed());
}

function testDisposeNoControls() {
  splitbehavior.setDisposeControls(false);
  goog.dispose(splitbehavior);
  assertTrue(splitbehavior.isDisposed());
  assertFalse(splitbehavior.first_.isDisposed());
  assertFalse(splitbehavior.second_.isDisposed());
}

function testDisposeFirstAndNotSecondControl() {
  splitbehavior.setDisposeControls(true, false);
  goog.dispose(splitbehavior);
  assertTrue(splitbehavior.isDisposed());
  assertTrue(splitbehavior.first_.isDisposed());
  assertFalse(splitbehavior.second_.isDisposed());
}
">9 of 9 tests run in 25ms.<br />0 passed, 9 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testBehaviorCustomEvent<br />Object #<Object> has no method 'createElement'<br />ERROR in testBehaviorCustomHandler<br />Object #<Object> has no method 'createElement'<br />ERROR in testBehaviorDefault<br />Object #<Object> has no method 'createElement'<br />ERROR in testDecorate<br />Object #<Object> has no method 'createElement'<br />ERROR in testDispose<br />Object #<Object> has no method 'createElement'<br />ERROR in testDisposeFirstAndNotSecondControl<br />Object #<Object> has no method 'createElement'<br />ERROR in testDisposeNoControls<br />Object #<Object> has no method 'createElement'<br />ERROR in testRender<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetActive<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>combobox_test.html</td><td>Fail</td><td> 0 passed, 10 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.TagName');
  goog.require('goog.dom.classes');
  goog.require('goog.events');
  goog.require('goog.events.KeyCodes');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.ComboBox');



var comboBox;
var input;

function setUp() {
  goog.dom.getElement('combo').innerHTML = '';

  comboBox = new goog.ui.ComboBox();
  comboBox.setDefaultText('Select a color...');
  comboBox.addItem(new goog.ui.ComboBoxItem('Red'));
  comboBox.addItem(new goog.ui.ComboBoxItem('Maroon'));
  comboBox.addItem(new goog.ui.ComboBoxItem('Gre&lt;en'));
  comboBox.addItem(new goog.ui.ComboBoxItem('Blue', 'Blue&gt;Data'));
  comboBox.addItem(new goog.ui.ComboBoxItem('Royal Blue'));
  comboBox.addItem(new goog.ui.ComboBoxItem('Yellow'));
  comboBox.addItem(new goog.ui.ComboBoxItem('Magenta'));
  comboBox.addItem(new goog.ui.ComboBoxItem('Mouve'));
  comboBox.addItem(new goog.ui.ComboBoxItem('Grey'));
  comboBox.render(goog.dom.getElement('combo'));

  input = comboBox.getElement().getElementsByTagName(
      goog.dom.TagName.INPUT)[0];
}

function tearDown() {
  comboBox.dispose();
  goog.events.removeAll();
}

function testGetMenu() {
  assertTrue('Menu should be instance of goog.ui.Menu',
      comboBox.getMenu() instanceof goog.ui.Menu);
  assertEquals('Menu should have correct number of children',
      9, comboBox.getMenu().getChildCount());
}

function testMenuBeginsInvisible() {
  assertFalse('Menu should begin invisible', comboBox.getMenu().isVisible());
}

function testClickCausesPopup() {
  goog.testing.events.fireClickSequence(input);
  assertTrue('Menu becomes visible after click',
      comboBox.getMenu().isVisible());
}

function testUpKeyCausesPopup() {
  goog.testing.events.fireKeySequence(input, goog.events.KeyCodes.UP);
  assertTrue('Menu becomes visible after UP key',
      comboBox.getMenu().isVisible());
}

function testActionSelectsItem() {
  comboBox.getMenu().getItemAt(2).dispatchEvent(
      goog.ui.Component.EventType.ACTION);
  assertEquals('Gre<en', input.value);
}

function testActionSelectsItemWithData() {
  comboBox.getMenu().getItemAt(3).dispatchEvent(
      goog.ui.Component.EventType.ACTION);
      assertEquals('Blue>Data', input.value);
}

function testRedisplayMenuAfterBackspace() {
  input.value = 'mx';
  comboBox.onInputChange_();
  input.value = 'm';
  comboBox.onInputChange_();
  assertEquals('Three items should be displayed',
      3, comboBox.getNumberOfVisibleItems_());
}

function testExternallyCreatedMenu() {
  var menu = new goog.ui.Menu();
  menu.decorate(goog.dom.getElement('menu'));
  assertTrue('Menu items should be instances of goog.ui.ComboBoxItem',
      menu.getChildAt(0) instanceof goog.ui.ComboBoxItem);

  comboBox = new goog.ui.ComboBox(null, menu);
  comboBox.render(goog.dom.getElement('combo'));

  input = comboBox.getElement().getElementsByTagName(
      goog.dom.TagName.INPUT)[0];
  menu.getItemAt(2).dispatchEvent(
      goog.ui.Component.EventType.ACTION);
  assertEquals('Blue', input.value);
}

function testRecomputeVisibleCountAfterChangingItems() {
  input.value = 'Black';
  comboBox.onInputChange_();
  assertEquals('No items should be displayed',
      0, comboBox.getNumberOfVisibleItems_());
  comboBox.addItem(new goog.ui.ComboBoxItem('Black'));
  assertEquals('One item should be displayed',
      1, comboBox.getNumberOfVisibleItems_());

  input.value = 'Red';
  comboBox.onInputChange_();
  assertEquals('One item should be displayed',
      1, comboBox.getNumberOfVisibleItems_());
  comboBox.removeItemAt(0);  // Red
  assertEquals('No items should be displayed',
      0, comboBox.getNumberOfVisibleItems_());  
}

function testSetEnabled() {
  // By default, everything should be enabled.
  assertFalse('Text input should initially not be disabled', input.disabled);
  assertFalse('Text input should initially not look disabled',
      goog.dom.classes.has(input,
      goog.getCssName(goog.ui.LabelInput.prototype.LABEL_CLASS_NAME,
          'disabled')));
  assertFalse('Combo box should initially not look disabled',
      goog.dom.classes.has(comboBox.getElement(),
      goog.getCssName('goog-combobox-disabled')));
  goog.testing.events.fireClickSequence(comboBox.getElement());
  assertTrue('Menu initially becomes visible after click',
      comboBox.getMenu().isVisible());
  goog.testing.events.fireClickSequence(document);
  assertFalse('Menu initially becomes invisible after document click',
      comboBox.getMenu().isVisible());

  comboBox.setEnabled(false);
  assertTrue('Text input should be disabled after being disabled',
      input.disabled);
  assertTrue('Text input should appear disabled after being disabled',
      goog.dom.classes.has(input,
      goog.getCssName(goog.ui.LabelInput.prototype.LABEL_CLASS_NAME,
          'disabled')));
  assertTrue('Combo box should appear disabled after being disabled',
      goog.dom.classes.has(comboBox.getElement(),
      goog.getCssName('goog-combobox-disabled')));
  goog.testing.events.fireClickSequence(comboBox.getElement());
  assertFalse('Menu should not become visible after click if disabled',
      comboBox.getMenu().isVisible());

  comboBox.setEnabled(true);
  assertFalse('Text input should not be disabled after being re-enabled',
      input.disabled);
  assertFalse('Text input should not appear disabled after being re-enabled',
      goog.dom.classes.has(input,
      goog.getCssName(goog.ui.LabelInput.prototype.LABEL_CLASS_NAME,
          'disabled')));
  assertFalse('Combo box should not appear disabled after being re-enabled',
      goog.dom.classes.has(comboBox.getElement(),
      goog.getCssName('goog-combobox-disabled')));
  goog.testing.events.fireClickSequence(comboBox.getElement());
  assertTrue('Menu becomes visible after click when re-enabled',
      comboBox.getMenu().isVisible());
  goog.testing.events.fireClickSequence(document);
  assertFalse('Menu becomes invisible after document click when re-enabled',
      comboBox.getMenu().isVisible());
}

">10 of 10 tests run in 27ms.<br />0 passed, 10 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testActionSelectsItem<br />Object #<Object> has no method 'createElement'<br />ERROR in testActionSelectsItemWithData<br />Object #<Object> has no method 'createElement'<br />ERROR in testClickCausesPopup<br />Object #<Object> has no method 'createElement'<br />ERROR in testExternallyCreatedMenu<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetMenu<br />Object #<Object> has no method 'createElement'<br />ERROR in testMenuBeginsInvisible<br />Object #<Object> has no method 'createElement'<br />ERROR in testRecomputeVisibleCountAfterChangingItems<br />Object #<Object> has no method 'createElement'<br />ERROR in testRedisplayMenuAfterBackspace<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetEnabled<br />Object #<Object> has no method 'createElement'<br />ERROR in testUpKeyCausesPopup<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>textarea_test.html</td><td>Fail</td><td> undefined</td><td title="

    goog.require('goog.dom');
    goog.require('goog.dom.classes');
    goog.require('goog.debug.DivConsole');
    goog.require('goog.debug.LogManager');
    goog.require('goog.debug.Logger');
    goog.require('goog.events');
    goog.require('goog.testing.ExpectedFailures');
    goog.require('goog.testing.events');
    goog.require('goog.testing.jsunit');
    goog.require('goog.object');
    goog.require('goog.ui.Control');
    goog.require('goog.ui.ControlRenderer');
    goog.require('goog.ui.Textarea');
    goog.require('goog.ui.TextareaRenderer');
    goog.require('goog.userAgent');
    goog.require('goog.userAgent.product');
    goog.require('goog.userAgent.product.isVersion');
  

    var sandbox = goog.dom.getElement('sandbox');
    var textarea;
    var demoTextareaElement = goog.dom.getElement('demo-textarea');
    var expectedFailures = new goog.testing.ExpectedFailures();

    function setUp() {
      textarea = new goog.ui.Textarea();
    }

    function tearDown() {
      expectedFailures.handleTearDown();
      textarea.dispose();
      goog.dom.removeChildren(sandbox);
    }

    /**
     * @return {boolean} Whether we're on Mac Safari 3.x.
     */
    function isMacSafari3() {
      return goog.userAgent.WEBKIT && goog.userAgent.MAC &&
          !goog.userAgent.isVersion('527');
    }

    /**
     * @return {boolean} Whether we're on Linux Firefox 3.6.3.
     */
    function isLinuxFirefox363() {
      return goog.userAgent.product.FIREFOX && goog.userAgent.LINUX &&
          goog.userAgent.product.isVersion('3.6.3') &&
          !goog.userAgent.product.isVersion('3.6.4');
    }

    /**
     * @return {boolean} Whether we're on Firefox 3.0.
     */
    function isFirefox3() {
      return goog.userAgent.GECKO &&
          !goog.userAgent.isVersion('1.9.1');
    }

    function testConstructor() {
      assertNotNull('Textarea must not be null', textarea);
      assertEquals('Renderer must default to expected value',
          goog.ui.TextareaRenderer.getInstance(), textarea.getRenderer());

      var fakeDomHelper = {
        'getDocument': function() { return true; }
      };
      var testTextarea = new goog.ui.Textarea('Hello',
          goog.ui.TextareaRenderer.getInstance(), fakeDomHelper);
      assertEquals('Content must have expected content', 'Hello',
          testTextarea.getContent());
      assertEquals('Renderer must have expected value',
          goog.ui.TextareaRenderer.getInstance(), testTextarea.getRenderer());
      assertEquals('DOM helper must have expected value', fakeDomHelper,
          testTextarea.getDomHelper());
      testTextarea.dispose();
    }

    function testConstructorWithDecorator() {
      var decoratedTextarea = new goog.ui.Textarea();
      decoratedTextarea.decorate(demoTextareaElement);
      assertEquals('Textarea should have current content after decoration',
          'Foo', decoratedTextarea.getContent());
      var initialHeight = decoratedTextarea.getHeight_();
      var initialOffsetHeight = decoratedTextarea.getElement().offsetHeight;
      // focus() will trigger the grow/shrink flow.
      decoratedTextarea.getElement().focus();
      assertEquals('Height should not have changed without content change',
           initialHeight, decoratedTextarea.getHeight_());
      assertEquals('offsetHeight should not have changed without content ' +
          'change', initialOffsetHeight,
          decoratedTextarea.getElement().offsetHeight);
      decoratedTextarea.dispose();
    }

    function testGetSetContent() {
      textarea.render(sandbox);
      assertEquals('Textarea\'s content must default to an empty string',
          '', textarea.getContent());
      textarea.setContent(17);
      assertEquals('Textarea element must have expected content', '17',
          textarea.getElement().value);
      textarea.setContent('foo');
      assertEquals('Textarea element must have updated content', 'foo',
          textarea.getElement().value);
    }

    function testGetSetValue() {
      textarea.render(sandbox);
      assertEquals('Textarea\'s content must default to an empty string',
          '', textarea.getValue());
      textarea.setValue(17);
      assertEquals('Textarea element must have expected content', '17',
          textarea.getValue());
      textarea.setValue('17');
      assertEquals('Textarea element must have expected content', '17',
          textarea.getValue());
    }

    function testBasicTextareaBehavior() {
      textarea.render(sandbox);
      var el = textarea.getElement();
      var heightBefore = textarea.getHeight_();
      textarea.setContent('Lorem ipsum dolor sit amet, consectetuer ' +
          'elit. Aenean sollicitudin ultrices urna. Proin vehicula mauris ac ' +
          'est. Ut scelerisque, risus ut facilisis dictum, est massa lacinia ' +
          'lorem, in fermentum purus ligula quis nunc.');
      var heightAfter = textarea.getHeight_();
      assertTrue('With this much content, height should have grown.',
          heightAfter > heightBefore);

      textarea.setContent('');
      heightAfter = textarea.getHeight_();
      assertTrue('Textarea should shrink with no content.',
          heightAfter <= heightBefore);
    }

    function testGetHorizontalScrollBarHeight() {
      textarea.render(sandbox);
      var textareaEl = textarea.getElement();
      var scrollHeightWithoutScrollBar = textareaEl.scrollHeight;
      var withoutScrollBarHeight =
          textarea.getHorizontalScrollBarHeight_();
      assertEquals('ScrollbarHeight should be 0 with no scrollbar.',
          0, withoutScrollBarHeight);

      textarea.setContent('Onereallylongstringoftextlongenoughto' +
          'justifyascrollbar');
      textarea.getElement().style.overflow = 'scroll';
      textarea.getElement().style.overflowX = 'scroll';
      var scrollBarHeight =
          textarea.getHorizontalScrollBarHeight_();
      var scrollHeight = textareaEl.scrollHeight;

      // Opera & Safari3 include scrollbars in scrollHeight.
      expectedFailures.expectFailureFor(goog.userAgent.OPERA ||
          isMacSafari3() || isFirefox3());
      try {
        assertTrue('ScrollbarHeight should be something > 0 (it is ' +
          scrollBarHeight + ') and isFirefox3():' + isFirefox3() + ', ' +
          goog.userAgent.VERSION, scrollBarHeight > 0);
      } catch (e) {
        expectedFailures.handleException(e);
      }
    }

    function testMinHeight() {
      textarea.render(sandbox);
      textarea.setMinHeight(50);
      assertEquals('offsetHeight should be 50 initially', 50,
          textarea.getElement().offsetHeight);
      textarea.setContent('Lorem ipsum dolor sit amet, consectetuer  ' +
          'elit. Aenean sollicitudin ultrices urna. Proin vehicula mauris ac ' +
          'est. Ut scelerisque, risus ut facilisis dictum, est massa lacinia ' +
          'lorem, in fermentum purus ligula quis nunc.');
      assertTrue('getHeight_() should be > 50',
          textarea.getHeight_() > 50);

      textarea.setContent('');
      assertEquals('With no content, offsetHeight should go back to 50, ' +
          'the minHeight.', 50, textarea.getElement().offsetHeight);

      expectedFailures.expectFailureFor(isMacSafari3());
      try {
        textarea.setMinHeight(0);
        assertTrue('After setting minHeight to 0, offsetHeight should ' +
            'now be < 50, but it is ' + textarea.getElement().offsetHeight,
            textarea.getElement().offsetHeight < 50);
      } catch (e) {
        expectedFailures.handleException(e);
      }
    }

    function testMouseUpListener() {
      textarea.render(sandbox);
      textarea.setMinHeight(100);
      textarea.setMaxHeight(200);
      textarea.mouseUpListener_({});
      assertEquals('After a mouseup which is not a resize, minHeight should ' +
          'still be 100', 100, textarea.minHeight_);

      // We need to test how CSS drop shadows effect this too.
      goog.dom.classes.add(textarea.getElement(), 'drop-shadowed');
      textarea.mouseUpListener_({});
      assertEquals('After a mouseup which is not a resize, minHeight should ' +
          'still be 100 even with a shadow', 100, textarea.minHeight_);

    }

    function testMaxHeight() {
      textarea.render(sandbox);
      textarea.setMaxHeight(50);
      assertTrue('Initial offsetHeight should be less than 50',
          textarea.getElement().offsetHeight < 50);
      var newContent = 'Lorem ipsum dolor sit amet, consectetuer adipiscing ' +
          'elit. Aenean sollicitudin ultrices urna. Proin vehicula mauris ac ' +
          'est. Ut scelerisque, risus ut facilisis dictum, est massa lacinia ' +
          'lorem, in fermentum purus ligula quis nunc.'
      textarea.setContent(newContent);

      assertTrue('With lots of content, getHeight_() should be > 50',
          textarea.getHeight_() > 50);
      assertEquals('Even with lots of content, offsetHeight should be 50 ' +
          'with maxHeight set', 50, textarea.getElement().offsetHeight);
      textarea.setMaxHeight(0);
      assertTrue('After setting maxHeight to 0, offsetHeight should now ' +
          'be > 50', textarea.getElement().offsetHeight > 50);
    }

    function testMinAndMaxHeight() {
      textarea.render(sandbox);
      textarea.setMinHeight(50);
      textarea.setMaxHeight(150);
      assertEquals('offsetHeight should be 50 initially', 50,
          textarea.getElement().offsetHeight);

      textarea.setContent('Lorem ipsum dolor sit amet, consectetuer  ' +
          'elit. Aenean sollicitudin ultrices urna. Proin vehicula mauris ac ' +
          'est. Ut scelerisque, risus ut facilisis dictum, est massa lacinia ' +
          'lorem, in fermentum purus ligula quis nunc.');


      var height = textarea.getHeight_();
      // For some reason Mac Safari 3 has 136 and Linux FF 3.6.3 has 146 here.
      expectedFailures.expectFailureFor(isMacSafari3() || isLinuxFirefox363());
      try {
        assertTrue('With lots of content, getHeight_() should be > 150 ' +
          '(it is ' + height + ')', height > 150);
        assertEquals('Even with lots of content, offsetHeight should be 150 ' +
            'with maxHeight set', 150,
            textarea.getElement().offsetHeight);

        textarea.setMaxHeight(0);
        assertTrue('After setting maxHeight to 0, offsetHeight should now ' +
            'be > 150 (it is ' + textarea.getElement().offsetHeight + ')',
            textarea.getElement().offsetHeight > 150);

        textarea.setContent('');
        textarea.setMinHeight(0);
        assertTrue('After setting minHeight to 0, with no contents, ' +
            'offsetHeight should now be < 50',
            textarea.getElement().offsetHeight < 50);
      } catch (e) {
        expectedFailures.handleException(e);
      }
    }

  ">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:25:28
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>arraymatcher_test.html</td><td>Success</td><td> 9 passed, 0 failed.</td><td title="

  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.AutoComplete.ArrayMatcher');



// TODO(user): Add more useful tests for the similarity matching.

var ArrayMatcher = goog.ui.AutoComplete.ArrayMatcher;

function testRequestingRows() {
  var items = ['a', 'Ab', 'abc', 'ba', 'ca'];
  var am = new ArrayMatcher(items, true);

  function matcher(token, matches) {
    assertEquals('a', token);
    assertEquals('Should have three matches', 3, matches.length);
    assertEquals('a', matches[0]);
    assertEquals('Ab', matches[1]);
    assertEquals('abc', matches[2]);
  }

  am.requestMatchingRows('a', 10, matcher);
}

function testRequestingRowsMaxMatches() {
  var items = ['a', 'Ab', 'abc', 'ba', 'ca'];
  var am = new ArrayMatcher(items, true);

  function matcher(token, matches) {
    assertEquals('a', token);
    assertEquals('Should have two matches', 2, matches.length);
    assertEquals('a', matches[0]);
    assertEquals('Ab', matches[1]);
  }

  am.requestMatchingRows('a', 2, matcher);
}

function testRequestingRowsSimilarMatches() {
  // No prefix matches so use similar
  var items = ['b', 'c', 'ba', 'ca'];
  var am = new ArrayMatcher(items, false);

  function matcher(token, matches) {
    assertEquals('a', token);
    assertEquals('Should have two matches', 2, matches.length);
    assertEquals('ba', matches[0]);
    assertEquals('ca', matches[1]);
  }

  am.requestMatchingRows('a', 10, matcher);
}

function testRequestingRowsSimilarMatchesMaxMatches() {
  // No prefix matches so use similar
  var items = ['b', 'c', 'ba', 'ca'];
  var am = new ArrayMatcher(items, false);

  function matcher(token, matches) {
    assertEquals('a', token);
    assertEquals('Should have one match', 1, matches.length);
    assertEquals('ba', matches[0]);
  }

  am.requestMatchingRows('a', 1, matcher);
}

function testGetPrefixMatches() {
  var items = ['a', 'b', 'c'];
  var am = new ArrayMatcher(items, true);

  var res = am.getPrefixMatches('a', 10);
  assertEquals('Should have one match', 1, res.length);
  assertEquals('Should return \'a\'', 'a', res[0]);
}

function testGetPrefixMatchesMaxMatches() {
  var items = ['a', 'Ab', 'abc', 'ba', 'ca'];
  var am = new ArrayMatcher(items, true);

  var res = am.getPrefixMatches('a', 2);
  assertEquals('Should have two matches', 2, res.length);
  assertEquals('a', res[0]);
}

function testGetPrefixMatchesEmptyToken() {
  var items = ['a', 'b', 'c'];
  var am = new ArrayMatcher(items, true);

  var res = am.getPrefixMatches('', 10);
  assertEquals('Should have no matches', 0, res.length);
}

function testGetSimilarRows() {
  var items = ['xa', 'xb', 'xc'];
  var am = new ArrayMatcher(items, true);

  var res = am.getSimilarRows('a', 10);
  assertEquals('Should have one match', 1, res.length);
  assertEquals('xa', res[0]);
}

function testGetSimilarRowsMaxMatches() {
  var items = ['xa', 'xAa', 'xaAa'];
  var am = new ArrayMatcher(items, true);

  var res = am.getSimilarRows('a', 2);
  assertEquals('Should have two matches', 2, res.length);
  assertEquals('xa', res[0]);
  assertEquals('xAa', res[1]);
}

">n/a</td></tr>
<tr><td>basic_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.MockClock');
  goog.require('goog.ui.AutoComplete.Basic');


var autocomplete;
var data = ['ab', 'aab', 'aaab'];
var input;
var mockClock;

function setUpPage() {
  new goog.ui.AutoComplete.Basic(data, goog.dom.getElement('user'), true,
      false);
}

function setUp() {
  mockClock = new goog.testing.MockClock(true);
  input = goog.dom.getElement('input');
  input.value = '';
  autocomplete = new goog.ui.AutoComplete.Basic(data, input, true, false);
}

function tearDown() {
  autocomplete.dispose();
  mockClock.dispose();
}

//=========================================================================
// Utility methods

/**
 * Fire listeners of a given type that are listening to the event's
 * currentTarget.
 *
 * @param {goog.eventsBrowserEvent} event
 */
function simulateEvent(event) {
  goog.events.fireListeners(
      event.currentTarget, event.type, true, event);
  goog.events.fireListeners(
      event.currentTarget, event.type, false, event);
}

/**
 * Fire all key event listeners that are listening to the input element.
 *
 * @param {number} keyCode The key code.
 */
function simulateAllKeyEventsOnInput(keyCode) {
  var eventTypes = [
      goog.events.EventType.KEYDOWN,
      goog.events.EventType.KEYPRESS,
      goog.events.EventType.KEYUP
  ];

  goog.array.forEach(eventTypes,
      function(type) {
        var event = new goog.events.Event(type, input);
        event.keyCode = keyCode;
        simulateEvent(new goog.events.BrowserEvent(event, input));
      });
}

/**
 * @param {string} text
 * @return {Node} Node whose inner text maches the given text.
 */
function findNodeByInnerText(text) {
  return goog.dom.findNode(document.body,
      function(node) {
	try {
          var display = goog.userAgent.IE ?
            goog.style.getCascadedStyle(node, 'display') :
            goog.style.getComputedStyle(node, 'display');

	  return goog.dom.getRawTextContent(node) == text &&
	      'none' != display && node.nodeType == goog.dom.NodeType.ELEMENT;
	} catch (e) {
	  return false;
	}
      });
};

//=========================================================================
// Tests

/**
 * Ensure that the display of the autocompleter works.
 */
function testBasicDisplay() {
  simulateAllKeyEventsOnInput(goog.events.KeyCodes.DOWN);

  input.value = 'a';
  simulateAllKeyEventsOnInput(goog.events.KeyCodes.A);
  mockClock.tick(500);

  var nodes = [
      findNodeByInnerText(data[0]),
      findNodeByInnerText(data[1]),
      findNodeByInnerText(data[2])
  ];
  assert(!!nodes[0]);
  assert(!!nodes[1]);
  assert(!!nodes[2]);
  assert(goog.style.isUnselectable(nodes[0]));
  assert(goog.style.isUnselectable(nodes[1]));
  assert(goog.style.isUnselectable(nodes[2]));

  input.value = 'aa';
  simulateAllKeyEventsOnInput(goog.events.KeyCodes.A);
  mockClock.tick(500);

  assertFalse(!!findNodeByInnerText(data[0]));
  assert(!!findNodeByInnerText(data[1]));
  assert(!!findNodeByInnerText(data[2]));
}

/**
 * Ensure that key navigation with multiple inputs work
 */
function testKeyNavigation() {
  simulateAllKeyEventsOnInput(goog.events.KeyCodes.DOWN);

  input.value = 'c, a';
  goog.dom.selection.setCursorPosition(input, 'c, a'.length);
  simulateAllKeyEventsOnInput(goog.events.KeyCodes.A);
  mockClock.tick(500);

  assert(document.body.innerHTML, !!findNodeByInnerText(data[1]));
  assert(!!findNodeByInnerText(data[2]));

  var selected = findNodeByInnerText(data[0]);
  assert(!!selected);
  assertTrue('Should have new standard active class',
      goog.dom.classes.has(selected, 'ac-active'));
  assertTrue('Should have legacy active class',
      goog.dom.classes.has(selected, 'active'));

  simulateAllKeyEventsOnInput(goog.events.KeyCodes.DOWN);
  assertFalse(goog.dom.classes.has(
                  findNodeByInnerText(data[0]), 'ac-active'));
  assert(goog.dom.classes.has(
             findNodeByInnerText(data[1]), 'ac-active'));

  simulateAllKeyEventsOnInput(goog.events.KeyCodes.ENTER);
  assertEquals('c, aab, ', input.value);
};

/**
 * Ensure that mouse navigation with multiple inputs works.
 */
function testMouseNavigation() {
  simulateAllKeyEventsOnInput(goog.events.KeyCodes.DOWN);

  input.value = 'c, a';
  goog.dom.selection.setCursorPosition(input, 'c, a'.length);
  simulateAllKeyEventsOnInput(goog.events.KeyCodes.A);
  mockClock.tick(500);

  var secondOption = findNodeByInnerText(data[1]);
  assert(!!secondOption);
  var parent = secondOption.parentNode;
  assertFalse(goog.dom.classes.has(secondOption, 'ac-active'));

  var mouseOver = new goog.events.Event(
      goog.events.EventType.MOUSEOVER, secondOption);
  simulateEvent(new goog.events.BrowserEvent(mouseOver, parent));
  assert(goog.dom.classes.has(secondOption, 'ac-active'));

  var mouseDown = new goog.events.Event(
      goog.events.EventType.MOUSEDOWN, secondOption);
  simulateEvent(new goog.events.BrowserEvent(mouseDown, parent));
  var mouseClick = new goog.events.Event(
      goog.events.EventType.CLICK, secondOption);
  simulateEvent(new goog.events.BrowserEvent(mouseClick, parent));

  assertEquals('c, aab, ', input.value);
}

">TypeError: Object #<Object> has no method 'setAttribute'
    at Object.setState (dom/a11y.js:392:11)
    at [object Object].attachInput (ui/autocomplete/inputhandler.js:414:17)
    at [object Object].attachInputs (ui/autocomplete/inputhandler.js:450:10)
    at new <anonymous> (ui/autocomplete/basic.js:51:16)
    at [object Object].setUpPage (_tmpclosuretest.js:14:49)
    at [object Object].runTests (testing/testcase.js:487:8)
    at [object Object].execute (testing/testrunner.js:266:17)
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:429:6)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
</td></tr>
<tr><td>autocomplete_test.html</td><td>Fail</td><td> 0 passed, 13 failed.</td><td title="

  goog.require('goog.dom.a11y');
  goog.require('goog.dom.a11y.Role');
  goog.require('goog.dom.a11y.State');
  goog.require('goog.events.EventTarget');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.AutoComplete');
  goog.require('goog.ui.AutoComplete.Renderer');
  goog.require('goog.string');



/**
 * Mock DataStore
 */
function MockDS() {
  this.rows_ = [
    '"Slartibartfast Theadore" <fjordmaster@magrathea.com>',
    '"Zaphod Beeblebrox" <theprez@universe.gov>',
    '"Ford Prefect" <ford@theguide.com>',
    '"Arthur Dent" <has.no.tea@gmail.com>',
    '"Marvin The Paranoid Android" <marv@googlemail.com>',
    'the.mice@magrathea.com',
    'the.mice@myotherdomain.com'
  ];
}

MockDS.prototype.requestMatchingRows = function(token, maxMatches,
                                                matchHandler) {
  var escapedToken = goog.string.regExpEscape(token);
  var matcher = new RegExp('(^|\\W+)' + escapedToken);
  var matches = [];
  for (var i = 0; i < this.rows_.length && matches.length < maxMatches; ++i) {
    var row = this.rows_[i];
    if (row.match(matcher)) {
      matches.push(row);
    }
  }
  matchHandler(token, matches);
};


/**
 * Mock Selection Handler
 */

function MockSelect() {
};
goog.inherits(MockSelect, goog.events.EventTarget);

MockSelect.prototype.selectRow = function(row) {
  this.selectedRow = row;
};


/**
 * Renderer subclass that exposes additional private members for testing.
 */
function TestRend() {
  goog.ui.AutoComplete.Renderer.call(this);
}
goog.inherits(TestRend, goog.ui.AutoComplete.Renderer);

TestRend.prototype.getRenderedRows = function() {
  return this.rows_;
};

TestRend.prototype.getHilitedRowIndex = function() {
  return this.hilitedRow_;
};

TestRend.prototype.getHilitedRowDiv = function() {
  return this.rowDivs_[this.hilitedRow_];
};

/**
 * Make sure results are truncated (or not) by setMaxMatches.
 */
function testMaxMatches() {
  var ds = new MockDS();
  var rend = new TestRend();
  var select = new MockSelect();
  var ac = new goog.ui.AutoComplete(ds, rend, select);

  ac.setMaxMatches(2);
  ac.setToken('the');
  assertEquals(2, rend.getRenderedRows().length);
  ac.setToken('');

  ac.setMaxMatches(3);
  ac.setToken('the');
  assertEquals(3, rend.getRenderedRows().length);
  ac.setToken('');

  ac.setMaxMatches(1000);
  ac.setToken('the');
  assertEquals(4, rend.getRenderedRows().length);
  ac.setToken('');
}

function checkHilitedIndex(renderer, index) {
  assertEquals(index, renderer.getHilitedRowIndex());
}

function testGetRowCount() {
  var ds = new MockDS();
  var rend = new TestRend();
  var select = new MockSelect();
  var ac = new goog.ui.AutoComplete(ds, rend, select);
  assertEquals(0, ac.getRowCount());

  ac.setToken('Zaphod');
  assertEquals(1, ac.getRowCount());

  ac.setMaxMatches(2);
  ac.setToken('the');
  assertEquals(2, ac.getRowCount());
}

/**
 * Try using next and prev to navigate past the ends with default behavior of
 * allowFreeSelect_ and wrap_.
 */
function testHiliteNextPrev_default() {
  var ds = new MockDS();
  var rend = new TestRend();
  var select = new MockSelect();
  var ac = new goog.ui.AutoComplete(ds, rend, select);

  // make sure 'next' and 'prev' don't explode before any token is set
  ac.hiliteNext();
  ac.hilitePrev();
  ac.setMaxMatches(4);
  assertEquals(0, rend.getRenderedRows().length);

  // check a few times
  for (var i = 0; i < 3; ++i) {
    ac.setToken('');
    ac.setToken('the');
    assertEquals(4, rend.getRenderedRows().length);
    // check to see if we can select the last of the 4 items
    checkHilitedIndex(rend, 0);
    ac.hiliteNext();
    checkHilitedIndex(rend, 1);
    ac.hiliteNext();
    checkHilitedIndex(rend, 2);
    ac.hiliteNext();
    checkHilitedIndex(rend, 3);
    // try going over the edge
    ac.hiliteNext();
    checkHilitedIndex(rend, 3);

    // go back down
    ac.hilitePrev();
    checkHilitedIndex(rend, 2);
    ac.hilitePrev();
    checkHilitedIndex(rend, 1);
    ac.hilitePrev();
    checkHilitedIndex(rend, 0);
    ac.hilitePrev();
    checkHilitedIndex(rend, 0);
  }
}

/**
 * Try using next and prev to navigate past the ends with wrap_ off and
 * allowFreeSelect_ on.
 */
function testHiliteNextPrev_allowFreeSelect() {
  var ds = new MockDS();
  var rend = new TestRend();
  var select = new MockSelect();
  var ac = new goog.ui.AutoComplete(ds, rend, select);
  ac.setAllowFreeSelect(true);

  // make sure 'next' and 'prev' don't explode before any token is set
  ac.hiliteNext();
  ac.hilitePrev();
  ac.setMaxMatches(4);
  assertEquals(0, rend.getRenderedRows().length);

  // check a few times
  for (var i = 0; i < 3; ++i) {
    ac.setToken('');
    ac.setToken('the');
    assertEquals(4, rend.getRenderedRows().length);
    // check to see if we can select the last of the 4 items
    checkHilitedIndex(rend, 0);
    ac.hiliteNext();
    checkHilitedIndex(rend, 1);
    ac.hiliteNext();
    checkHilitedIndex(rend, 2);
    ac.hiliteNext();
    checkHilitedIndex(rend, 3);
    // try going over the edge. Since allowFreeSelect is on, this will
    // deselect the last row.
    ac.hiliteNext();
    checkHilitedIndex(rend, -1);

    // go back down the list
    ac.hiliteNext();
    checkHilitedIndex(rend, 0);
    ac.hiliteNext();
    checkHilitedIndex(rend, 1);

    // go back up the list.
    ac.hilitePrev();
    checkHilitedIndex(rend, 0);
    // go back above the first, deselects first.
    ac.hilitePrev();
    checkHilitedIndex(rend, -1);
  }
}

/**
 * Try using next and prev to navigate past the ends with wrap_ on
 * allowFreeSelect_ off.
 */
function testHiliteNextPrev_wrap() {
  var ds = new MockDS();
  var rend = new TestRend();
  var select = new MockSelect();
  var ac = new goog.ui.AutoComplete(ds, rend, select);
  ac.setWrap(true);

  // make sure 'next' and 'prev' don't explode before any token is set
  ac.hiliteNext();
  ac.hilitePrev();
  ac.setMaxMatches(4);
  assertEquals(0, rend.getRenderedRows().length);

  // check a few times
  for (var i = 0; i < 3; ++i) {
    ac.setToken('');
    ac.setToken('the');
    assertEquals(4, rend.getRenderedRows().length);
    // check to see if we can select the last of the 4 items
    checkHilitedIndex(rend, 0);
    ac.hiliteNext();
    checkHilitedIndex(rend, 1);
    ac.hiliteNext();
    checkHilitedIndex(rend, 2);
    ac.hiliteNext();
    checkHilitedIndex(rend, 3);
    // try going over the edge. Since wrap is on, this will go back to 0.
    ac.hiliteNext();
    checkHilitedIndex(rend, 0);

    // go back down the list
    ac.hiliteNext();
    checkHilitedIndex(rend, 1);

    // go back up the list.
    ac.hilitePrev();
    checkHilitedIndex(rend, 0);
    // go back above the first, selects last.
    ac.hilitePrev();
    checkHilitedIndex(rend, 3);
  }
}

/**
 * Try using next and prev to navigate past the ends with wrap_ on
 * allowFreeSelect_ on.
 */
function testHiliteNextPrev_wrapAndAllowFreeSelect() {
  var ds = new MockDS();
  var rend = new TestRend();
  var select = new MockSelect();
  var ac = new goog.ui.AutoComplete(ds, rend, select);
  ac.setWrap(true);
  ac.setAllowFreeSelect(true);

  // make sure 'next' and 'prev' don't explode before any token is set
  ac.hiliteNext();
  ac.hilitePrev();
  ac.setMaxMatches(4);
  assertEquals(0, rend.getRenderedRows().length);

  // check a few times
  for (var i = 0; i < 3; ++i) {
    ac.setToken('');
    ac.setToken('the');
    assertEquals(4, rend.getRenderedRows().length);
    // check to see if we can select the last of the 4 items
    checkHilitedIndex(rend, 0);
    ac.hiliteNext();
    checkHilitedIndex(rend, 1);
    ac.hiliteNext();
    checkHilitedIndex(rend, 2);
    ac.hiliteNext();
    checkHilitedIndex(rend, 3);
    // try going over the edge. Since free select is on, this should go
    // to -1.
    ac.hiliteNext();
    checkHilitedIndex(rend, -1);

    // go back down the list
    ac.hiliteNext();
    checkHilitedIndex(rend, 0);
    ac.hiliteNext();
    checkHilitedIndex(rend, 1);

    // go back up the list.
    ac.hilitePrev();
    checkHilitedIndex(rend, 0);
    // go back above the first, free select.
    ac.hilitePrev();
    checkHilitedIndex(rend, -1);
    // wrap to last
    ac.hilitePrev();
    checkHilitedIndex(rend, 3);
  }
}

/**
 * Try using next and prev to navigate past the ends with wrap_ on
 * allowFreeSelect_ on AND turn autoHilite_ off.
 */
function testHiliteNextPrev_wrapAndAllowFreeSelectNoAutoHilite() {
  var ds = new MockDS();
  var rend = new TestRend();
  var select = new MockSelect();
  var ac = new goog.ui.AutoComplete(ds, rend, select);
  ac.setWrap(true);
  ac.setAllowFreeSelect(true);
  ac.setAutoHilite(false);

  // make sure 'next' and 'prev' don't explode before any token is set
  ac.hiliteNext();
  ac.hilitePrev();
  ac.setMaxMatches(4);
  assertEquals(0, rend.getRenderedRows().length);

  // check a few times
  for (var i = 0; i < 3; ++i) {
    ac.setToken('');
    ac.setToken('the');
    assertEquals(4, rend.getRenderedRows().length);
    // check to see if we can select the last of the 4 items.
    // Initially nothing should be selected since autoHilite_ is off.
    checkHilitedIndex(rend, -1);
    ac.hilitePrev();
    checkHilitedIndex(rend, 3);
    ac.hiliteNext();
    checkHilitedIndex(rend, -1);
    ac.hiliteNext();
    checkHilitedIndex(rend, 0);
    ac.hiliteNext();
    checkHilitedIndex(rend, 1);
    ac.hiliteNext();
    checkHilitedIndex(rend, 2);
    ac.hiliteNext();
    checkHilitedIndex(rend, 3);
    // try going over the edge. Since free select is on, this should go
    // to -1.
    ac.hiliteNext();
    checkHilitedIndex(rend, -1);

    // go back down the list
    ac.hiliteNext();
    checkHilitedIndex(rend, 0);
    ac.hiliteNext();
    checkHilitedIndex(rend, 1);

    // go back up the list.
    ac.hilitePrev();
    checkHilitedIndex(rend, 0);
    // go back above the first, free select.
    ac.hilitePrev();
    checkHilitedIndex(rend, -1);
    // wrap to last
    ac.hilitePrev();
    checkHilitedIndex(rend, 3);
  }
}

/**
 * Checks that autohilite is disabled when there is no token; this allows the
 * user to tab out of an empty autocomplete.
 */
function testNoAutoHiliteWhenTokenIsEmpty() {
  var ds = new MockDS();
  var rend = new TestRend();
  var select = new MockSelect();
  var ac = new goog.ui.AutoComplete(ds, rend, select);
  ac.setWrap(true);
  ac.setAllowFreeSelect(true);
  ac.setAutoHilite(true);
  ac.setMaxMatches(4);

  ac.setToken('');
  assertEquals(4, rend.getRenderedRows().length);
  // No token; nothing should be hilited.
  checkHilitedIndex(rend, -1);

  ac.setToken('the');
  assertEquals(4, rend.getRenderedRows().length);
  // Now there is a token, so the first row should be highlighted.
  checkHilitedIndex(rend, 0);
}

/**
 * Hilite using ids, the way mouse-based hiliting would work.
 */
function testHiliteId() {
  var ds = new MockDS();
  var rend = new TestRend();
  var select = new MockSelect();
  var ac = new goog.ui.AutoComplete(ds, rend, select);

  // check a few times
  for (var i = 0; i < 3; ++i) {
    ac.setToken('m');
    assertEquals(4, rend.getRenderedRows().length);
    // try hiliting all 3
    for (var x = 0; x < 4; ++x) {
      var id = rend.getRenderedRows()[x].id;
      ac.hiliteId(id);
      assertEquals(ac.getIdOfIndex_(x), id);
    }
  }
}

/**
 * Test selecting the hilited row
 */
function testSelection() {
  var ds = new MockDS();
  var rend = new TestRend();
  var select = new MockSelect();
  var ac;

  // try with default selection
  ac = new goog.ui.AutoComplete(ds, rend, select);
  ac.setToken('m');
  ac.selectHilited();
  assertEquals('"Slartibartfast Theadore" <fjordmaster@magrathea.com>',
               select.selectedRow);

  // try second item
  ac = new goog.ui.AutoComplete(ds, rend, select);
  ac.setToken('the');
  ac.hiliteNext();
  ac.selectHilited();
  assertEquals('"Ford Prefect" <ford@theguide.com>',
               select.selectedRow);
}

/**
 * Dismiss when empty and non-empty
 */
function testDismiss() {
  var ds = new MockDS();
  var rend = new TestRend();
  var select = new MockSelect();

  // dismiss empty
  var ac = new goog.ui.AutoComplete(ds, rend, select);
  ac.dismiss();

  ac = new goog.ui.AutoComplete(ds, rend, select);
  ac.setToken('sir not seen in this picture');
  ac.dismiss();

  // dismiss with contents
  ac = new goog.ui.AutoComplete(ds, rend, select);
  ac.setToken('t');
  ac.dismiss();
}

function testDispose() {
  var ds = new MockDS();
  var rend = new TestRend();
  var select = new MockSelect();
  var ac = new goog.ui.AutoComplete(ds, rend, select);
  ac.setToken('the');
  ac.dispose();
}

/**
 * Ensure that activedescendant is updated properly.
 */
function testRolesAndStates() {
  function checkActiveDescendant(activeDescendant) {
    assertEquals(
        goog.dom.a11y.getActiveDescendant(someDiv),
        activeDescendant);
  }
  function checkRole(el, role) {
    assertEquals(goog.dom.a11y.getRole(el), role);
  }
  var ds = new MockDS();
  var rend = new TestRend();
  var select = new MockSelect();
  var someDiv = goog.dom.createDom('div', {id: 'someDiv'}, 'DIV');
  var ac = new goog.ui.AutoComplete(ds, rend, select);
  ac.setTarget(someDiv);

  // initially activedescendant is not set
  checkActiveDescendant(null);

  // highlight the matching row and check that activedescendant updates
  ac.setToken('');
  ac.setToken('the');
  ac.hiliteNext();
  checkActiveDescendant(rend.getHilitedRowDiv());

  // highligted row should have a role of 'option'
  checkRole(rend.getHilitedRowDiv(), goog.dom.a11y.Role.OPTION);

  // closing the autocomplete should clear activedescendant
  ac.dismiss();
  checkActiveDescendant(null);
}

">13 of 13 tests run in 31ms.<br />0 passed, 13 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testDismiss<br />Object #<Object> has no method 'createElement'<br />ERROR in testDispose<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetRowCount<br />Object #<Object> has no method 'createElement'<br />ERROR in testHiliteId<br />Object #<Object> has no method 'createElement'<br />ERROR in testHiliteNextPrev_allowFreeSelect<br />Object #<Object> has no method 'createElement'<br />ERROR in testHiliteNextPrev_default<br />Object #<Object> has no method 'createElement'<br />ERROR in testHiliteNextPrev_wrap<br />Object #<Object> has no method 'createElement'<br />ERROR in testHiliteNextPrev_wrapAndAllowFreeSelect<br />Object #<Object> has no method 'createElement'<br />ERROR in testHiliteNextPrev_wrapAndAllowFreeSelectNoAutoHilite<br />Object #<Object> has no method 'createElement'<br />ERROR in testMaxMatches<br />Object #<Object> has no method 'createElement'<br />ERROR in testNoAutoHiliteWhenTokenIsEmpty<br />Object #<Object> has no method 'createElement'<br />ERROR in testRolesAndStates<br />Object #<Object> has no method 'createElement'<br />ERROR in testSelection<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>inputhandler_test.html</td><td>Success</td><td> 17 passed, 0 failed.</td><td title="

  goog.require('goog.events.KeyCodes');
  goog.require('goog.functions');
  goog.require('goog.object');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.MockClock');
  goog.require('goog.ui.AutoComplete.InputHandler');



  /** Mock out the input element. */
  function MockElement() {
    goog.events.EventTarget.call(this);
    this.setAttributeNS = function() {};
    this.setAttribute = function(key, value) { this[key] = value; };
    this.focus = function() {}
    this.blur = function() {}
    this.ownerDocument = document;
  }
  goog.inherits(MockElement, goog.events.EventTarget);


  function MockAutoCompleter() {
    this.setTokenWasCalled = false;
    this.selectHilitedWasCalled = false;
    this.dismissWasCalled = false;
    this.getTarget = function() { return mockElement };
    this.setTarget = function() { };
    this.setToken = function() { this.setTokenWasCalled = true; };
    this.selectHilited = function() {
      this.selectHilitedWasCalled = true;
      return true; // Success.
    };
    this.cancelDelayedDismiss = function() { };
    this.dismissOnDelay = function() {};
    this.dismiss = function() { this.dismissWasCalled = true; };
    this.isOpen = goog.functions.TRUE;
  }

  /**
   * MockInputHandler simulates key events for testing the IME behavior of
   * InputHandler.
   */
  function MockInputHandler() {
    goog.ui.AutoComplete.InputHandler.call(this);

    this.ac_ = new MockAutoCompleter();
    this.cursorPosition_ = 0;

    this.attachInput(mockElement);
  }
  goog.inherits(MockInputHandler, goog.ui.AutoComplete.InputHandler);

  /** Checks for updates to the text area, should not happen during IME. */
  MockInputHandler.prototype.update = function() {
    this.updates++;
  };

  /** Simulates key events. */
  MockInputHandler.prototype.fireKeyEvents = function(
      keyCode, down, press, up, opt_properties) {
    if (down) this.fireEvent('keydown', keyCode, opt_properties);
    if (press) this.fireEvent('keypress', keyCode, opt_properties);
    if (up) this.fireEvent('keyup', keyCode, opt_properties);
  };

  /** Simulates an event. */
  MockInputHandler.prototype.fireEvent = function(
      type, keyCode, opt_properties) {
    var e = {};
    e.type = type;
    e.keyCode = keyCode;
    e.preventDefault = function() {};
    if (!goog.userAgent.IE) {
      e.which = type == 'keydown' ? keyCode : 0;
    }
    if (opt_properties) {
      goog.object.extend(e, opt_properties);
    }
    e = new goog.events.BrowserEvent(e);
    mockElement.dispatchEvent(e);
  };

  MockInputHandler.prototype.setCursorPosition = function(cursorPosition) {
    this.cursorPosition_ = cursorPosition;
  };

  MockInputHandler.prototype.getCursorPosition = function() {
    return this.cursorPosition_;
  };

  // Variables used by all test
  var mh = null;
  var oldMac, oldWin, oldLinux, oldIe, oldFf, oldWebkit, oldVersion;
  var oldUsesKeyDown;
  var mockElement;
  var mockClock;

  function setUp() {
    oldMac = goog.userAgent.MAC;
    oldWin = goog.userAgent.WINDOWS;
    oldLinux = goog.userAgent.LINUX;
    oldIe = goog.userAgent.IE;
    oldFf = goog.userAgent.GECKO;
    oldWebkit = goog.userAgent.WEBKIT;
    oldVersion = goog.userAgent.VERSION;
    oldUsesKeyDown = goog.events.KeyHandler.USES_KEYDOWN_;
    mockClock = new goog.testing.MockClock(true);
    mockElement = new MockElement;
    mh = new MockInputHandler;
  }

  function tearDown() {
    goog.userAgent.MAC = oldMac;
    goog.userAgent.WINDOWS = oldWin;
    goog.userAgent.LINUX = oldLinux;
    goog.userAgent.IE = oldIe;
    goog.userAgent.GECKO = oldFf;
    goog.userAgent.WEBKIT = oldWebkit;
    goog.userAgent.VERSION = oldVersion;
    goog.events.KeyHandler.USES_KEYDOWN_ = oldUsesKeyDown;
    mockClock.dispose();
    mockElement.dispose();
  }

  /** Used to simulate behavior of Windows/Firefox3 */
  function simulateWinFirefox3() {
    goog.userAgent.MAC = false;
    goog.userAgent.WINDOWS = true;
    goog.userAgent.LINUX = false;
    goog.userAgent.IE = false;
    goog.userAgent.GECKO = true;
    goog.userAgent.WEBKIT = false;
    goog.events.KeyHandler.USES_KEYDOWN_ = false;
  }

  /** Used to simulate behavior of Windows/InternetExplorer7 */
  function simulateWinIe7() {
    goog.userAgent.MAC = false;
    goog.userAgent.WINDOWS = true;
    goog.userAgent.LINUX = false;
    goog.userAgent.IE = true;
    goog.userAgent.GECKO = false;
    goog.userAgent.WEBKIT = false;
    goog.events.KeyHandler.USES_KEYDOWN_ = true;
  }

  /** Used to simulate behavior of Windows/Chrome */
  function simulateWinChrome() {
    goog.userAgent.MAC = false;
    goog.userAgent.WINDOWS = true;
    goog.userAgent.LINUX = false;
    goog.userAgent.IE = false;
    goog.userAgent.GECKO = false;
    goog.userAgent.WEBKIT = true;
    goog.userAgent.VERSION = '525';
    goog.events.KeyHandler.USES_KEYDOWN_ = true;
  }

  /** Used to simulate behavior of Mac/Firefox3 */
  function simulateMacFirefox3() {
    goog.userAgent.MAC = true;
    goog.userAgent.WINDOWS = false;
    goog.userAgent.LINUX = false;
    goog.userAgent.IE = false;
    goog.userAgent.GECKO = true;
    goog.userAgent.WEBKIT = false;
    goog.events.KeyHandler.USES_KEYDOWN_ = true;
  }

  /** Used to simulate behavior of Mac/Safari3 */
  function simulateMacSafari3() {
    goog.userAgent.MAC = true;
    goog.userAgent.WINDOWS = false;
    goog.userAgent.LINUX = false;
    goog.userAgent.IE = false;
    goog.userAgent.GECKO = false;
    goog.userAgent.WEBKIT = true;
    goog.userAgent.VERSION = '525';
    goog.events.KeyHandler.USES_KEYDOWN_ = true;
  }

  /** Used to simulate behavior of Linux/Firefox3 */
  function simulateLinuxFirefox3() {
    goog.userAgent.MAC = false;
    goog.userAgent.WINDOWS = false;
    goog.userAgent.LINUX = true;
    goog.userAgent.IE = false;
    goog.userAgent.GECKO = true;
    goog.userAgent.WEBKIT = false;
    goog.events.KeyHandler.USES_KEYDOWN_ = true;
  }

  /** Test the normal, non-IME case */
  function testRegularKey() {
    // Each key fires down, press, and up in that order, and each should
    // trigger an autocomplete update
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    mh.fireKeyEvents(goog.events.KeyCodes.K, true, true, true);
    assertFalse('IME should not be triggered by K', mh.waitingForIme_);

    mh.fireKeyEvents(goog.events.KeyCodes.A, true, true, true);
    assertFalse('IME should not be triggered by A', mh.waitingForIme_);
  }

  /**
   * This test simulates the key inputs generated by pressing
   * '<ime_on>a<enter>i<ime_off>u' using the Japanese IME
   * on Windows/Firefox3.
   */
  function testImeWinFirefox3() {
    simulateWinFirefox3();
    mh.fireEvent('focus', '');
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    // ime_on

    // a
    mh.fireKeyEvents(goog.events.KeyCodes.WIN_IME, true, true, false);
    // Event is not generated for key code a.
    assertTrue('IME should be triggered', mh.waitingForIme_);

    // enter
    mh.fireKeyEvents(goog.events.KeyCodes.ENTER, false, false, true);
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    // i
    mh.fireKeyEvents(goog.events.KeyCodes.WIN_IME, true, true, false);
    // Event is not generated for key code i.
    assertTrue('IME should be triggered', mh.waitingForIme_);

    // ime_off

    // u
    mh.fireKeyEvents(goog.events.KeyCodes.U, true, true, true);
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    mh.fireEvent('blur', '');
  }

  /**
   * This test simulates the key inputs generated by pressing
   * '<ime_on>a<enter>i<ime_off>u' using the Japanese IME
   * on Windows/InternetExplorer7.
   */
  function testImeWinIe7() {
    simulateWinIe7();
    mh.fireEvent('focus', '');
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    // ime_on

    // a
    mh.fireKeyEvents(goog.events.KeyCodes.WIN_IME, true, false, false);
    mh.fireKeyEvents(goog.events.KeyCodes.A, false, false, true);
    assertTrue('IME should be triggered', mh.waitingForIme_);

    // enter
    mh.fireKeyEvents(goog.events.KeyCodes.WIN_IME, true, false, false);
    mh.fireKeyEvents(goog.events.KeyCodes.ENTER, false, false, true);
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    // i
    mh.fireKeyEvents(goog.events.KeyCodes.WIN_IME, true, false, false);
    mh.fireKeyEvents(goog.events.KeyCodes.I, false, false, true);
    assertTrue('IME should be triggered', mh.waitingForIme_);

    // ime_off

    // u
    mh.fireKeyEvents(goog.events.KeyCodes.U, true, true, true);
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    mh.fireEvent('blur', '');
  }

  /**
   * This test simulates the key inputs generated by pressing
   * '<ime_on>a<enter>i<ime_off>u' using the Japanese IME
   * on Windows/Chrome.
   */
  function testImeWinChrome() {
    simulateWinChrome();
    mh.fireEvent('focus', '');
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    // ime_on

    // a
    mh.fireKeyEvents(goog.events.KeyCodes.WIN_IME, true, false, false);
    mh.fireKeyEvents(goog.events.KeyCodes.A, false, false, true);
    assertTrue('IME should be triggered', mh.waitingForIme_);

    // enter
    mh.fireKeyEvents(goog.events.KeyCodes.WIN_IME, true, false, false);
    mh.fireKeyEvents(goog.events.KeyCodes.ENTER, false, false, true);
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    // i
    mh.fireKeyEvents(goog.events.KeyCodes.WIN_IME, true, false, false);
    mh.fireKeyEvents(goog.events.KeyCodes.I, false, false, true);
    assertTrue('IME should be triggered', mh.waitingForIme_);

    // ime_off

    // u
    mh.fireKeyEvents(goog.events.KeyCodes.U, true, true, true);
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    mh.fireEvent('blur', '');
  }

  /**
   * This test simulates the key inputs generated by pressing
   * '<ime_on>a<enter>i<ime_off>u' using the Japanese IME
   * on Mac/Firefox3.
   */
  function testImeMacFirefox3() {
    // TODO(user): Currently our code cannot distinguish preedit characters
    // from normal ones for Mac/Firefox3.
    // Enable this test after we fix it.

    simulateMacFirefox3();
    mh.fireEvent('focus', '');
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    // ime_on

    // a
    mh.fireKeyEvents(goog.events.KeyCodes.WIN_IME, true, true, false);
    assertTrue('IME should be triggered', mh.waitingForIme_);
    mh.fireKeyEvents(goog.events.KeyCodes.A, true, false, true);
    assertTrue('IME should be triggered', mh.waitingForIme_);

    // enter
    mh.fireKeyEvents(goog.events.KeyCodes.ENTER, true, true, true);
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    // i
    mh.fireKeyEvents(goog.events.KeyCodes.WIN_IME, true, true, false);
    mh.fireKeyEvents(goog.events.KeyCodes.I, true, false, true);
    assertTrue('IME should be triggered', mh.waitingForIme_);

    // ime_off

    // u
    mh.fireKeyEvents(goog.events.KeyCodes.U, true, true, true);
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    mh.fireEvent('blur', '');
  }

  /**
   * This test simulates the key inputs generated by pressing
   * '<ime_on>a<enter>i<ime_off>u' using the Japanese IME
   * on Mac/Safari3.
   */
  function testImeMacSafari3() {
    simulateMacSafari3();
    mh.fireEvent('focus', '');
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    // ime_on

    // a
    mh.fireKeyEvents(goog.events.KeyCodes.WIN_IME, true, false, false);
    mh.fireKeyEvents(goog.events.KeyCodes.A, false, false, true);
    assertTrue('IME should be triggered', mh.waitingForIme_);

    // enter
    mh.fireKeyEvents(goog.events.KeyCodes.WIN_IME, true, false, false);
    mh.fireKeyEvents(goog.events.KeyCodes.ENTER, false, false, true);
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    // i
    mh.fireKeyEvents(goog.events.KeyCodes.WIN_IME, true, false, false);
    mh.fireKeyEvents(goog.events.KeyCodes.I, false, false, true);
    assertTrue('IME should be triggered', mh.waitingForIme_);

    // ime_off

    // u
    mh.fireKeyEvents(goog.events.KeyCodes.U, true, true, true);
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    mh.fireEvent('blur', '');
  }

  /**
   * This test simulates the key inputs generated by pressing
   * '<ime_on>a<enter>i<ime_off>u' using the Japanese IME
   * on Linux/Firefox3.
   */
  function testImeLinuxFirefox3() {
    // TODO(user): Currently our code cannot distinguish preedit characters
    // from normal ones for Linux/Firefox3.
    // Enable this test after we fix it.


    simulateLinuxFirefox3();
    mh.fireEvent('focus', '');
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    // ime_on
    mh.fireKeyEvents(goog.events.KeyCodes.WIN_IME, true, true, false);

    // a
    mh.fireKeyEvents(goog.events.KeyCodes.A, true, false, true);
    assertTrue('IME should be triggered', mh.waitingForIme_);

    // enter
    mh.fireKeyEvents(goog.events.KeyCodes.ENTER, true, true, true);
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    // i
    mh.fireKeyEvents(goog.events.KeyCodes.WIN_IME, true, true, false);
    mh.fireKeyEvents(goog.events.KeyCodes.I, true, false, true);
    assertTrue('IME should be triggered', mh.waitingForIme_);

    // ime_off

    // u
    mh.fireKeyEvents(goog.events.KeyCodes.U, true, true, true);
    assertFalse('IME should not be triggered', mh.waitingForIme_);

    mh.fireEvent('blur', '');
  }

  /**
   * Make sure that the active element handling works.
   */
  function testActiveElement() {
    assertNull(mh.activeElement_);

    mockElement.dispatchEvent('keydown');
    assertEquals(mockElement, mh.activeElement_);

    mockElement.dispatchEvent('blur');
    assertNull(mh.activeElement_);

    mockElement.dispatchEvent('focus');
    assertEquals(mockElement, mh.activeElement_);

    mh.detachInput(mockElement);
    assertNull(mh.activeElement_);
  }

  function testUpdateDoesNotTriggerSetTokenForSelectRow() {

    var ih = new goog.ui.AutoComplete.InputHandler();

    // Set up our input handler with the necessary mocks
    var mockAutoCompleter = new MockAutoCompleter();
    ih.ac_ = mockAutoCompleter;
    ih.activeElement_ = mockElement;

    var row = {};
    ih.selectRow(row, false);

    ih.update();
    assertFalse('update should not call setToken on selectRow',
                mockAutoCompleter.setTokenWasCalled);

    ih.update();
    assertFalse('update should not call setToken on selectRow',
                mockAutoCompleter.setTokenWasCalled);
  }

  function testSetTokenText() {

    var ih = new MockInputHandler();

    // Set up our input handler with the necessary mocks
    var mockAutoCompleter = new MockAutoCompleter();
    ih.ac_ = mockAutoCompleter;
    ih.activeElement_ = mockElement;
    mockElement.value = 'bob, wal, joey';
    ih.setCursorPosition(8);

    ih.setTokenText('waldo', true /* multi-row */);

    assertEquals('bob, waldo, joey', mockElement.value);
  }

  function testGetThrottleTime() {
    var ih = new goog.ui.AutoComplete.InputHandler();
    ih.setThrottleTime(999);
    assertEquals('throttle time set+get', 999, ih.getThrottleTime());
  }

  function testGetUpdateDuringTyping() {
    var ih = new goog.ui.AutoComplete.InputHandler();
    ih.setUpdateDuringTyping(false);
    assertFalse('update during typing set+get', ih.getUpdateDuringTyping());
  }

  function testEnterToSelect() {
    mh.fireEvent('focus', '');
    mh.fireKeyEvents(goog.events.KeyCodes.ENTER, true, true, true);
    assertTrue('Should hilite', mh.ac_.selectHilitedWasCalled);
    assertFalse('Should NOT be dismissed', mh.ac_.dismissWasCalled);
  }

  function testEnterDoesNotSelectWhenClosed() {
    mh.fireEvent('focus', '');
    mh.ac_.isOpen = goog.functions.FALSE;
    mh.fireKeyEvents(goog.events.KeyCodes.ENTER, true, true, true);
    assertFalse('Should NOT hilite', mh.ac_.selectHilitedWasCalled);
    assertTrue('Should be dismissed', mh.ac_.dismissWasCalled);
  }

  function testTabToSelect() {
    mh.fireEvent('focus', '');
    mh.fireKeyEvents(goog.events.KeyCodes.TAB, true, true, true);
    assertTrue('Should hilite', mh.ac_.selectHilitedWasCalled);
    assertFalse('Should NOT be dismissed', mh.ac_.dismissWasCalled);
  }

  function testTabDoesNotSelectWhenClosed() {
    mh.fireEvent('focus', '');
    mh.ac_.isOpen = goog.functions.FALSE;
    mh.fireKeyEvents(goog.events.KeyCodes.TAB, true, true, true);
    assertFalse('Should NOT hilite', mh.ac_.selectHilitedWasCalled);
    assertTrue('Should be dismissed', mh.ac_.dismissWasCalled);
  }

  function testShiftTabDoesNotSelect() {
    mh.fireEvent('focus', '');
    mh.ac_.isOpen = goog.functions.TRUE;
    mh.fireKeyEvents(goog.events.KeyCodes.TAB, true, true, true,
        {shiftKey: true});
    assertFalse('Should NOT hilite', mh.ac_.selectHilitedWasCalled);
    assertTrue('Should be dismissed', mh.ac_.dismissWasCalled);
  }

">n/a</td></tr>
<tr><td>renderer_test.html</td><td>Fail</td><td> 0 passed, 6 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.AutoComplete.Renderer');


  var renderer;
  var rendRows = [];
  var someElement = goog.dom.getElement('someElement');

  // One-time set up of rows formatted for the renderer.
  var rows = [
    'Amanda Annie Anderson',
    'Frankie Manning',
    'Louis D Armstrong'
  ];
  for (var i = 0; i < rows.length; i++) {
    rendRows.push({
      id: i,
      data: rows[i]
    });
  }

  function setUp() {
    renderer = new goog.ui.AutoComplete.Renderer();
    renderer.rowDivs_ = [];
  }

  function tearDown() {
    renderer.dispose();
  }

  function testBasicStringTokenHighlighting() {
    var row = rendRows[0];  // 'Amanda Annie Anderson'

    // Should highlight first match only.
    var token = 'A';
    var node = renderer.renderRowHtml(row, token);
    var boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 1);
    assertPreviousNodeText(boldTagElArray[0], '');
    assertHighlightedText(boldTagElArray[0], 'A');
    assertLastNodeText(node, 'manda Annie Anderson');

    // Should only match on non-empty strings.
    token = '';
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 0);
    assertLastNodeText(node, 'Amanda Annie Anderson');

    // Match should be case insensitive, and should not match tokens in the
    // middle of words ("an" in Amanda).
    token = 'an';
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 1);
    assertPreviousNodeText(boldTagElArray[0], 'Amanda ');
    assertHighlightedText(boldTagElArray[0], 'An');
    assertLastNodeText(node, 'nie Anderson');

    // Should not match whitespace.
    token = ' ';
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 0);
    assertLastNodeText(node, 'Amanda Annie Anderson');

    // Should not match leading whitespace since all matches are at the start of
    // word boundaries.
    token = ' an';
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 0);
    assertLastNodeText(node, 'Amanda Annie Anderson');

    // Should match trailing whitespace.
    token = 'annie ';
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 1);
    assertPreviousNodeText(boldTagElArray[0], 'Amanda ');
    assertHighlightedText(boldTagElArray[0], 'Annie ');
    assertLastNodeText(node, 'Anderson');

    // Should match across whitespace.
    row = rendRows[2]; // 'Louis D Armstrong'
    token = 'd a';
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 1);
    assertPreviousNodeText(boldTagElArray[0], 'Louis ');
    assertHighlightedText(boldTagElArray[0], 'D A');
    assertLastNodeText(node, 'rmstrong');

    // Should match the last token.
    token = 'aRmStRoNg';
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 1);
    assertPreviousNodeText(boldTagElArray[0], 'Louis D ');
    assertHighlightedText(boldTagElArray[0], 'Armstrong');
    assertLastNodeText(node, '');
  }

  function testBasicArrayTokenHighlighting() {
    var row = rendRows[1];  // 'Frankie Manning'

    // Only the first match in the array should be highlighted.
    var token = ['f', 'm'];
    var node = renderer.renderRowHtml(row, token);
    var boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 1);
    assertPreviousNodeText(boldTagElArray[0], '');
    assertHighlightedText(boldTagElArray[0], 'F');
    assertLastNodeText(node, 'rankie Manning');

    // Only the first match in the array should be highlighted.
    token = ['m', 'f'];
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 1);
    assertPreviousNodeText(boldTagElArray[0], 'Frankie ');
    assertHighlightedText(boldTagElArray[0], 'M');
    assertLastNodeText(node, 'anning');

    // Skip tokens that do not match.
    token = ['asdf', 'f'];
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 1);
    assertPreviousNodeText(boldTagElArray[0], '');
    assertHighlightedText(boldTagElArray[0], 'F');
    assertLastNodeText(node, 'rankie Manning');

    // Highlight nothing if no tokens match.
    token = ['Foo', 'bar', 'baz'];
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 0);
    assertLastNodeText(node, 'Frankie Manning');

    // Empty array should not match.
    token = [];
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 0);
    assertLastNodeText(node, 'Frankie Manning');

    // Empty string in array should not match.
    token = [''];
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 0);
    assertLastNodeText(node, 'Frankie Manning');

    // Whitespace in array should not match.
    token = [' '];
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 0);
    assertLastNodeText(node, 'Frankie Manning');

    // Whitespace entries in array should not match.
    token = [' ', 'man'];
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 1);
    assertPreviousNodeText(boldTagElArray[0], 'Frankie ');
    assertHighlightedText(boldTagElArray[0], 'Man');
    assertLastNodeText(node, 'ning');

    // Whitespace in array entry should match as a whole token.
    row = rendRows[2]; // 'Louis D Armstrong'
    token = ['d arm', 'lou'];
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 1);
    assertPreviousNodeText(boldTagElArray[0], 'Louis ');
    assertHighlightedText(boldTagElArray[0], 'D Arm');
    assertLastNodeText(node, 'strong');
  }

  function testHighlightAllTokensSingleTokenHighlighting() {
    renderer.setHighlightAllTokens(true);
    var row = rendRows[0];  // 'Amanda Annie Anderson'

    // All matches at the start of the word should be highlighted when
    // highlightAllTokens is set.
    var token = 'a';
    var node = renderer.renderRowHtml(row, token);
    var boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 3);
    assertPreviousNodeText(boldTagElArray[0], '');
    assertHighlightedText(boldTagElArray[0], 'A');
    assertPreviousNodeText(boldTagElArray[1], 'manda ');
    assertHighlightedText(boldTagElArray[1], 'A');
    assertPreviousNodeText(boldTagElArray[2], 'nnie ');
    assertHighlightedText(boldTagElArray[2], 'A');
    assertLastNodeText(node, 'nderson');

    // Should not match on empty string.
    token = '';
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 0);
    assertLastNodeText(node, 'Amanda Annie Anderson');

    // Match should be case insensitive.
    token = 'AN';
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 2);
    assertPreviousNodeText(boldTagElArray[0], 'Amanda ');
    assertHighlightedText(boldTagElArray[0], 'An');
    assertPreviousNodeText(boldTagElArray[1], 'nie ');
    assertHighlightedText(boldTagElArray[1], 'An');
    assertLastNodeText(node, 'derson');

    // Should not match on whitespace.
    token = ' ';
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 0);
    assertLastNodeText(node, 'Amanda Annie Anderson');

    // When highlighting all tokens, should match despite leading whitespace.
    token = '  am';
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 1);
    assertPreviousNodeText(boldTagElArray[0], '');
    assertHighlightedText(boldTagElArray[0], 'Am');
    assertLastNodeText(node, 'anda Annie Anderson');

    // Should match with trailing whitepsace.
    token = 'ann   ';
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 1);
    assertPreviousNodeText(boldTagElArray[0], 'Amanda ');
    assertHighlightedText(boldTagElArray[0], 'Ann');
    assertLastNodeText(node, 'ie Anderson');
  }

  function testHighlightAllTokensMultipleStringTokenHighlighting() {
    renderer.setHighlightAllTokens(true);
    var row = rendRows[1];  // 'Frankie Manning'

    // Each individual space-separated token should match.
    var token = 'm F';
    var node = renderer.renderRowHtml(row, token);
    var boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 2);
    assertPreviousNodeText(boldTagElArray[0], '');
    assertHighlightedText(boldTagElArray[0], 'F');
    assertPreviousNodeText(boldTagElArray[1], 'rankie ');
    assertHighlightedText(boldTagElArray[1], 'M');
    assertLastNodeText(node, 'anning');
  }

  function testHighlightAllTokensArrayTokenHighlighting() {
    renderer.setHighlightAllTokens(true);
    var row = rendRows[0];  // 'Amanda Annie Anderson'

    // All tokens in the array should match.
    var token = ['AM', 'AN'];
    var node = renderer.renderRowHtml(row, token);
    var boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 3);
    assertPreviousNodeText(boldTagElArray[0], '');
    assertHighlightedText(boldTagElArray[0], 'Am');
    assertPreviousNodeText(boldTagElArray[1], 'anda ');
    assertHighlightedText(boldTagElArray[1], 'An');
    assertPreviousNodeText(boldTagElArray[2], 'nie ');
    assertHighlightedText(boldTagElArray[2], 'An');
    assertLastNodeText(node, 'derson');

    // Empty array should not match.
    token = [];
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 0);
    assertLastNodeText(node, 'Amanda Annie Anderson');

    // Empty string in array should not match.
    token = [''];
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 0);
    assertLastNodeText(node, 'Amanda Annie Anderson');

    // Whitespace in array should not match.
    token = [' '];
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 0);
    assertLastNodeText(node, 'Amanda Annie Anderson');

    // Empty string entries in array should not match.
    token = ['', 'Ann'];
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 1);
    assertPreviousNodeText(boldTagElArray[0], 'Amanda ');
    assertHighlightedText(boldTagElArray[0], 'Ann');
    assertLastNodeText(node, 'ie Anderson');

    // Whitespace entries in array should not match.
    token = [' ', 'And'];
    node = renderer.renderRowHtml(row, token);
    boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 1);
    assertPreviousNodeText(boldTagElArray[0], 'Amanda Annie ');
    assertHighlightedText(boldTagElArray[0], 'And');
    assertLastNodeText(node, 'erson');

    // Whitespace in array entry should match as a whole token.
    token = ['annie a', 'Am'];
    node = renderer.renderRowHtml(row, token);
    var boldTagElArray = node.getElementsByTagName('b');
    assertNumBoldTags(boldTagElArray, 2);
    assertPreviousNodeText(boldTagElArray[0], '');
    assertHighlightedText(boldTagElArray[0], 'Am');
    assertPreviousNodeText(boldTagElArray[1], 'anda ');
    assertHighlightedText(boldTagElArray[1], 'Annie A');
    assertLastNodeText(node, 'nderson');
  }

  function testMousedownToDismiss() {
    var dismissEvents = 0;
    goog.events.listen(renderer, goog.ui.AutoComplete.EventType.DISMISS,
        function() {
          dismissEvents++;
        });
    renderer.redraw();
    goog.testing.events.fireMouseDownEvent(someElement);
    assertEquals('1 dismiss event should be fired', 1, dismissEvents);
  }

  // ------- Helper functions -------
  function assertNumBoldTags (boldTagElArray, expectedNum) {
    assertEquals('Incorrect number of bold tags', expectedNum,
        boldTagElArray.length);
  }

  function assertPreviousNodeText(boldTag, expectedText) {
    var prevNode = boldTag.previousSibling;
    assertEquals('Expected text before the token does not match', expectedText,
        prevNode.nodeValue);
  }

  function assertHighlightedText(boldTag, expectedHighlightedText) {
    assertEquals('Incorrect text bolded', expectedHighlightedText,
        boldTag.innerHTML);
  }

  function assertLastNodeText(node, expectedText) {
    var lastNode = node.lastChild;
    assertEquals('Incorrect text in the last node', expectedText,
        lastNode.nodeValue);
  }

">6 of 6 tests run in 15ms.<br />0 passed, 6 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testBasicArrayTokenHighlighting<br />Object #<Object> has no method 'createElement'<br />ERROR in testBasicStringTokenHighlighting<br />Object #<Object> has no method 'createElement'<br />ERROR in testHighlightAllTokensArrayTokenHighlighting<br />Object #<Object> has no method 'createElement'<br />ERROR in testHighlightAllTokensMultipleStringTokenHighlighting<br />Object #<Object> has no method 'createElement'<br />ERROR in testHighlightAllTokensSingleTokenHighlighting<br />Object #<Object> has no method 'createElement'<br />ERROR in testMousedownToDismiss<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>remotearraymatcher_test.html</td><td>Success</td><td> 2 passed, 0 failed.</td><td title="

  goog.require('goog.events.KeyCodes');
  goog.require('goog.json');
  goog.require('goog.testing.MockControl');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.net.XhrIo');
  goog.require('goog.ui.AutoComplete.RemoteArrayMatcher');



  var url = "http://www.google.com";
  var token = "goog";
  var maxMatches = 5;
  var fullToken = "google";

  var responseJsonText = "['eric', 'larry', 'sergey', 'marissa', 'pupius']";
  var responseJson = goog.json.unsafeParse(responseJsonText);

  var mockControl;
  var mockMatchHandler;


  function setUp() {
    goog.net.XhrIo = goog.testing.net.XhrIo;
    mockControl = new goog.testing.MockControl();
    mockMatchHandler = mockControl.createFunctionMock();
  }

  function testRequestMatchingRows_noSimilarTrue() {
    var matcher = new goog.ui.AutoComplete.RemoteArrayMatcher(url);
    mockMatchHandler(token, responseJson);
    mockControl.$replayAll();
    matcher.requestMatchingRows(token, maxMatches, mockMatchHandler, fullToken);
    matcher.xhr_.simulateResponse(200, responseJsonText);
    mockControl.$verifyAll();
    mockControl.$resetAll();
  }

  function testRequestMatchingRows_twoCalls() {
    var matcher = new goog.ui.AutoComplete.RemoteArrayMatcher(url);

    var dummyMatchHandler = mockControl.createFunctionMock();

    mockMatchHandler(token, responseJson);
    mockControl.$replayAll();

    matcher.requestMatchingRows(token, maxMatches, dummyMatchHandler,
        fullToken);

    matcher.requestMatchingRows(token, maxMatches, mockMatchHandler, fullToken);
    matcher.xhr_.simulateResponse(200, responseJsonText);
    mockControl.$verifyAll();
    mockControl.$resetAll();
  }
">n/a</td></tr>
<tr><td>popupbase_test.html</td><td>Fail</td><td> 3 passed, 9 failed.</td><td title="

  goog.require('goog.events.EventType');
  goog.require('goog.ui.Popup');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');



var targetDiv = goog.dom.getElement('targetDiv');
var popupDiv = goog.dom.getElement('popupDiv');
var clock;
var popup;

function setUp() {
  popup = new goog.ui.PopupBase(popupDiv);
  clock = new goog.testing.MockClock(true);
}

function tearDown() {
  popup.dispose();
  clock.uninstall();
}

function testSetVisible() {
  popup.setVisible(true);
  assertEquals('visible', popupDiv.style.visibility);
  assertEquals('', popupDiv.style.display);
  popup.setVisible(false);
  assertEquals('hidden', popupDiv.style.visibility);
  assertEquals('none', popupDiv.style.display);
}

function testEscapeDismissal() {
  popup.setHideOnEscape(true);
  assertTrue('Sanity check that getHideOnEscape is true when set to true.',
      popup.getHideOnEscape());
  popup.setVisible(true);
  assertFalse('Escape key should be cancelled',
      goog.testing.events.fireKeySequence(
          targetDiv, goog.events.KeyCodes.ESC));
  assertFalse(popup.isVisible());
}

function testEscapeDismissalCanBeDisabled() {
  popup.setHideOnEscape(false);
  popup.setVisible(true);
  assertTrue('Escape key should be cancelled',
      goog.testing.events.fireKeySequence(
          targetDiv, goog.events.KeyCodes.ESC));
  assertTrue(popup.isVisible());
}

function testEscapeDismissalIsDisabledByDefault() {
  assertFalse(popup.getHideOnEscape());
}

function testEscapeDismissalDoesNotRecognizeOtherKeys() {
  popup.setHideOnEscape(true);
  popup.setVisible(true);
  var eventsPropagated = 0;
  goog.events.listenOnce(goog.dom.getElement('commonAncestor'),
      [goog.events.EventType.KEYDOWN,
       goog.events.EventType.KEYUP,
       goog.events.EventType.KEYPRESS],
      function() {
        ++eventsPropagated;
      });
  assertTrue('Popup should remain visible', popup.isVisible());
  assertTrue('The key event default action should not be prevented',
      goog.testing.events.fireKeySequence(
          targetDiv, goog.events.KeyCodes.A));
  assertEquals('Keydown, keyup, and keypress should have all propagated',
      3, eventsPropagated);
}

function testEscapeDismissalCanBeCancelledByBeforeHideEvent() {
  popup.setHideOnEscape(true);
  popup.setVisible(true);
  var eventsPropagated = 0;
  goog.events.listenOnce(goog.dom.getElement('commonAncestor'),
      goog.events.EventType.KEYDOWN,
      function() {
        ++eventsPropagated;
      });
  // Make a listener so that we stop hiding with an event handler.
  goog.events.listenOnce(popup, goog.ui.PopupBase.EventType.BEFORE_HIDE,
      function(e) {
        e.preventDefault();
      });
  assertEquals('The hide should have been cancelled',
      true, popup.isVisible());
  assertTrue('The key event default action should not be prevented',
      goog.testing.events.fireKeySequence(
          targetDiv, goog.events.KeyCodes.ESC));
  assertEquals('Keydown should have all propagated',
      1, eventsPropagated);
}

function testEscapeDismissalProvidesKeyTargetAsTargetForHideEvents() {
  popup.setHideOnEscape(true);
  popup.setVisible(true);
  var calls = 0;
  goog.events.listenOnce(popup,
      [goog.ui.PopupBase.EventType.BEFORE_HIDE,
       goog.ui.PopupBase.EventType.HIDE],
      function(e) {
        calls++;
        assertEquals('The key target should be the hide event target',
            'targetDiv', e.target.id);
      });
  goog.testing.events.fireKeySequence(
      targetDiv, goog.events.KeyCodes.ESC);
}

function testAutoHide() {
  popup.setAutoHide(true);
  popup.setVisible(true);
  clock.tick(1000); // avoid bouncing
  goog.testing.events.fireClickSequence(targetDiv);
  assertFalse(popup.isVisible());
}

function testAutoHideCanBeDisabled() {
  popup.setAutoHide(false);
  popup.setVisible(true);
  clock.tick(1000); // avoid bouncing
  goog.testing.events.fireClickSequence(targetDiv);
  assertTrue('Should not be hidden if auto hide is disabled', popup.isVisible());
}

function testAutoHideEnabledByDefault() {
  assertTrue(popup.getAutoHide());
}

function testCanAddElementDuringBeforeShow() {
  popup.setElement(null);
  goog.events.listenOnce(popup, goog.ui.PopupBase.EventType.BEFORE_SHOW,
      function() {
        popup.setElement(popupDiv);
      });
  popup.setVisible(true);
  assertTrue('Popup should be shown', popup.isVisible());
}

function testShowWithNoElementThrowsException() {
  popup.setElement(null);
  var e = assertThrows(function() {
    popup.setVisible(true);
  });
  assertEquals('Caller must call setElement before trying to show the popup',
      e.message);
}

// TODO(user): Write better unit tests for click and cross-iframe dismissal.

">12 of 12 tests run in 21ms.<br />3 passed, 9 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testAutoHide<br />Cannot read property 'closure_uid_3t4jz2' of undefined<br />ERROR in testAutoHideCanBeDisabled<br />Cannot set property 'visibility' of undefined<br />ERROR in testCanAddElementDuringBeforeShow<br />Cannot read property 'closure_uid_3t4jz2' of undefined<br />ERROR in testEscapeDismissal<br />Cannot read property 'closure_uid_3t4jz2' of undefined<br />ERROR in testEscapeDismissalCanBeCancelledByBeforeHideEvent<br />Cannot read property 'closure_uid_3t4jz2' of undefined<br />ERROR in testEscapeDismissalCanBeDisabled<br />Cannot read property 'closure_uid_3t4jz2' of undefined<br />ERROR in testEscapeDismissalDoesNotRecognizeOtherKeys<br />Cannot read property 'closure_uid_3t4jz2' of undefined<br />ERROR in testEscapeDismissalProvidesKeyTargetAsTargetForHideEvents<br />Cannot read property 'closure_uid_3t4jz2' of undefined<br />ERROR in testSetVisible<br />Cannot read property 'closure_uid_3t4jz2' of undefined<br /></td></tr>
<tr><td>datepicker_test.html</td><td>Fail</td><td> 0 passed, 12 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.events');
    goog.require('goog.i18n.DateTimeSymbols_en_US');
    goog.require('goog.i18n.DateTimeSymbols_zh_HK');
    goog.require('goog.style');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.DatePicker');
  

  var picker;
  var $$ = goog.dom.getElementsByTagNameAndClass;
  var sandbox = goog.dom.getElement('sandbox');

  function tearDown() {
    picker.dispose();
    goog.dom.removeChildren(sandbox);
  }

  function testIsMonthOnLeft() {
    goog.i18n.DateTimeSymbols = goog.i18n.DateTimeSymbols_en_US;
    picker = new goog.ui.DatePicker();
    picker.create(sandbox);
    var head = $$('tr', 'goog-date-picker-head')[0];
    var month = $$('button', 'goog-date-picker-month',
        head.firstChild)[0];
    assertSameElements(
        'Button element must have expected class names',
        ['goog-date-picker-btn','goog-date-picker-month'],
        goog.dom.classes.get(month)
    );
  }

  function testIsYearOnLeft() {
    goog.i18n.DateTimeSymbols = goog.i18n.DateTimeSymbols_zh_HK;
    picker = new goog.ui.DatePicker();
    picker.create(sandbox);
    var head = $$('tr', 'goog-date-picker-head')[0];
    var year = $$('button', 'goog-date-picker-year',
        head.firstChild)[0];
    assertSameElements(
        'Button element must have expected class names',
        ['goog-date-picker-btn','goog-date-picker-year'],
        goog.dom.classes.get(year)
    );
  }

  function testHidingOfTableFoot0() {
    picker = new goog.ui.DatePicker();
    picker.setAllowNone(false);
    picker.setShowToday(false);
    picker.create(sandbox);
    var tFoot = $$('tfoot')[0];
    assertFalse(goog.style.isElementShown(tFoot))
  }

  function testHidingOfTableFoot1() {
    picker = new goog.ui.DatePicker();
    picker.setAllowNone(false);
    picker.setShowToday(true);
    picker.create(sandbox);
    var tFoot = $$('tfoot')[0];
    assertTrue(goog.style.isElementShown(tFoot))
  }

  function testHidingOfTableFoot2() {
    picker = new goog.ui.DatePicker();
    picker.setAllowNone(true);
    picker.setShowToday(false);
    picker.create(sandbox);
    var tFoot = $$('tfoot')[0];
    assertTrue(goog.style.isElementShown(tFoot))
  }

  function testHidingOfTableFoot3() {
    picker = new goog.ui.DatePicker();
    picker.setAllowNone(true);
    picker.setShowToday(true);
    picker.create(sandbox);
    var tFoot = $$('tfoot')[0];
    assertTrue(goog.style.isElementShown(tFoot))
  }

  function testHidingOfTableFootAfterCreate0() {
    picker = new goog.ui.DatePicker();
    picker.create(sandbox);
    picker.setAllowNone(false);
    picker.setShowToday(false);
    var tFoot = $$('tfoot')[0];
    assertFalse(goog.style.isElementShown(tFoot))
  }

  function testHidingOfTableFootAfterCreate1() {
    picker = new goog.ui.DatePicker();
    picker.create(sandbox);
    picker.setAllowNone(false);
    picker.setShowToday(true);
    var tFoot = $$('tfoot')[0];
    assertTrue(goog.style.isElementShown(tFoot))
  }

  function testHidingOfTableFootAfterCreate2() {
    picker = new goog.ui.DatePicker();
    picker.create(sandbox);
    picker.setAllowNone(true);
    picker.setShowToday(false);
    var tFoot = $$('tfoot')[0];
    assertTrue(goog.style.isElementShown(tFoot))
  }

  function testHidingOfTableFootAfterCreate3() {
    picker = new goog.ui.DatePicker();
    picker.create(sandbox);
    picker.setAllowNone(true);
    picker.setShowToday(true);
    var tFoot = $$('tfoot')[0];
    assertTrue(goog.style.isElementShown(tFoot))
  }

  function testSetDate() {
    picker = new goog.ui.DatePicker();
    picker.createDom();
    picker.enterDocument();
    var selectEvents = 0;
    var changeEvents = 0;
    goog.events.listen(picker, goog.ui.DatePicker.Events.SELECT,
        function() {
          selectEvents++;
        });
    goog.events.listen(picker, goog.ui.DatePicker.Events.CHANGE,
        function() {
          changeEvents++;
        });

    // Set date.
    picker.setDate(new Date(2010, 1, 26));
    assertEquals('no select event dispatched', 1, selectEvents);
    assertEquals('no change event dispatched', 1, changeEvents);
    assertTrue('date is set',
        new goog.date.Date(2010, 1, 26).equals(picker.getDate()));

    // Set date to same date.
    picker.setDate(new Date(2010, 1, 26));
    assertEquals('1 select event dispatched', 2, selectEvents);
    assertEquals('no change event dispatched', 1, changeEvents);

    // Set date to different date.
    picker.setDate(new Date(2010, 1, 27));
    assertEquals('another select event dispatched', 3, selectEvents);
    assertEquals('1 change event dispatched', 2, changeEvents);

    // Set date to none.
    picker.setDate(null);
    assertEquals('another select event dispatched', 4, selectEvents);
    assertEquals('another change event dispatched', 3, changeEvents);
    assertNull('date cleared', picker.getDate());
  }

  function testEventListenerLeaks() {
    var listeners = goog.events.getTotalListenerCount();
    picker = new goog.ui.DatePicker();
    assertEquals('no listeners registered in constructor', listeners,
        goog.events.getTotalListenerCount());
    picker.createDom();
    picker.enterDocument();
    picker.exitDocument();
    assertEquals('exitDocument cleans up all listeners', listeners,
        goog.events.getTotalListenerCount());
  }

">12 of 12 tests run in 20ms.<br />0 passed, 12 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testEventListenerLeaks<br />Object #<Object> has no method 'createElement'<br />ERROR in testHidingOfTableFoot0<br />Object #<Object> has no method 'createElement'<br />ERROR in testHidingOfTableFoot1<br />Object #<Object> has no method 'createElement'<br />ERROR in testHidingOfTableFoot2<br />Object #<Object> has no method 'createElement'<br />ERROR in testHidingOfTableFoot3<br />Object #<Object> has no method 'createElement'<br />ERROR in testHidingOfTableFootAfterCreate0<br />Object #<Object> has no method 'createElement'<br />ERROR in testHidingOfTableFootAfterCreate1<br />Object #<Object> has no method 'createElement'<br />ERROR in testHidingOfTableFootAfterCreate2<br />Object #<Object> has no method 'createElement'<br />ERROR in testHidingOfTableFootAfterCreate3<br />Object #<Object> has no method 'createElement'<br />ERROR in testIsMonthOnLeft<br />Object #<Object> has no method 'createElement'<br />ERROR in testIsYearOnLeft<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetDate<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>menubuttonrenderer_test.html</td><td>Fail</td><td> 0 passed, 7 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.testing.jsunit');
    goog.require('goog.testing.ui.style');
    goog.require('goog.ui.MenuButton');
    goog.require('goog.ui.style.app.MenuButtonRenderer');
    goog.require('goog.userAgent');
  

    var renderer = goog.ui.style.app.MenuButtonRenderer.getInstance()
    var button;

    // Write iFrame tag to load reference FastUI markup. Then, our tests will
    // compare the generated markup to the reference markup.
    var refPath = '../../../../../webutil/css/fastui/app/menubutton_spec.html';
    goog.testing.ui.style.writeReferenceFrame(refPath);

    function setUp() {
      button = new goog.ui.MenuButton('Hello Generated', null, renderer);
      button.setTooltip('Click for Generated');
    }

    function tearDown() {
      if (button) {
        button.dispose();
      }
      goog.dom.getElement('sandbox').innerHTML = '';
    }

    function testGeneratedButton() {
      button.render(goog.dom.getElement('sandbox'));
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-resting');
      assertEquals('Hello Generated',
          button.getContentElement().firstChild.nodeValue);
      assertEquals('Click for Generated',
          button.getElement().getAttribute('title'));
    }

    function testButtonStates() {
      button.render(goog.dom.getElement('sandbox'));
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-resting');
      button.setState(goog.ui.Component.State.HOVER, true);
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-hover');
      button.setState(goog.ui.Component.State.HOVER, false);
      button.setState(goog.ui.Component.State.FOCUSED, true);
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-focused');
      button.setState(goog.ui.Component.State.FOCUSED, false);
      button.setState(goog.ui.Component.State.ACTIVE, true);
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-active');
      button.setState(goog.ui.Component.State.ACTIVE, false);
      button.setState(goog.ui.Component.State.DISABLED, true);
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-disabled');
    }

    function testDecoratedButton() {
      button.decorate(goog.dom.getElement('button'));
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-resting');
      assertEquals('Hello Decorated',
          button.getContentElement().firstChild.nodeValue);
      assertEquals('Click for Decorated',
          button.getElement().getAttribute('title'));
    }

    function testDecoratedButtonBox() {
      button.decorate(goog.dom.getElement('button-box'));
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-resting');
      assertEquals('Hello Decorated Box',
          button.getContentElement().firstChild.nodeValue);
      assertEquals('Click for Decorated Box',
          button.getElement().getAttribute('title'));
    }

    function testExistingContentIsUsed() {
      button.decorate(goog.dom.getElement('button-with-dom-content'));
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-resting');
      // Safari 3 adds style="-webkit-user-select" to the strong tag, so we
      // can't simply look at the HTML.
      var content = button.getContentElement();
      assertEquals('Unexpected number of child nodes; expected existing number '
          + 'plus one for the dropdown element', 4, content.childNodes.length);
      assertEquals('Unexpected tag', 'STRONG',
          content.childNodes[0].tagName);
      assertEquals('Unexpected text content', 'Hello Strong',
          content.childNodes[0].innerHTML);
      assertEquals('Unexpected tag', 'EM',
          content.childNodes[2].tagName);
      assertEquals('Unexpected text content', 'Box',
          content.childNodes[2].innerHTML);
    }

    function testDecoratedButtonWithMenu() {
      button.decorate(goog.dom.getElement('button-with-menu'));
      assertEquals('Unexpected number of menu items', 2, button.getItemCount());
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-resting');
      assertFalse('Expected menu element to not be contained by button',
          goog.dom.contains(button.getElement(),
              button.getMenu().getElement()));
    }

    function testDropDownExistsAfterButtonRename() {
      button.decorate(goog.dom.getElement('button-2'));
      button.setContent('New title');
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-resting');
      assertEquals('Unexpected number of child nodes; expected text element '
          + 'and the dropdown element',
          2, button.getContentElement().childNodes.length);
      assertEquals('New title',
          button.getContentElement().firstChild.nodeValue);
      assertEquals('Click for Decorated',
          button.getElement().getAttribute('title'));
    }
  ">7 of 7 tests run in 14ms.<br />0 passed, 7 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testButtonStates<br />Object #<Object> has no method 'createElement'<br />ERROR in testDecoratedButton<br />Invalid element to decorate<br />ERROR in testDecoratedButtonBox<br />Invalid element to decorate<br />ERROR in testDecoratedButtonWithMenu<br />Invalid element to decorate<br />ERROR in testDropDownExistsAfterButtonRename<br />Invalid element to decorate<br />ERROR in testExistingContentIsUsed<br />Invalid element to decorate<br />ERROR in testGeneratedButton<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>decorate_test.html</td><td>Fail</td><td> 0 passed, 1 failed.</td><td title="

    goog.require('goog.object');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.decorate');
    goog.require('goog.ui.registry');
  

    // Fake component and renderer implementations, for testing only.

    // UnknownComponent has no default renderer or decorator registered.
    function UnknownComponent() {
    }

    // FakeComponentX's default renderer is FakeRenderer.  It also has a
    // decorator.
    function FakeComponentX() {
      this.element = null;
    }

    FakeComponentX.prototype.decorate = function(element) {
      this.element = element;
    };

    // FakeComponentY doesn't have an explicitly registered default
    // renderer; it should inherit the default renderer from its superclass.
    // It does have a decorator registered.
    function FakeComponentY() {
      FakeComponentX.call(this);
    }
    goog.inherits(FakeComponentY, FakeComponentX);

    // FakeComponentZ is just another component.  Its default renderer is
    // FakeSingletonRenderer, but it has no decorator registered.
    function FakeComponentZ() {
    }

    // FakeRenderer is a stateful renderer.
    function FakeRenderer() {
    }

    // FakeSingletonRenderer is a stateless renderer that can be used as a
    // singleton.
    function FakeSingletonRenderer() {
    }

    FakeSingletonRenderer.instance_ = new FakeSingletonRenderer();

    FakeSingletonRenderer.getInstance = function() {
      return FakeSingletonRenderer.instance_;
    };

    function setUp() {
      goog.ui.registry.setDefaultRenderer(FakeComponentX, FakeRenderer);
      goog.ui.registry.setDefaultRenderer(FakeComponentZ,
          FakeSingletonRenderer);

      goog.ui.registry.setDecoratorByClassName('fake-component-x',
          function() {
            return new FakeComponentX();
          });
      goog.ui.registry.setDecoratorByClassName('fake-component-y',
          function() {
            return new FakeComponentY();
          });
    }

    function tearDown() {
      goog.ui.registry.reset();
    }

    function testDecorate() {
      var dx = goog.ui.decorate(document.getElementById('x'));
      assertTrue('Decorator for element with fake-component-x class must be ' +
          'a FakeComponentX', dx instanceof FakeComponentX);
      assertEquals('Element x must have been decorated',
          document.getElementById('x'), dx.element);

      var dy = goog.ui.decorate(document.getElementById('y'));
      assertTrue('Decorator for element with fake-component-y class must be ' +
          'a FakeComponentY', dy instanceof FakeComponentY);
      assertEquals('Element y must have been decorated',
          document.getElementById('y'), dy.element);

      var dz = goog.ui.decorate(document.getElementById('z'));
      assertNull('Decorator for element with unknown class must be null', dz);

      var du = goog.ui.decorate(document.getElementById('u'));
      assertNull('Decorator for element without CSS class must be null', du);
    }

  ">1 of 1 tests run in 5ms.<br />0 passed, 1 failed.<br />5 ms/test. 1 files loaded.<br />ERROR in testDecorate<br />Decorator for element with fake-component-x class must be a FakeComponentX<br />Call to assertTrue(boolean) with false<br />> assertTrue at testing/asserts.js:261:3<br />> testDecorate at _tmpclosuretest.js:74:7<br /></td></tr>
<tr><td>cookieeditor_test.html</td><td>Fail</td><td> 0 passed, 3 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.TagName');
  goog.require('goog.events.Event');
  goog.require('goog.events.EventType');
  goog.require('goog.net.cookies');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.CookieEditor');


  var COOKIE_KEY = 'my_fabulous_cookie';
  var COOKIE_VALUES;

  goog.net.cookies.get = function(key) {
    return COOKIE_VALUES[key];
  };

  goog.net.cookies.set = function(key, value) {
    return COOKIE_VALUES[key] = value;
  };

  goog.net.cookies.remove = function(key, value) {
    delete COOKIE_VALUES[key];
  };

  function setUp() {
    goog.dom.removeChildren(goog.dom.getElement('test_container'));
    COOKIE_VALUES = {};
  }

  function newCookieEditor(opt_cookieValue) {
    // Set cookie.
    if (opt_cookieValue) {
      goog.net.cookies.set(COOKIE_KEY, opt_cookieValue);
    }

    // Render editor.
    var editor = new goog.ui.CookieEditor();
    editor.selectCookie(COOKIE_KEY);
    editor.render(goog.dom.getElement('test_container'));
    assertEquals('wrong text area value', opt_cookieValue || '',
        editor.textAreaElem_.value || '');

    return editor;
  }

  function testRender() {
    // Render editor.
    var editor = newCookieEditor();

    // All expected elements created?
    var elem = editor.getElement();
    assertNotNullNorUndefined('missing element', elem);
    assertNotNullNorUndefined('missing clear button', editor.clearButtonElem_);
    assertNotNullNorUndefined('missing update button',
        editor.updateButtonElem_);
    assertNotNullNorUndefined('missing text area', editor.textAreaElem_);
  }

  function testEditCookie() {
    // Render editor.
    var editor = newCookieEditor();

    // Invalid value.
    var newValue = 'my bad value;';
    editor.textAreaElem_.value = newValue;
    goog.testing.events.fireBrowserEvent(new goog.events.Event(
        goog.events.EventType.CLICK, editor.updateButtonElem_));
    assertTrue('unexpected cookie value', !goog.net.cookies.get(COOKIE_KEY));

    // Valid value.
    newValue = 'my fabulous value';
    editor.textAreaElem_.value = newValue;
    goog.testing.events.fireBrowserEvent(new goog.events.Event(
        goog.events.EventType.CLICK, editor.updateButtonElem_));
    assertEquals('wrong cookie value', newValue,
        goog.net.cookies.get(COOKIE_KEY));
  }

  function testClearCookie() {
    // Render editor.
    var value = 'I will be cleared';
    var editor = newCookieEditor(value);

    // Clear value.
    goog.testing.events.fireBrowserEvent(new goog.events.Event(
        goog.events.EventType.CLICK, editor.clearButtonElem_));
    assertTrue('unexpected cookie value', !goog.net.cookies.get(COOKIE_KEY));
  }
">3 of 3 tests run in 6ms.<br />0 passed, 3 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testClearCookie<br />Object #<Object> has no method 'createElement'<br />ERROR in testEditCookie<br />Object #<Object> has no method 'createElement'<br />ERROR in testRender<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>toolbarfactory_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.testing.ExpectedFailures');
  goog.require('goog.testing.editor.TestHelper');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.editor.ToolbarFactory');


var helper = new goog.testing.editor.TestHelper(goog.dom.getElement('myField'));
var expectedFailures = new goog.testing.ExpectedFailures();

function setUp() {
  helper.setUpEditableElement();
}

function tearDown() {
  helper.tearDownEditableElement();
  expectedFailures.handleTearDown();
}

/**
 * Makes sure we have the correct conversion table in
 * goog.ui.editor.ToolbarFactory.LEGACY_SIZE_TO_PX_MAP_. Can only be tested in
 * a browser that takes legacy size values as input to execCommand but returns
 * pixel size values from queryCommandValue. That's OK because that's the only
 * situation where this conversion table's precision is critical. (When it's
 * used to size the labels of the font size menu options it's ok if it's a few
 * pixels off.)
 */
function testGetLegacySizeFromPx() {
  // We will be warned if other browsers start behaving like webkit pre-534.7.
  expectedFailures.expectFailureFor(
      !goog.userAgent.WEBKIT ||
      (goog.userAgent.WEBKIT && goog.userAgent.isVersion('534.7')));
  try {
    var fieldElem = goog.dom.getElement('myField');
    // Start from 1 because size 0 is bogus (becomes 16px, legacy size 3).
    for (var i = 1; i <
        goog.ui.editor.ToolbarFactory.LEGACY_SIZE_TO_PX_MAP_.length; i++) {
      helper.select(fieldElem, 0, fieldElem, 1);
      document.execCommand('fontSize', false, i);
      helper.select('foo', 1);
      var value = document.queryCommandValue('fontSize');
      assertEquals('Px size ' + value + ' should convert to legacy size ' + i,
          i, goog.ui.editor.ToolbarFactory.getLegacySizeFromPx(
              parseInt(value, 10)));
    }
  } catch (e) {
    expectedFailures.handleException(e);
  }
}
">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:10:24
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>bubble_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.TagName');
  goog.require('goog.events.BrowserEvent');
  goog.require('goog.events.EventType');
  goog.require('goog.events.KeyCodes');
  goog.require('goog.string');
  goog.require('goog.style');
  goog.require('goog.testing.editor.TestHelper');
  goog.require('goog.testing.editor.FieldMock');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.LooseMock');
  goog.require('goog.ui.editor.Bubble');
  goog.require('goog.userAgent');



var testHelper;
var fieldDiv = goog.dom.getElement('field');
var bubble;
var link;
var link2;
var panelId;

function setUpPage() {
  var viewportSize = goog.dom.getViewportSize();
  // Some tests depends on enough size of viewport.
  if (viewportSize.width < 600 || viewportSize.height < 440) {
    window.moveTo(0, 0);
    window.resizeTo(640, 480);
  }
};

function setUp() {
  testHelper = new goog.testing.editor.TestHelper(fieldDiv);
  testHelper.setUpEditableElement();

  bubble = new goog.ui.editor.Bubble(document.body, 999);

  fieldDiv.innerHTML = '<a href="http://www.google.com">Google</a>' +
      '<a href="http://www.google.com">Google2</a>';
  link = fieldDiv.firstChild;
  link2 = fieldDiv.lastChild;

  window.scrollTo(0, 0);
  goog.style.setStyle(document.body, 'direction', 'ltr');
  goog.style.setStyle(document.getElementById('field'), 'position', 'static');
}

function tearDown() {
  if (panelId) {
    bubble.removePanel(panelId);
  }
  testHelper.tearDownEditableElement();
}

/**
 * This is a helper function for setting up the target element with a
 * given direction.
 *
 * @param {string} dir The direction of the target element, 'ltr' or 'rtl'.
 * @param {boolean=} opt_preferTopPosition Whether to prefer placing the bubble
 *     above the element instead of below it.  Defaults to preferring below.
 */
function prepareTargetWithGivenDirection(dir, opt_preferTopPosition) {
  goog.style.setStyle(document.body, 'direction', dir);

  fieldDiv.style.direction = dir;
  fieldDiv.innerHTML = '<a href="http://www.google.com">Google</a>';
  link = fieldDiv.firstChild;

  panelId = bubble.addPanel('A', 'Link', link, function(el) {
    el.innerHTML = '<div style="border:1px solid blue;">B</div>';
  }, opt_preferTopPosition);
}

/**
 * This is a helper function for getting the expected position of the bubble.
 * (align to the right or the left of the target element).  Align left by
 * default and align right if opt_alignRight is true. The expected Y is
 * unaffected by alignment.
 *
 * @param {boolean=} opt_alignRight Sets the expected alignment to be right.
 */
function getExpectedBubblePositionWithGivenAlignment(opt_alignRight) {
  var targetPosition = goog.style.getFramedPageOffset(link, window);
  var targetWidth = link.offsetWidth;
  var bubbleSize = goog.style.getSize(bubble.bubbleContainer_);
  var expectedBubbleX = opt_alignRight ?
      targetPosition.x + targetWidth - bubbleSize.width : targetPosition.x;
  var expectedBubbleY = link.offsetHeight + targetPosition.y +
      goog.ui.editor.Bubble.VERTICAL_CLEARANCE_;

  return {
    x: expectedBubbleX,
    y: expectedBubbleY
  };
}

function testCreateBubbleWithLinkPanel() {
  var id = goog.string.createUniqueString();
  panelId = bubble.addPanel("A", "Link", link, function(container) {
    container.innerHTML = '<span id="' + id + '">Test</span>';
  });
  assertNotNull('Bubble should be created', bubble.bubbleContents_);
  assertNotNull('Added element should be present', goog.dom.getElement(id));
  assertTrue('Bubble should be visible', bubble.isVisible());
}

function testCloseBubble() {
  testCreateBubbleWithLinkPanel();

  var count = 0;
  goog.events.listen(bubble, goog.ui.Component.EventType.HIDE, function() {
    count++;
  });

  bubble.removePanel(panelId);
  panelId = null;

  assertFalse('Bubble should not be visible', bubble.isVisible());
  assertEquals('Hide event should be dispatched', 1, count);
}

function testCloseBox() {
  testCreateBubbleWithLinkPanel();

  var count = 0;
  goog.events.listen(bubble, goog.ui.Component.EventType.HIDE, function() {
    count++;
  });

  var closeBox = goog.dom.getElementsByTagNameAndClass(
      goog.dom.TagName.DIV, 'tr_bubble_closebox', bubble.bubbleContainer_)[0];
  goog.testing.events.fireClickSequence(closeBox);
  panelId = null;

  assertFalse('Bubble should not be visible', bubble.isVisible());
  assertEquals('Hide event should be dispatched', 1, count);
}

function testViewPortSizeMonitorEvent() {
  testCreateBubbleWithLinkPanel();

  var numCalled = 0;
  bubble.reposition = function() {
    numCalled++;
  };

  assertNotUndefined('viewPortSizeMonitor_ should not be undefined',
      bubble.viewPortSizeMonitor_);
  bubble.viewPortSizeMonitor_.dispatchEvent(goog.events.EventType.RESIZE);

  assertEquals('reposition not called', 1, numCalled);
}

function testBubblePositionPreferTop() {
  called = false;
  bubble.positionAtAnchor_ = function(targetCorner, bubbleCorner, overflow) {
    called = true;

    // Assert that the bubble is positioned below the target.
    assertEquals(goog.positioning.Corner.TOP_START, targetCorner);
    assertEquals(goog.positioning.Corner.BOTTOM_START, bubbleCorner);

    return goog.positioning.OverflowStatus.NONE;
  };
  prepareTargetWithGivenDirection('ltr', true);
  assertTrue(called);
}

function testBubblePosition() {
  panelId = bubble.addPanel('A', 'Link', link, goog.nullFunction);
  var CLEARANCE = goog.ui.editor.Bubble.VERTICAL_CLEARANCE_;
  var bubbleContainer = bubble.bubbleContainer_;

  // The field is at a normal place, alomost the top of the viewport, and
  // there is enough space at the bottom of the field.
  var targetPos = goog.style.getFramedPageOffset(link, window);
  var targetSize = goog.style.getSize(link);
  var pos = goog.style.getFramedPageOffset(bubbleContainer);
  assertEquals(targetPos.y + targetSize.height + CLEARANCE, pos.y);
  assertEquals(targetPos.x, pos.x);

  // Move the target to the bottom of the viewport.
  var field = document.getElementById('field');
  var fieldPos = goog.style.getFramedPageOffset(field, window);
  fieldPos.y += bubble.dom_.getViewportSize().height -
      (targetPos.y + targetSize.height);
  goog.style.setStyle(field, 'position', 'absolute');
  goog.style.setPosition(field, fieldPos);
  bubble.reposition();
  var bubbleSize = goog.style.getSize(bubbleContainer);
  targetPosition = goog.style.getFramedPageOffset(link, window);
  pos = goog.style.getFramedPageOffset(bubbleContainer);
  assertEquals(targetPosition.y - CLEARANCE - bubbleSize.height, pos.y);
}

function testBubblePositionRightAligned() {
  prepareTargetWithGivenDirection('rtl');

  var expectedPos = getExpectedBubblePositionWithGivenAlignment(true);
  var pos = goog.style.getFramedPageOffset(bubble.bubbleContainer_);
  assertEquals(expectedPos.x, pos.x);
  assertEquals(expectedPos.y, pos.y);
}

/**
 * Test for bug 1955511, the bubble should align to the right side
 * of the target element when the bubble is RTL, regardless of the
 * target element's directionality.
 */
function testBubblePositionLeftToRight() {
  goog.style.setStyle(bubble.bubbleContainer_, 'direction', 'ltr');
  prepareTargetWithGivenDirection('rtl');

  var expectedPos = getExpectedBubblePositionWithGivenAlignment();
  var pos = goog.style.getFramedPageOffset(bubble.bubbleContainer_);
  assertEquals(expectedPos.x, pos.x);
  assertEquals(expectedPos.y, pos.y);
}

/**
 * Test for bug 1955511, the bubble should align to the left side
 * of the target element when the bubble is LTR, regardless of the
 * target element's directionality.
 */
function testBubblePositionRightToLeft() {
  goog.style.setStyle(bubble.bubbleContainer_, 'direction', 'rtl');
  prepareTargetWithGivenDirection('ltr');

  var expectedPos = getExpectedBubblePositionWithGivenAlignment(true);
  var pos = goog.style.getFramedPageOffset(bubble.bubbleContainer_);
  assertEquals(expectedPos.x, pos.x);
  assertEquals(expectedPos.y, pos.y);
}
">TypeError: Cannot read property 'clientWidth' of undefined
    at Object.getViewportSize_ (dom/dom.js:452:31)
    at Object.getViewportSize (dom/dom.js:411:19)
    at [object Object].setUpPage (_tmpclosuretest.js:28:31)
    at [object Object].runTests (testing/testcase.js:487:8)
    at [object Object].execute (testing/testrunner.js:266:17)
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:429:6)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>abstractdialog_test.html</td><td>Fail</td><td> 0 passed, 15 failed.</td><td title="

  goog.require('goog.dom.DomHelper');
  goog.require('goog.events.EventHandler');
  goog.require('goog.events.KeyCodes');
  goog.require('goog.testing.MockControl');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.mockmatchers.ArgumentMatcher');
  goog.require('goog.ui.editor.AbstractDialog');
  goog.require('goog.ui.editor.AbstractDialog.Builder');
  goog.require('goog.ui.editor.AbstractDialog.EventType');



var dialog;
var builder;

var mockCtrl;
var mockAfterHideHandler;
var mockOkHandler;
var mockCancelHandler;
var mockCustomButtonHandler;

var CUSTOM_EVENT = 'customEvent';
var CUSTOM_BUTTON_ID = 'customButton';


function setUp() {
  mockCtrl = new goog.testing.MockControl();
  mockAfterHideHandler = mockCtrl.createLooseMock(goog.events.EventHandler);
  mockOkHandler = mockCtrl.createLooseMock(goog.events.EventHandler);
  mockCancelHandler = mockCtrl.createLooseMock(goog.events.EventHandler);
  mockCustomButtonHandler = mockCtrl.createLooseMock(goog.events.EventHandler);
}

function tearDown() {
  if (dialog) {
    mockAfterHideHandler.$setIgnoreUnexpectedCalls(true);
    dialog.dispose();
  }
}

/**
 * Sets up the mock event handler to expect an AFTER_HIDE event.
 */
function expectAfterHide() {
  mockAfterHideHandler.handleEvent(
      new goog.testing.mockmatchers.ArgumentMatcher(function(arg) {
        return arg.type ==
               goog.ui.editor.AbstractDialog.EventType.AFTER_HIDE;
      }));
}

/**
 * Sets up the mock event handler to expect an OK event.
 */
function expectOk() {
  mockOkHandler.handleEvent(new goog.testing.mockmatchers.ArgumentMatcher(
      function(arg) {
        return arg.type == goog.ui.editor.AbstractDialog.EventType.OK;
      }));
}

/**
 * Sets up the mock event handler to expect an OK event and to call
 * preventDefault when handling it.
 */
function expectOkPreventDefault() {
  expectOk();
  mockOkHandler.$does(function(e) {
    e.preventDefault();
  });
}

/**
 * Sets up the mock event handler to expect an OK event and to return false
 * when handling it.
 */
function expectOkReturnFalse() {
  expectOk();
  mockOkHandler.$returns(false);
}

/**
 * Sets up the mock event handler to expect a CANCEL event.
 */
function expectCancel() {
  mockCancelHandler.handleEvent(new goog.testing.mockmatchers.ArgumentMatcher(
      function(arg) {
        return arg.type == goog.ui.editor.AbstractDialog.EventType.CANCEL;
      }));
}

/**
 * Sets up the mock event handler to expect a custom button event.
 */
function expectCustomButton() {
  mockCustomButtonHandler.handleEvent(
      new goog.testing.mockmatchers.ArgumentMatcher(function(arg) {
        return arg.type == CUSTOM_EVENT;
      }));
}

/**
 * Helper to create the dialog being tested in each test. Since NewDialog is
 * abstract, needs to add a concrete version of any abstract methods. Also
 * creates up the global builder variable which should be set up after the call
 * to this method.
 * @return {goog.ui.editor.AbstractDialog} The dialog.
 */
function createTestDialog() {
  var dialog = new goog.ui.editor.AbstractDialog(new goog.dom.DomHelper());
  builder = new goog.ui.editor.AbstractDialog.Builder(dialog);
  dialog.createDialogControl = function() {
    return builder.build();
  };
  dialog.createOkEvent = function(e) {
    return new goog.events.Event(goog.ui.editor.AbstractDialog.EventType.OK);
  };
  dialog.addEventListener(goog.ui.editor.AbstractDialog.EventType.AFTER_HIDE,
                          mockAfterHideHandler);
  dialog.addEventListener(goog.ui.editor.AbstractDialog.EventType.OK,
                          mockOkHandler);
  dialog.addEventListener(goog.ui.editor.AbstractDialog.EventType.CANCEL,
                          mockCancelHandler);
  dialog.addEventListener(CUSTOM_EVENT, mockCustomButtonHandler);
  return dialog;
}


/**
 * Asserts that the given dialog is open.
 * @param {string} msg Message to be printed in case of failure.
 * @param {goog.ui.editor.AbstractDialog} dialog Dialog to be tested.
 */
function assertOpen(msg, dialog) {
  assertTrue(msg + ' [AbstractDialog.isOpen()]', dialog && dialog.isOpen());
}

/**
 * Asserts that the given dialog is closed.
 * @param {string} msg Message to be printed in case of failure.
 * @param {goog.ui.editor.AbstractDialog} dialog Dialog to be tested.
 */
function assertNotOpen(msg, dialog) {
  assertFalse(msg + ' [AbstractDialog.isOpen()]', dialog && dialog.isOpen());
}


/**
 * Tests that if you create a dialog and hide it without having shown it, no
 * errors occur.
 */
function testCreateAndHide() {
  dialog = createTestDialog();
  mockCtrl.$replayAll();

  assertNotOpen('Dialog should not be open after creation', dialog);
  dialog.hide();
  assertNotOpen('Dialog should not be open after hide()', dialog);

  mockCtrl.$verifyAll(); // Verifies AFTER_HIDE was not dispatched.
}

/**
 * Tests that when you show and hide a dialog the flags indicating open are
 * correct and the AFTER_HIDE event is dispatched (and no errors happen).
 */
function testShowAndHide() {
  dialog = createTestDialog();
  expectAfterHide(dialog);
  mockCtrl.$replayAll();

  assertNotOpen('Dialog should not be open before show()', dialog);
  dialog.show();
  assertOpen('Dialog should be open after show()', dialog);
  dialog.hide();
  assertNotOpen('Dialog should not be open after hide()', dialog);

  mockCtrl.$verifyAll(); // Verifies AFTER_HIDE was dispatched.
}

/**
 * Tests that when you show and dispose a dialog (without hiding it first) the
 * flags indicating open are correct and the AFTER_HIDE event is dispatched (and
 * no errors happen).
 */
function testShowAndDispose() {
  dialog = createTestDialog();
  expectAfterHide(dialog);
  mockCtrl.$replayAll();

  assertNotOpen('Dialog should not be open before show()', dialog);
  dialog.show();
  assertOpen('Dialog should be open after show()', dialog);
  dialog.dispose();
  assertNotOpen('Dialog should not be open after dispose()', dialog);

  mockCtrl.$verifyAll(); // Verifies AFTER_HIDE was dispatched.
}

/**
 * Tests that when you dispose a dialog (without ever showing it first) the
 * flags indicating open are correct and the AFTER_HIDE event is never
 * dispatched (and no errors happen).
 */
function testDisposeWithoutShow() {
  dialog = createTestDialog();
  mockCtrl.$replayAll();

  assertNotOpen('Dialog should not be open before dispose()', dialog);
  dialog.dispose();
  assertNotOpen('Dialog should not be open after dispose()', dialog);

  mockCtrl.$verifyAll(); // Verifies AFTER_HIDE was NOT dispatched.
}

/**
 * Tests that labels set in the builder can be found in the resulting dialog's
 * HTML.
 */
function testBasicLayout() {
  dialog = createTestDialog();
  mockCtrl.$replayAll();

  // create some dialog content
  var content = goog.dom.createDom('div', null, 'The Content');
  builder.setTitle('The Title')
      .setContent(content)
      .addOkButton('The OK Button')
      .addCancelButton()
      .addButton('The Apply Button', goog.nullFunction)
      .addClassName('myClassName');
  dialog.show();

  var dialogElem = dialog.dialogInternal_.getElement();
  var html = dialogElem.innerHTML;
  // TODO(user): This is really insufficient. If the title and content
  // were swapped this test would still pass!
  assertContains('Dialog html should contain title', '>The Title<', html);
  assertContains('Dialog html should contain content', '>The Content<', html);
  assertContains('Dialog html should contain custom OK button label',
                 '>The OK Button<',
                 html);
  assertContains('Dialog html should contain default Cancel button label',
                 '>Cancel<',
                 html);
  assertContains('Dialog html should contain custom button label',
                 '>The Apply Button<',
                 html);
  assertTrue('Dialog should have default Closure class',
             goog.dom.classes.has(dialogElem, 'modal-dialog'));
  assertTrue('Dialog should have our custom class',
             goog.dom.classes.has(dialogElem, 'myClassName'));

  mockCtrl.$verifyAll();
}


/**
 * Tests that clicking the OK button dispatches the OK event and closes the
 * dialog (dispatching the AFTER_HIDE event too).
 */
function testOk() {
  dialog = createTestDialog();
  expectOk(dialog);
  expectAfterHide(dialog);
  mockCtrl.$replayAll();

  dialog.show();
  goog.testing.events.fireClickSequence(dialog.getOkButtonElement());
  assertNotOpen('Dialog should not be open after clicking OK', dialog);

  mockCtrl.$verifyAll();
}

/**
 * Tests that hitting the enter key dispatches the OK event and closes the
 * dialog (dispatching the AFTER_HIDE event too).
 */
function testEnter() {
  dialog = createTestDialog();
  expectOk(dialog);
  expectAfterHide(dialog);
  mockCtrl.$replayAll();

  dialog.show();
  goog.testing.events.fireKeySequence(dialog.dialogInternal_.getElement(),
                                      goog.events.KeyCodes.ENTER);
  assertNotOpen('Dialog should not be open after hitting enter', dialog);

  mockCtrl.$verifyAll();
}

/**
 * Tests that clicking the Cancel button dispatches the CANCEL event and closes
 * the dialog (dispatching the AFTER_HIDE event too).
 */
function testCancel() {
  dialog = createTestDialog();
  expectCancel(dialog);
  expectAfterHide(dialog);
  mockCtrl.$replayAll();

  builder.addCancelButton('My Cancel Button');

  dialog.show();
  goog.testing.events.fireClickSequence(dialog.getCancelButtonElement());
  assertNotOpen('Dialog should not be open after clicking Cancel', dialog);

  mockCtrl.$verifyAll();
}

/**
 * Tests that hitting the escape key dispatches the CANCEL event and closes
 * the dialog (dispatching the AFTER_HIDE event too).
 */
function testEscape() {
  dialog = createTestDialog();
  expectCancel(dialog);
  expectAfterHide(dialog);
  mockCtrl.$replayAll();

  dialog.show();
  goog.testing.events.fireKeySequence(dialog.dialogInternal_.getElement(),
                                      goog.events.KeyCodes.ESC);
  assertNotOpen('Dialog should not be open after hitting escape', dialog);

  mockCtrl.$verifyAll();
}

/**
 * Tests that clicking the custom button dispatches the custom event and closes
 * the dialog (dispatching the AFTER_HIDE event too).
 */
function testCustomButton() {
  dialog = createTestDialog();
  expectCustomButton(dialog);
  expectAfterHide(dialog);
  mockCtrl.$replayAll();

  builder.addButton('My Custom Button',
      function() {
        dialog.dispatchEvent(CUSTOM_EVENT)
      },
      CUSTOM_BUTTON_ID);

  dialog.show();
  goog.testing.events.fireClickSequence(
      dialog.getButtonElement(CUSTOM_BUTTON_ID));
  assertNotOpen('Dialog should not be open after clicking custom button',
                dialog);

  mockCtrl.$verifyAll();
}


/**
 * Tests that if the OK handler calls preventDefault, the dialog doesn't close.
 */
function testOkPreventDefault() {
  dialog = createTestDialog();
  expectOkPreventDefault(dialog);
  mockCtrl.$replayAll();

  dialog.show();
  goog.testing.events.fireClickSequence(dialog.getOkButtonElement());
  assertOpen('Dialog should not be closed because preventDefault was called',
             dialog);

  mockCtrl.$verifyAll();
}

/**
 * Tests that if the OK handler returns false, the dialog doesn't close.
 */
function testOkReturnFalse() {
  dialog = createTestDialog();
  expectOkReturnFalse(dialog);
  mockCtrl.$replayAll();

  dialog.show();
  goog.testing.events.fireClickSequence(dialog.getOkButtonElement());
  assertOpen('Dialog should not be closed because handler returned false',
             dialog);

  mockCtrl.$verifyAll();
}

/**
 * Tests that if creating the OK event fails, no event is dispatched and the
 * dialog doesn't close.
 */
function testCreateOkEventFail() {
  dialog = createTestDialog();
  dialog.createOkEvent = function() { // Override our mock createOkEvent.
    return null;
  };
  mockCtrl.$replayAll();

  dialog.show();
  goog.testing.events.fireClickSequence(dialog.getOkButtonElement());
  assertOpen('Dialog should not be closed because OK event creation failed',
             dialog);

  mockCtrl.$verifyAll(); // Verifies that no event was dispatched.
}


/**
 * Tests that processOkAndClose() dispatches the OK event and closes the
 * dialog (dispatching the AFTER_HIDE event too).
 */
function testProcessOkAndClose() {
  dialog = createTestDialog();
  expectOk(dialog);
  expectAfterHide(dialog);
  mockCtrl.$replayAll();

  dialog.show();
  dialog.processOkAndClose();
  assertNotOpen('Dialog should not be open after processOkAndClose()', dialog);

  mockCtrl.$verifyAll();
}

/**
 * Tests that if the OK handler triggered by processOkAndClose calls
 * preventDefault, the dialog doesn't close (in the old implementation this
 * failed due to not great design, so this is sort of a regression test).
 */
function testProcessOkAndClosePreventDefault() {
  dialog = createTestDialog();
  expectOkPreventDefault(dialog);
  mockCtrl.$replayAll();

  dialog.show();
  dialog.processOkAndClose();
  assertOpen('Dialog should not be closed because preventDefault was called',
              dialog);

  mockCtrl.$verifyAll();
}

">15 of 15 tests run in 30ms.<br />0 passed, 15 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testBasicLayout<br />Object #<Object> has no method 'createElement'<br />ERROR in testCancel<br />Object #<Object> has no method 'createElement'<br />ERROR in testCreateAndHide<br />Object #<Object> has no method 'createElement'<br />ERROR in testCreateOkEventFail<br />Object #<Object> has no method 'createElement'<br />ERROR in testCustomButton<br />Object #<Object> has no method 'createElement'<br />ERROR in testDisposeWithoutShow<br />Object #<Object> has no method 'createElement'<br />ERROR in testEnter<br />Object #<Object> has no method 'createElement'<br />ERROR in testEscape<br />Object #<Object> has no method 'createElement'<br />ERROR in testOk<br />Object #<Object> has no method 'createElement'<br />ERROR in testOkPreventDefault<br />Object #<Object> has no method 'createElement'<br />ERROR in testOkReturnFalse<br />Object #<Object> has no method 'createElement'<br />ERROR in testProcessOkAndClose<br />Object #<Object> has no method 'createElement'<br />ERROR in testProcessOkAndClosePreventDefault<br />Object #<Object> has no method 'createElement'<br />ERROR in testShowAndDispose<br />Object #<Object> has no method 'createElement'<br />ERROR in testShowAndHide<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>linkdialog_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.DomHelper');
  goog.require('goog.editor.BrowserFeature');
  goog.require('goog.editor.Link');
  goog.require('goog.events.Event');
  goog.require('goog.events.EventHandler');
  goog.require('goog.math.Size');
  goog.require('goog.testing.MockControl');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.testing.dom');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.mockmatchers');
  goog.require('goog.testing.mockmatchers.ArgumentMatcher');
  goog.require('goog.ui.editor.AbstractDialog.EventType');
  goog.require('goog.ui.editor.LinkDialog');
  goog.require('goog.ui.editor.LinkDialog.OkEvent');
  goog.require('goog.ui.editor.messages');



  var dialog;
  var mockCtrl;
  var mockLink;
  var mockOkHandler;
  var mockGetViewportSize;
  var mockWindowOpen;
  var isNew;
  var anchorElem;
  var stubs = new goog.testing.PropertyReplacer();

  var ANCHOR_TEXT = 'anchor text';
  var ANCHOR_URL = 'http://www.google.com/';
  var ANCHOR_EMAIL = 'm@r.cos';
  var ANCHOR_MAILTO = 'mailto:' + ANCHOR_EMAIL;

  function setUp() {
    anchorElem = goog.dom.createElement(goog.dom.TagName.A);
    goog.dom.appendChild(goog.dom.getDocument().body, anchorElem);

    mockCtrl = new goog.testing.MockControl();
    mockLink = mockCtrl.createLooseMock(goog.editor.Link);
    mockOkHandler = mockCtrl.createLooseMock(goog.events.EventHandler);

    isNew = false;
    mockLink.isNew();
    mockLink.$anyTimes();
    mockLink.$does(function() {
      return isNew;
    });
    mockLink.getCurrentText();
    mockLink.$anyTimes();
    mockLink.$does(function() {
      return anchorElem.innerHTML;
    });
    mockLink.setTextAndUrl(goog.testing.mockmatchers.isString,
        goog.testing.mockmatchers.isString);
    mockLink.$anyTimes();
    mockLink.$does(function(text, url) {
      anchorElem.innerHTML = text;
      anchorElem.href = url;
    });
    mockLink.$registerArgumentListVerifier('placeCursorRightOf', function() {
      return true;
    });
    mockLink.placeCursorRightOf(goog.testing.mockmatchers.iBoolean);
    mockLink.$anyTimes();
    mockLink.getAnchor();
    mockLink.$anyTimes();
    mockLink.$returns(anchorElem);

    mockWindowOpen = mockCtrl.createFunctionMock('open');
    stubs.set(window, 'open', mockWindowOpen);
  }

  function tearDown() {
    dialog.dispose();
    goog.dom.removeNode(anchorElem);
    stubs.reset();
  }

  function setUpAnchor(href, text, opt_isNew) {
    anchorElem.href = href;
    anchorElem.innerHTML = text;
    isNew = !!opt_isNew;
  }

  /**
   * Creates and shows the dialog to be tested.
   * @param {Document=} opt_document Document to render the dialog into.
   *     Defaults to the main window's document.
   */
  function createAndShow(opt_document) {
    dialog = new goog.ui.editor.LinkDialog(new goog.dom.DomHelper(opt_document),
                                           mockLink);
    dialog.addEventListener(goog.ui.editor.AbstractDialog.EventType.OK,
        mockOkHandler);
    dialog.show();
  }

  /**
   * Sets up the mock event handler to expect an OK event with the given text
   * and url.
   */
  function expectOk(linkText, linkUrl) {
    mockOkHandler.handleEvent(new goog.testing.mockmatchers.ArgumentMatcher(
        function(arg) {
          return arg.type == goog.ui.editor.AbstractDialog.EventType.OK &&
                 arg.linkText == linkText &&
                 arg.linkUrl == linkUrl;
        }));
  }

  /**
   * Tests that when you show the dialog for a new link, the input fields are
   * empty, the web tab is selected and focus is in the url input field.
   * @param {Document=} opt_document Document to render the dialog into.
   *     Defaults to the main window's document.
   */
  function testShowForNewLink(opt_document) {
    mockCtrl.$replayAll();
    setUpAnchor('', '', true); // Must be done before creating the dialog.
    createAndShow(opt_document);

    assertEquals('Display text input field should be empty',
                 '',
                 getDisplayInputText());
    assertEquals('Url input field should be empty',
                 '',
                 getUrlInputText());
    assertEquals('On the web tab should be selected',
                 goog.ui.editor.LinkDialog.Id_.ON_WEB,
                 dialog.curTabId_);
    if (goog.editor.BrowserFeature.HAS_ACTIVE_ELEMENT) {
      assertEquals('Focus should be on url input',
                   getUrlInput(),
                   dialog.dom.getDocument().activeElement);
    }

    mockCtrl.$verifyAll();
  }

  /**
   * Fakes that the mock field is using an iframe and does the same test as
   * testShowForNewLink().
   */
  function testShowForNewLinkWithDiffAppWindow() {
    testShowForNewLink(goog.dom.getElement('appWindowIframe').contentDocument);
  }

  /**
   * Tests that when you show the dialog for a url link, the input fields are
   * filled in, the web tab is selected and focus is in the url input field.
   */
  function testShowForUrlLink() {
    mockCtrl.$replayAll();
    setUpAnchor(ANCHOR_URL, ANCHOR_TEXT);
    createAndShow();

    assertEquals('Display text input field should be filled in',
                 ANCHOR_TEXT,
                 getDisplayInputText());
    assertEquals('Url input field should be filled in',
                 ANCHOR_URL,
                 getUrlInputText());
    assertEquals('On the web tab should be selected',
                 goog.ui.editor.LinkDialog.Id_.ON_WEB,
                 dialog.curTabId_);
    if (goog.editor.BrowserFeature.HAS_ACTIVE_ELEMENT) {
      assertEquals('Focus should be on url input',
                   getUrlInput(),
                   dialog.dom.getDocument().activeElement);
    }

    mockCtrl.$verifyAll();
  }

  /**
   * Tests that when you show the dialog for a mailto link, the input fields are
   * filled in, the email tab is selected and focus is in the email input field.
   */
  function testShowForMailtoLink() {
    mockCtrl.$replayAll();
    setUpAnchor(ANCHOR_MAILTO, ANCHOR_TEXT);
    createAndShow();

    assertEquals('Display text input field should be filled in',
                 ANCHOR_TEXT,
                 getDisplayInputText());
    assertEquals('Email input field should be filled in',
                 ANCHOR_EMAIL, // The 'mailto:' is not in the input!
                 getEmailInputText());
    assertEquals('Email tab should be selected',
                 goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS,
                 dialog.curTabId_);
    if (goog.editor.BrowserFeature.HAS_ACTIVE_ELEMENT) {
      assertEquals('Focus should be on email input',
                   getEmailInput(),
                   dialog.dom.getDocument().activeElement);
    }

    mockCtrl.$verifyAll();
  }

  /**
   * Tests that the display text is autogenerated from the url input in the
   * right situations (and not generated when appropriate too).
   */
  function testAutogeneration() {
    mockCtrl.$replayAll();
    setUpAnchor('', '', true);
    createAndShow();

    // Simulate typing a url when everything is empty, should autogen.
    setUrlInputText(ANCHOR_URL);
    assertEquals('Display text should have been autogenerated',
                 ANCHOR_URL,
                 getDisplayInputText());

    // Simulate typing text when url is set, afterwards should not autogen.
    setDisplayInputText(ANCHOR_TEXT);
    setUrlInputText(ANCHOR_MAILTO);
    assertNotEquals('Display text should not have been autogenerated',
                    ANCHOR_MAILTO,
                    getDisplayInputText());
    assertEquals('Display text should have remained the same',
                 ANCHOR_TEXT,
                 getDisplayInputText());

    // Simulate typing text equal to existing url, afterwards should autogen.
    setDisplayInputText(ANCHOR_MAILTO);
    setUrlInputText(ANCHOR_URL);
    assertEquals('Display text should have been autogenerated',
                 ANCHOR_URL,
                 getDisplayInputText());

    mockCtrl.$verifyAll();
  }

  /**
   * Tests that clicking OK with the url tab selected dispatches an event with
   * the proper link data.
   */
  function testOkForUrl() {
    expectOk(ANCHOR_TEXT, ANCHOR_URL);
    mockCtrl.$replayAll();
    setUpAnchor('', '', true);
    createAndShow();

    dialog.tabPane_.setSelectedTabId(goog.ui.editor.LinkDialog.Id_.ON_WEB_TAB);
    setDisplayInputText(ANCHOR_TEXT);
    setUrlInputText(ANCHOR_URL);
    goog.testing.events.fireClickSequence(dialog.getOkButtonElement());

    mockCtrl.$verifyAll();
  }

  /**
   * Tests that clicking OK with the url tab selected but with an email address
   * in the url field dispatches an event with the proper link data.
   */
  function testOkForUrlWithEmail() {
    expectOk(ANCHOR_TEXT, ANCHOR_MAILTO);
    mockCtrl.$replayAll();
    setUpAnchor('', '', true);
    createAndShow();

    dialog.tabPane_.setSelectedTabId(goog.ui.editor.LinkDialog.Id_.ON_WEB_TAB);
    setDisplayInputText(ANCHOR_TEXT);
    setUrlInputText(ANCHOR_EMAIL);
    goog.testing.events.fireClickSequence(dialog.getOkButtonElement());

    mockCtrl.$verifyAll();
  }

  /**
   * Tests that clicking OK with the email tab selected dispatches an event with
   * the proper link data.
   */
  function testOkForEmail() {
    expectOk(ANCHOR_TEXT, ANCHOR_MAILTO);
    mockCtrl.$replayAll();
    setUpAnchor('', '', true);
    createAndShow();

    dialog.tabPane_.setSelectedTabId(
        goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS_TAB);

    setDisplayInputText(ANCHOR_TEXT);
    setEmailInputText(ANCHOR_EMAIL);
    goog.testing.events.fireClickSequence(dialog.getOkButtonElement());

    mockCtrl.$verifyAll();
  }

  /**
   * Test that clicking on the test button opens a new window with the correct
   * options.
   */
  function testWebTestButton() {
    if (goog.userAgent.GECKO) {
      // TODO(robbyw): Figure out why this is flaky and fix it.
      return;
    }

    var width, height;
    mockWindowOpen(ANCHOR_URL, '_blank',
        new goog.testing.mockmatchers.ArgumentMatcher(function(str) {
          return str == 'width=' + width + ',height=' + height +
                        ',toolbar=1,scrollbars=1,location=1,statusbar=0,' +
                        'menubar=1,resizable=1'
        }, "3rd arg: (string) window.open() options"));

    mockCtrl.$replayAll();
    setUpAnchor(ANCHOR_URL, ANCHOR_TEXT);
    createAndShow();

    // Measure viewport after opening dialog because that might cause scrollbars
    // to appear and reduce the viewport size.
    var size = goog.dom.getViewportSize(window);
    width = Math.max(size.width - 50, 50);
    height = Math.max(size.height - 50, 50);

    var testLink = goog.testing.dom.findTextNode(
        goog.ui.editor.messages.MSG_TEST_THIS_LINK,
        dialog.dialogInternal_.getElement());
    goog.testing.events.fireClickSequence(testLink.parentNode);

    mockCtrl.$verifyAll();
  }

  /**
   * Test that clicking on the test button does not open a new window when
   * the event is canceled.
   */
  function testWebTestButtonPreventDefault() {
    mockCtrl.$replayAll();
    setUpAnchor(ANCHOR_URL, ANCHOR_TEXT);
    createAndShow();

    goog.events.listen(dialog,
        goog.ui.editor.LinkDialog.EventType.BEFORE_TEST_LINK,
        function(e) {
          assertEquals(e.url, ANCHOR_URL);
          e.preventDefault();
        });
    var testLink = goog.testing.dom.findTextNode(
        goog.ui.editor.messages.MSG_TEST_THIS_LINK,
        dialog.dialogInternal_.getElement());
    goog.testing.events.fireClickSequence(testLink.parentNode);

    mockCtrl.$verifyAll();
  }

  /**
   * Test that the setTextToDisplayVisible() correctly works.
   * options.
   */
  function testSetTextToDisplayVisible() {
    mockCtrl.$replayAll();
    setUpAnchor('', '', true);
    createAndShow();

    assertNotEquals('none',
                    goog.style.getStyle(dialog.textToDisplayDiv_, 'display'));
    dialog.setTextToDisplayVisible(false);
    assertEquals('none',
                 goog.style.getStyle(dialog.textToDisplayDiv_, 'display'));
    dialog.setTextToDisplayVisible(true);
    assertNotEquals('none',
                    goog.style.getStyle(dialog.textToDisplayDiv_, 'display'));

    mockCtrl.$verifyAll();
  }

  function getDisplayInput() {
    return dialog.dom.getElement(goog.ui.editor.LinkDialog.Id_.TEXT_TO_DISPLAY);
  }

  function getDisplayInputText() {
    return getDisplayInput().value;
  }

  function setDisplayInputText(text) {
    var textInput = getDisplayInput();
    textInput.value = text;
    // Fire event so that dialog behaves like when user types.
    goog.testing.events.fireBrowserEvent(new goog.events.Event('keyup',
                                                               textInput));
  }

  function getUrlInput() {
    return dialog.dom.getElement(goog.ui.editor.LinkDialog.Id_.ON_WEB_INPUT);
  }

  function getUrlInputText() {
    return getUrlInput().value;
  }

  function setUrlInputText(text) {
    var urlInput = getUrlInput();
    urlInput.value = text;
    // Fire event so that dialog behaves like when user types.
    dialog.urlInputHandler_.dispatchEvent(
        goog.events.InputHandler.EventType.INPUT);
  }

  function getEmailInput() {
    return dialog.dom.getElement(
        goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS_INPUT);
  }

  function getEmailInputText() {
    return getEmailInput().value;
  }

  function setEmailInputText(text) {
    var emailInput = getEmailInput();
    emailInput.value = text;
    // Fire event so that dialog behaves like when user types.
    dialog.emailInputHandler_.dispatchEvent(
        goog.events.InputHandler.EventType.INPUT);
  }

">Error: Namespace "goog.window" already declared.
    at Error (unknown source)
    at Object.provide (base.js:105:13)
    at window/window.js:20:6
    at [object Object].loadScript_ (/home/ubuntu/Dev/projects/node-goog/lib/goog.js:256:38)
    at /home/ubuntu/Dev/projects/node-goog/lib/goog.js:224:8
    at Object.importScript_ (base.js:455:45)
    at Object.writeScripts_ (base.js:536:14)
    at Object.require (base.js:280:12)
    at _tmpclosuretest.js:18:8
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
</td></tr>
<tr><td>controlrenderer_test.html</td><td>Fail</td><td> undefined</td><td title="

    goog.require('goog.dom.NodeType');
    goog.require('goog.dom.a11y');
    goog.require('goog.dom.a11y.Role');
    goog.require('goog.dom.a11y.State');
    goog.require('goog.dom.classes');
    goog.require('goog.style');
    goog.require('goog.testing.ExpectedFailures');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.Component.State');
    goog.require('goog.ui.Control');
    goog.require('goog.ui.ControlRenderer');
    goog.require('goog.userAgent');
  

    var control, controlRenderer, testRenderer;
    var sandbox = goog.dom.getElement('sandbox');
    var expectedFailures = new goog.testing.ExpectedFailures();

    /**
     * A subclass of ControlRenderer that overrides {@code getAriaRole} and
     * {@code getStructuralCssClass} for testing purposes.
     * @constructor
     * @extends {goog.ui.ControlRenderer}
     */
    function TestRenderer() {
      goog.ui.ControlRenderer.call(this);
    };
    goog.inherits(TestRenderer, goog.ui.ControlRenderer);
    goog.addSingletonGetter(TestRenderer);

    TestRenderer.CSS_CLASS = 'goog-button';

    TestRenderer.IE6_CLASS_COMBINATIONS = [
      ['combined', 'goog-base-hover', 'goog-button'],
      ['combined', 'goog-base-disabled', 'goog-button'],
      ['combined', 'combined2', 'goog-base-hover', 'goog-base-rtl',
       'goog-button']
    ];

    /** {@inheritDoc} */
    TestRenderer.prototype.getAriaRole = function() {
      return goog.dom.a11y.Role.BUTTON;
    };

    /** {@inheritDoc} */
    TestRenderer.prototype.getCssClass = function() {
      return TestRenderer.CSS_CLASS;
    };

    /** {@inheritDoc} */
    TestRenderer.prototype.getStructuralCssClass = function() {
      return 'goog-base';
    };

    /** {@inheritDoc} */
    TestRenderer.prototype.getIe6ClassCombinations = function() {
      return TestRenderer.IE6_CLASS_COMBINATIONS;
    };

    /**
     * @return {boolean} Whether we're on Mac Safari 3.x.
     */
    function isMacSafari3() {
      return goog.userAgent.WEBKIT && goog.userAgent.MAC &&
          !goog.userAgent.isVersion('527');
    }

    /**
     * @return {boolean} Whether we're on IE6 or lower.
     */
    function isIe6() {
      return goog.userAgent.IE && !goog.userAgent.isVersion('7');
    }

    function setUp() {
      control = new goog.ui.Control('Hello');
      controlRenderer = goog.ui.ControlRenderer.getInstance();
      testRenderer = TestRenderer.getInstance();
    }

    function tearDown() {
      control.dispose();
      expectedFailures.handleTearDown();
      control = null;
      controlRenderer = null;
      testRenderer = null;
      goog.dom.removeChildren(sandbox);
    }

    function testConstructor() {
      assertNotNull('ControlRenderer singleton instance must not be null',
          controlRenderer);
      assertNotNull('TestRenderer singleton instance must not be null',
          testRenderer);
    }

    function testGetCustomRenderer() {
      var cssClass = 'special-css-class';
      var renderer = goog.ui.ControlRenderer.getCustomRenderer(
          goog.ui.ControlRenderer, cssClass);
      assertEquals(
          'Renderer should have returned the custom CSS class.',
          cssClass,
          renderer.getCssClass());
    }

    function testGetAriaRole() {
      assertUndefined('ControlRenderer\'s ARIA role must be undefined',
          controlRenderer.getAriaRole());
      assertEquals('TestRenderer\'s ARIA role must have expected value',
          goog.dom.a11y.Role.BUTTON, testRenderer.getAriaRole());
    }

    function testCreateDom() {
      assertHTMLEquals('ControlRenderer must create correct DOM',
          '<div class="goog-control">Hello</div>',
          goog.dom.getOuterHtml(controlRenderer.createDom(control)));
      assertHTMLEquals('TestRenderer must create correct DOM',
          '<div class="goog-button goog-base">Hello</div>',
          goog.dom.getOuterHtml(testRenderer.createDom(control)));
    }

    function testGetContentElement() {
      assertEquals('getContentElement() must return its argument', sandbox,
          controlRenderer.getContentElement(sandbox));
    }

    function testEnableExtraClassName() {
      // enableExtraClassName() must be a no-op if control has no DOM.
      controlRenderer.enableExtraClassName(control, 'foo', true);

      control.createDom();
      var element = control.getElement();

      controlRenderer.enableExtraClassName(control, 'foo', true);
      assertSameElements('Extra class name must have been added',
          ['goog-control', 'foo'], goog.dom.classes.get(element));

      controlRenderer.enableExtraClassName(control, 'foo', true);
      assertSameElements('Enabling existing extra class name must be a no-op',
          ['goog-control', 'foo'], goog.dom.classes.get(element));

      controlRenderer.enableExtraClassName(control, 'bar', false);
      assertSameElements('Disabling nonexistent class name must be a no-op',
          ['goog-control', 'foo'], goog.dom.classes.get(element));

      controlRenderer.enableExtraClassName(control, 'foo', false);
      assertSameElements('Extra class name must have been removed',
          ['goog-control'], goog.dom.classes.get(element));
    }

    function testCanDecorate() {
      assertTrue('canDecorate() must return true',
          controlRenderer.canDecorate());
    }

    function testDecorate() {
      sandbox.innerHTML = '<div id="foo">Hello, world!</div>';
      var foo = goog.dom.getElement('foo');
      var element = controlRenderer.decorate(control, foo);

      assertEquals('decorate() must return its argument', foo, element);
      assertEquals('Decorated control\'s ID must be set', 'foo',
          control.getId());
      assertTrue('Decorated control\'s content must be a text node',
          control.getContent().nodeType == goog.dom.NodeType.TEXT);
      assertEquals('Decorated control\'s content must have expected value',
          'Hello, world!', control.getContent().nodeValue);
      assertEquals('Decorated control\'s state must be as expected', 0x00,
          control.getState());
      assertSameElements('Decorated element\'s classes must be as expected',
          ['goog-control'], goog.dom.classes.get(element));
    }

    function testDecorateComplexDom() {
      sandbox.innerHTML = '<div id="foo"><i>Hello</i>,<b>world</b>!</div>';
      var foo = goog.dom.getElement('foo');
      var element = controlRenderer.decorate(control, foo);

      assertEquals('decorate() must return its argument', foo, element);
      assertEquals('Decorated control\'s ID must be set', 'foo',
          control.getId());
      assertTrue('Decorated control\'s content must be an array',
          goog.isArray(control.getContent()));
      assertEquals('Decorated control\'s content must have expected length', 4,
          control.getContent().length);
      assertEquals('Decorated control\'s state must be as expected', 0x00,
          control.getState());
      assertSameElements('Decorated element\'s classes must be as expected',
          ['goog-control'], goog.dom.classes.get(element));
    }

    function testDecorateWithClasses() {
      sandbox.innerHTML =
          '<div id="foo" class="app goog-base-disabled goog-base-hover"></div>';
      var foo = goog.dom.getElement('foo');

      control.addClassName('extra');
      var element = testRenderer.decorate(control, foo);

      assertEquals('decorate() must return its argument', foo, element);
      assertEquals('Decorated control\'s ID must be set', 'foo',
          control.getId());
      assertNull('Decorated control\'s content must be null',
          control.getContent());
      assertEquals('Decorated control\'s state must be as expected',
          goog.ui.Component.State.DISABLED | goog.ui.Component.State.HOVER,
          control.getState());
      assertSameElements('Decorated element\'s classes must be as expected', [
        'app',
        'extra',
        'goog-base',
        'goog-base-disabled',
        'goog-base-hover',
        'goog-button'
      ], goog.dom.classes.get(element));
    }

    function testDecorateOptimization() {
      // Temporarily replace goog.dom.classes.set().
      var goog$dom$classes$set = goog.dom.classes.set;
      goog.dom.classes.set = function() {
        fail('goog.dom.classes.set() must not be called');
      };

      // Since foo has all required classes, goog.dom.classes.set() must not be
      // called at all.
      sandbox.innerHTML = '<div id="foo" class="goog-control">Foo</div>';
      controlRenderer.decorate(control, goog.dom.getElement('foo'));

      // Since bar has all required classes, goog.dom.classes.set() must not be
      // called at all.
      sandbox.innerHTML = '<div id="bar" class="goog-base goog-button">Bar' +
          '</div>';
      testRenderer.decorate(control, goog.dom.getElement('bar'));

      // Since baz has all required classes, goog.dom.classes.set() must not be
      // called at all.
      sandbox.innerHTML = '<div id="baz" class="goog-base goog-button ' +
          'goog-button-disabled">Baz</div>';
      testRenderer.decorate(control, goog.dom.getElement('baz'));

      // Restore goog.dom.classes.set().
      goog.dom.classes.set = goog$dom$classes$set;
    }

    function testInitializeDom() {
      var renderer = new goog.ui.ControlRenderer();

      // Replace setRightToLeft().
      renderer.setRightToLeft = function() {
        fail('setRightToLeft() must not be called');
      };

      // When a control with default render direction enters the document,
      // setRightToLeft() must not be called.
      control.setRenderer(renderer);
      control.render(sandbox);

      // When a control in the default state (enabled, visible, focusable)
      // enters the document, it must get a tab index.
      // Expected to fail on Mac Safari 3, because it doesn't support tab index.
      expectedFailures.expectFailureFor(isMacSafari3());
      try {
        assertTrue('Enabled, visible, focusable control must have tab index',
            goog.dom.isFocusableTabIndex(control.getElement()));
      } catch (e) {
        expectedFailures.handleException(e);
      }
    }

    function testInitializeDomDecorated() {
      var renderer = new goog.ui.ControlRenderer();

      // Replace setRightToLeft().
      renderer.setRightToLeft = function() {
        fail('setRightToLeft() must not be called');
      };

      sandbox.innerHTML = '<div id="foo" class="goog-control">Foo</div>';

      // When a control with default render direction enters the document,
      // setRightToLeft() must not be called.
      control.setRenderer(renderer);
      control.decorate(goog.dom.getElement('foo'));

      // When a control in the default state (enabled, visible, focusable)
      // enters the document, it must get a tab index.
      // Expected to fail on Mac Safari 3, because it doesn't support tab index.
      expectedFailures.expectFailureFor(isMacSafari3());
      try {
        assertTrue('Enabled, visible, focusable control must have tab index',
            goog.dom.isFocusableTabIndex(control.getElement()));
      } catch (e) {
        expectedFailures.handleException(e);
      }
    }

    function testInitializeDomDisabledBiDi() {
      var renderer = new goog.ui.ControlRenderer();

      // Replace setFocusable().
      renderer.setFocusable = function() {
        fail('setFocusable() must not be called');
      };

      // When a disabled control enters the document, setFocusable() must not
      // be called.
      control.setEnabled(false);
      control.setRightToLeft(true);
      control.setRenderer(renderer);
      control.render(sandbox);

      // When a right-to-left control enters the document, special stying must
      // be applied.
      assertSameElements('BiDi control must have right-to-left class',
          ['goog-control', 'goog-control-disabled', 'goog-control-rtl'],
          goog.dom.classes.get(control.getElement()));
    }

    function testInitializeDomDisabledBiDiDecorated() {
      var renderer = new goog.ui.ControlRenderer();

      // Replace setFocusable().
      renderer.setFocusable = function() {
        fail('setFocusable() must not be called');
      };

      sandbox.innerHTML =
          '<div dir="rtl">\n' +
          '  <div id="foo" class="goog-control-disabled">Foo</div>\n' +
          '</div>\n';

      // When a disabled control enters the document, setFocusable() must not
      // be called.
      control.setRenderer(renderer);
      control.decorate(goog.dom.getElement('foo'));

      // When a right-to-left control enters the document, special stying must
      // be applied.
      assertSameElements('BiDi control must have right-to-left class',
          ['goog-control', 'goog-control-disabled', 'goog-control-rtl'],
          goog.dom.classes.get(control.getElement()));
    }

    function testSetAriaRole() {
      sandbox.innerHTML = '<div id="foo">Foo</div><div id="bar">Bar</div>';

      var foo = goog.dom.getElement('foo');
      controlRenderer.setAriaRole(foo);
      assertEquals('ControlRenderer must not set ARIA role', '',
          goog.dom.a11y.getRole(foo));

      var bar = goog.dom.getElement('bar');
      testRenderer.setAriaRole(bar);
      assertEquals('Element must have expected ARIA role',
          goog.dom.a11y.Role.BUTTON, goog.dom.a11y.getRole(bar));
    }

    function testSetAllowTextSelection() {
      sandbox.innerHTML = '<div id="foo"><span>Foo</span></div>';
      var foo = goog.dom.getElement('foo');

      controlRenderer.setAllowTextSelection(foo, false);
      assertTrue('Parent element must be unselectable on all browsers',
          goog.style.isUnselectable(foo));
      if (goog.userAgent.IE || goog.userAgent.OPERA) {
        assertTrue('On IE and Opera, child element must also be unselectable',
            goog.style.isUnselectable(foo.firstChild));
      } else {
        assertFalse('On browsers other than IE and Opera, the child element ' +
            'must not be unselectable',
            goog.style.isUnselectable(foo.firstChild));
      }

      controlRenderer.setAllowTextSelection(foo, true);
      assertFalse('Parent element must be selectable',
          goog.style.isUnselectable(foo));
      assertFalse('Child element must be unselectable',
          goog.style.isUnselectable(foo.firstChild));
    }

    function testSetRightToLeft() {
      sandbox.innerHTML = '<div id="foo">Foo</div><div id="bar">Bar</div>';

      var foo = goog.dom.getElement('foo');
      controlRenderer.setRightToLeft(foo, true);
      assertSameElements('Element must have right-to-left class applied',
          ['goog-control-rtl'], goog.dom.classes.get(foo));
      controlRenderer.setRightToLeft(foo, false);
      assertSameElements('Element must not have right-to-left class applied',
          [], goog.dom.classes.get(foo));

      var bar = goog.dom.getElement('bar');
      testRenderer.setRightToLeft(bar, true);
      assertSameElements('Element must have right-to-left class applied',
          ['goog-base-rtl'], goog.dom.classes.get(bar));
      testRenderer.setRightToLeft(bar, false);
      assertSameElements('Element must not have right-to-left class applied',
          [], goog.dom.classes.get(bar));
    }

    function testIsFocusable() {
      control.render(sandbox);
      // Expected to fail on Mac Safari 3, because it doesn't support tab index.
      expectedFailures.expectFailureFor(isMacSafari3());
      try {
        assertTrue('Control\'s key event target must be focusable',
            controlRenderer.isFocusable(control));
      } catch (e) {
        expectedFailures.handleException(e);
      }
    }

    function testIsFocusableForNonFocusableControl() {
      control.setSupportedState(goog.ui.Component.State.FOCUSED, false);
      control.render(sandbox);
      assertFalse('Non-focusable control\'s key event target must not be ' +
          'focusable', controlRenderer.isFocusable(control));
    }

    function testIsFocusableForControlWithoutKeyEventTarget() {
      // Unrendered control has no key event target.
      assertNull('Unrendered control must not have key event target',
          control.getKeyEventTarget());
      assertFalse('isFocusable() must return null if no key event target',
          controlRenderer.isFocusable(control));
    }

    function testSetFocusable() {
      control.render(sandbox);
      controlRenderer.setFocusable(control, false);
      assertFalse('Control\'s key event target must not have tab index',
          goog.dom.isFocusableTabIndex(control.getKeyEventTarget()));
      controlRenderer.setFocusable(control, true);
      // Expected to fail on Mac Safari 3, because it doesn't support tab index.
      expectedFailures.expectFailureFor(isMacSafari3());
      try {
        assertTrue('Control\'s key event target must have focusable tab index',
            goog.dom.isFocusableTabIndex(control.getKeyEventTarget()));
      } catch (e) {
        expectedFailures.handleException(e);
      }
    }

    function testSetFocusableForNonFocusableControl() {
      control.setSupportedState(goog.ui.Component.State.FOCUSED, false);
      control.render(sandbox);
      assertFalse('Non-focusable control\'s key event target must not be ' +
          'focusable',
          goog.dom.isFocusableTabIndex(control.getKeyEventTarget()));
      controlRenderer.setFocusable(control, true);
      assertFalse('Non-focusable control\'s key event target must not be ' +
          'focusable, even after calling setFocusable(true)',
          goog.dom.isFocusableTabIndex(control.getKeyEventTarget()));
    }

    function testSetVisible() {
      sandbox.innerHTML = '<div id="foo">Foo</div>';
      var foo = goog.dom.getElement('foo');
      assertTrue('Element must be visible', foo.style.display != 'none');
      controlRenderer.setVisible(foo, true);
      assertTrue('Element must still be visible', foo.style.display != 'none');
      controlRenderer.setVisible(foo, false);
      assertTrue('Element must be hidden', foo.style.display == 'none');
    }

    function testSetState() {
      control.setRenderer(testRenderer);
      control.createDom();
      var element = control.getElement();

      assertSameElements('Control must have expected class names',
          ['goog-button', 'goog-base'], goog.dom.classes.get(element));
      assertEquals('Control must not have disabled ARIA state', '',
          goog.dom.a11y.getState(element, goog.dom.a11y.State.DISABLED));

      testRenderer.setState(control, goog.ui.Component.State.DISABLED, true);
      assertSameElements('Control must have disabled class name',
          ['goog-button', 'goog-base', 'goog-base-disabled'],
          goog.dom.classes.get(element));
      assertEquals('Control must have disabled ARIA state', 'true',
          goog.dom.a11y.getState(element, goog.dom.a11y.State.DISABLED));

      testRenderer.setState(control, goog.ui.Component.State.DISABLED, false);
      assertSameElements('Control must no longer have disabled class name',
          ['goog-button', 'goog-base'], goog.dom.classes.get(element));
      assertEquals('Control must not have disabled ARIA state',
          'false',
          goog.dom.a11y.getState(element, goog.dom.a11y.State.DISABLED));

      testRenderer.setState(control, 0xFFFFFF, true);
      assertSameElements('Class names must be unchanged for invalid state',
          ['goog-button', 'goog-base'], goog.dom.classes.get(element));
    }

    function testUpdateAriaState() {
      control.createDom();
      var element = control.getElement();

      controlRenderer.updateAriaState(element, goog.ui.Component.State.ACTIVE,
          true);
      assertEquals('Control must have pressed ARIA state', 'true',
          goog.dom.a11y.getState(element, goog.dom.a11y.State.PRESSED));

      controlRenderer.updateAriaState(element, goog.ui.Component.State.ACTIVE,
          false);
      assertEquals('Control must no longer have pressed ARIA state',
          'false',
          goog.dom.a11y.getState(element, goog.dom.a11y.State.PRESSED));
  }

    function testSetContent() {
      sandbox.innerHTML = 'Hello, world!';
      controlRenderer.setContent(sandbox, 'Not so fast!');
      assertEquals('Element must contain expected text value', 'Not so fast!',
          goog.dom.getTextContent(sandbox));
    }

    function testSetContentNull() {
      sandbox.innerHTML = 'Hello, world!';
      controlRenderer.setContent(sandbox, null);
      assertEquals('Element must have no child nodes', 0,
          sandbox.childNodes.length);
      assertEquals('Element must contain expected text value', '',
          goog.dom.getTextContent(sandbox));
    }

    function testSetContentEmpty() {
      sandbox.innerHTML = 'Hello, world!';
      controlRenderer.setContent(sandbox, '');
      assertEquals('Element must not have children', 0,
          sandbox.childNodes.length);
      assertEquals('Element must contain expected text value', '',
          goog.dom.getTextContent(sandbox));
    }

    function testSetContentWhitespace() {
      sandbox.innerHTML = 'Hello, world!';
      controlRenderer.setContent(sandbox, ' ');
      assertEquals('Element must have one child', 1,
          sandbox.childNodes.length);
      assertEquals('Child must be a text node', goog.dom.NodeType.TEXT,
          sandbox.firstChild.nodeType);
      assertEquals('Element must contain expected text value', ' ',
          goog.dom.getTextContent(sandbox));
    }

    function testSetContentTextNode() {
      sandbox.innerHTML = 'Hello, world!';
      controlRenderer.setContent(sandbox, document.createTextNode('Text'));
      assertEquals('Element must have one child', 1,
          sandbox.childNodes.length);
      assertEquals('Child must be a text node', goog.dom.NodeType.TEXT,
          sandbox.firstChild.nodeType);
      assertEquals('Element must contain expected text value', 'Text',
          goog.dom.getTextContent(sandbox));
    }

    function testSetContentElementNode() {
      sandbox.innerHTML = 'Hello, world!';
      controlRenderer.setContent(sandbox,
          goog.dom.createDom('div', {id: 'foo'}, 'Foo'));
      assertEquals('Element must have one child', 1,
          sandbox.childNodes.length);
      assertEquals('Child must be an element node', goog.dom.NodeType.ELEMENT,
          sandbox.firstChild.nodeType);
      assertHTMLEquals('Element must contain expected HTML',
          '<div id="foo">Foo</div>', sandbox.innerHTML);
    }

    function testSetContentArray() {
      sandbox.innerHTML = 'Hello, world!';
      controlRenderer.setContent(sandbox,
          ['Hello, ', goog.dom.createDom('b', null, 'world'), '!']);
      assertEquals('Element must have three children', 3,
          sandbox.childNodes.length);
      assertEquals('1st child must be a text node', goog.dom.NodeType.TEXT,
          sandbox.childNodes[0].nodeType);
      assertEquals('2nd child must be an element', goog.dom.NodeType.ELEMENT,
          sandbox.childNodes[1].nodeType);
      assertEquals('3rd child must be a text node', goog.dom.NodeType.TEXT,
          sandbox.childNodes[2].nodeType);
      assertHTMLEquals('Element must contain expected HTML',
          'Hello, <b>world</b>!', sandbox.innerHTML);
    }

    function testSetContentNodeList() {
      sandbox.innerHTML = 'Hello, world!';
      var div = goog.dom.createDom('div', null, 'Hello, ',
          goog.dom.createDom('b', null, 'world'), '!');
      controlRenderer.setContent(sandbox, div.childNodes);
      assertEquals('Element must have three children', 3,
          sandbox.childNodes.length);
      assertEquals('1st child must be a text node', goog.dom.NodeType.TEXT,
          sandbox.childNodes[0].nodeType);
      assertEquals('2nd child must be an element', goog.dom.NodeType.ELEMENT,
          sandbox.childNodes[1].nodeType);
      assertEquals('3rd child must be a text node', goog.dom.NodeType.TEXT,
          sandbox.childNodes[2].nodeType);
      assertHTMLEquals('Element must contain expected HTML',
          'Hello, <b>world</b>!', sandbox.innerHTML);
    }

    function testGetKeyEventTarget() {
      assertNull('Key event target for unrendered control must be null',
          controlRenderer.getKeyEventTarget(control));
      control.createDom();
      assertEquals('Key event target for rendered control must be its element',
          control.getElement(), controlRenderer.getKeyEventTarget(control));
    }

    function testGetCssClass() {
      assertEquals('ControlRenderer\'s CSS class must have expected value',
          goog.ui.ControlRenderer.CSS_CLASS, controlRenderer.getCssClass());
      assertEquals('TestRenderer\'s CSS class must have expected value',
          TestRenderer.CSS_CLASS, testRenderer.getCssClass());
    }

    function testGetStructuralCssClass() {
      assertEquals('ControlRenderer\'s structural class must be its CSS class',
          controlRenderer.getCssClass(),
          controlRenderer.getStructuralCssClass());
      assertEquals('TestRenderer\'s structural class must have expected value',
          'goog-base', testRenderer.getStructuralCssClass());
    }

    function testGetClassNames() {
      // These tests use assertArrayEquals, because the order is significant.
      assertArrayEquals('ControlRenderer must return expected class names ' +
          'in the expected order',
          ['goog-control'],
          controlRenderer.getClassNames(control));
      assertArrayEquals('TestRenderer must return expected class names ' +
          'in the expected order',
          ['goog-button', 'goog-base'],
          testRenderer.getClassNames(control));
    }

    function testGetClassNamesForControlWithState() {
      control.setStateInternal(goog.ui.Component.State.HOVER |
          goog.ui.Component.State.ACTIVE);

      // These tests use assertArrayEquals, because the order is significant.
      assertArrayEquals('ControlRenderer must return expected class names ' +
          'in the expected order',
          ['goog-control', 'goog-control-hover', 'goog-control-active'],
          controlRenderer.getClassNames(control));
      assertArrayEquals('TestRenderer must return expected class names ' +
          'in the expected order',
          ['goog-button', 'goog-base', 'goog-base-hover', 'goog-base-active'],
          testRenderer.getClassNames(control));
    }

    function testGetClassNamesForControlWithExtraClassNames() {
      control.addClassName('foo');
      control.addClassName('bar');

      // These tests use assertArrayEquals, because the order is significant.
      assertArrayEquals('ControlRenderer must return expected class names ' +
          'in the expected order',
          ['goog-control', 'foo', 'bar'],
          controlRenderer.getClassNames(control));
      assertArrayEquals('TestRenderer must return expected class names ' +
          'in the expected order',
          ['goog-button', 'goog-base', 'foo', 'bar'],
          testRenderer.getClassNames(control));
    }

    function testGetClassNamesForControlWithStateAndExtraClassNames() {
      control.setStateInternal(goog.ui.Component.State.HOVER |
          goog.ui.Component.State.ACTIVE);
      control.addClassName('foo');
      control.addClassName('bar');

      // These tests use assertArrayEquals, because the order is significant.
      assertArrayEquals('ControlRenderer must return expected class names ' +
          'in the expected order', [
            'goog-control',
            'goog-control-hover',
            'goog-control-active',
            'foo',
            'bar'
          ], controlRenderer.getClassNames(control));
      assertArrayEquals('TestRenderer must return expected class names ' +
          'in the expected order', [
            'goog-button',
            'goog-base',
            'goog-base-hover',
            'goog-base-active',
            'foo',
            'bar'
          ], testRenderer.getClassNames(control));
    }

    function testGetClassNamesForState() {
      // These tests use assertArrayEquals, because the order is significant.
      assertArrayEquals('ControlRenderer must return expected class names ' +
          'in the expected order',
          ['goog-control-hover', 'goog-control-checked'],
          controlRenderer.getClassNamesForState(goog.ui.Component.State.HOVER |
              goog.ui.Component.State.CHECKED));
      assertArrayEquals('TestRenderer must return expected class names ' +
          'in the expected order',
          ['goog-base-hover', 'goog-base-checked'],
          testRenderer.getClassNamesForState(goog.ui.Component.State.HOVER |
              goog.ui.Component.State.CHECKED));
    }

    function testGetClassForState() {
      var renderer = new goog.ui.ControlRenderer();
      assertUndefined('State-to-class map must not exist until first use',
          renderer.classByState_);
      assertEquals('Renderer must return expected class name for SELECTED',
          'goog-control-selected',
          renderer.getClassForState(goog.ui.Component.State.SELECTED));
      assertUndefined('Renderer must return undefined for invalid state',
          renderer.getClassForState('foo'));
    }

    function testGetStateFromClass() {
      var renderer = new goog.ui.ControlRenderer();
      assertUndefined('Class-to-state map must not exist until first use',
          renderer.stateByClass_);
      assertEquals('Renderer must return expected state',
          goog.ui.Component.State.SELECTED,
          renderer.getStateFromClass('goog-control-selected'));
      assertEquals('Renderer must return 0x00 for unknown class',
          0x00,
          renderer.getStateFromClass('goog-control-annoyed'));
    }

    function testIe6ClassCombinationsCreateDom() {
      control.setRenderer(testRenderer);

      control.enableClassName('combined', true);

      control.createDom();
      var element = control.getElement();

      testRenderer.setState(control, goog.ui.Component.State.DISABLED, true);
      var expectedClasses = [
        'combined',
        'goog-base',
        'goog-base-disabled',
        'goog-button'
      ];
      if (isIe6()) {
        assertSameElements('IE6 and lower should have one combined class',
            expectedClasses.concat(['combined_goog-base-disabled_goog-button']),
            goog.dom.classes.get(element));
      } else {
        assertSameElements('Non IE6 browsers should not have a combined class',
            expectedClasses, goog.dom.classes.get(element));
      }

      testRenderer.setState(control, goog.ui.Component.State.DISABLED, false);
      testRenderer.setState(control, goog.ui.Component.State.HOVER, true);
      var expectedClasses = [
        'combined',
        'goog-base',
        'goog-base-hover',
        'goog-button'
      ];
      if (isIe6()) {
        assertSameElements('IE6 and lower should have one combined class',
            expectedClasses.concat(['combined_goog-base-hover_goog-button']),
            goog.dom.classes.get(element));
      } else {
        assertSameElements('Non IE6 browsers should not have a combined class',
            expectedClasses, goog.dom.classes.get(element));
      }

      testRenderer.setRightToLeft(element, true);
      testRenderer.enableExtraClassName(control, 'combined2', true);
      var expectedClasses = [
        'combined',
        'combined2',
        'goog-base',
        'goog-base-hover',
        'goog-base-rtl',
        'goog-button'
      ];
      if (isIe6()) {
        assertSameElements('IE6 and lower should have two combined class',
            expectedClasses.concat([
              'combined_goog-base-hover_goog-button',
              'combined_combined2_goog-base-hover_goog-base-rtl_goog-button'
            ]), goog.dom.classes.get(element));
      } else {
        assertSameElements('Non IE6 browsers should not have a combined class',
            expectedClasses, goog.dom.classes.get(element));
      }

    }

    function testIe6ClassCombinationsDecorate() {
      sandbox.innerHTML =
          '<div id="foo" class="combined goog-base-hover"></div>';
      var foo = goog.dom.getElement('foo');

      var element = testRenderer.decorate(control, foo);

      var expectedClasses = [
        'combined',
        'goog-base',
        'goog-base-hover',
        'goog-button'
      ];
      if (isIe6()) {
        assertSameElements('IE6 and lower should have one combined class',
            expectedClasses.concat(['combined_goog-base-hover_goog-button']),
            goog.dom.classes.get(element));
      } else {
        assertSameElements('Non IE6 browsers should not have a combined class',
            expectedClasses, goog.dom.classes.get(element));
      }

    }
  ">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:19:28
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>buttonrenderer_test.html</td><td>Fail</td><td> undefined</td><td title="

    goog.require('goog.dom.a11y');
    goog.require('goog.dom.a11y.Role');
    goog.require('goog.dom.a11y.State');
    goog.require('goog.dom.classes');
    goog.require('goog.style');
    goog.require('goog.testing.ExpectedFailures');
    goog.require('goog.testing.jsunit');
    goog.require('goog.testing.ui.rendererasserts');
    goog.require('goog.ui.Button');
    goog.require('goog.ui.ButtonRenderer');
    goog.require('goog.ui.ButtonSide');
  

    var button, buttonRenderer, testRenderer;
    var sandbox = goog.dom.getElement('sandbox');
    var expectedFailures = new goog.testing.ExpectedFailures();
    
    /**
     * A subclass of ButtonRenderer that overrides
     * {@code getStructuralCssClass} for testing purposes.
     * @constructor
     * @extends {goog.ui.ControlRenderer}
     */
    function TestRenderer() {
      goog.ui.ButtonRenderer.call(this);
    };
    goog.inherits(TestRenderer, goog.ui.ButtonRenderer);
    goog.addSingletonGetter(TestRenderer);

    /** {@inheritDoc} */
    TestRenderer.prototype.getStructuralCssClass = function() {
      return 'goog-base';
    };

    function setUp() {
      buttonRenderer = goog.ui.ButtonRenderer.getInstance();
      button = new goog.ui.Button('Hello', buttonRenderer);
      testRenderer = TestRenderer.getInstance();
    }

    function tearDown() {
      button.dispose();
      goog.dom.removeChildren(sandbox);
      expectedFailures.handleTearDown();
    }

    function testConstructor() {
      assertNotNull('ButtonRenderer singleton instance must not be null',
          buttonRenderer);
    }

    function testGetAriaRole() {
      assertEquals('ButtonRenderer\'s ARIA role must have expected value',
          goog.dom.a11y.Role.BUTTON, buttonRenderer.getAriaRole());
    }

    function testCreateDom() {
      var element = buttonRenderer.createDom(button);
      assertNotNull('Element must not be null', element);
      assertEquals('Element must be a DIV', 'DIV', element.tagName);
      assertHTMLEquals('Element must have expected structure',
          '<div class="goog-button">Hello</div>',
          goog.dom.getOuterHtml(element));

      button.setTooltip('Hello, world!');
      button.setValue('foo');
      element = buttonRenderer.createDom(button);
      assertNotNull('Element must not be null', element);
      assertEquals('Element must be a DIV', 'DIV', element.tagName);
      assertSameElements('Element must have expected class name',
          ['goog-button'], goog.dom.classes.get(element));
      assertEquals('Element must have expected title', 'Hello, world!',
          element.title);
      assertUndefined('Element must have no value', element.value);
      assertEquals('Element must have expected contents', 'Hello',
          element.innerHTML);

      button.setSupportedState(goog.ui.Component.State.CHECKED, true);
      var element = buttonRenderer.createDom(button);
      assertEquals('button\'s aria-pressed attribute must be false', 'false',
          goog.dom.a11y.getState(element, goog.dom.a11y.State.PRESSED));
    }

    function testDecorate() {
      sandbox.innerHTML =
          '<div id="foo">Foo</div>\n' +
          '<div id="bar" title="Hello, world!">Bar</div>\n' +
          '<div id="toggle">Toggle</div>';

      var foo = new goog.ui.Button(null, buttonRenderer);
      foo.decorate(goog.dom.getElement('foo'));
      assertEquals('foo\'s tooltip must be the empty string', '',
          foo.getTooltip());
      foo.dispose();

      var bar = new goog.ui.Button(null, buttonRenderer);
      bar.decorate(goog.dom.getElement('bar'));
      assertEquals('bar\'s tooltip must be initialized', 'Hello, world!',
          bar.getTooltip());
      bar.dispose();

      var toggle = new goog.ui.Button(null, buttonRenderer);
      toggle.setSupportedState(goog.ui.Component.State.CHECKED, true);
      var element = goog.dom.getElement('toggle');
      toggle.decorate(element);
      assertEquals('toggle\'s aria-pressed attribute must be false', 'false',
          goog.dom.a11y.getState(element, goog.dom.a11y.State.PRESSED));
      toggle.dispose();
    }
    
    function testCollapse() {
      buttonRenderer.setCollapsed(button, goog.ui.ButtonSide.START);
      assertSameElements('Button should have class to collapse start',
          ['goog-button-collapse-left'], button.getExtraClassNames());
      buttonRenderer.setCollapsed(button, goog.ui.ButtonSide.END);
      assertSameElements('Button should have class to collapse end',
          ['goog-button-collapse-right'], button.getExtraClassNames());
      buttonRenderer.setCollapsed(button, goog.ui.ButtonSide.BOTH);
      assertSameElements('Button should have classes to collapse both',
          ['goog-button-collapse-left', 'goog-button-collapse-right'],
          button.getExtraClassNames());
    }
    
    function testCollapseRtl() {
      button.setRightToLeft(true);
      buttonRenderer.setCollapsed(button, goog.ui.ButtonSide.START);
      assertSameElements('Button should have class to collapse start',
          ['goog-button-collapse-right'], button.getExtraClassNames());
      buttonRenderer.setCollapsed(button, goog.ui.ButtonSide.END);
      assertSameElements('Button should have class to collapse end',
          ['goog-button-collapse-left'], button.getExtraClassNames());
      buttonRenderer.setCollapsed(button, goog.ui.ButtonSide.BOTH);
      assertSameElements('Button should have classes to collapse both',
          ['goog-button-collapse-left', 'goog-button-collapse-right'],
          button.getExtraClassNames());
    }
    
    function testCollapseWithStructuralClass() {
      testRenderer.setCollapsed(button, goog.ui.ButtonSide.BOTH);
      assertSameElements('Should use structural class for collapse classes',
          ['goog-base-collapse-left', 'goog-base-collapse-right'],
          button.getExtraClassNames());
    }

    function testUpdateAriaState() {
      var element = buttonRenderer.createDom(button);
      buttonRenderer.updateAriaState(element, goog.ui.Component.State.CHECKED,
          true);
      assertEquals('Button must have pressed ARIA state', 'true',
          goog.dom.a11y.getState(element, goog.dom.a11y.State.PRESSED));

      // Test for updating a state other than CHECKED
      buttonRenderer.updateAriaState(element, goog.ui.Component.State.DISABLED,
          true);
      assertEquals('Button must have disabled ARIA state', 'true',
          goog.dom.a11y.getState(element, goog.dom.a11y.State.DISABLED));

      buttonRenderer.updateAriaState(element, goog.ui.Component.State.CHECKED,
          false);
      assertEquals('Control must no longer have pressed ARIA state',
          'false',
          goog.dom.a11y.getState(element, goog.dom.a11y.State.PRESSED));
    }

    function testDoesntCallGetCssClassInConstructor() {
      goog.testing.ui.rendererasserts.
          assertNoGetCssClassCallsInConstructor(goog.ui.ButtonRenderer);
    }

  ">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:18:28
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>primaryactionbuttonrenderer_test.html</td><td>Fail</td><td> 0 passed, 2 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.testing.jsunit');
    goog.require('goog.testing.ui.style');
    goog.require('goog.ui.Button');
    goog.require('goog.ui.style.app.PrimaryActionButtonRenderer');
    goog.require('goog.userAgent');
  

    var renderer = goog.ui.style.app.PrimaryActionButtonRenderer.getInstance();
    var button;

    // Write iFrame tag to load reference FastUI markup. Then, our tests will
    // compare the generated markup to the reference markup.
    var refPath = '../../../../../webutil/css/fastui/app/primaryactionbutton_spec.html';
    goog.testing.ui.style.writeReferenceFrame(refPath);

    function setUp() {
      button = new goog.ui.Button('Hello Generated', renderer);
    }

    function tearDown() {
      if (button) {
        button.dispose();
      }
      goog.dom.getElement('sandbox').innerHTML = '';
    }

    function testGeneratedButton() {
      button.render(goog.dom.getElement('sandbox'));
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-resting');
    }

    function testButtonStates() {
      button.render(goog.dom.getElement('sandbox'));
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-resting');
      button.setState(goog.ui.Component.State.HOVER, true);
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-hover');
      button.setState(goog.ui.Component.State.HOVER, false);
      button.setState(goog.ui.Component.State.FOCUSED, true);
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-focused');
      button.setState(goog.ui.Component.State.FOCUSED, false);
      button.setState(goog.ui.Component.State.ACTIVE, true);
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-active');
      button.setState(goog.ui.Component.State.ACTIVE, false);
      button.setState(goog.ui.Component.State.DISABLED, true);
      goog.testing.ui.style.assertStructureMatchesReference(button.getElement(),
        'normal-disabled');
    }

  ">2 of 2 tests run in 10ms.<br />0 passed, 2 failed.<br />5 ms/test. 1 files loaded.<br />ERROR in testButtonStates<br />Object #<Object> has no method 'createElement'<br />ERROR in testGeneratedButton<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>hsvapalette_test.html</td><td>Fail</td><td> 3 passed, 7 failed.</td><td title="


    goog.require('goog.color.alpha');
    goog.require('goog.events');
    goog.require('goog.math.Rect');
    goog.require('goog.style');
    goog.require('goog.testing.PropertyReplacer');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.HsvaPalette');
    goog.require('goog.userAgent');
  

    var samplePalette;
    var eventWasFired = false;
    var stubs = new goog.testing.PropertyReplacer();

    function setUp() {
      samplePalette = new goog.ui.HsvaPalette();
    }

    function tearDown() {
      samplePalette.dispose();
      stubs.reset();
    }

    function testZeroAlpha() {
      var palette = new goog.ui.HsvaPalette(null, undefined, 0);
      assertEquals(0, palette.getAlpha());
    }

    function testOptionalInitialColor() {
      var alpha = 0.5;
      var color = '#0000ff';
      var palette = new goog.ui.HsvaPalette(null, color, alpha);
      assertEquals(color, palette.getColor());
      assertEquals(alpha, palette.getAlpha());
    }

    function testCustomClassName() {
      var customClassName = 'custom-plouf';
      var customClassPalette =
          new goog.ui.HsvaPalette(null, null, null, customClassName);
      customClassPalette.createDom();
      assertTrue(goog.dom.classes.has(customClassPalette.getElement(),
                                      customClassName));
    }

    function testSetColor() {
      var color = '#abcdef01';
      samplePalette.setColorRgbaHex(color);
      assertEquals(color,
          goog.color.alpha.parse(samplePalette.getColorRgbaHex()).hex);
    }

    function testRender() {
      samplePalette.render(document.getElementById('sandbox'));

      assertTrue(samplePalette.isInDocument());

      var elem = samplePalette.getElement();
      assertNotNull(elem);
      assertEquals(goog.dom.TagName.DIV, elem.tagName);

      if (goog.userAgent.IE && !goog.userAgent.isVersion('7')) {
        assertSameElements('On IE6, the noalpha class must be present',
            ['goog-hsva-palette', 'goog-hsva-palette-noalpha'],
            goog.dom.classes.get(elem));
      } else {
        assertEquals('The noalpha class must not be present',
           'goog-hsva-palette', elem.className);
      }
    }

    function testNoLeftOverListenersAfterDispose() {
      var initialListenerCount = goog.events.getTotalListenerCount();
      samplePalette.render(document.getElementById('sandbox'));
      samplePalette.dispose();
      assertEquals(initialListenerCount, goog.events.getTotalListenerCount());
    }

    function testInputColor() {
      samplePalette.render(document.getElementById('sandbox'));
      var color = '#00112233';
      samplePalette.inputEl_.value = color;
      samplePalette.handleInput_(null);
      assertEquals(color,
          goog.color.alpha.parse(samplePalette.getColorRgbaHex()).hex);
    }

    function testHandleMouseMoveAlpha() {
      samplePalette.render(document.getElementById('sandbox'));
      stubs.set(goog.dom, 'getPageScroll', function() {
        return new goog.math.Coordinate(0, 0);
      });

      // Lowering the opacity of a dark, opaque red should yield a
      // more transparent red.
      samplePalette.setColorRgbaHex('#630c0000');
      goog.style.setPageOffset(samplePalette.aImageEl_, 0, 0);
      goog.style.setSize(samplePalette.aImageEl_, 10, 100);
      var boundaries = goog.style.getBounds(samplePalette.aImageEl_);

      var event = new goog.events.Event();
      event.clientY = boundaries.top;
      samplePalette.handleMouseMoveA_(boundaries, event);

      assertEquals('#630c00ff', samplePalette.getColorRgbaHex());
    }

    function testSwatchOpacity() {
      samplePalette.render(document.getElementById('sandbox'));

      samplePalette.setAlpha(1);
      assertEquals(1, goog.style.getOpacity(samplePalette.swatchEl_));

      samplePalette.setAlpha(0x99 / 0xff);
      assertEquals(0.6, goog.style.getOpacity(samplePalette.swatchEl_));

      samplePalette.setAlpha(0);
      assertEquals(0, goog.style.getOpacity(samplePalette.swatchEl_));
    }

    function testNoTransparencyBehavior() {
      samplePalette.render(document.getElementById('sandbox'));

      samplePalette.inputEl_.value = '#abcdef22';
      samplePalette.handleInput_(null);
      samplePalette.inputEl_.value = '#abcdef';
      samplePalette.handleInput_(null);
      assertEquals(1, goog.style.getOpacity(samplePalette.swatchEl_));
    }

  ">10 of 10 tests run in 19ms.<br />3 passed, 7 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testCustomClassName<br />Object #<Object> has no method 'createElement'<br />ERROR in testHandleMouseMoveAlpha<br />Object #<Object> has no method 'createElement'<br />ERROR in testInputColor<br />Object #<Object> has no method 'createElement'<br />ERROR in testNoLeftOverListenersAfterDispose<br />Object #<Object> has no method 'createElement'<br />ERROR in testNoTransparencyBehavior<br />Object #<Object> has no method 'createElement'<br />ERROR in testRender<br />Object #<Object> has no method 'createElement'<br />ERROR in testSwatchOpacity<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>idletimer_test.html</td><td>Fail</td><td> 0 passed, 2 failed.</td><td title="

  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.MockClock');
  goog.require('goog.ui.IdleTimer');
  goog.require('goog.ui.MockActivityMonitor');



  var clock;
  
  function setUp() {
    clock = new goog.testing.MockClock(true);
    goog.now = goog.bind(clock.getCurrentTime, clock);
  }

  function tearDown() {
    clock.dispose();
  }


  /**
   * Tests whether an event is fired when the user becomes idle
   */
  function testBecomeIdle() {
    var idleThreshold = 1000;
    var mockActivityMonitor = new goog.ui.MockActivityMonitor();
    var idleTimer = new goog.ui.IdleTimer(idleThreshold, mockActivityMonitor);

    mockActivityMonitor.simulateEvent();
    assertFalse('Precondition: user should be active', idleTimer.isIdle());

    var onBecomeIdleCount = 0;
    var onBecomeIdle = function() {
      onBecomeIdleCount += 1;
    };
    goog.events.listen(idleTimer,
        goog.ui.IdleTimer.Event.BECOME_IDLE,
        onBecomeIdle);

    clock.tick(idleThreshold);
    mockActivityMonitor.simulateEvent();
    clock.tick(idleThreshold);
    assert('The BECOME_IDLE event fired too early', onBecomeIdleCount == 0);
    assertFalse('The user should still be active', idleTimer.isIdle());

    clock.tick(1);
    assert('The BECOME_IDLE event fired too late', onBecomeIdleCount == 1);
    assert('The user should be idle', idleTimer.isIdle());

    idleTimer.dispose();
  }


  /**
   * Tests whether an event is fired when the user becomes active
   */
  function testBecomeActive() {
    var idleThreshold = 1000;
    var mockActivityMonitor = new goog.ui.MockActivityMonitor();
    var idleTimer = new goog.ui.IdleTimer(idleThreshold, mockActivityMonitor);

    clock.tick(idleThreshold + 1);
    assert('Precondition: user should be idle', idleTimer.isIdle());

    var onBecomeActiveCount = 0;
    var onBecomeActive = function() {
      onBecomeActiveCount += 1;
    };
    goog.events.listen(idleTimer,
        goog.ui.IdleTimer.Event.BECOME_ACTIVE,
        onBecomeActive);

    clock.tick(idleThreshold);
    assert('The BECOME_ACTIVE event fired too early', onBecomeActiveCount == 0);
    assert('The user should still be idle', idleTimer.isIdle());

    mockActivityMonitor.simulateEvent();
    assert('The BECOME_ACTIVE event fired too late', onBecomeActiveCount == 1);
    assertFalse('The user should be active', idleTimer.isIdle());

    idleTimer.dispose();
  }

">2 of 2 tests run in 6ms.<br />0 passed, 2 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testBecomeActive<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testBecomeIdle<br />Object #<Object> has no method 'attachEvent'<br /></td></tr>
<tr><td>fast_progressive_emojipicker_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.dom');
  goog.require('goog.testing.AsyncTestCase');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.emoji.EmojiPicker');
  goog.require('goog.ui.emoji.SpriteInfo');



var sprite = '../../demos/emoji/sprite.png';
var sprite2 = '../../demos/emoji/sprite2.png';

/**
 * Creates a SpriteInfo object with the specified properties. If the image is
 * sprited via CSS, then only the first parameter needs a value. If the image
 * is sprited via metadata, then the first parameter should be left null.
 *
 * @param {?string} cssClass CSS class to properly display the sprited image.
 * @param {string=} opt_url Url of the sprite image.
 * @param {number=} opt_width Width of the image being sprited.
 * @param {number=} opt_height Height of the image being sprited.
 * @param {number=} opt_xOffset Positive x offset of the image being sprited
 *     within the sprite.
 * @param {number=} opt_yOffset Positive y offset of the image being sprited
 *     within the sprite.
 * @param {boolean=} opt_animated Whether the sprite info is for an animated
 *     emoji.
 */
function si(cssClass, opt_url, opt_width, opt_height, opt_xOffset,
            opt_yOffset, opt_animated) {
  return new goog.ui.emoji.SpriteInfo(cssClass, opt_url, opt_width,
      opt_height, opt_xOffset, opt_yOffset, opt_animated);
}

// This group contains a mix of sprited emoji via css, sprited emoji via
// metadata, and non-sprited emoji.
var spritedEmoji2 = [
    'Emoji 1',
    [
        ['../../demos/emoji/200.gif', 'std.200', si('SPRITE_200')],
        ['../../demos/emoji/201.gif', 'std.201', si('SPRITE_201')],
        ['../../demos/emoji/202.gif', 'std.202', si('SPRITE_202')],
        ['../../demos/emoji/203.gif', 'std.203', si('SPRITE_203')],
        ['../../demos/emoji/204.gif', 'std.204', si('SPRITE_204')],
        ['../../demos/emoji/205.gif', 'std.205', si('SPRITE_205')],
        ['../../demos/emoji/206.gif', 'std.206', si('SPRITE_206')],
        ['../../demos/emoji/2BC.gif', 'std.2BC', si('SPRITE_2BC')],
        ['../../demos/emoji/2BD.gif', 'std.2BD', si('SPRITE_2BD')],
        ['../../demos/emoji/2BE.gif', 'std.2BE',
            si(null, sprite, 18, 18, 36, 54)],
        ['../../demos/emoji/2BF.gif', 'std.2BF',
            si(null, sprite, 18, 18, 0, 126)],
        ['../../demos/emoji/2C0.gif', 'std.2C0',
            si(null, sprite, 18, 18, 18, 305)],
        ['../../demos/emoji/2C1.gif', 'std.2C1',
            si(null, sprite, 18, 18, 0, 287)],
        ['../../demos/emoji/2C2.gif', 'std.2C2',
            si(null, sprite, 18, 18, 18, 126)],
        ['../../demos/emoji/2C3.gif', 'std.2C3',
            si(null, sprite, 18, 18, 36, 234)],
        ['../../demos/emoji/2C4.gif', 'std.2C4',
            si(null, sprite, 18, 18, 36, 72)],
        ['../../demos/emoji/2C5.gif', 'std.2C5',
            si(null, sprite, 18, 18, 54, 54)],
        ['../../demos/emoji/2C6.gif', 'std.2C6'],
        ['../../demos/emoji/2C7.gif', 'std.2C7'],
        ['../../demos/emoji/2C8.gif', 'std.2C8'],
        ['../../demos/emoji/2C9.gif', 'std.2C9'],
        ['../../demos/emoji/2CA.gif', 'std.2CA',
            si(null, sprite2, 18, 20, 36, 72, 1)],
        ['../../demos/emoji/2E3.gif', 'std.2E3',
            si(null, sprite2, 18, 18, 0, 0, 1)],
        ['../../demos/emoji/2EF.gif', 'std.2EF',
            si(null, sprite2, 18, 20, 0, 300, 1)],
        ['../../demos/emoji/2F1.gif', 'std.2F1',
            si(null, sprite2, 18, 18, 0, 320, 1)]
        ]];


/**
 * Returns true if the two paths end with the same file.
 *
 * E.g., ('../../cool.gif', 'file:///home/usr/somewhere/cool.gif') --> true
 *
 * @param {string} path1 First url
 * @param {string} path2 Second url
 */
function checkPathsEndWithSameFile(path1, path2) {
  var pieces1 = path1.split('/');
  var file1 = pieces1[pieces1.length - 1];
  var pieces2 = path2.split('/');
  var file2 = pieces2[pieces2.length - 1];

  return file1 == file2;
}


/**
 * Checks and verifies the structure of a progressive fast-loading picker
 * after the animated emoji have loaded.
 *
 * @param {goog.ui.emoji.EmojiPalette} palette Emoji palette to check.
 * @param {Array.<Array.<string>>} emoji Emoji that should be in the palette.
 * @param {Object} images Map of id -> Image for the images loaded in this
 *     picker.
 */
function checkPostLoadStructureForFastLoadProgressivePicker(palette,
                                                            emoji,
                                                            images) {
  for (var i = 0; i < emoji[1].length; i++) {
    palette.setSelectedIndex(i);
    var emojiInfo = emoji[1][i];
    var cell = palette.getSelectedItem();
    var id = cell.getAttribute(goog.ui.emoji.Emoji.ATTRIBUTE);
    var inner = cell.firstChild;

    // Check that the cell is a div wrapped around something else, and that the
    // outer div contains the goomoji attribute
    assertEquals('The palette item should be a div wrapped around something',
        cell.tagName, "DIV");
    assertNotNull('The outer div is not wrapped around another element', inner);
    assertEquals('The palette item should have the goomoji attribute',
        cell.getAttribute(goog.ui.emoji.Emoji.ATTRIBUTE), emojiInfo[1]);

    // Now check the contents of the cells
    var url = emojiInfo[0];  // url of the animated emoji
    var spriteInfo = emojiInfo[2];
    if (spriteInfo) {
      if (spriteInfo.isAnimated()) {
        var testImg = images[id];
        var img = inner.firstChild;
        checkPathsEndWithSameFile(img.src, url);
        assertEquals(testImg.width, img.width);
        assertEquals(testImg.height, img.height);
        assertEquals('0', goog.style.getStyle(img, 'left').replace(/px/g, '').
            replace(/pt/g, ''));
        assertEquals('0', goog.style.getStyle(img, 'top').replace(/px/g, '').
            replace(/pt/g, ''));
      } else {
        var cssClass = spriteInfo.getCssClass();
        if (cssClass) {
          assertEquals("DIV", inner.tagName);
          assertTrue('Sprite should have its CSS class set',
              goog.dom.classes.has(inner, cssClass));
        } else {
          // There's an inner div wrapping an img tag
          assertEquals("DIV", inner.tagName);
          var img = inner.firstChild;
          assertNotNull('Div should be wrapping something', img);
          assertEquals("IMG", img.tagName);
          checkPathsEndWithSameFile(img.src, spriteInfo.getUrl());
          assertEquals(spriteInfo.getWidthCssValue(),
              goog.style.getStyle(inner, 'width'));
          assertEquals(spriteInfo.getHeightCssValue(),
              goog.style.getStyle(inner, 'height'));
          assertEquals(spriteInfo.getXOffsetCssValue().replace(/px/, '').
              replace(/pt/, ''),
              goog.style.getStyle(img, 'left').replace(/px/, '').
                  replace(/pt/, ''));
          assertEquals(spriteInfo.getYOffsetCssValue().replace(/px/, '').
              replace(/pt/, ''),
              goog.style.getStyle(img, 'top').replace(/px/, '').
                  replace(/pt/, ''));
        }
      }
    } else {
      // A non-sprited emoji is just an img
      assertEquals(inner.tagName, "IMG");
      checkPathsEndWithSameFile(inner.src, emojiInfo[0]);
    }
  }
}

var testCase = new goog.testing.AsyncTestCase(document.title);
testCase.stepTimeout = 4 * 1000;

testCase.setUpPage = function() {
  testCase.waitForAsync('setUpPage');
  var defaultImg = '../../demos/emoji/none.gif';
  this.picker = new goog.ui.emoji.EmojiPicker(defaultImg);
  this.picker.setDelayedLoad(false);
  this.picker.setManualLoadOfAnimatedEmoji(true);
  this.picker.setProgressiveRender(true);
  this.picker.addEmojiGroup(spritedEmoji2[0], spritedEmoji2[1]);
  this.picker.render();

  this.palette = this.picker.getPage(0);
  var imageLoader = this.palette.getImageLoader();
  this.images = {};

  goog.events.listen(imageLoader, goog.net.EventType.COMPLETE,
      this.onImageLoaderComplete, false, this);
  goog.events.listen(imageLoader, goog.events.EventType.LOAD,
      this.onImageLoaded, false, this);

  // Now we load the animated emoji and check the structure again. The animated
  // emoji will be different.
  this.picker.manuallyLoadAnimatedEmoji();

  this.add(new goog.testing.TestCase.Test('test', this.testStructure, this));
};

testCase.onImageLoaded = function(e) {
  var image = e.target;
  this.log('Image loaded: ' + image.src);
  this.images[image.id] = image;
};

testCase.onImageLoaderComplete = function(e) {
  this.log('Image loading complete');
  this.continueTesting();
};

testCase.tearDownPage = function() {
  this.picker.dispose();
};

testCase.testStructure = function() {
  // Bug 2280968
    this.log('Not testing emojipicker structure');
    return;

  this.log('Testing emojipicker structure');
  checkPostLoadStructureForFastLoadProgressivePicker(this.palette,
      spritedEmoji2, this.images);
};

function setUpPage() {
  testCase.runTests();
}

// Standalone Closure Test Runner.
if (typeof G_testRunner != 'undefined') {
  G_testRunner.initialize(testCase);
}


">TypeError: Cannot set property 'name_' of undefined
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:426:44)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
    at Module.load (module.js:219:31)
    at Function._load (module.js:186:10)
    at require (module.js:231:19)
</td></tr>
<tr><td>popupemojipicker_test.html</td><td>Fail</td><td> 0 passed, 3 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.emoji.PopupEmojiPicker');



var emojiGroup1 = [
    'Emoji 1',
    [
        ['../../demos/emoji/200.gif', 'std.200'],
        ['../../demos/emoji/201.gif', 'std.201']
    ]];

var emojiGroup2 = [
    'Emoji 2',
    [
        ['../../demos/emoji/2D0.gif', 'std.2D0'],
        ['../../demos/emoji/2D1.gif', 'std.2D1']
    ]];

var emojiGroup3 = [
    'Emoji 3',
    [
        ['../../demos/emoji/2E4.gif', 'std.2E4'],
        ['../../demos/emoji/2E5.gif', 'std.2E5']
    ]];

function testConstructAndRenderPopupEmojiPicker() {
  var picker = new goog.ui.emoji.PopupEmojiPicker(
        '../../demos/emoji/none.gif');
  picker.addEmojiGroup(emojiGroup1[0], emojiGroup1[1]);
  picker.addEmojiGroup(emojiGroup2[0], emojiGroup2[1]);
  picker.addEmojiGroup(emojiGroup3[0], emojiGroup3[1]);
  picker.render();
  picker.attach(document.getElementById('button1'));
  picker.dispose();
}

// Unittest to ensure that the popup gets created in createDom().
function testPopupCreation() {
  var picker = new goog.ui.emoji.PopupEmojiPicker();
  picker.addEmojiGroup(emojiGroup1[0], emojiGroup1[1]);
  picker.createDom();
  assertNotNull(picker.getPopup());
}


function testAutoHideIsSetProperly() {
  var picker = new goog.ui.emoji.PopupEmojiPicker();
  picker.addEmojiGroup(emojiGroup1[0], emojiGroup1[1]);
  picker.createDom();
  picker.setAutoHide(true);
  var containingDiv = goog.dom.getElement('containingDiv');
  picker.setAutoHideRegion(containingDiv);
  assertTrue(picker.getAutoHide());
  assertEquals(containingDiv, picker.getAutoHideRegion());
}

">3 of 3 tests run in 12ms.<br />0 passed, 3 failed.<br />4 ms/test. 1 files loaded.<br />ERROR in testAutoHideIsSetProperly<br />Object #<Object> has no method 'createElement'<br />ERROR in testConstructAndRenderPopupEmojiPicker<br />Object #<Object> has no method 'createElement'<br />ERROR in testPopupCreation<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>emojipicker_test.html</td><td>Fail</td><td> 2 passed, 13 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.emoji.EmojiPicker');
  goog.require('goog.ui.emoji.SpriteInfo');




// 26 emoji
var emojiGroup1 = [
    'Emoji 1',
    [
        ['../../demos/emoji/200.gif', 'std.200'],
        ['../../demos/emoji/201.gif', 'std.201'],
        ['../../demos/emoji/202.gif', 'std.202'],
        ['../../demos/emoji/203.gif', 'std.203'],
        ['../../demos/emoji/204.gif', 'std.204'],
        ['../../demos/emoji/200.gif', 'std.200'],
        ['../../demos/emoji/201.gif', 'std.201'],
        ['../../demos/emoji/202.gif', 'std.202'],
        ['../../demos/emoji/203.gif', 'std.203'],
        ['../../demos/emoji/204.gif', 'std.204'],
        ['../../demos/emoji/200.gif', 'std.200'],
        ['../../demos/emoji/201.gif', 'std.201'],
        ['../../demos/emoji/202.gif', 'std.202'],
        ['../../demos/emoji/203.gif', 'std.203'],
        ['../../demos/emoji/204.gif', 'std.204'],
        ['../../demos/emoji/200.gif', 'std.200'],
        ['../../demos/emoji/201.gif', 'std.201'],
        ['../../demos/emoji/202.gif', 'std.202'],
        ['../../demos/emoji/203.gif', 'std.203'],
        ['../../demos/emoji/204.gif', 'std.204'],
        ['../../demos/emoji/200.gif', 'std.200'],
        ['../../demos/emoji/201.gif', 'std.201'],
        ['../../demos/emoji/202.gif', 'std.202'],
        ['../../demos/emoji/203.gif', 'std.203'],
        ['../../demos/emoji/204.gif', 'std.204'],
        ['../../demos/emoji/200.gif', 'std.200']
        ]];

// 20 emoji
var emojiGroup2 = [
    'Emoji 2',
    [
      ['../../demos/emoji/200.gif', 'std.200'],
      ['../../demos/emoji/201.gif', 'std.201'],
      ['../../demos/emoji/202.gif', 'std.202'],
      ['../../demos/emoji/203.gif', 'std.203'],
      ['../../demos/emoji/204.gif', 'std.204'],
      ['../../demos/emoji/200.gif', 'std.200'],
      ['../../demos/emoji/201.gif', 'std.201'],
      ['../../demos/emoji/202.gif', 'std.202'],
      ['../../demos/emoji/203.gif', 'std.203'],
      ['../../demos/emoji/204.gif', 'std.204'],
      ['../../demos/emoji/200.gif', 'std.200'],
      ['../../demos/emoji/201.gif', 'std.201'],
      ['../../demos/emoji/202.gif', 'std.202'],
      ['../../demos/emoji/203.gif', 'std.203'],
      ['../../demos/emoji/204.gif', 'std.204'],
      ['../../demos/emoji/200.gif', 'std.200'],
      ['../../demos/emoji/201.gif', 'std.201'],
      ['../../demos/emoji/202.gif', 'std.202'],
      ['../../demos/emoji/203.gif', 'std.203'],
      ['../../demos/emoji/204.gif', 'std.204']
        ]];

// 20 emoji
var emojiGroup3 = [
    'Emoji 3',
    [
      ['../../demos/emoji/200.gif', 'std.200'],
      ['../../demos/emoji/201.gif', 'std.201'],
      ['../../demos/emoji/202.gif', 'std.202'],
      ['../../demos/emoji/203.gif', 'std.203'],
      ['../../demos/emoji/204.gif', 'std.204'],
      ['../../demos/emoji/200.gif', 'std.200'],
      ['../../demos/emoji/201.gif', 'std.201'],
      ['../../demos/emoji/202.gif', 'std.202'],
      ['../../demos/emoji/203.gif', 'std.203'],
      ['../../demos/emoji/204.gif', 'std.204'],
      ['../../demos/emoji/200.gif', 'std.200'],
      ['../../demos/emoji/201.gif', 'std.201'],
      ['../../demos/emoji/202.gif', 'std.202'],
      ['../../demos/emoji/203.gif', 'std.203'],
      ['../../demos/emoji/204.gif', 'std.204'],
      ['../../demos/emoji/200.gif', 'std.200'],
      ['../../demos/emoji/201.gif', 'std.201'],
      ['../../demos/emoji/202.gif', 'std.202'],
      ['../../demos/emoji/203.gif', 'std.203'],
      ['../../demos/emoji/204.gif', 'std.204']
        ]];

  var sprite = '../../demos/emoji/sprite.png';
  var sprite2 = '../../demos/emoji/sprite2.png';

/**
 * Creates a SpriteInfo object with the specified properties. If the image is
 * sprited via CSS, then only the first parameter needs a value. If the image
 * is sprited via metadata, then the first parameter should be left null.
 *
 * @param {?string} cssClass CSS class to properly display the sprited image.
 * @param {string=} opt_url Url of the sprite image.
 * @param {number=} opt_width Width of the image being sprited.
 * @param {number=} opt_height Height of the image being sprited.
 * @param {number=} opt_xOffset Positive x offset of the image being sprited
 *     within the sprite.
 * @param {number=} opt_yOffset Positive y offset of the image being sprited
 *     within the sprite.
 * @param {boolean=} opt_animated Whether the sprite info is for an animated
 *     emoji.
 */
function si(cssClass, opt_url, opt_width, opt_height, opt_xOffset,
            opt_yOffset, opt_animated) {
  return new goog.ui.emoji.SpriteInfo(cssClass, opt_url, opt_width,
      opt_height, opt_xOffset, opt_yOffset, opt_animated);
}

// Contains a mix of sprited emoji via css, sprited emoji via metadata, and
// non-sprited emoji
var spritedEmoji1 = [
    'Emoji 1',
    [
        ['../../demos/emoji/200.gif', 'std.200', si('SPRITE_200')],
        ['../../demos/emoji/201.gif', 'std.201', si('SPRITE_201')],
        ['../../demos/emoji/202.gif', 'std.202', si('SPRITE_202')],
        ['../../demos/emoji/203.gif', 'std.203', si('SPRITE_203')],
        ['../../demos/emoji/204.gif', 'std.204', si('SPRITE_204')],
        ['../../demos/emoji/200.gif', 'std.200', si('SPRITE_200')],
        ['../../demos/emoji/201.gif', 'std.201', si('SPRITE_201')],
        ['../../demos/emoji/202.gif', 'std.202', si('SPRITE_202')],
        ['../../demos/emoji/203.gif', 'std.203', si('SPRITE_203')],
        ['../../demos/emoji/2BE.gif', 'std.2BE',
            si(null, sprite, 18, 18, 36, 54)],
        ['../../demos/emoji/2BF.gif', 'std.2BF',
            si(null, sprite, 18, 18, 0, 126)],
        ['../../demos/emoji/2C0.gif', 'std.2C0',
            si(null, sprite, 18, 18, 18, 305)],
        ['../../demos/emoji/2C1.gif', 'std.2C1',
            si(null, sprite, 18, 18, 0, 287)],
        ['../../demos/emoji/2C2.gif', 'std.2C2',
            si(null, sprite, 18, 18, 18, 126)],
        ['../../demos/emoji/2C3.gif', 'std.2C3',
            si(null, sprite, 18, 18, 36, 234)],
        ['../../demos/emoji/2C4.gif', 'std.2C4',
            si(null, sprite, 18, 18, 36, 72)],
        ['../../demos/emoji/2C5.gif', 'std.2C5',
            si(null, sprite, 18, 18, 54, 54)],
        ['../../demos/emoji/200.gif', 'std.200'],
        ['../../demos/emoji/201.gif', 'std.201'],
        ['../../demos/emoji/202.gif', 'std.202'],
        ['../../demos/emoji/203.gif', 'std.203'],
        ['../../demos/emoji/204.gif', 'std.204'],
        ['../../demos/emoji/200.gif', 'std.200'],
        ['../../demos/emoji/201.gif', 'std.201'],
        ['../../demos/emoji/202.gif', 'std.202'],
        ['../../demos/emoji/203.gif', 'std.203']
        ]];

// This group contains a mix of sprited emoji via css, sprited emoji via
// metadata, and non-sprited emoji.
var spritedEmoji2 = [
    'Emoji 1',
    [
        ['../../demos/emoji/200.gif', 'std.200', si('SPRITE_200')],
        ['../../demos/emoji/201.gif', 'std.201', si('SPRITE_201')],
        ['../../demos/emoji/202.gif', 'std.202', si('SPRITE_202')],
        ['../../demos/emoji/203.gif', 'std.203', si('SPRITE_203')],
        ['../../demos/emoji/204.gif', 'std.204', si('SPRITE_204')],
        ['../../demos/emoji/200.gif', 'std.200', si('SPRITE_200')],
        ['../../demos/emoji/201.gif', 'std.201', si('SPRITE_201')],
        ['../../demos/emoji/202.gif', 'std.202', si('SPRITE_202')],
        ['../../demos/emoji/203.gif', 'std.203', si('SPRITE_203')],
        ['../../demos/emoji/2BE.gif', 'std.2BE',
            si(null, sprite, 18, 18, 36, 54)],
        ['../../demos/emoji/2BF.gif', 'std.2BF',
            si(null, sprite, 18, 18, 0, 126)],
        ['../../demos/emoji/2C0.gif', 'std.2C0',
            si(null, sprite, 18, 18, 18, 305)],
        ['../../demos/emoji/2C1.gif', 'std.2C1',
            si(null, sprite, 18, 18, 0, 287)],
        ['../../demos/emoji/2C2.gif', 'std.2C2',
            si(null, sprite, 18, 18, 18, 126)],
        ['../../demos/emoji/2C3.gif', 'std.2C3',
            si(null, sprite, 18, 18, 36, 234)],
        ['../../demos/emoji/2C4.gif', 'std.2C4',
            si(null, sprite, 18, 18, 36, 72)],
        ['../../demos/emoji/2C5.gif', 'std.2C5',
            si(null, sprite, 18, 18, 54, 54)],
        ['../../demos/emoji/2C6.gif', 'std.2C6'],
        ['../../demos/emoji/2C7.gif', 'std.2C7'],
        ['../../demos/emoji/2C8.gif', 'std.2C8'],
        ['../../demos/emoji/2C9.gif', 'std.2C9'],
        ['../../demos/emoji/2CA.gif', 'std.2CA',
            si(null, sprite2, 18, 20, 36, 72, 1)],
        ['../../demos/emoji/2E3.gif', 'std.2E3',
            si(null, sprite2, 18, 18, 0, 0, 1)],
        ['../../demos/emoji/2EF.gif', 'std.2EF',
            si(null, sprite2, 18, 20, 0, 300, 1)],
        ['../../demos/emoji/2F1.gif', 'std.2F1',
            si(null, sprite2, 18, 18, 0, 320, 1)]
        ]];

var emojiGroups = [emojiGroup1, emojiGroup2, emojiGroup3];

function testConstructAndRenderOnePageEmojiPicker() {
  var picker = new goog.ui.emoji.EmojiPicker('../../demos/emoji/none.gif');
  picker.addEmojiGroup(emojiGroup1[0], emojiGroup1[1]);
  picker.render();
  picker.dispose();
}

function testConstructAndRenderMultiPageEmojiPicker() {
  var picker = new goog.ui.emoji.EmojiPicker('../../demos/emoji/none.gif');
  picker.addEmojiGroup(emojiGroup1[0], emojiGroup1[1]);
  picker.addEmojiGroup(emojiGroup2[0], emojiGroup2[1]);
  picker.addEmojiGroup(emojiGroup3[0], emojiGroup3[1]);
  picker.render();
  picker.dispose();
}

function testExitDocumentCleansUpProperlyForSinglePageEmojiPicker() {
  var picker = new goog.ui.emoji.EmojiPicker('../../demos/emoji/none.gif');
  picker.addEmojiGroup(emojiGroup1[0], emojiGroup1[1]);
  picker.render();
  picker.enterDocument();
  picker.exitDocument();
  picker.dispose();
}

function testExitDocumentCleansUpProperlyForMultiPageEmojiPicker() {
  var picker = new goog.ui.emoji.EmojiPicker('../../demos/emoji/none.gif');
  picker.addEmojiGroup(emojiGroup1[0], emojiGroup1[1]);
  picker.addEmojiGroup(emojiGroup2[0], emojiGroup2[1]);
  picker.render();
  picker.enterDocument();
  picker.exitDocument();
  picker.dispose();
}

function testNumGroups() {
  var picker = new goog.ui.emoji.EmojiPicker('../../demos/emoji/none.gif');

  for (var i = 0; i < emojiGroups.length; i++) {
    picker.addEmojiGroup(emojiGroups[i][0], emojiGroups[i][1]);
  }

  assertTrue(picker.getNumEmojiGroups() == emojiGroups.length);
}

function testAdjustNumRowsIfNecessaryIsCorrect() {
  var picker = new goog.ui.emoji.EmojiPicker('../../demos/emoji/none.gif');
  picker.addEmojiGroup(emojiGroup1[0], emojiGroup1[1]);
  picker.setAutoSizeByColumnCount(true);
  picker.setNumColumns(5);
  assertEquals(5, picker.getNumColumns());
  assertEquals(goog.ui.emoji.EmojiPicker.DEFAULT_NUM_ROWS, picker.getNumRows());

  picker.adjustNumRowsIfNecessary_();

  // The emojiGroup has 26 emoji. ceil(26/5) should give 6 rows.
  assertEquals(6, picker.getNumRows());

  // Change col count to 10, should give 3 rows.
  picker.setNumColumns(10);
  picker.adjustNumRowsIfNecessary_();
  assertEquals(3, picker.getNumRows());

  // Add another gruop, with 20 emoji. Deliberately set the number of rows too
  // low. It should adjust it to three to accommodate the emoji in the first
  // group.
  picker.addEmojiGroup(emojiGroup2[0], emojiGroup2[1]);
  picker.setNumColumns(10);
  picker.setNumRows(2);
  picker.adjustNumRowsIfNecessary_();
  assertEquals(3, picker.getNumRows());
};

/**
 * Helper for testDelayedLoad. Returns true if the two paths end with the same
 * file.
 *
 * E.g., ('../../cool.gif', 'file:///home/usr/somewhere/cool.gif') --> true
 *
 * @param {string} path1 First url
 * @param {string} path2 Second url
 */
function checkPathsEndWithSameFile(path1, path2) {
  var pieces1 = path1.split('/');
  var file1 = pieces1[pieces1.length - 1];
  var pieces2 = path2.split('/');
  var file2 = pieces2[pieces2.length - 1];

  return file1 == file2;
}

/**
 * Gets the emoji URL from a palette element. Palette elements are divs or
 * imgs wrapped in an outer div. The returns the background-image if it's a div,
 * or the src attribute if it's an image.
 *
 * @param {Element} element Element to get the image url for
 * @return string
 */
function getImageUrl(element) {
  element = element.firstChild;  // get the wrapped element
  if (element.tagName == 'IMG') {
    return element.src;
  } else {
    var url = goog.style.getStyle(element, 'background-image');
    url = url.replace(/url\(/, '');
    url = url.replace(/\)/, '');
    return url;
  }
}

/**
 * Checks that the content of an emojipicker page is all images pointing to
 * the default img.
 *
 * @param {goog.ui.emoji.EmojiPalette} page The page of the picker to check
 * @param {string} defaultImgUrl The url of the default img
 */
function checkContentIsDefaultImg(page, defaultImgUrl) {
  var content = page.getContent();

  for (var i = 0; i < content.length; i++) {
    var url = getImageUrl(content[i]);
    assertTrue('img src should be ' + defaultImgUrl + ' but is ' +
               url,
               checkPathsEndWithSameFile(url, defaultImgUrl));
  }
}


/**
 * Checks that the content of an emojipicker page is the specified emoji and
 * the default img after the emoji are all used.
 *
 * @param {goog.ui.emoji.EmojiPalette} page The page of the picker to check
 * @param {Array.<Array.<string>>} emojiList List of emoji that should be in the
 *     palette
 * @param {string} defaultImgUrl The url of the default img
 */
function checkContentIsEmojiImages(page, emojiList, defaultImg) {
  var content = page.getContent();

  for (var i = 0; i < content.length; i++) {
    var url = getImageUrl(content[i]);
    if (i < emojiList.length) {
      assertTrue('Paths should end with the same file: ' +
                 url + ', ' + emojiList[i][0],
                 checkPathsEndWithSameFile(url, emojiList[i][0]));
    } else {
      assertTrue('Paths should end with the same file: ' +
                 url + ', ' + defaultImg,
                 checkPathsEndWithSameFile(url, defaultImg));
    }
  }
}


function testNonDelayedLoadPaletteCreationForSinglePagePicker() {
  var defaultImg = '../../demos/emoji/none.gif';
  var picker = new goog.ui.emoji.EmojiPicker(defaultImg);
  picker.setDelayedLoad(false);
  picker.addEmojiGroup(emojiGroup1[0], emojiGroup1[1]);
  picker.render();

  var page = picker.getPage(0);
  assertTrue('Page should be in the document but is not', page.isInDocument());

  // The content should be the actual emoji images now, with the remainder set
  // to the default img
  checkContentIsEmojiImages(page, emojiGroup1[1], defaultImg);

  picker.dispose();
}


function testNonDelayedLoadPaletteCreationForMultiPagePicker() {
  var defaultImg = '../../demos/emoji/none.gif';
  var picker = new goog.ui.emoji.EmojiPicker(defaultImg);
  picker.setDelayedLoad(false);

  for (var i = 0; i < emojiGroups.length; i++) {
    picker.addEmojiGroup(emojiGroups[i][0], emojiGroups[i][1]);
  }

  picker.render();

  for (var i = 0; i < emojiGroups.length; i++) {
    var page = picker.getPage(i);
    assertTrue('Page ' + i + ' should be in the document but is not',
               page.isInDocument());
    checkContentIsEmojiImages(page, emojiGroups[i][1], defaultImg);
  }

  picker.dispose();
}


function testDelayedLoadPaletteCreationForSinglePagePicker() {
  var defaultImg = '../../demos/emoji/none.gif';
  var picker = new goog.ui.emoji.EmojiPicker(defaultImg);
  picker.setDelayedLoad(true);
  picker.addEmojiGroup(emojiGroup1[0], emojiGroup1[1]);
  picker.render();

  // At this point the picker should have pages filled with the default img
  checkContentIsDefaultImg(picker.getPage(0), defaultImg);

  // Now load the images
  picker.loadImages();

  var page = picker.getPage(0);
  assertTrue('Page should be in the document but is not', page.isInDocument());

  // The content should be the actual emoji images now, with the remainder set
  // to the default img
  checkContentIsEmojiImages(page, emojiGroup1[1], defaultImg);

  picker.dispose();
}


function testGetSelectedEmoji() {
  var defaultImg = '../../demos/emoji/none.gif';
  var picker = new goog.ui.emoji.EmojiPicker(defaultImg);
  picker.setDelayedLoad(false);
  picker.addEmojiGroup(emojiGroup1[0], emojiGroup1[1]);
  picker.render();

  var palette = picker.getPage(0);

  // No emoji should be selected yet
  assertUndefined(palette.getSelectedEmoji());

  // Artificially select the first emoji
  palette.setSelectedIndex(0);

  // Now we should get the first emoji back. See emojiGroup1 above.
  var emoji = palette.getSelectedEmoji();
  assertEquals(emoji.getId(), 'std.200');
  assertEquals(emoji.getUrl(), '../../demos/emoji/200.gif');

  picker.dispose();
}


/**
 * Checks and verifies the structure of a non-progressively-rendered
 * emojipicker.
 *
 * @param {goog.ui.emoji.EmojiPalette} palette Emoji palette to check.
 * @param {Array.<Array.<string>>} emoji Emoji that should be in the palette.
 */
function checkStructureForNonProgressivePicker(palette, emoji) {
  // We can hackily check the items by selecting an item and then getting the
  // selected item.
  for (var i = 0; i < emoji[1].length; i++) {
    palette.setSelectedIndex(i);
    var emojiInfo = emoji[1][i];
    var cell = palette.getSelectedItem();
    var inner = cell.firstChild;

    // Check that the cell is a div wrapped around something else, and that the
    // outer div contains the goomoji attribute
    assertEquals('The palette item should be a div wrapped around something',
        cell.tagName, "DIV");
    assertNotNull('The outer div is not wrapped around another element', inner);
    assertEquals('The palette item should have the goomoji attribute',
        cell.getAttribute(goog.ui.emoji.Emoji.ATTRIBUTE), emojiInfo[1]);

    // Now check the contents of the cells
    var spriteInfo = emojiInfo[2];
    if (spriteInfo) {
      assertEquals(inner.tagName, "DIV");
      var cssClass = spriteInfo.getCssClass();
      if (cssClass) {
        assertTrue('Sprite should have its CSS class set',
            goog.dom.classes.has(inner, cssClass));
      } else {
        checkPathsEndWithSameFile(
            goog.style.getStyle(inner, 'background-image'),
            spriteInfo.getUrl());
        assertEquals(spriteInfo.getWidthCssValue(),
            goog.style.getStyle(inner, 'width'));
        assertEquals(spriteInfo.getHeightCssValue(),
            goog.style.getStyle(inner, 'height'));
        assertEquals((spriteInfo.getXOffsetCssValue() + ' ' +
                      spriteInfo.getYOffsetCssValue()).replace(/px/g, '').
            replace(/pt/g, ''),
            goog.style.getStyle(inner,
                'background-position').replace(/px/g, '').
                replace(/pt/g, ''));
      }
    } else {
      // A non-sprited emoji is just an img
      assertEquals(inner.tagName, "IMG");
      checkPathsEndWithSameFile(inner.src, emojiInfo[0]);
    }
  }
}


/**
 * Checks and verifies the structure of a progressively-rendered emojipicker.
 *
 * @param {goog.ui.emoji.EmojiPalette} palette Emoji palette to check.
 * @param {Array.<Array.<string>>} emoji Emoji that should be in the palette.
 */
function checkStructureForProgressivePicker(palette, emoji) {
  // We can hackily check the items by selecting an item and then getting the
  // selected item.
  for (var i = 0; i < emoji[1].length; i++) {
    palette.setSelectedIndex(i);
    var emojiInfo = emoji[1][i];
    var cell = palette.getSelectedItem();
    var inner = cell.firstChild;

    // Check that the cell is a div wrapped around something else, and that the
    // outer div contains the goomoji attribute
    assertEquals('The palette item should be a div wrapped around something',
        cell.tagName, "DIV");
    assertNotNull('The outer div is not wrapped around another element', inner);
    assertEquals('The palette item should have the goomoji attribute',
        cell.getAttribute(goog.ui.emoji.Emoji.ATTRIBUTE), emojiInfo[1]);

    // Now check the contents of the cells
    var spriteInfo = emojiInfo[2];
    if (spriteInfo) {
      var cssClass = spriteInfo.getCssClass();
      if (cssClass) {
        assertEquals("DIV", inner.tagName);
        assertTrue('Sprite should have its CSS class set',
            goog.dom.classes.has(inner, cssClass));
      } else {
        // There's an inner div wrapping an img tag
        assertEquals("DIV", inner.tagName);
        var img = inner.firstChild;
        assertNotNull('Div should be wrapping something', img);
        assertEquals("IMG", img.tagName);
        checkPathsEndWithSameFile(img.src, spriteInfo.getUrl());
        assertEquals(spriteInfo.getWidthCssValue(),
                     goog.style.getStyle(inner, 'width'));
        assertEquals(spriteInfo.getHeightCssValue(),
                     goog.style.getStyle(inner, 'height'));
        assertEquals(spriteInfo.getXOffsetCssValue().replace(/px/, '').
            replace(/pt/, ''),
            goog.style.getStyle(img, 'left').replace(/px/, '').
                replace(/pt/, ''));
        assertEquals(spriteInfo.getYOffsetCssValue().replace(/px/, '').
            replace(/pt/, ''),
            goog.style.getStyle(img, 'top').replace(/px/, '').
                replace(/pt/, ''));
      }
    } else {
      // A non-sprited emoji is just an img
      assertEquals(inner.tagName, "IMG");
      checkPathsEndWithSameFile(inner.src, emojiInfo[0]);
    }
  }
}


/**
 * Checks and verifies the structure of a non-progressive fast-loading picker
 * after the animated emoji have loaded.
 *
 * @param {goog.ui.emoji.EmojiPalette} palette Emoji palette to check.
 * @param {Array.<Array.<string>>} emoji Emoji that should be in the palette.
 */
function checkPostLoadStructureForFastLoadNonProgressivePicker(palette, emoji) {
 for (var i = 0; i < emoji[1].length; i++) {
    palette.setSelectedIndex(i);
    var emojiInfo = emoji[1][i];
    var cell = palette.getSelectedItem();
    var inner = cell.firstChild;

    // Check that the cell is a div wrapped around something else, and that the
    // outer div contains the goomoji attribute
    assertEquals('The palette item should be a div wrapped around something',
        cell.tagName, "DIV");
    assertNotNull('The outer div is not wrapped around another element', inner);
    assertEquals('The palette item should have the goomoji attribute',
        cell.getAttribute(goog.ui.emoji.Emoji.ATTRIBUTE), emojiInfo[1]);

    // Now check the contents of the cells
    var url = emojiInfo[0];   // url of the animated emoji
    var spriteInfo = emojiInfo[2];
    if (spriteInfo) {
      assertEquals(inner.tagName, "DIV");
      if (spriteInfo.isAnimated()) {
        var img = new Image();
        img.src = url;
        checkPathsEndWithSameFile(
            goog.style.getStyle(inner, 'background-image'),
            url);
        assertEquals(String(img.width), goog.style.getStyle(inner, 'width').
            replace(/px/g, '').replace(/pt/g, ''));
        assertEquals(String(img.height), goog.style.getStyle(inner, 'height').
            replace(/px/g, '').replace(/pt/g,''));
        assertEquals('0 0', goog.style.getStyle(inner,
            'background-position').replace(/px/g, '').
            replace(/pt/g, ''));
      } else {
        var cssClass = spriteInfo.getCssClass();
        if (cssClass) {
          assertTrue('Sprite should have its CSS class set',
              goog.dom.classes.has(inner, cssClass));
        } else {
          checkPathsEndWithSameFile(
              goog.style.getStyle(inner, 'background-image'),
              spriteInfo.getUrl());
          assertEquals(spriteInfo.getWidthCssValue(),
              goog.style.getStyle(inner, 'width'));
          assertEquals(spriteInfo.getHeightCssValue(),
              goog.style.getStyle(inner, 'height'));
          assertEquals((spriteInfo.getXOffsetCssValue() + ' ' +
                        spriteInfo.getYOffsetCssValue()).replace(/px/g, '').
              replace(/pt/g, ''),
              goog.style.getStyle(inner,
                  'background-position').replace(/px/g, '').
                  replace(/pt/g, ''));
        }
      }
    } else {
      // A non-sprited emoji is just an img
      assertEquals(inner.tagName, "IMG");
      checkPathsEndWithSameFile(inner.src, emojiInfo[0]);
    }
  }
}


/**
 * Checks and verifies the structure of a progressive fast-loading picker
 * after the animated emoji have loaded.
 *
 * @param {goog.ui.emoji.EmojiPalette} palette Emoji palette to check.
 * @param {Array.<Array.<string>>} emoji Emoji that should be in the palette.
 */
function checkPostLoadStructureForFastLoadProgressivePicker(palette, emoji) {
  for (var i = 0; i < emoji[1].length; i++) {
    palette.setSelectedIndex(i);
    var emojiInfo = emoji[1][i];
    var cell = palette.getSelectedItem();
    var inner = cell.firstChild;

    // Check that the cell is a div wrapped around something else, and that the
    // outer div contains the goomoji attribute
    assertEquals('The palette item should be a div wrapped around something',
        cell.tagName, "DIV");
    assertNotNull('The outer div is not wrapped around another element', inner);
    assertEquals('The palette item should have the goomoji attribute',
        cell.getAttribute(goog.ui.emoji.Emoji.ATTRIBUTE), emojiInfo[1]);

    // Now check the contents of the cells
    var url = emojiInfo[0];  // url of the animated emoji
    var spriteInfo = emojiInfo[2];
    if (spriteInfo) {
      if (spriteInfo.isAnimated()) {
        var testImg = new Image();
        testImg.src = url;
        var img = inner.firstChild;
        checkPathsEndWithSameFile(img.src, url);
        assertEquals(testImg.width, img.width);
        assertEquals(testImg.height, img.height);
        assertEquals('0', goog.style.getStyle(img, 'left').replace(/px/g, '').
            replace(/pt/g, ''));
        assertEquals('0', goog.style.getStyle(img, 'top').replace(/px/g, '').
            replace(/pt/g, ''));
      } else {
        var cssClass = spriteInfo.getCssClass();
        if (cssClass) {
          assertEquals("DIV", inner.tagName);
          assertTrue('Sprite should have its CSS class set',
              goog.dom.classes.has(inner, cssClass));
        } else {
          // There's an inner div wrapping an img tag
          assertEquals("DIV", inner.tagName);
          var img = inner.firstChild;
          assertNotNull('Div should be wrapping something', img);
          assertEquals("IMG", img.tagName);
          checkPathsEndWithSameFile(img.src, spriteInfo.getUrl());
          assertEquals(spriteInfo.getWidthCssValue(),
              goog.style.getStyle(inner, 'width'));
          assertEquals(spriteInfo.getHeightCssValue(),
              goog.style.getStyle(inner, 'height'));
          assertEquals(spriteInfo.getXOffsetCssValue().replace(/px/, '').
              replace(/pt/, ''),
              goog.style.getStyle(img, 'left').replace(/px/, '').
                  replace(/pt/, ''));
          assertEquals(spriteInfo.getYOffsetCssValue().replace(/px/, '').
              replace(/pt/, ''),
              goog.style.getStyle(img, 'top').replace(/px/, '').
                  replace(/pt/, ''));
        }
      }
    } else {
      // A non-sprited emoji is just an img
      assertEquals(inner.tagName, "IMG");
      checkPathsEndWithSameFile(inner.src, emojiInfo[0]);
    }
  }
}


function testPreLoadCellConstructionForFastLoadingNonProgressive() {
  var defaultImg = '../../demos/emoji/none.gif';
  var picker = new goog.ui.emoji.EmojiPicker(defaultImg);
  picker.setDelayedLoad(false);
  picker.setManualLoadOfAnimatedEmoji(true);
  picker.setProgressiveRender(false);
  picker.addEmojiGroup(spritedEmoji2[0], spritedEmoji2[1]);
  picker.render();

  var palette = picker.getPage(0);

  checkStructureForNonProgressivePicker(palette, spritedEmoji2);

  picker.dispose();
}


function testPreLoadCellConstructionForFastLoadingProgressive() {
  var defaultImg = '../../demos/emoji/none.gif';
  var picker = new goog.ui.emoji.EmojiPicker(defaultImg);
  picker.setDelayedLoad(false);
  picker.setManualLoadOfAnimatedEmoji(true);
  picker.setProgressiveRender(true);
  picker.addEmojiGroup(spritedEmoji2[0], spritedEmoji2[1]);
  picker.render();

  var palette = picker.getPage(0);

  checkStructureForProgressivePicker(palette, spritedEmoji2);

  picker.dispose();
}


function testCellConstructionForNonProgressiveRenderingSpriting() {
  var defaultImg = '../../demos/emoji/none.gif';
  var picker = new goog.ui.emoji.EmojiPicker(defaultImg);
  picker.setDelayedLoad(false);
  picker.addEmojiGroup(spritedEmoji1[0], spritedEmoji1[1]);
  picker.render();

  var palette = picker.getPage(0);

  checkStructureForNonProgressivePicker(palette, spritedEmoji1);
  picker.dispose();
}


function testCellConstructionForProgressiveRenderingSpriting() {
  var defaultImg = '../../demos/emoji/none.gif';
  var picker = new goog.ui.emoji.EmojiPicker(defaultImg);
  picker.setDelayedLoad(false);
  picker.setProgressiveRender(true);
  picker.addEmojiGroup(spritedEmoji1[0], spritedEmoji1[1]);
  picker.render();

  var palette = picker.getPage(0);

  checkStructureForProgressivePicker(palette, spritedEmoji1);

  picker.dispose();
}


function testDelayedLoadPaletteCreationForMultiPagePicker() {
  var defaultImg = '../../demos/emoji/none.gif';
  var picker = new goog.ui.emoji.EmojiPicker(defaultImg);
  picker.setDelayedLoad(true);

  for (var i = 0; i < emojiGroups.length; i++) {
    picker.addEmojiGroup(emojiGroups[i][0], emojiGroups[i][1]);
  }

  picker.render();

  // At this point the picker should have pages filled with the default img
  for (var i = 0; i < emojiGroups.length; i++) {
    checkContentIsDefaultImg(picker.getPage(i), defaultImg);
  }

  // Now load the images
  picker.loadImages();

  // The first page should be loaded
  var page = picker.getPage(0);
  assertTrue('Page ' + i + ' should be in the document but is not',
             page.isInDocument());
  checkContentIsEmojiImages(page, emojiGroups[0][1], defaultImg);

  // The other pages should all be filled with the default img since they are
  // lazily loaded
  for (var i = 1; i < 3; i++) {
    checkContentIsDefaultImg(picker.getPage(i), defaultImg);
  }

  // Activate the other two pages so that their images get loaded, and check
  // that they're now loaded correctly
  var tabPane = picker.getTabPane();

  for (var i = 1; i < 3; i++) {
    tabPane.setSelectedIndex(i);
    page = picker.getPage(i);
    assertTrue(page.isInDocument());
    checkContentIsEmojiImages(page, emojiGroups[i][1], defaultImg);
  }

  picker.dispose();
}


">15 of 15 tests run in 21ms.<br />2 passed, 13 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testCellConstructionForNonProgressiveRenderingSpriting<br />Object #<Object> has no method 'createElement'<br />ERROR in testCellConstructionForProgressiveRenderingSpriting<br />Object #<Object> has no method 'createElement'<br />ERROR in testConstructAndRenderMultiPageEmojiPicker<br />Object #<Object> has no method 'createElement'<br />ERROR in testConstructAndRenderOnePageEmojiPicker<br />Object #<Object> has no method 'createElement'<br />ERROR in testDelayedLoadPaletteCreationForMultiPagePicker<br />Object #<Object> has no method 'createElement'<br />ERROR in testDelayedLoadPaletteCreationForSinglePagePicker<br />Object #<Object> has no method 'createElement'<br />ERROR in testExitDocumentCleansUpProperlyForMultiPageEmojiPicker<br />Object #<Object> has no method 'createElement'<br />ERROR in testExitDocumentCleansUpProperlyForSinglePageEmojiPicker<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetSelectedEmoji<br />Object #<Object> has no method 'createElement'<br />ERROR in testNonDelayedLoadPaletteCreationForMultiPagePicker<br />Object #<Object> has no method 'createElement'<br />ERROR in testNonDelayedLoadPaletteCreationForSinglePagePicker<br />Object #<Object> has no method 'createElement'<br />ERROR in testPreLoadCellConstructionForFastLoadingNonProgressive<br />Object #<Object> has no method 'createElement'<br />ERROR in testPreLoadCellConstructionForFastLoadingProgressive<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>fast_nonprogressive_emojipicker_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.dom');
  goog.require('goog.testing.AsyncTestCase');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.emoji.EmojiPicker');
  goog.require('goog.ui.emoji.SpriteInfo');



var sprite = '../../demos/emoji/sprite.png';
var sprite2 = '../../demos/emoji/sprite2.png';

/**
 * Creates a SpriteInfo object with the specified properties. If the image is
 * sprited via CSS, then only the first parameter needs a value. If the image
 * is sprited via metadata, then the first parameter should be left null.
 *
 * @param {?string} cssClass CSS class to properly display the sprited image.
 * @param {string=} opt_url Url of the sprite image.
 * @param {number=} opt_width Width of the image being sprited.
 * @param {number=} opt_height Height of the image being sprited.
 * @param {number=} opt_xOffset Positive x offset of the image being sprited
 *     within the sprite.
 * @param {number=} opt_yOffset Positive y offset of the image being sprited
 *     within the sprite.
 * @param {boolean=} opt_animated Whether the sprite info is for an animated
 *     emoji.
 */
function si(cssClass, opt_url, opt_width, opt_height, opt_xOffset,
            opt_yOffset, opt_animated) {
  return new goog.ui.emoji.SpriteInfo(cssClass, opt_url, opt_width,
      opt_height, opt_xOffset, opt_yOffset, opt_animated);
}


// This group contains a mix of sprited emoji via css, sprited emoji via
// metadata, and non-sprited emoji.
var spritedEmoji2 = [
    'Emoji 1',
    [
        ['../../demos/emoji/200.gif', 'std.200', si('SPRITE_200')],
        ['../../demos/emoji/201.gif', 'std.201', si('SPRITE_201')],
        ['../../demos/emoji/202.gif', 'std.202', si('SPRITE_202')],
        ['../../demos/emoji/203.gif', 'std.203', si('SPRITE_203')],
        ['../../demos/emoji/204.gif', 'std.204', si('SPRITE_204')],
        ['../../demos/emoji/205.gif', 'std.205', si('SPRITE_205')],
        ['../../demos/emoji/206.gif', 'std.206', si('SPRITE_206')],
        ['../../demos/emoji/2BC.gif', 'std.2BC', si('SPRITE_2BC')],
        ['../../demos/emoji/2BD.gif', 'std.2BD', si('SPRITE_2BD')],
        ['../../demos/emoji/2BE.gif', 'std.2BE',
            si(null, sprite, 18, 18, 36, 54)],
        ['../../demos/emoji/2BF.gif', 'std.2BF',
            si(null, sprite, 18, 18, 0, 126)],
        ['../../demos/emoji/2C0.gif', 'std.2C0',
            si(null, sprite, 18, 18, 18, 305)],
        ['../../demos/emoji/2C1.gif', 'std.2C1',
            si(null, sprite, 18, 18, 0, 287)],
        ['../../demos/emoji/2C2.gif', 'std.2C2',
            si(null, sprite, 18, 18, 18, 126)],
        ['../../demos/emoji/2C3.gif', 'std.2C3',
            si(null, sprite, 18, 18, 36, 234)],
        ['../../demos/emoji/2C4.gif', 'std.2C4',
            si(null, sprite, 18, 18, 36, 72)],
        ['../../demos/emoji/2C5.gif', 'std.2C5',
            si(null, sprite, 18, 18, 54, 54)],
        ['../../demos/emoji/2C6.gif', 'std.2C6'],
        ['../../demos/emoji/2C7.gif', 'std.2C7'],
        ['../../demos/emoji/2C8.gif', 'std.2C8'],
        ['../../demos/emoji/2C9.gif', 'std.2C9'],
        ['../../demos/emoji/2CA.gif', 'std.2CA',
            si(null, sprite2, 18, 20, 36, 72, 1)],
        ['../../demos/emoji/2E3.gif', 'std.2E3',
            si(null, sprite2, 18, 18, 0, 0, 1)],
        ['../../demos/emoji/2EF.gif', 'std.2EF',
            si(null, sprite2, 18, 20, 0, 300, 1)],
        ['../../demos/emoji/2F1.gif', 'std.2F1',
            si(null, sprite2, 18, 18, 0, 320, 1)]
        ]];


/**
 * Returns true if the two paths end with the same file.
 *
 * E.g., ('../../cool.gif', 'file:///home/usr/somewhere/cool.gif') --> true
 *
 * @param {string} path1 First url
 * @param {string} path2 Second url
 */
function checkPathsEndWithSameFile(path1, path2) {
  var pieces1 = path1.split('/');
  var file1 = pieces1[pieces1.length - 1];
  var pieces2 = path2.split('/');
  var file2 = pieces2[pieces2.length - 1];

  return file1 == file2;
}


/**
 * Checks and verifies the structure of a non-progressive fast-loading picker
 * after the animated emoji have loaded.
 *
 * @param {goog.ui.emoji.EmojiPalette} palette Emoji palette to check.
 * @param {Array.<Array.<string>>} emoji Emoji that should be in the palette.
 * @param {Object} images Map of id -> Image for the images loaded in this
 *     picker.
 */
function checkPostLoadStructureForFastLoadNonProgressivePicker(palette,
                                                               emoji,
                                                               images) {
  for (var i = 0; i < emoji[1].length; i++) {
    palette.setSelectedIndex(i);
    var emojiInfo = emoji[1][i];
    var cell = palette.getSelectedItem();
    var id = cell.getAttribute(goog.ui.emoji.Emoji.ATTRIBUTE);
    var inner = cell.firstChild;

    // Check that the cell is a div wrapped around something else, and that the
    // outer div contains the goomoji attribute
    assertEquals('The palette item should be a div wrapped around something',
        cell.tagName, "DIV");
    assertNotNull('The outer div is not wrapped around another element', inner);
    assertEquals('The palette item should have the goomoji attribute',
        cell.getAttribute(goog.ui.emoji.Emoji.ATTRIBUTE), emojiInfo[1]);

    // Now check the contents of the cells
    var url = emojiInfo[0];   // url of the animated emoji
    var spriteInfo = emojiInfo[2];
    if (spriteInfo) {
      assertEquals(inner.tagName, "DIV");
      if (spriteInfo.isAnimated()) {
        var img = images[id];
        checkPathsEndWithSameFile(
            goog.style.getStyle(inner, 'background-image'),
            url);
        assertEquals(String(img.width), goog.style.getStyle(inner, 'width').
            replace(/px/g, '').replace(/pt/g, ''));
        assertEquals(String(img.height), goog.style.getStyle(inner, 'height').
            replace(/px/g, '').replace(/pt/g,''));
        assertEquals('0 0', goog.style.getStyle(inner,
            'background-position').replace(/px/g, '').
            replace(/pt/g, ''));
      } else {
        var cssClass = spriteInfo.getCssClass();
        if (cssClass) {
          assertTrue('Sprite should have its CSS class set',
              goog.dom.classes.has(inner, cssClass));
        } else {
          checkPathsEndWithSameFile(
              goog.style.getStyle(inner, 'background-image'),
              spriteInfo.getUrl());
          assertEquals(spriteInfo.getWidthCssValue(),
              goog.style.getStyle(inner, 'width'));
          assertEquals(spriteInfo.getHeightCssValue(),
              goog.style.getStyle(inner, 'height'));
          assertEquals((spriteInfo.getXOffsetCssValue() + ' ' +
                        spriteInfo.getYOffsetCssValue()).replace(/px/g, '').
              replace(/pt/g, ''),
              goog.style.getStyle(inner,
                  'background-position').replace(/px/g, '').
                  replace(/pt/g, ''));
        }
      }
    } else {
      // A non-sprited emoji is just an img
      assertEquals(inner.tagName, "IMG");
      checkPathsEndWithSameFile(inner.src, emojiInfo[0]);
    }
  }
}

var testCase = new goog.testing.AsyncTestCase(document.title);
testCase.stepTimeout = 4 * 1000;

testCase.setUpPage = function() {
  this.waitForAsync('setUpPage');
  var defaultImg = '../../demos/emoji/none.gif';
  this.picker = new goog.ui.emoji.EmojiPicker(defaultImg);
  this.picker.setDelayedLoad(false);
  this.picker.setManualLoadOfAnimatedEmoji(true);
  this.picker.setProgressiveRender(false);
  this.picker.addEmojiGroup(spritedEmoji2[0], spritedEmoji2[1]);
  this.picker.render();

  this.palette = this.picker.getPage(0);
  var imageLoader = this.palette.getImageLoader();
  this.images = {};

  goog.events.listen(imageLoader, goog.net.EventType.COMPLETE,
      this.onImageLoaderComplete, false, this);
  goog.events.listen(imageLoader, goog.events.EventType.LOAD,
      this.onImageLoaded, false, this);

  // Now we load the animated emoji and check the structure again. The animated
  // emoji will be different.
  this.picker.manuallyLoadAnimatedEmoji();

  this.add(new goog.testing.TestCase.Test('test', this.testStructure, this));
};

testCase.onImageLoaded = function(e) {
  var image = e.target;
  this.log('Image loaded: ' + image.src);
  this.images[image.id] = image;
};

testCase.onImageLoaderComplete = function(e) {
  this.log('Image loading complete');
  this.continueTesting();
};

testCase.tearDownPage = function() {
  this.picker.dispose();
};

testCase.testStructure = function() {
  // Bug 2280968
  if (goog.userAgent.IE && goog.userAgent.VERSION == '6.0') {
    this.log('Not testing emojipicker structure');
    return;
  }

  this.log('Testing emojipicker structure');
  checkPostLoadStructureForFastLoadNonProgressivePicker(this.palette,
      spritedEmoji2, this.images);
};

function setUpPage() {
  testCase.runTests();
}

// Standalone Closure Test Runner.
if (typeof G_testRunner != 'undefined') {
  G_testRunner.initialize(testCase);
}


">TypeError: Cannot set property 'name_' of undefined
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:426:44)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
    at Module.load (module.js:219:31)
    at Function._load (module.js:186:10)
    at require (module.js:231:19)
</td></tr>
<tr><td>spriteinfo_test.html</td><td>Success</td><td> 2 passed, 0 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.emoji.SpriteInfo');


  function testGetCssValues() {
    var si = new goog.ui.emoji.SpriteInfo(null, 'im/s.png', 10, 10, 0, 128);
    assertEquals('10px', si.getWidthCssValue());
    assertEquals('10px', si.getHeightCssValue());
    assertEquals('0', si.getXOffsetCssValue());
    assertEquals('-128px', si.getYOffsetCssValue());
  }

  function testIncompletelySpecifiedSpriteInfoFails() {
    assertThrows('CSS class can\'t be null if the rest of the metadata ' +
                 'isn\'t specified', function() {
      new goog.ui.emoji.SpriteInfo(null)});

    assertThrows('Can\'t create an incompletely specified sprite info',
        function() {
          new goog.ui.emoji.SpriteInfo(null, 's.png', 10);
        });

    assertThrows('Can\'t create an incompletely specified sprite info',
        function() {
          new goog.ui.emoji.SpriteInfo(null, 's.png', 10, 10);
        });

    assertThrows('Can\'t create an incompletely specified sprite info',
        function() {new goog.ui.emoji.SpriteInfo(null, 's.png', 10, 10, 0);});
  }
">n/a</td></tr>
<tr><td>dialog_test.html</td><td>Fail</td><td> 0 passed, 24 failed.</td><td title="

  goog.require('goog.ui.Dialog');
  goog.require('goog.ui.Dialog.ButtonSet');
  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.events.EventType');
  goog.require('goog.style');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');



  var dialog;

  function setUp() {
    dialog = new goog.ui.Dialog();
    var buttons = new goog.ui.Dialog.ButtonSet();
    buttons.set(goog.ui.Dialog.DefaultButtonKeys.CANCEL,
       'Foo!',
       false,
       true);
    buttons.set(goog.ui.Dialog.DefaultButtonKeys.OK,
       'OK',
       true);
    dialog.setButtonSet(buttons);
    dialog.setVisible(true);
  }

  function tearDown() {
    dialog.dispose();
  }

  function testCrossFrameFocus() {
    // Firefox (3.6, maybe future versions) fails this test when there are too
    // many other test files being run concurrently.
    if (goog.userAgent.IE || goog.userAgent.GECKO) {
      return;
    }
    dialog.setVisible(false);
    var iframeWindow = goog.dom.getElement('f').contentWindow;
    var iframeInput = iframeWindow.document.getElementsByTagName('input')[0];
    dialog.setButtonSet(goog.ui.Dialog.ButtonSet.OK);
    var buttonElement = dialog.getButtonSet().getButton(0);
    var focusCounter = 0;
    goog.events.listen(buttonElement, 'focus', function() {
      focusCounter++;
    });
    iframeInput.focus();
    dialog.setVisible(true);
    dialog.setVisible(false);
    iframeInput.focus();
    dialog.setVisible(true);
    assertEquals(2, focusCounter);
  }

  function testNoTitleClose() {
    assertTrue(goog.style.isElementShown(dialog.getTitleCloseElement()));
    dialog.setHasTitleCloseButton(false);
    assertFalse(goog.style.isElementShown(dialog.getTitleCloseElement()));
  }

  /**
   * Helper that clicks the first button in the dialog and checks if that
   * results in a goog.ui.Dialog.EventType.SELECT being dispatched.
   * @param {boolean} disableButton Whether to disable the button being
   *     tested.
   * @return {boolean} Whether a goog.ui.Dialog.EventType.SELECT was dispatched.
   */
  function checkSelectDispatchedOnButtonClick(disableButton) {
    var aButton = dialog.getButtonElement().getElementsByTagName('BUTTON')[0];
    assertNotEquals(aButton, null);
    aButton.disabled = disableButton;
    var wasCalled = false;
    var callRecorder = function() { wasCalled = true; };
    goog.events.listen(dialog, goog.ui.Dialog.EventType.SELECT, callRecorder);
    goog.testing.events.fireClickSequence(aButton);
    return wasCalled;
  }

  function testButtonClicksDispatchSelectEvents() {
    assertTrue('Select event should be dispatched' +
               ' when clicking on an enabled button',
        checkSelectDispatchedOnButtonClick(false));
  }

  function testDisabledButtonClicksDontDispatchSelectEvents() {
    assertFalse('Select event should not be dispatched' +
                ' when clicking on a disabled button',
        checkSelectDispatchedOnButtonClick(true));
  }

  function testEnterKeyDispatchesDefaultSelectEvents() {
    var okButton = dialog.getButtonElement().getElementsByTagName('BUTTON')[1];
    assertNotEquals(okButton, null);
    var wasCalled = false;
    var callRecorder = function() { wasCalled = true; };
    goog.events.listen(dialog, goog.ui.Dialog.EventType.SELECT, callRecorder);
    // Test that event is not dispatched when default button is disabled.
    okButton.disabled = true;
    goog.testing.events.fireKeySequence(dialog.getElement(),
                                        goog.events.KeyCodes.ENTER);
    assertFalse(wasCalled);
    // Test that event is dispatched when default button is enabled.
    okButton.disabled = false;
    goog.testing.events.fireKeySequence(dialog.getElement(),
                                        goog.events.KeyCodes.ENTER);
    assertTrue(wasCalled);
  }

  function testEnterKeyDoesNothingOnSpecialFormElements() {
    dialog.setContent('<textarea>Hello dialog</textarea>');
    var textarea = dialog.getContentElement().
        getElementsByTagName('TEXTAREA')[0];
    var wasCalled = false;
    var callRecorder = function() {
      wasCalled = true;
    };
    goog.events.listen(dialog, goog.ui.Dialog.EventType.SELECT, callRecorder);

    // Enter does not fire on the enabled textarea.
    goog.testing.events.fireKeySequence(textarea,
        goog.events.KeyCodes.ENTER);
    assertFalse(wasCalled);

    // Enter fires on the disabled textarea.
    textarea.disabled = true;
    goog.testing.events.fireKeySequence(textarea,
        goog.events.KeyCodes.ENTER);
    assertTrue(wasCalled);
  }

  function testEscapeKeyDoesNothingOnSpecialFormElements() {
    dialog.setContent('<select><option>Hello</option>' +
        '<option>dialog</option></select>');
    var select = dialog.getContentElement().
        getElementsByTagName('SELECT')[0];
    var wasCalled = false;
    var callRecorder = function() {
      wasCalled = true;
    };
    goog.events.listen(dialog, goog.ui.Dialog.EventType.SELECT, callRecorder);

    // Escape does not fire on the enabled select box.
    goog.testing.events.fireKeySequence(select,
        goog.events.KeyCodes.ESC);
    assertFalse(wasCalled);

    // Escape fires on the disabled select.
    select.disabled = true;
    goog.testing.events.fireKeySequence(select,
        goog.events.KeyCodes.ESC);
    assertTrue(wasCalled);
  }

  function testEscapeCloses() {
    // If escapeCloses is set to false, the dialog should ignore the escape key
    assertTrue(dialog.isEscapeToCancel());
    dialog.setEscapeToCancel(false);
    assertFalse(dialog.isEscapeToCancel());

    var buttons = new goog.ui.Dialog.ButtonSet();
    buttons.set(goog.ui.Dialog.DefaultButtonKeys.OK, 'OK', true);
    dialog.setButtonSet(buttons);
    goog.testing.events.fireKeySequence(dialog.getContentElement(),
        goog.events.KeyCodes.ESC);
    assertTrue(dialog.isVisible());

    // Having a cancel button should make no difference, escape should still not
    // work.
    buttons.set(goog.ui.Dialog.DefaultButtonKeys.CANCEL, 'Foo!', false, true);
    dialog.setButtonSet(buttons);
    goog.testing.events.fireKeySequence(dialog.getContentElement(),
        goog.events.KeyCodes.ESC);
    assertTrue(dialog.isVisible());
  }

  function testEnterKeyWithoutDefaultDoesNotPreventPropagation() {
    var buttons = new goog.ui.Dialog.ButtonSet();
    buttons.set(goog.ui.Dialog.DefaultButtonKeys.CANCEL,
       'Foo!',
       false);
    // Set a button set without a default selected button
    dialog.setButtonSet(buttons);
    dialog.setContent('<span id="linkel" tabindex="0">Link Span</span>');

    var call = false;
    function called() {
      call = true;
    }
    var element = document.getElementById("linkel");
    goog.events.listen(element, goog.events.EventType.KEYDOWN, called);
    goog.testing.events.fireKeySequence(element, goog.events.KeyCodes.ENTER);

    assertTrue('Should have gotten event on the link', call);
  }

  function testPreventDefaultedSelectCausesStopPropagation() {
    dialog.setButtonSet(goog.ui.Dialog.ButtonSet.OK_CANCEL);

    var callCount = 0;
    var keypressCount = 0;
    var keydownCount = 0;

    var preventDefaulter = function(e) {
      e.preventDefault();
    };

    goog.events.listen(
        dialog, goog.ui.Dialog.EventType.SELECT, preventDefaulter);
    goog.events.listen(
        document.body, goog.events.EventType.KEYPRESS, function() {
          keypressCount++;
        });
    goog.events.listen(
        document.body, goog.events.EventType.KEYDOWN, function() {
          keydownCount++;
        });

    // Ensure that if the SELECT event is prevented, all key events
    // are still stopped from propagating.
    goog.testing.events.fireKeySequence(
        dialog.getElement(), goog.events.KeyCodes.ENTER);
    assertEquals('The KEYPRESS should be stopped', 0, keypressCount);
    assertEquals('The KEYDOWN should not be stopped', 1, keydownCount);

    keypressCount = 0;
    keydownCount = 0;
    goog.testing.events.fireKeySequence(
        dialog.getElement(), goog.events.KeyCodes.ESC);
    assertEquals('The KEYDOWN should be stopped', 0, keydownCount);
    // Note: Some browsers don't yield keypresses on escape, so don't check.

    goog.events.unlisten(
        dialog, goog.ui.Dialog.EventType.SELECT, preventDefaulter);

    keypressCount = 0;
    keydownCount = 0;
    goog.testing.events.fireKeySequence(
        dialog.getElement(), goog.events.KeyCodes.ENTER);
    assertEquals('The KEYPRESS should be stopped', 0, keypressCount);
    assertEquals('The KEYDOWN should not be stopped', 1, keydownCount);
  }

  function testEnterKeyHandledInKeypress() {
    var inKeyPress = false;
    goog.events.listen(
        document.body, goog.events.EventType.KEYPRESS,
        function() {
          inKeyPress = true;
        }, true /* capture */);
    goog.events.listen(
        document.body, goog.events.EventType.KEYPRESS,
        function() {
          inKeyPress = false;
        }, false /* !capture */);
    var selectCalled = false;
    goog.events.listen(
        dialog, goog.ui.Dialog.EventType.SELECT, function() {
          selectCalled = true;
          assertTrue(
              'Select must be dispatched during keypress to allow popups',
              inKeyPress);
        });

    goog.testing.events.fireKeySequence(
        dialog.getElement(), goog.events.KeyCodes.ENTER);
    assertTrue(selectCalled);
  }

  function testButtonsWithContentsDispatchSelectEvents() {
    var aButton = dialog.getButtonElement().getElementsByTagName('BUTTON')[0];
    var aSpan = document.createElement('SPAN');
    aButton.appendChild(aSpan);
    var wasCalled = false;
    var callRecorder = function() { wasCalled = true; };
    goog.events.listen(dialog, goog.ui.Dialog.EventType.SELECT, callRecorder);
    goog.testing.events.fireClickSequence(aSpan);
    assertTrue(wasCalled);
  }

  function testAfterHideEvent() {
    var wasCalled = false;
    var callRecorder = function() { wasCalled = true; };
    goog.events.listen(dialog, goog.ui.Dialog.EventType.AFTER_HIDE,
        callRecorder);
    dialog.setVisible(false);
    assertTrue(wasCalled);
  }

  function testCannedButtonSets() {
    dialog.setButtonSet(goog.ui.Dialog.ButtonSet.OK);
    assertButtons([goog.ui.Dialog.DefaultButtonKeys.OK]);

    dialog.setButtonSet(goog.ui.Dialog.ButtonSet.OK_CANCEL);
    assertButtons([goog.ui.Dialog.DefaultButtonKeys.OK,
                   goog.ui.Dialog.DefaultButtonKeys.CANCEL]);

    dialog.setButtonSet(goog.ui.Dialog.ButtonSet.YES_NO);
    assertButtons([goog.ui.Dialog.DefaultButtonKeys.YES,
                   goog.ui.Dialog.DefaultButtonKeys.NO]);

    dialog.setButtonSet(goog.ui.Dialog.ButtonSet.YES_NO_CANCEL);
    assertButtons([goog.ui.Dialog.DefaultButtonKeys.YES,
                   goog.ui.Dialog.DefaultButtonKeys.NO,
                   goog.ui.Dialog.DefaultButtonKeys.CANCEL]);

    dialog.setButtonSet(goog.ui.Dialog.ButtonSet.CONTINUE_SAVE_CANCEL);
    assertButtons([goog.ui.Dialog.DefaultButtonKeys.CONTINUE,
                   goog.ui.Dialog.DefaultButtonKeys.SAVE,
                   goog.ui.Dialog.DefaultButtonKeys.CANCEL]);
  }

  function testFactoryButtonSets() {
    dialog.setButtonSet(goog.ui.Dialog.ButtonSet.createOk());
    assertButtons([goog.ui.Dialog.DefaultButtonKeys.OK]);

    dialog.setButtonSet(goog.ui.Dialog.ButtonSet.createOkCancel());
    assertButtons([goog.ui.Dialog.DefaultButtonKeys.OK,
                   goog.ui.Dialog.DefaultButtonKeys.CANCEL]);

    dialog.setButtonSet(goog.ui.Dialog.ButtonSet.createYesNo());
    assertButtons([goog.ui.Dialog.DefaultButtonKeys.YES,
                   goog.ui.Dialog.DefaultButtonKeys.NO]);

    dialog.setButtonSet(goog.ui.Dialog.ButtonSet.createYesNoCancel());
    assertButtons([goog.ui.Dialog.DefaultButtonKeys.YES,
                   goog.ui.Dialog.DefaultButtonKeys.NO,
                   goog.ui.Dialog.DefaultButtonKeys.CANCEL]);

    dialog.setButtonSet(goog.ui.Dialog.ButtonSet.createContinueSaveCancel());
    assertButtons([goog.ui.Dialog.DefaultButtonKeys.CONTINUE,
                   goog.ui.Dialog.DefaultButtonKeys.SAVE,
                   goog.ui.Dialog.DefaultButtonKeys.CANCEL]);
  }

  function testDefaultButtonClassName() {
    var key = 'someKey';
    var msg = 'someMessage';
    var isDefalut = false;
    var buttonSetOne = new goog.ui.Dialog.ButtonSet().set(key, msg, isDefault);
    dialog.setButtonSet(buttonSetOne);
    var defaultClassName = goog.getCssName(buttonSetOne.class_, 'default');
    var buttonOne = buttonSetOne.getButton(key);
    assertNotEquals(defaultClassName, buttonOne.className);
    var isDefault = true;
    var buttonSetTwo = new goog.ui.Dialog.ButtonSet().set(key, msg, isDefault);
    dialog.setButtonSet(buttonSetTwo);
    var buttonTwo = buttonSetTwo.getButton(key);
    assertEquals(defaultClassName, buttonTwo.className);
  }

  function testGetButton() {
    dialog.setButtonSet(goog.ui.Dialog.ButtonSet.OK);
    var buttons = document.getElementsByName(
        goog.ui.Dialog.DefaultButtonKeys.OK);
    assertEquals(buttons[0], dialog.getButtonSet().getButton(
        goog.ui.Dialog.DefaultButtonKeys.OK));
  }

  function testGetAllButtons() {
    dialog.setButtonSet(goog.ui.Dialog.ButtonSet.YES_NO_CANCEL);
    var buttons = dialog.getElement().getElementsByTagName(
        goog.dom.TagName.BUTTON);
    for (var i = 0; i < buttons.length; i++) {
      assertEquals(buttons[i], dialog.getButtonSet().getAllButtons()[i]);
    }
  }

  function testSetButtonEnabled() {
    var buttonSet = goog.ui.Dialog.ButtonSet.createYesNoCancel();
    dialog.setButtonSet(buttonSet);
    assertFalse(
        buttonSet.getButton(goog.ui.Dialog.DefaultButtonKeys.NO).disabled);
    buttonSet.setButtonEnabled(goog.ui.Dialog.DefaultButtonKeys.NO, false);
    assertTrue(
        buttonSet.getButton(goog.ui.Dialog.DefaultButtonKeys.NO).disabled);
    buttonSet.setButtonEnabled(goog.ui.Dialog.DefaultButtonKeys.NO, true);
    assertFalse(
        buttonSet.getButton(goog.ui.Dialog.DefaultButtonKeys.NO).disabled);
  }

  function testSetAllButtonsEnabled() {
    var buttonSet = goog.ui.Dialog.ButtonSet.createContinueSaveCancel();
    dialog.setButtonSet(buttonSet);
    var buttons = buttonSet.getAllButtons();
    for (var i = 0; i < buttons.length; i++) {
      assertFalse(buttons[i].disabled);
    }

    buttonSet.setAllButtonsEnabled(false);
    for (var i = 0; i < buttons.length; i++) {
      assertTrue(buttons[i].disabled);
    }

    buttonSet.setAllButtonsEnabled(true);
    for (var i = 0; i < buttons.length; i++) {
      assertFalse(buttons[i].disabled);
    }
  }

  function testIframeMask() {
    // generate a new dialog
    dialog.dispose();
    dialog = new goog.ui.Dialog(null, true /* iframe mask */);
    dialog.setVisible(true);

    var iframes =
        goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.IFRAME);
    // NOTE: one iframe already exists in the document, so we check for 1 extra
    // iframe.
    assertEquals('No iframe mask created', 2, iframes.length);
  }

  function testNonModalDialog() {
    // generate a new dialog
    dialog.dispose();
    dialog = new goog.ui.Dialog(null, true /* iframe mask */);
    dialog.setModal(false);
    dialog.setVisible(true);

    var iframes =
        goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.IFRAME);
    // NOTE: one iframe already exists in the document, so we check there are
    // no extra iframes in the document.
    assertEquals('Iframe mask created for modal dialog', 1, iframes.length);
  }

  function testSwapModalForOpenDialog() {
    dialog.dispose();
    dialog = new goog.ui.Dialog(null, true /* iframe mask */);
    dialog.setVisible(true);
    dialog.setModal(false);
    assertNull('IFrame bg element should be null', dialog.bgIframeEl_);
    assertNull('bg element should be null', dialog.bgEl_);

    dialog.setModal(true);
    assertNotNull('IFrame bg element should not be null', dialog.bgIframeEl_);
    assertNotNull('bg element should not be null', dialog.bgEl_);

    assertEquals('IFrame bg element is a child of body',
        document.body, dialog.bgIframeEl_.parentNode);
    assertEquals('bg element is a child of body',
        document.body, dialog.bgEl_.parentNode);

    assertTrue('IFrame bg element should visible',
        goog.style.isElementShown(dialog.bgIframeEl_));
    assertTrue('bg element should be visible',
        goog.style.isElementShown(dialog.bgEl_));
  }

  /**
   * Assert that the dialog has buttons with the given keys in the correct
   * order.
   * @param {Array.<string>} keys An array of button keys.
   */
  function assertButtons(keys) {
    var buttons = dialog.getElement().getElementsByTagName(
        goog.dom.TagName.BUTTON);
    var actualKeys = [];
    for (var i = 0; i < buttons.length; i++) {
      actualKeys[i] = buttons[i].name;
    }
    assertArrayEquals(keys, actualKeys);
  }

  function testButtonSetOkFiresDialogEventOnEscape() {
    dialog.setButtonSet(goog.ui.Dialog.ButtonSet.OK);
    var wasCalled = false;
    var callRecorder = function() { wasCalled = true; };
    goog.events.listen(dialog, goog.ui.Dialog.EventType.SELECT,
        callRecorder);
    goog.testing.events.fireKeySequence(
        dialog.getElement(), goog.events.KeyCodes.ESC);
    assertTrue(wasCalled);
  }
">24 of 24 tests run in 38ms.<br />0 passed, 24 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testAfterHideEvent<br />Object #<Object> has no method 'createElement'<br />ERROR in testButtonClicksDispatchSelectEvents<br />Object #<Object> has no method 'createElement'<br />ERROR in testButtonSetOkFiresDialogEventOnEscape<br />Object #<Object> has no method 'createElement'<br />ERROR in testButtonsWithContentsDispatchSelectEvents<br />Object #<Object> has no method 'createElement'<br />ERROR in testCannedButtonSets<br />Object #<Object> has no method 'createElement'<br />ERROR in testCrossFrameFocus<br />Object #<Object> has no method 'createElement'<br />ERROR in testDefaultButtonClassName<br />Object #<Object> has no method 'createElement'<br />ERROR in testDisabledButtonClicksDontDispatchSelectEvents<br />Object #<Object> has no method 'createElement'<br />ERROR in testEnterKeyDispatchesDefaultSelectEvents<br />Object #<Object> has no method 'createElement'<br />ERROR in testEnterKeyDoesNothingOnSpecialFormElements<br />Object #<Object> has no method 'createElement'<br />ERROR in testEnterKeyHandledInKeypress<br />Object #<Object> has no method 'createElement'<br />ERROR in testEnterKeyWithoutDefaultDoesNotPreventPropagation<br />Object #<Object> has no method 'createElement'<br />ERROR in testEscapeCloses<br />Object #<Object> has no method 'createElement'<br />ERROR in testEscapeKeyDoesNothingOnSpecialFormElements<br />Object #<Object> has no method 'createElement'<br />ERROR in testFactoryButtonSets<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetAllButtons<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetButton<br />Object #<Object> has no method 'createElement'<br />ERROR in testIframeMask<br />Object #<Object> has no method 'createElement'<br />ERROR in testNoTitleClose<br />Object #<Object> has no method 'createElement'<br />ERROR in testNonModalDialog<br />Object #<Object> has no method 'createElement'<br />ERROR in testPreventDefaultedSelectCausesStopPropagation<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetAllButtonsEnabled<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetButtonEnabled<br />Object #<Object> has no method 'createElement'<br />ERROR in testSwapModalForOpenDialog<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>selectionmenubutton_test.html</td><td>Fail</td><td> 0 passed, 6 failed.</td><td title="

  goog.require('goog.Timer');
  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.events.Event');
  goog.require('goog.events.KeyCodes');
  goog.require('goog.positioning');
  goog.require('goog.positioning.Overflow');
  goog.require('goog.style');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.SelectionMenuButton');



var selectionMenuButton;
var clonedSelectionMenuButtonDom;


function setUp() {
  clonedSelectionMenuButtonDom =
      goog.dom.getElement('demoSelectionMenuButton').cloneNode(true);

  selectionMenuButton = new goog.ui.SelectionMenuButton();
}

function tearDown() {
  selectionMenuButton.dispose();

  var element = goog.dom.getElement('demoSelectionMenuButton');
  element.parentNode.replaceChild(clonedSelectionMenuButtonDom, element);
}


/**
 * Open the menu and click on the menu item inside.
 */
function testBasicButtonBehavior() {
  var node = goog.dom.getElement('demoSelectionMenuButton');
  selectionMenuButton.decorate(node);
  goog.testing.events.fireClickSequence(node);

  assertTrue('Menu must open after click', selectionMenuButton.isOpen());

  var menuItemClicked = 0;
  var lastMenuItemClicked = null;
  goog.events.listen(selectionMenuButton.getMenu(),
    goog.ui.Component.EventType.ACTION,
    function(e) {
      menuItemClicked++;
      lastMenuItemClicked = e.target
    });

  var menuItem2 = goog.dom.getElement('menuItem2');
  goog.testing.events.fireClickSequence(menuItem2);
  assertFalse('Menu must close on clicking when open',
      selectionMenuButton.isOpen());
  assertEquals('Number of menu items clicked should be 1', 1, menuItemClicked);
  assertEquals('menuItem2 should be the last menuitem clicked', menuItem2,
      lastMenuItemClicked.getElement());
}


/**
 * Tests that the checkbox fires the same events as the first 2 items.
 */
function testCheckboxFireEvents() {
  var node = goog.dom.getElement('demoSelectionMenuButton');
  selectionMenuButton.decorate(node);

  var menuItemClicked = 0;
  var lastMenuItemClicked = null;
  goog.events.listen(selectionMenuButton.getMenu(),
    goog.ui.Component.EventType.ACTION,
    function(e) {
      menuItemClicked++;
      lastMenuItemClicked = e.target;
    });

  var checkbox = goog.dom.getElement('demoCheckbox');
  assertFalse('Checkbox must be unchecked (i.e. unselected)', checkbox.checked);

  checkbox.checked = true;
  goog.testing.events.fireClickSequence(checkbox);
  assertFalse('Menu must be closed when clicking checkbox',
      selectionMenuButton.isOpen());
  assertEquals('Number of menu items clicked should be 1', 1, menuItemClicked);
  assertEquals('menuItem1 should be the last menuitem clicked',
      goog.dom.getElement('menuItem1'),
      lastMenuItemClicked.getElement());

  checkbox.checked = false;
  goog.testing.events.fireClickSequence(checkbox);
  assertFalse('Menu must be closed when clicking checkbox',
      selectionMenuButton.isOpen());
  assertEquals('Number of menu items clicked should be 2', 2, menuItemClicked);
  assertEquals('menuItem2 should be the last menuitem clicked',
      goog.dom.getElement('menuItem2'), lastMenuItemClicked.getElement());
}


/**
 * Tests that the checkbox state gets updated when the first 2 events fire
 */
function testCheckboxReceiveEvents() {
  var node = goog.dom.getElement('demoSelectionMenuButton');
  selectionMenuButton.decorate(node);

  var checkbox = goog.dom.getElement('demoCheckbox');
  assertFalse('Checkbox must be unchecked (i.e. unselected)', checkbox.checked);

  goog.testing.events.fireClickSequence(goog.dom.getElement('menuItem1'));
  assertTrue('Checkbox must be checked (i.e. selected)', checkbox.checked);

  goog.testing.events.fireClickSequence(goog.dom.getElement('menuItem2'));
  assertFalse('Checkbox must be unchecked (i.e. unselected)', checkbox.checked);
}


/**
 * Tests that set/getSelectionState correctly changes the state
 */
function testSelectionState() {
  var node = goog.dom.getElement('demoSelectionMenuButton');
  selectionMenuButton.decorate(node);

  var checkbox = goog.dom.getElement('demoCheckbox');
  assertFalse('Checkbox must be unchecked (i.e. unselected)', checkbox.checked);

  selectionMenuButton.setSelectionState(
      goog.ui.SelectionMenuButton.SelectionState.ALL);
  assertTrue('Checkbox should be checked when selecting all', checkbox.checked);
  assertEquals('selectionState should be ALL',
      selectionMenuButton.getSelectionState(),
      goog.ui.SelectionMenuButton.SelectionState.ALL);

  selectionMenuButton.setSelectionState(
      goog.ui.SelectionMenuButton.SelectionState.NONE);
  assertFalse('Checkbox should be checked when selecting all',
      checkbox.checked);
  assertEquals('selectionState should be NONE',
      selectionMenuButton.getSelectionState(),
      goog.ui.SelectionMenuButton.SelectionState.NONE);

  selectionMenuButton.setSelectionState(
      goog.ui.SelectionMenuButton.SelectionState.SOME);
  assertTrue('Checkbox should be checked when selecting all', checkbox.checked);
  assertEquals('selectionState should be SOME',
      selectionMenuButton.getSelectionState(),
      goog.ui.SelectionMenuButton.SelectionState.SOME);
}


/**
 * Tests that the checkbox gets disabled when the button is disabled
 */
function testCheckboxDisabled() {
  var node = goog.dom.getElement('demoSelectionMenuButton');
  selectionMenuButton.decorate(node);

  var checkbox = goog.dom.getElement('demoCheckbox');
  assertFalse('Checkbox must be enabled', checkbox.disabled);

  selectionMenuButton.setEnabled(false);
  assertTrue('Checkbox must be disabled', checkbox.disabled);

  selectionMenuButton.setEnabled(true);
  assertFalse('Checkbox must be enabled', checkbox.disabled);
}


/**
 * Tests that clicking the checkbox does not open the menu
 */
function testCheckboxClickMenuClosed() {
  var node = goog.dom.getElement('demoSelectionMenuButton');
  selectionMenuButton.decorate(node);

  var checkbox = goog.dom.getElement('demoCheckbox');
  goog.testing.events.fireMouseDownEvent(checkbox);
  assertFalse('Menu must be closed when mousedown checkbox',
      selectionMenuButton.isOpen());
  goog.testing.events.fireMouseUpEvent(checkbox);
  assertFalse('Menu must remain closed when mouseup checkbox',
      selectionMenuButton.isOpen());

  selectionMenuButton.setOpen(true);
  goog.testing.events.fireClickSequence(checkbox);
  assertFalse('Menu must close when clickin checkbox',
      selectionMenuButton.isOpen());

}


">6 of 6 tests run in 7ms.<br />0 passed, 6 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testBasicButtonBehavior<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testCheckboxClickMenuClosed<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testCheckboxDisabled<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testCheckboxFireEvents<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testCheckboxReceiveEvents<br />Object #<Object> has no method 'cloneNode'<br />ERROR in testSelectionState<br />Object #<Object> has no method 'cloneNode'<br /></td></tr>
<tr><td>popupmenu_test.html</td><td>Fail</td><td> 0 passed, 4 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.events.EventHandler');
  goog.require('goog.events.EventType');
  goog.require('goog.math.Box');
  goog.require('goog.positioning.Corner');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.PopupMenu');



var anchor = goog.dom.getElement('popup-anchor');

// Event handler
var handler;
var showPopup;
var beforeShowPopupCalled;
var popup;

function setUp() {
  handler = new goog.events.EventHandler();
  popup = new goog.ui.PopupMenu();
  popup.render();
}

function tearDown() {
  handler.dispose();
  popup.dispose();
}

/**
 * Asserts properties of {@code target} matches the expected value.
 *
 * @param {Object} target The target specifying how the popup menu should be
 *     attached to an anchor.
 * @param {Element} expectedElement The expected anchoring element.
 * @param {goog.positioning.Corner} expectedTargetCorner The expected value of
 *     the {@code target.targetCorner_} property.
 * @param {goog.positioning.Corner} expectedMenuCorner The expected value of
 *     the {@code target.menuCorner_} property.
 * @param {goog.events.EventType} expectedEventType The expected value of the
 *     {@code target.eventType_} property.
 * @param {goog.math.Box} expectedMargin The expected value of the
 *     {@code target.margin_} property.
 */
function assertTarget(target, expectedElement, expectedTargetCorner,
    expectedMenuCorner, expectedEventType, expectedMargin) {
  var expectedTarget = {
    element_: expectedElement,
    targetCorner_: expectedTargetCorner,
    menuCorner_: expectedMenuCorner,
    eventType_: expectedEventType,
    margin_: expectedMargin
  }

  assertObjectEquals('Target does not match.', expectedTarget, target);
}

/**
 * Test menu receives BEFORE_SHOW event before it's displayed.
 */
function testBeforeShowEvent() {
  var target = popup.createAttachTarget(anchor);
  popup.attach(anchor);

  function beforeShowPopup(e) {
    //Ensure that the element is not yet visible.
    assertFalse('The element should not be shown when BEFORE_SHOW event is ' +
        'being handled',
        goog.style.isElementShown(popup.getElement()));
    // Verify that current anchor is set before dispatching BEFORE_SHOW.
    assertNotNullNorUndefined(popup.getAttachedElement());
    assertEquals('The attached anchor element is incorrect',
        target.element_, popup.getAttachedElement());
    beforeShowPopupCalled = true;
    return showPopup;

  };
  function onShowPopup(e) {
    assertEquals('The attached anchor element is incorrect',
        target.element_, popup.getAttachedElement());
  };

  handler.listen(popup,
                 goog.ui.Menu.EventType.BEFORE_SHOW,
                 beforeShowPopup);
  handler.listen(popup,
                 goog.ui.Menu.EventType.SHOW,
                 onShowPopup);

  beforeShowPopupCalled = false;
  showPopup = false;
  popup.showMenu(target, 0, 0);
  assertTrue('BEFORE_SHOW event handler should be called on #showMenu',
       beforeShowPopupCalled);
  assertFalse('The element should not be shown when BEFORE_SHOW handler ' +
      'returned false',
       goog.style.isElementShown(popup.getElement()));

  beforeShowPopupCalled = false;
  showPopup = true;
  popup.showMenu(target, 0, 0);
  assertTrue('The element should be shown when BEFORE_SHOW handler ' +
      'returned true',
      goog.style.isElementShown(popup.getElement()));
}

/**
 * Test the behavior of {@link PopupMenu.isAttachTarget}.
 */
function testIsAttachTarget() {
  // Before 'attach' is called.
  assertFalse('Menu should not be attached to the element',
      popup.isAttachTarget(anchor));

  popup.attach(anchor);
  assertTrue('Menu should be attached to the anchor',
      popup.isAttachTarget(anchor));

  popup.detach(anchor);
  assertFalse('Menu is expected to be detached from the element',
     popup.isAttachTarget(anchor));
}

/**
 * Tests the behavior of {@link PopupMenu.createAttachTarget}.
 */
function testCreateAttachTarget() {
  // Randomly picking parameters.
  var targetCorner = goog.positioning.Corner.TOP_END;
  var menuCorner = goog.positioning.Corner.BOTTOM_LEFT;
  var contextMenu = false;   // Show menu on mouse down event.
  var margin = new goog.math.Box(0, 10, 5, 25);

  // Simply setting the required parameters.
  var target = popup.createAttachTarget(anchor);
  assertTrue(popup.isAttachTarget(anchor));
  assertTarget(target, anchor, undefined, undefined,
      goog.events.EventType.MOUSEDOWN, undefined);

  // Creating another target with all the parameters.
  target = popup.createAttachTarget(anchor, targetCorner, menuCorner,
      contextMenu, margin);
  assertTrue(popup.isAttachTarget(anchor));
  assertTarget(target, anchor, targetCorner, menuCorner,
      goog.events.EventType.MOUSEDOWN, margin);

  // Finally, switch up the 'contextMenu'
  target = popup.createAttachTarget(anchor, undefined, undefined,
      true /*opt_contextMenu*/, undefined);
  assertTarget(target, anchor, undefined, undefined,
      goog.events.EventType.CONTEXTMENU, undefined);
}

/**
 * Tests the behavior of {@link PopupMenu.getAttachTarget}.
 */
function testGetAttachTarget() {
  // Before the menu is attached to the anchor.
  var target = popup.getAttachTarget(anchor);
  assertTrue('Not expecting a target before the element is attach to the menu',
      target == null);

  // Randomly picking parameters.
  var targetCorner = goog.positioning.Corner.TOP_END;
  var menuCorner = goog.positioning.Corner.BOTTOM_LEFT;
  var contextMenu = false;   // Show menu on mouse down event.
  var margin = new goog.math.Box(0, 10, 5, 25);

  popup.attach(anchor, targetCorner, menuCorner, contextMenu, margin);
  target = popup.getAttachTarget(anchor);
  assertTrue('Failed to get target after attaching element to menu',
      target != null);

  // Make sure we got the right target back.
  assertTarget(target, anchor, targetCorner, menuCorner,
      goog.events.EventType.MOUSEDOWN, margin);
}

">4 of 4 tests run in 12ms.<br />0 passed, 4 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testBeforeShowEvent<br />Object #<Object> has no method 'createElement'<br />ERROR in testCreateAttachTarget<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetAttachTarget<br />Object #<Object> has no method 'createElement'<br />ERROR in testIsAttachTarget<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>iframemask_test.html</td><td>Fail</td><td> 0 passed, 8 failed.</td><td title="

  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.StrictMock');
  goog.require('goog.ui.IframeMask');
  goog.require('goog.ui.Popup');
  goog.require('goog.structs.Pool');



var iframeMask;
var mockClock;

function setUp() {
  goog.dom.getElement('sandbox').innerHTML = '<div id="popup"></div>';
  mockClock = new goog.testing.MockClock(true);

  iframeMask = new goog.ui.IframeMask();
}

function tearDown() {
  iframeMask.dispose();
  mockClock.dispose();

  assertNoIframes();
}

function findOneAndOnlyIframe() {
  var iframes = document.getElementsByTagName(goog.dom.TagName.IFRAME);
  assertEquals('There should be exactly 1 iframe in the document',
      1, iframes.length);
  return iframes[0];
}

function assertNoIframes() {
  assertEquals('Expected no iframes in the document', 0,
      goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.IFRAME).length);
}

function testApplyFullScreenMask() {
  iframeMask.applyMask();

  var iframe = findOneAndOnlyIframe();
  assertEquals('block', iframe.style.display);
  assertEquals('absolute', iframe.style.position);

  // coerce zindex to a string
  assertEquals('1', iframe.style.zIndex + '');

  iframeMask.hideMask();
  assertEquals('none', iframe.style.display);
}

function testApplyOpacity() {
  iframeMask.setOpacity(0.3);
  iframeMask.applyMask();

  if (goog.userAgent.IE) {
    assertContains('Expected opactity to be set in the CSS style',
        '30', findOneAndOnlyIframe().style.cssText);
  } else {
    assertContains('Expected opactity to be set in the CSS style',
        '0.3', findOneAndOnlyIframe().style.cssText);
  }
}

function testApplyZIndex() {
  iframeMask.setZIndex(5);
  iframeMask.applyMask();

  // coerce zindex to a string
  assertEquals('5', findOneAndOnlyIframe().style.zIndex + '');
}

function testSnapElement() {
  iframeMask.setSnapElement(goog.dom.getElement('popup'));
  iframeMask.applyMask();

  var iframe = findOneAndOnlyIframe();
  var bounds = goog.style.getBounds(iframe);
  assertEquals(100, bounds.left);
  assertEquals(900, bounds.top);
  assertEquals(300, bounds.width);
  assertEquals(400, bounds.height);

  iframeMask.setSnapElement(document.documentElement);

  // Make sure that snapping to a different element changes the bounds.
  assertNotEquals('Snap element not updated',
      400, goog.style.getBounds(iframe).height);
}

function testAttachToPopup() {
  var popup = new goog.ui.Popup(goog.dom.getElement('popup'));
  iframeMask.listenOnTarget(popup, goog.ui.PopupBase.EventType.SHOW,
      goog.ui.PopupBase.EventType.HIDE, goog.dom.getElement('popup'));

  assertNoIframes();
  popup.setVisible(true);
  assertNoIframes();

  // Tick because the showing of the iframe mask happens asynchronously.
  // (Otherwise the handling of the mousedown can take so long that a bounce
  // occurs).
  mockClock.tick(1);

  var iframe = findOneAndOnlyIframe();
  var bounds = goog.style.getBounds(iframe);
  assertEquals(300, bounds.width);
  assertEquals(400, bounds.height);
  assertEquals('block', iframe.style.display);

  popup.setVisible(false);
  assertEquals('none', iframe.style.display);
}

function testQuickHidingPopup() {
  var popup = new goog.ui.Popup(goog.dom.getElement('popup'));
  iframeMask.listenOnTarget(popup, goog.ui.PopupBase.EventType.SHOW,
      goog.ui.PopupBase.EventType.HIDE);

  assertNoIframes();
  popup.setVisible(true);
  assertNoIframes();
  popup.setVisible(false);
  assertNoIframes();

  // Tick because the showing of the iframe mask happens asynchronously.
  // (Otherwise the handling of the mousedown can take so long that a bounce
  // occurs).
  mockClock.tick(1);
  assertNoIframes();
}

function testRemoveHandlers() {
  var popup = new goog.ui.Popup(goog.dom.getElement('popup'));
  iframeMask.listenOnTarget(popup, goog.ui.PopupBase.EventType.SHOW,
      goog.ui.PopupBase.EventType.HIDE);
  iframeMask.removeHandlers();
  popup.setVisible(true);

  // Tick because the showing of the iframe mask happens asynchronously.
  // (Otherwise the handling of the mousedown can take so long that a bounce
  // occurs).
  mockClock.tick(1);
  assertNoIframes();
}

function testIframePool() {
  var iframe = goog.dom.iframe.createBlank(goog.dom.getDomHelper());
  var mockPool = new goog.testing.StrictMock(goog.structs.Pool);
  mockPool.getObject();
  mockPool.$returns(iframe);

  mockPool.$replay();

  iframeMask.dispose();

  // Create a new iframe mask with a pool, and verify that it checks
  // its iframe out of the pool instead of creating one.
  iframeMask = new goog.ui.IframeMask(null, mockPool);
  iframeMask.applyMask();
  mockPool.$verify();
  findOneAndOnlyIframe();

  mockPool.$reset();
  
  mockPool.releaseObject(iframe);
  mockPool.$replay();

  // When the iframe mask has a pool, the pool is responsible for
  // removing the iframe from the DOM.
  iframeMask.hideMask();
  mockPool.$verify();
  findOneAndOnlyIframe()

  // And showing the iframe again should check it out of the pool again.
  mockPool.$reset();
  mockPool.getObject();
  mockPool.$returns(iframe);
  mockPool.$replay();
  
  iframeMask.applyMask();
  mockPool.$verify();

  // When the test is over, the iframe mask should be disposed. Make sure
  // that the pool removes the iframe from the page.
  mockPool.$reset();
  mockPool.releaseObject(iframe);
  mockPool.$does(function() {
    goog.dom.removeNode(iframe);
  });
  mockPool.$replay();
}

">8 of 8 tests run in 15ms.<br />0 passed, 8 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testApplyFullScreenMask<br />Object #<Object> has no method 'createElement'<br />ERROR in testApplyOpacity<br />Object #<Object> has no method 'createElement'<br />ERROR in testApplyZIndex<br />Object #<Object> has no method 'createElement'<br />ERROR in testAttachToPopup<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testIframePool<br />Object #<Object> has no method 'createElement'<br />ERROR in testQuickHidingPopup<br />Object #<Object> has no method 'getElementsByTagName'<br />ERROR in testRemoveHandlers<br />Cannot read property 'closure_uid_lzavf0' of undefined<br />ERROR in testSnapElement<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>advancedtooltip_test.html</td><td>Fail</td><td> 0 passed, 5 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.events.EventType');
    goog.require('goog.math.Box');
    goog.require('goog.math.Coordinate');
    goog.require('goog.style');
    goog.require('goog.testing.MockClock');
    goog.require('goog.testing.events');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.AdvancedTooltip');
    goog.require('goog.userAgent');
  

  var att;
  var clock;
  var anchor;
  var elsewhere;
  var popup;

  var SHOWDELAY = 50;
  var HIDEDELAY = 250;
  var TRACKINGDELAY = 100;

  function isWindowTooSmall() {
    // Firefox 3 fails if the window is too small.
    return goog.userAgent.GECKO &&
        (window.innerWidth < 350 || window.innerHeight < 100);
  }

  function setUp() {
    popup = goog.dom.createDom('span',
        {id: 'popup', style: 'position:absolute;top:300;left:300'}, 'Hello');
    att = new goog.ui.AdvancedTooltip('hovertarget');
    att.setElement(popup);
    att.setCursorTracking(true);
    att.setHotSpotPadding(new goog.math.Box(10, 10, 10, 10));
    att.setShowDelayMs(SHOWDELAY);
    att.setHideDelayMs(HIDEDELAY);
    att.setCursorTrackingHideDelayMs(TRACKINGDELAY);
    att.setMargin(new goog.math.Box(300, 0, 0, 300));

    clock = new goog.testing.MockClock(true);

    anchor = goog.dom.getElement('hovertarget');
    elsewhere = goog.dom.getElement('notpopup');
  }

  function tearDown() {
    // tooltip needs to be hidden as well as disposed of so that it doesn't
    // leave global state hanging around to trip up other tests.
    if (att.isVisible()) {
      att.onHide_();
    }
    att.dispose();
    clock.uninstall();
  }

  function assertVisible(msg, element) {
    if (element) {
      assertEquals(msg, 'visible', element.style.visibility);
    } else {
      assertEquals('visible', msg.style.visibility);
    }
  }

  function assertHidden(msg, element) {
    if (element) {
      assertEquals(msg, 'hidden', element.style.visibility);
    } else {
      assertEquals('hidden', msg.style.visibility);
    }
  }

  /**
   * Helper function to fire events related to moving a mouse from one element
   * to another. Fires mouseout, mouseover, and mousemove event.
   * @param {Element} from Element the mouse is moving from.
   * @param {Element} to Element the mouse is moving to.
   */
  function fireMouseEvents(from, to) {
    goog.testing.events.fireMouseOutEvent(from, to);
    goog.testing.events.fireMouseOverEvent(to, from);
    var bounds = goog.style.getBounds(to);
    goog.testing.events.fireMouseMoveEvent(
        document, new goog.math.Coordinate(bounds.left + 1, bounds.top + 1));
  }

  function testCursorTracking() {
    if (isWindowTooSmall()) {
      return;
    }

    var oneThirdOfTheWay, twoThirdsOfTheWay;

    oneThirdOfTheWay = new goog.math.Coordinate(100, 100);
    twoThirdsOfTheWay = new goog.math.Coordinate(200, 200);

    goog.testing.events.fireMouseOverEvent(anchor, elsewhere);
    clock.tick(SHOWDELAY);
    assertVisible('Mouse over anchor should show popup', popup);

    goog.testing.events.fireMouseOutEvent(anchor, elsewhere);
    goog.testing.events.fireMouseMoveEvent(document, oneThirdOfTheWay);
    clock.tick(HIDEDELAY);
    assertVisible("Moving mouse towards popup shouldn't hide it", popup);

    goog.testing.events.fireMouseMoveEvent(document, twoThirdsOfTheWay);
    goog.testing.events.fireMouseMoveEvent(document, oneThirdOfTheWay);
    clock.tick(TRACKINGDELAY);
    assertHidden('Moving mouse away from popup should hide it', popup);

    goog.testing.events.fireMouseMoveEvent(document, twoThirdsOfTheWay);
    goog.testing.events.fireBrowserEvent(new goog.events.Event(
        goog.events.EventType.FOCUS, anchor));
    clock.tick(SHOWDELAY);
    assertVisible('Set focus shows popup', popup);
    goog.testing.events.fireMouseMoveEvent(document, oneThirdOfTheWay);
    clock.tick(TRACKINGDELAY);
    assertHidden('Mouse move after focus should hide popup', popup);
  }

  function testPadding() {
    if (isWindowTooSmall()) {
      return;
    }

    goog.testing.events.fireMouseOverEvent(anchor, elsewhere);
    clock.tick(SHOWDELAY);

    var attBounds = goog.style.getBounds(popup);
    var inPadding = new goog.math.Coordinate(attBounds.left - 5,
                                             attBounds.top - 5);
    var outOfPadding = new goog.math.Coordinate(attBounds.left - 15,
                                                attBounds.top - 15);

    fireMouseEvents(anchor, popup);
    goog.testing.events.fireMouseOutEvent(popup, elsewhere);
    goog.testing.events.fireMouseMoveEvent(document, inPadding);
    clock.tick(HIDEDELAY);
    assertVisible("Mouse out of popup but within padding shouldn't hide it",
                  popup);

    goog.testing.events.fireMouseMoveEvent(document, outOfPadding);
    clock.tick(HIDEDELAY);
    assertHidden("Mouse move beyond popup padding should hide it", popup);
  }


  function testAnchorWithChild() {
    var child = goog.dom.getElement('childtarget');

    fireMouseEvents(elsewhere, anchor);
    fireMouseEvents(anchor, child);
    clock.tick(SHOWDELAY);
    assertVisible('Mouse into child of anchor should still show popup', popup);

    fireMouseEvents(child, anchor);
    clock.tick(HIDEDELAY);
    assertVisible('Mouse from child to anchor should still show popup', popup);
  }

  function testNestedTooltip() {
    if (!isWindowTooSmall()) {
      checkNestedTooltips(false);
    }
  }

  function testNestedAdvancedTooltip() {
    if (!isWindowTooSmall()) {
      checkNestedTooltips(true);
    }
  }

  function checkNestedTooltips(useAdvancedTooltip) {
    popup.appendChild(goog.dom.createDom(
        'span', {id: 'nestedAnchor'}, 'Nested Anchor'));
    var nestedAnchor = goog.dom.getElement('nestedAnchor');
    var nestedTooltip;
    if (useAdvancedTooltip) {
      nestedTooltip = new goog.ui.AdvancedTooltip(nestedAnchor, 'popup');
    } else {
      nestedTooltip = new goog.ui.Tooltip(nestedAnchor, 'popup');
    }
    var nestedPopup = nestedTooltip.getElement();
    nestedTooltip.setShowDelayMs(SHOWDELAY);
    nestedTooltip.setHideDelayMs(HIDEDELAY);

    fireMouseEvents(elsewhere, anchor);
    clock.tick(SHOWDELAY);
    fireMouseEvents(anchor, popup);
    fireMouseEvents(popup, nestedAnchor);
    clock.tick(SHOWDELAY + HIDEDELAY);
    assertVisible('Mouse into nested anchor should show popup', nestedPopup);
    assertVisible('Mouse into nested anchor should not hide parent', popup);
    fireMouseEvents(nestedAnchor, elsewhere);
    clock.tick(HIDEDELAY);
    assertHidden('Mouse out of nested popup should hide it', nestedPopup);
    clock.tick(HIDEDELAY);
    assertHidden('Mouse out of nested popup should eventually hide parent',
                 popup);

    goog.testing.events.fireBrowserEvent(new goog.events.Event(
        goog.events.EventType.FOCUS, anchor));
    clock.tick(SHOWDELAY);
    goog.testing.events.fireBrowserEvent(new goog.events.Event(
        goog.events.EventType.BLUR, anchor));
    goog.testing.events.fireBrowserEvent(new goog.events.Event(
        goog.events.EventType.FOCUS, nestedAnchor));
    clock.tick(SHOWDELAY + HIDEDELAY);
    assertVisible("Moving focus to child anchor doesn't hide parent", popup);
    assertVisible('Set focus shows nested popup', nestedPopup);

    goog.testing.events.fireBrowserEvent(new goog.events.Event(
        goog.events.EventType.BLUR, nestedAnchor));
    goog.testing.events.fireBrowserEvent(new goog.events.Event(
        goog.events.EventType.FOCUS, anchor));
    clock.tick(HIDEDELAY + HIDEDELAY);
    assertHidden('Lose focus hides nested popup', nestedPopup);
    assertVisible(
        "Moving focus from nested anchor to parent doesn't hide parent", popup);

    goog.testing.events.fireBrowserEvent(new goog.events.Event(
        goog.events.EventType.BLUR, anchor));
    goog.testing.events.fireBrowserEvent(new goog.events.Event(
        goog.events.EventType.FOCUS, nestedAnchor));
    clock.tick(SHOWDELAY);
    goog.testing.events.fireBrowserEvent(new goog.events.Event(
        goog.events.EventType.BLUR, nestedAnchor));
    clock.tick(HIDEDELAY);
    assertHidden('Lose focus hides nested popup', nestedPopup);
    clock.tick(HIDEDELAY);
    assertHidden('Nested anchor losing focus hides parent', popup);

    goog.testing.events.fireBrowserEvent(new goog.events.Event(
        goog.events.EventType.FOCUS, anchor));
    clock.tick(SHOWDELAY);
    goog.testing.events.fireBrowserEvent(new goog.events.Event(
        goog.events.EventType.BLUR, anchor));
    goog.testing.events.fireBrowserEvent(new goog.events.Event(
        goog.events.EventType.FOCUS, nestedAnchor));
    clock.tick(SHOWDELAY);
    var coordElsewhere = new goog.math.Coordinate(1, 1);
    goog.testing.events.fireMouseMoveEvent(document, coordElsewhere);
    clock.tick(HIDEDELAY);
    assertHidden('Mouse move should hide parent with active child', popup);
    assertHidden('Mouse move should hide nested popup', nestedPopup);
  }
">5 of 5 tests run in 10ms.<br />0 passed, 5 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testAnchorWithChild<br />Object #<Object> has no method 'createElement'<br />ERROR in testCursorTracking<br />Object #<Object> has no method 'createElement'<br />ERROR in testNestedAdvancedTooltip<br />Object #<Object> has no method 'createElement'<br />ERROR in testNestedTooltip<br />Object #<Object> has no method 'createElement'<br />ERROR in testPadding<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>tooltip_test.html</td><td>Fail</td><td> 0 passed, 8 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.events');
    goog.require('goog.events.Event');
    goog.require('goog.events.EventHandler');
    goog.require('goog.events.EventType');
    goog.require('goog.style');
    goog.require('goog.ui.Tooltip');
    goog.require('goog.testing.MockClock');
    goog.require('goog.testing.TestQueue');
    goog.require('goog.testing.events');
    goog.require('goog.testing.jsunit');
    goog.require('goog.userAgent');
  

    var tt, clock, handler, eventQueue, dom;

    // Allow positions to be off by one in gecko as it reports scrolling
    // offsets in steps of 2.
    var ALLOWED_OFFSET = goog.userAgent.GECKO ? 1 : 0;

    function setUp() {
      // We get access denied error when accessing the iframe in IE on the farm
      // as IE doesn't have the same window size issues as firefox on the farm
      // we bypass the iframe and use the current document instead.
      if (goog.userAgent.IE) {
        dom = goog.dom.getDomHelper(document);
      } else {
        var frame = document.getElementById('testframe');
        var doc = goog.dom.getFrameContentDocument(frame);
        dom = goog.dom.getDomHelper(doc);
      }

      // Host elements in fixed size iframe to avoid window size problems when
      // running under Selenium.
      dom.getDocument().body.innerHTML =
          '<p id="notpopup">Content</p>' +
          '<p id="hovertarget">Hover Here For Popup</p>' +
          '<p id="second">Secondary target</p>';

      tt = new goog.ui.Tooltip(undefined, undefined, dom);
      tt.setElement(dom.createDom('div', {id: 'popup',
                                          style: 'visibility:hidden'},
                                  'Hello'));
      clock = new goog.testing.MockClock(true);
      eventQueue = new goog.testing.TestQueue();
      handler = new goog.events.EventHandler(eventQueue);
      handler.listen(tt, goog.ui.PopupBase.EventType.SHOW, eventQueue.enqueue);
      handler.listen(tt, goog.ui.PopupBase.EventType.HIDE, eventQueue.enqueue);
    }

    function tearDown() {
      // tooltip needs to be hidden as well as disposed of so that it doesn't
      // leave global state hanging around to trip up other tests.
      tt.onHide_();
      tt.dispose();
      clock.uninstall();
      handler.removeAll();
    }

    function testConstructor() {
      var element = tt.getElement();
      assertNotNull('Tooltip should have non-null element', element);
      assertEquals('Tooltip element should be the DIV we created',
          dom.getElement('popup'), element);
      assertEquals('Tooltip element should be a child of the document body',
          dom.getDocument().body, element.parentNode);
    }

    function testTooltipShowsAndHides() {
      var hoverTarget = dom.getElement('hovertarget');
      var elsewhere = dom.getElement('notpopup');
      var element = tt.getElement();
      var position = new goog.math.Coordinate(5, 5);
      assertNotNull('Tooltip should have non-null element', element);
      assertEquals('Initial state should be inactive',
                   goog.ui.Tooltip.State.INACTIVE, tt.getState());
      tt.attach(hoverTarget);
      tt.setShowDelayMs(100);
      tt.setHideDelayMs(50);
      goog.testing.events.fireMouseOverEvent(hoverTarget, elsewhere, position);
      assertEquals(goog.ui.Tooltip.State.WAITING_TO_SHOW, tt.getState());
      clock.tick(101);
      assertEquals('visible', tt.getElement().style.visibility);
      assertEquals('tooltip y position (10px margin below the cursor)', '15px',
          tt.getElement().style.top);
      assertEquals(goog.ui.Tooltip.State.SHOWING, tt.getState());
      assertEquals(goog.ui.PopupBase.EventType.SHOW, eventQueue.dequeue().type);
      assertTrue(eventQueue.isEmpty());

      goog.testing.events.fireMouseOutEvent(hoverTarget, elsewhere);
      assertEquals(goog.ui.Tooltip.State.WAITING_TO_HIDE, tt.getState());
      clock.tick(51);
      assertEquals('hidden', tt.getElement().style.visibility);
      assertEquals(goog.ui.Tooltip.State.INACTIVE, tt.getState());
      assertEquals(goog.ui.PopupBase.EventType.HIDE, eventQueue.dequeue().type);
      assertTrue(eventQueue.isEmpty());
    }

    function testMultipleTargets() {
      var firstTarget = dom.getElement('hovertarget');
      var secondTarget = dom.getElement('second');
      var elsewhere = dom.getElement('notpopup');
      var element = tt.getElement();

      tt.attach(firstTarget);
      tt.attach(secondTarget);
      tt.setShowDelayMs(100);
      tt.setHideDelayMs(50);

      // Move over first target
      goog.testing.events.fireMouseOverEvent(firstTarget, elsewhere);
      clock.tick(101);
      assertEquals(goog.ui.PopupBase.EventType.SHOW, eventQueue.dequeue().type);
      assertTrue(eventQueue.isEmpty());

      // Move from first to second
      goog.testing.events.fireMouseOutEvent(firstTarget, secondTarget);
      goog.testing.events.fireMouseOverEvent(secondTarget, firstTarget);
      assertEquals(goog.ui.Tooltip.State.UPDATING,  tt.getState());
      assertTrue(eventQueue.isEmpty());

      // Move from second to element (before second shows)
      goog.testing.events.fireMouseOutEvent(secondTarget, element);
      goog.testing.events.fireMouseOverEvent(element, secondTarget);
      assertEquals(goog.ui.Tooltip.State.SHOWING, tt.getState());
      assertTrue(eventQueue.isEmpty());

      // Move from element to second, and let it show
      goog.testing.events.fireMouseOutEvent(element, secondTarget);
      goog.testing.events.fireMouseOverEvent(secondTarget, element);
      assertEquals(goog.ui.Tooltip.State.UPDATING, tt.getState());
      clock.tick(101);
      assertEquals(goog.ui.Tooltip.State.SHOWING, tt.getState());
      assertEquals('Anchor should be second target', secondTarget, tt.anchor);
      assertEquals(goog.ui.PopupBase.EventType.HIDE, eventQueue.dequeue().type);
      assertEquals(goog.ui.PopupBase.EventType.SHOW, eventQueue.dequeue().type);
      assertTrue(eventQueue.isEmpty());

      // Move from second to first and then off without first showing
      goog.testing.events.fireMouseOutEvent(secondTarget, firstTarget);
      goog.testing.events.fireMouseOverEvent(firstTarget, secondTarget);
      assertEquals(goog.ui.Tooltip.State.UPDATING, tt.getState());
      goog.testing.events.fireMouseOutEvent(firstTarget, elsewhere);
      assertEquals(goog.ui.Tooltip.State.WAITING_TO_HIDE, tt.getState());
      clock.tick(51);
      assertEquals('hidden', tt.getElement().style.visibility);
      assertEquals(goog.ui.Tooltip.State.INACTIVE, tt.getState());
      assertEquals(goog.ui.PopupBase.EventType.HIDE, eventQueue.dequeue().type);
      assertTrue(eventQueue.isEmpty());
      clock.tick(200);

      // Move from element to second, but detach second before it shows.
      goog.testing.events.fireMouseOutEvent(element, secondTarget);
      goog.testing.events.fireMouseOverEvent(secondTarget, element);
      assertEquals(goog.ui.Tooltip.State.WAITING_TO_SHOW, tt.getState());
      tt.detach(secondTarget);
      clock.tick(200);
      assertEquals(goog.ui.Tooltip.State.INACTIVE, tt.getState());
      assertEquals('Anchor should be second target', secondTarget, tt.anchor);
      assertTrue(eventQueue.isEmpty());
    }

    function testRequireInteraction() {
      var hoverTarget = dom.getElement('hovertarget');
      var elsewhere = dom.getElement('notpopup');

      tt.attach(hoverTarget);
      tt.setShowDelayMs(100);
      tt.setHideDelayMs(50);
      tt.setRequireInteraction(true);

      goog.testing.events.fireMouseOverEvent(hoverTarget, elsewhere);
      clock.tick(101);
      assertEquals(
          'Tooltip should not show without mouse move event',
          'hidden', tt.getElement().style.visibility);
      goog.testing.events.fireMouseMoveEvent(hoverTarget);
      goog.testing.events.fireMouseOverEvent(hoverTarget, elsewhere);
      clock.tick(101);
      assertEquals(
          'Tooltip should show because we had mouse move event',
          'visible', tt.getElement().style.visibility);

      goog.testing.events.fireMouseOutEvent(hoverTarget, elsewhere);
      clock.tick(51);
      assertEquals('hidden', tt.getElement().style.visibility);
      goog.testing.events.fireBrowserEvent(new goog.events.Event(
          goog.events.EventType.FOCUS, hoverTarget));
      clock.tick(101);
      assertEquals(
          'Tooltip should show because we had focus event',
          'visible', tt.getElement().style.visibility);
      goog.testing.events.fireBrowserEvent(new goog.events.Event(
          goog.events.EventType.BLUR, hoverTarget));
      clock.tick(51);
      assertEquals('hidden', tt.getElement().style.visibility);

      goog.testing.events.fireMouseMoveEvent(hoverTarget);
      goog.testing.events.fireMouseOverEvent(hoverTarget, elsewhere);
      goog.testing.events.fireMouseOutEvent(hoverTarget, elsewhere);
      goog.testing.events.fireMouseOverEvent(hoverTarget, elsewhere);
      clock.tick(101);
      assertEquals(
          'A cancelled trigger should also cancel the seen interaction',
          'hidden', tt.getElement().style.visibility);
    }

    function testDispose() {
      var element = tt.getElement();
      tt.dispose();
      assertTrue('Tooltip should have been disposed of', tt.isDisposed());
      assertNull('Tooltip element reference should have been nulled out',
          tt.getElement());
      assertNotEquals('Tooltip element should not be a child of the body',
          document.body, element.parentNode);
    }

    function testNested() {
      var ttNested;
      tt.getElement().appendChild(dom.createDom(
          'span', {id: 'nested'}, 'Goodbye'));
      ttNested = new goog.ui.Tooltip(undefined, undefined, dom);
      ttNested.setElement(dom.createDom('div', {id: 'nestedPopup'}, 'hi'));
      tt.setShowDelayMs(100);
      tt.setHideDelayMs(50);
      ttNested.setShowDelayMs(75);
      ttNested.setHideDelayMs(25);
      var nestedAnchor = dom.getElement('nested');
      var hoverTarget = dom.getElement('hovertarget');
      var outerTooltip = dom.getElement('popup');
      var innerTooltip = dom.getElement('nestedPopup');
      var elsewhere = dom.getElement('notpopup');

      ttNested.attach(nestedAnchor);
      tt.attach(hoverTarget);

      // Test mouse into, out of nested tooltip
      goog.testing.events.fireMouseOverEvent(hoverTarget, elsewhere);
      clock.tick(101);
      goog.testing.events.fireMouseOutEvent(hoverTarget, outerTooltip);
      goog.testing.events.fireMouseOverEvent(outerTooltip, hoverTarget);
      clock.tick(51);
      assertEquals('visible', tt.getElement().style.visibility);
      goog.testing.events.fireMouseOutEvent(outerTooltip, nestedAnchor);
      goog.testing.events.fireMouseOverEvent(nestedAnchor, outerTooltip);
      clock.tick(76);
      assertEquals('visible', tt.getElement().style.visibility);
      assertEquals('visible', ttNested.getElement().style.visibility);
      goog.testing.events.fireMouseOutEvent(nestedAnchor, outerTooltip);
      goog.testing.events.fireMouseOverEvent(outerTooltip, nestedAnchor);
      clock.tick(100);
      assertEquals('visible', tt.getElement().style.visibility);
      assertEquals('hidden', ttNested.getElement().style.visibility);

      // Go back in nested tooltip and then out through tooltip element.
      goog.testing.events.fireMouseOutEvent(outerTooltip, nestedAnchor);
      goog.testing.events.fireMouseOverEvent(nestedAnchor, outerTooltip);
      clock.tick(76);
      goog.testing.events.fireMouseOutEvent(nestedAnchor, innerTooltip);
      goog.testing.events.fireMouseOverEvent(innerTooltip, nestedAnchor);
      clock.tick(15);
      assertEquals('visible', tt.getElement().style.visibility);
      assertEquals('visible', ttNested.getElement().style.visibility);
      goog.testing.events.fireMouseOutEvent(innerTooltip, elsewhere);
      clock.tick(26);
      assertEquals('hidden', ttNested.getElement().style.visibility);
      clock.tick(51);
      assertEquals('hidden', tt.getElement().style.visibility);

      // Test with focus
      goog.testing.events.fireBrowserEvent(new goog.events.Event(
          goog.events.EventType.FOCUS, hoverTarget));
      clock.tick(101);
      goog.testing.events.fireBrowserEvent(new goog.events.Event(
          goog.events.EventType.BLUR, hoverTarget));
      goog.testing.events.fireBrowserEvent(new goog.events.Event(
          goog.events.EventType.FOCUS, nestedAnchor));
      clock.tick(76);
      assertEquals('visible', tt.getElement().style.visibility);
      assertEquals('visible', ttNested.getElement().style.visibility);
      goog.testing.events.fireBrowserEvent(new goog.events.Event(
          goog.events.EventType.BLUR, nestedAnchor));
      goog.testing.events.fireBrowserEvent(new goog.events.Event(
          goog.events.EventType.FOCUS, hoverTarget));
      clock.tick(26);
      assertEquals('visible', tt.getElement().style.visibility);
      assertEquals('hidden', ttNested.getElement().style.visibility);

      ttNested.onHide_();
      ttNested.dispose();
    }

    function testMemoryLeak() {
      var listeners = goog.events.getTotalListenerCount();
      var anchor = dom.createElement('div');
      var tooltip = new goog.ui.Tooltip(anchor, '');
      tooltip.setVisible(true);
      tooltip.dispose();
      assertEquals('no event listeners leaked', listeners,
                   goog.events.getTotalListenerCount());
    }

    function testPosition() {
      dom.getDocument().body.style.paddingBottom = '150%'; // force scrollbar
      var scrollEl = dom.getDocumentScrollElement();

      var anchor = dom.getElement('hovertarget');
      var tooltip = new goog.ui.Tooltip(anchor, 'foo');
      tooltip.getElement().style.position = 'absolute';

      tooltip.cursorPosition.x = 100;
      tooltip.cursorPosition.y = 100;
      tooltip.showForElement(anchor);

      assertEquals('Tooltip should be at cursor position',
        '(110, 110)', // (100, 100) + padding (10, 10)
        goog.style.getPageOffset(tooltip.getElement()).toString());

      scrollEl.scrollTop = 50;

      var offset = goog.style.getPageOffset(tooltip.getElement());
      assertTrue('Tooltip should be at cursor position when scrolled',
        Math.abs(offset.x - 110) <= ALLOWED_OFFSET); // 100 + padding 10
      assertTrue('Tooltip should be at cursor position when scrolled',
        Math.abs(offset.y - 110) <= ALLOWED_OFFSET); // 100 + padding 10

      tooltip.dispose();
      dom.getDocument().body.style.paddingTop = '';
      scrollEl.scrollTop = 0;
    }
  ">8 of 8 tests run in 12ms.<br />0 passed, 8 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testConstructor<br />Cannot read property 'document' of undefined<br />ERROR in testDispose<br />Cannot read property 'document' of undefined<br />ERROR in testMemoryLeak<br />Cannot read property 'document' of undefined<br />ERROR in testMultipleTargets<br />Cannot read property 'document' of undefined<br />ERROR in testNested<br />Cannot read property 'document' of undefined<br />ERROR in testPosition<br />Cannot read property 'document' of undefined<br />ERROR in testRequireInteraction<br />Cannot read property 'document' of undefined<br />ERROR in testTooltipShowsAndHides<br />Cannot read property 'document' of undefined<br /></td></tr>
<tr><td>containerscroller_test.html</td><td>Fail</td><td> 0 passed, 13 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.Container');
  goog.require('goog.ui.ContainerScroller');
  goog.require('goog.ui.Control');



var sandbox = goog.dom.getElement('sandbox');
var sandboxHtml = sandbox.innerHTML;
var container;
var mockClock;
var scroller;

function setUp() {
  container = new goog.ui.Container();
  container.decorate(sandbox);
  container.getElement().scrollTop = 0;
  mockClock = new goog.testing.MockClock(true);
  scroller = null;
}

function tearDown() {
  container.dispose();
  if (scroller) {
    scroller.dispose();
  }
  // Tick one second to clear all the extra registered events.
  mockClock.tick(1000);
  mockClock.uninstall();
  sandbox.innerHTML = sandboxHtml;
}

function testHighlightFirstStaysAtTop() {
  scroller = new goog.ui.ContainerScroller(container);
  container.getChildAt(0).setHighlighted(true);
  assertEquals(0, container.getElement().scrollTop);
}

function testHighlightSecondStaysAtTop() {
  scroller = new goog.ui.ContainerScroller(container);
  container.getChildAt(1).setHighlighted(true);
  assertEquals(0, container.getElement().scrollTop);
}

function testHighlightSecondLastScrollsNearTheBottom() {
  scroller = new goog.ui.ContainerScroller(container);
  container.getChildAt(8).setHighlighted(true);
  assertEquals('Since scrolling is lazy, when highlighting the second' +
      ' last, the item should be the last visible one.',
      80, container.getElement().scrollTop);
}

function testHighlightLastScrollsToBottom() {
  scroller = new goog.ui.ContainerScroller(container);
  container.getChildAt(9).setHighlighted(true);
  assertEquals(100, container.getElement().scrollTop);
}

function testScrollRestoreIfStillVisible() {
  scroller = new goog.ui.ContainerScroller(container);
  container.getChildAt(9).setHighlighted(true);
  var scrollTop = container.getElement().scrollTop;
  container.setVisible(false);
  container.setVisible(true);
  assertEquals('Scroll position should be the same after restore, if it ' +
               'still makes highlighted item visible',
               scrollTop, container.getElement().scrollTop);
}

function testNoScrollRestoreIfNotVisible() {
  scroller = new goog.ui.ContainerScroller(container);
  container.getElement().scrollTop = 100;
  container.setVisible(false);
  container.getChildAt(0).setHighlighted(true);
  container.setVisible(true);
  assertNotEquals('Scroll position should not be the same after restore, if ' +
                  'the scroll position when the menu was hidden no longer ' +
                  'makes the highlighted item visible when the container is ' +
                  'shown again',
               100, container.getElement().scrollTop);
}

function testCenterOnHighlightedOnFirstOpen() {
  container.setVisible(false);
  scroller = new goog.ui.ContainerScroller(container);
  container.getChildAt(4).setHighlighted(true);
  container.setVisible(true);
  // #2 should be at the top when 4 is centered, meaning a scroll top
  // of 40 pixels.
  assertEquals(
      'On the very first display of the scroller, the item should be ' +
      'centered, rather than just assured in view.',
      40, container.getElement().scrollTop);
}

function testHighlightsAreIgnoredInResponseToScrolling() {
  scroller = new goog.ui.ContainerScroller(container);
  container.getChildAt(9).setHighlighted(true);
  goog.testing.events.fireMouseOverEvent(
      goog.dom.getElement('control-5'),
      goog.dom.getElement('control-9'));
  assertEquals('Mouseovers due to scrolls should be ignored',
      9, container.getHighlightedIndex());
}

function testHighlightsAreNotIgnoredWhenNotScrolling() {
  scroller = new goog.ui.ContainerScroller(container);
  container.getChildAt(5).setHighlighted(true);
  mockClock.tick(1000);
  goog.testing.events.fireMouseOutEvent(
      goog.dom.getElement('control-5'),
      goog.dom.getElement('control-6'));
  goog.testing.events.fireMouseOverEvent(
      goog.dom.getElement('control-6'),
      goog.dom.getElement('control-5'));
  assertEquals('Mousovers not due to scrolls should not be ignored',
      6, container.getHighlightedIndex());
}

function testFastSynchronousHighlightsNotIgnored() {
  scroller = new goog.ui.ContainerScroller(container);
  // Whereas subsequent highlights from mouseovers due to a scroll, should
  // be ignored, they should not ignored if they are made synchronusly
  // from the code and not from a mouseover.  Imagine how bad it would be
  // if you could only set the highligted index a certain number of
  // times in the same execution context.
  container.getChildAt(9).setHighlighted(true);
  container.getChildAt(1).setHighlighted(true);
  assertEquals('Synchronous highlights should NOT be ignored.',
      1, container.getHighlightedIndex());
  container.getChildAt(8).setHighlighted(true);
  assertEquals('Synchronous highlights should NOT be ignored.',
      8, container.getHighlightedIndex());
}

function testInitialItemIsCentered() {
  container.getChildAt(4).setHighlighted(true);
  scroller = new goog.ui.ContainerScroller(container);
  // #2 should be at the top when 4 is centered, meaning a scroll top
  // of 40 pixels.
  assertEquals(
      'On the very first attachment of the scroller, the item should be ' +
      'centered, rather than just assured in view.',
      40, container.getElement().scrollTop);
}

function testInitialItemIsCenteredTopItem() {
  container.getChildAt(0).setHighlighted(true);
  scroller = new goog.ui.ContainerScroller(container);
  assertEquals(0, container.getElement().scrollTop);
}

function testHidingMenuItemsDoesntAffectContainerScroller() {
  scroller = new goog.ui.ContainerScroller(container);
  container.getElement = function() {
    fail('getElement() must not be called when a control in the container is ' +
         'being hidden');
  };
  container.getChildAt(0).setVisible(false);
}

">13 of 13 tests run in 14ms.<br />0 passed, 13 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testCenterOnHighlightedOnFirstOpen<br />Invalid element to decorate<br />ERROR in testFastSynchronousHighlightsNotIgnored<br />Invalid element to decorate<br />ERROR in testHidingMenuItemsDoesntAffectContainerScroller<br />Invalid element to decorate<br />ERROR in testHighlightFirstStaysAtTop<br />Invalid element to decorate<br />ERROR in testHighlightLastScrollsToBottom<br />Invalid element to decorate<br />ERROR in testHighlightSecondLastScrollsNearTheBottom<br />Invalid element to decorate<br />ERROR in testHighlightSecondStaysAtTop<br />Invalid element to decorate<br />ERROR in testHighlightsAreIgnoredInResponseToScrolling<br />Invalid element to decorate<br />ERROR in testHighlightsAreNotIgnoredWhenNotScrolling<br />Invalid element to decorate<br />ERROR in testInitialItemIsCentered<br />Invalid element to decorate<br />ERROR in testInitialItemIsCenteredTopItem<br />Invalid element to decorate<br />ERROR in testNoScrollRestoreIfNotVisible<br />Invalid element to decorate<br />ERROR in testScrollRestoreIfStillVisible<br />Invalid element to decorate<br /></td></tr>
<tr><td>nativebuttonrenderer_test.html</td><td>Fail</td><td> undefined</td><td title="

    goog.require('goog.dom');
    goog.require('goog.events');
    goog.require('goog.testing.ExpectedFailures');
    goog.require('goog.testing.events');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.Button');
    goog.require('goog.ui.Component.State');
    goog.require('goog.ui.NativeButtonRenderer');
    goog.require('goog.testing.ui.rendererasserts');
  

    var sandbox = goog.dom.getElement('sandbox');
    var renderer = goog.ui.NativeButtonRenderer.getInstance();
    var expectedFailures = new goog.testing.ExpectedFailures();
    var button;
  
    function setUp() {
      button = new goog.ui.Button('Hello', renderer);
    }
    
    function tearDown() {
      button.dispose();
      goog.dom.removeChildren(sandbox);
      expectedFailures.handleTearDown();
    }

    function testConstructor() {
      assertNotNull('Renderer must not be null', renderer);
    }

    function testGetAriaRole() {
      assertUndefined('ARIA role must be undefined', renderer.getAriaRole());
    }

    function testCreateDom() {
      button.setTooltip('Hello, world!');
      button.setValue('foo');
      var element = renderer.createDom(button);
      assertNotNull('Element must not be null', element);
      assertEquals('Element must be a button', 'BUTTON', element.tagName);
      assertSameElements('Button element must have expected class name',
          ['goog-button'], goog.dom.classes.get(element));
      assertFalse('Button element must be enabled', element.disabled);
      assertEquals('Button element must have expected title', 'Hello, world!',
          element.title);
      // Expected to fail on IE.
      expectedFailures.expectFailureFor(goog.userAgent.IE);
      try {
        // See http://www.fourmilab.ch/fourmilog/archives/2007-03/000824.html
        // for a description of the problem.
        assertEquals('Button element must have expected value', 'foo',
            element.value);
        assertEquals('Button element must have expected contents', 'Hello',
            element.innerHTML);
      } catch (e) {
        expectedFailures.handleException(e);
      }
      assertFalse('Button must not handle its own mouse events',
          button.isHandleMouseEvents());
      assertFalse('Button must not support the custom FOCUSED state',
          button.isSupportedState(goog.ui.Component.State.FOCUSED));
    }

    function testCanDecorate() {
      sandbox.innerHTML =
          '<button id="buttonElement">Button</button>\n' +
          '<input id="inputButton" type="button" value="Input Button">\n' +
          '<input id="inputSubmit" type="submit" value="Input Submit">\n' +
          '<input id="inputReset" type="reset" value="Input Reset">\n' +
          '<input id="inputText" type="text" size="10">\n' +
          '<div id="divButton" class="goog-button">Hello</div>';

      assertTrue('Must be able to decorate <button>',
          renderer.canDecorate(goog.dom.getElement('buttonElement')));
      assertTrue('Must be able to decorate <input type="button">',
          renderer.canDecorate(goog.dom.getElement('inputButton')));
      assertTrue('Must be able to decorate <input type="submit">',
          renderer.canDecorate(goog.dom.getElement('inputSubmit')));
      assertTrue('Must be able to decorate <input type="reset">',
          renderer.canDecorate(goog.dom.getElement('inputReset')));
      assertFalse('Must not be able to decorate <input type="text">',
          renderer.canDecorate(goog.dom.getElement('inputText')));
      assertFalse('Must not be able to decorate <div class="goog-button">',
          renderer.canDecorate(goog.dom.getElement('divButton')));
    }

    function testDecorate() {
      sandbox.innerHTML =
          '<button id="foo" title="Hello!" value="bar">Foo Button</button>\n' +
          '<button id="disabledButton" value="bah" disabled>Disabled</button>';

      var element = renderer.decorate(button, goog.dom.getElement('foo'));
      assertEquals('Decorated element must be as expected',
          goog.dom.getElement('foo'), element);
      assertEquals('Decorated button title must have expected value', 'Hello!',
          button.getTooltip());
      // Expected to fail on IE.
      expectedFailures.expectFailureFor(goog.userAgent.IE);
      try {
        // See http://www.fourmilab.ch/fourmilog/archives/2007-03/000824.html
        // for a description of the problem.
        assertEquals('Decorated button value must have expected value', 'bar',
            button.getValue());
      } catch (e) {
        expectedFailures.handleException(e);
      }
            assertFalse('Button must not handle its own mouse events',
          button.isHandleMouseEvents());
      assertFalse('Button must not support the custom FOCUSED state',
          button.isSupportedState(goog.ui.Component.State.FOCUSED));

      element = renderer.decorate(button,
          goog.dom.getElement('disabledButton'));
      assertFalse('Decorated button must be disabled', button.isEnabled());
      assertSameElements('Decorated button must have expected class names',
          ['goog-button', 'goog-button-disabled'],
          goog.dom.classes.get(element));
      // Expected to fail on IE.
      expectedFailures.expectFailureFor(goog.userAgent.IE);
      try {
        // See http://www.fourmilab.ch/fourmilog/archives/2007-03/000824.html
        // for a description of the problem.
        assertEquals('Decorated button value must have expected value', 'bah',
            button.getValue());
      } catch (e) {
        expectedFailures.handleException(e);
      }
      assertFalse('Button must not handle its own mouse events',
          button.isHandleMouseEvents());
      assertFalse('Button must not support the custom FOCUSED state',
          button.isSupportedState(goog.ui.Component.State.FOCUSED));
    }

    function testInitializeDom() {
      var dispatchedActionCount = 0;
      var handleAction = function() {
        dispatchedActionCount++;
      };
      goog.events.listen(button, goog.ui.Component.EventType.ACTION,
          handleAction);

      button.render(sandbox);
      goog.testing.events.fireClickSequence(button.getElement());
      assertEquals('Button must have dispatched ACTION on click', 1,
          dispatchedActionCount);

      goog.events.unlisten(button, goog.ui.Component.EventType.ACTION,
          handleAction);
    }

    function testIsFocusable() {
      assertTrue('Enabled button must be focusable',
          renderer.isFocusable(button));
      button.setEnabled(false);
      assertFalse('Disabled button must not be focusable',
          renderer.isFocusable(button));
    }

    function testSetState() {
      button.render(sandbox);
      assertFalse('Button element must not be disabled',
          button.getElement().disabled);
      renderer.setState(button, goog.ui.Component.State.DISABLED, true);
      assertTrue('Button element must be disabled',
          button.getElement().disabled);
    }

    function testGetValue() {
      sandbox.innerHTML = '<button id="foo" value="blah">Hello</button>';
      // Expected to fail on IE.
      expectedFailures.expectFailureFor(goog.userAgent.IE);
      try {
        // See http://www.fourmilab.ch/fourmilog/archives/2007-03/000824.html
        // for a description of the problem.
        assertEquals('Value must be as expected', 'blah',
            renderer.getValue(goog.dom.getElement('foo')));
      } catch (e) {
        expectedFailures.handleException(e);
      }
    }

    function testSetValue() {
      button.render(sandbox);
      renderer.setValue(button.getElement(), 'What?');
      assertEquals('Button must have expected value', 'What?',
          renderer.getValue(button.getElement()));
    }

    function testDoesntCallGetCssClassInConstructor() {
      goog.testing.ui.rendererasserts.
          assertNoGetCssClassCallsInConstructor(goog.ui.NativeButtonRenderer);
    }
  ">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:16:28
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>tabbar_test.html</td><td>Fail</td><td> 11 passed, 6 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.events.Event');
    goog.require('goog.events.EventType');
    goog.require('goog.events.KeyCodes');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.Component');
    goog.require('goog.ui.Component.EventType');
    goog.require('goog.ui.Container.Orientation');
    goog.require('goog.ui.Tab');
    goog.require('goog.ui.TabBar');
    goog.require('goog.ui.TabBar.Location');
    goog.require('goog.ui.TabBarRenderer');
  

    var sandbox = goog.dom.getElement('sandbox');
    var tabBar;

    // Fake keyboard event object.
    function FakeKeyEvent(keyCode) {
      this.keyCode = keyCode;
      this.defaultPrevented = false;
      this.propagationStopped = false;
    }
    FakeKeyEvent.prototype.preventDefault = function() {
      this.defaultPrevented = true;
    };
    FakeKeyEvent.prototype.stopPropagation = function() {
      this.propagationStopped = true;
    };

    function setUp() {
      tabBar = new goog.ui.TabBar();
    }

    function tearDown() {
      tabBar.dispose();
      goog.dom.removeChildren(sandbox);
    }

    function testConstructor() {
      assertNotNull('Tab bar must not be null', tabBar);
      assertEquals('Tab bar renderer must default to expected value',
          goog.ui.TabBarRenderer.getInstance(), tabBar.getRenderer());
      assertEquals('Tab bar location must default to expected value',
          goog.ui.TabBar.Location.TOP, tabBar.getLocation());
      assertEquals('Tab bar orientation must default to expected value',
          goog.ui.Container.Orientation.HORIZONTAL, tabBar.getOrientation());

      var fakeRenderer = {};
      var fakeDomHelper = {};
      var bar = new goog.ui.TabBar(goog.ui.TabBar.Location.START, fakeRenderer,
          fakeDomHelper);
      assertNotNull('Tab bar must not be null', bar);
      assertEquals('Tab bar renderer must have expected value',
          fakeRenderer, bar.getRenderer());
      assertEquals('Tab bar DOM helper must have expected value',
          fakeDomHelper, bar.getDomHelper());
      assertEquals('Tab bar location must have expected value',
          goog.ui.TabBar.Location.START, bar.getLocation());
      assertEquals('Tab bar orientation must have expected value',
          goog.ui.Container.Orientation.VERTICAL, bar.getOrientation());
      bar.dispose();
    }

    function testDispose() {
      // Set tabBar.selectedTab_ to something non-null, just to test dispose().
      tabBar.selectedTab_ = {};
      assertNotNull('Selected tab must be non-null', tabBar.getSelectedTab());
      assertFalse('Tab bar must not have been disposed of',
          tabBar.isDisposed());
      tabBar.dispose();
      assertNull('Selected tab must be null', tabBar.getSelectedTab());
      assertTrue('Tab bar must have been disposed of', tabBar.isDisposed());
    }

    function testAddRemoveChild() {
      assertNull('No tab must be selected', tabBar.getSelectedTab());

      var first = new goog.ui.Tab('First');
      tabBar.addChild(first);
      assertEquals('First tab must have been added at the expected index', 0,
          tabBar.indexOfChild(first));
      first.setSelected(true);
      assertEquals('First tab must be selected', 0,
          tabBar.getSelectedTabIndex());

      var second = new goog.ui.Tab('Second');
      tabBar.addChild(second);
      assertEquals('Second tab must have been added at the expected index', 1,
          tabBar.indexOfChild(second));
      assertEquals('First tab must remain selected', 0,
          tabBar.getSelectedTabIndex());

      var firstRemoved = tabBar.removeChild(first);
      assertEquals('removeChild() must return the removed tab', first,
          firstRemoved);
      assertEquals('First tab must no longer be in the tab bar', -1,
          tabBar.indexOfChild(first));
      assertEquals('Second tab must be at the expected index', 0,
          tabBar.indexOfChild(second));
      assertFalse('First tab must no longer be selected', first.isSelected());
      assertTrue('Remaining tab must be selected', second.isSelected());

      var secondRemoved = tabBar.removeChild(second);
      assertEquals('removeChild() must return the removed tab', second,
          secondRemoved);
      assertFalse('Tab must no longer be selected', second.isSelected());
      assertNull('No tab must be selected', tabBar.getSelectedTab());
    }

    function testGetSetLocation() {
      assertEquals('Location must default to TOP', goog.ui.TabBar.Location.TOP,
          tabBar.getLocation());
      tabBar.setLocation(goog.ui.TabBar.Location.START);
      assertEquals('Location must have expected value',
          goog.ui.TabBar.Location.START, tabBar.getLocation());
      tabBar.createDom();
      assertThrows('Attempting to change the location after the tab bar has ' +
          'been rendered must throw error',
          function() {
            tabBar.setLocation(goog.ui.TabBar.Location.BOTTOM);
          });
    }

    function testIsSetAutoSelectTabs() {
      assertTrue('Tab bar must auto-select tabs by default',
          tabBar.isAutoSelectTabs());
      tabBar.setAutoSelectTabs(false);
      assertFalse('Tab bar must no longer auto-select tabs by default',
          tabBar.isAutoSelectTabs());
      tabBar.render(sandbox);
      assertFalse('Rendering must not change auto-select setting',
          tabBar.isAutoSelectTabs());
      tabBar.setAutoSelectTabs(true);
      assertTrue('Tab bar must once again auto-select tabs',
          tabBar.isAutoSelectTabs());
    }

    function setHighlightedIndexFromKeyEvent() {
      var foo, bar, baz;

      // Create a tab bar with some tabs.
      tabBar.addChild(foo = new goog.ui.Tab('foo'));
      tabBar.addChild(bar = new goog.ui.Tab('bar'));
      tabBar.addChild(baz = new goog.ui.Tab('baz'));

      // Verify baseline assumptions.
      assertNull('No tab must be highlighted', tabBar.getHighlighted());
      assertNull('No tab must be selected', tabBar.getSelectedTab());
      assertTrue('Tab bar must auto-select tabs on keyboard highlight',
          tabBar.isAutoSelectTabs());

      // Highlight and selection must move together.
      tabBar.setHighlightedIndexFromKeyEvent(0);
      assertTrue('Foo must be highlighted', foo.isHighlighted());
      assertTrue('Foo must be selected', foo.isSelected());

      // Highlight and selection must move together.
      tabBar.setHighlightedIndexFromKeyEvent(1);
      assertFalse('Foo must no longer be highlighted', foo.isHighlighted());
      assertFalse('Foo must no longer be selected', foo.isSelected());
      assertTrue('Bar must be highlighted', bar.isHighlighted());
      assertTrue('Bar must be selected', bar.isSelected());

      // Turn off auto-select-on-keyboard-highlight.
      tabBar.setAutoSelectTabs(false);

      // Selection must not change; only highlight should move.
      tabBar.setHighlightedIndexFromKeyEvent(2);
      assertFalse('Bar must no longer be highlighted', bar.isHighlighted());
      assertTrue('Bar must remain selected', bar.isSelected());
      assertTrue('Baz must be highlighted', baz.isHighlighted());
      assertFalse('Baz must not be selected', baz.isSelected());
    }

    function testGetSetSelectedTab() {
      var foo, bar, baz;

      // Create a tab bar with some tabs.
      tabBar.addChild(foo = new goog.ui.Tab('foo'));
      tabBar.addChild(bar = new goog.ui.Tab('bar'));
      tabBar.addChild(baz = new goog.ui.Tab('baz'));

      assertNull('No tab must be selected', tabBar.getSelectedTab());

      tabBar.setSelectedTab(baz);
      assertTrue('Baz must be selected', baz.isSelected());
      assertEquals('Baz must be the selected tab', baz,
          tabBar.getSelectedTab());

      tabBar.setSelectedTab(foo);
      assertFalse('Baz must no longer be selected', baz.isSelected());
      assertTrue('Foo must be selected', foo.isSelected());
      assertEquals('Foo must be the selected tab', foo,
          tabBar.getSelectedTab());

      tabBar.setSelectedTab(foo);
      assertTrue('Foo must remain selected', foo.isSelected());
      assertEquals('Foo must remain the selected tab', foo,
          tabBar.getSelectedTab());

      tabBar.setSelectedTab(null);
      assertFalse('Foo must no longer be selected', foo.isSelected());
      assertNull('No tab must be selected', tabBar.getSelectedTab());
    }

    function testGetSetSelectedTabIndex() {
      var foo, bar, baz;

      // Create a tab bar with some tabs.
      tabBar.addChildAt(foo = new goog.ui.Tab('foo'), 0);
      tabBar.addChildAt(bar = new goog.ui.Tab('bar'), 1);
      tabBar.addChildAt(baz = new goog.ui.Tab('baz'), 2);

      assertEquals('No tab must be selected', -1, tabBar.getSelectedTabIndex());

      tabBar.setSelectedTabIndex(2);
      assertTrue('Baz must be selected', baz.isSelected());
      assertEquals('Baz must be the selected tab', 2,
          tabBar.getSelectedTabIndex());

      tabBar.setSelectedTabIndex(0);
      assertFalse('Baz must no longer be selected', baz.isSelected());
      assertTrue('Foo must be selected', foo.isSelected());
      assertEquals('Foo must be the selected tab', 0,
          tabBar.getSelectedTabIndex());

      tabBar.setSelectedTabIndex(0);
      assertTrue('Foo must remain selected', foo.isSelected());
      assertEquals('Foo must remain the selected tab', 0,
          tabBar.getSelectedTabIndex());

      tabBar.setSelectedTabIndex(-1);
      assertFalse('Foo must no longer be selected', foo.isSelected());
      assertEquals('No tab must be selected', -1, tabBar.getSelectedTabIndex());
    }

    function testDeselectIfSelected() {
      var foo, bar, baz;

      // Create a tab bar with some tabs.
      tabBar.addChild(foo = new goog.ui.Tab('foo'));
      tabBar.addChild(bar = new goog.ui.Tab('bar'));
      tabBar.addChild(baz = new goog.ui.Tab('baz'));

      // Start with the middle tab selected.
      bar.setSelected(true);
      assertTrue('Bar must be selected', bar.isSelected());
      assertEquals('Bar must be the selected tab', bar,
          tabBar.getSelectedTab());

      // Should be a no-op.
      tabBar.deselectIfSelected(null);
      assertTrue('Bar must remain selected', bar.isSelected());
      assertEquals('Bar must remain the selected tab', bar,
          tabBar.getSelectedTab());

      // Should be a no-op.
      tabBar.deselectIfSelected(foo);
      assertTrue('Bar must remain selected', bar.isSelected());
      assertEquals('Bar must remain the selected tab', bar,
          tabBar.getSelectedTab());

      // Should deselect bar and select the previous tab (foo).
      tabBar.deselectIfSelected(bar);
      assertFalse('Bar must no longer be selected', bar.isSelected());
      assertTrue('Foo must be selected', foo.isSelected());
      assertEquals('Foo must be the selected tab', foo,
          tabBar.getSelectedTab());

      // Should deselect foo and select the next tab (bar).
      tabBar.deselectIfSelected(foo);
      assertFalse('Foo must no longer be selected', foo.isSelected());
      assertTrue('Bar must be selected', bar.isSelected());
      assertEquals('Bar must be the selected tab', bar,
          tabBar.getSelectedTab());
    }

    function testHandleTabSelect() {
      var foo, bar, baz;

      // Create a tab bar with some tabs.
      tabBar.addChild(foo = new goog.ui.Tab('foo'));
      tabBar.addChild(bar = new goog.ui.Tab('bar'));
      tabBar.addChild(baz = new goog.ui.Tab('baz'));

      assertNull('No tab must be selected', tabBar.getSelectedTab());

      tabBar.handleTabSelect(new goog.events.Event(
          goog.ui.Component.EventType.SELECT, bar));
      assertEquals('Bar must be the selected tab', bar,
          tabBar.getSelectedTab());

      tabBar.handleTabSelect(new goog.events.Event(
          goog.ui.Component.EventType.SELECT, bar));
      assertEquals('Bar must remain selected tab', bar,
          tabBar.getSelectedTab());

      tabBar.handleTabSelect(new goog.events.Event(
          goog.ui.Component.EventType.SELECT, foo));
      assertEquals('Foo must now be the selected tab', foo,
          tabBar.getSelectedTab());
    }

    function testHandleTabUnselect() {
      var foo, bar, baz;

      // Create a tab bar with some tabs.
      tabBar.addChild(foo = new goog.ui.Tab('foo'));
      tabBar.addChild(bar = new goog.ui.Tab('bar'));
      tabBar.addChild(baz = new goog.ui.Tab('baz'));

      bar.setSelected(true);
      assertEquals('Bar must be the selected tab', bar,
          tabBar.getSelectedTab());

      tabBar.handleTabUnselect(new goog.events.Event(
          goog.ui.Component.EventType.UNSELECT, foo));
      assertEquals('Bar must remain the selected tab', bar,
          tabBar.getSelectedTab());

      tabBar.handleTabUnselect(new goog.events.Event(
          goog.ui.Component.EventType.SELECT, bar));
      assertNull('No tab must be selected', tabBar.getSelectedTab());
    }

    function testHandleTabDisable() {
      var foo, bar, baz;

      // Create a tab bar with some tabs.
      tabBar.addChild(foo = new goog.ui.Tab('foo'));
      tabBar.addChild(bar = new goog.ui.Tab('bar'));
      tabBar.addChild(baz = new goog.ui.Tab('baz'));

      // Start with the middle tab selected.
      bar.setSelected(true);
      assertTrue('Bar must be selected', bar.isSelected());
      assertEquals('Bar must be the selected tab', bar,
          tabBar.getSelectedTab());

      // Should deselect bar and select the previous enabled, visible tab (foo).
      bar.setEnabled(false);
      assertFalse('Bar must no longer be selected', bar.isSelected());
      assertTrue('Foo must be selected', foo.isSelected());
      assertEquals('Foo must be the selected tab', foo,
          tabBar.getSelectedTab());

      // Should deselect foo and select the next enabled, visible tab (baz).
      foo.setEnabled(false);
      assertFalse('Foo must no longer be selected', foo.isSelected());
      assertTrue('Baz must be selected', baz.isSelected());
      assertEquals('Baz must be the selected tab', baz,
          tabBar.getSelectedTab());

      // Should deselect baz.  Since there are no enabled, visible tabs left,
      // the tab bar should have no selected tab.
      baz.setEnabled(false);
      assertFalse('Baz must no longer be selected', baz.isSelected());
      assertNull('No tab must be selected', tabBar.getSelectedTab());
    }

    function testHandleTabHide() {
      var foo, bar, baz;

      // Create a tab bar with some tabs.
      tabBar.addChild(foo = new goog.ui.Tab('foo'));
      tabBar.addChild(bar = new goog.ui.Tab('bar'));
      tabBar.addChild(baz = new goog.ui.Tab('baz'));

      // Start with the middle tab selected.
      bar.setSelected(true);
      assertTrue('Bar must be selected', bar.isSelected());
      assertEquals('Bar must be the selected tab', bar,
          tabBar.getSelectedTab());

      // Should deselect bar and select the previous enabled, visible tab (foo).
      bar.setVisible(false);
      assertFalse('Bar must no longer be selected', bar.isSelected());
      assertTrue('Foo must be selected', foo.isSelected());
      assertEquals('Foo must be the selected tab', foo,
          tabBar.getSelectedTab());

      // Should deselect foo and select the next enabled, visible tab (baz).
      foo.setVisible(false);
      assertFalse('Foo must no longer be selected', foo.isSelected());
      assertTrue('Baz must be selected', baz.isSelected());
      assertEquals('Baz must be the selected tab', baz,
          tabBar.getSelectedTab());

      // Should deselect baz.  Since there are no enabled, visible tabs left,
      // the tab bar should have no selected tab.
      baz.setVisible(false);
      assertFalse('Baz must no longer be selected', baz.isSelected());
      assertNull('No tab must be selected', tabBar.getSelectedTab());
    }

    function testHandleFocus() {
      var foo, bar, baz;

      // Create a tab bar with some tabs.
      tabBar.addChild(foo = new goog.ui.Tab('foo'), true);
      tabBar.addChild(bar = new goog.ui.Tab('bar'), true);
      tabBar.addChild(baz = new goog.ui.Tab('baz'), true);

      // Render the tab bar into the document, so highlight handling works as
      // expected.
      tabBar.render(sandbox);

      // Start with the middle tab selected.
      bar.setSelected(true);
      assertTrue('Bar must be selected', bar.isSelected());
      assertEquals('Bar must be the selected tab', bar,
          tabBar.getSelectedTab());

      assertNull('No tab must be highlighted', tabBar.getHighlighted());
      tabBar.handleFocus(new goog.events.Event(goog.events.EventType.FOCUS,
          tabBar.getElement()));
      assertTrue('Bar must be highlighted', bar.isHighlighted());
      assertEquals('Bar must be the highlighted tab', bar,
          tabBar.getHighlighted());
    }

    function testHandleFocusWithoutSelectedTab() {
      var foo, bar, baz;

      // Create a tab bar with some tabs.
      tabBar.addChild(foo = new goog.ui.Tab('foo'), true);
      tabBar.addChild(bar = new goog.ui.Tab('bar'), true);
      tabBar.addChild(baz = new goog.ui.Tab('baz'), true);

      // Render the tab bar into the document, so highlight handling works as
      // expected.
      tabBar.render(sandbox);

      // Start with no tab selected.
      assertNull('No tab must be selected', tabBar.getSelectedTab());

      assertNull('No tab must be highlighted', tabBar.getHighlighted());
      tabBar.handleFocus(new goog.events.Event(goog.events.EventType.FOCUS,
          tabBar.getElement()));
      assertTrue('Foo must be highlighted', foo.isHighlighted());
      assertEquals('Foo must be the highlighted tab', foo,
          tabBar.getHighlighted());
    }

    function testGetOrientationFromLocation() {
      assertEquals(goog.ui.Container.Orientation.HORIZONTAL,
          goog.ui.TabBar.getOrientationFromLocation(
              goog.ui.TabBar.Location.TOP));
      assertEquals(goog.ui.Container.Orientation.HORIZONTAL,
          goog.ui.TabBar.getOrientationFromLocation(
              goog.ui.TabBar.Location.BOTTOM));
      assertEquals(goog.ui.Container.Orientation.VERTICAL,
          goog.ui.TabBar.getOrientationFromLocation(
              goog.ui.TabBar.Location.START));
      assertEquals(goog.ui.Container.Orientation.VERTICAL,
          goog.ui.TabBar.getOrientationFromLocation(
              goog.ui.TabBar.Location.END));
    }

    function testKeyboardNavigation() {
      var foo, bar, baz;

      // Create a tab bar with some tabs.
      tabBar.addChild(foo = new goog.ui.Tab('foo'), true);
      tabBar.addChild(bar = new goog.ui.Tab('bar'), true);
      tabBar.addChild(baz = new goog.ui.Tab('baz'), true);
      tabBar.render(sandbox);

      // Highlight the selected tab (this happens automatically when the tab
      // bar receives keyboard focus).
      tabBar.setSelectedTabIndex(0);
      tabBar.getSelectedTab().setHighlighted(true);

      // Count events dispatched by each tab.
      var eventCount = {
        'foo': {'select': 0, 'unselect': 0},
        'bar': {'select': 0, 'unselect': 0},
        'baz': {'select': 0, 'unselect': 0}
      };

      function countEvent(e) {
        var tabId = e.target.getContent();
        var type = e.type;
        eventCount[tabId][type]++;
      }

      function getEventCount(tabId, type) {
        return eventCount[tabId][type];
      }

      // Listen for SELECT and UNSELECT events on the tab bar.
      goog.events.listen(tabBar, [
        goog.ui.Component.EventType.SELECT,
        goog.ui.Component.EventType.UNSELECT
      ], countEvent);

      // Verify baseline assumptions.
      assertTrue('Tab bar must auto-select tabs',
          tabBar.isAutoSelectTabs());
      assertEquals('First tab must be selected', 0,
          tabBar.getSelectedTabIndex());

      // Simulate a right arrow key event.
      var rightEvent = new FakeKeyEvent(goog.events.KeyCodes.RIGHT);
      assertTrue('Key event must have beeen handled',
          tabBar.handleKeyEvent(rightEvent));
      assertTrue('Key event propagation must have been stopped',
          rightEvent.propagationStopped);
      assertTrue('Default key event must have been prevented',
          rightEvent.defaultPrevented);
      assertEquals('Foo must have dispatched UNSELECT', 1,
          getEventCount('foo', goog.ui.Component.EventType.UNSELECT));
      assertEquals('Bar must have dispatched SELECT', 1,
          getEventCount('bar', goog.ui.Component.EventType.SELECT));
      assertEquals('Bar must have been selected', bar, tabBar.getSelectedTab());

      // Simulate a left arrow key event.
      var leftEvent = new FakeKeyEvent(goog.events.KeyCodes.LEFT);
      assertTrue('Key event must have beeen handled',
          tabBar.handleKeyEvent(leftEvent));
      assertTrue('Key event propagation must have been stopped',
          leftEvent.propagationStopped);
      assertTrue('Default key event must have been prevented',
          leftEvent.defaultPrevented);
      assertEquals('Bar must have dispatched UNSELECT', 1,
          getEventCount('bar', goog.ui.Component.EventType.UNSELECT));
      assertEquals('Foo must have dispatched SELECT', 1,
          getEventCount('foo', goog.ui.Component.EventType.SELECT));
      assertEquals('Foo must have been selected', foo, tabBar.getSelectedTab());

      // Disable tab auto-selection.
      tabBar.setAutoSelectTabs(false);

      // Simulate another left arrow key event.
      var anotherLeftEvent = new FakeKeyEvent(goog.events.KeyCodes.LEFT);
      assertTrue('Key event must have beeen handled',
          tabBar.handleKeyEvent(anotherLeftEvent));
      assertTrue('Key event propagation must have been stopped',
          anotherLeftEvent.propagationStopped);
      assertTrue('Default key event must have been prevented',
          anotherLeftEvent.defaultPrevented);
      assertEquals('Foo must remain selected', foo, tabBar.getSelectedTab());
      assertEquals('Foo must not have dispatched another UNSELECT event', 1,
          getEventCount('foo', goog.ui.Component.EventType.UNSELECT));
      assertEquals('Baz must not have dispatched a SELECT event', 0,
          getEventCount('baz', goog.ui.Component.EventType.SELECT));
      assertFalse('Baz must not be selected', baz.isSelected());
      assertTrue('Baz must be highlighted', baz.isHighlighted());

      // Simulate 'g' key event.
      var gEvent = new FakeKeyEvent(goog.events.KeyCodes.G);
      assertFalse('Key event must not have beeen handled',
          tabBar.handleKeyEvent(gEvent));
      assertFalse('Key event propagation must not have been stopped',
          gEvent.propagationStopped);
      assertFalse('Default key event must not have been prevented',
          gEvent.defaultPrevented);
      assertEquals('Foo must remain selected', foo, tabBar.getSelectedTab());

      // Clean up.
      goog.events.unlisten(tabBar, [
        goog.ui.Component.EventType.SELECT,
        goog.ui.Component.EventType.UNSELECT
      ], countEvent);
    }

    function testExitAndEnterDocument() {
      var component = new goog.ui.Component();
      component.render(sandbox);

      var tab1 = new goog.ui.Tab('tab1');
      var tab2 = new goog.ui.Tab('tab2');
      var tab3 = new goog.ui.Tab('tab3');
      tabBar.addChild(tab1, true);
      tabBar.addChild(tab2, true);
      tabBar.addChild(tab3, true);

      component.addChild(tabBar, true);
      tab2.setSelected(true);
      assertEquals(tabBar.getSelectedTab(), tab2);

      component.removeChild(tabBar, true);
      tab1.setSelected(true);
      assertEquals(tabBar.getSelectedTab(), tab2);

      component.addChild(tabBar, true);
      tab3.setSelected(true);
      assertEquals(tabBar.getSelectedTab(), tab3);
    }
  ">17 of 17 tests run in 48ms.<br />11 passed, 6 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testExitAndEnterDocument<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetSetLocation<br />Object #<Object> has no method 'createElement'<br />ERROR in testHandleFocus<br />Object #<Object> has no method 'createElement'<br />ERROR in testHandleFocusWithoutSelectedTab<br />Object #<Object> has no method 'createElement'<br />ERROR in testIsSetAutoSelectTabs<br />Object #<Object> has no method 'createElement'<br />ERROR in testKeyboardNavigation<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>splitpane_test.html</td><td>Fail</td><td> 0 passed, 4 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.classes');
  goog.require('goog.math.Size');
  goog.require('goog.style');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.Component');
  goog.require('goog.ui.SplitPane');
  goog.require('goog.ui.SplitPane.Orientation');



var splitpane;
var leftComponent;
var rightComponent;

function setUp() {
  leftComponent = new goog.ui.Component();
  rightComponent = new goog.ui.Component();
  splitpane = new goog.ui.SplitPane(leftComponent, rightComponent,
      goog.ui.SplitPane.Orientation.HORIZONTAL);
}

function tearDown() {
  splitpane.dispose();
  leftComponent.dispose();
  rightComponent.dispose();
  goog.dom.getElement('sandbox').innerHTML = '';
}

function testRender() {
  splitpane.render(goog.dom.getElement('sandbox'));
  assertEquals(1, goog.dom.getElementsByTagNameAndClass('div',
      'goog-splitpane').length);
  assertEquals(1, goog.dom.getElementsByTagNameAndClass('div',
      'goog-splitpane-first-container').length);
  assertEquals(1, goog.dom.getElementsByTagNameAndClass('div',
      'goog-splitpane-second-container').length);
  assertEquals(1, goog.dom.getElementsByTagNameAndClass('div',
      'goog-splitpane-handle').length);
}

function testDecorate() {
  var mainDiv = goog.dom.createDom('div', 'goog-splitpane',
      goog.dom.createDom('div', 'goog-splitpane-first-container'),
      goog.dom.createDom('div', 'goog-splitpane-second-container'),
      goog.dom.createDom('div', 'goog-splitpane-handle'));
  var sandbox = goog.dom.getElement('sandbox');
  goog.dom.appendChild(sandbox, mainDiv);

  splitpane.decorate(mainDiv);  
}

function testSetSize() {
  splitpane.setInitialSize(200);
  splitpane.setHandleSize(10);
  splitpane.render(goog.dom.getElement('sandbox'));

  splitpane.setSize(new goog.math.Size(500, 300));
  assertEquals(200, splitpane.getFirstComponentSize());

  var splitpaneSize = goog.style.getBorderBoxSize(splitpane.getElement());
  assertEquals(500, splitpaneSize.width);
  assertEquals(300, splitpaneSize.height);  
}


function testOrientationChange() {
  splitpane.setInitialSize(200);
  splitpane.setHandleSize(10);
  splitpane.render(goog.dom.getElement('sandbox'));
  splitpane.setSize(new goog.math.Size(500, 300));

  var first = goog.dom.getElementsByTagNameAndClass('div',
      'goog-splitpane-first-container')[0];
  var second = goog.dom.getElementsByTagNameAndClass('div',
      'goog-splitpane-second-container')[0];
  var handle = goog.dom.getElementsByTagNameAndClass('div',
      'goog-splitpane-handle')[0];

  var handleSize = goog.style.getBorderBoxSize(handle);
  assertEquals(10, handleSize.width);
  assertEquals(300, handleSize.height);

  var firstSize = goog.style.getBorderBoxSize(first);
  assertEquals(200, firstSize.width);
  assertEquals(300, firstSize.height);

  var secondSize = goog.style.getBorderBoxSize(second);
  assertEquals(290, secondSize.width); // 500 - 200 - 10 = 290
  assertEquals(300, secondSize.height);

  splitpane.setOrientation(goog.ui.SplitPane.Orientation.VERTICAL);

  handleSize = goog.style.getBorderBoxSize(handle);
  assertEquals(10, handleSize.height);
  assertEquals(500, handleSize.width);

  firstSize = goog.style.getBorderBoxSize(first);
  assertEquals(120, firstSize.height); // 200 * 300/500 = 120
  assertEquals(500, firstSize.width);

  secondSize = goog.style.getBorderBoxSize(second);
  assertEquals(170, secondSize.height); // 300 - 120 - 10 = 170
  assertEquals(500, secondSize.width);

  splitpane.setOrientation(goog.ui.SplitPane.Orientation.HORIZONTAL);

  handleSize = goog.style.getBorderBoxSize(handle);
  assertEquals(10, handleSize.width);
  assertEquals(300, handleSize.height);

  firstSize = goog.style.getBorderBoxSize(first);
  assertEquals(200, firstSize.width);
  assertEquals(300, firstSize.height);

  secondSize = goog.style.getBorderBoxSize(second);
  assertEquals(290, secondSize.width);
  assertEquals(300, secondSize.height);
}

">4 of 4 tests run in 10ms.<br />0 passed, 4 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testDecorate<br />Object #<Object> has no method 'createElement'<br />ERROR in testOrientationChange<br />Object #<Object> has no method 'createElement'<br />ERROR in testRender<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetSize<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>checkbox_test.html</td><td>Fail</td><td> 4 passed, 5 failed.</td><td title="

    goog.require('goog.array');
    goog.require('goog.dom');
    goog.require('goog.dom.classes');
    goog.require('goog.events.KeyCodes');
    goog.require('goog.testing.asserts');
    goog.require('goog.testing.events');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.Checkbox');
    goog.require('goog.ui.decorate');
  

  var checkbox;

  function setUp() {
    checkbox = new goog.ui.Checkbox();
  }

  function tearDown() {
    checkbox.dispose();
  }

  function testClassNames() {
    checkbox.createDom();

    checkbox.setChecked(false);
    assertSameElements('classnames of unchecked checkbox',
        ['goog-checkbox', 'goog-checkbox-unchecked'],
        goog.dom.classes.get(checkbox.getElement()));

    checkbox.setChecked(true);
    assertSameElements('classnames of checked checkbox',
        ['goog-checkbox', 'goog-checkbox-checked'],
        goog.dom.classes.get(checkbox.getElement()));

    checkbox.setChecked(null);
    assertSameElements('classnames of partially checked checkbox',
        ['goog-checkbox', 'goog-checkbox-undetermined'],
        goog.dom.classes.get(checkbox.getElement()));

    checkbox.setEnabled(false);
    assertSameElements('classnames of partially checked disabled checkbox',
        ['goog-checkbox',
         'goog-checkbox-undetermined',
         'goog-checkbox-disabled'],
        goog.dom.classes.get(checkbox.getElement()));
  }

  function testIsEnabled() {
    assertTrue('enabled by default', checkbox.isEnabled());
    checkbox.setEnabled(false);
    assertFalse('has been disabled', checkbox.isEnabled());
  }

  function testCheckedState() {
    assertTrue('unchecked by default', !checkbox.isChecked() &&
        checkbox.isUnchecked() && !checkbox.isUndetermined());

    checkbox.setChecked(true);
    assertTrue('set to checked', checkbox.isChecked() &&
        !checkbox.isUnchecked() && !checkbox.isUndetermined());

    checkbox.setChecked(null);
    assertTrue('set to partially checked', !checkbox.isChecked() &&
        !checkbox.isUnchecked() && checkbox.isUndetermined());
  }

  function testToggle() {
    checkbox.setChecked(null);
    checkbox.toggle();
    assertTrue('undetermined -> checked', checkbox.getChecked());
    checkbox.toggle();
    assertFalse('checked -> unchecked', checkbox.getChecked());
    checkbox.toggle();
    assertTrue('unchecked -> checked', checkbox.getChecked());
  };

  function testEvents() {
    checkbox.render();

    var events = []
    goog.events.listen(checkbox,
        [goog.ui.Component.EventType.CHECK,
         goog.ui.Component.EventType.UNCHECK,
         goog.ui.Component.EventType.CHANGE],
        function(e) {
          events.push(e.type);
        });

    checkbox.setEnabled(false);
    goog.testing.events.fireClickSequence(checkbox.getElement());
    assertArrayEquals('disabled => no events', [], events);
    assertFalse('checked state did not change', checkbox.getChecked());
    events = [];

    checkbox.setEnabled(true);
    goog.testing.events.fireClickSequence(checkbox.getElement());
    assertArrayEquals('CHECK+CHANGE fired', ['check', 'change'], events);
    assertTrue('checkbox became checked', checkbox.getChecked());
    events = [];

    goog.testing.events.fireClickSequence(checkbox.getElement());
    assertArrayEquals('UNCHECK+CHANGE fired', ['uncheck', 'change'], events);
    assertFalse('checkbox became unchecked', checkbox.getChecked());
    events = [];

    goog.events.listen(checkbox, goog.ui.Component.EventType.CHECK,
        function(e) {
          e.preventDefault();
        });
    goog.testing.events.fireClickSequence(checkbox.getElement());
    assertArrayEquals('CHECK event fired', ['check'], events);
    assertFalse('toggling has been prevented', checkbox.getChecked());
  }

  function testLabel() {
    var label = goog.dom.createElement('div');
    document.body.appendChild(label);
    try {
      checkbox.setChecked(false);
      checkbox.setLabel(label);
      checkbox.render(label);

      goog.testing.events.fireClickSequence(label);
      assertTrue('checkbox toggled if the label is clicked',
          checkbox.getChecked());
      goog.testing.events.fireClickSequence(checkbox.getElement());
      assertFalse('checkbox toggled if it is clicked', checkbox.getChecked());

      checkbox.setLabel(null);
      goog.testing.events.fireClickSequence(label);
      assertFalse('label element deactivated', checkbox.getChecked());
      goog.testing.events.fireClickSequence(checkbox.getElement());
      assertTrue('checkbox still active', checkbox.getChecked());
    } finally {
      document.body.removeChild(label);
    }
  }

  function testConstructor() {
    assertEquals('state is unchecked', goog.ui.Checkbox.State.UNCHECKED,
        checkbox.getChecked());

    var testCheckboxWithState = new goog.ui.Checkbox(
        goog.ui.Checkbox.State.UNDETERMINED);
    assertNotNull('checkbox created with custom state', testCheckboxWithState);
    assertEquals('checkbox state is undetermined',
        goog.ui.Checkbox.State.UNDETERMINED,
        testCheckboxWithState.getChecked());
    testCheckboxWithState.dispose();
  }

  function testSpaceKey() {
    var normalSpan = goog.dom.getElement('normal');

    checkbox.decorate(normalSpan);
    assertEquals('default state is unchecked',
        goog.ui.Checkbox.State.UNCHECKED, checkbox.getChecked());
    goog.testing.events.fireKeySequence(normalSpan, goog.events.KeyCodes.SPACE);
    assertEquals('SPACE toggles checkbox to be checked',
        goog.ui.Checkbox.State.CHECKED, checkbox.getChecked());
    goog.testing.events.fireKeySequence(normalSpan, goog.events.KeyCodes.SPACE);
    assertEquals('another SPACE toggles checkbox to be unchecked',
        goog.ui.Checkbox.State.UNCHECKED, checkbox.getChecked());

    // Enter for example doesn't work
    goog.testing.events.fireKeySequence(normalSpan, goog.events.KeyCodes.ENTER);
    assertEquals('Enter leaves checkbox unchecked',
        goog.ui.Checkbox.State.UNCHECKED, checkbox.getChecked());
  }

  function testDecorate() {
    var normalSpan = goog.dom.getElement('normal');
    var checkedSpan = goog.dom.getElement('checked');
    var uncheckedSpan = goog.dom.getElement('unchecked');
    var undeterminedSpan = goog.dom.getElement('undetermined');
    var disabledSpan = goog.dom.getElement('disabled');

    validateCheckBox(normalSpan, goog.ui.Checkbox.State.UNCHECKED);
    validateCheckBox(checkedSpan, goog.ui.Checkbox.State.CHECKED);
    validateCheckBox(uncheckedSpan, goog.ui.Checkbox.State.UNCHECKED);
    validateCheckBox(undeterminedSpan, goog.ui.Checkbox.State.UNDETERMINED);
    validateCheckBox(disabledSpan, goog.ui.Checkbox.State.UNCHECKED, true);
  }

  function validateCheckBox(span, state, opt_disabled) {
    var testCheckbox = goog.ui.decorate(span);
    assertNotNull('checkbox created', testCheckbox);
    assertEquals('decorate was successful',
        goog.ui.Checkbox, testCheckbox.constructor)
    assertEquals('checkbox state should be: ' + state, state,
        testCheckbox.getChecked());
    assertEquals('checkbox is ' + (!opt_disabled ? 'enabled' : 'disabled'),
        !opt_disabled, testCheckbox.isEnabled());
    testCheckbox.dispose();
  }

">9 of 9 tests run in 13ms.<br />4 passed, 5 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testClassNames<br />Object #<Object> has no method 'createElement'<br />ERROR in testDecorate<br />checkbox created<br />Expected not to be <null><br />> assertNotNull at testing/asserts.js:329:3<br />> validateCheckBox at _tmpclosuretest.js:189:5<br />> testDecorate at _tmpclosuretest.js:180:5<br />ERROR in testEvents<br />Object #<Object> has no method 'createElement'<br />ERROR in testLabel<br />Object #<Object> has no method 'createElement'<br />ERROR in testSpaceKey<br />Cannot read property 'display' of undefined<br /></td></tr>
<tr><td>colormenubuttonrenderer_test.html</td><td>Fail</td><td> 1 passed, 3 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.dom.classes');
  goog.require('goog.events');
  goog.require('goog.events.Event');
  goog.require('goog.testing.events');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.ui.RendererHarness');
  goog.require('goog.testing.ui.rendererasserts');
  goog.require('goog.ui.ColorMenuButton');
  goog.require('goog.userAgent');



var harness;

function setUp() {
  harness = new goog.testing.ui.RendererHarness(
      goog.ui.ColorMenuButtonRenderer.getInstance(),
      goog.dom.getElement('parent'),
      goog.dom.getElement('decoratedButton'));
}

function tearDown() {
  harness.dispose();
}

function testEquality() {
  harness.attachControlAndRender(
      new goog.ui.ColorMenuButton('Foo'));
  harness.attachControlAndDecorate(
      new goog.ui.ColorMenuButton());
  harness.assertDomMatches();
}

function testWrapCaption() {
  var caption = goog.dom.createDom('div', null, 'Foo');
  var wrappedCaption = goog.ui.ColorMenuButtonRenderer.wrapCaption(caption,
      goog.dom.getDomHelper());
  assertNotEquals('Caption should have been wrapped', caption, wrappedCaption);
  assertEquals('Wrapped caption should have indicator css class',
      'goog-color-menu-button-indicator', wrappedCaption.className);
}

function testSetCaptionValue() {
  var caption = goog.dom.createDom('div', null, 'Foo');
  var wrappedCaption = goog.ui.ColorMenuButtonRenderer.wrapCaption(caption,
      goog.dom.getDomHelper());
  goog.ui.ColorMenuButtonRenderer.setCaptionValue(wrappedCaption, 'red');

  var expectedColor = goog.userAgent.IE ? '#ff0000' : 'rgb(255, 0, 0)';
  assertEquals(expectedColor, caption.style.borderBottomColor);
}

function testDoesntCallGetCssClassInConstructor() {
  goog.testing.ui.rendererasserts.
      assertNoGetCssClassCallsInConstructor(goog.ui.ColorMenuButtonRenderer);
}
">4 of 4 tests run in 10ms.<br />1 passed, 3 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testEquality<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetCaptionValue<br />Object #<Object> has no method 'createElement'<br />ERROR in testWrapCaption<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>formpost_test.html</td><td>Fail</td><td> 1 passed, 1 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.dom.TagName');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.FormPost');
    goog.require('goog.userAgent');
    goog.require('goog.userAgent.product');
    goog.require('goog.userAgent.product.isVersion');
  

    var TARGET = 'target';
    var ACTION_URL = 'http://url/';
    var formPost;
    var parameters;
    var submits;
    var originalCreateDom = goog.ui.FormPost.prototype.createDom;

    function isChrome7or8() {
      // Temporarily disabled in Chrome 7 & 8. See b/3176768
      if (goog.userAgent.product.CHROME &&
          goog.userAgent.product.isVersion('7.0') &&
          !goog.userAgent.product.isVersion('8.0')) {
        return false;
      }

      return true;
    }

    function setUp() {
      formPost = new goog.ui.FormPost();
      submits = 0;

      // Replace the form's submit method with a fake.
      goog.ui.FormPost.prototype.createDom = function() {
        originalCreateDom.apply(this, arguments);

        this.getElement().submit = function() { submits++ };
      }
      parameters = {'foo': 'bar', 'baz': 'blah', 'array': ['no', 'yes']};
    }

    function tearDown() {
      formPost.dispose();
      goog.ui.FormPost.prototype.createDom = originalCreateDom;
    }

    function testPost() {
      formPost.post(parameters, ACTION_URL, TARGET);
      expectUrlAndParameters_(ACTION_URL, TARGET, parameters);
    }

    function testPostWithDefaults() {
      // Temporarily disabled in Chrome 7. See See b/3176768
      if (isChrome7or8) {
        return;
      }
      formPost = new goog.ui.FormPost();
      formPost.post(parameters);
      expectUrlAndParameters_('', '', parameters);
    }

    function expectUrlAndParameters_(url, target, parameters) {
      var form = formPost.getElement();
      assertEquals('element must be a form',
          goog.dom.TagName.FORM, form.tagName);
      assertEquals('form must be hidden', 'none', form.style.display);
      assertEquals('form method must be POST',
          'POST', form.method.toUpperCase());
      assertEquals('submits', 1, submits);
      assertEquals('action attribute', url, form.action);
      assertEquals('target attribute', target, form.target);
      var inputs = goog.dom.getElementsByTagNameAndClass(
          goog.dom.TagName.INPUT, null, form);
      var formValues = {};
      for (var i = 0, input = inputs[i]; input = inputs[i]; i++) {
        if (goog.isArray(formValues[input.name])) {
          formValues[input.name].push(input.value);
        } else if (input.name in formValues) {
          formValues[input.name] = [formValues[input.name], input.value];
        } else {
          formValues[input.name] = input.value;
        }
      }
      assertObjectEquals('form values must match', parameters, formValues);
    }

  ">2 of 2 tests run in 12ms.<br />1 passed, 1 failed.<br />6 ms/test. 1 files loaded.<br />ERROR in testPost<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>treecontrol_test.html</td><td>Fail</td><td> 0 passed, 2 failed.</td><td title="

  goog.require('goog.testing.jsunit');
  goog.require('goog.dom');
  goog.require('goog.events.KeyCodes');
  goog.require('goog.ui.tree.TreeControl');



function makeATree() {
  var tree = new goog.ui.tree.TreeControl('root');
  var testData = ['A', [
                  ['AA', [
                    ['AAA', []],
                    ['AAB', []]
                  ]],
                  ['AB', [
                    ['ABA', []],
                    ['ABB', []]
                  ]]
                ]];

  createTreeFromTestData(tree, testData, 3);
  tree.render(goog.dom.getElement('treeContainer'));
  return tree;
};

function createTreeFromTestData(node, data, maxLevels) {
  node.setHtml(data[0]);
  if (maxLevels < 0) {
    return;
  }

  var children = data[1];
  for (var i = 0; i < children.length; i++) {
    var child = children[i];
    var childNode = node.getTree().createNode('');
    node.add(childNode);
    createTreeFromTestData(childNode, child, maxLevels - 1);
  }
};

/**
 * Test moving a node to a greater depth.
 */
function testIndent() {
  var tree = makeATree();
  tree.expandAll();

  var node = tree.getChildren()[0].getChildren()[0];
  assertEquals(node.html_,'AAA');
  assertNotNull(node.getElement());
  assertEquals('19px', node.getRowElement().style.paddingLeft);

  assertEquals(2, node.getDepth());

  var newParent = node.getNextSibling();
  assertEquals('AAB', newParent.html_);
  assertEquals(2, newParent.getDepth());

  newParent.add(node);

  assertEquals(newParent, node.getParent());
  assertEquals(node, newParent.getChildren()[0]);
  assertEquals(3, node.getDepth());
  assertEquals('38px', node.getRowElement().style.paddingLeft);
};

/**
 * Test moving a node to a lesser depth.
 */
function testOutdent() {
  var tree = makeATree();
  tree.expandAll();

  var node = tree.getChildren()[0].getChildren()[0];
  assertEquals(node.html_,'AAA');
  assertNotNull(node.getElement());
  assertEquals('19px', node.getRowElement().style.paddingLeft);

  assertEquals(2, node.getDepth());

  var newParent = tree;
  assertEquals('A', newParent.html_);
  assertEquals(0, newParent.getDepth());

  newParent.add(node);

  assertEquals(newParent, node.getParent());
  assertEquals(node, newParent.getChildren()[2]);
  assertEquals(1, node.getDepth());
  assertEquals('0px', node.getRowElement().style.paddingLeft);
};

">2 of 2 tests run in 7ms.<br />0 passed, 2 failed.<br />4 ms/test. 1 files loaded.<br />ERROR in testIndent<br />Object #<Object> has no method 'setAttribute'<br />ERROR in testOutdent<br />Object #<Object> has no method 'setAttribute'<br /></td></tr>
<tr><td>typeahead_test.html</td><td>Fail</td><td> 0 passed, 3 failed.</td><td title="

  goog.require('goog.testing.jsunit');
  goog.require('goog.dom');
  goog.require('goog.events.KeyCodes');
  goog.require('goog.ui.tree.TreeControl');
  goog.require('goog.ui.tree.TypeAhead');



function makeATree() {
  var tree = new goog.ui.tree.TreeControl('root');
  var testData = ['level1',
      [['level2', [['eve', []], ['eve2', []]], []],
          ['level22', [['eve', []], ['eve3', []]], []]],
      []];

  createTreeFromTestData(tree, testData, 3);

  tree.createDom();
  goog.dom.getElement('treeContainer').appendChild(tree.getElement());
  tree.enterDocument();

  return tree;
};

function createTreeFromTestData(node, data, maxLevels) {
  node.setHtml(data[0]);
  if (maxLevels < 0) {
    return;
  }

  var children = data[1];
  for (var i = 0; i < children.length; i++) {
    var child = children[i];
    var childNode = node.getTree().createNode('');
    node.add(childNode);
    createTreeFromTestData(childNode, child, maxLevels - 1);
  }
};

/**
 * Test jumpToLabel_ functionality.
 */
function testJumpToLabel() {
  var tree = makeATree();
  var typeAhead = tree.typeAhead_;

  // Test the case when only one matching entry exists.
  var handled = typeAhead.jumpToLabel_('level1');
  var selectedItem = tree.getSelectedItem();
  assertTrue(handled && selectedItem.html_ == 'level1');

  // Test the case when more than one matching entry exists.
  handled = typeAhead.jumpToLabel_('eve');
  selectedItem = tree.getSelectedItem();
  assertTrue(handled && selectedItem.html_ == 'eve');

  // Test the case when the matching entry is at a deeper level.
  handled = typeAhead.jumpToLabel_('eve3');
  selectedItem = tree.getSelectedItem();
  assertTrue(handled && selectedItem.html_ == 'eve3');
};

/**
 * Test jumpTo_ functionality.
 */
function testJumpTo() {
  var tree = makeATree();
  var typeAhead = tree.typeAhead_;

  // Jump to the first matching 'eve', followed by Ctrl+DOWN to jump to
  // second matching 'eve'
  var handled = typeAhead.jumpToLabel_('eve') &&
                typeAhead.jumpTo_(goog.ui.tree.TypeAhead.Offset.DOWN);
  var selectedItem = tree.getSelectedItem();
  assertTrue(handled && selectedItem.html_ == 'eve');

  // Simulate a DOWN key on the tree, now the selection should be on 'eve3'
  var e = new Object();
  e.keyCode = goog.events.KeyCodes.DOWN;
  e.preventDefault = function() {};
  handled = tree.handleKeyEvent(e);
  selectedItem = tree.getSelectedItem();
  assertTrue(handled && selectedItem.html_ == 'eve3');
};


/**
 * Test handleTypeAheadChar functionality.
 */
function testHandleTypeAheadChar() {
  var tree = makeATree();
  var typeAhead = tree.typeAhead_;
  var e = new Object();

  // Period character('.'): keyCode = 190, charCode = 46
  // String.fromCharCode(190) = '3/4'  <-- incorrect
  // String.fromCharCode(46) = '.'  <-- correct
  e.keyCode = goog.events.KeyCodes.PERIOD;
  e.charCode = 46;
  e.preventDefault = function() {};
  typeAhead.handleTypeAheadChar(e);
  assertEquals('.', typeAhead.buffer_);

  // charCode not supplied.
  // This is expected to work only for alpha-num characters.
  e.keyCode = goog.events.KeyCodes.A;
  e.charCode = undefined;
  typeAhead.buffer_ = '';
  typeAhead.handleTypeAheadChar(e);
  assertEquals('a', typeAhead.buffer_);
}

">3 of 3 tests run in 9ms.<br />0 passed, 3 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testHandleTypeAheadChar<br />Object #<Object> has no method 'setAttribute'<br />ERROR in testJumpTo<br />Object #<Object> has no method 'setAttribute'<br />ERROR in testJumpToLabel<br />Object #<Object> has no method 'setAttribute'<br /></td></tr>
<tr><td>basenode_test.html</td><td>Fail</td><td> 1 passed, 8 failed.</td><td title="


goog.require('goog.dom');
goog.require('goog.dom.classes');
goog.require('goog.testing.jsunit');
goog.require('goog.ui.Component');
goog.require('goog.ui.tree.BaseNode');
goog.require('goog.ui.tree.BaseNode.EventType');
goog.require('goog.ui.tree.TreeControl');
goog.require('goog.ui.tree.TreeNode');




function testAdd() {
  var node1 = new goog.ui.tree.TreeNode('node1');
  var node2 = new goog.ui.tree.TreeNode('node2');
  var node3 = new goog.ui.tree.TreeNode('node3');
  var node4 = new goog.ui.tree.TreeNode('node4');

  assertEquals('node2 added', node2, node1.add(node2));
  assertEquals('node3 added', node3, node1.add(node3));
  assertEquals('node4 added', node4, node1.add(node4, node3));

  assertEquals('node1 has 3 children', 3, node1.getChildCount());
  assertEquals('first child', node2, node1.getChildAt(0));
  assertEquals('second child', node4, node1.getChildAt(1));
  assertEquals('third child', node3, node1.getChildAt(2));
  assertNull('node1 has no parent', node1.getParent());
  assertEquals('the parent of node2 is node1', node1, node2.getParent());

  assertEquals('node4 moved under node2', node4, node2.add(node4));
  assertEquals('node1 has 2 children', 2, node1.getChildCount());
  assertEquals('node2 has 1 child', 1, node2.getChildCount());
  assertEquals('the child of node2 is node4', node4, node2.getChildAt(0));
  assertEquals('the parent of node4 is node2', node2, node4.getParent());
}

function testExpandIconAfterAddChild() {
  var tree = new goog.ui.tree.TreeControl('root');
  var node1 = new goog.ui.tree.TreeNode('node1')
  var node2 = new goog.ui.tree.TreeNode('node2')
  tree.render(goog.dom.createDom('div'));
  tree.addChild(node1);

  node1.addChild(node2);
  assertTrue('expand icon of node1 changed to L+', goog.dom.classes.has(
      node1.getExpandIconElement(), 'goog-tree-expand-icon-lplus'));

  node1.removeChild(node2);
  assertFalse('expand icon of node1 changed back to L', goog.dom.classes.has(
      node1.getExpandIconElement(), 'goog-tree-expand-icon-lplus'));
}

function testExpandEvents() {
  var n = new goog.ui.tree.BaseNode('');
  n.getTree = function() {};
  var expanded = false;
  n.setExpanded(expanded);
  assertEquals(expanded, n.getExpanded());
  var callCount = 0;
  n.addEventListener(goog.ui.tree.BaseNode.EventType.BEFORE_EXPAND,
      function(e) {
        assertEquals(expanded, n.getExpanded());
        callCount++;
      });
  n.addEventListener(goog.ui.tree.BaseNode.EventType.EXPAND,
      function(e) {
        assertEquals(!expanded, n.getExpanded());
        callCount++;
      });
  n.setExpanded(!expanded);
  assertEquals(2, callCount);
}

function testExpandEvents2() {
  var n = new goog.ui.tree.BaseNode('');
  n.getTree = function() {};
  var expanded = true;
  n.setExpanded(expanded);
  assertEquals(expanded, n.getExpanded());
  var callCount = 0;
  n.addEventListener(goog.ui.tree.BaseNode.EventType.BEFORE_COLLAPSE,
      function(e) {
        assertEquals(expanded, n.getExpanded());
        callCount++;
      });
  n.addEventListener(goog.ui.tree.BaseNode.EventType.COLLAPSE,
      function(e) {
        assertEquals(!expanded, n.getExpanded());
        callCount++;
      });
  n.setExpanded(!expanded);
  assertEquals(2, callCount);
}

function testExpandEventsPreventDefault() {
  var n = new goog.ui.tree.BaseNode('');
  n.getTree = function() {};
  var expanded = true;
  n.setExpanded(expanded);
  assertEquals(expanded, n.getExpanded());
  var callCount = 0;
  n.addEventListener(goog.ui.tree.BaseNode.EventType.BEFORE_COLLAPSE,
      function(e) {
        assertEquals(expanded, n.getExpanded());
        e.preventDefault();
        callCount++;
      });
  n.addEventListener(goog.ui.tree.BaseNode.EventType.COLLAPSE,
      function(e) {
        fail('Should not fire COLLAPSE');
      });
  n.setExpanded(!expanded);
  assertEquals(1, callCount);
}

function testExpandEventsPreventDefault2() {
  var n = new goog.ui.tree.BaseNode('');
  n.getTree = function() {};
  var expanded = false;
  n.setExpanded(expanded);
  assertEquals(expanded, n.getExpanded());
  var callCount = 0;
  n.addEventListener(goog.ui.tree.BaseNode.EventType.BEFORE_EXPAND,
      function(e) {
        assertEquals(expanded, n.getExpanded());
        e.preventDefault();
        callCount++;
      });
  n.addEventListener(goog.ui.tree.BaseNode.EventType.EXPAND,
      function(e) {
        fail('Should not fire EXPAND');
      });
  n.setExpanded(!expanded);
  assertEquals(1, callCount);
}

function testGetNextShownNode() {
  var tree = new goog.ui.tree.TreeControl('tree');
  assertNull('next node for unpopulated tree', tree.getNextShownNode());

  var node1 = new goog.ui.tree.TreeNode('node1');
  var node2 = new goog.ui.tree.TreeNode('node2');
  var node3 = new goog.ui.tree.TreeNode('node3');
  node1.add(node2);
  node1.add(node3);

  assertNull('next node for unexpanded node1', node1.getNextShownNode());
  node1.expand();
  assertEquals('next node for expanded node1', node2, node1.getNextShownNode());
  assertEquals('next node for node2', node3, node2.getNextShownNode());
  assertNull('next node for node3', node3.getNextShownNode());

  tree.add(node1);
  assertEquals('next node for populated tree', node1, tree.getNextShownNode());
  assertNull('next node for node3 inside the tree', node3.getNextShownNode());

  var component = new goog.ui.Component();
  component.addChild(tree);
  assertNull('next node for node3 inside the tree if the tree has parent',
      node3.getNextShownNode());
}

function testInvisibleNodesInUnrenderedTree() {
  var tree = new goog.ui.tree.TreeControl('tree');
  var a = new goog.ui.tree.TreeNode('a');
  var b = new goog.ui.tree.TreeNode('b');
  tree.add(a);
  a.add(b);
  tree.render();
  // getTextContent uses \n separator in IE7, space in other browsers.
  assertEquals('invisible node not rendered', 'tree a',
      goog.dom.getTextContent(tree.getElement()).replace(/\s/g, ' '));
  a.expand();
  assertEquals('node is rendered after parent has been expanded', 'tree a b',
      goog.dom.getTextContent(tree.getElement()).replace(/\s/g, ' '));
  tree.dispose();
}

function testInvisibleNodesInRenderedTree() {
  var tree = new goog.ui.tree.TreeControl('tree');
  tree.render();
  var a = new goog.ui.tree.TreeNode('a');
  var b = new goog.ui.tree.TreeNode('b');
  tree.add(a);
  a.add(b);
  assertEquals('invisible node not rendered', 'tree a',
      goog.dom.getTextContent(tree.getElement()).replace(/\s/g, ' '));
  a.expand();
  assertEquals('node is rendered after parent has been expanded', 'tree a b',
      goog.dom.getTextContent(tree.getElement()).replace(/\s/g, ' '));
  tree.dispose();
}

">9 of 9 tests run in 17ms.<br />1 passed, 8 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testExpandEvents<br />unimplemented abstract method<br />ERROR in testExpandEvents2<br />unimplemented abstract method<br />ERROR in testExpandEventsPreventDefault<br />unimplemented abstract method<br />ERROR in testExpandEventsPreventDefault2<br />unimplemented abstract method<br />ERROR in testExpandIconAfterAddChild<br />Object #<Object> has no method 'setAttribute'<br />ERROR in testGetNextShownNode<br />Object #<Object> has no method 'setAttribute'<br />ERROR in testInvisibleNodesInRenderedTree<br />Object #<Object> has no method 'setAttribute'<br />ERROR in testInvisibleNodesInUnrenderedTree<br />Object #<Object> has no method 'setAttribute'<br /></td></tr>
<tr><td>serverchart_test.html</td><td>Success</td><td> 24 passed, 0 failed.</td><td title="

  goog.require('goog.ui.ServerChart');
  goog.require('goog.testing.jsunit');



function testHttpsBarChartRequest() {
  var bar = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.BAR, 
      180, 
      104,
      null,
      goog.ui.ServerChart.CHART_SERVER_HTTPS_URI);
  tryToCreateBarChart(bar);
  var uri = bar.getUri();
  var httpsUri = new goog.Uri(goog.ui.ServerChart.CHART_SERVER_HTTPS_URI);
  assertEquals('https', uri.getScheme());
  assertEquals(httpsUri.getDomain(), uri.getDomain());
}

function testMinValue() {
  var pie = new goog.ui.ServerChart(goog.ui.ServerChart.ChartType.PIE3D,
      180, 104);
  pie.addDataSet([1, 2, 3], '000000');
  assertEquals(pie.getMinValue(), 0);

  var line = new goog.ui.ServerChart(goog.ui.ServerChart.ChartType.LINE,
      180, 104);
  line.addDataSet([1, 2, 3], '000000');
  assertEquals(line.getMinValue(), 1);
}

function testSetParameterValue() {
  var scatter = new goog.ui.ServerChart(goog.ui.ServerChart.ChartType.SCATTER,
      180, 104);
  var key = goog.ui.ServerChart.UriParam.DATA_COLORS;
  var value = '000000,FF0000|00FF00|0000FF';
  scatter.setParameterValue(key, value);

  assertEquals('unexpected parameter value', value,
      scatter.getUri().getParameterValue(key));

  scatter.removeParameter(key);

  assertUndefined('parameter not removed',
      scatter.getUri().getParameterValue(key));
}

function testTypes() {
  var chart;

  chart = new goog.ui.ServerChart(goog.ui.ServerChart.ChartType.CONCENTRIC_PIE,
      180, 104);

  assertTrue(chart.isPieChart());
  assertFalse(chart.isBarChart());
  assertFalse(chart.isMap());
  assertFalse(chart.isLineChart());

  chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.HORIZONTAL_GROUPED_BAR, 180, 104);

  assertFalse(chart.isPieChart());
  assertTrue(chart.isBarChart());
  assertTrue(chart.isHorizontalBarChart());
  assertTrue(chart.isGroupedBarChart());
  assertFalse(chart.isVerticalBarChart());
  assertFalse(chart.isStackedBarChart());

  chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.BAR, 180, 104);
  assertTrue(chart.isBarChart());
  assertTrue(chart.isStackedBarChart());
  assertFalse(chart.isGroupedBarChart());

  chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.XYLINE, 180, 104);
  assertTrue('I thought lxy was a line chart', chart.isLineChart());
  assertFalse('lxy is definitely not a pie chart', chart.isPieChart());
}

function testBarChartRequest() {
  var bar = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.BAR, 180, 104);
  tryToCreateBarChart(bar);
  var httpUri = new goog.Uri(goog.ui.ServerChart.CHART_SERVER_URI);
  var uri = bar.getUri();
  assertEquals(httpUri.getDomain(), uri.getDomain());
}

function tryToCreateBarChart(bar) {
  bar.addDataSet([8,23,7], '008000');
  bar.addDataSet([31,11,7], 'ffcc33');
  bar.addDataSet([2,43,70,3,43,74], '3072f3');
  bar.setLeftLabels(['','20K','','60K','','100K']);
  bar.setXLabels(['O','N','D']);
  bar.setMaxValue(100);
  var uri = bar.getUri();
  assertEquals(
      'br',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.TYPE));
  assertEquals(
      '180x104',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.SIZE));
  assertEquals(
      'e:D6NtDQ,S7F4DQ,AAaxsZApaxvA',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.DATA));
  assertEquals(
      '008000,ffcc33,3072f3',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.DATA_COLORS));
  assertEquals(
      '100K||60K||20K|',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.LEFT_Y_LABELS));
  assertEquals(
      'O|N|D',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.X_LABELS));
}

function testClearDataSets() {
  var chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.BAR, 180, 104);
  tryToCreateBarChart(chart);
  var uriBefore = chart.getUri().toString();
  chart.clearDataSets();
  tryToCreateBarChart(chart);
  var uriAfter = chart.getUri().toString();
  assertEquals(uriBefore, uriAfter);
}

function testMultipleDatasetsTextEncoding() {
  var chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.BAR, 180, 104);
  chart.setEncodingType(goog.ui.ServerChart.EncodingType.TEXT);
  chart.addDataSet([0, 25, 100], '008000');
  chart.addDataSet([12, 2, 7.1], '112233');
  chart.addDataSet([82, 16, 2], '3072f3');
  var uri = chart.getUri();
  assertEquals(
    't:0,25,100|12,2,7.1|82,16,2',
    uri.getParameterValue(goog.ui.ServerChart.UriParam.DATA));
}

function testVennDiagramRequest() {
  var venn = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.VENN, 300,200);
  venn.setTitle('Google Employees');
  var weights = [80,  // Size of circle A
                 60,  // Size of circle B
                 40,  // Size of circle C
                 20,  // Overlap of A and B
                 20,  // Overlap of A and C
                 20,  // Overlap of B and C
                 5];  // Overlap of A, B and C
  var labels = [
      'C Hackers',      // Label for A
      'LISP Gurus',     // Label for B
      'Java Jockeys'];  // Label for C
  venn.setVennSeries(weights, labels);
  var uri = venn.getUri();
  var httpUri = new goog.Uri(goog.ui.ServerChart.CHART_SERVER_URI);
  assertEquals(httpUri.getDomain(), uri.getDomain());
  assertEquals(
      'v',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.TYPE));
  assertEquals(
      '300x200',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.SIZE));
  assertEquals(
      'e:..u7d3MzMzMzAA',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.DATA));
  assertEquals(
      'Google Employees',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.TITLE));
  assertEquals(
      labels.join('|'),
      uri.getParameterValue(goog.ui.ServerChart.UriParam.LEGEND_TEXTS));
}


function testSparklineChartRequest() {
  var chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.SPARKLINE, 300,200);
  chart.addDataSet([8,23,7], '008000');
  chart.addDataSet([31,11,7], 'ffcc33');
  chart.addDataSet([2,43,70,3,43,74], '3072f3');
  chart.setLeftLabels(['','20K','','60K','','100K']);
  chart.setXLabels(['O','N','D']);
  chart.setMaxValue(100);
  var uri = chart.getUri();
  assertEquals(
      'ls',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.TYPE));
  assertEquals(
      '300x200',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.SIZE));
  assertEquals(
      'e:D6NtDQ,S7F4DQ,AAaxsZApaxvA',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.DATA));
  assertEquals(
      '008000,ffcc33,3072f3',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.DATA_COLORS));
  assertEquals(
      '100K||60K||20K|',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.LEFT_Y_LABELS));
  assertEquals(
      'O|N|D',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.X_LABELS));
}

function testLegendPositionRequest() {
  var chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.SPARKLINE, 300,200);
  chart.addDataSet([0, 100], '008000', 'foo');
  chart.setLegendPosition(goog.ui.ServerChart.LegendPosition.TOP);
  assertEquals('t', chart.getLegendPosition());
  var uri = chart.getUri();
  assertEquals(
      't',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.LEGEND_POSITION));
}

function testSetGridParameter() {
  var gridArg = '20,20,4,4';
  var chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.SPARKLINE, 300,200);
  chart.addDataSet([0, 100], '008000', 'foo');
  chart.setGridParameter(gridArg);
  assertEquals(gridArg, chart.getGridParameter());
  var uri = chart.getUri();
  assertEquals(
      gridArg,
      uri.getParameterValue(goog.ui.ServerChart.UriParam.GRID));
}

function testSetMarkerParameter() {
  var markerArg = 's,FF0000,0,-1,5';
  var chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.SPARKLINE, 300,200);
  chart.addDataSet([0, 100], '008000', 'foo');
  chart.setMarkerParameter(markerArg);
  assertEquals(markerArg, chart.getMarkerParameter());
  var uri = chart.getUri();
  assertEquals(
      markerArg,
      uri.getParameterValue(goog.ui.ServerChart.UriParam.MARKERS));
}

function testNullDataPointRequest() {
  var chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.SPARKLINE, 300,200);
  chart.addDataSet([40, null, 10], '008000');
  assertEquals(10, chart.getMinValue());
  assertEquals(40, chart.getMaxValue());
  var uri = chart.getUri();
  assertEquals(
      'e:..__AA',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.DATA));

  chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.SPARKLINE, 300,200);
  chart.addDataSet([-5, null, -1], '008000');
  assertEquals(-5, chart.getMinValue());
  assertEquals(-1, chart.getMaxValue());
  uri = chart.getUri();
  assertEquals(
      'e:AA__..',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.DATA));
}

function testSetBarSpaceWidths() {
  var noSpaceBetweenBarsSpecified = '20';
  var noSpaceBetweenBarsChart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.VERTICAL_STACKED_BAR);
  noSpaceBetweenBarsChart.setBarSpaceWidths(20);
  var uri = noSpaceBetweenBarsChart.getUri();
  assertEquals(noSpaceBetweenBarsSpecified,
      uri.getParameterValue(goog.ui.ServerChart.UriParam.BAR_HEIGHT));

  var spaceBetweenBarsSpecified = '20,5';
  var spaceBetweenBarsChart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.HORIZONTAL_STACKED_BAR);
  spaceBetweenBarsChart.setBarSpaceWidths(20, 5);
  var uri = spaceBetweenBarsChart.getUri();
  assertEquals(spaceBetweenBarsSpecified,
      uri.getParameterValue(goog.ui.ServerChart.UriParam.BAR_HEIGHT));

  var spaceBetweenGroupsSpecified = '20,5,6';
  var spaceBetweenGroupsChart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.HORIZONTAL_STACKED_BAR);
  spaceBetweenGroupsChart.setBarSpaceWidths(20, 5, 6);
  var uri = spaceBetweenGroupsChart.getUri();
  assertEquals(spaceBetweenGroupsSpecified,
      uri.getParameterValue(goog.ui.ServerChart.UriParam.BAR_HEIGHT));

  var groupsButNotBarsSpecified = '20,6';
  var groupsButNotBarsChart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.HORIZONTAL_STACKED_BAR);
  groupsButNotBarsChart.setBarSpaceWidths(20, undefined, 6);
  var uri = groupsButNotBarsChart.getUri();
  assertEquals(groupsButNotBarsSpecified,
      uri.getParameterValue(goog.ui.ServerChart.UriParam.BAR_HEIGHT));
}

function testSetAutomaticBarWidth() {
  var noSpaceBetweenBarsSpecified = 'a';
  var noSpaceBetweenBarsChart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.VERTICAL_STACKED_BAR);
  noSpaceBetweenBarsChart.setAutomaticBarWidth();
  var uri = noSpaceBetweenBarsChart.getUri();
  assertEquals(noSpaceBetweenBarsSpecified,
      uri.getParameterValue(goog.ui.ServerChart.UriParam.BAR_HEIGHT));

  var spaceBetweenBarsSpecified = 'a,5';
  var spaceBetweenBarsChart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.HORIZONTAL_STACKED_BAR);
  spaceBetweenBarsChart.setAutomaticBarWidth(5);
  uri = spaceBetweenBarsChart.getUri();
  assertEquals(spaceBetweenBarsSpecified,
      uri.getParameterValue(goog.ui.ServerChart.UriParam.BAR_HEIGHT));

  var spaceBetweenGroupsSpecified = 'a,5,6';
  var spaceBetweenGroupsChart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.HORIZONTAL_STACKED_BAR);
  spaceBetweenGroupsChart.setAutomaticBarWidth(5, 6);
  uri = spaceBetweenGroupsChart.getUri();
  assertEquals(spaceBetweenGroupsSpecified,
      uri.getParameterValue(goog.ui.ServerChart.UriParam.BAR_HEIGHT));

  var groupsButNotBarsSpecified = 'a,6';
  var groupsButNotBarsChart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.HORIZONTAL_STACKED_BAR);
  groupsButNotBarsChart.setAutomaticBarWidth(undefined, 6);
  uri = groupsButNotBarsChart.getUri();
  assertEquals(groupsButNotBarsSpecified,
      uri.getParameterValue(goog.ui.ServerChart.UriParam.BAR_HEIGHT));
}

function testSetDataScaling() {
  var dataScalingArg = '0,160';
  var dataArg = 't:0,50,100,130';
  var chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.VERTICAL_STACKED_BAR, 300, 200);
  chart.addDataSet([0,50,100,130], '008000');
  chart.setDataScaling(0,160);
  var uri = chart.getUri();
  assertEquals(dataScalingArg,
      uri.getParameterValue(goog.ui.ServerChart.UriParam.DATA_SCALING));
  assertEquals(
      dataArg,
      uri.getParameterValue(goog.ui.ServerChart.UriParam.DATA));
}

function testSetMultiAxisLabelStyle() {
  var noFontSizeChart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.HORIZONTAL_STACKED_BAR, 300, 200);
  noFontSizeChart.addDataSet([0,50,100,130], '008000');
  var axisNumber = noFontSizeChart.addMultiAxis(
      goog.ui.ServerChart.MultiAxisType.LEFT_Y_AXIS);
  var noFontSizeArgs = axisNumber + ',009000';
  noFontSizeChart.setMultiAxisLabelStyle(axisNumber, '009000');
  var noFontSizeUri = noFontSizeChart.getUri();
  assertEquals(noFontSizeArgs,
      noFontSizeUri.getParameterValue(
          goog.ui.ServerChart.UriParam.MULTI_AXIS_STYLE));

  var noAlignChart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.HORIZONTAL_STACKED_BAR, 300, 200);
  noAlignChart.addDataSet([0,50,100,130], '008000');
  var xAxisNumber = noAlignChart.addMultiAxis(
      goog.ui.ServerChart.MultiAxisType.X_AXIS);
  var yAxisNumber = noAlignChart.addMultiAxis(
      goog.ui.ServerChart.MultiAxisType.LEFT_Y_AXIS);
  var noAlignArgs = xAxisNumber + ',009000,12|' + yAxisNumber + ',007000,14';
  noAlignChart.setMultiAxisLabelStyle(xAxisNumber, '009000', 12);
  noAlignChart.setMultiAxisLabelStyle(yAxisNumber, '007000', 14);
  var noAlignUri = noAlignChart.getUri();
  assertEquals(noAlignArgs,
      noAlignUri.getParameterValue(
          goog.ui.ServerChart.UriParam.MULTI_AXIS_STYLE));

  var noLineTicksChart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.HORIZONTAL_STACKED_BAR, 300, 200);
  noLineTicksChart.addDataSet([0,50,100,130], '008000');
  axisNumber = noLineTicksChart.addMultiAxis(
      goog.ui.ServerChart.MultiAxisType.LEFT_Y_AXIS);
  var noLineTicksArgs = axisNumber + ',009000,12,0';
  noLineTicksChart.setMultiAxisLabelStyle(axisNumber, '009000', 12,
      goog.ui.ServerChart.MultiAxisAlignment.ALIGN_CENTER);
  var noLineTicksUri = noLineTicksChart.getUri();
  assertEquals(noLineTicksArgs,
      noLineTicksUri.getParameterValue(
          goog.ui.ServerChart.UriParam.MULTI_AXIS_STYLE));


  var allParamsChart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.HORIZONTAL_STACKED_BAR, 300, 200);
  allParamsChart.addDataSet([0,50,100,130], '008000');
  axisNumber = allParamsChart.addMultiAxis(
      goog.ui.ServerChart.MultiAxisType.LEFT_Y_AXIS);
  var allParamsArgs = axisNumber + ',009000,12,0,lt';
  allParamsChart.setMultiAxisLabelStyle(axisNumber, '009000', 12,
      goog.ui.ServerChart.MultiAxisAlignment.ALIGN_CENTER,
      goog.ui.ServerChart.AxisDisplayType.LINE_AND_TICKS);
  var allParamsUri = allParamsChart.getUri();
  assertEquals(allParamsArgs,
      allParamsUri.getParameterValue(
          goog.ui.ServerChart.UriParam.MULTI_AXIS_STYLE));
}

function testSetBackgroundFill() {
  var chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.HORIZONTAL_STACKED_BAR, 300, 200);
  assertEquals(0, chart.getBackgroundFill().length);
  chart.setBackgroundFill([{color: '00ff00'}]);
  assertObjectEquals({
    area: 'bg',
    effect: 's',
    color: '00ff00'}, chart.getBackgroundFill()[0]);
  chart.setBackgroundFill([
      {color: '00ff00'},
      {area: 'c', color: '00ff00'}
  ]);
  assertObjectEquals({
    area: 'bg',
    effect: 's',
    color: '00ff00'}, chart.getBackgroundFill()[0]);
  assertObjectEquals({
    area: 'c',
    effect: 's',
    color: '00ff00'}, chart.getBackgroundFill()[1]);
  
  chart.setParameterValue(goog.ui.ServerChart.UriParam.BACKGROUND_FILL,
      'bg,s,00ff00|c,lg,45,ff00ff|bg,s,ff00ff');
  assertEquals(0, chart.getBackgroundFill().length);
}

function testSetMultiAxisRange() {
  var chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.HORIZONTAL_STACKED_BAR, 300, 200);
  var x = chart.addMultiAxis(goog.ui.ServerChart.MultiAxisType.X_AXIS);
  var top = chart.addMultiAxis(goog.ui.ServerChart.MultiAxisType.TOP_AXIS);
  chart.setMultiAxisRange(x, -500, 500, 100);
  chart.setMultiAxisRange(top, 0, 10);
  var range = chart.getMultiAxisRange();

  assertArrayEquals(range[x], [-500, 500, 100]);
  assertArrayEquals(range[top], [0, 10]);
}

function testGetConvertedValue() {
  var chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.VERTICAL_STACKED_BAR);

  assertThrows('No exception thrown when minValue > maxValue', function() {
    var result = chart.getConvertedValue_(
        90, 24, 3, goog.ui.ServerChart.EncodingType.SIMPLE);
  });

  assertEquals('_', chart.getConvertedValue_(90, 100, 101,
       goog.ui.ServerChart.EncodingType.SIMPLE));

  assertEquals('_', chart.getConvertedValue_(
      null, 0, 5, goog.ui.ServerChart.EncodingType.SIMPLE));
  assertEquals('__', chart.getConvertedValue_(
      null, 0, 150, goog.ui.ServerChart.EncodingType.EXTENDED));
  assertEquals('24', chart.getConvertedValue_(
      24, 1, 200, goog.ui.ServerChart.EncodingType.TEXT));
  assertEquals('H', chart.getConvertedValue_(
      24, 1, 200, goog.ui.ServerChart.EncodingType.SIMPLE));
  assertEquals('HZ', chart.getConvertedValue_(
      24, 1, 200, goog.ui.ServerChart.EncodingType.EXTENDED));

  // Out-of-range values should give a missing data point, not an empty string.
  assertEquals('__', chart.getConvertedValue_(
      0, 1, 200, goog.ui.ServerChart.EncodingType.EXTENDED));
  assertEquals('__', chart.getConvertedValue_(
      201, 1, 200, goog.ui.ServerChart.EncodingType.EXTENDED));
  assertEquals('_', chart.getConvertedValue_(
      0, 1, 200, goog.ui.ServerChart.EncodingType.SIMPLE));
  assertEquals('_', chart.getConvertedValue_(
      201, 1, 200, goog.ui.ServerChart.EncodingType.SIMPLE));
  assertEquals('_', chart.getConvertedValue_(
      0, 1, 200, goog.ui.ServerChart.EncodingType.TEXT));
  assertEquals('_', chart.getConvertedValue_(
      201, 1, 200, goog.ui.ServerChart.EncodingType.TEXT));
}

function testGetChartServerValues() {
  var chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.HORIZONTAL_STACKED_BAR);
  var values = [0, 1, 2, 56, 90, 120];
  var minValue = 0;
  var maxValue = 140;
  var expectedSimple = 'AABYn0';
  assertEquals(expectedSimple,
      chart.getChartServerValues_(values, minValue, maxValue));
  var expectedText = '0,1,2,56,90,120';
  assertEquals(expectedSimple,
      chart.getChartServerValues_(values, minValue, maxValue));
}

function testUriLengthLimit() {
  var chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.SPARKLINE, 300,200);
  var longUri = null;
  goog.events.listen(chart, goog.ui.ServerChart.Event.URI_TOO_LONG,
                     function(e) {longUri = e.uri;});
  assertEquals(goog.ui.ServerChart.EncodingType.AUTOMATIC,
      chart.getEncodingType());
  chart.addDataSet([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
      '008000');
  assertEquals(
      'e:AAHHOOVVccjjqqxx44..AAHHOOVVccjjqqxx44..',
      chart.getUri().getParameterValue(goog.ui.ServerChart.UriParam.DATA));
  chart.setUriLengthLimit(110);
  assertEquals(
      's:AHOUbipv29AHOUbipv29',
      chart.getUri().getParameterValue(goog.ui.ServerChart.UriParam.DATA));
  chart.setUriLengthLimit(90);
  assertEquals(null, longUri)
  chart.getUri();
  assertNotEquals(null, longUri);
}

function testVisibleDataSets() {
  var uri;

  var bar = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.BAR, 180, 104);
  bar.addDataSet([8,23,7], '008000');
  bar.addDataSet([31,11,7], 'ffcc33');
  bar.addDataSet([2,43,70,3,43,74], '3072f3');
  bar.setMaxValue(100);

  bar.setNumVisibleDataSets(0);
  uri = bar.getUri();
  assertEquals(
      'e0:D6NtDQ,S7F4DQ,AAaxsZApaxvA',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.DATA));

  bar.setNumVisibleDataSets(1);
  uri = bar.getUri();
  assertEquals(
      'e1:D6NtDQ,S7F4DQ,AAaxsZApaxvA',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.DATA));

  bar.setNumVisibleDataSets(2);
  uri = bar.getUri();
  assertEquals(
      'e2:D6NtDQ,S7F4DQ,AAaxsZApaxvA',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.DATA));

  bar.setNumVisibleDataSets(null);
  uri = bar.getUri();
  assertEquals(
      'e:D6NtDQ,S7F4DQ,AAaxsZApaxvA',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.DATA));
}

function testTitle() {
  var chart = new goog.ui.ServerChart(
      goog.ui.ServerChart.ChartType.BAR, 180, 104);
  assertEquals('Default title size', 13.5, chart.getTitleSize());
  assertEquals('Default title color', '333333', chart.getTitleColor());
  chart.setTitle('Test title');
  chart.setTitleSize(7);
  chart.setTitleColor('ff0000');
  var uri = chart.getUri();
  assertEquals(
      'Changing chart title failed',
      'Test title',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.TITLE));
  assertEquals(
      'Changing title size and color failed',
      'ff0000,7',
      uri.getParameterValue(goog.ui.ServerChart.UriParam.TITLE_FORMAT));
  assertEquals('New title size', 7, chart.getTitleSize());
  assertEquals('New title color', 'ff0000', chart.getTitleColor());
}
">n/a</td></tr>
<tr><td>tabrenderer_test.html</td><td>Fail</td><td> 5 passed, 4 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.dom.a11y.Role');
    goog.require('goog.dom.classes');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.Tab');
    goog.require('goog.ui.TabRenderer');
    goog.require('goog.testing.ui.rendererasserts');
  

    var sandbox = goog.dom.getElement('sandbox');
    var renderer = goog.ui.TabRenderer.getInstance();
    var tab;
  
    function setUp() {
      tab = new goog.ui.Tab('Hello');
    }
    
    function tearDown() {
      tab.dispose();
      goog.dom.removeChildren(sandbox);
    }

    function testConstructor() {
      assertNotNull('Renderer must not be null', renderer);
    }

    function testGetCssClass() {
      assertEquals('CSS class must have expected value',
          goog.ui.TabRenderer.CSS_CLASS, renderer.getCssClass());
    }

    function testGetAriaRole() {
      assertEquals('ARIA role must have expected value',
          goog.dom.a11y.Role.TAB, renderer.getAriaRole());
    }

    function testCreateDom() {
      var element = renderer.createDom(tab);
      assertNotNull('Element must not be null', element);
      assertHTMLEquals('DOM must have expected structure',
          '<div class="goog-tab">Hello</div>', goog.dom.getOuterHtml(element));
    }

    function testCreateDomWithTooltip() {
      tab.setTooltip('Hello, world!');
      var element = renderer.createDom(tab);
      assertNotNull('Element must not be null', element);
      assertEquals('Element must have expected tooltip', 'Hello, world!',
          renderer.getTooltip(element));
    }

    function testDecorate() {
      sandbox.innerHTML =
          '<div id="foo">Foo</div>\n' +
          '<div id="bar" title="Yes">Bar</div>';

      var foo = renderer.decorate(tab, goog.dom.getElement('foo'));
      assertNotNull('Decorated element must not be null', foo);
      assertSameElements('Decorated element must have expected class',
          ['goog-tab'], goog.dom.classes.get(foo));
      assertEquals('Decorated tab must have expected content', 'Foo',
          tab.getContent().nodeValue);
      assertUndefined('Decorated tab must not have tooltip', tab.getTooltip());
      assertEquals('Decorated element must not have title', '',
          renderer.getTooltip(foo));

      var bar = renderer.decorate(tab, goog.dom.getElement('bar'));
      assertNotNull('Decorated element must not be null', bar);
      assertSameElements('Decorated element must have expected class',
          ['goog-tab'], goog.dom.classes.get(bar));
      assertEquals('Decorated tab must have expected content', 'Bar',
          tab.getContent().nodeValue);
      assertEquals('Decorated tab must have expected tooltip', 'Yes',
          tab.getTooltip());
      assertEquals('Decorated element must have expected title', 'Yes',
          renderer.getTooltip(bar));
    }

    function testGetTooltip() {
      sandbox.innerHTML =
          '<div id="foo">Foo</div>\n' +
          '<div id="bar" title="">Bar</div>\n' +
          '<div id="baz" title="BazTitle">Baz</div>';
      assertEquals('getTooltip() must return empty string for no title', '',
          renderer.getTooltip(goog.dom.getElement('foo')));
      assertEquals('getTooltip() must return empty string for empty title', '',
          renderer.getTooltip(goog.dom.getElement('bar')));
      assertEquals('Tooltip must have expected value', 'BazTitle',
          renderer.getTooltip(goog.dom.getElement('baz')));
    }

    function testSetTooltip() {
      sandbox.innerHTML = '<div id="foo">Foo</div>';
      var element = goog.dom.getElement('foo');

      renderer.setTooltip(null, null); // Must not error.

      renderer.setTooltip(element, null);
      assertEquals('Tooltip must be the empty string', '', element.title);

      renderer.setTooltip(element, '');
      assertEquals('Tooltip must be the empty string', '', element.title);

      renderer.setTooltip(element, 'Foo');
      assertEquals('Tooltip must have expected value', 'Foo', element.title);
    }

    function testDoesntCallGetCssClassInConstructor() {
      goog.testing.ui.rendererasserts.
          assertNoGetCssClassCallsInConstructor(goog.ui.TabRenderer);
    }
  ">9 of 9 tests run in 17ms.<br />5 passed, 4 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testCreateDom<br />Object #<Object> has no method 'createElement'<br />ERROR in testCreateDomWithTooltip<br />Object #<Object> has no method 'createElement'<br />ERROR in testDecorate<br />Cannot read property 'nodeValue' of null<br />ERROR in testGetTooltip<br />Tooltip must have expected value<br />Expected <BazTitle> (String) but was <> (String)<br />> assertEquals at testing/asserts.js:289:3<br />> testGetTooltip at _tmpclosuretest.js:90:7<br /></td></tr>
<tr><td>tabpane_test.html</td><td>Fail</td><td> 0 passed, 2 failed.</td><td title="

  goog.require('goog.ui.TabPane');
  goog.require('goog.dom');
  goog.require('goog.events');
  goog.require('goog.testing.jsunit');



  var tabPane;
  var page1;
  var page2;
  var page3;

  function setUp() {
    goog.dom.getElement('testBody').innerHTML =
       "<div id='tabpane'></div>"
       "<div id='page1Content'>"
       "  Content for page 1"
       "</div>"
       "<div id='page2Content'>"
       "  Content for page 2"
       "</div>"
       "<div id='page3Content'>"
       "  Content for page 3"
       "</div>";

    tabPane = new goog.ui.TabPane(goog.dom.getElement('tabpane'));
    page1 = new goog.ui.TabPane.TabPage(goog.dom.getElement('page1Content'),
        'page1');
    page2 = new goog.ui.TabPane.TabPage(goog.dom.getElement('page2Content'),
        'page2');
    page3 = new goog.ui.TabPane.TabPage(goog.dom.getElement('page3Content'),
        'page3');

    tabPane.addPage(page1);
    tabPane.addPage(page2);
    tabPane.addPage(page3);
  }

  function tearDown() {
    tabPane.dispose();
  }

  function testAllPagesEnabledAndSelectable() {
    tabPane.setSelectedIndex(0);
    var selected = tabPane.getSelectedPage();
    assertEquals('page1 should be selected', 'page1', selected.getTitle());
    assertEquals('goog-tabpane-tab-selected',
                 selected.getTitleElement().className);

    tabPane.setSelectedIndex(1);
    selected = tabPane.getSelectedPage();
    assertEquals('page2 should be selected', 'page2', selected.getTitle());
    assertEquals('goog-tabpane-tab-selected',
                 selected.getTitleElement().className);

    tabPane.setSelectedIndex(2);
    selected = tabPane.getSelectedPage();
    assertEquals('page3 should be selected', 'page3', selected.getTitle());
    assertEquals('goog-tabpane-tab-selected',
                 selected.getTitleElement().className);
  }

  function testDisabledPageIsNotSelectable() {
    page2.setEnabled(false);
    assertEquals('goog-tabpane-tab-disabled',
                 page2.getTitleElement().className);

    tabPane.setSelectedIndex(0);
    var selected = tabPane.getSelectedPage();
    assertEquals('page1 should be selected', 'page1', selected.getTitle());
    assertEquals('goog-tabpane-tab-selected',
                 selected.getTitleElement().className);

    tabPane.setSelectedIndex(1);
    selected = tabPane.getSelectedPage();
    assertEquals('page1 should remain selected, as page2 is disabled',
                 'page1', selected.getTitle());
    assertEquals('goog-tabpane-tab-selected',
                 selected.getTitleElement().className);

    tabPane.setSelectedIndex(2);
    selected = tabPane.getSelectedPage();
    assertEquals('page3 should be selected', 'page3', selected.getTitle());
    assertEquals('goog-tabpane-tab-selected',
                 selected.getTitleElement().className);
  }
">2 of 2 tests run in 6ms.<br />0 passed, 2 failed.<br />3 ms/test. 1 files loaded.<br />ERROR in testAllPagesEnabledAndSelectable<br />Object #<Object> has no method 'createElement'<br />ERROR in testDisabledPageIsNotSelectable<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>customcolorpalette_test.html</td><td>Fail</td><td> 0 passed, 2 failed.</td><td title="


    goog.require('goog.dom.TagName');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.CustomColorPalette');
  

    var samplePalette;

    function setUp() {
      samplePalette = new goog.ui.CustomColorPalette();
    }

    function tearDown() {
      samplePalette.dispose();
      document.getElementById('sandbox').innerHTML = '';
    }

    function testRender() {
      samplePalette.render(document.getElementById('sandbox'));

      assertTrue('Palette must have been rendered',
                 samplePalette.isInDocument());

      var elem = samplePalette.getElement();
      assertNotNull('The palette element should not be null', elem);
      assertEquals('The palette element should have the right tag name',
                   goog.dom.TagName.DIV, elem.tagName);

      assertTrue('The custom color palette should have the right class name',
                 goog.dom.classes.has(elem, 'goog-palette'));
    }

    function testSetColors() {
      var colorSet = ['#e06666', '#f6b26b', '#ffd966', '#93c47d', '#76a5af',
          '#6fa8dc', '#8e7cc3'];
      samplePalette.setColors(colorSet);
      assertSameElements('The palette should have the correct set of colors',
                         colorSet, samplePalette.getColors());
    }
  ">2 of 2 tests run in 10ms.<br />0 passed, 2 failed.<br />5 ms/test. 1 files loaded.<br />ERROR in testRender<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetColors<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>rangemodel_test.html</td><td>Success</td><td> 6 passed, 0 failed.</td><td title="

  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.RangeModel');



  function reset(rm, step) {
    rm.setStep(step || 1);
    rm.setExtent(0);
    rm.setMinimum(0);
    rm.setMaximum(100);
    rm.setValue(0);
  }

  function getDescriptiveString(rm) {
    return rm.getMinimum() + ' < ' + rm.getValue() + '[' + rm.getExtent() +
        '] < ' + rm.getMaximum();
  }

  function testValue() {
    var rm = new goog.ui.RangeModel;

    assertEquals(0, rm.getValue());
    rm.setValue(50);
    assertEquals(50, rm.getValue());

    // setting smaller than min should keep min
    rm.setValue(-1);
    assertEquals(0, rm.getValue());

    // setting larger than max should keep max - extent
    rm.setValue(101);
    assertEquals(100, rm.getValue());
    rm.setValue(0);
    rm.setExtent(10);
    rm.setValue(100);
    assertEquals(90, rm.getValue());

    ////////////////
    // Change step
    reset(rm, 3);

    assertEquals(0, rm.getValue());
    rm.setValue(50);
    assertEquals(51, rm.getValue());

    // setting smaller than min should keep min
    rm.setValue(-1);
    assertEquals(0, rm.getValue());

    // setting larger than max should keep max - extent
    rm.setValue(101);
    assertEquals(99, rm.getValue());
    rm.setValue(0);
    rm.setExtent(10);
    rm.setValue(100);
    assertEquals(90, rm.getValue());

  }

  function testMinium() {
    var rm = new goog.ui.RangeModel;

    rm.setValue(50);
    rm.setMinimum(10);
    assertEquals(10, rm.getMinimum());

    reset(rm);

    // setting larger than value should change value
    rm.setMinimum(10);
    assertEquals(10, rm.getMinimum());
    assertEquals(10, rm.getValue());

    // setting larger than max should set max = min
    rm.setMinimum(200);
    assertEquals(200, rm.getMinimum());
    assertEquals(200, rm.getValue());
    assertEquals(200, rm.getMaximum());
    assertEquals(0, rm.getExtent());

    reset(rm);

    // should change extent
    rm.setExtent(10);
    rm.setMinimum(95);
    assertEquals(95, rm.getMinimum());
    assertEquals(95, rm.getValue());
    assertEquals(100, rm.getMaximum());
    assertEquals(5, rm.getExtent());

    ////////////////
    // Change step
    reset(rm, 3);

    rm.setValue(50);
    rm.setMinimum(10);
    assertEquals(10, rm.getMinimum());

    reset(rm, 3);

    // setting larger than value should change value
    rm.setMinimum(10);
    assertEquals(10, rm.getMinimum());
    assertEquals(10, rm.getValue());

    // setting larger than max should set max = min
    rm.setMinimum(200);
    assertEquals(200, rm.getMinimum());
    assertEquals(200, rm.getValue());
    assertEquals(200, rm.getMaximum());
    assertEquals(0, rm.getExtent());

    reset(rm, 3);

    // should change extent
    rm.setExtent(10); // 0 < 0[9] < 99
    rm.setMinimum(95); // 95 < 95[3] < 98
    assertEquals(95, rm.getMinimum());
    assertEquals(95, rm.getValue());
    assertEquals(98, rm.getMaximum());
    assertEquals(3, rm.getExtent());
  }

  function testMaximum() {
    var rm = new goog.ui.RangeModel;

    rm.setMaximum(50);
    assertEquals(50, rm.getMaximum());

    reset(rm);

    // setting to smaller than minimum should change minimum, value and extent
    rm.setValue(5);
    rm.setExtent(10);
    rm.setMinimum(50);
    rm.setMaximum(40);
    assertEquals(40, rm.getMaximum());
    assertEquals(0, rm.getExtent());
    assertEquals(40, rm.getValue());
    assertEquals(40, rm.getMinimum());

    reset(rm);

    // setting smaller than value should change value to max - extent
    rm.setExtent(10);
    rm.setValue(50);
    rm.setMaximum(40);
    assertEquals(40, rm.getMaximum());
    assertEquals(30, rm.getValue());

    reset(rm);

    // should change value, and keep extent constant,
    // unless extent is > max - min.
    rm.setExtent(10);
    rm.setValue(90);
    rm.setMaximum(95);
    assertEquals(95, rm.getMaximum());
    assertEquals(10, rm.getExtent());
    assertEquals(85, rm.getValue());

    ////////////////
    // Change step
    reset(rm, 3);

    rm.setMaximum(50); // 0 < 0[0] < 51
    assertEquals(51, rm.getMaximum());

    reset(rm, 3);

    // setting to smaller than minimum should change minimum, value and extent
    rm.setValue(5); // 0 < 6[0] < 99
    rm.setExtent(10); // 0 < 6[9] < 99
    rm.setMinimum(50); // 50 < 50[9] < 98
    rm.setMaximum(40); // 41 < 41[0] < 41
    assertEquals(41, rm.getMaximum());
    assertEquals(0, rm.getExtent());
    assertEquals(41, rm.getValue());
    assertEquals(41, rm.getMinimum());

    reset(rm, 3);

    // setting smaller than value should change value to max - extent
    rm.setExtent(10); // 0 < 0[9] < 99
    rm.setValue(50); // 0 < 51[9] < 99
    rm.setMaximum(40); // 0 < 30[9] < 39
    assertEquals(39, rm.getMaximum());
    assertEquals(30, rm.getValue());

    reset(rm, 3);

    // should change value, and keep extent constant,
    // unless extent is > max - min.
    rm.setExtent(10); // 0 < 0[9] < 99
    rm.setValue(90); // 0 < 90[9] < 99
    rm.setMaximum(95); // 0 < 90[6] < 96
    assertEquals(96, rm.getMaximum());
    assertEquals(87, rm.getValue());
    assertEquals(9, rm.getExtent());
  }

  function testExtent() {
    var rm = new goog.ui.RangeModel;

    rm.setExtent(10);
    assertEquals(10, rm.getExtent());

    rm.setExtent(-10);
    assertEquals(0, rm.getExtent());

    rm.setValue(50);
    rm.setExtent(100);
    assertEquals(50, rm.getExtent());
    assertEquals(50, rm.getValue());

    ////////////////
    // Change step
    reset(rm, 3);

    rm.setExtent(10); // 0 < 0[9] < 99
    assertEquals(9, rm.getExtent());

    rm.setExtent(-10);
    assertEquals(0, rm.getExtent());

    rm.setValue(50);  // 0 < 51[9] < 99
    rm.setExtent(100); // 0 < 51[48] < 99
    assertEquals(48, rm.getExtent());
    assertEquals(51, rm.getValue());
  }

  function testRoundToStep() {
    var rm = new goog.ui.RangeModel;
    rm.setStep(0.5);

    assertEquals(1, rm.roundToStep(1));
    assertEquals(0.5, rm.roundToStep(0.5));
    assertEquals(1, rm.roundToStep(0.75));
    assertEquals(0.5, rm.roundToStep(0.74));
  }

  function testRoundToStepWithMin() {
    var rm = new goog.ui.RangeModel;
    rm.setStep(0.5);
    rm.setMinimum(0.25);

    assertEquals(1.25, rm.roundToStepWithMin(1));
    assertEquals(0.75, rm.roundToStepWithMin(0.5));
    assertEquals(0.75, rm.roundToStepWithMin(0.75));
    assertEquals(0.75, rm.roundToStepWithMin(0.74));
  }

">n/a</td></tr>
<tr><td>colorpalette_test.html</td><td>Fail</td><td> 0 passed, 7 failed.</td><td title="

    goog.require('goog.color');
    goog.require('goog.events');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.ColorPalette');
  

    var emptyPalette, samplePalette;

    function setUp() {
      emptyPalette = new goog.ui.ColorPalette();
      samplePalette = new goog.ui.ColorPalette([
        'red', '#00FF00', 'rgb(0, 0, 255)'
      ]);
      samplePalette.setSelectedColor('blue');
    }

    function tearDown() {
      emptyPalette.dispose();
      samplePalette.dispose();
      document.getElementById('sandbox').innerHTML = '';
    }

    function testEmptyColorPalette() {
      var colors = emptyPalette.getColors();
      assertNotNull(colors);
      assertEquals(0, colors.length);

      var nodes = emptyPalette.getContent();
      assertNotNull(nodes);
      assertEquals(0, nodes.length);
    }

    function testSampleColorPalette() {
      var colors = samplePalette.getColors();
      assertNotNull(colors);
      assertEquals(3, colors.length);
      assertEquals('red', colors[0]);
      assertEquals('#00FF00', colors[1]);
      assertEquals('rgb(0, 0, 255)', colors[2]);

      var nodes = samplePalette.getContent();
      assertNotNull(nodes);
      assertEquals(3, nodes.length);
      assertEquals('goog-palette-colorswatch', nodes[0].className);
      assertEquals('goog-palette-colorswatch', nodes[1].className);
      assertEquals('goog-palette-colorswatch', nodes[2].className);
      assertEquals('#ff0000',
          goog.color.parse(nodes[0].style.backgroundColor).hex);
      assertEquals('#00ff00',
          goog.color.parse(nodes[1].style.backgroundColor).hex);
      assertEquals('#0000ff',
          goog.color.parse(nodes[2].style.backgroundColor).hex);
    }

    function testGetColors() {
      var emptyColors = emptyPalette.getColors();
      assertNotNull(emptyColors);
      assertEquals(0, emptyColors.length);

      var sampleColors = samplePalette.getColors();
      assertNotNull(sampleColors);
      assertEquals(3, sampleColors.length);
      assertEquals('red', sampleColors[0]);
      assertEquals('#00FF00', sampleColors[1]);
      assertEquals('rgb(0, 0, 255)', sampleColors[2]);
    }

    function testSetColors() {
      emptyPalette.setColors(['black', '#FFFFFF']);

      var colors = emptyPalette.getColors();
      assertNotNull(colors);
      assertEquals(2, colors.length);
      assertEquals('black', colors[0]);
      assertEquals('#FFFFFF', colors[1]);

      var nodes = emptyPalette.getContent();
      assertNotNull(nodes);
      assertEquals(2, nodes.length);
      assertEquals('goog-palette-colorswatch', nodes[0].className);
      assertEquals('goog-palette-colorswatch', nodes[1].className);
      assertEquals('#000000',
          goog.color.parse(nodes[0].style.backgroundColor).hex);
      assertEquals('#ffffff',
          goog.color.parse(nodes[1].style.backgroundColor).hex);
      assertEquals('black', nodes[0].title);
      assertEquals('RGB (255, 255, 255)', nodes[1].title);

      samplePalette.setColors(['#336699', 'cyan']);

      var newColors = samplePalette.getColors();
      assertNotNull(newColors);
      assertEquals(2, newColors.length);
      assertEquals('#336699', newColors[0]);
      assertEquals('cyan', newColors[1]);

      var newNodes = samplePalette.getContent();
      assertNotNull(newNodes);
      assertEquals(2, newNodes.length);
      assertEquals('goog-palette-colorswatch', newNodes[0].className);
      assertEquals('goog-palette-colorswatch', newNodes[1].className);
      assertEquals('#336699',
          goog.color.parse(newNodes[0].style.backgroundColor).hex);
      assertEquals('#00ffff',
          goog.color.parse(newNodes[1].style.backgroundColor).hex);
    }

    function testRender() {
      samplePalette.render(document.getElementById('sandbox'));

      assertTrue(samplePalette.isInDocument());

      var elem = samplePalette.getElement();
      assertNotNull(elem);
      assertEquals('DIV', elem.tagName);
      assertEquals('goog-palette', elem.className);

      var table = elem.firstChild;
      assertEquals('TABLE', table.tagName);
      assertEquals('goog-palette-table', table.className);

      // TODO(user):  Each ColorPalette creates 12 listeners (13 on IE)!
      assertEquals(goog.userAgent.IE ? 13 : 12,
          goog.events.getTotalListenerCount());
    }

    function testGetSelectedColor() {
      assertNull(emptyPalette.getSelectedColor());
      assertEquals('#0000ff', samplePalette.getSelectedColor());
    }

    function testSetSelectedColor() {
      emptyPalette.setSelectedColor('red');
      assertNull(emptyPalette.getSelectedColor());

      samplePalette.setSelectedColor('red');
      assertEquals('#ff0000', samplePalette.getSelectedColor());
      samplePalette.setSelectedColor(17); // Invalid color spec.
      assertNull(samplePalette.getSelectedColor());

      samplePalette.setSelectedColor('rgb(0, 255, 0)');
      assertEquals('#00ff00', samplePalette.getSelectedColor());
      samplePalette.setSelectedColor(false); // Invalid color spec.
      assertNull(samplePalette.getSelectedColor());

      samplePalette.setSelectedColor('#0000FF');
      assertEquals('#0000ff', samplePalette.getSelectedColor());
      samplePalette.setSelectedColor(null); // Invalid color spec.
      assertNull(samplePalette.getSelectedColor());
    }
  ">7 of 7 tests run in 17ms.<br />0 passed, 7 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testEmptyColorPalette<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetColors<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetSelectedColor<br />Object #<Object> has no method 'createElement'<br />ERROR in testRender<br />Object #<Object> has no method 'createElement'<br />ERROR in testSampleColorPalette<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetColors<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetSelectedColor<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>keyboardshortcuthandler_test.html</td><td>Fail</td><td> 0 passed, 34 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.testing.MockClock');
    goog.require('goog.testing.PropertyReplacer');
    goog.require('goog.testing.StrictMock');
    goog.require('goog.testing.events');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.KeyboardShortcutHandler');
  

    var Modifiers = goog.ui.KeyboardShortcutHandler.Modifiers;
    var KeyCodes = goog.events.KeyCodes;

    var handler;
    var targetDiv;
    var listener;
    var mockClock;
    var stubs = new goog.testing.PropertyReplacer();

    /**
     * Fires a keypress on the target div.
     * @return {boolean} The returnValue of the sequence: false if
     *     preventDefault() was called on any of the events, true otherwise.
     */
    function fire(keycode, opt_extraProperties, opt_element) {
      return goog.testing.events.fireKeySequence(
          opt_element || targetDiv, keycode, opt_extraProperties);
    }

    function fireAltGraphKey(keycode, keyPressKeyCode, opt_extraProperties,
                             opt_element) {
      return goog.testing.events.fireNonAsciiKeySequence(
          opt_element || targetDiv, keycode, keyPressKeyCode,
          opt_extraProperties);
    }

    function setUp() {
      targetDiv = goog.dom.getElement('targetDiv');
      handler = new goog.ui.KeyboardShortcutHandler(
          goog.dom.getElement('rootDiv'));

      // Create a mock event listener in order to set expectations on what
      // events are fired.  We create a fake class whose only method is
      // shortcutFired(shortcut identifier).
      listener = new goog.testing.StrictMock(
          {shortcutFired: goog.nullFunction});
      goog.events.listen(
          handler,
          goog.ui.KeyboardShortcutHandler.EventType.SHORTCUT_TRIGGERED,
          function (event) { listener.shortcutFired(event.identifier); });

       // Set up a fake clock, because keyboard shortcuts *are* time
       // sensitive.
       mockClock = new goog.testing.MockClock(true);
    }

    function tearDown() {
      mockClock.uninstall();
      handler.dispose();
      stubs.reset();
    }

    function testAllowsSingleLetterKeyBindingsSpecifiedAsString() {
      listener.shortcutFired('lettergee');
      listener.$replay();

      handler.registerShortcut('lettergee', 'g');
      fire(KeyCodes.G);

      listener.$verify()
    }

    function testAllowsSingleLetterKeyBindingsSpecifiedAsKeyCode() {
      listener.shortcutFired('lettergee');
      listener.$replay();

      handler.registerShortcut('lettergee', KeyCodes.G);
      fire(KeyCodes.G);

      listener.$verify()
    }

    function testDoesntFireWhenWrongKeyIsPressed() {
      listener.$replay(); // no events expected

      handler.registerShortcut('letterjay', 'j');
      fire(KeyCodes.G);

      listener.$verify()
    }

    function testAllowsControlAndLetterSpecifiedAsAString() {
      listener.shortcutFired('lettergee');
      listener.$replay();

      handler.registerShortcut('lettergee', 'ctrl+g');
      fire(KeyCodes.G, {ctrlKey: true});

      listener.$verify()
    }

    function testAllowsControlAndLetterSpecifiedAsArgSequence() {
      listener.shortcutFired('lettergeectrl');
      listener.$replay();

      handler.registerShortcut('lettergeectrl',
          KeyCodes.G, Modifiers.CTRL);
      fire(KeyCodes.G, {ctrlKey: true});

      listener.$verify()
    }

    function testAllowsControlAndLetterSpecifiedAsArray() {
      listener.shortcutFired('lettergeectrl');
      listener.$replay();

      handler.registerShortcut('lettergeectrl',
          [KeyCodes.G, Modifiers.CTRL]);
      fire(KeyCodes.G, {ctrlKey: true});

      listener.$verify()
    }

    function testAllowsShift() {
      listener.shortcutFired('lettergeeshift');
      listener.$replay();

      handler.registerShortcut('lettergeeshift',
          [KeyCodes.G, Modifiers.SHIFT]);
      fire(KeyCodes.G, {shiftKey: true});

      listener.$verify()
    }

    function testAllowsAlt() {
      listener.shortcutFired('lettergeealt');
      listener.$replay();

      handler.registerShortcut('lettergeealt',
          [KeyCodes.G, Modifiers.ALT]);
      fire(KeyCodes.G, {altKey: true});

      listener.$verify()
    }

    function testAllowsMeta() {
      listener.shortcutFired('lettergeemeta');
      listener.$replay();

      handler.registerShortcut('lettergeemeta',
          [KeyCodes.G, Modifiers.META]);
      fire(KeyCodes.G, {metaKey: true});

      listener.$verify()
    }

    function testAllowsMultipleModifiers() {
      listener.shortcutFired('lettergeectrlaltshift');
      listener.$replay();

      handler.registerShortcut('lettergeectrlaltshift',
          KeyCodes.G, Modifiers.CTRL | Modifiers.ALT | Modifiers.SHIFT);
      fire(KeyCodes.G, {ctrlKey: true, altKey: true, shiftKey: true});

      listener.$verify()
    }

    function testAllowsMultipleModifiersSpecifiedAsString() {
      listener.shortcutFired('lettergeectrlaltshiftmeta');
      listener.$replay();

      handler.registerShortcut('lettergeectrlaltshiftmeta',
          'ctrl+shift+alt+meta+g');
      fire(KeyCodes.G,
          {ctrlKey: true, altKey: true, shiftKey: true, metaKey: true});

      listener.$verify()
    }

    function testPreventsDefaultOnReturnFalse() {
      listener.shortcutFired('x');
      listener.$replay();

      handler.registerShortcut('x', 'x');
      var key = goog.events.listen(handler,
          goog.ui.KeyboardShortcutHandler.EventType.SHORTCUT_TRIGGERED,
          function (event) { return false });

      assertFalse('return false in listener must prevent default',
                  fire(KeyCodes.X));

      listener.$verify();

      goog.events.unlistenByKey(key);
    }

    function testPreventsDefaultWhenExceptionThrown() {
      handler.registerShortcut('x', 'x');
      handler.setAlwaysPreventDefault(true);
      goog.events.listenOnce(handler,
          goog.ui.KeyboardShortcutHandler.EventType.SHORTCUT_TRIGGERED,
          function (event) { throw new Error('x'); });

      // We can't use the standard infrastructure to detect that
      // the event was preventDefaulted, because of the exception.
      var callCount = 0;
      stubs.set(goog.events.BrowserEvent.prototype, 'preventDefault',
          function() {
        callCount++;
      });

      var e = assertThrows(goog.partial(fire, KeyCodes.X));
      assertEquals('x', e.message);

      assertEquals(1, callCount);
    }

    function testDoesntFireWhenUserForgetsRequiredModifier() {
      listener.$replay(); // no events expected

      handler.registerShortcut('lettergeectrl',
          KeyCodes.G, Modifiers.CTRL);
      fire(KeyCodes.G);

      listener.$verify()
    }

    function testDoesntFireIfTooManyModifiersPressed() {
      listener.$replay(); // no events expected

      handler.registerShortcut('lettergeectrl',
          KeyCodes.G, Modifiers.CTRL);
      fire(KeyCodes.G, {ctrlKey: true, metaKey: true});

      listener.$verify()
    }

    function testDoesntFireIfAnyRequiredModifierForgotten() {
      listener.$replay(); // no events expected

      handler.registerShortcut('lettergeectrlaltshift',
          KeyCodes.G, Modifiers.CTRL | Modifiers.ALT | Modifiers.SHIFT);
      fire(KeyCodes.G, {altKey: true, shiftKey: true});

      listener.$verify()
    }

    function testAllowsMultiKeySequenceSpecifiedAsArray() {
      listener.shortcutFired('quitemacs');
      listener.$replay();

      handler.registerShortcut('quitemacs',
          [KeyCodes.X, Modifiers.CTRL,
           KeyCodes.C]);
      fire(KeyCodes.X, {ctrlKey: true});
      fire(KeyCodes.C);

      listener.$verify()
    }

    function testAllowsMultiKeySequenceSpecifiedAsArray() {
      listener.shortcutFired('quitemacs');
      listener.$replay();

      handler.registerShortcut('quitemacs',
          [KeyCodes.X, Modifiers.CTRL,
           KeyCodes.C]);
      fire(KeyCodes.X, {ctrlKey: true});
      fire(KeyCodes.C);

      listener.$verify()
    }

    function testAllowsMultiKeySequenceSpecifiedAsArguments() {
      listener.shortcutFired('quitvi');
      listener.$replay();

      handler.registerShortcut('quitvi',
          KeyCodes.COLON, Modifiers.NONE,
          KeyCodes.Q, Modifiers.NONE,
          KeyCodes.EXCLAMATION, Modifiers.NONE);
      fire(KeyCodes.COLON);
      fire(KeyCodes.Q);
      fire(KeyCodes.EXCLAMATION);

      listener.$verify()
    }

    function testMultiKeyEventIsNotFiredIfUserIsTooSlow() {
      listener.$replay(); // no events expected

      handler.registerShortcut('quitemacs',
          [KeyCodes.X, Modifiers.CTRL,
           KeyCodes.C]);

      fire(KeyCodes.X, {ctrlKey: true});

      // Wait 3 seconds before hitting C.  Although the actual limit is 1500
      // at time of writing, it's best not to over-specify functionality.
      mockClock.tick(3000);

      fire(KeyCodes.C);

      listener.$verify()
    }

    function testAllowsMultipleAHandlers() {
      listener.shortcutFired('quitvi');
      listener.shortcutFired('letterex');
      listener.shortcutFired('quitemacs');
      listener.$replay();

      // register 3 handlers in 3 diferent ways
      handler.registerShortcut('quitvi',
          KeyCodes.COLON, Modifiers.NONE,
          KeyCodes.Q, Modifiers.NONE,
          KeyCodes.EXCLAMATION, Modifiers.NONE);
      handler.registerShortcut('quitemacs',
          [KeyCodes.X, Modifiers.CTRL,
           KeyCodes.C]);
      handler.registerShortcut('letterex', 'x');


      // quit vi
      fire(KeyCodes.COLON);
      fire(KeyCodes.Q);
      fire(KeyCodes.EXCLAMATION);

      // then press the letter x
      fire(KeyCodes.X);

      // then quit emacs
      fire(KeyCodes.X, {ctrlKey: true});
      fire(KeyCodes.C);

      listener.$verify()
    }

    function testCanRemoveOneHandler() {
      listener.shortcutFired('letterex');
      listener.$replay();

      // register 2 handlers, then remove quitvi
      handler.registerShortcut('quitvi',
          KeyCodes.COLON, Modifiers.NONE,
          KeyCodes.Q, Modifiers.NONE,
          KeyCodes.EXCLAMATION, Modifiers.NONE);
      handler.registerShortcut('letterex', 'x');
      handler.unregisterShortcut(
          KeyCodes.COLON, Modifiers.NONE,
          KeyCodes.Q, Modifiers.NONE,
          KeyCodes.EXCLAMATION, Modifiers.NONE);

      // call the "quit VI" keycodes, even though it is removed
      fire(KeyCodes.COLON);
      fire(KeyCodes.Q);
      fire(KeyCodes.EXCLAMATION);

      // press the letter x
      fire(KeyCodes.X);

      listener.$verify()
    }

    function testCanRemoveTwoHandlers() {
      listener.$replay(); // no events expected

      handler.registerShortcut('quitemacs',
          [KeyCodes.X, Modifiers.CTRL,
           KeyCodes.C]);
      handler.registerShortcut('letterex', 'x');
      handler.unregisterShortcut(
          [KeyCodes.X, Modifiers.CTRL,
           KeyCodes.C]);
      handler.unregisterShortcut('x');

      fire(KeyCodes.X, {ctrlKey: true});
      fire(KeyCodes.C);
      fire(KeyCodes.X);

      listener.$verify()
    }

    function testCheckRegisteredShortcuts() {
      assertFalse(handler.isShortcutRegistered('x'));
      handler.registerShortcut('letterex', 'x');
      assertTrue(handler.isShortcutRegistered('x'));

      handler.registerShortcut('qe', [KeyCodes.X, Modifiers.CTRL, KeyCodes.C]);
      assertTrue(handler.isShortcutRegistered('x'));
      assertTrue(handler.isShortcutRegistered([KeyCodes.X,
                                               Modifiers.CTRL, KeyCodes.C]));
      handler.unregisterShortcut('x');
      assertFalse(handler.isShortcutRegistered('x'));
      assertTrue(handler.isShortcutRegistered([KeyCodes.X,
                                               Modifiers.CTRL, KeyCodes.C]));
      handler.unregisterShortcut([KeyCodes.X, Modifiers.CTRL, KeyCodes.C]);
      assertFalse(handler.isShortcutRegistered([KeyCodes.X,
                                                Modifiers.CTRL, KeyCodes.C]));
    }

    /**
     * Registers a slew of keyboard shortcuts to test each primary category
     * of shortcuts.
     */
    function registerEnterSpaceXF1AltY() {
      // Enter and space are specially handled keys.
      handler.registerShortcut('enter', KeyCodes.ENTER);
      handler.registerShortcut('space', KeyCodes.SPACE)
      // 'x' should be treated as text in many contexts
      handler.registerShortcut('x', 'x');
      // F1 is a global shortcut.
      handler.registerShortcut('global', KeyCodes.F1);
      // Alt-Y has modifiers, which pass through most form elements.
      handler.registerShortcut('withAlt', 'alt+y');
    }

    /**
     * Fires enter, space, X, F1, and Alt-Y keys on a widget.
     * @param {Element} target The element on which to fire the events.
     */
    function fireEnterSpaceXF1AltY(target) {
      fire(KeyCodes.ENTER, undefined, target);
      fire(KeyCodes.SPACE, undefined, target);
      fire(KeyCodes.X, undefined, target);
      fire(KeyCodes.F1, undefined, target);
      fire(KeyCodes.Y, {altKey: true}, target);
    }

    function testIgnoreNonGlobalShortcutsInSelect() {
      var targetSelect = goog.dom.getElement('targetSelect');

      listener.shortcutFired('global');
      listener.shortcutFired('withAlt');
      listener.$replay();

      registerEnterSpaceXF1AltY();
      fireEnterSpaceXF1AltY(goog.dom.getElement('targetSelect'));

      listener.$verify();
    }

    function testIgnoreNonGlobalShortcutsInTextArea() {
      listener.shortcutFired('global');
      listener.shortcutFired('withAlt');
      listener.$replay();

      registerEnterSpaceXF1AltY();
      fireEnterSpaceXF1AltY(goog.dom.getElement('targetTextArea'));

      listener.$verify();
    }

   function testIgnoreShortcutsExceptEnterInTextBoxAndPassword() {
      // Events for the text box.
      listener.shortcutFired('enter');
      listener.shortcutFired('global');
      listener.shortcutFired('withAlt');
      // Events for the password field.
      listener.shortcutFired('enter');
      listener.shortcutFired('global');
      listener.shortcutFired('withAlt');
      listener.$replay();

      registerEnterSpaceXF1AltY();
      fireEnterSpaceXF1AltY(goog.dom.getElement('targetTextBox'));
      fireEnterSpaceXF1AltY(goog.dom.getElement('targetPassword'));

      listener.$verify();
    }

    function testIgnoreSpaceInCheckBoxAndButton() {
      // Events for the check box.
      listener.shortcutFired('enter');
      listener.shortcutFired('x');
      listener.shortcutFired('global');
      listener.shortcutFired('withAlt');
      // Events for the button.
      listener.shortcutFired('enter');
      listener.shortcutFired('x');
      listener.shortcutFired('global');
      listener.shortcutFired('withAlt');
      listener.$replay();

      registerEnterSpaceXF1AltY();
      fireEnterSpaceXF1AltY(goog.dom.getElement('targetCheckBox'));
      fireEnterSpaceXF1AltY(goog.dom.getElement('targetButton'));

      listener.$verify();
    }

    function testIgnoreNonGlobalShortcutsInContentEditable() {
      try {
        document.designMode = 'on';
        targetDiv.contentEditable = 'true';

        // Expect only global shortcuts.
        listener.shortcutFired('global');
        listener.$replay();

        registerEnterSpaceXF1AltY();
        fireEnterSpaceXF1AltY(targetDiv);

        listener.$verify();
      } finally {
        document.designMode = 'off';
        targetDiv.contentEditable = 'false';
      }
    }

    function testSetAllShortcutsAreGlobal() {
      listener.shortcutFired('enter');
      listener.shortcutFired('space');
      listener.shortcutFired('x');
      listener.shortcutFired('global');
      listener.shortcutFired('withAlt');
      listener.$replay();

      registerEnterSpaceXF1AltY();
      handler.setAllShortcutsAreGlobal(true);
      fireEnterSpaceXF1AltY(goog.dom.getElement('targetTextArea'));

      listener.$verify();
    }

    function testSetModifierShortcutsAreGlobalFalse() {
      listener.shortcutFired('global');
      listener.$replay();

      registerEnterSpaceXF1AltY();
      handler.setModifierShortcutsAreGlobal(false);
      fireEnterSpaceXF1AltY(goog.dom.getElement('targetTextArea'));

      listener.$verify();
    }

    function testAltGraphKeyOnUSLayout() {
      // Windows does not assign printable characters to any ctrl+alt keys of
      // the US layout. This test verifies we fire shortcut events when typing
      // ctrl+alt keys on the US layout.
      listener.shortcutFired('letterOne');
      listener.shortcutFired('letterTwo');
      listener.shortcutFired('letterThree');
      listener.shortcutFired('letterFour');
      listener.shortcutFired('letterFive');
      if (goog.userAgent.WINDOWS && !goog.userAgent.GECKO) {
        listener.$replay();

        handler.registerShortcut('letterOne', 'ctrl+alt+1');
        handler.registerShortcut('letterTwo', 'ctrl+alt+2');
        handler.registerShortcut('letterThree', 'ctrl+alt+3');
        handler.registerShortcut('letterFour', 'ctrl+alt+4');
        handler.registerShortcut('letterFive', 'ctrl+alt+5');

        // Send key events on the English (United States) layout.
        fireAltGraphKey(KeyCodes.ONE, 0, {ctrlKey: true, altKey: true});
        fireAltGraphKey(KeyCodes.TWO, 0, {ctrlKey: true, altKey: true});
        fireAltGraphKey(KeyCodes.THREE, 0, {ctrlKey: true, altKey: true});
        fireAltGraphKey(KeyCodes.FOUR, 0, {ctrlKey: true, altKey: true});
        fireAltGraphKey(KeyCodes.FIVE, 0, {ctrlKey: true, altKey: true});

        listener.$verify()
      }
    }

    function testAltGraphKeyOnFrenchLayout() {
      // Windows assigns printable characters to ctrl+alt+[2-5] keys of the
      // French layout. This test verifies we fire shortcut events only when
      // we type ctrl+alt+1 keys on the French layout.
      listener.shortcutFired('letterOne');
      if (goog.userAgent.WINDOWS && !goog.userAgent.GECKO) {
        listener.$replay();

        handler.registerShortcut('letterOne', 'ctrl+alt+1');
        handler.registerShortcut('letterTwo', 'ctrl+alt+2');
        handler.registerShortcut('letterThree', 'ctrl+alt+3');
        handler.registerShortcut('letterFour', 'ctrl+alt+4');
        handler.registerShortcut('letterFive', 'ctrl+alt+5');

        // Send key events on the French (France) layout.
        fireAltGraphKey(KeyCodes.ONE, 0, {ctrlKey: true, altKey: true});
        fireAltGraphKey(KeyCodes.TWO, 0x0303, {ctrlKey: true, altKey: true});
        fireAltGraphKey(KeyCodes.THREE, 0x0023, {ctrlKey: true, altKey: true});
        fireAltGraphKey(KeyCodes.FOUR, 0x007b, {ctrlKey: true, altKey: true});
        fireAltGraphKey(KeyCodes.FIVE, 0x205b, {ctrlKey: true, altKey: true});

        listener.$verify()
      }
    }

    function testAltGraphKeyOnSpanishLayout() {
      // Windows assigns printable characters to ctrl+alt+[1-5] keys of the
      // Spanish layout. This test verifies we do not fire shortcut events at
      // all when typing ctrl+alt+[1-5] keys on the Spanish layout.
      if (goog.userAgent.WINDOWS && !goog.userAgent.GECKO) {
        listener.$replay();

        handler.registerShortcut('letterOne', 'ctrl+alt+1');
        handler.registerShortcut('letterTwo', 'ctrl+alt+2');
        handler.registerShortcut('letterThree', 'ctrl+alt+3');
        handler.registerShortcut('letterFour', 'ctrl+alt+4');
        handler.registerShortcut('letterFive', 'ctrl+alt+5');

        // Send key events on the Spanish (Spain) layout.
        fireAltGraphKey(KeyCodes.ONE, 0x007c, {ctrlKey: true, altKey: true});
        fireAltGraphKey(KeyCodes.TWO, 0x0040, {ctrlKey: true, altKey: true});
        fireAltGraphKey(KeyCodes.THREE, 0x0023, {ctrlKey: true, altKey: true});
        fireAltGraphKey(KeyCodes.FOUR, 0x0303, {ctrlKey: true, altKey: true});
        fireAltGraphKey(KeyCodes.FIVE, 0x20ac, {ctrlKey: true, altKey: true});

        listener.$verify()
      }
    }

    function testNumpadKeyShortcuts() {
      var testCases = [
        ['letterNumpad0', 'num-0', KeyCodes.NUM_ZERO],
        ['letterNumpad1', 'num-1', KeyCodes.NUM_ONE],
        ['letterNumpad2', 'num-2', KeyCodes.NUM_TWO],
        ['letterNumpad3', 'num-3', KeyCodes.NUM_THREE],
        ['letterNumpad4', 'num-4', KeyCodes.NUM_FOUR],
        ['letterNumpad5', 'num-5', KeyCodes.NUM_FIVE],
        ['letterNumpad6', 'num-6', KeyCodes.NUM_SIX],
        ['letterNumpad7', 'num-7', KeyCodes.NUM_SEVEN],
        ['letterNumpad8', 'num-8', KeyCodes.NUM_EIGHT],
        ['letterNumpad9', 'num-9', KeyCodes.NUM_NINE],
        ['letterNumpadMultiply', 'num-multiply', KeyCodes.NUM_MULTIPLY],
        ['letterNumpadPlus', 'num-plus', KeyCodes.NUM_PLUS],
        ['letterNumpadMinus', 'num-minus', KeyCodes.NUM_MINUS],
        ['letterNumpadPERIOD', 'num-period', KeyCodes.NUM_PERIOD],
        ['letterNumpadDIVISION', 'num-division', KeyCodes.NUM_DIVISION]
      ];
      for (var i = 0; i < testCases.length; ++i) {
        listener.shortcutFired(testCases[i][0]);
      }
      listener.$replay();

      // Register shortcuts for numpad keys and send numpad-key events.
      for (var i = 0; i < testCases.length; ++i) {
        handler.registerShortcut(testCases[i][0], testCases[i][1]);
        fire(testCases[i][2]);
      }
      listener.$verify()
    }

  ">34 of 34 tests run in 33ms.<br />0 passed, 34 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testAllowsAlt<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testAllowsControlAndLetterSpecifiedAsAString<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testAllowsControlAndLetterSpecifiedAsArgSequence<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testAllowsControlAndLetterSpecifiedAsArray<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testAllowsMeta<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testAllowsMultiKeySequenceSpecifiedAsArguments<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testAllowsMultiKeySequenceSpecifiedAsArray<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testAllowsMultipleAHandlers<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testAllowsMultipleModifiers<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testAllowsMultipleModifiersSpecifiedAsString<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testAllowsShift<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testAllowsSingleLetterKeyBindingsSpecifiedAsKeyCode<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testAllowsSingleLetterKeyBindingsSpecifiedAsString<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testAltGraphKeyOnFrenchLayout<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testAltGraphKeyOnSpanishLayout<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testAltGraphKeyOnUSLayout<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testCanRemoveOneHandler<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testCanRemoveTwoHandlers<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testCheckRegisteredShortcuts<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testDoesntFireIfAnyRequiredModifierForgotten<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testDoesntFireIfTooManyModifiersPressed<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testDoesntFireWhenUserForgetsRequiredModifier<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testDoesntFireWhenWrongKeyIsPressed<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testIgnoreNonGlobalShortcutsInContentEditable<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testIgnoreNonGlobalShortcutsInSelect<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testIgnoreNonGlobalShortcutsInTextArea<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testIgnoreShortcutsExceptEnterInTextBoxAndPassword<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testIgnoreSpaceInCheckBoxAndButton<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testMultiKeyEventIsNotFiredIfUserIsTooSlow<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testNumpadKeyShortcuts<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testPreventsDefaultOnReturnFalse<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testPreventsDefaultWhenExceptionThrown<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testSetAllShortcutsAreGlobal<br />Object #<Object> has no method 'attachEvent'<br />ERROR in testSetModifierShortcutsAreGlobalFalse<br />Object #<Object> has no method 'attachEvent'<br /></td></tr>
<tr><td>richtextspellchecker_test.html</td><td>Fail</td><td> 0 passed, 3 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.string.StringBuffer');
  goog.require('goog.testing.jsunit');
  goog.require('goog.ui.RichTextSpellChecker');



var attributeSet = ['b', 'u', 'del', 'i'];
var vocabulary = ['test', 'words', 'a', 'few', 'missspelling', 'iggnore'];

// We don't use Math.random() to make test predictable. Math.random is not
// repeatable, so a success on the dev machine != success in the lab (or on
// other dev machines). This is the same pseudorandom logic that CRT rand()
// uses.
var rseed = 1;
function random(range) {
  rseed = (rseed * 1103515245 + 12345) & 0xffffffff;
  return ((rseed >> 16) & 0x7fff) % range;
};

function localSpellCheckingFunction(words, spellChecker, callback) {
  var len = words.length;
  var results = [];
  for (var i = 0; i < len; i++) {
    var word = words[i];
    var found = false;
    // Last two words are considered misspellings
    for (var j = 0 ; j < vocabulary.length - 2 ; ++j) {
      if (vocabulary[j] == word) {
        found = true;
        break;
      }
    }
    if (found) {
      results.push([word, goog.spell.SpellCheck.WordStatus.VALID]);
    } else {
      results.push([word, goog.spell.SpellCheck.WordStatus.INVALID,
          ['foo','bar']]);
    }
  }
  callback.call(spellChecker, results);
};

function generateRandomSpace() {
  var string = '';
  var nSpace = 1 + random(4);
  for (var i = 0; i < nSpace ; ++i) {
    string += ' ';
  }
  return string;
};

function generateRandomString(maxWords) {
  var string = '';
  var nWords = 1 + random(maxWords);
  for (var i = 0; i < nWords ; ++i) {
    string += vocabulary[random(vocabulary.length)];
    string += generateRandomSpace();
  }
  return string;
};

function generateRandomHtml(rootNode, branchFactor, attributes, numAttr) {
  if (numAttr == 0) {
    var text = document.createTextNode(generateRandomString(10));
    rootNode.appendChild(text);
    return;
  }

  var lastElementWasText = false;
  for (var i = 0; i < branchFactor; ++i) {
    var rand = random(10);
    if (rand < 8 && !lastElementWasText) {
      lastElementWasText = true;
      var text = document.createTextNode(generateRandomString(10));
      rootNode.appendChild(text);
    } else {
      lastElementWasText = false;

      var rand = random(numAttr);
      var index = 0;
      for (;;) {
        while (attributes[index] == null) {
          ++index;
        }
        if (rand == 0)
          break;
        ++index;
        --rand;
      };

      var attr = attributes[index];
      var el = document.createElement(attr);
      rootNode.appendChild(el);
      rand = random(10);
      if (rand == 0) {
        el.className = 'goog-quote';
      }
      attributes[index] = null;
      generateRandomHtml(el, branchFactor, attributes, numAttr-1);
      attributes[index] = attr;
    }
  }
};

var timerQueue = [];
function processTimerQueue() {
  while (timerQueue.length > 0) {
    var fn = timerQueue.shift();
    fn();
  }
};

function localTimer(fn, delay, obj) {
  if (obj) {
    fn = goog.bind(fn, obj);
  }
  timerQueue.push(fn);
  return timerQueue.length;
};

function testDocumentIntegrity() {
  var handler = new goog.spell.SpellCheck(localSpellCheckingFunction);
  var s = new goog.ui.RichTextSpellChecker(handler);
  s.asyncWordsPerBatch_ = 100;
  var el = document.getElementById('test1');
  s.decorate(el);
  generateRandomHtml(el, 4, attributeSet, attributeSet.length);
  var el2 = el.cloneNode(true);

  var timerSav = goog.Timer.callOnce;
  goog.Timer.callOnce = localTimer;

  s.setExcludeMarker('goog-quote');
  s.check();
  processTimerQueue();
  s.ignoreWord('iggnore');
  processTimerQueue();
  s.check();
  processTimerQueue();
  s.resume();
  processTimerQueue();

  goog.Timer.callOnce = timerSav;

  assertEquals('Spell checker run should not change the underlying element.',
               el2.innerHTML, el.innerHTML);
  s.dispose();
};

function testBiggerDocument() {
  var handler = new goog.spell.SpellCheck(localSpellCheckingFunction);
  var s = new goog.ui.RichTextSpellChecker(handler);
  var el = document.getElementById('test2');
  s.decorate(el);
  generateRandomHtml(el, 4, attributeSet, attributeSet.length);
  var el2 = el.cloneNode(true);

  var timerSav = goog.Timer.callOnce;
  goog.Timer.callOnce = localTimer;

  s.check();
  processTimerQueue();
  s.resume();
  processTimerQueue();

  goog.Timer.callOnce = timerSav;

  assertEquals('Spell checker run should not change the underlying element.',
               el2.innerHTML, el.innerHTML);
  s.dispose();
};

function testElementOverflow() {
  var handler = new goog.spell.SpellCheck(localSpellCheckingFunction);
  var s = new goog.ui.RichTextSpellChecker(handler);
  s.asyncWordsPerBatch_ = 100;
  var el = document.getElementById('test3');
  s.decorate(el);
  var text = generateRandomString(200);
  el.appendChild(document.createTextNode(text));

  var el2 = el.cloneNode(true);

  var timerSav = goog.Timer.callOnce;
  goog.Timer.callOnce = localTimer;

  s.check();
  processTimerQueue();
  s.check();
  processTimerQueue();
  s.resume();
  processTimerQueue();

  goog.Timer.callOnce = timerSav;

  assertEquals('Spell checker run should not change the underlying element.',
               el2.innerHTML, el.innerHTML);
  s.dispose();
};

">3 of 3 tests run in 19ms.<br />0 passed, 3 failed.<br />6 ms/test. 1 files loaded.<br />ERROR in testBiggerDocument<br />Object #<Object> has no method 'createElement'<br />ERROR in testDocumentIntegrity<br />Object #<Object> has no method 'createElement'<br />ERROR in testElementOverflow<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>tabbarrenderer_test.html</td><td>Fail</td><td> 6 passed, 2 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.dom.a11y.Role');
    goog.require('goog.dom.classes');
    goog.require('goog.testing.jsunit');
    goog.require('goog.ui.Container.Orientation');
    goog.require('goog.ui.Tab');
    goog.require('goog.ui.TabBar');
    goog.require('goog.ui.TabBar.Location');
    goog.require('goog.ui.TabBarRenderer');
    goog.require('goog.testing.ui.rendererasserts');
  

    var sandbox = goog.dom.getElement('sandbox');
    var renderer = goog.ui.TabBarRenderer.getInstance();
    var tabBar;
  
    function setUp() {
      tabBar = new goog.ui.TabBar();
    }
    
    function tearDown() {
      tabBar.dispose();
      goog.dom.removeChildren(sandbox);
    }

    function testConstructor() {
      assertNotNull('Renderer must not be null', renderer);
    }

    function testGetCssClass() {
      assertEquals('getCssClass() must return expected value',
          goog.ui.TabBarRenderer.CSS_CLASS, renderer.getCssClass());
    }

    function testGetAriaRole() {
      assertEquals('getAriaRole() must return expected value',
          goog.dom.a11y.Role.TAB_LIST, renderer.getAriaRole());
    }

    function testCreateDom() {
      var element = renderer.createDom(tabBar);
      assertNotNull('Created element must not be null', element);
      assertEquals('Created element must be a DIV', 'DIV', element.tagName);
      assertSameElements('Created element must have expected class names',
          ['goog-tab-bar', 'goog-tab-bar-horizontal', 'goog-tab-bar-top'],
          goog.dom.classes.get(element));
    }

    function testDecorate() {
      sandbox.innerHTML = '<div id="start" class="goog-tab-bar-start"></div>';
      var element = renderer.decorate(tabBar, goog.dom.getElement('start'));
      assertNotNull('Decorated element must not be null', element);
      assertEquals('Decorated element must be as expected',
          goog.dom.getElement('start'), element);
      // Due to a bug in ContainerRenderer, the "-vertical" class isn't applied.
      // TODO(user): Fix this!
      assertSameElements('Decorated element must have expected class names',
          ['goog-tab-bar', 'goog-tab-bar-start'],
          goog.dom.classes.get(element));
    }

    function testSetStateFromClassName() {
      renderer.setStateFromClassName(tabBar, 'goog-tab-bar-bottom',
          renderer.getCssClass());
      assertEquals('Location must be BOTTOM', goog.ui.TabBar.Location.BOTTOM,
          tabBar.getLocation());
      assertEquals('Orientation must be HORIZONTAL',
          goog.ui.Container.Orientation.HORIZONTAL, tabBar.getOrientation());

      renderer.setStateFromClassName(tabBar, 'goog-tab-bar-end',
          renderer.getCssClass());
      assertEquals('Location must be END', goog.ui.TabBar.Location.END,
          tabBar.getLocation());
      assertEquals('Orientation must be VERTICAL',
          goog.ui.Container.Orientation.VERTICAL, tabBar.getOrientation());

      renderer.setStateFromClassName(tabBar, 'goog-tab-bar-top',
          renderer.getCssClass());
      assertEquals('Location must be TOP', goog.ui.TabBar.Location.TOP,
          tabBar.getLocation());
      assertEquals('Orientation must be HORIZONTAL',
          goog.ui.Container.Orientation.HORIZONTAL, tabBar.getOrientation());

      renderer.setStateFromClassName(tabBar, 'goog-tab-bar-start',
          renderer.getCssClass());
      assertEquals('Location must be START', goog.ui.TabBar.Location.START,
          tabBar.getLocation());
      assertEquals('Orientation must be VERTICAL',
          goog.ui.Container.Orientation.VERTICAL, tabBar.getOrientation());
    }

    function testGetClassNames() {
      assertSameElements('Class names for TOP location must be as expected',
          ['goog-tab-bar', 'goog-tab-bar-horizontal', 'goog-tab-bar-top'],
          renderer.getClassNames(tabBar));

      tabBar.setLocation(goog.ui.TabBar.Location.START);
      assertSameElements('Class names for START location must be as expected',
          ['goog-tab-bar', 'goog-tab-bar-vertical', 'goog-tab-bar-start'],
          renderer.getClassNames(tabBar));

      tabBar.setLocation(goog.ui.TabBar.Location.BOTTOM);
      assertSameElements('Class names for BOTTOM location must be as expected',
          ['goog-tab-bar', 'goog-tab-bar-horizontal', 'goog-tab-bar-bottom'],
          renderer.getClassNames(tabBar));
      
      tabBar.setLocation(goog.ui.TabBar.Location.END);
      assertSameElements('Class names for END location must be as expected',
          ['goog-tab-bar', 'goog-tab-bar-vertical', 'goog-tab-bar-end'],
          renderer.getClassNames(tabBar));
    }

    function testDoesntCallGetCssClassInConstructor() {
      goog.testing.ui.rendererasserts.
          assertNoGetCssClassCallsInConstructor(goog.ui.TabBarRenderer);
    }
  ">8 of 8 tests run in 11ms.<br />6 passed, 2 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testCreateDom<br />Object #<Object> has no method 'createElement'<br />ERROR in testDecorate<br />Decorated element must be as expected<br />Expected <[object Object]> (Object) but was <[object Object]> (Object)<br />> assertEquals at testing/asserts.js:289:3<br />> testDecorate at _tmpclosuretest.js:55:7<br /></td></tr>
<tr><td>singleton_test.html</td><td>Success</td><td> 1 passed, 0 failed.</td><td title="

  goog.require('goog.testing.asserts');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.singleton');



function testGetInstance() {
  function SingletonClass() {}
  goog.addSingletonGetter(SingletonClass);

  var s1 = SingletonClass.getInstance();
  var s2 = SingletonClass.getInstance();
  assertEquals('second getInstance call returns the same instance', s1, s2);

  goog.testing.singleton.reset();
  var s3 = SingletonClass.getInstance();
  assertNotEquals('getInstance returns a new instance after reset', s1, s3);
}

">n/a</td></tr>
<tr><td>propertyreplacer_test.html</td><td>Fail</td><td> 8 passed, 3 failed.</td><td title="

  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.testing.asserts');
  goog.require('goog.testing.jsunit');



// Test PropertyReplacer with JavaScript objects.
function testSetJsProperties() {
  var stubs = new goog.testing.PropertyReplacer();
  var x = {a: 1, b: undefined};

  // Setting simple values.
  stubs.set(x, 'num', 1);
  assertEquals('x.num = 1', 1, x.num);
  stubs.set(x, 'undef', undefined);
  assertTrue('x.undef = undefined', 'undef' in x && x.undef === undefined);
  stubs.set(x, 'null', null);
  assertTrue('x["null"] = null', x['null'] === null);

  // Setting a simple value that existed originally.
  stubs.set(x, 'b', null);
  assertTrue('x.b = null', x.b === null);

  // Setting a complex value.
  stubs.set(x, 'obj', {});
  assertEquals('x.obj = {}', 'object', typeof x.obj);
  stubs.set(x.obj, 'num', 2);
  assertEquals('x.obj.num = 2', 2, x.obj.num);

  // Overwriting a leaf.
  stubs.set(x.obj, 'num', 3);
  assertEquals('x.obj.num = 3', 3, x.obj.num);

  // Overwriting a non-leaf.
  stubs.set(x, 'obj', {});
  assertFalse('x.obj = {} again', 'num' in x.obj);

  // Setting a function.
  stubs.set(x, 'func', function(n) { return n + 1; });
  assertEquals('x.func = lambda n: n+1', 11, x.func(10));

  // Setting a constructor and a prototype method.
  stubs.set(x, 'Class', function(num) { this.num = num; });
  stubs.set(x.Class.prototype, 'triple', function() { return this.num * 3; });
  assertEquals('prototype method', 12, (new x.Class(4)).triple());

  // Cleaning up with UnsetAll() twice. The second run should have no effect.
  for (var i = 0; i < 2; i++) {
    stubs.reset();
    assertEquals('x.a preserved', 1, x.a);
    assertTrue('x.b reset', 'b' in x && x.b === undefined);
    assertFalse('x.num removed', 'num' in x);
    assertFalse('x.undef removed', 'undef' in x);
    assertFalse('x["null"] removed', 'null' in x);
    assertFalse('x.obj removed', 'obj' in x);
    assertFalse('x.func removed', 'func' in x);
    assertFalse('x.Class removed', 'Class' in x);
  }
}

// Test removing JavaScript object properties.
function testRemoveJsProperties() {
  var stubs = new goog.testing.PropertyReplacer();
  var orig = {'a': 1, 'b': undefined};
  var x = {'a': 1, 'b': undefined};

  stubs.remove(x, 'a');
  assertFalse('x.a removed', 'a' in x);
  assertTrue('x.b not removed', 'b' in x);
  stubs.reset();
  assertObjectEquals('x.a reset', x, orig);

  stubs.remove(x, 'b');
  assertFalse('x.b removed', 'b' in x);
  stubs.reset();
  assertObjectEquals('x.b reset', x, orig);

  stubs.set(x, 'c', 2);
  stubs.remove(x, 'c');
  assertObjectEquals('x.c added then removed', x, orig);
  stubs.reset();
  assertObjectEquals('x.c reset', x, orig);

  stubs.remove(x, 'b');
  stubs.set(x, 'b', undefined);
  assertObjectEquals('x.b removed then added', x, orig);
  stubs.reset();
  assertObjectEquals('x.b reset', x, orig);

  stubs.remove(x, 'd');
  assertObjectEquals('removing non-existing key', x, orig);
  stubs.reset();
  assertObjectEquals('reset removing non-existing key', x, orig);
}

// Test PropertyReplacer with prototype chain.
function testPrototype() {
  var stubs = new goog.testing.PropertyReplacer();

  // Simple inheritance.
  var a = {a: 0};
  function B() {};
  B.prototype = a;
  var b = new B();

  stubs.set(a, 0, 1);
  stubs.set(b, 0, 2);
  stubs.reset();
  assertEquals('a.a == 0', 0, a['a']);
  assertEquals('b.a == 0', 0, b['a']);

  // Inheritance with goog.inherits.
  var c = {a: 0};
  function C() {};
  C.prototype = c;
  function D() {};
  goog.inherits(D, C);
  var d = new D();

  var stubs = new goog.testing.PropertyReplacer();
  stubs.set(c, 'a', 1);
  stubs.set(d, 'a', 2);
  stubs.reset();
  assertEquals('c.a == 0', 0, c['a']);
  assertEquals('d.a == 0', 0, d['a']);

  // Setting prototype fields.
  stubs.set(B.prototype, 'c', 'z');
  assertEquals('b.c=="z"', 'z', b.c);
  stubs.reset();
  assertFalse('b.c deleted', 'c' in b);

  // Setting Object.prototype's fields.
  stubs.set(Object.prototype, 'one', 1);
  assertEquals('b.one==1', 1, b.one);
  stubs.reset();
  assertFalse('b.one deleted', 'one' in b);

  stubs.set(Object.prototype, 'two', 2);
  stubs.remove(b, 'two');
  assertEquals('b.two==2', 2, b.two);
  stubs.remove(Object.prototype, 'two');
  assertFalse('b.two deleted', 'two' in b);
  stubs.reset();
  assertFalse('Object prototype reset', 'two' in b);
}

// Test replacing function properties.
function testFunctionProperties() {
  var stubs = new goog.testing.PropertyReplacer();
  stubs.set(Array, 'x', 1);
  assertEquals('Array.x==1', 1, Array.x);
  stubs.reset();
  assertFalse('Array.x deleted', 'x' in Array);

  stubs.set(Math.random, 'x', 1);
  assertEquals('Math.random.x==1', 1, Math.random.x);
  stubs.reset();
  assertFalse('Math.random.x deleted', 'x' in Math.random);
}

// Test the hasKey_ private method.
function testHasKey() {
  f = goog.testing.PropertyReplacer.hasKey_;

  assertFalse('{}.a', f({}, 'a'));
  assertTrue('{a:0}.a', f({a: 0}, 'a'));

  function C() {};
  C.prototype.a = 0;
  assertFalse('C.prototype.a set, is C.a own?', f(C, 'a'));
  assertTrue('C.prototype.a', f(C.prototype, 'a'));
  assertFalse('C.a not set', f(C, 'a'));
  C.a = 0;
  assertTrue('C.a set', f(C, 'a'));

  var c = new C();
  assertFalse('C().a, inherited', f(c, 'a'));
  c.a = 0;
  assertTrue('C().a, own', f(c, 'a'));

  assertFalse('window, invalid key', f(window, 'no such key'));
  assertTrue('window, global variable', f(window, 'goog'));
  assertTrue('window, build-in key', f(window, 'location'))

  assertFalse('document, invalid key', f(document, 'no such key'));
  assertTrue('document.body', f(document, 'body'));

  var div = document.createElement('div');
  assertFalse('div, invalid key', f(div, 'no such key'));
  assertTrue('div.className', f(div, 'className'));
  div['a'] = 0;
  assertTrue('div, key added by JS', f(div, 'a'));

  assertFalse('Date().getTime', f(new Date(), 'getTime'));
  assertTrue('Date.prototype.getTime', f(Date.prototype, 'getTime'));

  assertFalse('Math, invalid key', f(Math, 'no such key'));
  assertTrue('Math.random', f(Math, 'random'));

  function Parent() {};
  Parent.prototype.a = 0;
  function Child() {};
  goog.inherits(Child, Parent);
  assertFalse('goog.inherits, parent prototype', f(new Child, 'a'));
  Child.prototype.a = 1;
  assertFalse('goog.inherits, child prototype', f(new Child, 'a'));

  function OverwrittenProto() {};
  OverwrittenProto.prototype = {a: 0};
  assertFalse(f(new OverwrittenProto, 'a'));
}

// Test PropertyReplacer with DOM objects' built in attributes.
function testDomBuiltInAttributes() {
  var div = document.createElement('div');
  div.id = 'old-id';

  var stubs = new goog.testing.PropertyReplacer();
  stubs.set(div, 'id', 'new-id');
  stubs.set(div, 'className', 'test-class');
  assertEquals('div.id == "new-id"', 'new-id', div.id);
  assertEquals('div.className == "test-class"', 'test-class', div.className);

  stubs.remove(div, 'className');
  // '' in Firefox, undefined in Chrome.
  assertEvaluatesToFalse('div.className is empty', div.className);

  stubs.reset();
  assertEquals('div.id == "old-id"', 'old-id', div.id);
  assertEquals('div.name == ""', '', div.className);
}

// Test PropertyReplacer with DOM objects' custom attributes.
function testDomCustomAttributes() {
  var div = document.createElement('div');
  div.attr1 = 'old';

  var stubs = new goog.testing.PropertyReplacer();
  stubs.set(div, 'attr1', 'new');
  stubs.set(div, 'attr2', 'new');
  assertEquals('div.attr1 == "new"', 'new', div.attr1);
  assertEquals('div.attr2 == "new"', 'new', div.attr2);

  stubs.set(div, 'attr3', 'new');
  stubs.remove(div, 'attr3');
  assertEquals('div.attr3 == undefined', undefined, div.attr3);

  stubs.reset();
  assertEquals('div.attr1 == "old"', 'old', div.attr1);
  assertEquals('div.attr2 == undefined', undefined, div.attr2);
}

// Test PropertyReplacer overriding Math.random.
function testMathRandom() {
  var stubs = new goog.testing.PropertyReplacer();
  stubs.set(Math, 'random', function() { return -1; });
  assertEquals('mocked Math.random', -1, Math.random());

  stubs.reset();
  assertNotEquals('original Math.random', -1, Math.random());
}

// Tests the replace method of PropertyReplacer.
function testReplace() {
  var stubs = new goog.testing.PropertyReplacer();
  function C() {
    this.a = 1;
  };
  C.prototype.b = 1;
  C.prototype.toString = function() {
    return 'obj';
  };
  var obj = new C();

  stubs.replace(obj, 'a', 2);
  assertEquals('successfully replaced the own property of an object', 2, obj.a);

  stubs.replace(obj, 'b', 2);
  assertEquals('successfully replaced the property in the prototype', 2, obj.b);

  var error = assertThrows('cannot replace missing key',
      goog.bind(stubs.replace, stubs, obj, 'unknown', 1));
  // Using assertContains instead of assertEquals because Opera 10.0 adds
  // the stack trace to the error message.
  assertEquals('error message for missing key',
      'Cannot replace missing property "unknown" in obj', error.message);
  assertFalse('object not touched', 'unknown' in obj);

  var error = assertThrows('cannot change value type',
      goog.bind(stubs.replace, stubs, obj, 'a', '3'));
  assertContains('error message for type mismatch',
      'Cannot replace property "a" in obj with a value of different type',
      error.message);
}

// Tests altering complete namespace paths.
function testSetPath() {
  goog.global.a = {b: {}};
  var stubs = new goog.testing.PropertyReplacer();

  stubs.setPath('a.b.c.d', 1);
  assertObjectEquals('a.b.c.d=1', {b: {c: {d: 1}}}, goog.global.a);
  stubs.setPath('a.b.e', 2);
  assertObjectEquals('a.b.e=2', {b: {c: {d: 1}, e: 2}}, goog.global.a);
  stubs.setPath('a.f', 3);
  assertObjectEquals('a.f=3', {b: {c: {d: 1}, e: 2}, f: 3}, goog.global.a);
  stubs.setPath('a.f.g', 4);
  assertObjectEquals('a.f.g=4', {b: {c: {d: 1}, e: 2}, f: {g: 4}},
                     goog.global.a);
  stubs.setPath('a', 5);
  assertEquals('a=5', 5, goog.global.a);

  stubs.setPath('x.y.z', 5);
  assertObjectEquals('x.y.z=5', {y: {z: 5}}, goog.global.x);

  stubs.reset();
  assertObjectEquals('a.* reset', {b: {}}, goog.global.a);
  // NOTE: it's impossible to delete global variables in Internet Explorer,
  // so ('x' in goog.global) would be true.
  assertUndefined('x.* reset', goog.global.x);
}

// Tests altering paths with functions in them.
function testSetPathWithFunction() {
  var f = function() {};
  goog.global.a = {b: f};
  var stubs = new goog.testing.PropertyReplacer();

  stubs.setPath('a.b.c', 1);
  assertEquals('a.b.c=1, f kept', f, goog.global.a.b);
  assertEquals('a.b.c=1, c set', 1, goog.global.a.b.c);

  stubs.setPath('a.b.prototype.d', 2);
  assertEquals('a.b.prototype.d=2, b kept', f, goog.global.a.b);
  assertEquals('a.b.prototype.d=2, c kept', 1, goog.global.a.b.c);
  assertFalse('a.b.prototype.d=2, a.b.d not set', 'd' in goog.global.a.b);
  assertTrue('a.b.prototype.d=2, proto set', 'd' in goog.global.a.b.prototype);
  assertEquals('a.b.prototype.d=2, d set', 2, new goog.global.a.b().d);

  var invalidSetPath = function() {
    stubs.setPath('a.prototype.e', 3);
  };
  assertThrows('setting the prototype of a non-function', invalidSetPath);

  stubs.reset();
  assertObjectEquals('a.b.c reset', {b: f}, goog.global.a);
  assertObjectEquals('a.b.prototype reset', {}, goog.global.a.b.prototype);
}

">11 of 11 tests run in 10ms.<br />8 passed, 3 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testDomBuiltInAttributes<br />Object #<Object> has no method 'createElement'<br />ERROR in testDomCustomAttributes<br />Object #<Object> has no method 'createElement'<br />ERROR in testHasKey<br />document.body<br />Call to assertTrue(boolean) with false<br />> assertTrue at testing/asserts.js:261:3<br />> testHasKey at _tmpclosuretest.js:189:3<br /></td></tr>
<tr><td>functionmock_test.html</td><td>Success</td><td> 21 passed, 0 failed.</td><td title="

  goog.require('goog.testing.asserts');
  goog.require('goog.testing.FunctionMock');
  goog.require('goog.testing.GlobalFunctionMock');
  goog.require('goog.testing.MethodMock');
  goog.require('goog.testing.StrictMock');
  goog.require('goog.testing.jsunit');



// Global scope so we can tear it down safely
var mockGlobal;

function tearDown() {
  if (mockGlobal) {
    mockGlobal.$tearDown();
  }
}


//----- Tests for goog.testing.FunctionMock

function testMocksFunctionWithNoArgs() {
  var mockFoo = goog.testing.createFunctionMock();
  mockFoo();
  mockFoo.$replay();
  mockFoo();
  mockFoo.$verify();
}

function testMocksFunctionWithOneArg() {
  var mockFoo = goog.testing.createFunctionMock();
  mockFoo('x');
  mockFoo.$replay();
  mockFoo('x');
  mockFoo.$verify();
}

function testMocksFunctionWithMultipleArgs() {
  var mockFoo = goog.testing.createFunctionMock();
  mockFoo('x', 'y');
  mockFoo.$replay();
  mockFoo('x', 'y');
  mockFoo.$verify();
}

function testFailsIfCalledWithIncorrectArgs() {
  var mockFoo = goog.testing.createFunctionMock();

  mockFoo();
  mockFoo.$replay();
  assertThrows(function() {mockFoo('x');});
  mockFoo.$reset();

  mockFoo('x');
  mockFoo.$replay();
  assertThrows(function() {mockFoo();});
  mockFoo.$reset();

  mockFoo('x');
  mockFoo.$replay();
  assertThrows(function() {mockFoo('x', 'y');});
  mockFoo.$reset();

  mockFoo('x', 'y');
  mockFoo.$replay();
  assertThrows(function() {mockFoo('x');});
  mockFoo.$reset();

  mockFoo('correct');
  mockFoo.$replay();
  assertThrows(function() {mockFoo('wrong');});
  mockFoo.$reset();

  mockFoo('correct', 'args');
  mockFoo.$replay();
  assertThrows(function() {mockFoo('wrong', 'args');});
  mockFoo.$reset();
}

function testMocksFunctionWithReturnValue() {
  var mockFoo = goog.testing.createFunctionMock();
  mockFoo().$returns('bar');
  mockFoo.$replay();
  assertEquals('bar', mockFoo());
  mockFoo.$verify();
}

function testFunctionMockWorksWhenPassedAsACallback() {
  var invoker = {
    register: function(callback) {
      this.callback = callback;
    },

    invoke: function(args) {
      return this.callback(args);
    }
  };

  var mockFunction = goog.testing.createFunctionMock();
  mockFunction('bar').$returns('baz');

  mockFunction.$replay();
  invoker.register(mockFunction);
  assertEquals('baz', invoker.invoke('bar'));
  mockFunction.$verify();
}

function testFunctionMockQuacksLikeAStrictMock() {
  var mockFunction = goog.testing.createFunctionMock();
  assertQuacksLike(mockFunction, goog.testing.StrictMock);
}


//----- Global functions for goog.testing.GlobalFunctionMock to mock

function globalFoo() {
  return 'I am Spartacus!';
}

function globalBar(who, what) {
  return [who, 'is', what].join(' ');
}


//----- Tests for goog.testing.createGlobalFunctionMock

function testMocksGlobalFunctionWithNoArgs() {
  mockGlobal = goog.testing.createGlobalFunctionMock('globalFoo');
  mockGlobal().$returns('No, I am Spartacus!');

  mockGlobal.$replay();
  assertEquals('No, I am Spartacus!', globalFoo());
  mockGlobal.$verify();
}

function testMocksGlobalFunctionUsingGlobalName() {
  goog.testing.createGlobalFunctionMock('globalFoo');
  globalFoo().$returns('No, I am Spartacus!');

  globalFoo.$replay();
  assertEquals('No, I am Spartacus!', globalFoo());
  globalFoo.$verify();
  globalFoo.$tearDown();
}

function testMocksGlobalFunctionWithArgs() {
  var mockReturnValue = 'Noam is Chomsky!';
  mockGlobal = goog.testing.createGlobalFunctionMock('globalBar');
  mockGlobal('Noam', 'Spartacus').$returns(mockReturnValue);

  mockGlobal.$replay();
  assertEquals(mockReturnValue, globalBar('Noam', 'Spartacus'));
  mockGlobal.$verify();
}

function testGlobalFunctionMockFailsWithIncorrectArgs() {
  mockGlobal = goog.testing.createGlobalFunctionMock('globalBar');
  mockGlobal('a', 'b');

  mockGlobal.$replay();

  assertThrows('Mock should have failed because of incorrect arguments',
      function() {globalBar('b', 'a')});
}

function testGlobalFunctionMockQuacksLikeAFunctionMock() {
  mockGlobal = goog.testing.createGlobalFunctionMock('globalFoo');
  assertQuacksLike(mockGlobal, goog.testing.FunctionMock);
}

function testMockedFunctionsAvailableInGlobalAndGoogGlobalAndWindowScope() {
  mockGlobal = goog.testing.createGlobalFunctionMock('globalFoo');

  // we expect this call 3 times through global, goog.global and window scope
  mockGlobal().$times(3);

  mockGlobal.$replay();
  goog.global.globalFoo();
  window.globalFoo();
  globalFoo();
  mockGlobal.$verify();
}

function testTearDownRestoresOriginalGlobalFunction() {
  mockGlobal = goog.testing.createGlobalFunctionMock('globalFoo');
  mockGlobal().$returns('No, I am Spartacus!');

  mockGlobal.$replay();
  assertEquals('No, I am Spartacus!', globalFoo());
  mockGlobal.$tearDown();
  assertEquals('I am Spartacus!', globalFoo());
  mockGlobal.$verify();
}

function testTearDownHandlesMultipleMocking() {
  var mock1 = goog.testing.createGlobalFunctionMock('globalFoo');
  var mock2 = goog.testing.createGlobalFunctionMock('globalFoo');
  var mock3 = goog.testing.createGlobalFunctionMock('globalFoo');
  mock1().$returns('No, I am Spartacus 1!');
  mock2().$returns('No, I am Spartacus 2!');
  mock3().$returns('No, I am Spartacus 3!');

  mock1.$replay();
  mock2.$replay();
  mock3.$replay();
  assertEquals('No, I am Spartacus 3!', globalFoo());
  mock3.$tearDown();
  assertEquals('No, I am Spartacus 2!', globalFoo());
  mock2.$tearDown();
  assertEquals('No, I am Spartacus 1!', globalFoo());
  mock1.$tearDown();
  assertEquals('I am Spartacus!', globalFoo());
}

//----- Functions for goog.testing.MethodMock to mock

var mynamespace = {};

mynamespace.myMethod = function() {
  return 'I should be mocked.';
};

function testMocksMethod() {
  mockMethod = goog.testing.createMethodMock(mynamespace, 'myMethod');
  mockMethod().$returns('I have been mocked!');

  mockMethod.$replay();
  assertEquals('I have been mocked!', mockMethod());
  mockMethod.$verify();
}

function testMocksMethodInNamespace() {
  goog.testing.createMethodMock(mynamespace, 'myMethod');
  mynamespace.myMethod().$returns('I have been mocked!');

  mynamespace.myMethod.$replay();
  assertEquals('I have been mocked!', mynamespace.myMethod());
  mynamespace.myMethod.$verify();
  mynamespace.myMethod.$tearDown();
}

function testMethodMockCanOnlyMockExistingMethods() {
  assertThrows(function() {
    goog.testing.createMethodMock(mynamespace, 'doesNotExist');
  });
}

//----- Functions for goog.testing.createConstructorMock to mock

var constructornamespace = {};

constructornamespace.MyConstructor = function() {
};

constructornamespace.MyConstructor.prototype.myMethod = function() {
  return 'I should be mocked.';
};

constructornamespace.MyConstructorWithArgument = function(argument) {
  this.argument_ = argument;
};

constructornamespace.MyConstructorWithArgument.prototype.myMethod = function() {
  return this.argument_;
};

constructornamespace.MyConstructorWithClassMembers = function() {
};

constructornamespace.MyConstructorWithClassMembers.CONSTANT = 42;

constructornamespace.MyConstructorWithClassMembers.classMethod = function() {
  return 'class method return value';
};

function testConstructorMock() {
  var mockObject =
      new goog.testing.StrictMock(constructornamespace.MyConstructor);
  var mockConstructor = goog.testing.createConstructorMock(
      constructornamespace, 'MyConstructor');
  mockConstructor().$returns(mockObject);
  mockObject.myMethod().$returns('I have been mocked!');

  mockConstructor.$replay();
  mockObject.$replay();
  assertEquals('I have been mocked!',
      new constructornamespace.MyConstructor().myMethod());
  mockConstructor.$verify();
  mockObject.$verify();
  mockConstructor.$tearDown();
}

function testConstructorMockWithArgument() {
  var mockObject = new goog.testing.StrictMock(
      constructornamespace.MyConstructorWithArgument);
  var mockConstructor = goog.testing.createConstructorMock(
      constructornamespace, 'MyConstructorWithArgument');
  mockConstructor(goog.testing.mockmatchers.isString).$returns(mockObject);
  mockObject.myMethod().$returns('I have been mocked!');

  mockConstructor.$replay();
  mockObject.$replay();
  assertEquals('I have been mocked!',
      new constructornamespace.MyConstructorWithArgument('I should be mocked.')
          .myMethod());
  mockConstructor.$verify();
  mockObject.$verify();
  mockConstructor.$tearDown();
}

/**
 * Test that class members are copied to the mock constructor.
 */
function testConstructorMockWithClassMembers() {
  var mockConstructor = goog.testing.createConstructorMock(
      constructornamespace, 'MyConstructorWithClassMembers');
  assertEquals(42, constructornamespace.MyConstructorWithClassMembers.CONSTANT);
  assertEquals('class method return value',
      constructornamespace.MyConstructorWithClassMembers.classMethod());
  mockConstructor.$tearDown();
}

//----- Helper assertions

function assertQuacksLike(obj, target) {
  for (meth in target.prototype) {
    if (!goog.string.endsWith(meth, '_')) {
      assertNotUndefined('Should have implemented '+ meth +'()', obj[meth]);
    }
  }
}
">n/a</td></tr>
<tr><td>loosemock_test.html</td><td>Success</td><td> 16 passed, 0 failed.</td><td title="

  goog.require('goog.testing.LooseMock');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.mockmatchers');


  // The object that we will be mocking
  var RealObject = function() {
  };

  RealObject.prototype.a = function() {
    fail('real object should never be called');
  };

  RealObject.prototype.b = function() {
    fail('real object should never be called');
  };

  var mock;

  var stubs;

  function setUp() {
    var obj = new RealObject();
    mock = new goog.testing.LooseMock(obj);
    stubs = new goog.testing.PropertyReplacer();
  }

  function tearDown() {
    stubs.reset();
  }

  /*
   * Calling this method evades the logTestFailure in
   * goog.testing.Mock.prototype.$recordAndThrow, so it doesn't look like the
   * test failed.
   */
  function silenceFailureLogging() {
    if (goog.global['G_testRunner']) {
      stubs.set(goog.global['G_testRunner'],
          'logTestFailure', goog.nullFunction);
    }
  }

  function unsilenceFailureLogging() {
    stubs.reset();
  }

  /**
   * Version of assertThrows that doesn't log the exception generated by the
   * mocks under test.
   * TODO: would be nice to check that a particular substring is in the thrown
   * message so we know it's not something dumb like a syntax error
   */
  function assertThrowsQuiet(var_args) {
    silenceFailureLogging();
    assertThrows.apply(null, arguments);
    unsilenceFailureLogging();
  }

  // Most of the basic functionality is tested in strictmock_test; these tests
  // cover the cases where loose mocks are different from strict mocks
  function testSimpleExpectations() {
    mock.a(5);
    mock.b();
    mock.$replay();
    mock.a(5);
    mock.b();
    mock.$verify();

    mock.$reset();

    mock.a();
    mock.b();
    mock.$replay();
    mock.b();
    mock.a();
    mock.$verify();

    mock.$reset();

    mock.a(5).$times(2);
    mock.a(5);
    mock.a(2);
    mock.$replay();
    mock.a(5);
    mock.a(5);
    mock.a(5);
    mock.a(2);
    mock.$verify();
  }


  function testMultipleExpectations() {
    mock.a().$returns(1);
    mock.a().$returns(2);
    mock.$replay();
    assertEquals(1, mock.a());
    assertEquals(2, mock.a());
    mock.$verify();
  }


  function testMultipleExpectationArgs() {
    mock.a('asdf').$anyTimes();
    mock.a('qwer').$anyTimes();
    mock.b().$times(3);
    mock.$replay();
    mock.a('asdf');
    mock.b();
    mock.a('asdf');
    mock.a('qwer');
    mock.b();
    mock.a('qwer');
    mock.b();
    mock.$verify();

    mock.$reset();

    mock.a('asdf').$anyTimes();
    mock.a('qwer').$anyTimes();
    mock.$replay();
    mock.a('asdf');
    mock.a('qwer');
    goog.bind(mock.a, mock, 'asdf');
    goog.bind(mock.$verify, mock);
  }

  function testSameMethodOutOfOrder() {
    mock.a('foo').$returns(1);
    mock.a('bar').$returns(2);
    mock.$replay();
    assertEquals(2, mock.a('bar'));
    assertEquals(1, mock.a('foo'));
  }

  function testSameMethodDifferentReturnValues() {
    mock.a('foo').$returns(1).$times(2);
    mock.a('foo').$returns(3);
    mock.a('bar').$returns(2);
    mock.$replay();
    assertEquals(1, mock.a('foo'));
    assertEquals(2, mock.a('bar'));
    assertEquals(1, mock.a('foo'));
    assertEquals(3, mock.a('foo'));
    assertThrowsQuiet(function() {
      mock.a('foo');
      mock.$verify();
    });
  }

  function testSameMethodBrokenExpectations() {
    // This is a weird corner case.
    // No way to ever make this verify no matter what you call after replaying,
    // because the second expectation of mock.a('foo') will be masked by
    // the first expectation that can be called any number of times, and so we
    // can never satisfy that second expectation.
    mock.a('foo').$returns(1).$anyTimes();
    mock.a('bar').$returns(2);
    mock.a('foo').$returns(3);

    // LooseMock can detect this case and fail on $replay.
    assertThrowsQuiet(goog.bind(mock.$replay, mock));
    mock.$reset();

    // This is a variant of the corner case above, but it's harder to determine
    // that the expectation to mock.a('bar') can never be satisfied. So we don't
    // fail on $replay, but we do fail on $verify.
    mock.a(goog.testing.mockmatchers.isString).$returns(1).$anyTimes();
    mock.a('bar').$returns(2);
    mock.$replay();

    assertEquals(1, mock.a('foo'));
    assertEquals(1, mock.a('bar'));
    assertThrowsQuiet(goog.bind(mock.$verify, mock));
  }

  function testSameMethodMultipleAnyTimes() {
    mock.a('foo').$returns(1).$anyTimes();
    mock.a('foo').$returns(2).$anyTimes();
    mock.$replay();
    assertEquals(1, mock.a('foo'));
    assertEquals(1, mock.a('foo'));
    assertEquals(1, mock.a('foo'));
    // Note we'll never return 2 but that's ok.
    mock.$verify();
  }

  function testFailingFast() {
    mock.a().$anyTimes();
    mock.$replay();
    mock.a();
    mock.a();
    assertThrowsQuiet(goog.bind(mock.b, mock));
    mock.$reset();

    // too many
    mock.a();
    mock.b();
    mock.$replay();
    mock.a();
    mock.b();

    var message;
    silenceFailureLogging();
    try {
      mock.a();
    } catch (e) {
      message = e.message;
    }
    unsilenceFailureLogging();

    assertTrue('No exception thrown on unexpected call', goog.isDef(message));
    assertContains('Too many calls to a', message);
  }

  function testTimes() {
    mock.a().$times(3);
    mock.b().$times(2);
    mock.$replay();
    mock.a();
    mock.b();
    mock.b();
    mock.a();
    mock.a();
    mock.$verify();
  }


  function testFailingSlow() {
    // not enough
    mock.a().$times(3);
    mock.$replay();
    mock.a();
    mock.a();
    assertThrowsQuiet(goog.bind(mock.$verify, mock));

    mock.$reset();

    // not enough, interleaved order
    mock.a().$times(3);
    mock.b().$times(3);
    mock.$replay();
    mock.a();
    mock.b();
    mock.a();
    mock.b();
    assertThrowsQuiet(goog.bind(mock.$verify, mock));

    mock.$reset();
    // bad args
    mock.a('asdf').$anyTimes();
    mock.$replay();
    mock.a('asdf');
    assertThrowsQuiet(goog.bind(mock.a, mock, 'qwert'));
    assertThrowsQuiet(goog.bind(mock.$verify, mock));
  }


  function testArgsAndReturns() {
    mock.a('asdf').$atLeastOnce().$returns(5);
    mock.b('qwer').$times(2).$returns(3);
    mock.$replay();
    assertEquals(5, mock.a('asdf'));
    assertEquals(3, mock.b('qwer'));
    assertEquals(5, mock.a('asdf'));
    assertEquals(5, mock.a('asdf'));
    assertEquals(3, mock.b('qwer'));
    mock.$verify();
  }


  function testThrows() {
    mock.a().$throws('exception!');
    mock.$replay();
    assertThrowsQuiet(goog.bind(mock.a, mock));
    mock.$verify();
  }


  function testDoes() {
    mock.a(1, 2).$does(function(a, b) {return a + b;});
    mock.$replay();
    assertEquals('Mock should call the function', 3, mock.a(1, 2));
    mock.$verify();
  }

  function testIgnoresExtraCalls() {
    mock = new goog.testing.LooseMock(RealObject, true);
    mock.a();
    mock.$replay();
    mock.a();
    mock.b(); // doesn't throw
    mock.$verify();
  }

  function testSkipAnyTimes() {
    mock = new goog.testing.LooseMock(RealObject);
    mock.a(1).$anyTimes();
    mock.a(2).$anyTimes();
    mock.a(3).$anyTimes();
    mock.$replay();
    mock.a(1);
    mock.a(3);
    mock.$verify();
  }

  function testErrorMessageForBadArgs() {
    mock.a();
    mock.$anyTimes();

    mock.$replay();

    var message;
    silenceFailureLogging();
    try {
      mock.a('a');
    } catch (e) {
      message = e.message;
    }
    unsilenceFailureLogging();

    assertTrue('No exception thrown on verify', goog.isDef(message));
    assertContains('Bad arguments to a()', message);
  }
">n/a</td></tr>
<tr><td>pseudorandom_test.html</td><td>Success</td><td> 2 passed, 0 failed.</td><td title="

  goog.require('goog.testing.PseudoRandom');
  goog.require('goog.testing.jsunit');



  function testInstall() {
    var random = new goog.testing.PseudoRandom(100);
    var originalRandom = Math.random;

    assertFalse(!!random.installed_);

    random.install();
    assertTrue(random.installed_);
    assertNotEquals(Math.random, originalRandom);

    random.uninstall();
    assertFalse(random.installed_);
    assertEquals(originalRandom, Math.random);
  }

  function testRandom() {
    var random = new goog.testing.PseudoRandom(100, true);
    assertEquals(0.002247790043235406, Math.random());
    assertEquals(0.5030723804889388, Math.random());
    assertEquals(0.8068772436163565, Math.random());
    assertEquals(0.7714252865710697, Math.random());
    assertEquals(0.47000723489722573, Math.random());
    assertEquals(0.7192345287533566, Math.random());
    assertEquals(0.16993709732683582, Math.random());
    assertEquals(0.033624989920819824, Math.random());
    assertEquals(0.11188828673232759, Math.random());
    assertEquals(0.959487323992191, Math.random());
    assertEquals(0.41261565794007266, Math.random());
    assertEquals(0.37042378904869727, Math.random());
    assertEquals(0.726719974629303, Math.random());
    assertEquals(0.4998944519829092, Math.random());
    assertEquals(0.4050909653859837, Math.random());
    assertEquals(0.1459898667628944, Math.random());
    assertEquals(0.07685837237074747, Math.random());
    assertEquals(0.030492650793359256, Math.random());
    assertEquals(0.9107450010435443, Math.random());
    assertEquals(0.5719443575274702, Math.random());
    assertEquals(0.3260816232292376, Math.random());
    assertEquals(0.2860344063649913, Math.random());
    assertEquals(0.1668293458478155, Math.random());
    assertEquals(0.01935336909534569, Math.random());
    assertEquals(0.2064792722790407, Math.random());
    assertEquals(0.9609506356262506, Math.random());
    assertEquals(0.04813212235387236, Math.random());
    assertEquals(0.3856775275075161, Math.random());
    assertEquals(0.03993020546828175, Math.random());
    assertEquals(0.47094740919094846, Math.random());
    assertEquals(0.10238883726308114, Math.random());
    assertEquals(0.41156286239234224, Math.random());
    assertEquals(0.5509296189780301, Math.random());
    assertEquals(0.923636159949447, Math.random());
    assertEquals(0.8410754768206976, Math.random());
    assertEquals(0.5543406327830456, Math.random());
    assertEquals(0.5766840905906678, Math.random());
    assertEquals(0.11773664603930258, Math.random());
    assertEquals(0.2656405284851376, Math.random());
    assertEquals(0.7339493122692493, Math.random());
    assertEquals(0.46725172061611736, Math.random());
    assertEquals(0.7078046837927923, Math.random());
    assertEquals(0.43989058002919174, Math.random());
    assertEquals(0.9581870193135442, Math.random());
    assertEquals(0.645608146359543, Math.random());
    assertEquals(0.15083260469093143, Math.random());
    assertEquals(0.840659687127659, Math.random());
    assertEquals(0.4837564718883229, Math.random());
    assertEquals(0.40865381592350314, Math.random());
    assertEquals(0.12834819085342566, Math.random());
    assertEquals(0.49551988588811074, Math.random());
    assertEquals(0.24041126455188305, Math.random());
    assertEquals(0.8921497427923432, Math.random());
    assertEquals(0.9602342842517404, Math.random());
    assertEquals(0.4691342571046254, Math.random());
    random.uninstall();
  }

">n/a</td></tr>
<tr><td>mockcontrol_test.html</td><td>Fail</td><td> undefined</td><td title="


goog.require('goog.async.Deferred');
goog.require('goog.testing.MockControl');
goog.require('goog.testing.async.MockControl');
goog.require('goog.testing.jsunit');
goog.require('goog.testing.testing.asserts');


var mockControl;
var asyncMockControl;

var mockControl2;
var asyncMockControl2;

function setUp() {
  mockControl = new goog.testing.MockControl();
  asyncMockControl = new goog.testing.async.MockControl(mockControl);

  // We need two of these for the tests where we need to verify our meta-test
  // assertions without verifying our tested assertions.
  mockControl2 = new goog.testing.MockControl();
  asyncMockControl2 = new goog.testing.async.MockControl(mockControl2);
}

function assertVerifyFails() {
  assertThrowsJsUnitException(function() { mockControl.$verifyAll(); });
}

function testCreateCallbackMockFailure() {
  asyncMockControl.createCallbackMock('failingCallbackMock', function() {});
  assertVerifyFails();
}

function testCreateCallbackMockSuccess() {
  var callback = asyncMockControl.createCallbackMock(
      'succeedingCallbackMock', function() {});
  callback();
  mockControl.$verifyAll();
}

function testCreateCallbackMockSuccessWithArg() {
  var callback = asyncMockControl.createCallbackMock(
      'succeedingCallbackMockWithArg',
      asyncMockControl.createCallbackMock(
          'metaCallbackMock',
          function(val) { assertEquals(10, val); }));
  callback(10);
  mockControl.$verifyAll();
}

function testCreateCallbackMockSuccessWithArgs() {
  var callback = asyncMockControl.createCallbackMock(
      'succeedingCallbackMockWithArgs',
      asyncMockControl.createCallbackMock(
          'metaCallbackMock', function(val1, val2, val3) {
            assertEquals(10, val1);
            assertEquals('foo', val2);
            assertObjectEquals({foo: 'bar'}, val3);
          }));
  callback(10, 'foo', {foo: 'bar'});
  mockControl.$verifyAll();
}

function testAsyncAssertEqualsFailureNeverCalled() {
  asyncMockControl.asyncAssertEquals('never called', 12);
  assertVerifyFails();
}

function testAsyncAssertEqualsFailureNumberOfArgs() {
  assertThrowsJsUnitException(function() {
    asyncMockControl.asyncAssertEquals('wrong number of args', 12)();
  });
}

function testAsyncAssertEqualsFailureOneArg() {
  assertThrowsJsUnitException(function() {
    asyncMockControl.asyncAssertEquals('wrong arg value', 12)(13);
  });
}

function testAsyncAssertEqualsFailureThreeArgs() {
  assertThrowsJsUnitException(function() {
    asyncMockControl.asyncAssertEquals('wrong arg values', 1, 2, 15)(2, 2, 15);
  });
}

function testAsyncAssertEqualsSuccessNoArgs() {
  asyncMockControl.asyncAssertEquals('should be called')();
  mockControl.$verifyAll();
}

function testAsyncAssertEqualsSuccessThreeArgs() {
  asyncMockControl.asyncAssertEquals('should have args', 1, 2, 3)(1, 2, 3);
  mockControl.$verifyAll();
}

function testAssertDeferredErrorFailureNoError() {
  var deferred = new goog.async.Deferred();
  asyncMockControl.assertDeferredError(deferred, function() {});
  assertVerifyFails();
}

function testAssertDeferredErrorSuccess() {
  var deferred = new goog.async.Deferred();
  asyncMockControl.assertDeferredError(deferred, function() {
    deferred.errback(new Error('FAIL'));
  });
  mockControl.$verifyAll();
}

function testAssertDeferredEqualsFailureActualDeferredNeverResolves() {
  var actual = new goog.async.Deferred();
  asyncMockControl.assertDeferredEquals('doesn\'t resolve', 12, actual);
  assertVerifyFails();
}

function testAssertDeferredEqualsFailureActualDeferredNeverResolvesBoth() {
  var actualDeferred = new goog.async.Deferred();
  var expectedDeferred = new goog.async.Deferred();
  expectedDeferred.callback(12);
  asyncMockControl.assertDeferredEquals(
      'doesn\'t resolve', expectedDeferred, actualDeferred);
  assertVerifyFails();
}

function testAssertDeferredEqualsFailureExpectedDeferredNeverResolves() {
  var expected = new goog.async.Deferred();
  asyncMockControl.assertDeferredEquals('doesn\'t resolve', expected, 12);
  assertVerifyFails();
}

function testAssertDeferredEqualsFailureExpectedDeferredNeverResolvesBoth() {
  var actualDeferred = new goog.async.Deferred();
  var expectedDeferred = new goog.async.Deferred();
  actualDeferred.callback(12);
  asyncMockControl.assertDeferredEquals(
      'doesn\'t resolve', expectedDeferred, actualDeferred);
  assertVerifyFails();
}

function testAssertDeferredEqualsFailureWrongValueActualDeferred() {
  var actual = new goog.async.Deferred();
  asyncMockControl.assertDeferredEquals('doesn\'t resolve', 12, actual);
  asyncMockControl2.assertDeferredError(actual, function() {
    actual.callback(13);
  });
  mockControl2.$verifyAll();
}

function testAssertDeferredEqualsFailureWrongValueExpectedDeferred() {
  var expected = new goog.async.Deferred();
  asyncMockControl.assertDeferredEquals('doesn\'t resolve', expected, 12);
  asyncMockControl2.assertDeferredError(expected, function() {
    expected.callback(13);
  });
  mockControl2.$verifyAll();
}

function testAssertDeferredEqualsFailureWongValueBothDeferred() {
  var actualDeferred = new goog.async.Deferred();
  var expectedDeferred = new goog.async.Deferred();
  asyncMockControl.assertDeferredEquals(
      'different values', expectedDeferred, actualDeferred);
  expectedDeferred.callback(12);
  asyncMockControl2.assertDeferredError(actualDeferred, function() {
    actualDeferred.callback(13);
  });
  assertVerifyFails();
  mockControl2.$verifyAll();
}

function testAssertDeferredEqualsFailureNeitherDeferredEverResolves() {
  var actualDeferred = new goog.async.Deferred();
  var expectedDeferred = new goog.async.Deferred();
  asyncMockControl.assertDeferredEquals(
      'doesn\'t resolve', expectedDeferred, actualDeferred);
  assertVerifyFails();
}

function testAssertDeferredEqualsSuccessActualDeferred() {
  var actual = new goog.async.Deferred();
  asyncMockControl.assertDeferredEquals('should succeed', 12, actual);
  actual.callback(12);
  mockControl.$verifyAll();
}

function testAssertDeferredEqualsSuccessExpectedDeferred() {
  var expected = new goog.async.Deferred();
  asyncMockControl.assertDeferredEquals('should succeed', expected, 12);
  expected.callback(12);
  mockControl.$verifyAll();
}

function testAssertDeferredEqualsSuccessBothDeferred() {
  var actualDeferred = new goog.async.Deferred();
  var expectedDeferred = new goog.async.Deferred();
  asyncMockControl.assertDeferredEquals(
      'should succeed', expectedDeferred, actualDeferred);
  expectedDeferred.callback(12);
  actualDeferred.callback(12);
  mockControl.$verifyAll();
}

">goog.require could not find: goog.testing.testing.asserts
Error: goog.require could not find: goog.testing.testing.asserts
    at Error (unknown source)
    at Object.require (base.js:287:15)
    at _tmpclosuretest.js:8:6
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
    at Module._compile (module.js:287:26)
    at Object..js (module.js:293:10)
</td></tr>
<tr><td>mockmatchers_test.html</td><td>Fail</td><td> 16 passed, 2 failed.</td><td title="

  goog.require('goog.dom');
  goog.require('goog.testing.FunctionMock');
  goog.require('goog.testing.mockmatchers');
  goog.require('goog.testing.jsunit');


  // A local reference to the mockmatchers namespace.
  var matchers = goog.testing.mockmatchers;

  // Simple classes to test the InstanceOf matcher.
  var foo = function() {};
  var bar = function() {};

  // Simple class to test adding error messages to
  // MockExpectation objects
  function MockMock() {
    this.errorMessages = [];
  }

  var mockExpect = null;

  MockMock.prototype.addErrorMessage = function(msg) {
    this.errorMessages.push(msg);
  };


  MockMock.prototype.getErrorMessageCount = function() {
    return this.errorMessages.length;
  };


  function setUp() {
    mockExpect = new MockMock();
  }


  function testNoMatchName() {
    // A matcher that does not fill in the match name
    var matcher = new goog.testing.mockmatchers.ArgumentMatcher(goog.isString);

    // Make sure the lack of match name doesn't affect the ability
    // to return True/False
    assertTrue(matcher.matches('hello'));
    assertFalse(matcher.matches(123));

    // Make sure we handle the lack of a match name
    assertFalse(matcher.matches(456, mockExpect));
    assertEquals(1, mockExpect.errorMessages.length);
    assertEquals("Expected: missing mockmatcher description " +
        "but was: <456> (Number)", mockExpect.errorMessages[0]);
  }


  function testInstanceOf() {
    var matcher = new matchers.InstanceOf(foo);
    assertTrue(matcher.matches(new foo()));
    assertFalse(matcher.matches(new bar()));

    assertFalse(matcher.matches(new bar(), mockExpect));
    assertEquals(1, mockExpect.errorMessages.length);
    assertEquals("Expected: instanceOf() " +
        "but was: <[object Object]> (Object)",
        mockExpect.errorMessages[0]);
  }


  function testTypeOf() {
    var matcher = new matchers.TypeOf('number');
    assertTrue(matcher.matches(1));
    assertTrue(matcher.matches(2));
    assertFalse(matcher.matches('test'));

    assertFalse(matcher.matches(true, mockExpect));
    assertEquals(1, mockExpect.errorMessages.length);
    assertEquals("Expected: typeOf(number) but was: <true> (Boolean)",
        mockExpect.errorMessages[0]);
  }


  function testRegexpMatch() {
    var matcher = new matchers.RegexpMatch(/^cho[dtp]/);
    assertTrue(matcher.matches('chodhop'));
    assertTrue(matcher.matches('chopper'));
    assertFalse(matcher.matches('chocolate'));
    assertFalse(matcher.matches(null));

    assertFalse(matcher.matches('an anger', mockExpect));
    assertEquals(1, mockExpect.errorMessages.length);
    assertEquals('Expected: match(/^cho[dtp]/) but was: <an anger> (String)',
        mockExpect.errorMessages[0]);
  }


  function testObjectEquals() {
    // Test a simple match.
    var simpleMatcher = new matchers.ObjectEquals({name: 'Bob', age: 42});
    assertTrue(simpleMatcher.matches({name: 'Bob', age: 42}, mockExpect));
    assertEquals(0, mockExpect.getErrorMessageCount());
    expectObjectEqualsFailure(simpleMatcher, {name: 'Bill', age: 42},
        'name expected <Bob> (String) but was <Bill> (String)');
    expectObjectEqualsFailure(simpleMatcher, {name: 'Bob', age: 21},
        'age expected <42> (Number) but was <21> (Number)');
    expectObjectEqualsFailure(simpleMatcher, {name: 'Bob'},
        'property age not present in actual Object');
    expectObjectEqualsFailure(simpleMatcher,
        {name: 'Bob', age: 42, country: 'USA'},
        'property country not present in expected Object');

    // Multiple mismatches should include multiple messages.
    expectObjectEqualsFailure(simpleMatcher, {name: 'Jim', age: 36},
        'name expected <Bob> (String) but was <Jim> (String)\n' +
        '   age expected <42> (Number) but was <36> (Number)');
  }

  function testComplexObjectEquals() {
    var complexMatcher = new matchers.ObjectEquals(
        {a: 'foo', b: 2, c: ['bar', 3], d: {sub1: 'baz', sub2: -1}});
    assertTrue(complexMatcher.matches(
        {a: 'foo', b: 2, c: ['bar', 3], d: {sub1: 'baz', sub2: -1}}));
    expectObjectEqualsFailure(complexMatcher,
        {a: 'foo', b: 2, c: ['bar', 3], d: {sub1: 'zap', sub2: -1}},
        'sub1 expected <baz> (String) but was <zap> (String)');
    expectObjectEqualsFailure(complexMatcher,
        {a: 'foo', b: 2, c: ['bar', 6], d: {sub1: 'baz', sub2: -1}},
        'c[1] expected <3> (Number) but was <6> (Number)');
  }


  function testSaveArgument() {
    var saveMatcher = new matchers.SaveArgument();
    assertTrue(saveMatcher.matches(42));
    assertEquals(42, saveMatcher.arg);

    saveMatcher = new matchers.SaveArgument(goog.isString);
    assertTrue(saveMatcher.matches('test'));
    assertEquals('test', saveMatcher.arg);
    assertFalse(saveMatcher.matches(17));
    assertEquals(17, saveMatcher.arg);

    saveMatcher = new matchers.SaveArgument(new matchers.ObjectEquals({
      value: 'value'
    }));
    assertTrue(saveMatcher.matches({ value: 'value' }));
    assertEquals('value', saveMatcher.arg.value);
    assertFalse(saveMatcher.matches('test'));
    assertEquals('test', saveMatcher.arg);
  }


  function testIsArray() {
    assertTrue(matchers.isArray.matches([]));
    assertTrue(matchers.isArray.matches(new Array()));
    assertFalse(matchers.isArray.matches('test'));

    assertFalse(matchers.isArray.matches({}, mockExpect));
    assertEquals(1, mockExpect.errorMessages.length);
    assertEquals("Expected: isArray but was: <[object Object]> (Object)",
        mockExpect.errorMessages[0]);
  }


  function testIsArrayLike() {
    var nodeList = (function() {
      var div = document.createElement('div');
      div.appendChild(document.createElement('p'));
      div.appendChild(document.createElement('p'));
      return div.getElementsByTagName('div');
    })();

    assertTrue(matchers.isArrayLike.matches([]));
    assertTrue(matchers.isArrayLike.matches(new Array()));
    assertTrue(matchers.isArrayLike.matches(nodeList));
    assertFalse(matchers.isArrayLike.matches('test'));

    assertFalse(matchers.isArrayLike.matches(3, mockExpect));
    assertEquals(1, mockExpect.errorMessages.length);
    assertEquals("Expected: isArrayLike but was: <3> (Number)",
        mockExpect.errorMessages[0]);
  }


  function testIsDateLike() {
    assertTrue(matchers.isDateLike.matches(new Date()));
    assertFalse(matchers.isDateLike.matches('test'));

    assertFalse(matchers.isDateLike.matches('test', mockExpect));
    assertEquals(1, mockExpect.errorMessages.length);
    assertEquals("Expected: isDateLike but was: <test> (String)",
        mockExpect.errorMessages[0]);
  }


  function testIsString() {
    assertTrue(matchers.isString.matches('a'));
    assertTrue(matchers.isString.matches('b'));
    assertFalse(matchers.isString.matches(null));

    assertFalse(matchers.isString.matches(null, mockExpect));
    assertEquals(1, mockExpect.errorMessages.length);
    assertEquals("Expected: isString but was: <null>",
        mockExpect.errorMessages[0]);
  }


  function testIsBoolean() {
    assertTrue(matchers.isBoolean.matches(true));
    assertTrue(matchers.isBoolean.matches(false));
    assertFalse(matchers.isBoolean.matches(null));

    assertFalse(matchers.isBoolean.matches([], mockExpect));
    assertEquals(1, mockExpect.errorMessages.length);
    assertEquals("Expected: isBoolean but was: <> (Array)",
        mockExpect.errorMessages[0]);
  }


  function testIsNumber() {
    assertTrue(matchers.isNumber.matches(-1));
    assertTrue(matchers.isNumber.matches(1));
    assertTrue(matchers.isNumber.matches(1.25));
    assertFalse(matchers.isNumber.matches(null));

    assertFalse(matchers.isNumber.matches('hello', mockExpect));
    assertEquals(1, mockExpect.errorMessages.length);
    assertEquals("Expected: isNumber but was: <hello> (String)",
        mockExpect.errorMessages[0]);
  }


  function testIsFunction() {
    assertTrue(matchers.isFunction.matches(function() {}));
    assertFalse(matchers.isFunction.matches('test'));

    assertFalse(matchers.isFunction.matches({}, mockExpect));
    assertEquals(1, mockExpect.errorMessages.length);
    assertEquals("Expected: isFunction but was: <[object Object]> (Object)",
        mockExpect.errorMessages[0]);
  }


  function testIsObject() {
    assertTrue(matchers.isObject.matches({}));
    assertTrue(matchers.isObject.matches(new Object()));
    assertTrue(matchers.isObject.matches(new function() {}));
    assertTrue(matchers.isObject.matches([]));
    assertTrue(matchers.isObject.matches(new Array()));
    assertTrue(matchers.isObject.matches(function() {}));
    assertFalse(matchers.isObject.matches(null));

    assertFalse(matchers.isObject.matches(1234, mockExpect));
    assertEquals(1, mockExpect.errorMessages.length);
    assertEquals("Expected: isObject but was: <1234> (Number)",
        mockExpect.errorMessages[0]);
  }


  function testIsNodeLike() {
    assertFalse(matchers.isNodeLike.matches({}));
    assertFalse(matchers.isNodeLike.matches(1));
    assertFalse(matchers.isNodeLike.matches(function() {}));
    assertFalse(matchers.isNodeLike.matches(false));
    assertTrue(matchers.isNodeLike.matches(document.body));
    assertTrue(matchers.isNodeLike.matches(goog.dom.getElement('someDiv')));

    assertFalse(matchers.isNodeLike.matches('test', mockExpect));
    assertEquals(1, mockExpect.errorMessages.length);
    assertEquals("Expected: isNodeLike but was: <test> (String)",
        mockExpect.errorMessages[0]);
  }


  function testIgnoreArgumentsMatcher() {
    // ignoreArgument always returns true:
    assertTrue(matchers.ignoreArgument.matches());
    assertTrue(matchers.ignoreArgument.matches(356));
    assertTrue(matchers.ignoreArgument.matches('str'));
    assertTrue(matchers.ignoreArgument.matches(['array', 123, false]));
    assertTrue(matchers.ignoreArgument.matches({'map': 1, key2: 'value2'}));
  }


  function testFlexibleArrayMatcher() {
    // Test that basic lists are verified properly.
    var a1 = [1, 'test'];
    var a2 = [1, 'test'];
    var a3 = [1, 'test', 'extra'];
    assertTrue(matchers.flexibleArrayMatcher(a1, a2));
    assertFalse(matchers.flexibleArrayMatcher(a1, a3));

    // Test that basic lists with basic class instances are verified properly.
    var instance = new foo();
    a1 = [1, 'test', instance];
    a2 = [1, 'test', instance];
    a3 = [1, 'test', new foo()];
    assertTrue(matchers.flexibleArrayMatcher(a1, a2));
    assertTrue(matchers.flexibleArrayMatcher(a1, a3));

    // Create an argument verifier that returns a consistent value.
    var verifyValue = true;
    var argVerifier = function() {};
    goog.inherits(argVerifier, matchers.ArgumentMatcher);
    argVerifier.prototype.matches = function(arg) {
      return verifyValue;
    };

    // Test that the arguments are always verified when the verifier returns
    // true.
    a1 = [1, 'test', new argVerifier()];
    a2 = [1, 'test', 'anything'];
    a3 = [1, 'test', 12345];
    assertTrue(matchers.flexibleArrayMatcher(a1, a2));
    assertTrue(matchers.flexibleArrayMatcher(a1, a3));

    // Now test the case when then verifier returns false.
    verifyValue = false;
    assertFalse(matchers.flexibleArrayMatcher(a1, a2));
    assertFalse(matchers.flexibleArrayMatcher(a1, a3));

    // And test we report errors back up via the opt_expectation
    assertFalse(matchers.flexibleArrayMatcher(a2, a3, mockExpect));
    assertEquals(1, mockExpect.errorMessages.length);
    assertEquals(
        'Expected <anything> (String) but was <12345> (Number)\n' +
        '    expected <anything> (String) but was <12345> (Number)',
        mockExpect.errorMessages[0]);

    // And test we report errors found via the matcher
    a1 = [1, goog.testing.mockmatchers.isString ];
    a2 = [1, 'test string'];
    a3 = [1, null];
    assertTrue(matchers.flexibleArrayMatcher(a1, a2, mockExpect));
    assertFalse(matchers.flexibleArrayMatcher(a1, a3, mockExpect));
    // Old error is still there
    assertEquals(2, mockExpect.errorMessages.length);
    assertEquals(
        'Expected <anything> (String) but was <12345> (Number)\n' +
        '    expected <anything> (String) but was <12345> (Number)',
        mockExpect.errorMessages[0]);
    // plus the new error...
    assertEquals("Expected: isString but was: <null>",
        mockExpect.errorMessages[1]);
  }


  /**
   * Utility method for checking for an ObjectEquals match failure.  Checks that
   * the expected error message was included in the error messages appended to
   * the expectation object.
   * @param {goog.testing.mockmatchers.ArgumentMatcher.ObjectEquals} matcher
   *     The matcher to test against.
   * @param {Object} matchObject The object to compare.
   * @param {string=} opt_errorMsg The deep object comparison failure message
   *     to check for.
   */
  function expectObjectEqualsFailure(matcher, matchObject, opt_errorMsg) {
    mockExpect.errorMessages = [];
    assertFalse(matcher.matches(matchObject, mockExpect));
    assertNotEquals(0, mockExpect.getErrorMessageCount());
    if (opt_errorMsg) {
      assertContains(opt_errorMsg, mockExpect.errorMessages[0]);
    }
  }
">18 of 18 tests run in 10ms.<br />16 passed, 2 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testIsArrayLike<br />Object #<Object> has no method 'createElement'<br />ERROR in testIsNodeLike<br />Call to assertTrue(boolean) with false<br />> assertTrue at testing/asserts.js:261:3<br />> testIsNodeLike at _tmpclosuretest.js:264:5<br /></td></tr>
<tr><td>continuationtestcase_test.html</td><td>Fail</td><td> 0 passed, 12 failed.</td><td title="

goog.require('goog.events');
goog.require('goog.events.EventTarget');
goog.require('goog.testing.ContinuationTestCase');
goog.require('goog.testing.MockClock');
goog.require('goog.testing.PropertyReplacer');
goog.require('goog.testing.TestCase.Test');
goog.require('goog.testing.jsunit');


/**
 * @fileoverview This test file uses the ContinuationTestCase to test itself,
 * which is a little confusing. It's also difficult to write a truly effective
 * test, since testing a failure causes an actual failure in the test runner.
 * All tests have been manually verified using a sophisticated combination of
 * alerts and false assertions.
 */

var testCase = new goog.testing.ContinuationTestCase('Continuation Test Case');
testCase.autoDiscoverTests();

// Standalone Closure Test Runner.
if (typeof G_testRunner != 'undefined') {
  G_testRunner.initialize(testCase);
}


var clock = new goog.testing.MockClock();
var count = 0;
var stubs = new goog.testing.PropertyReplacer();


function setUpPage() {
  count = testCase.getCount();
}


/**
 * Resets the mock clock. Includes a wait step to verify that setUp routines
 * can contain continuations.
 */
function setUp() {
  waitForTimeout(function() {
    // Pointless assertion to verify that setUp methods can contain waits.
    assertEquals(count, testCase.getCount());
  }, 0);

  clock.reset();
}


/**
 * Uninstalls the mock clock if it was installed, and restores the Step timeout
 * functions to the default window implementations.
 */
function tearDown() {
  clock.uninstall();
  stubs.reset();

  waitForTimeout(function() {
    // Pointless assertion to verify that tearDown methods can contain waits.
    assertTrue(testCase.now_() >= testCase.startTime_);
  }, 0);
}


/**
 * Installs the Mock Clock and replaces the Step timeouts with the mock
 * implementations.
 */
function installMockClock() {
  clock.install();

  // Overwrite the "protected" setTimeout and clearTimeout with the versions
  // replaced by MockClock. Normal tests should never do this, but we need to
  // test the ContinuationTest itself.
  stubs.set(goog.testing.ContinuationTestCase.Step, 'protectedClearTimeout_',
            window.clearTimeout);
  stubs.set(goog.testing.ContinuationTestCase.Step, 'protectedSetTimeout_',
            window.setTimeout);
}


/**
 * @return {goog.testing.ContinuationTestCase.Step} A generic step in a
 *     continuation test.
 */
function getSampleStep() {
  return new goog.testing.ContinuationTestCase.Step('test', function() {});
}


/**
 * @return {goog.testing.ContinuationTestCase.Test} A simple continuation test
 *     with generic setUp, test, and tearDown functions.
 */
function getSampleTest() {
  var setupStep = new goog.testing.TestCase.Test('setup', function() {})
  var testStep = new goog.testing.TestCase.Test('test', function() {})
  var teardownStep = new goog.testing.TestCase.Test('teardown', function() {})

  return new goog.testing.ContinuationTestCase.Test(setupStep,
                                                    testStep,
                                                    teardownStep);
}


function testStepWaiting() {
  var step = getSampleStep();
  assertTrue(step.waiting);
}


function testStepSetTimeout() {
  installMockClock();
  var step = getSampleStep();

  var timeoutReached = false;
  step.setTimeout(function() {timeoutReached = true}, 100);

  clock.tick(50);
  assertFalse(timeoutReached);
  clock.tick(50);
  assertTrue(timeoutReached);
}


function testStepClearTimeout() {
  var step = new goog.testing.ContinuationTestCase.Step('test', function() {});

  var timeoutReached = false;
  step.setTimeout(function() {timeoutReached = true}, 100);

  clock.tick(50);
  assertFalse(timeoutReached);
  step.clearTimeout();
  clock.tick(50);
  assertFalse(timeoutReached);
}


function testTestPhases() {
  var test = getSampleTest();

  assertEquals('setup', test.getCurrentPhase()[0].name);
  test.cancelCurrentPhase();

  assertEquals('test', test.getCurrentPhase()[0].name);
  test.cancelCurrentPhase();

  assertEquals('teardown', test.getCurrentPhase()[0].name);
  test.cancelCurrentPhase();

  assertNull(test.getCurrentPhase());
}


function testTestSetError() {
  var test = getSampleTest();

  var error1 = new Error('Oh noes!');
  var error2 = new Error('B0rken.');

  assertNull(test.getError());
  test.setError(error1);
  assertEquals(error1, test.getError());
  test.setError(error2);
  assertEquals('Once an error has been set, it should not be overwritten.',
               error1, test.getError());
}


function testAddStep() {
  var test = getSampleTest();
  var step = getSampleStep();

  // Try adding a step to each phase and then cancelling the phase.
  for (var i = 0; i < 3; i++) {
    assertEquals(1, test.getCurrentPhase().length);
    test.addStep(step);

    assertEquals(2, test.getCurrentPhase().length);
    assertEquals(step, test.getCurrentPhase()[1]);
    test.cancelCurrentPhase();
  }

  assertNull(test.getCurrentPhase());
}


function testCancelTestPhase() {
  var test = getSampleTest();

  test.cancelTestPhase();
  assertEquals('teardown', test.getCurrentPhase()[0].name);

  test = getSampleTest();
  test.cancelCurrentPhase();
  test.cancelTestPhase();
  assertEquals('teardown', test.getCurrentPhase()[0].name);

  test = getSampleTest();
  test.cancelTestPhase();
  test.cancelTestPhase();
  assertEquals('teardown', test.getCurrentPhase()[0].name);
}


function testWaitForTimeout() {
  var reachedA = false;
  var reachedB = false;
  var reachedC = false;

  waitForTimeout(function a() {
    reachedA = true;

    assertTrue('A must be true at callback a.', reachedA);
    assertFalse('B must be false at callback a.', reachedB);
    assertFalse('C must be false at callback a.', reachedC);
  }, 10);

  waitForTimeout(function b() {
    reachedB = true;

    assertTrue('A must be true at callback b.', reachedA);
    assertTrue('B must be true at callback b.', reachedB);
    assertFalse('C must be false at callback b.', reachedC);
  }, 20);

  waitForTimeout(function c() {
    reachedC = true;

    assertTrue('A must be true at callback c.', reachedA);
    assertTrue('B must be true at callback c.', reachedB);
    assertTrue('C must be true at callback c.', reachedC);
  }, 20);

  assertFalse('a', reachedA);
  assertFalse('b', reachedB);
  assertFalse('c', reachedC);
}


function testWaitForEvent() {
  var et = new goog.events.EventTarget();

  var eventFired = false;
  goog.events.listen(et, 'testPrefire', function() {
    eventFired = true;
    et.dispatchEvent('test');
  });

  waitForEvent(et, 'test', function() {
    assertTrue(eventFired);
  });

  et.dispatchEvent('testPrefire');
}


function testWaitForCondition() {
  var counter = 0;

  waitForCondition(function() {
    return ++counter >= 3;
  }, function() {
    assertEquals(3, counter);
  }, 10, 100);
}


function testOutOfOrderWaits() {
  var counter = 0;
  waitForTimeout(function() {assertEquals(5, ++counter);}, 50);
  waitForTimeout(function() {assertEquals(1, ++counter);}, 10);
  waitForTimeout(function() {assertEquals(3, ++counter);}, 30);
  waitForTimeout(function() {assertEquals(2, ++counter);}, 20);
  waitForTimeout(function() {assertEquals(4, ++counter);}, 40);
}


/*
 * Any of the test functions below (except the condition check passed into
 * waitForCondition) can raise an assertion successfully. Any level of nested
 * test steps should be possible, in any configuration.
 */

var testObj;


function testCrazyNestedWaitFunction() {
  testObj = {
    lock: true,
    et: new goog.events.EventTarget(),
    steps: 0
  }

  waitForTimeout(handleTimeout, 10);
  waitForEvent(testObj.et, 'test', handleEvent);
  waitForCondition(condition, handleCondition, 1);
}

function handleTimeout() {
  testObj.steps++;
  assertEquals('handleTimeout should be called first.', 1, testObj.steps);
  waitForTimeout(fireEvent, 10);
}

function fireEvent() {
  testObj.steps++;
  assertEquals('fireEvent should be called second.', 2, testObj.steps);
  testObj.et.dispatchEvent('test');
}

function handleEvent() {
  testObj.steps++;
  assertEquals('handleEvent should be called third.', 3, testObj.steps);
  testObj.lock = false;
}

function condition() {
  return !testObj.lock;
}

function handleCondition() {
  assertFalse(testObj.lock);
  testObj.steps++;
  assertEquals('handleCondition should be called last.', 4, testObj.steps);
}

">12 of 12 tests run in 10ms.<br />0 passed, 12 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testAddStep<br />waitForTimeout is not defined<br />ERROR in testCancelTestPhase<br />waitForTimeout is not defined<br />ERROR in testCrazyNestedWaitFunction<br />waitForTimeout is not defined<br />ERROR in testOutOfOrderWaits<br />waitForTimeout is not defined<br />ERROR in testStepClearTimeout<br />waitForTimeout is not defined<br />ERROR in testStepSetTimeout<br />waitForTimeout is not defined<br />ERROR in testStepWaiting<br />waitForTimeout is not defined<br />ERROR in testTestPhases<br />waitForTimeout is not defined<br />ERROR in testTestSetError<br />waitForTimeout is not defined<br />ERROR in testWaitForCondition<br />waitForTimeout is not defined<br />ERROR in testWaitForEvent<br />waitForTimeout is not defined<br />ERROR in testWaitForTimeout<br />waitForTimeout is not defined<br /></td></tr>
<tr><td>deferredtestcase_test.html</td><td>Fail</td><td> 1 passed, 4 failed.</td><td title="


    goog.require('goog.async.Deferred');
    goog.require('goog.testing.DeferredTestCase');
    goog.require('goog.testing.TestRunner');
    goog.require('goog.testing.jsunit');
  

    var deferredTestCase =
        goog.testing.DeferredTestCase.createAndInstall(document.title);
    var testTestCase;
    var runner;

    // Optionally, set a longer-than-usual step timeout.
    deferredTestCase.stepTimeout = 15 * 1000; // 15 seconds

    // This is the sample code in deferredtestcase.js
    function testDeferredCallbacks() {
      var callbackTime = goog.now();
      var callbacks = new goog.async.Deferred();
      deferredTestCase.addWaitForAsync('Waiting for 1st callback', callbacks);
      callbacks.addCallback(
          function() {
            assertTrue(
                'We\'re going back in time!', goog.now() >= callbackTime);
            callbackTime = goog.now();
          });
      deferredTestCase.addWaitForAsync('Waiting for 2nd callback', callbacks);
      callbacks.addCallback(
          function() {
            assertTrue(
                'We\'re going back in time!', goog.now() >= callbackTime);
            callbackTime = goog.now();
          });
      deferredTestCase.addWaitForAsync('Waiting for last callback', callbacks);
      callbacks.addCallback(
          function() {
            assertTrue(
                'We\'re going back in time!', goog.now() >= callbackTime);
            callbackTime = goog.now();
          });

      deferredTestCase.waitForDeferred(callbacks);
    }

    function createDeferredTestCase(d) {
      testTestCase = new goog.testing.DeferredTestCase('Foobar TestCase');
      testTestCase.add(new goog.testing.TestCase.Test(
        'Foobar Test',
        function() {
          this.waitForDeferred(d);
        },
        testTestCase));

      var testCompleteCallback = new goog.async.Deferred();
      testTestCase.setCompletedCallback(
          function() {
            testCompleteCallback.callback(true);
          });

      // We're not going to use the runner to run the test, but we attach one
      // here anyway because without a runner TestCase throws an exception in
      // finalize().
      var runner = new goog.testing.TestRunner();
      runner.initialize(testTestCase);

      return testCompleteCallback;
    }

    function testDeferredWait() {
      var d = new goog.async.Deferred();
      deferredTestCase.addWaitForAsync('Foobar', d);
      d.addCallback(function() {
        return goog.async.Deferred.succeed(true);
      });
      deferredTestCase.waitForDeferred(d);
    }

    function testNonAsync() {
      assertTrue(true);
    }

    function testPassWithTestRunner() {
      var d = new goog.async.Deferred();
      d.addCallback(function() {
        return goog.async.Deferred.succeed(true);
        //return goog.async.Deferred.fail(true);
        //return new goog.async.Deferred();
      });

      var testCompleteDeferred = createDeferredTestCase(d);
      testTestCase.execute();

      var deferredCallbackOnPass = new goog.async.Deferred();
      deferredCallbackOnPass.addCallback(function() {
        return testCompleteDeferred;
      });
      deferredCallbackOnPass.addCallback(function() {
        assertTrue('Test case should have succeded.', testTestCase.isSuccess());
      });

      deferredTestCase.waitForDeferred(deferredCallbackOnPass);
    }

    function testFailWithTestRunner() {
      var d = new goog.async.Deferred();
      d.addCallback(function() {
        return goog.async.Deferred.fail(true);
      });

      var testCompleteDeferred = createDeferredTestCase(d);

      // Override and consume test exception
      var origFn = testTestCase.doAsyncError;
      testTestCase.doAsyncError = function() {
        try {
          origFn();
        } catch (e) {
          testCompleteDeferred.callback(true);
        }
      }
      testTestCase.execute();

      var deferredCallbackOnFail = new goog.async.Deferred();
      deferredCallbackOnFail.addCallback(function() {
        return testCompleteDeferred;
      });
      deferredCallbackOnFail.addCallback(function() {
        assertTrue('Test case should have failed.', !testTestCase.isSuccess());
      });

      deferredTestCase.waitForDeferred(deferredCallbackOnFail);
    }

  ">Error
    at [object Object].<anonymous> (debug/error.js:37:16)
    at new <anonymous> (../../third_party/closure/goog/mochikit/async/deferred.js:487:20)
    at [object Object].check_ (../../third_party/closure/goog/mochikit/async/deferred.js:202:13)
    at [object Object].callback (../../third_party/closure/goog/mochikit/async/deferred.js:215:8)
    at [object Object].doAsyncError (_tmpclosuretest.js:120:32)
    at [object Object].doTopOfStackAsyncError_ (testing/asynctestcase.js:473:10)
    at [object Object].<anonymous> (testing/asynctestcase.js:619:12)
    at Object._onTimeout (native)
    at Timer.callback (timers.js:62:39)
</td></tr>
<tr><td>recordfunction_test.html</td><td>Success</td><td> 6 passed, 0 failed.</td><td title="

  goog.require('goog.functions');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.recordConstructor');
  goog.require('goog.testing.recordFunction');



var stubs = new goog.testing.PropertyReplacer();

function tearDown() {
  stubs.reset();
}

function testNoCalls() {
  var f = goog.testing.recordFunction(goog.functions.identity);
  assertEquals('call count', 0, f.getCallCount());
  assertNull('last call', f.getLastCall());
  assertArrayEquals('all calls', [], f.getCalls());
}

function testWithoutArguments() {
  var f = goog.testing.recordFunction();
  assertUndefined('f(1)', f(1));
  assertEquals('call count', 1, f.getCallCount());
  var lastCall = f.getLastCall();
  assertEquals('original function', goog.nullFunction, lastCall.getFunction());
  assertEquals('this context', window, lastCall.getThis());
  assertArrayEquals('arguments', [1], lastCall.getArguments());
  assertEquals('arguments[0]', 1, lastCall.getArgument(0));
  assertUndefined('arguments[1]', lastCall.getArgument(1));
  assertUndefined('return value', lastCall.getReturnValue());
}

function testWithIdentityFunction() {
  var f = goog.testing.recordFunction(goog.functions.identity);
  var dummyThis = {};
  assertEquals('f(1)', 1, f(1));
  assertEquals('f.call(dummyThis, 2)', 2, f.call(dummyThis, 2));

  var calls = f.getCalls();
  var firstCall = calls[0];
  var lastCall = f.getLastCall();
  assertEquals('call count', 2, f.getCallCount());
  assertEquals('last call', calls[1], lastCall);
  assertEquals('original function', goog.functions.identity,
      lastCall.getFunction());
  assertEquals('this context of first call', window, firstCall.getThis());
  assertEquals('this context of last call', dummyThis, lastCall.getThis());
  assertArrayEquals('arguments of the first call', [1],
      firstCall.getArguments());
  assertArrayEquals('arguments of the last call', [2], lastCall.getArguments());
  assertEquals('return value of the first call', 1, firstCall.getReturnValue());
  assertEquals('return value of the last call', 2, lastCall.getReturnValue());
  assertNull('error thrown by the first call', firstCall.getError());
  assertNull('error thrown by the last call', lastCall.getError());
}

function testWithErrorFunction() {
  var f = goog.testing.recordFunction(goog.functions.error('error'));

  var error = assertThrows('f(1) should throw an error', function() {
    f(1);
  });
  assertEquals('error message', 'error', error.message);
  assertEquals('call count', 1, f.getCallCount());
  var lastCall = f.getLastCall();
  assertEquals('this context', window, lastCall.getThis());
  assertArrayEquals('arguments', [1], lastCall.getArguments());
  assertUndefined('return value', lastCall.getReturnValue());
  assertEquals('recorded error message', 'error', lastCall.getError().message);
}

function testWithClass() {
  var ns = {};
  /** @constructor */
  ns.TestClass = function(num) {
    this.setX(ns.TestClass.identity(1) + num);
  }
  ns.TestClass.prototype.setX = function(x) {
    this.x = x;
  };
  ns.TestClass.identity = function(x) {
    return x;
  };
  var originalNsTestClass = ns.TestClass;

  stubs.set(ns, 'TestClass', goog.testing.recordConstructor(ns.TestClass));
  stubs.set(ns.TestClass.prototype, 'setX',
      goog.testing.recordFunction(ns.TestClass.prototype.setX));
  stubs.set(ns.TestClass, 'identity',
      goog.testing.recordFunction(ns.TestClass.identity));

  var obj = new ns.TestClass(2);
  assertEquals('constructor is called once', 1, ns.TestClass.getCallCount());
  var lastConstructorCall = ns.TestClass.getLastCall();
  assertArrayEquals('... with argument 2', [2],
      lastConstructorCall.getArguments());
  assertEquals('the created object', obj, lastConstructorCall.getThis());
  assertEquals('type of the created object', originalNsTestClass,
      obj.constructor);

  assertEquals('setX is called once', 1, obj.setX.getCallCount());
  assertArrayEquals('... with argument 3', [3],
      obj.setX.getLastCall().getArguments());
  assertEquals('The x field is properly set', 3, obj.x);

  assertEquals('identity is called once', 1,
      ns.TestClass.identity.getCallCount());
  assertArrayEquals('... with argument 1', [1],
      ns.TestClass.identity.getLastCall().getArguments());
}

function testPopLastCall() {
  var f = goog.testing.recordFunction();
  f(0);
  f(1);

  var firstCall = f.getCalls()[0];
  var lastCall = f.getCalls()[1];
  assertEquals('return value of popLastCall', lastCall, f.popLastCall());
  assertArrayEquals('1 call remains', [firstCall], f.getCalls());
  assertEquals('next return value of popLastCall', firstCall, f.popLastCall());
  assertArrayEquals('0 calls remain', [], f.getCalls());
  assertNull('no more calls to pop', f.popLastCall());
}

">n/a</td></tr>
<tr><td>mock_test.html</td><td>Success</td><td> 9 passed, 0 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.object');
  goog.require('goog.testing.Mock');
  goog.require('goog.testing.MockExpectation');
  goog.require('goog.testing.jsunit');



  // The object that we will be mocking
  var RealObject = function() {
  };

  RealObject.prototype.a = function() {
    fail('real object should never be called');
  };

  RealObject.prototype.b = function() {
    fail('real object should never be called');
  };

  var matchers = goog.testing.mockmatchers;
  var mock;

  function setUp() {
    var obj = new RealObject();
    mock = new goog.testing.Mock(obj);
  }

  function testMockErrorMessage() {
    var expectation = new goog.testing.MockExpectation('a');
    assertEquals(0, expectation.getErrorMessageCount());
    assertEquals('', expectation.getErrorMessage());

    expectation.addErrorMessage('foo failed');
    assertEquals(1, expectation.getErrorMessageCount());
    assertEquals('foo failed', expectation.getErrorMessage());

    expectation.addErrorMessage('bar failed');
    assertEquals(2, expectation.getErrorMessageCount());
    assertEquals('foo failed\nbar failed', expectation.getErrorMessage());
  }

  function testVerifyArgumentList() {
    var expectation = new goog.testing.MockExpectation('a');
    assertEquals('', expectation.getErrorMessage());

    // test single string arg
    expectation.argumentList = ['foo'];
    assertTrue(mock.$verifyCall(expectation, 'a', ['foo']));

    // single numeric arg
    expectation.argumentList = [2]
    assertTrue(mock.$verifyCall(expectation, 'a', [2]));

    // single object arg (using standard === comparison)
    var obj = {prop1: 'prop1', prop2: 2};
    expectation.argumentList = [obj];
    assertTrue(mock.$verifyCall(expectation, 'a', [obj]));

    // make sure comparison succeeds if args are similar, but not ===
    var obj2 = {prop1: 'prop1', prop2: 2};
    expectation.argumentList = [obj];
    assertTrue(mock.$verifyCall(expectation, 'a', [obj2]));
    assertEquals('', expectation.getErrorMessage());

    // multiple args
    expectation.argumentList = ['foo', 2, obj, obj2];
    assertTrue(mock.$verifyCall(expectation, 'a', ['foo', 2, obj, obj2]));

    // test flexible arg matching.
    expectation.argumentList = ['foo', matchers.isNumber];
    assertTrue(mock.$verifyCall(expectation, 'a', ['foo', 1]));

    expectation.argumentList = [new matchers.InstanceOf(RealObject)];
    assertTrue(mock.$verifyCall(expectation, 'a', [new RealObject()]));
  }


  function testRegisterArgumentListVerifier() {
    var expectationA = new goog.testing.MockExpectation('a');
    var expectationB = new goog.testing.MockExpectation('b');

    // Simple matcher that return true if all args are === equivalent.
    mock.$registerArgumentListVerifier('a', function(expectedArgs, args) {
      return goog.array.equals(expectedArgs, args, function(a, b) {
        return (a === b);
      });
    });

    // test single string arg
    expectationA.argumentList = ['foo'];
    assertTrue(mock.$verifyCall(expectationA, 'a', ['foo']));

    // single numeric arg
    expectationA.argumentList = [2]
    assertTrue(mock.$verifyCall(expectationA, 'a', [2]));

    // single object arg (using standard === comparison)
    var obj = {prop1: 'prop1', prop2: 2};
    expectationA.argumentList = [obj];
    expectationB.argumentList = [obj];
    assertTrue(mock.$verifyCall(expectationA, 'a', [obj]));
    assertTrue(mock.$verifyCall(expectationB, 'b', [obj]));

    // if args are similar, but not ===, then comparison should succeed
    // for method with registered object matcher, and fail for method without
    var obj2 = {prop1: 'prop1', prop2: 2};
    expectationA.argumentList = [obj];
    expectationB.argumentList = [obj];
    assertFalse(mock.$verifyCall(expectationA, 'a', [obj2]))
    assertTrue(mock.$verifyCall(expectationB, 'b', [obj2]));


    // multiple args, should fail for method with registered arg matcher,
    // and succeed for method without.
    expectationA.argumentList = ['foo', 2, obj, obj2];
    expectationB.argumentList = ['foo', 2, obj, obj2];
    assertFalse(mock.$verifyCall(expectationA, 'a', ['foo', 2, obj2, obj]));
    assertTrue(mock.$verifyCall(expectationB, 'b', ['foo', 2, obj2, obj]));
  }


  function testCreateProxy() {
    mock = new goog.testing.Mock(RealObject, false, true);
    assertTrue(mock.$proxy instanceof RealObject);
    assertThrows(function() {
      new goog.testing.Mock(RealObject, true, true);
    });
    assertThrows(function() {
      new goog.testing.Mock(1, false, true);
    });
  }


  function testValidConstructorArgument() {
    var someNamespace = { };
    assertThrows(function() {
        new goog.testing.Mock(someNamespace.RealObjectWithTypo);
    });
  }


  function testArgumentsAsString() {
    assertEquals('()', mock.$argumentsAsString([]));
    assertEquals('(string, number, object, null)',
                 mock.$argumentsAsString(['red', 1, {}, null]));
  }


  function testThrowCallExceptionBadArgs() {
    var msg;
    mock.$throwException = function(m) {
      msg = m;
    };

    mock.$throwCallException(
        'fn1', [ 'b' ],
        { name: 'fn1',
          argumentList: [ 'c' ],
          getErrorMessage: function() { return ''; } });
    assertContains(
        'Bad arguments to fn1().\nActual: (string)\nExpected: (string)', msg);
  }

  function testThrowCallExceptionUnexpected() {
    var msg;
    mock.$throwException = function(m) {
      msg = m;
    };

    mock.$throwCallException('fn1', [ 'b' ]);
    assertEquals('Unexpected call to fn1(string).', msg);
  }

  function testThrowCallExceptionUnexpectedWithNext() {
    var msg;
    mock.$throwException = function(m) {
      msg = m;
    };

    mock.$throwCallException(
        'fn1', [ 'b' ],
        { name: 'fn2',
          argumentList: [ 3 ],
          getErrorMessage: function() { return ''; } });
    assertEquals(
        'Unexpected call to fn1(string).\n' +
        'Next expected call was to fn2(number)', msg);
  }

">n/a</td></tr>
<tr><td>eventobserver_test.html</td><td>Success</td><td> 2 passed, 0 failed.</td><td title="

  goog.require('goog.array');
  goog.require('goog.events');
  goog.require('goog.events.EventTarget');
  goog.require('goog.testing.events.EventObserver');
  goog.require('goog.testing.jsunit');



  // Return an event's type
  function getEventType(e) {
    return e.type;
  }

  function testGetEvents() {
    var observer = new goog.testing.events.EventObserver();
    var target = new goog.events.EventTarget();
    goog.events.listen(target, ['foo', 'bar', 'baz'], observer);

    var eventTypes = [
        'bar', 'baz', 'foo', 'qux', 'quux', 'corge', 'foo', 'baz'];
    goog.array.forEach(eventTypes, goog.bind(target.dispatchEvent, target));

    var replayEvents = observer.getEvents();

    assertArrayEquals('Only the listened-for event types should be remembered',
        ['bar', 'baz', 'foo', 'foo', 'baz'],
        goog.array.map(observer.getEvents(), getEventType));

    assertArrayEquals(['bar'],
        goog.array.map(observer.getEvents('bar'), getEventType));
    assertArrayEquals(['baz', 'baz'],
        goog.array.map(observer.getEvents('baz'), getEventType));
    assertArrayEquals(['foo', 'foo'],
        goog.array.map(observer.getEvents('foo'), getEventType));
  }

  function testHandleEvent() {
    var events = [
      new goog.events.Event('foo'),
      new goog.events.Event('bar'),
      new goog.events.Event('baz')
    ];

    var observer = new goog.testing.events.EventObserver();
    goog.array.forEach(events, goog.bind(observer.handleEvent, observer));

    assertArrayEquals(events, observer.getEvents());
    assertArrayEquals([events[0]], observer.getEvents('foo'));
    assertArrayEquals([events[1]], observer.getEvents('bar'));
    assertArrayEquals([events[2]], observer.getEvents('baz'));
  }

">n/a</td></tr>
<tr><td>matchers_test.html</td><td>Success</td><td> 1 passed, 0 failed.</td><td title="

    goog.require('goog.testing.events.EventMatcher');
    goog.require('goog.testing.jsunit');
  

  function testEventMatcher() {
    var matcher = new goog.testing.events.EventMatcher('foo');
    assertFalse(matcher.matches(undefined));
    assertFalse(matcher.matches(null));
    assertFalse(matcher.matches({type: 'foo'}));
    assertFalse(matcher.matches(new goog.events.Event('bar')));

    assertTrue(matcher.matches(new goog.events.Event('foo')));
    var FooEvent = function() {
      goog.events.Event.call(this, 'foo');
    };
    goog.inherits(FooEvent, goog.events.Event);
    assertTrue(matcher.matches(new FooEvent()));
  }
">n/a</td></tr>
<tr><td>mockrange_test.html</td><td>Success</td><td> 1 passed, 0 failed.</td><td title="

  goog.require('goog.testing.MockRange');
  goog.require('goog.testing.jsunit');



  /**
   * Tests that a MockRange can be created successfully, a call to a mock
   * method can be recorded, and the correct behavior replayed and verified.
   */
  function testMockMethod() {
    var mockRange = new goog.testing.MockRange();
    mockRange.getStartOffset().$returns(42);
    mockRange.$replay();

    assertEquals('Mock method should return recorded value',
                 42,
                 mockRange.getStartOffset());
    mockRange.$verify();
  }

">n/a</td></tr>
<tr><td>asynctestcase_async_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="

    goog.require('goog.testing.AsyncTestCase');
    goog.require('goog.testing.jsunit');
  

    // Has the setUp() function been called.
    var setUpCalled = false;
    // Has the current test function completed. This helps us to ensure that
    // the next test is not started before the previous completed.
    var curTestIsDone = true;
    // Use an asynchronous test runner for our tests.
    var asyncTestCase =
        goog.testing.AsyncTestCase.createAndInstall(document.title);

    /**
     * Uses window.setTimeout() to perform asynchronous behaviour and uses
     * asyncTestCase.waitForAsync() and asyncTestCase.continueTesting() to mark
     * the beginning and end of it.
     * @param {number} numAsyncCalls The number of asynchronous calls to make.
     * @param {string} name The name of the current step.
     */
    function doAsyncStuff(numAsyncCalls, name) {
      if (numAsyncCalls > 0) {
        curTestIsDone = false;
        asyncTestCase.waitForAsync('doAsyncStuff-' + name + '(' + numAsyncCalls
                                   + ')');
        window.setTimeout(function() {
          doAsyncStuff(numAsyncCalls - 1, name);
        }, 0);
      } else {
        curTestIsDone = true;
        asyncTestCase.continueTesting();
      }
    }

    function setUpPage() {
      debug('setUpPage was called.');
      doAsyncStuff(3, 'setUpPage');
    }
    function setUp() {
      assertTrue(curTestIsDone);
      doAsyncStuff(3, 'setUp');
    }
    function tearDown() {
      assertTrue(curTestIsDone);
    }
    function test1() {
      assertTrue(curTestIsDone);
      doAsyncStuff(1, 'test1');
    }
    function test2_asyncContinueThenWait() {
      var activeTest = asyncTestCase.activeTest_;
      function async1() {
        asyncTestCase.continueTesting();
        asyncTestCase.waitForAsync('2');
        window.setTimeout(async2, 0);
      }
      function async2() {
        asyncTestCase.continueTesting();
        assertEquals('Did not wait for inner waitForAsync',
                     activeTest,
                     asyncTestCase.activeTest_);
      }
      asyncTestCase.waitForAsync('1');
      window.setTimeout(async1, 0);
    }
    function test3() {
      assertTrue(curTestIsDone);
      doAsyncStuff(2, 'test3');
    }

    function tearDownPage() {
      debug('tearDownPage was called.');
      assertTrue(curTestIsDone);
    }

  ">n/a</td></tr>
<tr><td>asynctestcase_noasync_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="

    goog.require('goog.testing.AsyncTestCase');
    goog.require('goog.testing.jsunit');
  

    // Has the setUp() function been called.
    var setUpCalled = false;
    // Has the current test function completed. This helps us to ensure that the
    // next test is not started before the previous completed.
    var curTestIsDone = true;
    // For restoring it later.
    var oldTimeout = window.setTimeout;
    // Use an asynchronous test runner for our tests.
    var asyncTestCase =
        goog.testing.AsyncTestCase.createAndInstall(document.title);

    /**
     * Uses window.setTimeout() to perform asynchronous behaviour and uses
     * asyncTestCase.waitForAsync() and asyncTestCase.continueTesting() to mark
     * the beginning and end of it.
     * @param {number} numAsyncCalls The number of asynchronous calls to make.
     * @param {string} name The name of the current step.
     */
    function doAsyncStuff(numAsyncCalls, name) {
      if (numAsyncCalls > 0) {
        curTestIsDone = false;
        asyncTestCase.waitForAsync('doAsyncStuff-' + name + '(' + numAsyncCalls
                                   + ')');
        window.setTimeout(function() {
          doAsyncStuff(numAsyncCalls - 1, name);
        }, 0);
      } else {
        curTestIsDone = true;
        asyncTestCase.continueTesting();
      }
    }

    function setUpPage() {
      debug('setUpPage was called.');
      // Don't do anything asynchronously.
      window.setTimeout = function(callback, time) {
        callback();
      };
      doAsyncStuff(3, 'setUpPage');
    }
    function setUp() {
      assertTrue(curTestIsDone);
      doAsyncStuff(3, 'setUp');
    }
    function tearDown() {
      assertTrue(curTestIsDone);
    }
    function test1() {
      assertTrue(curTestIsDone);
      doAsyncStuff(1, 'test1');
    }
    function test2() {
      assertTrue(curTestIsDone);
      doAsyncStuff(2, 'test2');
    }
    function test3() {
      assertTrue(curTestIsDone);
      doAsyncStuff(5, 'test3');
    }
    function tearDownPage() {
      debug('tearDownPage was called.');
      assertTrue(curTestIsDone);
      window.setTimeout = oldTimeout;
    }

  ">n/a</td></tr>
<tr><td>stacktrace_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.string');
  goog.require('goog.testing.ExpectedFailures');
  goog.require('goog.testing.PropertyReplacer');
  goog.require('goog.testing.StrictMock');
  goog.require('goog.testing.asserts');
  goog.require('goog.testing.jsunit');
  goog.require('goog.testing.stacktrace');
  goog.require('goog.userAgent');



var stubs = new goog.testing.PropertyReplacer();
var expectedFailures = new goog.testing.ExpectedFailures();

function setUp() {
  stubs.set(goog.testing.stacktrace, 'isClosureInspectorActive_', function() {
    return false;
  });
}

function tearDown() {
  stubs.reset();
  expectedFailures.handleTearDown();
}

function testParseStackFrameInChrome() {
  var frameString = '    at Error (unknown source)';
  var frame = goog.testing.stacktrace.parseStackFrame_(frameString);
  var expected = new goog.testing.stacktrace.Frame('', 'Error', '', '', '');
  assertObjectEquals('exception name only', expected, frame);

  frameString = '    at Object.assert (file:///.../asserts.js:29:10)';
  frame = goog.testing.stacktrace.parseStackFrame_(frameString);
  expected = new goog.testing.stacktrace.Frame('Object', 'assert', '', '',
      'file:///.../asserts.js:29:10')
  assertObjectEquals('context object + function name + url', expected, frame);

  frameString = '    at http://www.example.com/jsunit.js:117:13';
  frame = goog.testing.stacktrace.parseStackFrame_(frameString);
  expected = new goog.testing.stacktrace.Frame('', '', '', '',
      'http://www.example.com/jsunit.js:117:13');
  assertObjectEquals('url only', expected, frame);

  frameString = '    at [object Object].exec [as execute] (file:///foo)';
  frame = goog.testing.stacktrace.parseStackFrame_(frameString);
  expected = new goog.testing.stacktrace.Frame('[object Object]', 'exec',
      'execute', '', 'file:///foo');
  assertObjectEquals('function alias', expected, frame);

  frameString = '    at new Class (file:///foo)';
  frame = goog.testing.stacktrace.parseStackFrame_(frameString);
  expected = new goog.testing.stacktrace.Frame('', 'new Class', '', '',
      'file:///foo');
  assertObjectEquals('constructor call', expected, frame);

  frameString = '    at new <anonymous> (file:///foo)';
  frame = goog.testing.stacktrace.parseStackFrame_(frameString);
  expected = new goog.testing.stacktrace.Frame('', 'new <anonymous>', '', '',
      'file:///foo');
  assertObjectEquals('anonymous constructor call', expected, frame);

  frameString = '    at Array.forEach (native)';
  frame = goog.testing.stacktrace.parseStackFrame_(frameString);
  expected = new goog.testing.stacktrace.Frame('Array', 'forEach', '', '', '');
  assertObjectEquals('native function call', expected, frame);

  frameString = '    at foo (eval at file://bar)';
  frame = goog.testing.stacktrace.parseStackFrame_(frameString);
  expected = new goog.testing.stacktrace.Frame('', 'foo', '', '', 'file://bar');
  assertObjectEquals('eval', expected, frame);
}

// All test strings are parsed with the conventional and long
// frame algorithms.
function testParseStackFrameInFirefox() {
  var frameString = 'Error("Assertion failed")@:0';
  var frame = goog.testing.stacktrace.parseStackFrame_(frameString);
  var expected = new goog.testing.stacktrace.Frame('', 'Error', '',
      '("Assertion failed")', '');
  assertObjectEquals('function name + arguments', expected, frame);

  frame = goog.testing.stacktrace.parseLongFirefoxFrame_(frameString);
  assertObjectEquals('function name + arguments', expected, frame);

  frameString = '()@file:///foo:42';
  frame = goog.testing.stacktrace.parseStackFrame_(frameString);
  expected = new goog.testing.stacktrace.Frame('', '', '', '()',
      'file:///foo:42');
  assertObjectEquals('anonymous function', expected, frame);

  frame = goog.testing.stacktrace.parseLongFirefoxFrame_(frameString);
  assertObjectEquals('anonymous function', expected, frame);

  frameString = '@javascript:alert(0)';
  frame = goog.testing.stacktrace.parseStackFrame_(frameString);
  expected = new goog.testing.stacktrace.Frame('', '', '', '',
      'javascript:alert(0)');
  assertObjectEquals('anonymous function', expected, frame);

  frame = goog.testing.stacktrace.parseLongFirefoxFrame_(frameString);
  assertObjectEquals('anonymous function', expected, frame);
}

function testCanonicalizeFrame() {
  var frame = new goog.testing.stacktrace.Frame('<window>', 'foo', 'bar',
      '("<a>\'&amp;")', 'http://x?a=1&b=2:1');
  assertEquals('canonical stack frame, everything is escaped',
      '&lt;window&gt;.foo(&quot;&lt;a&gt;\'&amp;amp;&quot;) ' +
      '[as bar] at http://x?a=1&amp;b=2:1', frame.toCanonicalString());
}

function testCanonicalizeFrameWithClosureInspector() {
  stubs.set(goog.testing.stacktrace, 'isClosureInspectorActive_', function() {
    return true;
  });

  var frame = new goog.testing.stacktrace.Frame('', 'foo', '', '()',
      'http://x?a=1&b=2:1');
  assertEquals('canonical stack frame with closure inspector link',
      'foo() at <a href="" onclick="CLOSURE_INSPECTOR___.showLine(' +
      '\'http://x?a=1&amp;b=2:1\', \'1\'); return false">' +
      'http://x?a=1&amp;b=2:1<' + '/a>',
       frame.toCanonicalString());
}

function testDeobfuscateFunctionName() {
  goog.testing.stacktrace.setDeobfuscateFunctionName(function(name) {
    return name.replace(/\$/g, '.');
  });

  var frame = new goog.testing.stacktrace.Frame('', 'a$b$c', 'd$e', '', '');
  assertEquals('deobfuscated function name', 'a.b.c [as d.e]',
      frame.toCanonicalString());
}

function testFramesToString() {
  var normalFrame = new goog.testing.stacktrace.Frame('', 'foo', '', '', '');
  var anonFrame = new goog.testing.stacktrace.Frame('', '', '', '', '');
  var frames = [normalFrame, anonFrame, null, anonFrame];
  var stack = goog.testing.stacktrace.framesToString_(frames);
  assertEquals('framesToString', '> foo\n> anonymous\n> (unknown)\n', stack);
}

function testFollowCallChain() {
  var func = function(var_args) {
    return goog.testing.stacktrace.followCallChain_();
  };

  // Created a fake type with a toString method.
  function LocalType() {};
  LocalType.prototype.toString = function() {
    return 'sg';
  };

  // Create a mock with no expectations.
  var mock = new goog.testing.StrictMock(LocalType);

  mock.$replay();

  var frames = func(undefined, null, false, 0, '', {}, goog.nullFunction,
      mock, new LocalType);

  // Opera before version 10 doesn't support the caller attribute. In that
  // browser followCallChain_() returns empty stack trace.
  expectedFailures.expectFailureFor(goog.userAgent.OPERA &&
      !goog.userAgent.isVersion('10'));
  try {
    assertTrue('The stack trace consists of >=2 frames', frames.length >= 2)
  } catch (e) {
    expectedFailures.handleException(e);
  }

  if (frames.length >= 2) {
    assertEquals('innermost function is anonymous', '', frames[0].getName());
    // There are white space differences how browsers convert functions to
    // strings.
    var expected = '(undefined,null,false,0,"",[objectObject],function(){},' +
        'goog.testing.Mock,sg)';
    assertEquals('arguments of the innermost function (ignoring whitespaces)',
        expected, frames[0].args_.replace(/\s/g, ''));
    assertEquals('test function name', 'testFollowCallChain',
        frames[1].getName());
  }

  mock.$verify();
}

// Create a stack trace string with one modest record and one long record,
// Verify that all frames are parsed. The length of the long arg is set
// to blow Firefox 3x's stack if put through a RegExp.
function testParsingLongStackTrace() {
  var longArg = goog.string.buildString(
      '(', goog.string.repeat('x', 1000000), ')');
  var stackTrace = goog.string.buildString(
      'shortFrame()@:0\n',
      'longFrame',
      longArg,
      '@http://google.com/somescript:0\n');
  var frames = goog.testing.stacktrace.parse_(stackTrace);
  assertEquals('number of returned frames', 2, frames.length);
  var expected = new goog.testing.stacktrace.Frame(
      '', 'shortFrame', '', '()', '');
  assertObjectEquals('short frame', expected, frames[0]);

  expected = new goog.testing.stacktrace.Frame(
      '', 'longFrame', '', longArg, 'http://google.com/somescript:0');
  assertObjectEquals('exception name only', expected, frames[1]);
}

">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:15:24
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>jsbinarysizetoolbar_test.html</td><td>Fail</td><td> 0 passed, 1 failed.</td><td title="


    goog.require("goog.testing.jsunit");
  

  function setUp() {
    goog.dom.getElement('toolbar').innerHTML = '';
  }

  function tearDown() {
    goog.dom.getElement('toolbar').innerHTML = '';
  }

  function testDrawToolbar() {
    drawToolbar();
    var toolbarElem = goog.dom.getElement('toolbar').firstChild
    assertNotNull("Toolbar container was not rendered", toolbarElem);
    assertEquals("Toolbar does not have expected number of children", 3,
        toolbarElem.childNodes.length);


  }
  ">1 of 1 tests run in 4ms.<br />0 passed, 1 failed.<br />4 ms/test. 1 files loaded.<br />ERROR in testDrawToolbar<br />Cannot call method 'getElement' of undefined<br /></td></tr>
<tr><td>jsbinarysizebutton_test.html</td><td>Fail</td><td> 0 passed, 2 failed.</td><td title="


    goog.require("goog.testing.jsunit");
  

  function setUp() {
    goog.dom.getElement('b1').innerHTML = '';
    goog.dom.getElement('cb1').innerHTML = '';

  }

  function tearDown() {
    goog.dom.getElement('b1').innerHTML = '';
    goog.dom.getElement('cb1').innerHTML = '';
  }

  function testDrawButton() {
    drawButtons();
    var buttonElem = goog.dom.getElement('b1').firstChild
    assertNotNull("Button container was not rendered", buttonElem);
    assertEquals("Button does not have correct title", "I changed the tooltip.",
        buttonElem.title);
  }

  function testDrawCustomButton() {
    drawButtons();
    var buttonElems = goog.dom.getElement('cb1').childNodes
    assertEquals("Incorrect number of buttons rendered", 7, buttonElems.length);
  }
  ">2 of 2 tests run in 7ms.<br />0 passed, 2 failed.<br />4 ms/test. 1 files loaded.<br />ERROR in testDrawButton<br />Cannot call method 'getElement' of undefined<br />ERROR in testDrawCustomButton<br />Cannot call method 'getElement' of undefined<br /></td></tr>
<tr><td>strictmock_test.html</td><td>Success</td><td> 20 passed, 0 failed.</td><td title="

  goog.require('goog.testing.StrictMock');
  goog.require('goog.testing.jsunit');



  // The object that we will be mocking
  var RealObject = function() {
  };

  RealObject.prototype.a = function() {
    fail('real object should never be called');
  };

  RealObject.prototype.b = function() {
    fail('real object should never be called');
  };

  RealObject.prototype.c = function() {
    fail('real object should never be called');
  };

  var mock;

  function setUp() {
    var obj = new RealObject();
    mock = new goog.testing.StrictMock(obj);
  }


  function testMockFunction() {
    var mock = new goog.testing.StrictMock(RealObject);
    mock.a();
    mock.b();
    mock.c();
    mock.$replay();
    mock.a();
    mock.b();
    mock.c();
    mock.$verify();

    mock.$reset();

    assertThrows(function() {mock.x()});
  }


  function testSimpleExpectations() {
    mock.a();
    mock.$replay();
    mock.a();
    mock.$verify();

    mock.$reset();

    mock.a();
    mock.b();
    mock.a();
    mock.a();
    mock.$replay();
    mock.a();
    mock.b();
    mock.a();
    mock.a();
    mock.$verify();
  }


  function testFailToSetExpectation() {
    mock.$replay();
    assertThrows(goog.bind(mock.a, mock));

    mock.$reset();

    mock.$replay();
    assertThrows(goog.bind(mock.b, mock));
  }


  function testUnexpectedCall() {
    mock.a();
    mock.$replay();
    mock.a();
    assertThrows(goog.bind(mock.a, mock));

    mock.$reset();

    mock.a();
    mock.$replay();
    assertThrows(goog.bind(mock.b, mock));
  }


  function testNotEnoughCalls() {
    mock.a();
    mock.$replay();
    assertThrows(goog.bind(mock.$verify, mock));

    mock.$reset();

    mock.a();
    mock.b();
    mock.$replay();
    mock.a();
    assertThrows(goog.bind(mock.$verify, mock));
  }


  function testOutOfOrderCalls() {
    mock.a();
    mock.b();
    mock.$replay();
    assertThrows(goog.bind(mock.b, mock));
  }


  function testVerify() {
    mock.a();
    mock.$replay();
    mock.a();
    mock.$verify();

    mock.$reset();

    mock.a();
    mock.$replay();
    assertThrows(goog.bind(mock.$verify, mock));
  }


  function testArgumentMatching() {
    mock.a('foo');
    mock.b('bar');
    mock.$replay();
    mock.a('foo');
    assertThrows(function() {mock.b('foo')});

    mock.$reset();
    mock.a('foo');
    mock.a('bar');
    mock.$replay();
    mock.a('foo');
    mock.a('bar');
    mock.$verify();

    mock.$reset();
    mock.a('foo');
    mock.a('bar');
    mock.$replay();
    assertThrows(function() {mock.a('bar')});
  }


  function testReturnValue() {
    mock.a().$returns(5);
    mock.$replay();

    assertEquals('Mock should return the right value', 5, mock.a());

    mock.$verify();
  }


  function testAtMostOnce() {
    // Zero times SUCCESS.
    mock.a().$atMostOnce();
    mock.$replay();
    mock.$verify();

    mock.$reset();

    // One time SUCCESS.
    mock.a().$atMostOnce();
    mock.$replay();
    mock.a();
    mock.$verify();

    mock.$reset();

    // Many times FAIL.
    mock.a().$atMostOnce();
    mock.$replay();
    mock.a();
    assertThrows(goog.bind(mock.a, mock));

    mock.$reset();

    // atMostOnce only lasts until a new method is called.
    mock.a().$atMostOnce();
    mock.b();
    mock.a();
    mock.$replay();
    mock.b();
    assertThrows(goog.bind(mock.$verify, mock));
  }


  function testAtLeastOnce() {
    // atLeastOnce does not mean zero times
    mock.a().$atLeastOnce();
    mock.$replay();
    assertThrows(goog.bind(mock.$verify, mock));

    mock.$reset();

    // atLeastOnce does mean three times
    mock.a().$atLeastOnce();
    mock.$replay();
    mock.a();
    mock.a();
    mock.a();
    mock.$verify();

    mock.$reset();

    // atLeastOnce only lasts until a new method is called
    mock.a().$atLeastOnce();
    mock.b();
    mock.a();
    mock.$replay();
    mock.a();
    mock.a();
    mock.b();
    mock.a();
    assertThrows(goog.bind(mock.a, mock));
  }


  function testAtLeastOnceWithArgs() {
    mock.a('asdf').$atLeastOnce();
    mock.a('qwert');
    mock.$replay();
    mock.a('asdf');
    mock.a('asdf');
    mock.a('qwert');
    mock.$verify();

    mock.$reset();

    mock.a('asdf').$atLeastOnce();
    mock.a('qwert');
    mock.$replay();
    mock.a('asdf');
    mock.a('asdf');
    assertThrows(function() {mock.a('zxcv')});
    assertThrows(goog.bind(mock.$verify, mock));
  }


  function testAnyTimes() {
    mock.a().$anyTimes();
    mock.$replay();
    mock.$verify();

    mock.$reset();

    mock.a().$anyTimes();
    mock.$replay();
    mock.a();
    mock.a();
    mock.a();
    mock.a();
    mock.a();
    mock.$verify();
  }


  function testAnyTimesWithArguments() {
    mock.a('foo').$anyTimes();
    mock.$replay();
    mock.$verify();

    mock.$reset();

    mock.a('foo').$anyTimes();
    mock.a('bar').$anyTimes();
    mock.$replay();
    mock.a('foo');
    mock.a('foo');
    mock.a('foo');
    mock.a('bar');
    mock.a('bar');
    mock.$verify();
  }


  function testMultipleSkippedAnyTimes() {
    mock.a().$anyTimes();
    mock.b().$anyTimes();
    mock.c().$anyTimes();
    mock.$replay();
    mock.c();
    mock.$verify();
  }


  function testMultipleSkippedAnyTimesWithArguments() {
    mock.a('foo').$anyTimes();
    mock.a('bar').$anyTimes();
    mock.a('baz').$anyTimes();
    mock.$replay();
    mock.a('baz');
    mock.$verify();
  }


  function testVerifyThrows() {
    mock.a(1);
    mock.$replay();
    mock.a(1);
    try {
      mock.a(2);
      fail('bad mock, should fail');
    } catch (ex) {
      // this could be an event handler, for example
    }
    assertThrows(goog.bind(mock.$verify, mock));
  }


  function testThrows() {
    mock.a().$throws('exception!');
    mock.$replay();
    assertThrows(goog.bind(mock.a, mock));
    mock.$verify();
  }


  function testDoes() {
    mock.a(1, 2).$does(function(a, b) {return a + b;});
    mock.$replay();
    assertEquals('Mock should call the function', 3, mock.a(1, 2));
    mock.$verify();
  }

  function testErrorMessageForBadArgs() {
    mock.a();
    mock.$anyTimes();

    mock.$replay();

    var message;
    try {
      mock.a('a');
    } catch (e) {
      message = e.message;
    }

    assertTrue('No exception thrown on verify', goog.isDef(message));
    assertContains('Bad arguments to a()', message);
  }
">n/a</td></tr>
<tr><td>testhelper_test.html</td><td>Fail</td><td> 0 passed, 10 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.dom.TagName');
    goog.require('goog.editor.node');
    goog.require('goog.testing.editor.TestHelper');
    goog.require('goog.testing.jsunit');
  

  var root = goog.dom.getElement('root');
  var helper;

  function setUp() {
    root.innerHTML = '';
    helper = new goog.testing.editor.TestHelper(root);
  }

  function tearDown() {
    helper.dispose();
  }

  function testSetRoot() {
    helper.setRoot(goog.dom.getElement('root2'));
    helper.assertHtmlMatches('Root 2');
  }

  function testSetupEditableElement() {
    helper.setUpEditableElement();
    assertTrue(goog.editor.node.isEditableContainer(root));
  }

  function testTearDownEditableElement() {
    helper.tearDownEditableElement();
    assertFalse(goog.editor.node.isEditableContainer(root));
  }

  function testFindNode() {
    // Test the easiest case.
    root.innerHTML = 'a<br>b';
    assertEquals(helper.findTextNode('a'), root.firstChild);
    assertEquals(helper.findTextNode('b'), root.lastChild);
    assertNull(helper.findTextNode('c'));
  }

  function testFindNodeDuplicate() {
    // Test duplicate.
    root.innerHTML = 'c<br>c';
    assertEquals('Should return first duplicate', helper.findTextNode('c'),
        root.firstChild);
  }

  function findNodeWithHierarchy() {
    // Test a more complicated hierarchy.
    root.innerHTML = '<div>a<p>b<span>c</span>d</p>e</div>';
    assertEquals(goog.dom.TagName.DIV,
        helper.findTextNode('a').parentNode.tagName);
    assertEquals(goog.dom.TagName.P,
        helper.findTextNode('b').parentNode.tagName);
    assertEquals(goog.dom.TagName.SPAN,
        helper.findTextNode('c').parentNode.tagName);
    assertEquals(goog.dom.TagName.P,
        helper.findTextNode('d').parentNode.tagName);
    assertEquals(goog.dom.TagName.DIV,
        helper.findTextNode('e').parentNode.tagName);
  }

  function setUpAssertHtmlMatches() {
    var tag1, tag2;
    if (goog.userAgent.IE) {
      tag1 = goog.dom.TagName.DIV;
    } else if (goog.userAgent.WEBKIT) {
      tag1 = goog.dom.TagName.P;
      tag2 = goog.dom.TagName.BR;
    } else if (goog.userAgent.GECKO) {
      tag1 = goog.dom.TagName.SPAN;
      tag2 = goog.dom.TagName.BR;
    }

    var parent = goog.dom.createDom(goog.dom.TagName.DIV);
    root.appendChild(parent);
    parent.style.fontSize = '2em';
    parent.style.display = 'none';
    if (goog.userAgent.IE || goog.userAgent.GECKO) {
      parent.appendChild(goog.dom.createTextNode('NonWebKitText'));
    }

    if (tag1) {
      var e1 = goog.dom.createDom(tag1);
      parent.appendChild(e1);
      parent = e1;
    }
    if (tag2) {
      parent.appendChild(goog.dom.createDom(tag2));
    }
    parent.appendChild(goog.dom.createTextNode('Text'));
    if (goog.userAgent.WEBKIT) {
      root.firstChild.appendChild(goog.dom.createTextNode('WebKitText'));
    }
  }

  function testAssertHtmlMatches() {
    setUpAssertHtmlMatches();

    helper.assertHtmlMatches('<div style="display: none; font-size: 2em">' +
        '[[IE GECKO]]NonWebKitText<div class="IE"><p class="WEBKIT">' +
        '<span class="GECKO"><br class="GECKO WEBKIT">Text</span></p></div>' +
        '</div>[[WEBKIT]]WebKitText');
  }

  function testAssertHtmlMismatchText() {
    setUpAssertHtmlMatches();

    var e = assertThrows('Should fail due to mismatched text', function() {
      helper.assertHtmlMatches('<div style="display: none; font-size: 2em">' +
          '[[IE GECKO]]NonWebKitText<div class="IE"><p class="WEBKIT">' +
          '<span class="GECKO"><br class="GECKO WEBKIT">Bad</span></p></div>' +
          '</div>[[WEBKIT]]Extra');
    });
    assertContains('Text should match', e.message);
  }

  function testAssertHtmlMismatchTag() {
    setUpAssertHtmlMatches();

    var e = assertThrows('Should fail due to mismatched tag', function() {
      helper.assertHtmlMatches('<span style="display: none; font-size: 2em">' +
          '[[IE GECKO]]NonWebKitText<div class="IE"><p class="WEBKIT">' +
          '<span class="GECKO"><br class="GECKO WEBKIT">Text</span></p></div>' +
          '</span>[[WEBKIT]]Extra');
    });
    assertContains('Tag names should match', e.message);
  }

  function testAssertHtmlMismatchStyle() {
    setUpAssertHtmlMatches();

    var e = assertThrows('Should fail due to mismatched style', function() {
      helper.assertHtmlMatches('<div style="display: none; font-size: 3em">' +
          '[[IE GECKO]]NonWebKitText<div class="IE"><p class="WEBKIT">' +
          '<span class="GECKO"><br class="GECKO WEBKIT">Text</span></p></div>' +
          '</div>[[WEBKIT]]Extra');
    });
    assertContains('Should have same styles', e.message);
  }

  function testAssertHtmlMismatchOptionalText() {
    setUpAssertHtmlMatches();

    var e = assertThrows('Should fail due to mismatched style', function() {
      helper.assertHtmlMatches('<div style="display: none; font-size: 2em">' +
          '[[IE GECKO]]Bad<div class="IE"><p class="WEBKIT">' +
          '<span class="GECKO"><br class="GECKO WEBKIT">Text</span></p></div>' +
          '</div>[[WEBKIT]]Bad');
    });
    assertContains('Text should match', e.message);
  }
">10 of 10 tests run in 13ms.<br />0 passed, 10 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testAssertHtmlMatches<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertHtmlMismatchOptionalText<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertHtmlMismatchStyle<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertHtmlMismatchTag<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertHtmlMismatchText<br />Object #<Object> has no method 'createElement'<br />ERROR in testFindNode<br />Expected <null> but was <undefined><br />> assertEquals at testing/asserts.js:289:3<br />> testFindNode at _tmpclosuretest.js:40:5<br />ERROR in testFindNodeDuplicate<br />Should return first duplicate<br />Expected <null> but was <undefined><br />> assertEquals at testing/asserts.js:289:3<br />> testFindNodeDuplicate at _tmpclosuretest.js:48:5<br />ERROR in testSetRoot<br />Object #<Object> has no method 'createElement'<br />ERROR in testSetupEditableElement<br />Cannot set property 'designMode' of undefined<br />ERROR in testTearDownEditableElement<br />Cannot set property 'designMode' of undefined<br /></td></tr>
<tr><td>mockuseragent_test.html</td><td>Success</td><td> 2 passed, 0 failed.</td><td title="

  goog.require('goog.testing.MockUserAgent');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');



  function testMockUserAgentInstall() {
    var userAgent = new goog.testing.MockUserAgent();

    var originalUserAgentFunction = goog.userAgent.getUserAgentString;

    assertFalse(!!userAgent.installed_);

    userAgent.install();
    assertTrue(userAgent.installed_);
    assertNotEquals(goog.userAgent.getUserAgentString,
        originalUserAgentFunction);

    userAgent.uninstall();
    assertFalse(userAgent.installed_);
    assertEquals(originalUserAgentFunction, goog.userAgent.getUserAgentString);
  }

  function testMockUserAgentGetAgent() {
    var uaString = 'Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US) ' +
        'AppleWebKit/525.13 (KHTML, like Gecko) ' +
        'Chrome/0.2.149.27 Safari/525.13';

    var userAgent = new goog.testing.MockUserAgent();
    userAgent.setUserAgentString(uaString);
    userAgent.install();

    assertTrue(userAgent.installed_);

    assertEquals(uaString, goog.userAgent.getUserAgentString());
  }

">n/a</td></tr>
<tr><td>integration_test.html</td><td>Success</td><td> 7 passed, 0 failed.</td><td title="


goog.require('goog.async.Deferred');
goog.require('goog.async.DeferredList');
goog.require('goog.testing.fs');
goog.require('goog.fs.DirectoryEntry.Behavior');
goog.require('goog.testing.AsyncTestCase');
goog.require('goog.testing.PropertyReplacer');
goog.require('goog.testing.jsunit');



var TEST_DIR = 'goog-fs-test-dir';

var deferredFs = goog.testing.fs.getTemporary();
var asyncTestCase = goog.testing.AsyncTestCase.createAndInstall();
var continueTesting = goog.bind(asyncTestCase.continueTesting, asyncTestCase);

function setUpPage() {
  goog.testing.fs.install(new goog.testing.PropertyReplacer());
}

function tearDown() {
  loadTestDir().
      addCallback(function(dir) { return dir.removeRecursively(); }).
      addCallback(continueTesting);
  asyncTestCase.waitForAsync('removing filesystem');
}

function testWriteFile() {
  loadFile('test', goog.fs.DirectoryEntry.Behavior.CREATE).
      addCallback(goog.partial(writeToFile, 'test content')).
      addCallback(goog.partial(checkFileContent, 'test content')).
      addCallback(continueTesting);
  asyncTestCase.waitForAsync('testWriteFile');
}

function testRemoveFile() {
  loadFile('test', goog.fs.DirectoryEntry.Behavior.CREATE).
      addCallback(goog.partial(writeToFile, 'test content')).
      addCallback(function(file) { return file.remove(); }).
      addCallback(goog.partial(checkFileRemoved, 'test')).
      addCallback(continueTesting);
  asyncTestCase.waitForAsync('testRemoveFile');
}

function testMoveFile() {
  var deferredSubdir = loadDirectory(
      'subdir', goog.fs.DirectoryEntry.Behavior.CREATE);
  var deferredWrittenFile =
      loadFile('test', goog.fs.DirectoryEntry.Behavior.CREATE).
      addCallback(goog.partial(writeToFile, 'test content'));
  goog.async.DeferredList.gatherResults([deferredSubdir, deferredWrittenFile]).
      addCallback(splitArgs(function(dir, file) { return file.moveTo(dir); })).
      addCallback(goog.partial(checkFileContent, 'test content')).
      addCallback(goog.partial(checkFileRemoved, 'test')).
      addCallback(continueTesting);
  asyncTestCase.waitForAsync('testMoveFile');
}

function testCopyFile() {
  var deferredFile = loadFile('test', goog.fs.DirectoryEntry.Behavior.CREATE);
  var deferredSubdir = loadDirectory(
      'subdir', goog.fs.DirectoryEntry.Behavior.CREATE);
  var deferredWrittenFile = branch(deferredFile).
      addCallback(goog.partial(writeToFile, 'test content'));
  goog.async.DeferredList.gatherResults([deferredSubdir, deferredWrittenFile]).
      addCallback(splitArgs(function(dir, file) { return file.copyTo(dir); })).
      addCallback(goog.partial(checkFileContent, 'test content')).
      awaitDeferred(deferredFile).
      addCallback(goog.partial(checkFileContent, 'test content')).
      addCallback(continueTesting);
  asyncTestCase.waitForAsync('testMoveFile');
}

function testAbortWrite() {
  var deferredFile = loadFile('test', goog.fs.DirectoryEntry.Behavior.CREATE);
  branch(deferredFile).
      addCallback(goog.partial(startWrite, 'test content')).
      addCallback(function(writer) { writer.abort(); }).
      addCallback(
          goog.partial(waitForEvent, goog.fs.FileSaver.EventType.ABORT)).
      awaitDeferred(deferredFile).
      addCallback(goog.partial(checkFileContent, '')).
      addCallback(continueTesting);
  asyncTestCase.waitForAsync('testWriteFile');
}

function testSeek() {
  var deferredFile = loadFile('test', goog.fs.DirectoryEntry.Behavior.CREATE);
  branch(deferredFile).
      addCallback(goog.partial(writeToFile, 'test content')).
      addCallback(function(file) { return file.createWriter(); }).
      addCallback(
          goog.partial(checkReadyState, goog.fs.FileSaver.ReadyState.INIT)).
      addCallback(function(writer) {
        writer.seek(5);
        writer.write(goog.fs.getBlob('stuff and things'));
      }).
      addCallback(
          goog.partial(checkReadyState, goog.fs.FileSaver.ReadyState.WRITING)).
      addCallback(
          goog.partial(waitForEvent, goog.fs.FileSaver.EventType.WRITE)).
      awaitDeferred(deferredFile).
      addCallback(goog.partial(checkFileContent, 'test stuff and things')).
      addCallback(continueTesting);
  asyncTestCase.waitForAsync('testWriteFile');
}

function testTruncate() {
  var deferredFile = loadFile('test', goog.fs.DirectoryEntry.Behavior.CREATE);
  branch(deferredFile).
      addCallback(goog.partial(writeToFile, 'test content')).
      addCallback(function(file) { return file.createWriter(); }).
      addCallback(
          goog.partial(checkReadyState, goog.fs.FileSaver.ReadyState.INIT)).
      addCallback(function(writer) { writer.truncate(4); }).
      addCallback(
          goog.partial(checkReadyState, goog.fs.FileSaver.ReadyState.WRITING)).
      addCallback(
          goog.partial(waitForEvent, goog.fs.FileSaver.EventType.WRITE)).
      awaitDeferred(deferredFile).
      addCallback(goog.partial(checkFileContent, 'test')).
      addCallback(continueTesting);
  asyncTestCase.waitForAsync('testWriteFile');
}



function loadTestDir() {
  return branch(deferredFs).addCallback(function(fs) {
    return fs.getRoot().getDirectory(
        TEST_DIR, goog.fs.DirectoryEntry.Behavior.CREATE);
  });
}

function loadFile(filename, behavior) {
  return loadTestDir().addCallback(function(dir) {
    return dir.getFile(filename, behavior);
  });
}

function loadDirectory(filename, behavior) {
  return loadTestDir().addCallback(function(dir) {
    return dir.getDirectory(filename, behavior);
  });
}

function startWrite(content, file) {
  return file.createWriter().
      addCallback(
          goog.partial(checkReadyState, goog.fs.FileSaver.ReadyState.INIT)).
      addCallback(function(writer) {
        writer.write(goog.fs.getBlob(content));
        return writer;
      }).
      addCallback(
          goog.partial(checkReadyState, goog.fs.FileSaver.ReadyState.WRITING));
}

function waitForEvent(type, target) {
  var d = new goog.async.Deferred();
  goog.events.listenOnce(target, type, d.callback, false, d);
  return d;
}

function writeToFile(content, file) {
  return startWrite(content, file).
      addCallback(
          goog.partial(waitForEvent, goog.fs.FileSaver.EventType.WRITE)).
      addCallback(function() { return file; });
}

function checkFileContent(content, file) {
  return file.file().
      addCallback(function(blob) { return goog.fs.blobToString(blob); }).
      addCallback(goog.partial(assertEquals, content));
}

function checkFileRemoved(filename) {
  return loadFile(filename).
      addCallback(goog.partial(fail, 'expected file to be removed')).
      addErrback(function(err) {
        assertEquals(err.code, goog.fs.Error.ErrorCode.NOT_FOUND);
        return true; // Go back to callback path
      });
}

function checkReadyState(expectedState, writer) {
  assertEquals(expectedState, writer.getReadyState());
}

function branch(deferred) {
  return goog.async.Deferred.succeed(null).awaitDeferred(deferred);
}

function splitArgs(fn) {
  return function(args) { return fn(args[0], args[1]); };
}

">n/a</td></tr>
<tr><td>blob_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="

goog.require('goog.testing.fs.Blob');
goog.require('goog.testing.jsunit');



function testAttributes() {
  var blob = new goog.testing.fs.Blob();
  assertEquals(0, blob.size);
  assertEquals('', blob.type);

  blob = new goog.testing.fs.Blob('foo bar baz');
  assertEquals(11, blob.size);
  assertEquals('', blob.type);

  blob = new goog.testing.fs.Blob('foo bar baz', 'text/plain');
  assertEquals(11, blob.size);
  assertEquals('text/plain', blob.type);
}

function testToString() {
  assertEquals('', new goog.testing.fs.Blob().toString());
  assertEquals('foo bar', new goog.testing.fs.Blob('foo bar').toString());
}

function testSlice() {
  var blob = new goog.testing.fs.Blob('abcdef');
  assertEquals('bc', blob.slice(1, 2).toString());
  assertEquals('def', blob.slice(3, 10).toString());
  assertEquals('', blob.slice(10, 1).toString());
  assertEquals('a', blob.slice(-1, 1).toString());

  assertEquals('text/plain', blob.slice(1, 2, 'text/plain').type);
}

">n/a</td></tr>
<tr><td>filewriter_test.html</td><td>Success</td><td> 9 passed, 0 failed.</td><td title="


goog.require('goog.fs.FileSaver.EventType');
goog.require('goog.testing.AsyncTestCase');
goog.require('goog.testing.fs.FileSystem');
goog.require('goog.testing.fs.Blob');
goog.require('goog.testing.jsunit');



var asyncTestCase = goog.testing.AsyncTestCase.createAndInstall();
var continueTesting = goog.bind(asyncTestCase.continueTesting, asyncTestCase);
var fs, file, deferredWriter;

function setUp() {
  fs = new goog.testing.fs.FileSystem();
  file = fs.getRoot().getDirectorySync('foo').getFileSync('bar');
  deferredWriter = file.createWriter();
}

function testWrite() {
  deferredWriter.
      addCallback(goog.partial(checkReadyState,
                               goog.fs.FileSaver.ReadyState.INIT)).
      addCallback(goog.partial(checkPositionAndLength, 0, 0)).
      addCallback(goog.partial(writeString, 'hello')).
      addCallback(goog.partial(checkPositionAndLength, 0, 0)).
      addCallback(goog.partial(checkReadyState,
                               goog.fs.FileSaver.ReadyState.WRITING)).
      addCallback(goog.partial(waitForEvent,
                               goog.fs.FileSaver.EventType.WRITE_START)).
      addCallback(goog.partial(checkPositionAndLength, 0, 0)).
      addCallback(goog.partial(waitForEvent,
                               goog.fs.FileSaver.EventType.WRITE)).
      addCallback(function() { assertEquals('hello', file.data); }).
      addCallback(goog.partial(checkPositionAndLength, 5, 5)).
      addCallback(goog.partial(checkReadyState,
                               goog.fs.FileSaver.ReadyState.WRITING)).
      addCallback(goog.partial(waitForEvent,
                               goog.fs.FileSaver.EventType.WRITE_END)).
      addCallback(goog.partial(checkReadyState,
                               goog.fs.FileSaver.ReadyState.DONE)).
      addCallback(goog.partial(writeString, ' world')).
      addCallback(goog.partial(checkPositionAndLength, 5, 5)).
      addCallback(goog.partial(waitForEvent,
                               goog.fs.FileSaver.EventType.WRITE)).
      addCallback(function() { assertEquals('hello world', file.data); }).
      addCallback(goog.partial(checkPositionAndLength, 11, 11)).
      addCallback(continueTesting);
  asyncTestCase.waitForAsync('testWrite');
}

function testSeek() {
  deferredWriter.
      addCallback(goog.partial(writeAndWait, 'hello world')).
      addCallback(goog.partial(checkPositionAndLength, 11, 11)).

      addCallback(function(writer) { writer.seek(6); }).
      addCallback(goog.partial(checkPositionAndLength, 6, 11)).
      addCallback(goog.partial(writeAndWait, 'universe')).
      addCallback(function() { assertEquals('hello universe', file.data); }).
      addCallback(goog.partial(checkPositionAndLength, 14, 14)).

      addCallback(function(writer) { writer.seek(500); }).
      addCallback(goog.partial(checkPositionAndLength, 14, 14)).
      addCallback(goog.partial(writeAndWait, '!')).
      addCallback(function() { assertEquals('hello universe!', file.data); }).
      addCallback(goog.partial(checkPositionAndLength, 15, 15)).

      addCallback(function(writer) { writer.seek(-9); }).
      addCallback(goog.partial(checkPositionAndLength, 6, 15)).
      addCallback(goog.partial(writeAndWait, 'foo')).
      addCallback(function() { assertEquals('hello fooverse!', file.data); }).
      addCallback(goog.partial(checkPositionAndLength, 9, 15)).

      addCallback(function(writer) { writer.seek(-500); }).
      addCallback(goog.partial(checkPositionAndLength, 0, 15)).
      addCallback(goog.partial(writeAndWait, 'bye-o')).
      addCallback(function() { assertEquals('bye-o fooverse!', file.data); }).
      addCallback(goog.partial(checkPositionAndLength, 5, 15)).

      addCallback(continueTesting);
  asyncTestCase.waitForAsync('testSeek');
}

function testAbort() {
  deferredWriter.
      addCallback(goog.partial(writeString, 'hello world')).
      addCallback(function(writer) { writer.abort(); }).
      addCallback(goog.partial(checkReadyState,
                               goog.fs.FileSaver.ReadyState.WRITING)).
      addCallback(goog.partial(waitForError, goog.fs.Error.ErrorCode.ABORT)).
      addCallback(goog.partial(checkReadyState,
                               goog.fs.FileSaver.ReadyState.WRITING)).
      addCallback(goog.partial(waitForEvent,
                               goog.fs.FileSaver.EventType.ABORT)).
      addCallback(goog.partial(checkReadyState,
                               goog.fs.FileSaver.ReadyState.WRITING)).
      addCallback(goog.partial(waitForEvent,
                               goog.fs.FileSaver.EventType.WRITE_END)).
      addCallback(goog.partial(checkReadyState,
                               goog.fs.FileSaver.ReadyState.DONE)).
      addCallback(goog.partial(checkPositionAndLength, 0, 0)).
      addCallback(function() { assertEquals('', file.data); }).
      addCallback(continueTesting);
  asyncTestCase.waitForAsync('testAbort');
};

function testTruncate() {
  deferredWriter.
      addCallback(goog.partial(writeAndWait, 'hello world')).
      addCallback(goog.partial(checkPositionAndLength, 11, 11)).
      addCallback(function(writer) { writer.truncate(5); }).
      addCallback(goog.partial(checkPositionAndLength, 11, 11)).
      addCallback(goog.partial(checkReadyState,
                               goog.fs.FileSaver.ReadyState.WRITING)).
      addCallback(goog.partial(waitForEvent,
                               goog.fs.FileSaver.EventType.WRITE_START)).
      addCallback(goog.partial(checkPositionAndLength, 11, 11)).
      addCallback(goog.partial(waitForEvent,
                               goog.fs.FileSaver.EventType.WRITE)).
      addCallback(goog.partial(checkReadyState,
                               goog.fs.FileSaver.ReadyState.WRITING)).
      addCallback(goog.partial(checkPositionAndLength, 5, 5)).
      addCallback(function() { assertEquals('hello', file.data); }).
      addCallback(goog.partial(waitForEvent,
                               goog.fs.FileSaver.EventType.WRITE_END)).
      addCallback(goog.partial(checkReadyState,
                               goog.fs.FileSaver.ReadyState.DONE)).

      addCallback(function(writer) { writer.truncate(10); }).
      addCallback(goog.partial(waitForEvent,
                               goog.fs.FileSaver.EventType.WRITE_END)).
      addCallback(goog.partial(checkPositionAndLength, 5, 10)).
      addCallback(function() { assertEquals('hello\0\0\0\0\0', file.data); }).

      addCallback(continueTesting);
  asyncTestCase.waitForAsync('testTruncate');
};

function testAbortBeforeWrite() {
  deferredWriter.
      addCallback(function(writer) { writer.abort(); }).
      addErrback(function(err) {
        assertEquals(goog.fs.Error.ErrorCode.INVALID_STATE, err.code);
        continueTesting();
      });
  asyncTestCase.waitForAsync('testAbortBeforeWrite');
}

function testAbortAfterWrite() {
  deferredWriter.
      addCallback(goog.partial(writeAndWait, 'hello world')).
      addCallback(function(writer) { writer.abort(); }).
      addErrback(function(err) {
        assertEquals(goog.fs.Error.ErrorCode.INVALID_STATE, err.code);
        continueTesting();
      });
  asyncTestCase.waitForAsync('testAbortAfterWrite');
}

function testWriteDuringWrite() {
  deferredWriter.
      addCallback(goog.partial(writeString, 'hello world')).
      addCallback(goog.partial(writeString, 'hello world')).
      addErrback(function(err) {
        assertEquals(goog.fs.Error.ErrorCode.INVALID_STATE, err.code);
        continueTesting();
      });
  asyncTestCase.waitForAsync('testWriteDuringWrite');
}

function testSeekDuringWrite() {
  deferredWriter.
      addCallback(goog.partial(writeString, 'hello world')).
      addCallback(function(writer) { writer.seek(5); }).
      addErrback(function(err) {
        assertEquals(goog.fs.Error.ErrorCode.INVALID_STATE, err.code);
        continueTesting();
      });
  asyncTestCase.waitForAsync('testSeekDuringWrite');
}

function testTruncateDuringWrite() {
  deferredWriter.
      addCallback(goog.partial(writeString, 'hello world')).
      addCallback(function(writer) { writer.truncate(5); }).
      addErrback(function(err) {
        assertEquals(goog.fs.Error.ErrorCode.INVALID_STATE, err.code);
        continueTesting();
      });
  asyncTestCase.waitForAsync('testTruncateDuringWrite');
}



function waitForEvent(type, target) {
  var d = new goog.async.Deferred();
  goog.events.listenOnce(target, type, goog.bind(d.callback, d, target));
  return d;
}

function waitForError(type, target) {
  var d = new goog.async.Deferred();
  goog.events.listenOnce(
      target, goog.fs.FileSaver.EventType.ERROR, function(e) {
        assertEquals(type, target.getError().code);
        d.callback(target);
      });
  return d;
}

function checkReadyState(expectedState, writer) {
  assertEquals(expectedState, writer.getReadyState());
}

function checkPositionAndLength(expectedPosition, expectedLength, writer) {
  assertEquals(expectedPosition, writer.getPosition());
  assertEquals(expectedLength, writer.getLength());
}

function writeString(str, writer) {
  writer.write(new goog.testing.fs.Blob(str));
}

function writeAndWait(str, writer) {
  writeString(str, writer);
  return waitForEvent(goog.fs.FileSaver.EventType.WRITE_END, writer);
}

">n/a</td></tr>
<tr><td>entry_test.html</td><td>Success</td><td> 13 passed, 0 failed.</td><td title="


goog.require('goog.fs.Error.ErrorCode');
goog.require('goog.testing.AsyncTestCase');
goog.require('goog.testing.fs.FileSystem');
goog.require('goog.testing.jsunit');



var asyncTestCase = goog.testing.AsyncTestCase.createAndInstall();
var fs, file;

function setUp() {
  fs = new goog.testing.fs.FileSystem();
  file = fs.getRoot().getDirectorySync('foo').getFileSync('bar');
}

function testGetName() {
  assertEquals('bar', file.getName());
}

function testGetFullPath() {
  assertEquals('/foo/bar', file.getFullPath());
  assertEquals('/', fs.getRoot().getFullPath());
}

function testGetFileSystem() {
  assertEquals(fs, file.getFileSystem());
}

function testMoveTo() {
  file.moveTo(fs.getRoot()).addCallback(function(newFile) {
    assertTrue(file.deleted);
    assertFalse(newFile.deleted);
    assertEquals('/bar', newFile.getFullPath());
    assertEquals(fs.getRoot(), newFile.parent);
    assertEquals(newFile, fs.getRoot().getFileSync('bar'));
    assertFalse(fs.getRoot().getDirectorySync('foo').hasChild('bar'));

    asyncTestCase.continueTesting();
  });
  asyncTestCase.waitForAsync('waiting for file move');
}

function testMoveToNewName() {
  file.moveTo(fs.getRoot(), 'baz').addCallback(function(newFile) {
    assertTrue(file.deleted);
    assertFalse(newFile.deleted);
    assertEquals('/baz', newFile.getFullPath());
    assertEquals(fs.getRoot(), newFile.parent);
    assertEquals(newFile, fs.getRoot().getFileSync('baz'));
    assertFalse(fs.getRoot().getDirectorySync('foo').hasChild('bar'));
    assertFalse(fs.getRoot().getDirectorySync('foo').hasChild('baz'));

    asyncTestCase.continueTesting();
  });
  asyncTestCase.waitForAsync('waiting for file move');
}

function testMoveDeletedFile() {
  assertFailsWhenDeleted(function() { return file.moveTo(fs.getRoot()); });
}

function testCopyTo() {
  file.copyTo(fs.getRoot()).addCallback(function(newFile) {
    assertFalse(file.deleted);
    assertFalse(newFile.deleted);
    assertEquals('/bar', newFile.getFullPath());
    assertEquals(fs.getRoot(), newFile.parent);
    assertEquals(newFile, fs.getRoot().getFileSync('bar'));
    assertEquals(file, fs.getRoot().getDirectorySync('foo').getFileSync('bar'));

    asyncTestCase.continueTesting();
  });
  asyncTestCase.waitForAsync('waiting for file copy');
}

function testCopyToNewName() {
  file.copyTo(fs.getRoot(), 'baz').addCallback(function(newFile) {
    assertFalse(file.deleted);
    assertFalse(newFile.deleted);
    assertEquals('/baz', newFile.getFullPath());
    assertEquals(fs.getRoot(), newFile.parent);
    assertEquals(newFile, fs.getRoot().getFileSync('baz'));
    assertEquals(file, fs.getRoot().getDirectorySync('foo').getFileSync('bar'));
    assertFalse(fs.getRoot().getDirectorySync('foo').hasChild('baz'));

    asyncTestCase.continueTesting();
  });
  asyncTestCase.waitForAsync('waiting for file copy');
}

function testCopyDeletedFile() {
  assertFailsWhenDeleted(function() { return file.copyTo(fs.getRoot()); });
}

function testRemove() {
  file.remove().addCallback(function() {
    assertTrue(file.deleted);
    assertFalse(fs.getRoot().getDirectorySync('foo').hasChild('bar'));

    asyncTestCase.continueTesting();
  });
  asyncTestCase.waitForAsync('waiting for file removal');
}

function testRemoveDeletedFile() {
  assertFailsWhenDeleted(function() { return file.remove(); });
}

function testGetParent() {
  file.getParent().addCallback(function(p) {
    assertEquals(file.parent, p);
    assertEquals(fs.getRoot().getDirectorySync('foo'), p);
    assertEquals('/foo', p.getFullPath());

    asyncTestCase.continueTesting();
  });
  asyncTestCase.waitForAsync('waiting for file parent');
}

function testGetDeletedFileParent() {
  assertFailsWhenDeleted(function() { return file.getParent(); });
}

function assertFailsWhenDeleted(fn) {
  file.remove().addCallback(fn).
      addCallback(function() { fail('Expected an error'); }).
      addErrback(function(err) {
        assertEquals(goog.fs.Error.ErrorCode.NOT_FOUND, err.code);
        asyncTestCase.continueTesting();
      });
  asyncTestCase.waitForAsync('waiting for file operation');
}

">n/a</td></tr>
<tr><td>fileentry_test.html</td><td>Success</td><td> 3 passed, 0 failed.</td><td title="


goog.require('goog.testing.AsyncTestCase');
goog.require('goog.testing.fs.FileSystem');
goog.require('goog.testing.jsunit');



var asyncTestCase = goog.testing.AsyncTestCase.createAndInstall();
var fs, file;

function setUp() {
  fs = new goog.testing.fs.FileSystem();
  file = fs.getRoot().getDirectorySync('foo').getFileSync('bar');
}

function testIsFile() {
  assertTrue(file.isFile());
}

function testIsDirectory() {
  assertFalse(file.isDirectory());
}

function testFile() {
  file.data = 'hello world';
  file.file().addCallback(function(f) {
    assertEquals('bar', f.name);
    assertEquals('hello world', f.toString());

    asyncTestCase.continueTesting();
  });
  asyncTestCase.waitForAsync('testFile');
}


">n/a</td></tr>
<tr><td>directoryentry_test.html</td><td>Success</td><td> 17 passed, 0 failed.</td><td title="


goog.require('goog.fs.DirectoryEntry.Behavior');
goog.require('goog.fs.Error.ErrorCode');
goog.require('goog.testing.AsyncTestCase');
goog.require('goog.testing.fs.FileSystem');
goog.require('goog.testing.jsunit');



var asyncTestCase = goog.testing.AsyncTestCase.createAndInstall();
var fs, dir;

function setUp() {
  fs = new goog.testing.fs.FileSystem();
  dir = fs.getRoot().getDirectorySync('foo');
  dir.getDirectorySync('subdir').getFileSync('subfile');
  dir.getFileSync('file');
}

function testIsFile() {
  assertFalse(dir.isFile());
}

function testIsDirectory() {
  assertTrue(dir.isDirectory());
}

function testRemoveWithChildren() {
  dir.getFileSync('bar');
  expectError(dir.remove(), goog.fs.Error.ErrorCode.INVALID_MODIFICATION);
}

function testRemoveWithoutChildren() {
  var emptyDir = dir.getDirectorySync('empty');
  emptyDir.remove().addCallback(function() {
    assertTrue(emptyDir.deleted);
    assertFalse(fs.getRoot().hasChild('empty'));

    asyncTestCase.continueTesting();
  });
  asyncTestCase.waitForAsync('waiting for file removal');
}

function testGetFile() {
  dir.getFile('file').addCallback(function(file) {
    assertEquals(dir.getFileSync('file'), file);
    assertEquals('file', file.getName());
    assertEquals('/foo/file', file.getFullPath());
    assertTrue(file.isFile());

    asyncTestCase.continueTesting();
  });
  asyncTestCase.waitForAsync('waiting for file');
}

function testGetFileFromSubdir() {
  dir.getFile('subdir/subfile').addCallback(function(file) {
    assertEquals(dir.getDirectorySync('subdir').getFileSync('subfile'), file);
    assertEquals('subfile', file.getName());
    assertEquals('/foo/subdir/subfile', file.getFullPath());
    assertTrue(file.isFile());

    asyncTestCase.continueTesting();
  });
  asyncTestCase.waitForAsync('waiting for file');
}

function testCreateFile() {
  dir.getFile('bar', goog.fs.DirectoryEntry.Behavior.CREATE).
      addCallback(function(file) {
        assertEquals('bar', file.getName());
        assertEquals('/foo/bar', file.getFullPath());
        assertEquals(dir, file.parent);
        assertTrue(file.isFile());

        asyncTestCase.continueTesting();
      });
  asyncTestCase.waitForAsync('waiting for file creation');
}

function testCreateFileThatAlreadyExists() {
  var existingFile = dir.getFileSync('file');
  dir.getFile('file', goog.fs.DirectoryEntry.Behavior.CREATE).
      addCallback(function(file) {
        assertEquals('file', file.getName());
        assertEquals('/foo/file', file.getFullPath());
        assertEquals(dir, file.parent);
        assertEquals(existingFile, file);
        assertTrue(file.isFile());

        asyncTestCase.continueTesting();
      });
  asyncTestCase.waitForAsync('waiting for file creation');
}

function testCreateFileInSubdir() {
  dir.getFile('subdir/bar', goog.fs.DirectoryEntry.Behavior.CREATE).
      addCallback(function(file) {
        assertEquals('bar', file.getName());
        assertEquals('/foo/subdir/bar', file.getFullPath());
        assertEquals(dir.getDirectorySync('subdir'), file.parent);
        assertTrue(file.isFile());

        asyncTestCase.continueTesting();
      });
  asyncTestCase.waitForAsync('waiting for file creation');
}

function testCreateFileExclusive() {
  dir.getFile('bar', goog.fs.DirectoryEntry.Behavior.CREATE).
      addCallback(function(file) {
        assertEquals('bar', file.getName());
        assertEquals('/foo/bar', file.getFullPath());
        assertEquals(dir, file.parent);
        assertTrue(file.isFile());

        asyncTestCase.continueTesting();
      });
  asyncTestCase.waitForAsync('waiting for file creation');
}

function testGetNonExistentFile() {
  expectError(dir.getFile('bar'), goog.fs.Error.ErrorCode.NOT_FOUND);
}

function testGetNonExistentFileInSubdir() {
  expectError(dir.getFile('subdir/bar'), goog.fs.Error.ErrorCode.NOT_FOUND);
}

function testGetFileInNonExistentSubdir() {
  expectError(dir.getFile('bar/subfile'), goog.fs.Error.ErrorCode.NOT_FOUND);
}

function testGetFileThatsActuallyADirectory() {
  expectError(dir.getFile('subdir'), goog.fs.Error.ErrorCode.TYPE_MISMATCH);
}

function testCreateFileInNonExistentSubdir() {
  expectError(
      dir.getFile('bar/newfile', goog.fs.DirectoryEntry.Behavior.CREATE),
      goog.fs.Error.ErrorCode.NOT_FOUND);
}

function testCreateFileThatsActuallyADirectory() {
  expectError(
      dir.getFile('subdir', goog.fs.DirectoryEntry.Behavior.CREATE),
      goog.fs.Error.ErrorCode.TYPE_MISMATCH);
}

function testCreateExclusiveExistingFile() {
  expectError(
      dir.getFile('file', goog.fs.DirectoryEntry.Behavior.CREATE_EXCLUSIVE),
      goog.fs.Error.ErrorCode.PATH_EXISTS);
}


function expectError(deferred, code) {
  deferred.
      addCallback(function() { fail('Expected an error'); }).
      addErrback(function(err) {
        assertEquals(code, err.code);
        asyncTestCase.continueTesting();
      });
  asyncTestCase.waitForAsync('waiting for error');
}

">n/a</td></tr>
<tr><td>layoutasserts_test.html</td><td>Fail</td><td> 0 passed, 7 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.style');
    goog.require('goog.testing.jsunit');
    goog.require('goog.testing.style.layoutasserts');
  


  var div1;
  var div2;
  var DEFAULT_WIDTH = 200;
  var DEFAULT_HEIGHT = 100;

  function setUp() {
    div1 = goog.dom.createDom(
        'div',
        {
          id: 'test',
          className: 'test',
          style: 'position:absolute;top:0;left:0;' +
                 'width:' + DEFAULT_WIDTH + 'px;' +
                 'height:' + DEFAULT_HEIGHT + 'px;' +
                  'background-color:#EEE',
          innerHTML: 'abc'
        });
    div2 = goog.dom.createDom('div',
        {
          id: 'test2',
          className: 'test2',
          style: 'position:absolute;' +
                 'top:0;left:0;' +
                 'width:' + DEFAULT_WIDTH + 'px;' +
                 'height:' + DEFAULT_HEIGHT + 'px;' +
                 'background-color:#F00',
          innerHTML: 'abc'
        });

  }


  function tearDown() {
    div1 = null;
    div2 = null;
  }


  /**
   * Tests assertIsVisible.
   */
  function testAssertIsVisible() {
    assertThrows('Exception should be thrown when asserting visibility.',
        goog.bind(assertIsVisible, null, null)); // assertIsVisible(null)

    // Attach it to BODY tag and assert that it is visible.
    document.body.appendChild(div1);
    assertIsVisible('Div should be visible.', div1);

    // Tests with hidden element
    failed = false;
    goog.style.showElement(div1, false /* display */);
    assertThrows('Exception should be thrown when asserting visibility.',
        goog.bind(assertIsVisible, null, div1));

    // Clean up.
    document.body.removeChild(div1);
  }


  /**
   * Tests assertNotVisible.
   */
  function testAssertNotVisible() {
    // Tests null as a parameter.
    var element = null;
    assertNotVisible(element);

    // Attach the element to BODY element, assert should fail.
    document.body.appendChild(div1);
    assertThrows('Exception should be thrown when asserting non-visibility.',
        goog.bind(assertNotVisible, null, div1));

    // Clean up.
    document.body.removeChild(div1);
  }


  /**
   * Tests assertIsIntersect.
   */
  function testAssertIntersect() {
    document.body.appendChild(div1);
    document.body.appendChild(div2);

    // No intersection
    goog.style.setPosition(div1, 0, 0);
    goog.style.setPosition(div2, 500, 500);
    assertThrows('Exception should be thrown when asserting intersection.',
        goog.bind(assertIntersect, null, div1, div2));
    assertNoIntersect(div1,div2);

    // Some intersection
    goog.style.setPosition(div1, 0, 0);
    goog.style.setPosition(div2, 50, 50);
    assertThrows('Exception should be thrown when asserting no intersection.',
        goog.bind(assertNoIntersect, null, div1, div2));
    assertIntersect(div1, div2);

    // Completely superimposed.
    goog.style.setPosition(div1, 0, 0);
    goog.style.setPosition(div2, 0, 0);
    assertThrows('Exception should be thrown when asserting no intersection.',
        goog.bind(assertNoIntersect, null, div1, div2));
    assertIntersect(div1, div2)
  }


  /**
   * Tests assertWidth.
   */
  function testAssertWidth() {
    document.body.appendChild(div1);

    // Test correct width
    assertWidth(div1, DEFAULT_WIDTH);

    // Test wrong width
    assertThrows('Exception should be thrown when elements has wrong width',
        goog.bind(assertWidth, null, div1, 400));

    // Test a valid tolerance value
    assertWidthWithinTolerance(div1, 180, 20);

    // Test exceeding tolerance value
    assertThrows(
        'Exception should be thrown when element\'s width exceeds tolerance',
        goog.bind(assertWidthWithinTolerance, null, div1, 100, 0.1));
  }


  /**
   * Tests assertHeight.
   */
  function testAssertHeight() {
    document.body.appendChild(div1);

    // Test correct height
    assertHeight(div1, DEFAULT_HEIGHT);

    // Test wrong height
    assertThrows('Exception should be thrown when element has wrong height.',
        goog.bind(assertHeightWithinTolerance, null, div1, 300));

    // Test a valid tolerance value
    assertHeightWithinTolerance(div1, 90, 10);

    // Test exceeding tolerance value
    assertThrows(
        'Exception should be thrown when element\'s height exceeds tolerance',
        goog.bind(assertHeight, null, div1, 50, 0.2));
  }


  /**
   * Tests assertIsLeftOf.
   */
  function testAssertIsLeftOf() {
    document.body.appendChild(div1);
    document.body.appendChild(div2);

    // Test elements of same size & location
    assertThrows('Exception should be thrown when elements intersect.',
        goog.bind(assertIsLeftOf, null, div1, div2));
    assertThrows('Exception should be thrown when elements intersect.',
        goog.bind(
            assertIsStrictlyLeftOf, null, div1, div2));

    // Test elements that are not left to right
    goog.style.setPosition(div1, 100, 0);
    goog.style.setPosition(div2, 0, 0);
    assertThrows(
        'Exception should be thrown when elements are not left to right.',
        goog.bind(assertIsLeftOf, null, div1, div2));
    assertThrows(
        'Exception should be thrown when elements are not left to right.',
        goog.bind(
            assertIsStrictlyLeftOf, null, div1, div2));

    // Test elements that intersect, but is left to right
    goog.style.setPosition(div1, 0, 0);
    goog.style.setPosition(div2, 100, 0);
    assertIsLeftOf(div1, div2);
    assertThrows('Exception should be thrown when elements intersect.',
        goog.bind(
            assertIsStrictlyLeftOf, null, div1, div2));

    // Test elements that are strictly left to right
    goog.style.setPosition(div1, 0, 0);
    goog.style.setPosition(div2, 999, 0);
    assertIsLeftOf(div1, div2);
    assertIsStrictlyLeftOf(div1, div2);
  }


  /**
   * Tests assertIsAbove.
   */
  function testAssertIsAbove() {
    document.body.appendChild(div1);
    document.body.appendChild(div2);

    // Test elements of same size & location
    assertThrows('Exception should be thrown when elements intersect.',
        goog.bind(assertIsAbove, null, div1, div2));
    assertThrows('Exception should be thrown when elements intersect.',
        goog.bind(
          assertIsStrictlyAbove, null, div1, div2));

    // Test elements that are not top to bottom
    goog.style.setPosition(div1, 0, 999);
    goog.style.setPosition(div2, 0, 0);
    assertThrows(
        'Exception should be thrown when elements are not top to bottom.',
        goog.bind(assertIsAbove, null, div1, div2));
    assertThrows(
        'Exception should be thrown when elements are not top to bottom.',
        goog.bind(
          assertIsStrictlyAbove, null, div1, div2));

    // Test elements that intersect, but is top to bottom
    goog.style.setPosition(div1, 0, 0);
    goog.style.setPosition(div2, 0, 50);
    assertIsAbove(div1, div2);
    assertThrows('Exception should be thrown when elements intersect.',
        goog.bind(
        assertIsStrictlyAbove, null, div1, div2));

    // Test elements that are top to bottom
    goog.style.setPosition(div1, 0, 0);
    goog.style.setPosition(div2, 0, 999);
    assertIsAbove(div1, div2);
    assertIsStrictlyAbove(div1, div2);
  }

  ">7 of 7 tests run in 7ms.<br />0 passed, 7 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testAssertHeight<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertIntersect<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertIsAbove<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertIsLeftOf<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertIsVisible<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertNotVisible<br />Object #<Object> has no method 'createElement'<br />ERROR in testAssertWidth<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>mockclassfactory_test.html</td><td>Success</td><td> 9 passed, 0 failed.</td><td title="

  goog.require('goog.testing.MockClassFactory');
  goog.require('goog.testing.jsunit');


  goog.provide('fake.BaseClass');
  goog.provide('fake.ChildClass');

  // Classes that will be mocked.  A base class and child class are used to
  // test inheritance.
  fake.BaseClass = function(a) {
    fail('real object should never be called');
  };

  fake.BaseClass.prototype.foo = function() {
    fail('real object should never be called');
  };

  fake.BaseClass.prototype.toString = function() {return 'foo';}

  fake.BaseClass.prototype.toLocaleString = function() {return 'bar';}

  fake.ChildClass = function(a) {
    fail('real object should never be called');
  };
  goog.inherits(fake.ChildClass, fake.BaseClass);

  fake.ChildClass.staticFoo = function() {
    fail('real object should never be called');
  };

  fake.ChildClass.prototype.bar = function() {
    fail('real object should never be called');
  };

  fake.ChildClass.staticProperty = 'staticPropertyOnClass';

  function TopLevelBaseClass() {
  }

  var mockClassFactory = new goog.testing.MockClassFactory();
  var matchers = goog.testing.mockmatchers;

  function tearDown() {
    mockClassFactory.reset();
  };

  function testGetStrictMockClass() {
    var mock1 = mockClassFactory.getStrictMockClass(fake, fake.BaseClass, 1);
    mock1.foo();
    mock1.$replay();

    var mock2 = mockClassFactory.getStrictMockClass(fake, fake.BaseClass, 2);
    mock2.foo();
    mock2.$replay();

    var mock3 = mockClassFactory.getStrictMockClass(fake, fake.ChildClass, 3);
    mock3.foo();
    mock3.bar();
    mock3.$replay();

    var instance1 = new fake.BaseClass(1);
    instance1.foo();
    mock1.$verify();

    var instance2 = new fake.BaseClass(2);
    instance2.foo();
    mock2.$verify();

    var instance3 = new fake.ChildClass(3);
    instance3.foo();
    instance3.bar();
    mock3.$verify();

    assertThrows(function() {new fake.BaseClass(-1)});
    assertTrue(instance1 instanceof fake.BaseClass);
    assertTrue(instance2 instanceof fake.BaseClass);
    assertTrue(instance3 instanceof fake.ChildClass);
  };

  function testGetStrictMockClassCreatesAllProxies() {
    var mock1 = mockClassFactory.getStrictMockClass(fake, fake.BaseClass, 1);
    // toString(), toLocaleString() and others are treaded specially in
    // createProxy_().
    mock1.toString();
    mock1.toLocaleString();
    mock1.$replay();

    var instance1 = new fake.BaseClass(1);
    instance1.toString();
    instance1.toLocaleString();
    mock1.$verify();
  }

  function testGetLooseMockClass() {
    var mock1 = mockClassFactory.getLooseMockClass(fake, fake.BaseClass, 1);
    mock1.foo().$anyTimes().$returns(3);
    mock1.$replay();

    var mock2 = mockClassFactory.getLooseMockClass(fake, fake.BaseClass, 2);
    mock2.foo().$times(3);
    mock2.$replay();

    var mock3 = mockClassFactory.getLooseMockClass(fake, fake.ChildClass, 3);
    mock3.foo().$atLeastOnce().$returns(5);
    mock3.bar().$atLeastOnce();
    mock3.$replay();

    var instance1 = new fake.BaseClass(1);
    assertEquals(3, instance1.foo());
    assertEquals(3, instance1.foo());
    assertEquals(3, instance1.foo());
    assertEquals(3, instance1.foo());
    assertEquals(3, instance1.foo());
    mock1.$verify();

    var instance2 = new fake.BaseClass(2);
    instance2.foo();
    instance2.foo();
    instance2.foo();
    mock2.$verify();

    var instance3 = new fake.ChildClass(3);
    assertEquals(5, instance3.foo());
    assertEquals(5, instance3.foo());
    instance3.bar();
    mock3.$verify();

    assertThrows(function() {new fake.BaseClass(-1)});
    assertTrue(instance1 instanceof fake.BaseClass);
    assertTrue(instance2 instanceof fake.BaseClass);
    assertTrue(instance3 instanceof fake.ChildClass);
  };

  function testGetStrictStaticMock() {
    var staticMock = mockClassFactory.getStrictStaticMock(fake,
        fake.ChildClass);
    var mock = mockClassFactory.getStrictMockClass(fake, fake.ChildClass, 1);

    mock.foo();
    mock.bar();
    staticMock.staticFoo();
    mock.$replay();
    staticMock.$replay();

    var instance = new fake.ChildClass(1);
    instance.foo();
    instance.bar();
    fake.ChildClass.staticFoo();
    mock.$verify();
    staticMock.$verify();

    assertTrue(instance instanceof fake.BaseClass);
    assertTrue(instance instanceof fake.ChildClass);
    assertThrows(function() {
      mockClassFactory.getLooseStaticMock(fake, fake.ChildClass)
    });
  };

  function testGetStrictStaticMockKeepsStaticProperties() {
    var OriginalChildClass = fake.ChildClass;
    var staticMock = mockClassFactory.getStrictStaticMock(fake,
        fake.ChildClass);
    assertEquals(OriginalChildClass.staticProperty,
        fake.ChildClass.staticProperty);
  };

  function testGetLooseStaticMockKeepsStaticProperties() {
    var OriginalChildClass = fake.ChildClass;
    var staticMock = mockClassFactory.getLooseStaticMock(fake,
        fake.ChildClass);
    assertEquals(OriginalChildClass.staticProperty,
        fake.ChildClass.staticProperty);
  };

  function testGetLooseStaticMock() {
    var staticMock = mockClassFactory.getLooseStaticMock(fake,
        fake.ChildClass);
    var mock = mockClassFactory.getStrictMockClass(fake, fake.ChildClass, 1);

    mock.foo();
    mock.bar();
    staticMock.staticFoo().$atLeastOnce();
    mock.$replay();
    staticMock.$replay();

    var instance = new fake.ChildClass(1);
    instance.foo();
    instance.bar();
    fake.ChildClass.staticFoo();
    fake.ChildClass.staticFoo();
    mock.$verify();
    staticMock.$verify();

    assertTrue(instance instanceof fake.BaseClass);
    assertTrue(instance instanceof fake.ChildClass);
    assertThrows(function() {
      mockClassFactory.getStrictStaticMock(fake, fake.ChildClass)
    });
  };

  function testFlexibleClassMockInstantiation() {
    // This mock should be returned for all instances created with a number
    // as the first argument.
    var mock = mockClassFactory.getStrictMockClass(fake, fake.ChildClass,
        matchers.isNumber);
    mock.foo(); // Will be called by the first mock instance.
    mock.foo(); // Will be called by the second mock instance.
    mock.$replay();

    var instance1 = new fake.ChildClass(1);
    var instance2 = new fake.ChildClass(2);
    instance1.foo();
    instance2.foo();
    assertThrows(function() {
      new fake.ChildClass('foo');
    });
    mock.$verify();
  };

  function testMockTopLevelClass() {
    var mock = mockClassFactory.getStrictMockClass(goog.global,
        goog.global.TopLevelBaseClass);
  }
">n/a</td></tr>
<tr><td>mockclock_test.html</td><td>Success</td><td> 16 passed, 0 failed.</td><td title="

  goog.require('goog.functions');
  goog.require('goog.testing.MockClock');
  goog.require('goog.testing.jsunit');



  function testMockClockWasInstalled() {
    var clock = new goog.testing.MockClock();
    var originalTimeout = window.setTimeout;
    clock.install();
    assertNotEquals(window.setTimeout, originalTimeout);
    setTimeout(function() {}, 100);
    assertEquals(1, clock.getTimeoutsMade());
    setInterval(function() {}, 200);
    assertEquals(2, clock.getTimeoutsMade());
    clock.uninstall();
    assertEquals(window.setTimeout, originalTimeout);
    assertNull(clock.replacer_);
  }


  function testSetTimeoutAndTick() {
    var clock = new goog.testing.MockClock(true);
    var m5 = false, m10 = false, m15 = false, m20 = false;
    setTimeout(function() { m5 = true; }, 5);
    setTimeout(function() { m10 = true; }, 10);
    setTimeout(function() { m15 = true; }, 15);
    setTimeout(function() { m20 = true; }, 20);
    assertEquals(4, clock.getTimeoutsMade());

    assertEquals(4, clock.tick(4));
    assertEquals(4, clock.getCurrentTime());

    assertFalse(m5);
    assertFalse(m10);
    assertFalse(m15);
    assertFalse(m20);

    assertEquals(5, clock.tick(1));
    assertEquals(5, clock.getCurrentTime());

    assertTrue('m5 should now be true', m5);
    assertFalse(m10);
    assertFalse(m15);
    assertFalse(m20);

    assertEquals(10, clock.tick(5));
    assertEquals(10, clock.getCurrentTime());

    assertTrue('m5 should be true', m5);
    assertTrue('m10 should now be true', m10);
    assertFalse(m15);
    assertFalse(m20);

    assertEquals(15, clock.tick(5));
    assertEquals(15, clock.getCurrentTime());

    assertTrue('m5 should be true', m5);
    assertTrue('m10 should be true', m10);
    assertTrue('m15 should now be true', m15);
    assertFalse(m20);

    assertEquals(20, clock.tick(5));
    assertEquals(20, clock.getCurrentTime());

    assertTrue('m5 should be true', m5);
    assertTrue('m10 should be true', m10);
    assertTrue('m15 should be true', m15);
    assertTrue('m20 should now be true', m20);

    clock.uninstall();
  }


  function testSetInterval() {
    var clock = new goog.testing.MockClock(true);
    var times = 0
    setInterval(function() { times++; }, 100);

    clock.tick(500);
    assertEquals(5, times);
    clock.tick(100);
    assertEquals(6, times);
    clock.tick(100);
    assertEquals(7, times);
    clock.tick(50);
    assertEquals(7, times);
    clock.tick(50);
    assertEquals(8, times);

    clock.uninstall();
  }


  function testClearTimeout() {
    var clock = new goog.testing.MockClock(true);
    var ran = false;
    var c = setTimeout(function() { ran = true; }, 100);
    clock.tick(50);
    assertFalse(ran);
    clearTimeout(c);
    clock.tick(100);
    assertFalse(ran);
    clock.uninstall();
  }


  function testClearInterval() {
    var clock = new goog.testing.MockClock(true);
    var times = 0
    var c = setInterval(function() { times++; }, 100);

    clock.tick(500);
    assertEquals(5, times);
    clock.tick(100);
    assertEquals(6, times);
    clock.tick(100);
    clearInterval(c);
    assertEquals(7, times);
    clock.tick(50);
    assertEquals(7, times);
    clock.tick(50);
    assertEquals(7, times);

    clock.uninstall();
  }


  function testClearInterval2() {
    // Tests that we can clear the interval from inside the function
    var clock = new goog.testing.MockClock(true);
    var times = 0
    var c = setInterval(function() {
      times++;
      if (times == 6) {
        clearInterval(c);
      }
    }, 100);

    clock.tick(500);
    assertEquals(5, times);
    clock.tick(100);
    assertEquals(6, times);
    clock.tick(100);
    assertEquals(6, times);
    clock.tick(50);
    assertEquals(6, times);
    clock.tick(50);
    assertEquals(6, times);

    clock.uninstall();
  }


  function testMockGoogNow() {
    assertNotEquals(0, goog.now());
    var clock = new goog.testing.MockClock(true);
    assertEquals(0, goog.now());
    clock.tick(50);
    assertEquals(50, goog.now());
    clock.uninstall();
    assertNotEquals(50, goog.now());
  }


  function testTimeoutDelay() {
    var clock = new goog.testing.MockClock(true);
    var m5 = false, m10 = false, m20 = false;
    setTimeout(function() { m5 = true; }, 5);
    setTimeout(function() { m10 = true; }, 10);
    setTimeout(function() { m20 = true; }, 20);

    // Fire 3ms early, so m5 fires at t=2
    clock.setTimeoutDelay(-3);
    clock.tick(1);
    assertFalse(m5);
    assertFalse(m10);
    clock.tick(1);
    assertTrue(m5);
    assertFalse(m10);

    // Fire 3ms late, so m10 fires at t=13
    clock.setTimeoutDelay(3);
    assertEquals(12, clock.tick(10));
    assertEquals(12, clock.getCurrentTime());
    assertFalse(m10);
    clock.tick(1);
    assertTrue(m10);
    assertFalse(m20);

    // Fire 10ms early, so m20 fires now, since it's after t=10
    clock.setTimeoutDelay(-10);
    assertFalse(m20);
    assertEquals(14, clock.tick(1));
    assertEquals(14, clock.getCurrentTime());
    assertTrue(m20);

    clock.uninstall();
  }


  function testTimerCallbackCanCreateIntermediateTimer() {
    var clock = new goog.testing.MockClock(true);
    var sequence = [];

    // Create 3 timers: 1, 2, and 3.  Timer 1 should fire at T=1, timer 2 at
    // T=2, and timer 3 at T=3.  The catch: Timer 2 is created by the
    // callback within timer 0.

    // Testing method: Create a simple string sequencing each timer and at
    // what time it fired.

    setTimeout(function() {
      sequence.push('timer1 at T=' + goog.now());
      setTimeout(function() {
        sequence.push('timer2 at T=' + goog.now());
      }, 1);
    }, 1);

    setTimeout(function() {
      sequence.push('timer3 at T=' + goog.now());
    }, 3);

    clock.tick(4);

    assertEquals(
        'Each timer should fire in sequence at the correct time.',
        'timer1 at T=1, timer2 at T=2, timer3 at T=3',
        sequence.join(', '));

    clock.uninstall();
  }


  function testCorrectArgumentsPassedToCallback() {
    var clock = new goog.testing.MockClock(true);
    var timeoutId;
    var timeoutExecuted = false;

    timeoutId = setTimeout(function(arg) {
      assertEquals('"this" must be goog.global',
          goog.global, this);
      assertEquals('The timeout ID must be the first parameter',
          timeoutId, arg);
      assertEquals('Exactly one argument must be passed',
          1, arguments.length);
      timeoutExecuted = true;
    }, 1);

    clock.tick(4);

    assertTrue('The timeout was not executed', timeoutExecuted);

    clock.uninstall();
  }


  function testTickZero() {
    var clock = new goog.testing.MockClock(true);
    var calls = 0;

    setTimeout(function() {
      assertEquals('I need to be first', 0, calls);
      calls++;
    }, 0);

    setTimeout(function() {
      assertEquals('I need to be second', 1, calls);
      calls++;
    }, 0);

    clock.tick(0);
    assertEquals(2, calls);

    setTimeout(function() {
      assertEquals('I need to be third', 2, calls);
      calls++;
    }, 0);

    clock.tick(0);
    assertEquals(3, calls);

    assertEquals('Time should still be zero', 0, goog.now());

    clock.uninstall();
  }


  function testReset() {
    var clock = new goog.testing.MockClock(true);

    setTimeout(function() {
      fail('Timeouts should be cleared after a reset');
    }, 0);

    clock.reset();
    clock.tick(999999);
    clock.uninstall();
  }


  function testQueueInsertionHelper() {
    var queue = [];

    function queueToString() {
      var buffer = [];
      for (var i = 0; i < queue.length; i++) {
        buffer.push(queue[i].runAtMillis);
      }
      return buffer.join(',');
    }

    goog.testing.MockClock.insert_({runAtMillis: 2}, queue);
    assertEquals('Only item',
        '2', queueToString());

    goog.testing.MockClock.insert_({runAtMillis: 4}, queue);
    assertEquals('Biggest item',
        '4,2', queueToString());

    goog.testing.MockClock.insert_({runAtMillis: 5}, queue);
    assertEquals('An even bigger item',
        '5,4,2', queueToString());

    goog.testing.MockClock.insert_({runAtMillis: 1}, queue);
    assertEquals('Smallest item',
        '5,4,2,1', queueToString());

    goog.testing.MockClock.insert_({runAtMillis: 1, dup: true}, queue);
    assertEquals('Duplicate smallest item',
        '5,4,2,1,1', queueToString());
    assertTrue('Duplicate item comes at a smaller index', queue[3].dup);

    goog.testing.MockClock.insert_({runAtMillis: 3}, queue);
    goog.testing.MockClock.insert_({runAtMillis: 3, dup:true}, queue);
    assertEquals('Duplicate a middle item',
        '5,4,3,3,2,1,1', queueToString());
    assertTrue('Duplicate item comes at a smaller index', queue[2].dup);
  }

  function testIsTimeoutSet() {
    var clock = new goog.testing.MockClock(true);
    var timeoutKey = setTimeout(function(){}, 1);
    assertTrue('Timeout ' + timeoutKey + ' should be set',
        clock.isTimeoutSet(timeoutKey));
    var nextTimeoutKey = timeoutKey + 1;
    assertFalse('Timeout ' + nextTimeoutKey + ' should not be set',
        clock.isTimeoutSet(nextTimeoutKey));
    clearTimeout(timeoutKey);
    assertFalse('Timeout ' + timeoutKey + ' should no longer be set',
        clock.isTimeoutSet(timeoutKey));
    var newTimeoutKey = setTimeout(function(){}, 1);
    clock.tick(5);
    assertFalse('Timeout ' + timeoutKey + ' should not be set',
        clock.isTimeoutSet(timeoutKey));
    assertTrue('Timeout ' + newTimeoutKey + ' should be set',
        clock.isTimeoutSet(newTimeoutKey));
    clock.uninstall();
  }

  function testBalksOnTimeoutsGreaterThanMaxInt() {
    // Browsers have trouble with timeout greater than max int, so we
    // want Mock Clock to fail if this happens.
    var clock = new goog.testing.MockClock(true);
    // Functions on window don't seem to be able to throw exceptions in
    // IE6.  Explicitly reading the property makes it work.
    var setTimeout = window.setTimeout;
    assertThrows('Timeouts > MAX_INT should fail',
        function() {
           setTimeout(goog.nullFunction, 2147483648);
        });
    assertThrows('Timeouts much greater than MAX_INT should fail',
        function() {
          setTimeout(goog.nullFunction, 2147483648 * 10);
        });
    clock.uninstall();
  }

  function testCorrectSetTimeoutIsRestored() {
    var original = window.setTimeout;
    var safe = goog.functions.error('should not have been called');
    try {
      window.setTimeout = safe;
      var clock = new goog.testing.MockClock(true);
      assertNotEquals('setTimeout is replaced', safe, window.setTimeout);
      clock.uninstall();
      // NOTE: If this assertion proves to be flaky in IE, the string value of
      // the two functions have to be compared as described in
      // goog.testing.TestCase#finalize.
      assertEquals('setTimeout is restored', safe, window.setTimeout);
    } finally {
      window.setTimeout = original;
    }
  }

">n/a</td></tr>
<tr><td>mockrandom_test.html</td><td>Success</td><td> 2 passed, 0 failed.</td><td title="

  goog.require('goog.testing.MockRandom');
  goog.require('goog.testing.jsunit');



  function testMockRandomInstall() {
    var random = new goog.testing.MockRandom([]);
    var originalRandom = Math.random;

    assertFalse(!!random.installed_);

    random.install();
    assertTrue(random.installed_);
    assertNotEquals(Math.random, originalRandom);

    random.uninstall();
    assertFalse(random.installed_);
    assertEquals(originalRandom, Math.random);
  }

  function testMockRandomRandom() {
    var random = new goog.testing.MockRandom([], true);

    assertFalse(random.hasMoreValues());

    random.inject(2);
    assertTrue(random.hasMoreValues());
    assertEquals(2, Math.random());

    random.inject([1, 2, 3]);
    assertTrue(random.hasMoreValues());
    assertEquals(1, Math.random());
    assertEquals(2, Math.random());
    assertEquals(3, Math.random());
    assertFalse(random.hasMoreValues());
    assertNotUndefined(Math.random());
  }
  
">n/a</td></tr>
<tr><td>expectedfailures_test.html</td><td>Fail</td><td> 0 passed, 7 failed.</td><td title="

  goog.require('goog.testing.ExpectedFailures');
  goog.require('goog.testing.jsunit');


  var count, expectedFailures, lastLevel, lastMessage;

  // Stub out the logger.
  goog.testing.ExpectedFailures.prototype.logger_.log = function(level,
      message) {
    lastLevel = level;
    lastMessage = message;
    count++;
  };

  function setUp() {
    expectedFailures = new goog.testing.ExpectedFailures();
    count = 0;
    lastLevel = lastMessage = '';
  }

  // Individual test methods.

  function testNoExpectedFailure() {
    expectedFailures.handleTearDown()
  }

  function testPreventExpectedFailure() {
    expectedFailures.expectFailureFor(true);

    expectedFailures.handleException(new goog.testing.JsUnitException('', ''));
    assertEquals('Should have logged a message', 1, count);
    assertEquals('Should have logged an info message',
        goog.debug.Logger.Level.INFO, lastLevel);
    assertContains('Should log a suppression message',
        'Suppressing test failure', lastMessage);

    expectedFailures.handleTearDown();
    assertEquals('Should not have logged another message', 1, count);
  }

  function testDoNotPreventException() {
    var ex = 'exception';
    expectedFailures.expectFailureFor(false);
    var e = assertThrows('Should have rethrown exception', function() {
      expectedFailures.handleException(ex);
    });
    assertEquals('Should rethrow same exception', ex, e);
  }

  function testExpectedFailureDidNotOccur() {
    expectedFailures.expectFailureFor(true);

    expectedFailures.handleTearDown();
    assertEquals('Should have logged a message', 1, count);
    assertEquals('Should have logged a warning',
        goog.debug.Logger.Level.WARNING, lastLevel);
    assertContains('Should log a suppression message',
        'Expected a test failure', lastMessage);
  }

  function testRun() {
    expectedFailures.expectFailureFor(true);

    expectedFailures.run(function() {
      fail('Expected failure');
    });

    assertEquals('Should have logged a message', 1, count);
    assertEquals('Should have logged an info message',
        goog.debug.Logger.Level.INFO, lastLevel);
    assertContains('Should log a suppression message',
        'Suppressing test failure', lastMessage);

    expectedFailures.handleTearDown();
    assertEquals('Should not have logged another message', 1, count);
  }

  function testRunStrict() {
    expectedFailures.expectFailureFor(true);

    var ex = assertThrows(function() {
      expectedFailures.run(function() {
        // Doesn't fail!
      });
    });
    assertContains(
        "Expected a test failure in 'testRunStrict' but the test passed.",
        ex.message);
  }

  function testRunLenient() {
    expectedFailures.expectFailureFor(true);

    expectedFailures.run(function() {
      // Doesn't fail!
    }, true);
    expectedFailures.handleTearDown();
    assertEquals('Should have logged a message', 1, count);
    assertEquals('Should have logged a warning',
        goog.debug.Logger.Level.WARNING, lastLevel);
    assertContains('Should log a suppression message',
        'Expected a test failure', lastMessage);
  }

">7 of 7 tests run in 14ms.<br />0 passed, 7 failed.<br />2 ms/test. 1 files loaded.<br />ERROR in testDoNotPreventException<br />Object #<Object> has no method 'createElement'<br />ERROR in testExpectedFailureDidNotOccur<br />Object #<Object> has no method 'createElement'<br />ERROR in testNoExpectedFailure<br />Object #<Object> has no method 'createElement'<br />ERROR in testPreventExpectedFailure<br />Object #<Object> has no method 'createElement'<br />ERROR in testRun<br />Object #<Object> has no method 'createElement'<br />ERROR in testRunLenient<br />Object #<Object> has no method 'createElement'<br />ERROR in testRunStrict<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>rendererasserts_test.html</td><td>Success</td><td> 2 passed, 0 failed.</td><td title="

    goog.require('goog.ui.ControlRenderer');
    goog.require('goog.testing.ui.rendererasserts');
    goog.require('goog.testing.asserts');
    goog.require('goog.testing.jsunit');
  

    function testSuccess() {
      function GoodRenderer() {}

      goog.testing.ui.rendererasserts.
          assertNoGetCssClassCallsInConstructor(GoodRenderer);
    }

    function testFailure() {
      function BadRenderer() {
        goog.ui.ControlRenderer.call(this);
        this.myClass = this.getCssClass();
      }
      goog.inherits(BadRenderer, goog.ui.ControlRenderer);

      var ex = assertThrows(
          'Expected assertNoGetCssClassCallsInConstructor to fail.',
          function() {
            goog.testing.ui.rendererasserts.
                assertNoGetCssClassCallsInConstructor(BadRenderer);
          });
      assertTrue('Expected assertNoGetCssClassCallsInConstructor to throw a' +
          ' jsunit exception', ex.isJsUnitException);
      assertContains('getCssClass', ex.message);
    }
  ">n/a</td></tr>
<tr><td>performancetimer_test.html</td><td>Fail</td><td> 1 passed, 2 failed.</td><td title="

    goog.require('goog.dom');
    goog.require('goog.testing.PerformanceTimer');
    goog.require('goog.testing.jsunit');
  

    var sandbox = document.getElementById('sandbox');
    var timer;

    // Fast test function, pretty much guaranteed to run in under 5,000ms.
    function fastTestFunction() {
      for (var i = 0; i < 10; i++) {
        var div = document.createElement('div');
        div.innerHTML = 'Div no. ' + i;
        sandbox.appendChild(div);
      }
    }

    // Slow test function, pretty much guaranteed to run longer than 1ms.
    function slowTestFunction() {
      for (var i = 0; i < 1000; i++) {
        var span = document.createElement('span');
        span.id = 'span_' + i;
        span.className = 'foo bar';
        span.innerHTML = 'Span no. ' + i;

        var div = document.createElement('div');
        div.id = 'div_ ' + i;
        div.className = 'foo bar';
        div.tabIndex = i;
        div.appendChild(span);

        sandbox.appendChild(div);
      }
    }

    function setUp() {
      timer = new goog.testing.PerformanceTimer();
    }
    
    function tearDown() {
      timer = null;
      goog.dom.removeChildren(sandbox);
    }

    function testConstructor() {
      assertTrue('Timer must be an instance of goog.testing.PerformanceTimer',
          timer instanceof goog.testing.PerformanceTimer);
      assertEquals('Timer must collect the default number of samples', 10,
          timer.getNumSamples());
      assertEquals('Timer must have the default timeout interval', 5000,
          timer.getTimeoutInterval());
    }

    function testRun() {
      // Fast test function should complete successfully in under 5 seconds...
      var results = timer.run(fastTestFunction);

      assertNotNull('Results must be available',
          results);
      assertTrue('Average must be a nonnegative number',
          results['average'] >= 0);
      assertEquals('Count must be as expected', 10,
          results['count']);
      assertTrue('Maximum must be a nonnegative number',
          results['maximum'] >= 0);
      assertTrue('Mimimum must be a nonnegative number',
          results['minimum'] >= 0);
      assertTrue('Standard deviation must be a nonnegative number',
          results['standardDeviation'] >= 0);
      assertTrue('Total must be a nonnegative number',
          results['total'] >= 0);
      assertTrue('Average must be between minimum and maximum',
          results['minimum'] <= results['average'] &&
          results['average'] <= results['maximum']);
    }

    function testTimeout() {
      // Slow test function can't finish 10 runs in under 1 millisecond...
      timer.setTimeoutInterval(1);
      var results = timer.run(slowTestFunction);

      assertNotNull('Results must be available',
          results);
      assertTrue('Count must less than expected',
          results['count'] < timer.getNumSamples());
    }
  ">3 of 3 tests run in 11ms.<br />1 passed, 2 failed.<br />4 ms/test. 1 files loaded.<br />ERROR in testRun<br />Object #<Object> has no method 'createElement'<br />ERROR in testTimeout<br />Object #<Object> has no method 'createElement'<br /></td></tr>
<tr><td>json_test.html</td><td>Success</td><td> 30 passed, 0 failed.</td><td title="

  goog.require('goog.json');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');



function allChars(start, end, opt_allowControlCharacters) {
  var sb = [];
  for (var i = start; i < end; i++) {
    // unicode without the control characters 0x00 - 0x1f, 0x7f - 0x9f
    if (opt_allowControlCharacters || i > 0x1f && i < 0x7f || i > 0x9f) {
      sb.push(String.fromCharCode(i));
    }
  }
  return sb.join('');
}

// serialization

function testStringSerialize() {

  assertEquals('Empty string', goog.json.serialize(''), '""');

  // unicode
  var str = allChars(0, 10000);
  eval(goog.json.serialize(str));

  assertEquals('true as a string', goog.json.serialize('true'), '"true"');
  assertEquals('false as a string', goog.json.serialize('false'), '"false"');
  assertEquals('null as a string', goog.json.serialize('null'), '"null"');
  assertEquals('number as a string', goog.json.serialize('0'), '"0"');
}

function testNullSerialize() {
  assertEquals('null', goog.json.serialize(null), 'null');
  assertEquals('undefined', goog.json.serialize(undefined), 'null');

  assertNotEquals('0', goog.json.serialize(0), 'null');
  assertNotEquals('""', goog.json.serialize(''), 'null');
  assertNotEquals('false', goog.json.serialize(false), 'null');
}

function testNumberSerialize() {
  assertEquals('0', goog.json.serialize(0), '0');
  assertEquals('12345', goog.json.serialize(12345), '12345');
  assertEquals('-12345', goog.json.serialize(-12345), '-12345');

  assertEquals('0.1', goog.json.serialize(0.1), '0.1');
  // the leading zero may not be omitted
  assertEquals('.1', goog.json.serialize(.1), '0.1');

  // no leading +
  assertEquals('+1',goog.json.serialize(+1), '1');

  // either format is OK
  var s = goog.json.serialize(1e50);
  assertTrue('1e50', s == "1e50" ||
                     s == "1E50" ||
                     s == "1e+50" ||
                     s == "1E+50");

  // either format is OK
  s = goog.json.serialize(1e-50);
  assertTrue('1e50', s == "1e-50" || s == "1E-50");

  // These numbers cannot be represented in JSON
  assertEquals('NaN', goog.json.serialize(NaN), 'null');
  assertEquals('Infinity', goog.json.serialize(Infinity), 'null');
  assertEquals('-Infinity', goog.json.serialize(-Infinity), 'null');
}

function testBooleanSerialize() {
  assertEquals('true', goog.json.serialize(true), 'true');
  assertEquals('false', goog.json.serialize(false), 'false');

  assertNotEquals('0', goog.json.serialize(0), 'false');
  assertNotEquals('"false"', goog.json.serialize('false'), 'false');
  assertNotEquals('null', goog.json.serialize(null), 'false');
  assertNotEquals('undefined', goog.json.serialize(undefined), 'false');
  assertNotEquals('NaN', goog.json.serialize(NaN), 'false');

  assertNotEquals('1', goog.json.serialize(1), 'true');
  assertNotEquals('"true"', goog.json.serialize('true'), 'true');
  assertNotEquals('{}', goog.json.serialize({}), 'true');
  assertNotEquals('[]', goog.json.serialize([]), 'true');
}

function testArraySerialize() {
  assertEquals('[]', goog.json.serialize([]), '[]');
  assertEquals('[1]', goog.json.serialize([1]), '[1]');
  assertEquals('[1,2]', goog.json.serialize([1,2]), '[1,2]');
  assertEquals('[1,2,3]', goog.json.serialize([1,2,3]), '[1,2,3]');
  assertEquals('[[]]', goog.json.serialize([[]]), '[[]]');

  assertNotEquals('{length:0}', goog.json.serialize({length:0}), '[]');
}

function testObjectSerialize_emptyObject() {
  assertEquals('{}', goog.json.serialize({}), '{}');
}

function testObjectSerialize_oneItem() {
  assertEquals('{"a":"b"}', goog.json.serialize({a:'b'}), '{"a":"b"}');
}

function testObjectSerialize_twoItems() {
  assertEquals('{"a":"b","c":"d"}',
               goog.json.serialize({a:'b',c:'d'}),
               '{"a":"b","c":"d"}');
}

function testObjectSerialize_whitespace() {
  assertEquals('{" ":" "}', goog.json.serialize({' ':' '}), '{" ":" "}');
}

function testSerializeSkipFunction() {
  var object = {
    s: 'string value',
    b: true,
    i: 100,
    f: function() { var x = 'x'; }
  };
  assertEquals('failed to serialize function', '',
      goog.json.serialize(object.f));
  assertEquals('failed to serialize object with function',
      '{"s":"string value","b":true,"i":100}',
      goog.json.serialize(object));
}

function testObjectSerialize_array() {
  assertNotEquals('[0,1]', goog.json.serialize([0,1]), '{"0":"0","1":"1"}');
}

function testObjectSerialize_recursion() {
  if (goog.userAgent.WEBKIT) {
    return; // this makes safari 4 crash.
  }

  var anObject = {};
  anObject.thisObject = anObject;
  assertThrows('expected recursion exception', function() {
      goog.json.serialize(anObject);
  });
}

function testObjectSerializeWithHasOwnProperty() {
  var object = {'hasOwnProperty': null};
  if (goog.userAgent.IE && !goog.userAgent.isVersion('9')) {
    assertEquals('{}', goog.json.serialize(object));
  } else {
    assertEquals('{"hasOwnProperty":null}', goog.json.serialize(object));
  }
}

// parsing

function testStringParse() {

  assertEquals('Empty string', goog.json.parse('""'), '');
  assertEquals('whitespace string', goog.json.parse('" "'), ' ');

  // unicode without the control characters 0x00 - 0x1f, 0x7f - 0x9f
  var str = allChars(0, 1000);
  var jsonString = goog.json.serialize(str);
  var a = eval(jsonString);
  assertEquals('unicode string', goog.json.parse(jsonString), a);

  assertEquals('true as a string', goog.json.parse('"true"'), 'true');
  assertEquals('false as a string', goog.json.parse('"false"'), 'false');
  assertEquals('null as a string', goog.json.parse('"null"'), 'null');
  assertEquals('number as a string', goog.json.parse('"0"'), '0');
}

function testStringUnsafeParse() {

  assertEquals('Empty string', goog.json.unsafeParse('""'), '');
  assertEquals('whitespace string', goog.json.unsafeParse('" "'), ' ');

  // unicode
  var str = allChars(0, 1000);
  var jsonString = goog.json.serialize(str);
  var a = eval(jsonString);
  assertEquals('unicode string', goog.json.unsafeParse(jsonString), a);

  assertEquals('true as a string', goog.json.unsafeParse('"true"'), 'true');
  assertEquals('false as a string', goog.json.unsafeParse('"false"'), 'false');
  assertEquals('null as a string', goog.json.unsafeParse('"null"'), 'null');
  assertEquals('number as a string', goog.json.unsafeParse('"0"'), '0');
}

function testNullParse() {
  assertEquals('null', goog.json.parse('null'), null);

  assertNotEquals('0', goog.json.parse('0'), null);
  assertNotEquals('""', goog.json.parse('""'), null);
  assertNotEquals('false', goog.json.parse('false'), null);
}

function testNullUnsafeParse() {
  assertEquals('null', goog.json.unsafeParse('null'), null);

  assertNotEquals('0', goog.json.unsafeParse('0'), null);
  assertNotEquals('""', goog.json.unsafeParse('""'), null);
  assertNotEquals('false', goog.json.unsafeParse('false'), null);
}

function testNumberParse() {
  assertEquals('0', goog.json.parse('0'), 0);
  assertEquals('12345', goog.json.parse('12345'), 12345);
  assertEquals('-12345', goog.json.parse('-12345'), -12345);

  assertEquals('0.1', goog.json.parse('0.1'), 0.1);

  // either format is OK
  assertEquals(1e50, goog.json.parse('1e50'));
  assertEquals(1e50, goog.json.parse('1E50'));
  assertEquals(1e50, goog.json.parse('1e+50'));
  assertEquals(1e50, goog.json.parse('1E+50'));

  // either format is OK
  assertEquals(1e-50, goog.json.parse('1e-50'));
  assertEquals(1e-50, goog.json.parse('1E-50'));
}

function testNumberUnsafeParse() {
  assertEquals('0', goog.json.unsafeParse('0'), 0);
  assertEquals('12345', goog.json.unsafeParse('12345'), 12345);
  assertEquals('-12345', goog.json.unsafeParse('-12345'), -12345);

  assertEquals('0.1', goog.json.unsafeParse('0.1'), 0.1);

  // either format is OK
  assertEquals(1e50, goog.json.unsafeParse('1e50'));
  assertEquals(1e50, goog.json.unsafeParse('1E50'));
  assertEquals(1e50, goog.json.unsafeParse('1e+50'));
  assertEquals(1e50, goog.json.unsafeParse('1E+50'));

  // either format is OK
  assertEquals(1e-50, goog.json.unsafeParse('1e-50'));
  assertEquals(1e-50, goog.json.unsafeParse('1E-50'));
}

function testBooleanParse() {
  assertEquals('true', goog.json.parse('true'), true);
  assertEquals('false', goog.json.parse('false'), false);

  assertNotEquals('0', goog.json.parse('0'), false);
  assertNotEquals('"false"', goog.json.parse('"false"'), false);
  assertNotEquals('null', goog.json.parse('null'), false);

  assertNotEquals('1', goog.json.parse('1'), true);
  assertNotEquals('"true"', goog.json.parse('"true"'), true);
  assertNotEquals('{}', goog.json.parse('{}'), true);
  assertNotEquals('[]', goog.json.parse('[]'), true);
}

function testBooleanUnsafeParse() {
  assertEquals('true', goog.json.unsafeParse('true'), true);
  assertEquals('false', goog.json.unsafeParse('false'), false);

  assertNotEquals('0', goog.json.unsafeParse('0'), false);
  assertNotEquals('"false"', goog.json.unsafeParse('"false"'), false);
  assertNotEquals('null', goog.json.unsafeParse('null'), false);

  assertNotEquals('1', goog.json.unsafeParse('1'), true);
  assertNotEquals('"true"', goog.json.unsafeParse('"true"'), true);
  assertNotEquals('{}', goog.json.unsafeParse('{}'), true);
  assertNotEquals('[]', goog.json.unsafeParse('[]'), true);
}

function testArrayParse() {
  function arrayEquals(a1, a2) {
    if (a1.length != a2.length) {
      return false;
    }
    for (var i = 0; i < a1.length; i++) {
      if (a1[i] != a2[i]) {
        return false;
      }
    }
    return true;
  }

  assertTrue('[]', arrayEquals(goog.json.parse('[]'), []));
  assertTrue('[1]', arrayEquals(goog.json.parse('[1]'), [1]));
  assertTrue('[1,2]', arrayEquals(goog.json.parse('[1,2]'), [1,2]));
  assertTrue('[1,2,3]', arrayEquals(goog.json.parse('[1,2,3]'), [1,2,3]));
  assertTrue('[[]]', arrayEquals(goog.json.parse('[[]]')[0], []));

  // make sure we do not get an array for something that looks like an array
  assertFalse('{length:0}', 'push' in goog.json.parse('{"length":0}'));
}

function testArrayUnsafeParse() {
  function arrayEquals(a1, a2) {
    if (a1.length != a2.length) {
      return false;
    }
    for (var i = 0; i < a1.length; i++) {
      if (a1[i] != a2[i]) {
        return false;
      }
    }
    return true;
  }

  assertTrue('[]', arrayEquals(goog.json.unsafeParse('[]'), []));
  assertTrue('[1]', arrayEquals(goog.json.unsafeParse('[1]'), [1]));
  assertTrue('[1,2]', arrayEquals(goog.json.unsafeParse('[1,2]'), [1,2]));
  assertTrue('[1,2,3]', arrayEquals(goog.json.unsafeParse('[1,2,3]'), [1,2,3]));
  assertTrue('[[]]', arrayEquals(goog.json.unsafeParse('[[]]')[0], []));

  // make sure we do not get an array for something that looks like an array
  assertFalse('{length:0}', 'push' in goog.json.unsafeParse('{"length":0}'));
}

function testObjectParse() {
  function objectEquals(a1, a2) {
    for (var key in a1) {
      if (a1[key] != a2[key]) {
        return false;
      }
    }
    return true;
  }

  assertTrue('{}', objectEquals(goog.json.parse('{}'), {}));
  assertTrue('{"a":"b"}', objectEquals(goog.json.parse('{"a":"b"}'), {a:'b'}));
  assertTrue('{"a":"b","c":"d"}',
             objectEquals(goog.json.parse('{"a":"b","c":"d"}'),
             {a:'b',c:'d'}));
  assertTrue('{" ":" "}', objectEquals(goog.json.parse('{" ":" "}'), {' ':' '}));

  // make sure we do not get an Object when it is really an array
  assertTrue('[0,1]', 'length' in goog.json.parse('[0,1]'));
}

function testObjectUnsafeParse() {
  function objectEquals(a1, a2) {
    for (var key in a1) {
      if (a1[key] != a2[key]) {
        return false;
      }
    }
    return true;
  }

  assertTrue('{}', objectEquals(goog.json.unsafeParse('{}'), {}));
  assertTrue('{"a":"b"}', objectEquals(goog.json.unsafeParse('{"a":"b"}'), {a:'b'}));
  assertTrue('{"a":"b","c":"d"}',
             objectEquals(goog.json.unsafeParse('{"a":"b","c":"d"}'),
             {a:'b',c:'d'}));
  assertTrue('{" ":" "}', objectEquals(goog.json.unsafeParse('{" ":" "}'), {' ':' '}));

  // make sure we do not get an Object when it is really an array
  assertTrue('[0,1]', 'length' in goog.json.unsafeParse('[0,1]'));
}


function testForValidJson() {
  function error_(msg, s) {
    assertThrows(msg + ', Should have raised an exception: ' + s,
        goog.partial(goog.json.parse, s));
  }

  error_('Non closed string', '"dasdas');
  error_('undefined is not valid json', 'undefined');

  // These numbers cannot be represented in JSON
  error_('NaN cannot be presented in JSON', 'NaN');
  error_('Infinity cannot be presented in JSON', 'Infinity');
  error_('-Infinity cannot be presented in JSON', '-Infinity');
}

function testIsNotValid() {
  assertFalse(goog.json.isValid_('t'));
  assertFalse(goog.json.isValid_('r'));
  assertFalse(goog.json.isValid_('u'));
  assertFalse(goog.json.isValid_('e'));
  assertFalse(goog.json.isValid_('f'));
  assertFalse(goog.json.isValid_('a'));
  assertFalse(goog.json.isValid_('l'));
  assertFalse(goog.json.isValid_('s'));
  assertFalse(goog.json.isValid_('n'));
  assertFalse(goog.json.isValid_('E'));

  assertFalse(goog.json.isValid_('+'));
  assertFalse(goog.json.isValid_('-'));

  assertFalse(goog.json.isValid_('t++'));
  assertFalse(goog.json.isValid_('++t'));
  assertFalse(goog.json.isValid_('t--'));
  assertFalse(goog.json.isValid_('--t'));
  assertFalse(goog.json.isValid_('-t'));
  assertFalse(goog.json.isValid_('+t'));

  assertFalse(goog.json.isValid_('"\\"')); // "\"
  assertFalse(goog.json.isValid_('"\\'));  // "\

  // multiline string using \ at the end is not valid
  assertFalse(goog.json.isValid_('"a\\\nb"'));


  assertFalse(goog.json.isValid_('"\n"'));
  assertFalse(goog.json.isValid_('"\r"'));
  assertFalse(goog.json.isValid_('"\r\n"'));
  // Disallow the unicode newlines
  assertFalse(goog.json.isValid_('"\u2028"'));
  assertFalse(goog.json.isValid_('"\u2029"'));

  assertFalse(goog.json.isValid_(' '));
  assertFalse(goog.json.isValid_('\n'));
  assertFalse(goog.json.isValid_('\r'));
  assertFalse(goog.json.isValid_('\r\n'));

  assertFalse(goog.json.isValid_('t.r'));

  assertFalse(goog.json.isValid_('1e'));
  assertFalse(goog.json.isValid_('1e-'));
  assertFalse(goog.json.isValid_('1e+'));

  assertFalse(goog.json.isValid_('1e-'));

  assertFalse(goog.json.isValid_('"\\\u200D\\"'));
  assertFalse(goog.json.isValid_('"\\\0\\"'));
  assertFalse(goog.json.isValid_('"\\\0"'));
  assertFalse(goog.json.isValid_('"\\0"'));

  assertFalse(goog.json.isValid_('"\\\u200D\\", alert(\'foo\') //"\n'));
}

function testIsValid() {
  assertTrue(goog.json.isValid_('\n""\n'));
  assertTrue(goog.json.isValid_('[1\n,2\r,3\u2028\n,4\u2029]'));
  assertTrue(goog.json.isValid_('"\x7f"'));
  // Test tab characters in json.
  assertTrue(goog.json.isValid_('{"\t":"\t"}'));
}

function testDoNotSerializeProto() {
  function F() {};
  F.prototype = {
    c: 3
  };

  var obj = new F;
  obj.a = 1;
  obj.b = 2;

  assertEquals('Should not follow the prototype chain',
               '{"a":1,"b":2}',
               goog.json.serialize(obj));
}

function testEscape() {
  var unescaped = '1a*/]';
  assertEquals('Should not escape',
               '"' + unescaped + '"',
               goog.json.serialize(unescaped));

  var escaped = '\n\x7f\u1049';
  assertEquals('Should escape',
               '',
               findCommonChar(escaped, goog.json.serialize(escaped)));
  assertEquals('Should eval to the same string after escaping',
               escaped,
               goog.json.parse(goog.json.serialize(escaped)));
}

/**
 * @param {string} a
 * @param {string} b
 * @return {string} any common character between two strings a and b.
 */
function findCommonChar(a, b) {
  for (var i = 0; i < b.length; i++) {
    if (a.indexOf(b.charAt(i)) >= 0) {
      return b.charAt(i);
    }
  }
  return '';
}

">n/a</td></tr>
<tr><td>relative_test.html</td><td>Success</td><td> 6 passed, 0 failed.</td><td title="

  goog.LOCALE = 'en_US';
  goog.require('goog.testing.jsunit');
  goog.require('goog.date.relative');


  // Timestamp to base times for test on.
  var baseTime = new Date(2009, 2, 23, 14, 31, 6).getTime();

  // Ensure goog.now returns a constant timestamp.
  goog.now = function() {
    return baseTime;
  };


  function testFormatRelativeForPastDates() {
    var fn = goog.date.relative.format;

    assertEquals('Should round seconds to the minute below',
        '0 minutes ago', fn(timestamp('23 March 2009 14:30:10')));

    assertEquals('Should round seconds to the minute below',
        '1 minute ago',
        fn(timestamp('23 March 2009 14:29:56')));

    assertEquals('Should round seconds to the minute below',
        '2 minutes ago', fn(timestamp('23 March 2009 14:29:00')));

    assertEquals('10 minutes ago', fn(timestamp('23 March 2009 14:20:10')));
    assertEquals('59 minutes ago', fn(timestamp('23 March 2009 13:31:42')));
    assertEquals('2 hours ago', fn(timestamp('23 March 2009 12:20:56')));
    assertEquals('23 hours ago', fn(timestamp('22 March 2009 15:30:56')));
    assertEquals('1 day ago', fn(timestamp('22 March 2009 12:11:04')));
    assertEquals('2 days ago', fn(timestamp('21 March 2009 10:30:56')));
  }

  function testFormatRelativeForFutureDates() {
    var fn = goog.date.relative.format;

    assertEquals('Should round seconds to the minute below',
        'in 1 minute',
        fn(timestamp('23 March 2009 14:32:05')));

    assertEquals('Should round seconds to the minute below',
        'in 2 minutes', fn(timestamp('23 March 2009 14:33:00')));

    assertEquals('in 10 minutes', fn(timestamp('23 March 2009 14:40:10')));
    assertEquals('in 59 minutes', fn(timestamp('23 March 2009 15:29:15')));
    assertEquals('in 2 hours', fn(timestamp('23 March 2009 17:20:56')));
    assertEquals('in 23 hours', fn(timestamp('24 March 2009 13:30:56')));
    assertEquals('in 1 day', fn(timestamp('24 March 2009 16:11:04')));
    assertEquals('in 2 days', fn(timestamp('25 March 2009 10:30:56')));
  }


  function testFormatPast() {
    var fn = goog.date.relative.formatPast;

    assertEquals('59 minutes ago', fn(timestamp('23 March 2009 13:31:42')));
    assertEquals('0 minutes ago', fn(timestamp('23 March 2009 14:32:05')));
    assertEquals('0 minutes ago', fn(timestamp('23 March 2009 14:33:00')));
    assertEquals('0 minutes ago', fn(timestamp('25 March 2009 10:30:56')));
  }


  function testFormatDay() {
    var fn = goog.date.relative.formatDay;
    assertEquals('Today', fn(timestamp('23 March 2009 10:31:06')));
    assertEquals('Today', fn(timestamp('23 March 2009 00:12:19')));
    assertEquals('Yesterday', fn(timestamp('22 March 2009 23:48:12')));
    assertEquals('Yesterday', fn(timestamp('22 March 2009 04:11:23')));
    assertEquals('Mar 21', fn(timestamp('21 March 2009 15:54:45')));
    assertEquals('Mar 19', fn(timestamp('19 March 2009 01:22:11')));
  }

  function testGetDateString() {
    var fn = goog.date.relative.getDateString;

    assertEquals('2:21 PM (10 minutes ago)',
                 fn(new Date(baseTime - 10 * 60 * 1000)));

    assertEquals('4:31 AM (10 hours ago)',
                 fn(new Date(baseTime - 10 * 60 * 60 * 1000)));

    assertEquals('Friday, March 13, 2009 (10 days ago)',
                 fn(new Date(baseTime - 10 * 24 * 60 * 60 * 1000)));

    assertEquals('Tuesday, March 3, 2009',
                 fn(new Date(baseTime - 20 * 24 * 60 * 60 * 1000)));
  }

  function testGetPastDateString() {
    var fn = goog.date.relative.getPastDateString;
    assertEquals('2:21 PM (10 minutes ago)',
                 fn(new Date(baseTime - 10 * 60 * 1000)));
    assertEquals('2:41 PM (0 minutes ago)',
                 fn(new Date(baseTime + 10 * 60 * 1000)));
  }

  function timestamp(str) {
    return new Date(str).getTime()
  }

">n/a</td></tr>
<tr><td>date_test.html</td><td>Fail</td><td> undefined</td><td title="

  goog.require('goog.date');
  goog.require('goog.date.Date');
  goog.require('goog.date.DateTime');
  goog.require('goog.date.Interval');
  goog.require('goog.i18n.DateTimeSymbols');
  goog.require('goog.testing.ExpectedFailures');
  goog.require('goog.testing.jsunit');
  goog.require('goog.userAgent');
  goog.require('goog.userAgent.platform');
  goog.require('goog.userAgent.product');
  goog.require('goog.userAgent.product.isVersion');



var expectedFailures = new goog.testing.ExpectedFailures();

function shouldRunTests() {

  // Test disabled in Chrome-vista due to flakiness. See b/2753939.
  if (goog.userAgent.product.CHROME &&
      goog.userAgent.WINDOWS &&
      goog.userAgent.platform.VERSION == '6.0') {
    return false;
  }

  return true;
}

function tearDown() {
  expectedFailures.handleTearDown();
}

/**
 * Unit test for Closure's 'goog.date'.
 */
function testIsLeapYear() {
  var f = goog.date.isLeapYear;

  assertFalse('Year 1900 was not a leap year (the 100 rule)', f(1900));
  assertFalse('Year 1901 was not a leap year (the 100 rule)', f(1901));
  assertTrue('Year 1904 was a leap year', f(1904));
  assertFalse('Year 1999 was not a leap year', f(1999));
  assertTrue('Year 2000 was a leap year (the 400 rule)', f(2000));
  assertTrue('Year 2004 was a leap year', f(2004));
  assertFalse('Year 2006 was not a leap year', f(2006));
}


function testIsLongIsoYear() {
  var f = goog.date.isLongIsoYear;

  // see http://en.wikipedia.org/wiki/ISO_week_date#The_leap_year_cycle
  assertFalse('1902 was not an ISO leap year', f(1902));
  assertTrue('1903 was an ISO leap year', f(1903));
  assertFalse('1904 was not an ISO leap year', f(1904));
  assertTrue('1981 was an ISO leap year', f(1981));
  assertTrue('1987 was an ISO leap year', f(1987));
  assertFalse('2000 was not an ISO leap year', f(2000));
}


function testGetNumberOfDaysInMonth() {
  var f = goog.date.getNumberOfDaysInMonth;

  assertEquals('January has 31 days', f(2006, goog.date.month.JAN, 2000), 31);
  assertEquals('February has 28 days', f(2006, goog.date.month.FEB), 28);
  assertEquals('February has 29 days (leap year)',
               f(2008, goog.date.month.FEB), 29);
  assertEquals('March has 31 days', f(2006, goog.date.month.MAR), 31);
  assertEquals('April has 30 days', f(2006, goog.date.month.APR), 30);
  assertEquals('May has 31 days', f(2006, goog.date.month.MAY), 31);
  assertEquals('June has 30 days', f(2006, goog.date.month.JUN), 30);
  assertEquals('July has 31 days', f(2006, goog.date.month.JUL), 31);
  assertEquals('August has 31 days', f(2006, goog.date.month.AUG), 31);
  assertEquals('September has 30 days', f(2006, goog.date.month.SEP), 30);
  assertEquals('October has 31 days', f(2006, goog.date.month.OCT), 31);
  assertEquals('November has 30 days', f(2006, goog.date.month.NOV), 30);
  assertEquals('December has 31 days', f(2006, goog.date.month.DEC), 31);
}


function testIsSameDay() {
  assertTrue('Dates are on the same day', goog.date.isSameDay(
      new Date('2009/02/01 12:45:12'),
      new Date('2009/02/01 01:15:49')));

  assertFalse('Days are different', goog.date.isSameDay(
      new Date('2009/02/01 12:45:12'),
      new Date('2009/02/02 01:15:49')));

  assertFalse('Months are different', goog.date.isSameDay(
      new Date('2009/02/01 12:45:12'),
      new Date('2009/03/01 01:15:49')));

  assertFalse('Years are different', goog.date.isSameDay(
      new Date('2009/02/01 12:45:12'),
      new Date('2010/02/01 01:15:49')));

  assertFalse('Wrong millennium', goog.date.isSameDay(
      new Date('2009/02/01 12:45:12'),
      new Date('1009/02/01 01:15:49')));
}


function testIsSameMonth() {
  assertTrue('Dates are on the same day', goog.date.isSameMonth(
      new Date('2009/02/01 12:45:12'),
      new Date('2009/02/01 01:15:49')));

  assertTrue('Dates are in the same month', goog.date.isSameMonth(
      new Date('2009/02/01 12:45:12'),
      new Date('2009/02/10 01:15:49')));

  assertFalse('Month is different', goog.date.isSameMonth(
      new Date('2009/02/01 12:45:12'),
      new Date('2009/03/01 01:15:49')));

  assertFalse('Year is different', goog.date.isSameMonth(
      new Date('2008/02/01 12:45:12'),
      new Date('2009/02/01 01:15:49')));

  assertFalse('Wrong millennium', goog.date.isSameMonth(
      new Date('2009/02/01 12:45:12'),
      new Date('1009/02/01 01:15:49')));
}


function testIsSameYear() {
  assertTrue('Dates are on the same day', goog.date.isSameYear(
      new Date('2009/02/01 12:45:12'),
      new Date('2009/02/01 01:15:49')));

  assertTrue('Only days are different', goog.date.isSameYear(
      new Date('2009/02/01 12:45:12'),
      new Date('2009/02/11 01:15:49')));

  assertTrue('Only months are different', goog.date.isSameYear(
      new Date('2009/02/01 12:45:12'),
      new Date('2009/02/01 01:15:49')));

  assertFalse('Years are different', goog.date.isSameYear(
      new Date('2009/02/01 12:45:12'),
      new Date('2010/02/01 01:15:49')));

  assertFalse('Years are different', goog.date.isSameYear(
      new Date('2009/02/01 12:45:12'),
      new Date('2008/02/01 01:15:49')));

}


function testGetWeekNumber() {
  var f = goog.date.getWeekNumber;

  // Test cases from http://en.wikipedia.org/wiki/ISO_week_date#Examples
  assertEquals('2005-01-01 is the week 53 of the previous year', 53,
               f(2005, goog.date.month.JAN, 1));
  assertEquals('2005-01-02 is the week 53 of the previous year', 53,
               f(2005, goog.date.month.JAN, 2));
  assertEquals('2005-12-31 is the week 52', 52,
               f(2005, goog.date.month.DEC, 31));
  assertEquals('2007-01-01 is the week 1', 1,
               f(2007, goog.date.month.JAN, 1));
  assertEquals('2007-12-30 is the week 52', 52,
               f(2007, goog.date.month.DEC, 30));
  assertEquals('2007-12-31 is the week 1 of the following year', 1,
               f(2007, goog.date.month.DEC, 31));
  assertEquals('2008-01-01 is the week 1', 1,
               f(2008, goog.date.month.JAN, 1));
  assertEquals('2008-12-28 is the week 52', 52,
               f(2008, goog.date.month.DEC, 28));
  assertEquals('2008-12-29 is the week 1 of the following year', 1,
               f(2008, goog.date.month.DEC, 29));
  assertEquals('2008-12-31 is the week 1 of the following year', 1,
               f(2008, goog.date.month.DEC, 31));
  assertEquals('2009-01-01 is the week 1', 1,
               f(2009, goog.date.month.JAN, 1));
  assertEquals('2009-12-31 is the week 53 of the previous year', 53,
               f(2009, goog.date.month.DEC, 31));
  assertEquals('2010-01-01 is the week 53 of the previous year', 53,
               f(2010, goog.date.month.JAN, 1));
  assertEquals('2010-01-03 is the week 53 of the previous year', 53,
               f(2010, goog.date.month.JAN, 3));
  assertEquals('2010-01-04 is the week 1', 1,
               f(2010, goog.date.month.JAN, 4));

  assertEquals('2006-01-01 is in week 52 of the following year', 52,
               f(2006, goog.date.month.JAN, 1));
  assertEquals('2006-01-02 is in week 1', 1,
               f(2006, goog.date.month.JAN, 2));
  assertEquals('2006-10-16 is in week 42', 42,
               f(2006, goog.date.month.OCT, 16));
  assertEquals('2006-10-19 is in week 42', 42,
               f(2006, goog.date.month.OCT, 19));
  assertEquals('2006-10-22 is in week 42', 42,
               f(2006, goog.date.month.OCT, 22));
  assertEquals('2006-10-23 is in week 43', 43,
               f(2006, goog.date.month.OCT, 23));
  assertEquals('2008-12-29 is in week 1 of the following year', 1,
               f(2008, goog.date.month.DEC, 29));
  assertEquals('2010-01-03 is in week 53 of the previous year', 53,
               f(2010, goog.date.month.JAN, 03));

  assertEquals('2008-02-01 is in week 5', 5,
               f(2008, goog.date.month.FEB, 1));
  assertEquals('2008-02-04 is in week 6', 6,
               f(2008, goog.date.month.FEB, 4));

  // Tests for different cutoff days.
  assertEquals('2006-01-01 is in week 52 of the prev. year (cutoff=Monday)', 52,
               f(2006, goog.date.month.JAN, 1, goog.date.weekDay.MON));
  assertEquals('2006-01-01 is in week 1 (cutoff=Sunday)', 1,
               f(2006, goog.date.month.JAN, 1, goog.date.weekDay.SUN));
  assertEquals('2006-12-31 is in week 52 (cutoff=Monday)', 52,
               f(2006, goog.date.month.DEC, 31, goog.date.weekDay.MON));
  assertEquals('2006-12-31 is in week 53 (cutoff=Sunday)', 53,
               f(2006, goog.date.month.DEC, 31, goog.date.weekDay.SUN));
  assertEquals('2007-01-01 is in week 1 (cutoff=Monday)', 1,
               f(2007, goog.date.month.JAN, 1, goog.date.weekDay.MON));
  assertEquals('2007-01-01 is in week 1 (cutoff=Sunday)', 1,
               f(2007, goog.date.month.JAN, 1, goog.date.weekDay.SUN));

  // Tests for leap year 2000.
  assertEquals('2000-02-27 is in week 8', 8,
               f(2000, goog.date.month.FEB, 27));
  assertEquals('2000-02-28 is in week 9', 9,
               f(2000, goog.date.month.FEB, 28));
  assertEquals('2000-02-29 is in week 9', 9,
               f(2000, goog.date.month.FEB, 29));
  assertEquals('2000-03-01 is in week 9', 9,
               f(2000, goog.date.month.MAR, 1));
  assertEquals('2000-03-05 is in week 9', 9,
               f(2000, goog.date.month.MAR, 5));
  assertEquals('2000-03-06 is in week 10', 10,
               f(2000, goog.date.month.MAR, 6));

  // Check that week number is strictly incremented by 1.
  var dt = new goog.date.Date(2008, goog.date.month.JAN, 1);
  for (var i = 0; i < 52; ++i) {
    var expected_week = i + 1;
    assertEquals(dt.toUTCIsoString(true) + ' is in week ' + expected_week,
                 expected_week, dt.getWeekNumber());
    dt.add(new goog.date.Interval(goog.date.Interval.DAYS, 7));
  }
}


function testFormatMonthAndYear() {
  var f = goog.date.formatMonthAndYear;
  assertEquals('January 2008',
               f(goog.i18n.DateTimeSymbols.MONTHS[goog.date.month.JAN], 2008));
  assertEquals('Jun 2007',
               f(goog.i18n.DateTimeSymbols.SHORTMONTHS[goog.date.month.JUN],
                   2007));
}


//=== tests for goog.date.Date ===
function testIsDateLikeWithGoogDate() {
  var jsDate = new Date();
  var googDate = new goog.date.Date();
  var string = 'foo';
  var number = 1;
  var nullVar = null;
  var notDefined;

  assertTrue('js Date should be date-like', goog.isDateLike(jsDate));
  assertTrue('goog Date should be date-like', goog.isDateLike(googDate));
  assertFalse('string should not be date-like', goog.isDateLike(string));
  assertFalse('number should not be date-like', goog.isDateLike(number));
  assertFalse('nullVar should not be date-like', goog.isDateLike(nullVar));
  assertFalse('undefined should not be date-like', goog.isDateLike(notDefined));
}


function testDateConstructor() {
  var date = new goog.date.Date(2001, 2, 3);
  assertEquals(2001, date.getFullYear());
  assertEquals(2, date.getMonth());
  assertEquals(3, date.getDate());

  var date = new goog.date.Date(2001);
  assertEquals(2001, date.getFullYear());
  assertEquals(0, date.getMonth());
  assertEquals(1, date.getDate());

  var date = new goog.date.Date(new Date(2001, 2, 3, 4, 5, 6, 7));
  assertEquals(2001, date.getFullYear());
  assertEquals(2, date.getMonth());
  assertEquals(3, date.getDate());
  assertEquals(new Date(2001, 2, 3).getTime(), date.getTime());

  goog.now = function() {
    return new Date(2001, 2, 3, 4).getTime();
  };
  var date = new goog.date.Date();
  assertEquals(2001, date.getFullYear());
  assertEquals(2, date.getMonth());
  assertEquals(3, date.getDate());
  assertEquals(new Date(2001, 2, 3).getTime(), date.getTime());
}


function testDateToIsoString() {
  var d = new goog.date.Date(2006, goog.date.month.JAN, 1);
  assertEquals('1 Jan 2006 is 20060101', d.toIsoString(), '20060101');

  d = new goog.date.Date(2007, goog.date.month.JUN, 12);
  assertEquals('12 Jun 2007 is 20070612', d.toIsoString(), '20070612');

  d = new goog.date.Date(2218, goog.date.month.DEC, 31);
  assertEquals('31 Dec 2218 is 22181231', d.toIsoString(), '22181231');
}


function testRfc822StringToDate() {
  var date = goog.date.DateTime.fromRfc822String('October 2, 2002 8:00:00');
  assertNotNull(date);
  assertEquals(2002, date.getFullYear());
  assertEquals(9, date.getMonth());
  assertEquals(2, date.getDate());
  assertEquals(8, date.getHours());
  assertEquals(0, date.getMinutes());
  assertEquals(0, date.getSeconds());
  assertEquals(0, date.getMilliseconds());
  assertEquals(new Date(2002, 9, 2, 8).getTime(), date.getTime());

  var date = goog.date.DateTime.fromRfc822String(
      'Sat, 02 Oct 2010 08:00:00 UTC');
  assertEquals(2010, date.getFullYear());
  assertEquals(9, date.getUTCMonth());
  assertEquals(2, date.getUTCDate());
  assertEquals(8, date.getUTCHours());
  assertEquals(0, date.getUTCMinutes());
  assertEquals(0, date.getUTCSeconds());
  assertEquals(0, date.getUTCMilliseconds());

  var date = goog.date.DateTime.fromRfc822String('');
  assertEquals(null, date);

  var date = goog.date.DateTime.fromRfc822String('Invalid Date String');
  assertEquals(null, date);

  var date = goog.date.DateTime.fromRfc822String('Sat, 02 Oct 2010');
  assertEquals(2010, date.getFullYear());
  assertEquals(9, date.getMonth());
  assertEquals(2, date.getDate());
  assertEquals(0, date.getHours());
  assertEquals(0, date.getMinutes());
  assertEquals(0, date.getSeconds());
  assertEquals(0, date.getMilliseconds());
  assertEquals(new Date(2010, 9, 2).getTime(), date.getTime());
}

function testIsoStringToDate() {
  var iso = '20060210T000000Z';
  var date = goog.date.fromIsoString(iso);

  assertEquals('Got 2006 from ' + iso, 2006, date.getFullYear());
  assertEquals('Got February from ' + iso, 1, date.getMonth());
  // use getUTCDate() here, since in 'iso' var we specified timezone
  // as being a zero offset from GMT
  assertEquals('Got 10th from ' + iso, 10, date.getUTCDate());

  // YYYY-MM-DD
  iso = '2005-02-22';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2005 from ' + iso, 2005, date.getFullYear());
  assertEquals('Got February from ' + iso, 1, date.getMonth());
  assertEquals('Got 22nd from ' + iso, 22, date.getDate());

  // YYYYMMDD
  iso = '20050222';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2005 from ' + iso, 2005, date.getFullYear());
  assertEquals('Got February from ' + iso, 1, date.getMonth());
  assertEquals('Got 22nd from ' + iso, 22, date.getDate());

  // YYYY-MM
  iso = '2005-08';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2005 from ' + iso, 2005, date.getFullYear());
  assertEquals('Got August from ' + iso, 7, date.getMonth());

  // YYYYMM
  iso = '200502';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2005 from ' + iso, 2005, date.getFullYear());
  assertEquals('Got February from ' + iso, 1, date.getMonth());

  // YYYY
  iso = '2005';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2005 from ' + iso, 2005, date.getFullYear());

  // 1997-W01 or 1997W01
  iso = '2005-W22';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2005 from ' + iso, 2005, date.getFullYear());
  assertEquals('Got May from ' + iso, 4, date.getMonth());
  assertEquals('Got 30th from ' + iso, 30, date.getDate());

  iso = '2005W22';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2005 from ' + iso, 2005, date.getFullYear());
  assertEquals('Got May from ' + iso, 4, date.getMonth());
  assertEquals('Got 30th from ' + iso, 30, date.getDate());

  // 1997-W01-2 or 1997W012
  iso = '2005-W22-4';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2005 from ' + iso, 2005, date.getFullYear());
  assertEquals('Got June from ' + iso, 5, date.getMonth());
  assertEquals('Got 2nd from ' + iso, 2, date.getDate());

  iso = '2005W224';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2005 from ' + iso, 2005, date.getFullYear());
  assertEquals('Got June from ' + iso, 5, date.getMonth());
  assertEquals('Got 2nd from ' + iso, 2, date.getDate());

  iso = '2004-W53-6';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2005 from ' + iso, 2005, date.getFullYear());
  assertEquals('Got January from ' + iso, 0, date.getMonth());
  assertEquals('Got 1st from ' + iso, 1, date.getDate());

  iso = '2004-W53-7';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2005 from ' + iso, 2005, date.getFullYear());
  assertEquals('Got January from ' + iso, 0, date.getMonth());
  assertEquals('Got 2nd from ' + iso, 2, date.getDate());

  iso = '2005-W52-6';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2005 from ' + iso, 2005, date.getFullYear());
  assertEquals('Got December from ' + iso, 11, date.getMonth());
  assertEquals('Got 31st from ' + iso, 31, date.getDate());

  // both years 2007 start with the same day
  iso = '2007-W01-1';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2007 from ' + iso, 2007, date.getFullYear());
  assertEquals('Got January from ' + iso, 0, date.getMonth());
  assertEquals('Got 1st from ' + iso, 1, date.getDate());

  iso = '2007-W52-7';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2007 from ' + iso, 2007, date.getFullYear());
  assertEquals('Got December from ' + iso, 11, date.getMonth());
  assertEquals('Got 30th from ' + iso, 30, date.getDate());

  iso = '2008-W01-1';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2007 from ' + iso, 2007, date.getFullYear());
  assertEquals('Got December from ' + iso, 11, date.getMonth());
  assertEquals('Got 31st from ' + iso, 31, date.getDate());

  // Gregorian year 2008 is a leap year,
  // ISO year 2008 is 2 days shorter:
  // 1 day longer at the start, 3 days shorter at the end
  iso = '2008-W01-2';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2008 from ' + iso, 2008, date.getFullYear());
  assertEquals('Got Jan from ' + iso, 0, date.getMonth());
  assertEquals('Got 1st from ' + iso, 1, date.getDate());

  // ISO year is three days into the previous gregorian year
  iso = '2009-W01-1';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2008 from ' + iso, 2008, date.getFullYear());
  assertEquals('Got December from ' + iso, 11, date.getMonth());
  assertEquals('Got 29th from ' + iso, 29, date.getDate());

  iso = '2009-W01-3';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2008 from ' + iso, 2008, date.getFullYear());
  assertEquals('Got December from ' + iso, 11, date.getMonth());
  assertEquals('Got 31st from ' + iso, 31, date.getDate());

  iso = '2009-W01-4';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2009 from ' + iso, 2009, date.getFullYear());
  assertEquals('Got January from ' + iso, 0, date.getMonth());
  assertEquals('Got 1st from ' + iso, 1, date.getDate());

  // ISO year is three days into the next gregorian year
  iso = '2009-W53-4';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2009 from ' + iso, 2009, date.getFullYear());
  assertEquals('Got December from ' + iso, 11, date.getMonth());
  assertEquals('Got 31st from ' + iso, 31, date.getDate());

  iso = '2009-W53-5';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2010 from ' + iso, 2010, date.getFullYear());
  assertEquals('Got January from ' + iso, 0, date.getMonth());
  assertEquals('Got 1st from ' + iso, 1, date.getDate());

  iso = '2009-W53-6';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2010 from ' + iso, 2010, date.getFullYear());
  assertEquals('Got January from ' + iso, 0, date.getMonth());
  assertEquals('Got 2nd from ' + iso, 2, date.getDate());

  iso = '2009-W53-7';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2010 from ' + iso, 2010, date.getFullYear());
  assertEquals('Got January from ' + iso, 0, date.getMonth());
  assertEquals('Got 3rd from ' + iso, 3, date.getDate());

  iso = '2010-W01-1';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2010 from ' + iso, 2010, date.getFullYear());
  assertEquals('Got January from ' + iso, 0, date.getMonth());
  assertEquals('Got 4th from ' + iso, 4, date.getDate());

  // Examples where the ISO year is three days into the previous gregorian year

  // 1995-035 or 1995035
  iso = '2005-146';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2005 from ' + iso, 2005, date.getFullYear());
  assertEquals('Got May from ' + iso, 4, date.getMonth());
  assertEquals('Got 26th from ' + iso, 26, date.getDate());

  iso = '2005146';
  date = goog.date.fromIsoString(iso);
  assertEquals('Got 2005 from ' + iso, 2005, date.getFullYear());
  assertEquals('Got May from ' + iso, 4, date.getMonth());
  assertEquals('Got 26th from ' + iso, 26, date.getDate());
}


// test private function used by goog.date.Date.toIsoString()
function test_setIso8601TimeOnly_() {
  // 23:59:59
  var d = new goog.date.DateTime(0, 0);
  var iso = '18:46:39';
  assertTrue('parsed ' + iso, goog.date.setIso8601TimeOnly_(d, iso));
  assertEquals('Got 18 hours from ' + iso, 18, d.getHours());
  assertEquals('Got 46 minutes from ' + iso, 46, d.getMinutes());
  assertEquals('Got 39 seconds from ' + iso, 39, d.getSeconds());

  // 235959
  d = new goog.date.DateTime(0, 0);
  iso = '184639';
  assertTrue('parsed ' + iso, goog.date.setIso8601TimeOnly_(d, iso));
  assertEquals('Got 18 hours from ' + iso, 18, d.getHours());
  assertEquals('Got 46 minutes from ' + iso, 46, d.getMinutes());
  assertEquals('Got 39 seconds from ' + iso, 39, d.getSeconds());

  // 23:59, 2359, or 23
  d = new goog.date.DateTime(0, 0);
  iso = '18:46';
  assertTrue('parsed ' + iso, goog.date.setIso8601TimeOnly_(d, iso));
  assertEquals('Got 18 hours from ' + iso, 18, d.getHours());
  assertEquals('Got 46 minutes from ' + iso, 46, d.getMinutes());

  d = new goog.date.DateTime(0, 0);
  iso = '1846';
  assertTrue('parsed ' + iso, goog.date.setIso8601TimeOnly_(d, iso));
  assertEquals('Got 18 hours from ' + iso, 18, d.getHours());
  assertEquals('Got 46 minutes from ' + iso, 46, d.getMinutes());

  d = new goog.date.DateTime(0, 0);
  iso = '18';
  assertTrue('parsed ' + iso, goog.date.setIso8601TimeOnly_(d, iso));
  assertEquals('Got 18 hours from ' + iso, 18, d.getHours());

  d = new goog.date.DateTime(0, 0);
  iso = '18463';
  assertFalse('failed to parse ' + iso, goog.date.setIso8601TimeOnly_(d, iso));
  assertTrue('date did not change', d.equals(new goog.date.DateTime(0, 0)));

  // 23:59:59.9942 or 235959.9942
  d = new goog.date.DateTime(0, 0);
  iso = '18:46:39.9942';
  assertTrue('parsed ' + iso, goog.date.setIso8601TimeOnly_(d, iso));
  assertEquals('Got 18 hours from ' + iso, 18, d.getHours());
  assertEquals('Got 46 minutes from ' + iso, 46, d.getMinutes());
  assertEquals('Got 39 seconds from ' + iso, 39, d.getSeconds());

  // Fails in Safari4 Winxp, temporarily disabled
  expectedFailures.expectFailureFor(isWinxpSafari4());
  try {
    if (goog.userAgent.WEBKIT && goog.userAgent.MAC) {
      // Both Safari 3.1 and WebKit (on Mac) return floating-point values.
      assertRoughlyEquals('Got roughly 994.2 milliseconds from ' + iso, 994.2,
          d.getMilliseconds(), 0.01);
    } else {
      // Other browsers, including WebKit on Windows, return integers.
      assertEquals('Got 994 milliseconds from ' + iso, 994, d.getMilliseconds());
    }

    d = new goog.date.DateTime(0, 0);
    iso = '184639.9942';
    assertTrue('parsed ' + iso, goog.date.setIso8601TimeOnly_(d, iso));
    assertEquals('Got 18 hours from ' + iso, 18, d.getHours());
    assertEquals('Got 46 minutes from ' + iso, 46, d.getMinutes());
    assertEquals('Got 39 seconds from ' + iso, 39, d.getSeconds());
    if (goog.userAgent.WEBKIT && goog.userAgent.MAC) {
      // Both Safari 3.1 and WebKit (on Mac) return floating-point values.
      assertRoughlyEquals('Got roughly 994.2 milliseconds from ' + iso, 994.2,
          d.getMilliseconds(), 0.01);
    } else {
      // Other browsers, including WebKit on Windows, return integers.
      assertEquals('Got 994 milliseconds from ' + iso, 994, d.getMilliseconds());
    }
  } catch (e) {
      expectedFailures.handleException(e);
  }


  // 1995-02-04 24:00 = 1995-02-05 00:00
  // timezone tests
  var offset = new Date().getTimezoneOffset() / 60;
  d = new goog.date.DateTime(0, 0);
  iso = '18:46:39+07:00';
  assertTrue('parsed ' + iso, goog.date.setIso8601TimeOnly_(d, iso));
  assertEquals('Got an 11-hour GMT offset from ' + iso, 11, d.getUTCHours());

  d = new goog.date.DateTime(0, 0);
  iso = '18:46:39+00:00';
  assertTrue('parsed ' + iso, goog.date.setIso8601TimeOnly_(d, iso));
  assertEquals('Got an 18-hour GMT offset from ' + iso, 18, d.getUTCHours());

  d = new goog.date.DateTime(0, 0);
  iso = '16:46:39-07:00';
  assertTrue('parsed ' + iso, goog.date.setIso8601TimeOnly_(d, iso));
  assertEquals('Got a 23-hour GMT offset from ' + iso, 23, d.getUTCHours());
}


function testDateIntervalAdd() {
  // -1m, cross year boundary
  var d = new goog.date.Date(2007, goog.date.month.JAN, 1);
  d.add(new goog.date.Interval(goog.date.Interval.MONTHS, -1));
  assertEquals('2007-01-01 - 1m = 2006-12-01', '20061201', d.toIsoString());

  // +1y2m3d
  d = new goog.date.Date(2006, goog.date.month.JAN, 1);
  d.add(new goog.date.Interval(1, 2, 3));
  assertEquals('2006-01-01 + 1y2m3d = 2007-03-04', '20070304', d.toIsoString());

  // -1y2m3d (negative interval)
  d = new goog.date.Date(2007, goog.date.month.MAR, 4);
  d.add(new goog.date.Interval(-1, -2, -3));
  assertEquals('2007-03-04 - 1y2m3d = 2006-01-01', '20060101', d.toIsoString());

  // 2007-12-30 + 3d (roll over to next year)
  d = new goog.date.Date(2007, goog.date.month.DEC, 30);
  d.add(new goog.date.Interval(goog.date.Interval.DAYS, 3));
  assertEquals('2007-12-30 + 3d = 2008-01-02', '20080102', d.toIsoString());

  // 2004-03-01 - 1d (handle leap year)
  d = new goog.date.Date(2004, goog.date.month.MAR, 1);
  d.add(new goog.date.Interval(goog.date.Interval.DAYS, -1));
  assertEquals('2004-03-01 - 1d = 2004-02-29', '20040229', d.toIsoString());

  // 2004-02-29 + 1y (stays at end of Feb, doesn't roll to Mar)
  d = new goog.date.Date(2004, goog.date.month.FEB, 29);
  d.add(new goog.date.Interval(goog.date.Interval.YEARS, 1));
  assertEquals('2004-02-29 + 1y = 2005-02-28', '20050228', d.toIsoString());

  // 2004-02-29 - 1y (stays at end of Feb, doesn't roll to Mar)
  d = new goog.date.Date(2004, goog.date.month.FEB, 29);
  d.add(new goog.date.Interval(goog.date.Interval.YEARS, -1));
  assertEquals('2004-02-29 - 1y = 2003-02-28', '20030228', d.toIsoString());

  // 2003-02-28 + 1y (stays at 28, doesn't go to leap year end of Feb)
  d = new goog.date.Date(2003, goog.date.month.FEB, 28);
  d.add(new goog.date.Interval(goog.date.Interval.YEARS, 1));
  assertEquals('2003-02-28 + 1y = 2004-02-28', '20040228', d.toIsoString());

  // 2005-02-28 - 1y (stays at 28, doesn't go to leap year end of Feb)
  d = new goog.date.Date(2005, goog.date.month.FEB, 28);
  d.add(new goog.date.Interval(goog.date.Interval.YEARS, -1));
  assertEquals('2005-02-28 - 1y = 2004-02-28', '20040228', d.toIsoString());

  // 2003-01-31 + 1y (stays at end of Jan, standard case)
  d = new goog.date.Date(2003, goog.date.month.JAN, 31);
  d.add(new goog.date.Interval(goog.date.Interval.YEARS, 1));
  assertEquals('2003-01-31 + 1y = 2004-01-31', '20040131', d.toIsoString());

  // 2005-01-31 - 1y (stays at end of Jan, standard case)
  d = new goog.date.Date(2005, goog.date.month.JAN, 31);
  d.add(new goog.date.Interval(goog.date.Interval.YEARS, -1));
  assertEquals('2005-01-31 - 1y = 2004-01-31', '20040131', d.toIsoString());

  // 2006-01-31 + 1m (stays at end of Feb, doesn't roll to Mar, non-leap-year)
  d = new goog.date.Date(2006, goog.date.month.JAN, 31);
  d.add(new goog.date.Interval(goog.date.Interval.MONTHS, 1));
  assertEquals('2006-01-31 + 1m = 2006-02-28', '20060228', d.toIsoString());

  // 2004-02-29 + 1m (stays at 29, standard case)
  d = new goog.date.Date(2004, goog.date.month.FEB, 29);
  d.add(new goog.date.Interval(goog.date.Interval.MONTHS, +1));
  assertEquals('2004-02-29 + 1m = 2004-03-29', '20040329', d.toIsoString());

  // 2004-02-29 - 1m (stays at 29, standard case)
  d = new goog.date.Date(2004, goog.date.month.FEB, 29);
  d.add(new goog.date.Interval(goog.date.Interval.MONTHS, -1));
  assertEquals('2004-02-29 - 1m = 2004-01-29', '20040129', d.toIsoString());

  // 2004-01-30 + 1m (snaps to Feb 29)
  d = new goog.date.Date(2004, goog.date.month.JAN, 30);
  d.add(new goog.date.Interval(goog.date.Interval.MONTHS, 1));
  assertEquals('2004-01-30 + 1m = 2004-02-29', '20040229', d.toIsoString());

  // 2004-03-30 - 1m (snaps to Feb 29)
  d = new goog.date.Date(2004, goog.date.month.MAR, 30);
  d.add(new goog.date.Interval(goog.date.Interval.MONTHS, -1));
  assertEquals('2004-03-30 - 1m = 2004-02-29', '20040229', d.toIsoString());

  // 2004-03-30 + 1m (stays at 30, standard case)
  d = new goog.date.Date(2004, goog.date.month.MAR, 30);
  d.add(new goog.date.Interval(goog.date.Interval.MONTHS, 1));
  assertEquals('2004-03-30 + 1m = 2004-04-30', '20040430', d.toIsoString());

  // 2008-10-30 + 1d (roll over to 31).
  d = new goog.date.Date(2008, goog.date.month.OCT, 30);
  d.add(new goog.date.Interval(goog.date.Interval.DAYS, 1));
  assertEquals('2008-10-30 + 1d = 2008-10-31', '20081031', d.toIsoString());

  // 2008-10-31 + 1d (roll over to November, not December).
  d = new goog.date.Date(2008, goog.date.month.OCT, 31);
  d.add(new goog.date.Interval(goog.date.Interval.DAYS, 1));
  assertEquals('2008-10-31 + 1d = 2008-11-01', '20081101', d.toIsoString());

  // 2008-10-17 + 1d (Brasilia dst).
  d = new goog.date.Date(2008, goog.date.month.OCT, 17);
  d.add(new goog.date.Interval(goog.date.Interval.DAYS, 1));
  assertEquals('2008-10-17 + 1d = 2008-10-18', '20081018', d.toIsoString());

  // 2008-10-18 + 1d (Brasilia dst).
  d = new goog.date.Date(2008, goog.date.month.OCT, 18);
  d.add(new goog.date.Interval(goog.date.Interval.DAYS, 1));
  assertEquals('2008-10-18 + 1d = 2008-10-19', '20081019', d.toIsoString());

  // 2008-10-19 + 1d (Brasilia dst).
  d = new goog.date.Date(2008, goog.date.month.OCT, 19);
  d.add(new goog.date.Interval(goog.date.Interval.DAYS, 1));
  assertEquals('2008-10-19 + 1d = 2008-10-20', '20081020', d.toIsoString());

  // 2008-02-16 + 1d (Brasilia dst).
  d = new goog.date.Date(2008, goog.date.month.FEB, 16);
  d.add(new goog.date.Interval(goog.date.Interval.DAYS, 1));
  assertEquals('2008-02-16 + 1d = 2008-02-17', '20080217', d.toIsoString());

  // 2008-02-17 + 1d (Brasilia dst).
  d = new goog.date.Date(2008, goog.date.month.FEB, 17);
  d.add(new goog.date.Interval(goog.date.Interval.DAYS, 1));
  assertEquals('2008-02-17 + 1d = 2008-02-18', '20080218', d.toIsoString());
}


function testDateEquals() {
  var d1 = new goog.date.Date(2004, goog.date.month.MAR, 1);
  var d2 = new goog.date.Date(2004, goog.date.month.MAR, 1);
  assertTrue('d1 == d2', d1.equals(d2));
  assertTrue('d2 == d1', d2.equals(d1));

  d1 = new goog.date.Date(2005, goog.date.month.MAR, 1);
  d2 = new goog.date.Date(2004, goog.date.month.MAR, 1);
  assertFalse('different year', d1.equals(d2));

  d1 = new goog.date.Date(2004, goog.date.month.FEB, 1);
  d2 = new goog.date.Date(2004, goog.date.month.MAR, 1);
  assertFalse('different month', d1.equals(d2));

  d1 = new goog.date.Date(2004, goog.date.month.MAR, 2);
  d2 = new goog.date.Date(2004, goog.date.month.MAR, 1);
  assertFalse('different date', d1.equals(d2));

  // try passing in DateTime, time fields should be ignored
  d1 = new goog.date.Date(2004, goog.date.month.MAR, 1);
  d2 = new goog.date.DateTime(2004, goog.date.month.MAR, 1, 12, 30, 30);
  assertTrue('using goog.date.DateTime, same date', d1.equals(d2));
}


function testDateTimeConstructor() {
  var date = new goog.date.DateTime(2001, 2, 3, 4, 5, 6, 7);
  assertEquals(2001, date.getFullYear());
  assertEquals(2, date.getMonth());
  assertEquals(3, date.getDate());
  assertEquals(4, date.getHours());
  assertEquals(5, date.getMinutes());
  assertEquals(6, date.getSeconds());
  assertEquals(7, date.getMilliseconds());
  assertEquals(new Date(2001, 2, 3, 4, 5, 6, 7).getTime(), date.getTime());

  var date = new goog.date.DateTime(2001);
  assertEquals(2001, date.getFullYear());
  assertEquals(0, date.getMonth());
  assertEquals(1, date.getDate());
  assertEquals(0, date.getHours());
  assertEquals(0, date.getMinutes());
  assertEquals(0, date.getSeconds());
  assertEquals(0, date.getMilliseconds());

  var date = new goog.date.DateTime(new Date(2001, 2, 3, 4, 5, 6, 7));
  assertEquals(2001, date.getFullYear());
  assertEquals(2, date.getMonth());
  assertEquals(3, date.getDate());
  assertEquals(4, date.getHours());
  assertEquals(5, date.getMinutes());
  assertEquals(6, date.getSeconds());
  assertEquals(7, date.getMilliseconds());
  assertEquals(new Date(2001, 2, 3, 4, 5, 6, 7).getTime(), date.getTime());

  goog.now = function() {
    return new Date(2001, 2, 3, 4).getTime();
  };
  var date = new goog.date.DateTime();
  assertEquals(2001, date.getFullYear());
  assertEquals(2, date.getMonth());
  assertEquals(3, date.getDate());
  assertEquals(4, date.getHours());
  assertEquals(0, date.getMinutes());
  assertEquals(0, date.getSeconds());
  assertEquals(0, date.getMilliseconds());
  assertEquals(new Date(2001, 2, 3, 4).getTime(), date.getTime());

  var date = new goog.date.DateTime(new Date('October 2, 2002 8:00:00'));
  assertEquals(2002, date.getFullYear());
  assertEquals(9, date.getMonth());
  assertEquals(2, date.getDate());
  assertEquals(8, date.getHours());
  assertEquals(0, date.getMinutes());
  assertEquals(0, date.getSeconds());
  assertEquals(0, date.getMilliseconds());
  assertEquals(new Date(2002, 9, 2, 8).getTime(), date.getTime());
}


function testDateTimeEquals() {
  var d1 = new goog.date.DateTime(2004, goog.date.month.MAR, 1, 12, 30, 30);
  var d2 = new goog.date.DateTime(2004, goog.date.month.MAR, 1, 12, 30, 30);
  assertTrue('d1 == d2', d1.equals(d2));
  assertTrue('d2 == d1', d2.equals(d1));

  d1 = new goog.date.DateTime(2007, goog.date.month.JAN, 1);
  d2 = new goog.date.DateTime(); // today
  assertFalse('different date', d1.equals(d2));

  d1 = new goog.date.DateTime(2004, goog.date.month.MAR, 1);
  d2 = new goog.date.DateTime(2004, goog.date.month.MAR, 1, 12);
  assertFalse('different hours', d1.equals(d2));

  d1 = new goog.date.DateTime(2004, goog.date.month.MAR, 1, 12, 29, 30);
  d2 = new goog.date.DateTime(2004, goog.date.month.MAR, 1, 12, 30, 30);
  assertFalse('different minutes', d1.equals(d2));

  d1 = new goog.date.DateTime(2004, goog.date.month.MAR, 1, 12, 30, 29);
  d2 = new goog.date.DateTime(2004, goog.date.month.MAR, 1, 12, 30, 30);
  assertFalse('different seconds', d1.equals(d2));

  d1 = new goog.date.DateTime(2004, goog.date.month.MAR, 1, 12, 30, 30, 500);
  d2 = new goog.date.DateTime(2004, goog.date.month.MAR, 1, 12, 30, 30, 500);
  assertTrue('same milliseconds', d1.equals(d2));

  d1 = new goog.date.DateTime(2004, goog.date.month.MAR, 1, 12, 30, 30, 499);
  d2 = new goog.date.DateTime(2004, goog.date.month.MAR, 1, 12, 30, 30, 500);
  assertFalse('different milliseconds', d1.equals(d2));

  // try milliseconds again, this time comparing against a native Date
  d1 = new goog.date.DateTime(2004, goog.date.month.MAR, 1, 12, 30, 30);
  d2 = new Date(2004, 2, 1, 12, 30, 30, 999);
  assertFalse('different milliseconds, native Date', d1.equals(d2));

  // pass in a goog.date.Date rather than a goog.date.DateTime
  d1 = new goog.date.DateTime(2004, goog.date.month.MAR, 1, 12, 30, 30);
  d2 = new goog.date.Date(2004, goog.date.month.MAR, 1);
  assertFalse('using goog.date.Date, different times', d1.equals(d2));

  d1 = new goog.date.DateTime(2004, goog.date.month.MAR, 1, 0, 0, 0);
  d2 = new goog.date.Date(2004, goog.date.month.MAR, 1);
  assertTrue('using goog.date.Date, same time (midnight)', d1.equals(d2));
}


function testIntervalGetInverse() {
  var i1 = new goog.date.Interval(goog.date.Interval.DAYS, -1);
  var i2 = i1.getInverse();

  var d = new goog.date.Date(2004, goog.date.month.MAR, 1);
  d.add(i1);
  d.add(i2);
  var label = '2004-03-01 - 1d + 1d = 2004-03-01';
  assertEquals(label, d.toIsoString(), '20040301');

  i1 = new goog.date.Interval(1, 2, 3);
  i2 = i1.getInverse();

  d = new goog.date.Date(2004, goog.date.month.MAR, 1);
  d.add(i1);
  d.add(i2);
  label = '2004-03-01 - 1y2m3d + 1y2m3d = 2004-03-01';
  assertEquals(label, d.toIsoString(), '20040301');
}


function testIntervalTimes() {
  var i = new goog.date.Interval(1, 2, 3, 4, 5, 6);
  var expected = new goog.date.Interval(2, 4, 6, 8, 10, 12);
  assertTrue('double interval', expected.equals(i.times(2)));
}


//=== tests for goog.date.Interval.equals() ===
function testIntervalEquals() {
  var i1 = new goog.date.Interval(goog.date.Interval.DAYS, -1);
  var i2 = new goog.date.Interval(goog.date.Interval.DAYS, -1);
  assertTrue('-1d == -1d, aka i1 == i2', i1.equals(i2));
  assertTrue('-1d == -1d, aka i2 == i1', i2.equals(i1));

  i1 = new goog.date.Interval(goog.date.Interval.DAYS, -1);
  i2 = new goog.date.Interval(goog.date.Interval.DAYS, 1);
  assertFalse('-1d != +1d, aka i1 == i2', i1.equals(i2));
  assertFalse('-1d != +1d, aka i2 == i1', i2.equals(i1));

  i1 = new goog.date.Interval(0, 3); // Three months
  i2 = new goog.date.Interval(goog.date.Interval.MONTHS, 3);
  assertTrue('3m == 3m, aka i1 == i2', i1.equals(i2));
  assertTrue('3m == 3m, aka i2 == i1', i2.equals(i1));

  //1 year, 6 months, 15 days, 12 hours, 30 minutes, 30 seconds
  i1 = new goog.date.Interval(1, 6, 15, 12, 30, 30);
  i2 = new goog.date.Interval(1, 6, 15, 12, 30, 30);
  assertTrue('1y6m15d12h30M30s == 1y6m15d12h30M30s', i1.equals(i2));
  assertTrue('1y6m15d12h30M30s == 1y6m15d12h30M30s', i2.equals(i1));
}


//=== tests for adding two goog.date.Interval intervals ===
function testIntervalIntervalAdd() {
  var i1 = new goog.date.Interval(1, 6, 15, 12, 30, 30);
  var i2 = new goog.date.Interval(0, 3, 20, 10, 50, -25);
  i1.add(i2);
  assertTrue('i1 + i2', i1.equals(new goog.date.Interval(1, 9, 35, 22, 80, 5)));

  i1 = new goog.date.Interval(1, 6, 15, 12, 30, 30);
  i2 = new goog.date.Interval(0, 3, 20, 10, 50, -25);
  i2.add(i1);
  assertTrue('i2 + i1', i2.equals(new goog.date.Interval(1, 9, 35, 22, 80, 5)));

  i1 = new goog.date.Interval(1, 6, 15, 12, 30, 30);
  i2 = i1.getInverse();
  i1.add(i2);
  assertTrue('i1 + (-i1)', i1.equals(new goog.date.Interval()));

  i1 = new goog.date.Interval(goog.date.Interval.DAYS, 1);
  i2 = new goog.date.Interval(0, -2, -2);
  i1.add(i2);
  assertTrue('1d + (-2m-2d)', i1.equals(new goog.date.Interval(0, -2, -1)));
}


//=== tests conversion to and from ISO 8601 duration string ===
function testIsoDuration() {
  var interval1 = new goog.date.Interval(123, 456, 678, 11, 12, 455.5);
  var duration1 = 'P123Y456M678DT11H12M455.5S';
  assertTrue('parse full duration',
      interval1.equals(goog.date.Interval.fromIsoString(duration1)));
  assertEquals('create full duration', duration1, interval1.toIsoString());

  var interval2 = new goog.date.Interval(123);
  var duration2 = 'P123Y';
  var duration2v = 'P123Y0M0DT0H0M0S';
  assertTrue('parse year',
      interval2.equals(goog.date.Interval.fromIsoString(duration2)));
  assertEquals('create year', duration2, interval2.toIsoString());
  assertEquals('create year, verbose', duration2v, interval2.toIsoString(true));

  var interval3 = new goog.date.Interval(0, 0, 0, 11, 12, 40);
  var duration3 = 'PT11H12M40S';
  var duration3v = 'P0Y0M0DT11H12M40S';
  assertTrue('parse time duration',
      interval3.equals(goog.date.Interval.fromIsoString(duration3)));
  assertEquals('create time duration', duration3, interval3.toIsoString());
  assertEquals('create time duration, verbove',
      duration3v, interval3.toIsoString(true));

  var interval4 = new goog.date.Interval(7, 8, 9, 1, 2, 4);
  var duration4 = 'P7Y8M9DT1H2M4S';
  assertTrue('parse one-digit duration',
      interval4.equals(goog.date.Interval.fromIsoString(duration4)));
  assertEquals('create one-digit duration', duration4, interval4.toIsoString());

  var interval5 = new goog.date.Interval(-123, -456, -678, -11, -12, -455.5);
  var duration5 = '-P123Y456M678DT11H12M455.5S';
  assertTrue('parse full negative duration',
      interval5.equals(goog.date.Interval.fromIsoString(duration5)));
  assertEquals('create full negative duration',
      duration5, interval5.toIsoString());

  var interval6 = new goog.date.Interval(0, 0, -1);
  var duration6 = '-P1D';
  var duration6v = '-P0Y0M1DT0H0M0S';
  assertTrue('parse partial negative duration',
      interval6.equals(goog.date.Interval.fromIsoString(duration6)));
  assertEquals('create partial negative duration',
      duration6, interval6.toIsoString());
  assertEquals('create partial negative duration, verbose',
      duration6v, interval6.toIsoString(true));

  var interval7 = new goog.date.Interval(0, 0, 9, 0, 0, 4);
  var duration7 = 'P9DT4S';
  var duration7v = 'P0Y0M9DT0H0M4S';
  assertTrue('parse partial one-digit duration',
      interval7.equals(goog.date.Interval.fromIsoString(duration7)));
  assertTrue('parse partial one-digit duration, verbose',
      interval7.equals(goog.date.Interval.fromIsoString(duration7v)));
  assertEquals('create partial one-digit duration',
      duration7, interval7.toIsoString());
  assertEquals('create partial one-digit duration, verbose',
      duration7v, interval7.toIsoString(true));

  var interval8 = new goog.date.Interval(1, -1, 1, -1, 1, -1);
  assertNull('create mixed sign duration', interval8.toIsoString());

  var duration9 = '1Y1M1DT1H1M1S';
  assertNull('missing P', goog.date.Interval.fromIsoString(duration9));

  var duration10 = 'P1Y1M1D1H1M1S';
  assertNull('missing T', goog.date.Interval.fromIsoString(duration10));

  var duration11 = 'P1Y1M1DT';
  assertNull('extra T', goog.date.Interval.fromIsoString(duration11));

  var duration12 = 'PT.5S';
  assertNull('invalid seconds, missing integer part',
             goog.date.Interval.fromIsoString(duration12));

  var duration13 = 'PT1.S';
  assertNull('invalid seconds, missing fractional part',
             goog.date.Interval.fromIsoString(duration13));
}


function testGetTotalSeconds() {
  var duration = new goog.date.Interval(0, 0, 2, 3, 4, 5);
  assertEquals('seconds in 2d3h4m5s', 2 * 86400 + 3 * 3600 + 4 * 60 + 5,
      duration.getTotalSeconds());
}


function testIsDateLikeWithGoogDateTime() {
  var jsDate = new Date();
  var googDate = new goog.date.DateTime();
  var string = 'foo';
  var number = 1;
  var nullVar = null;
  var notDefined;

  assertTrue('js Date should be date-like', goog.isDateLike(jsDate));
  assertTrue('goog Date should be date-like', goog.isDateLike(googDate));
  assertFalse('string should not be date-like', goog.isDateLike(string));
  assertFalse('number should not be date-like', goog.isDateLike(number));
  assertFalse('nullVar should not be date-like', goog.isDateLike(nullVar));
  assertFalse('undefined should not be date-like', goog.isDateLike(notDefined));
}


function testDateTimezone() {
  var d = new goog.date.DateTime(2006, 01, 01, 12, 00, 00);
  d.add(new goog.date.Interval(goog.date.Interval.MINUTES,
                               d.getTimezoneOffset()));
  var d2 = new goog.date.DateTime(2006, 01, 01, 12, 00, 00);
  assertEquals('Compensate for timezone and compare with UTC date/time',
               d.toIsoString(true), d2.toUTCIsoString(true));
}


function testToUsTimeString() {
  var doPad = true;
  var doShowPm = true;
  var dontPad = false;
  var dontShowPm = false;

  // 12am
  var d = new goog.date.DateTime(2007, 1, 14);
  assertEquals('12am test 1', '12:00am', d.toUsTimeString());
  assertEquals('12am test 2', '12:00am', d.toUsTimeString(doPad));
  assertEquals('12am test 3', '12:00am', d.toUsTimeString(dontPad));
  assertEquals('12am test 4', '12:00am', d.toUsTimeString(doPad, doShowPm));
  assertEquals('12am test 5', '00:00', d.toUsTimeString(doPad, dontShowPm));
  assertEquals('12am test 6', '12:00am', d.toUsTimeString(dontPad, doShowPm));
  assertEquals('12am test 7', '0:00', d.toUsTimeString(dontPad, dontShowPm));

  // 9am
  d = new goog.date.DateTime(2007, 1, 14, 9);
  assertEquals('9am test 1', '9:00am', d.toUsTimeString());
  assertEquals('9am test 2', '09:00am', d.toUsTimeString(doPad));
  assertEquals('9am test 3', '9:00am', d.toUsTimeString(dontPad));
  assertEquals('9am test 4', '09:00am', d.toUsTimeString(doPad, doShowPm));
  assertEquals('9am test 5', '09:00', d.toUsTimeString(doPad, dontShowPm));
  assertEquals('9am test 6', '9:00am', d.toUsTimeString(dontPad, doShowPm));
  assertEquals('9am test 7', '9:00', d.toUsTimeString(dontPad, dontShowPm));

  // 12pm
  d = new goog.date.DateTime(2007, 1, 14, 12);
  assertEquals('12pm test 1', '12:00pm', d.toUsTimeString());
  assertEquals('12pm test 2', '12:00pm', d.toUsTimeString(doPad));
  assertEquals('12pm test 3', '12:00pm', d.toUsTimeString(dontPad));
  assertEquals('12pm test 4', '12:00pm', d.toUsTimeString(doPad, doShowPm));
  assertEquals('12pm test 5', '12:00', d.toUsTimeString(doPad, dontShowPm));
  assertEquals('12pm test 6', '12:00pm', d.toUsTimeString(dontPad, doShowPm));
  assertEquals('12pm test 7', '12:00', d.toUsTimeString(dontPad, dontShowPm));

  // 6pm
  d = new goog.date.DateTime(2007,1, 14, 18);
  assertEquals('6pm test 1', '6:00pm', d.toUsTimeString());
  assertEquals('6pm test 2', '06:00pm', d.toUsTimeString(doPad));
  assertEquals('6pm test 3', '6:00pm', d.toUsTimeString(dontPad));
  assertEquals('6pm test 4', '06:00pm', d.toUsTimeString(doPad, doShowPm));
  assertEquals('6pm test 5', '06:00', d.toUsTimeString(doPad, dontShowPm));
  assertEquals('6pm test 6', '6:00pm', d.toUsTimeString(dontPad, doShowPm));
  assertEquals('6pm test 7', '6:00', d.toUsTimeString(dontPad, dontShowPm));

  // 6:01pm
  d = new goog.date.DateTime(2007, 1, 14 ,18, 1);
  assertEquals('6:01pm test 1', '6:01pm', d.toUsTimeString());
  assertEquals('6:01pm test 2', '06:01pm', d.toUsTimeString(doPad));
  assertEquals('6:01pm test 3', '6:01pm', d.toUsTimeString(dontPad));
  assertEquals('6:01pm test 4', '06:01pm', d.toUsTimeString(doPad, doShowPm));
  assertEquals('6:01pm test 5', '06:01', d.toUsTimeString(doPad, dontShowPm));
  assertEquals('6:01pm test 6', '6:01pm', d.toUsTimeString(dontPad, doShowPm));
  assertEquals('6:01pm test 7', '6:01', d.toUsTimeString(dontPad, dontShowPm));

  // 6:35pm
  d = new goog.date.DateTime(2007, 1, 14 ,18, 35);
  assertEquals('6:35pm test 1', '6:35pm', d.toUsTimeString());
  assertEquals('6:35pm test 2', '06:35pm', d.toUsTimeString(doPad));
  assertEquals('6:35pm test 3', '6:35pm', d.toUsTimeString(dontPad));
  assertEquals('6:35pm test 4', '06:35pm', d.toUsTimeString(doPad, doShowPm));
  assertEquals('6:35pm test 5', '06:35', d.toUsTimeString(doPad, dontShowPm));
  assertEquals('6:35pm test 6', '6:35pm', d.toUsTimeString(dontPad, doShowPm));
  assertEquals('6:35pm test 7', '6:35', d.toUsTimeString(dontPad, dontShowPm));

  // omit zero minutes
  d = new goog.date.DateTime(2007,1, 14, 18);
  assertEquals('omit zero 1', '6:00pm', d.toUsTimeString(dontPad,
                                                         doShowPm,
                                                         false));
  assertEquals('omit zero 2', '6pm', d.toUsTimeString(dontPad,
                                                      doShowPm,
                                                      true));

  // but don't omit zero minutes if not actually zero minutes
  d = new goog.date.DateTime(2007,1, 14, 18, 1);
  assertEquals('omit zero 3', '6:01pm', d.toUsTimeString(dontPad,
                                                         doShowPm,
                                                         false));
  assertEquals('omit zero 4', '6:01pm', d.toUsTimeString(dontPad,
                                                         doShowPm,
                                                         true));
}


function testToIsoTimeString() {
  // 00:00
  var d = new goog.date.DateTime(2007, 1, 14);
  assertEquals('00:00', '00:00:00', d.toIsoTimeString());

  // 09:00
  d = new goog.date.DateTime(2007, 1, 14, 9);
  assertEquals('09:00', '09:00:00', d.toIsoTimeString());

  // 12:00
  d = new goog.date.DateTime(2007, 1, 14, 12);
  assertEquals('12:00', '12:00:00', d.toIsoTimeString());

  // 18:00
  d = new goog.date.DateTime(2007,1, 14, 18);
  assertEquals('18:00', '18:00:00', d.toIsoTimeString());

  // 18:01
  d = new goog.date.DateTime(2007, 1, 14 ,18, 1);
  assertEquals('18:01', '18:01:00', d.toIsoTimeString());

  // 18:35
  d = new goog.date.DateTime(2007, 1, 14 ,18, 35);
  assertEquals('18:35', '18:35:00', d.toIsoTimeString());

  // 18:35:01
  d = new goog.date.DateTime(2007, 1, 14 ,18, 35, 1);
  assertEquals('18:35:01', '18:35:01', d.toIsoTimeString());

  // 18:35:11
  d = new goog.date.DateTime(2007, 1, 14 ,18, 35, 11);
  assertEquals('18:35:11', '18:35:11', d.toIsoTimeString());

  // 18:35:11 >> 18:35
  d = new goog.date.DateTime(2007, 1, 14 ,18, 35, 11);
  assertEquals('18:35:11 no secs', '18:35', d.toIsoTimeString(false));
}


function testToXmlDateTimeString() {
  var d = new goog.date.DateTime(2007, 1, 14);
  assertEquals("2007-02-14",
      "2007-02-14T00:00:00",
      d.toXmlDateTime());

  d = new goog.date.DateTime(2007, 1, 14 ,18, 35, 1);
  assertEquals('2007-02-14 18:35:01, timezone==undefined',
      '2007-02-14T18:35:01',
      d.toXmlDateTime());

  d = new goog.date.DateTime(2007, 1, 14 ,18, 35, 1);
  assertEquals('2007-02-14 18:35:01, timezone==false',
      '2007-02-14T18:35:01',
      d.toXmlDateTime(false));

  d = new goog.date.DateTime(2007, 1, 14 ,18, 35, 1);
  assertEquals('2007-02-14 18:35:01, timezone==true',
      '2007-02-14T18:35:01' + d.getTimezoneOffsetString(),
      d.toXmlDateTime(true));
}


function testClone() {
  var d = new goog.date.DateTime(2007, 1, 14, 18, 35, 1);
  var d2 = d.clone();
  assertTrue('datetimes equal', d.equals(d2));

  d = new goog.date.DateTime(2007, 1, 14, 18, 35, 1, 310);
  d2 = d.clone();
  assertTrue('datetimes with milliseconds equal', d.equals(d2));

  d = new goog.date.Date(2007, 1, 14);
  d2 = d.clone();
  assertTrue('dates equal', d.equals(d2));

  // 1 year, 6 months, 15 days, 12 hours, 30 minutes, 30 seconds
  var i = new goog.date.Interval(1, 6, 15, 12, 30, 30);
  var i2 = i.clone();
  assertTrue('intervals equal', i.equals(i2));

  i = new goog.date.Interval(goog.date.Interval.DAYS, -1);
  i2 = i.clone();
  assertTrue('day intervals equal', i.equals(i2));

  // Brasilia dst
  d = new goog.date.Date(2008, goog.date.month.OCT, 18);
  d.add(new goog.date.Interval(goog.date.Interval.DAYS, 1));
  d2 = d.clone();
  assertTrue('dates equal', d.equals(d2));
}

function testValueOf() {
  var date1 = new goog.date.DateTime(2008, 11, 26, 15, 40, 0);
  var date2 = new goog.date.Date(2008, 11, 27);
  var date3 = new goog.date.DateTime(2008, 11, 26, 15, 40, 1);
  var nativeDate = new Date();
  nativeDate.setFullYear(2008, 11, 26);
  nativeDate.setHours(15, 40, 0, 0);
  assertEquals(date1.valueOf(), nativeDate.valueOf());
  assertFalse(date1 < date1);
  assertTrue(date1 <= date1);
  assertTrue(date1 < date2);
  assertTrue(date2 > date3);
}

function isWinxpSafari4() {
  return goog.userAgent.product.SAFARI && goog.userAgent.product.isVersion('531') &&
      !goog.userAgent.product.isVersion('553') &&
      goog.userAgent.WINDOWS &&
      goog.userAgent.platform.isVersion('5.0') &&
      !goog.userAgent.platform.isVersion('6.0');
}

">TypeError: Object #<Object> has no method 'createElement'
    at Object.createDom_ (dom/dom.js:681:21)
    at Object.<anonymous> (dom/dom.js:641:19)
    at Function.setUpConsole_ (testing/expectedfailures.js:115:28)
    at new <anonymous> (testing/expectedfailures.js:63:33)
    at _tmpclosuretest.js:17:24
    at [object Object].runTestContents_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:419:27)
    at [object Object].runTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:404:8)
    at [object Object].runNextTest_ (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:311:10)
    at [object Object].run (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:95:8)
    at Object.<anonymous> (/home/ubuntu/Dev/projects/node-goog/bin/googtest.js:446:29)
</td></tr>
<tr><td>daterange_test.html</td><td>Success</td><td> 16 passed, 0 failed.</td><td title="

  goog.require('goog.date.Date');
  goog.require('goog.date.Interval');
  goog.require('goog.iter.Iterator');
  goog.require('goog.testing.jsunit');


  goog.require('goog.date.DateRange');
  goog.require('goog.date.DateRange.StandardDateRangeKeys');



var gd = goog.date.Date;
var gdr = goog.date.DateRange;
var gdi = goog.date.Interval;

function testDateRange() {
  var date1 = new gd(2000, 0, 1);
  var date2 = new gd(2000, 1, 1);

  var range = new gdr(date1, date2);
  assertTrue('startDate matches', date1.equals(range.getStartDate()));
  assertTrue('endDate matches', date2.equals(range.getEndDate()));
}

function testDateRangeEquals() {
  var date1 = new gd(2000, 0, 1);
  var date2 = new gd(2000, 1, 1);

  var range1 = new gdr(date1, date2);
  var range2 = new gdr(date1, date2);
  assertTrue('equals', gdr.equals(range1, range2));
}

function testDateRangeNotEquals() {
  var date1 = new gd(2000, 0, 1);
  var date2 = new gd(2000, 1, 1);

  var range1 = new gdr(date1, date2);
  var range2 = new gdr(date2, date1);
  assertFalse('not equals', gdr.equals(range1, range2));
}

function testOffsetInDays() {
  var d = new gd(2000, 0, 1);
  var f = gdr.offsetInDays_;

  assertTrue('same day', d.equals(f(d, 0)));
  assertTrue('next day', new gd(2000, 0, 2).equals(f(d, 1)));
  assertTrue('last day', new gd(1999, 11, 31).equals(f(d, -1)));
}

function testCurrentOrLastMonday() {
  var mon = new gd(2008, 9, 13);
  var tue = new gd(2008, 9, 14);
  var wed = new gd(2008, 9, 15);
  var thu = new gd(2008, 9, 16);
  var fri = new gd(2008, 9, 17);
  var sat = new gd(2008, 9, 18);
  var sun = new gd(2008, 9, 19);
  var f = gdr.currentOrLastMonday_;

  assertTrue('mon', mon.equals(f(mon)));
  assertTrue('tue', mon.equals(f(tue)));
  assertTrue('wed', mon.equals(f(wed)));
  assertTrue('thu', mon.equals(f(thu)));
  assertTrue('fri', mon.equals(f(fri)));
  assertTrue('sat', mon.equals(f(sat)));
  assertTrue('sun', mon.equals(f(sun)));
}

function testOffsetInMonths() {
  var d = new gd(2008, 9, 13);
  var f = gdr.offsetInMonths_;

  assertTrue('this month', new gd(2008, 9, 1).equals(f(d, 0)));
  assertTrue('last month', new gd(2008, 8, 1).equals(f(d, -1)));
  assertTrue('next month', new gd(2008, 10, 1).equals(f(d, 1)));
  assertTrue('next year', new gd(2009, 9, 1).equals(f(d, 12)));
  assertTrue('last year', new gd(2007, 9, 1).equals(f(d, -12)));
}

function testYesterday() {
  var d = new gd(2008, 9, 13);
  var s = new gd(2008, 9, 12);
  var e = new gd(2008, 9, 12);
  assertStartEnd('yesterday', s, e, gdr.yesterday(d));
  assertStartEnd('yesterday with regular Date', s, e,
      gdr.yesterday(new Date(d.getTime())));
}

function testToday() {
  var d = new gd(2008, 9, 13);
  assertStartEnd('today', d, d, gdr.today(d));
}

function testLast7Days() {
  var d = new gd(2008, 9, 13);
  var s = new gd(2008, 9, 6);
  var e = new gd(2008, 9, 12);
  assertStartEnd('last7Days', s, e, gdr.last7Days(d));
  assertStartEnd('last7Days with regular Date', s, e,
      gdr.last7Days(new Date(d.getTime())));
  assertStartEnd('last7Days by key', s, e,
      gdr.standardDateRange(gdr.StandardDateRangeKeys.LAST_7_DAYS, d));
}

function testThisMonth() {
  var d = new gd(2008, 9, 13);
  var s = new gd(2008, 9, 1);
  var e = new gd(2008, 9, 31);
  assertStartEnd('thisMonth', s, e, gdr.thisMonth(d));
  assertStartEnd('thisMonth with regular Date', s, e,
      gdr.thisMonth(new Date(d.getTime())));
  assertStartEnd('thisMonth by key', s, e,
      gdr.standardDateRange(gdr.StandardDateRangeKeys.THIS_MONTH, d));
}

function testLastMonth() {
  var d = new gd(2008, 9, 13);
  var s = new gd(2008, 8, 1);
  var e = new gd(2008, 8, 30);
  assertStartEnd('lastMonth', s, e, gdr.lastMonth(d));
  assertStartEnd('lastMonth with regular Date', s, e,
      gdr.lastMonth(new Date(d.getTime())));
  assertStartEnd('lastMonth by key', s, e,
      gdr.standardDateRange(gdr.StandardDateRangeKeys.LAST_MONTH, d));
}

function testThisWeek() {
  var d = new gd(2008, 9, 13);
  var s = new gd(2008, 9, 13);
  var e = new gd(2008, 9, 19);
  assertStartEnd('thisWeek', s, e, gdr.thisWeek(d));
  assertStartEnd('thisWeek with regular Date', s, e,
      gdr.thisWeek(new Date(d.getTime())));
  assertStartEnd('thisWeek by key', s, e,
      gdr.standardDateRange(gdr.StandardDateRangeKeys.THIS_WEEK, d));
}

function testLastWeek() {
  var d = new gd(2008, 9, 13);
  var s = new gd(2008, 9, 6);
  var e = new gd(2008, 9, 12);
  assertStartEnd('lastWeek', s, e, gdr.lastWeek(d));
  assertStartEnd('lastWeek with regular Date', s, e,
      gdr.lastWeek(new Date(d.getTime())));
  assertStartEnd('lastWeek by key', s, e,
      gdr.standardDateRange(gdr.StandardDateRangeKeys.LAST_WEEK, d));
}

function testLastBusinessWeek() {
  var d = new gd(2008, 9, 13);
  var s = new gd(2008, 9, 6);
  var e = new gd(2008, 9, 10);
  assertStartEnd('lastBusinessWeek', s, e, gdr.lastBusinessWeek(d));
  assertStartEnd('lastBusinessWeek with regular Date', s, e,
      gdr.lastBusinessWeek(new Date(d.getTime())));
  assertStartEnd('lastBusinessWeek by key', s, e,
      gdr.standardDateRange(gdr.StandardDateRangeKeys.LAST_BUSINESS_WEEK, d));
}

function testAllTime() {
  var s = new gd(0000, 0, 1);
  var e = new gd(9999, 11, 31);
  assertStartEnd('allTime', s, e, gdr.allTime());
  assertStartEnd('allTime by key', s, e,
      gdr.standardDateRange(gdr.StandardDateRangeKeys.ALL_TIME));
}

function testIterator() {
  var s = new gd(2008, 9, 1);
  var e = new gd(2008, 9, 10);
  var i = new gdr(s, e).iterator();
  assertTrue('day 0', new gd(2008, 9, 1).equals(i.next()));
  assertTrue('day 1', new gd(2008, 9, 2).equals(i.next()));
  assertTrue('day 2', new gd(2008, 9, 3).equals(i.next()));
  assertTrue('day 3', new gd(2008, 9, 4).equals(i.next()));
  assertTrue('day 4', new gd(2008, 9, 5).equals(i.next()));
  assertTrue('day 5', new gd(2008, 9, 6).equals(i.next()));
  assertTrue('day 6', new gd(2008, 9, 7).equals(i.next()));
  assertTrue('day 7', new gd(2008, 9, 8).equals(i.next()));
  assertTrue('day 8', new gd(2008, 9, 9).equals(i.next()));
  assertTrue('day 9', new gd(2008, 9, 10).equals(i.next()));
  assertThrows('day 10', goog.bind(i.next, i));
}

function assertStartEnd(name, start, end, actual) {
  assertTrue(
      name + ' start should be ' + start + ' but was ' + actual.getStartDate(),
      start.equals(actual.getStartDate()));
  assertTrue(
      name + ' end should be ' + end + ' but was ' + actual.getEndDate(),
      end.equals(actual.getEndDate()));
}

">n/a</td></tr>
<tr><td>utcdatetime_test.html</td><td>Success</td><td> 7 passed, 0 failed.</td><td title="

  goog.require('goog.date');
  goog.require('goog.date.UtcDateTime');
  goog.require('goog.testing.jsunit');



function testConstructor() {
  goog.now = function() {
    return new Date(2001, 2, 3, 4).getTime();
  };

  var d = new goog.date.UtcDateTime();
  assertTrue('default constructor', d.equals(new Date(goog.now())));

  var d = new goog.date.UtcDateTime(2001);
  assertTrue('year only', d.equals(new Date(Date.UTC(2001, 0, 1, 0, 0, 0))));

  var d = new goog.date.UtcDateTime(2001, 2, 3, 4, 5, 6, 7);
  assertTrue('full date/time',
             d.equals(new Date(Date.UTC(2001, 2, 3, 4, 5, 6, 7))));

  var d = new goog.date.UtcDateTime(new Date(0));
  assertTrue('copy constructor',
             d.equals(new Date(Date.UTC(1970, 0, 1, 0, 0, 0))));
}

function testClone() {
  var d = new goog.date.UtcDateTime(2001, 2, 3, 4, 5, 6, 7);
  assertTrue('clone of UtcDateTime', d.equals(d.clone()));
}

function testAdd() {
  var date = new goog.date.UtcDateTime(2007, goog.date.month.OCT, 5);
  date.add(new goog.date.Interval(-1, 2));
  var expected = new goog.date.UtcDateTime(2006, goog.date.month.DEC, 5);
  assertTrue('UTC date + years + months', expected.equals(date));

  var date = new goog.date.UtcDateTime(2007, goog.date.month.OCT, 1);
  date.add(new goog.date.Interval(0, 0, 60));
  var expected = new goog.date.UtcDateTime(2007, goog.date.month.NOV, 30);
  assertTrue('UTC date + days', expected.equals(date));

  var date = new goog.date.UtcDateTime(2007, goog.date.month.OCT, 1);
  date.add(new goog.date.Interval(0, 0, 0, 60 * 24 - 12, -30, -30.5));
  var expected = new goog.date.UtcDateTime(2007, goog.date.month.NOV, 29,
                                           11, 29, 29, 500);
  assertTrue('UTC date + time, daylight saving ignored', expected.equals(date));
}

function testGetYear() {
  var date = new goog.date.UtcDateTime(2000, goog.date.month.JAN, 1);
  assertEquals('year of 2000-01-01 00:00:00', 2000, date.getYear());

  var date = new goog.date.UtcDateTime(1999, goog.date.month.DEC, 31, 23, 59);
  assertEquals('year of 1999-12-31 23:59:00', 1999, date.getYear());
}

function testGetDay() {
  var date = new goog.date.UtcDateTime(2000, goog.date.month.JAN, 1);
  assertEquals('2000-01-01 00:00:00 is Saturday (UTC + ISO)',
               goog.date.weekDay.SAT, date.getUTCIsoWeekday());
  assertEquals('2000-01-01 00:00:00 is Saturday (ISO)',
               goog.date.weekDay.SAT, date.getIsoWeekday());
  assertEquals('2000-01-01 00:00:00 is Saturday (UTC)',
               6, date.getUTCDay());
  assertEquals('2000-01-01 00:00:00 is Saturday',
               6, date.getDay());

  var date = new goog.date.UtcDateTime(2000, goog.date.month.JAN, 1, 23, 59);
  assertEquals('2000-01-01 23:59:00 is Saturday (UTC + ISO)',
               goog.date.weekDay.SAT, date.getUTCIsoWeekday());
  assertEquals('2000-01-01 23:59:00 is Saturday (ISO)',
               goog.date.weekDay.SAT, date.getIsoWeekday());
  assertEquals('2000-01-01 23:59:00 is Saturday (UTC)',
               6, date.getUTCDay());
  assertEquals('2000-01-01 23:59:00 is Saturday',
               6, date.getDay());
}

function testFromIsoString() {
  var dateString = '2000-01-02';
  var date = goog.date.UtcDateTime.fromIsoString(dateString);
  var exp = new goog.date.UtcDateTime(2000, goog.date.month.JAN, 2);
  assertTrue('parsed ISO date', exp.equals(date));

  var dateTimeString = '2000-01-02 03:04:05';
  var dateTime = goog.date.UtcDateTime.fromIsoString(dateTimeString);
  var exp = new goog.date.UtcDateTime(2000, goog.date.month.JAN, 2, 3, 4, 5);
  assertTrue('parsed ISO date/time', exp.equals(dateTime));
}

function testToIsoString() {
  var date = new goog.date.UtcDateTime(2000, goog.date.month.JAN, 2, 3, 4, 5);
  assertEquals('serialize date/time',
               '2000-01-02 03:04:05', date.toIsoString(true));
  assertEquals('serialize time only',
               '03:04:05', date.toIsoTimeString(true));
  assertEquals('serialize date/time to XML',
               '2000-01-02T03:04:05', date.toXmlDateTime());
}

">n/a</td></tr>
<tr><td>object_test.html</td><td>Success</td><td> 24 passed, 0 failed.</td><td title="

  goog.require('goog.object');
  goog.require('goog.testing.jsunit');



function stringifyObject(m) {
  var keys = goog.object.getKeys(m);
  var s = '';
  for (var i = 0; i < keys.length; i++) {
    s += keys[i] + goog.object.get(m, keys[i]);
  }
  return s;
}

function getObject() {
  return {
    a: 0,
    b: 1,
    c: 2,
    d: 3
  };
}

function testKeys() {
  var m = getObject();
  assertEquals('getKeys, The keys should be a,b,c',
               'a,b,c,d',
               goog.object.getKeys(m).join(','));
}

function testValues() {
  var m = getObject();
  assertEquals('getValues, The values should be 0,1,2',
      '0,1,2,3', goog.object.getValues(m).join(','));
}

function testGetAnyKey() {
  var m = getObject();
  assertTrue("getAnyKey, The key should be a,b,c or d",
             goog.object.getAnyKey(m) in m);
  assertUndefined("getAnyKey, The key should be undefined",
                  goog.object.getAnyKey({}));
}

function testGetAnyValue() {
  var m = getObject();
  assertTrue("getAnyValue, The value should be 0,1,2 or 3",
             goog.object.containsValue(m, goog.object.getAnyValue(m)));
  assertUndefined("getAnyValue, The value should be undefined",
                  goog.object.getAnyValue({}));
}

function testContainsKey() {
  var m = getObject();
  assertTrue("containsKey, Should contain the 'a' key",
             goog.object.containsKey(m, 'a'));
  assertFalse("containsKey, Should not contain the 'e' key",
              goog.object.containsKey(m, 'e'));
}

function testContainsValue() {
  var m = getObject();
  assertTrue('containsValue, Should contain the value 0',
             goog.object.containsValue(m, 0));
  assertFalse('containsValue, Should not contain the value 4',
              goog.object.containsValue(m, 4));
  assertTrue('isEmpty, The map should not be empty', !goog.object.isEmpty(m));
}

function testFindKey() {
  var dict = {'a': 1, 'b': 2, 'c': 3, 'd': 4};
  var key = goog.object.findKey(dict, function(v, k, d) {
    assertEquals('valid 3rd argument', dict, d);
    assertTrue('valid 1st argument', goog.object.containsValue(d, v));
    assertTrue('valid 2nd argument', k in d);
    return v % 3 == 0;
  });
  assertEquals('key "c" found', 'c', key);

  var pred = function(value) {
    return value > 5;
  };
  assertUndefined('no match', goog.object.findKey(dict, pred));
}

function testFindValue() {
  var dict = {'a': 1, 'b': 2, 'c': 3, 'd': 4};
  var value = goog.object.findValue(dict, function(v, k, d) {
    assertEquals('valid 3rd argument', dict, d);
    assertTrue('valid 1st argument', goog.object.containsValue(d, v));
    assertTrue('valid 2nd argument', k in d);
    return k.toUpperCase() == 'C';
  });
  assertEquals('value 3 found', 3, value);

  var pred = function(value, key) {
    return key > 'd';
  }
  assertUndefined('no match', goog.object.findValue(dict, pred));
}

function testClear() {
  var m = getObject();
  goog.object.clear(m);
  assertTrue('cleared so it should be empty', goog.object.isEmpty(m));
  assertFalse("cleared so it should not contain 'a' key",
              goog.object.containsKey(m, 'a'));
}

function testClone() {
  var m = getObject();
  var m2 = goog.object.clone(m);
  assertFalse('clone so it should not be empty', goog.object.isEmpty(m2));
  assertTrue("clone so it should contain 'c' key",
             goog.object.containsKey(m2, 'c'));
}

function testForEach() {
  var m = getObject();
  var s = '';
  goog.object.forEach(m, function(val, key, m2) {
    assertNotUndefined(key);
    assertEquals(m, m2);
    s += key + val;
  });
  assertEquals(s, 'a0b1c2d3');
}

function testFilter() {
  var m = getObject();

  var m2 = goog.object.filter(m, function (val, key, m3) {
    assertNotUndefined(key);
    assertEquals(m, m3);
    return val > 1;
  });
  assertEquals(stringifyObject(m2), 'c2d3');
}


function testMap() {
  var m = getObject();
  var m2 = goog.object.map(m, function (val, key, m3) {
    assertNotUndefined(key);
    assertEquals(m, m3);
    return val * val;
  });
  assertEquals(stringifyObject(m2), 'a0b1c4d9');
}

function testSome() {
  var m = getObject();
  var b = goog.object.some(m, function (val, key, m2) {
    assertNotUndefined(key);
    assertEquals(m, m2);
    return val > 1;
  });
  assertTrue(b);
  var b = goog.object.some(m, function (val, key, m2) {
    assertNotUndefined(key);
    assertEquals(m, m2);
    return val > 100;
  });
  assertFalse(b);
}

function testEvery() {
  var m = getObject();
  var b = goog.object.every(m, function (val, key, m2) {
    assertNotUndefined(key);
    assertEquals(m, m2);
    return val >= 0;
  });
  assertTrue(b);
  b = goog.object.every(m, function (val, key, m2) {
    assertNotUndefined(key);
    assertEquals(m, m2);
    return val > 1;
  });
  assertFalse(b);
}

function testContains() {
  var m = getObject();
  assertTrue(goog.object.contains(m, 3));
  assertFalse(goog.object.contains(m, 4));
}

function testObjectProperties() {
  var m = {};

  goog.object.set(m, 'toString', 'once');
  goog.object.set(m, 'valueOf', 'upon');
  goog.object.set(m, 'eval', 'a');
  goog.object.set(m, 'toSource', 'midnight');
  goog.object.set(m, 'prototype', 'dreary');
  goog.object.set(m, 'hasOwnProperty', 'dark');

  assertEquals(goog.object.get(m, 'toString'), 'once');
  assertEquals(goog.object.get(m, 'valueOf'), 'upon');
  assertEquals(goog.object.get(m, 'eval'), 'a');
  assertEquals(goog.object.get(m, 'toSource'), 'midnight');
  assertEquals(goog.object.get(m, 'prototype'), 'dreary');
  assertEquals(goog.object.get(m, 'hasOwnProperty'), 'dark');
}

function testSetDefault() {
  var dict = {};
  assertEquals(1, goog.object.setIfUndefined(dict, 'a', 1));
  assertEquals(1, dict['a']);
  assertEquals(1, goog.object.setIfUndefined(dict, 'a', 2));
  assertEquals(1, dict['a']);
}

function testTranspose() {
  var m = getObject();
  var b = goog.object.transpose(m);
  assertEquals('a', b[0]);
  assertEquals('b', b[1]);
  assertEquals('c', b[2]);
  assertEquals('d', b[3]);
}

function testExtend() {
  var o = {};
  var o2 = {a: 0, b: 1};
  goog.object.extend(o, o2);
  assertEquals(0, o.a);
  assertEquals(1, o.b);
  assertTrue('a' in o);
  assertTrue('b' in o);

  o2 = {c: 2};
  goog.object.extend(o, o2);
  assertEquals(2, o.c);
  assertTrue('c' in o);

  o2 = {c: 3};
  goog.object.extend(o, o2);
  assertEquals(3, o.c);
  assertTrue('c' in o);


  o = {};
  o2 = {a: 0, b: 1};
  var o3 = {c: 2, d: 3};
  goog.object.extend(o, o2, o3);
  assertEquals(0, o.a);
  assertEquals(1, o.b);
  assertEquals(2, o.c);
  assertEquals(3, o.d);
  assertTrue('a' in o);
  assertTrue('b' in o);
  assertTrue('c' in o);
  assertTrue('d' in o);

  o = {};
  o2 = {
    'constructor': 0,
    'hasOwnProperty': 1,
    'isPrototypeOf': 2,
    'propertyIsEnumerable': 3,
    'toLocaleString': 4,
    'toString': 5,
    'valueOf': 6
  };
  goog.object.extend(o, o2);
  assertEquals(0, o['constructor']);
  assertEquals(1, o['hasOwnProperty']);
  assertEquals(2, o['isPrototypeOf']);
  assertEquals(3, o['propertyIsEnumerable']);
  assertEquals(4, o['toLocaleString']);
  assertEquals(5, o['toString']);
  assertEquals(6, o['valueOf']);
  assertTrue('constructor' in o);
  assertTrue('hasOwnProperty' in o);
  assertTrue('isPrototypeOf' in o);
  assertTrue('propertyIsEnumerable' in o);
  assertTrue('toLocaleString' in o);
  assertTrue('toString' in o);
  assertTrue('valueOf' in o);
}

function testCreate() {
  assertObjectEquals('With multiple arguments',
                     {a: 0, b: 1}, goog.object.create('a', 0, 'b', 1));
  assertObjectEquals('With an array argument',
                     {a: 0, b: 1}, goog.object.create(['a', 0, 'b', 1]));

  assertObjectEquals('With no arguments',
                     {}, goog.object.create());
  assertObjectEquals('With an ampty array argument',
                     {}, goog.object.create([]));

  assertThrows('Should throw due to uneven arguments', function() {
    goog.object.create('a');
  });
  assertThrows('Should throw due to uneven arguments', function() {
    goog.object.create('a', 0, 'b');
  });
  assertThrows('Should throw due to uneven length array', function() {
    goog.object.create(['a']);
  });
  assertThrows('Should throw due to uneven length array', function() {
    goog.object.create(['a', 0, 'b']);
  });
}

function testCreateSet() {
  assertObjectEquals('With multiple arguments',
                     {a: true, b: true}, goog.object.createSet('a', 'b'));
  assertObjectEquals('With an array argument',
                     {a: true, b: true}, goog.object.createSet(['a', 'b']));

  assertObjectEquals('With no arguments',
                     {}, goog.object.createSet());
  assertObjectEquals('With an ampty array argument',
                     {}, goog.object.createSet([]));
}

function createTestDeepObject() {
  var obj = {};
  obj.a = {};
  obj.a.b = {};
  obj.a.b.c = {};
  obj.a.b.c.fooArr = [5, 6, 7, 8];
  obj.a.b.c.knownNull = null;
  return obj;
}

function testGetValueByKeys() {
  var obj = createTestDeepObject();
  assertEquals(obj, goog.object.getValueByKeys(obj));
  assertEquals(obj.a, goog.object.getValueByKeys(obj, 'a'));
  assertEquals(obj.a.b, goog.object.getValueByKeys(obj, 'a', 'b'));
  assertEquals(obj.a.b.c, goog.object.getValueByKeys(obj, 'a', 'b', 'c'));
  assertEquals(obj.a.b.c.d,
               goog.object.getValueByKeys(obj, 'a', 'b', 'c', 'd'));
  assertEquals(8, goog.object.getValueByKeys(obj, 'a', 'b', 'c', 'fooArr', 3));
  assertNull(goog.object.getValueByKeys(obj, 'a', 'b', 'c', 'knownNull'));
  assertUndefined(goog.object.getValueByKeys(obj, 'e', 'f', 'g'));
}

function testGetValueByKeysArraySyntax() {
  var obj = createTestDeepObject();
  assertEquals(obj, goog.object.getValueByKeys(obj, []));
  assertEquals(obj.a, goog.object.getValueByKeys(obj, ['a']));

  assertEquals(obj.a.b, goog.object.getValueByKeys(obj, ['a', 'b']));
  assertEquals(obj.a.b.c, goog.object.getValueByKeys(obj, ['a', 'b', 'c']));
  assertEquals(obj.a.b.c.d,
      goog.object.getValueByKeys(obj, ['a', 'b', 'c', 'd']));
  assertEquals(8,
      goog.object.getValueByKeys(obj, ['a', 'b', 'c', 'fooArr', 3]));
  assertNull(goog.object.getValueByKeys(obj, ['a', 'b', 'c', 'knownNull']));
  assertUndefined(goog.object.getValueByKeys(obj, 'e', 'f', 'g'));
}

">n/a</td></tr>
<tr><td>cssom_test.html</td><td>Fail</td><td> 1 passed, 12 failed.</td><td title="

      goog.require('goog.array');
      goog.require('goog.cssom');
      goog.require('goog.testing.jsunit');
      goog.require('goog.userAgent');
    


      // Since sheet cssom_test1.css's first line is to import
      // cssom_test2.css, we should get 2 before one in the string.
      var cssText = '.css-link-1 { display: block; } ' +
          '.css-import-2 { display: block; } ' +
          '.css-import-1 { display: block; } ' +
          '.css-style-1 { display: block; } ' +
          '.css-style-2 { display: block; } ' +
          '.css-style-3 { display: block; }';

      var replacementCssText = '.css-repl-1 { display: block; }';

      var isIe7 = goog.userAgent.IE &&
                 (goog.userAgent.compare(goog.userAgent.VERSION, '7.0') == 0);

      // We're going to toLowerCase cssText before testing, because IE returns
      // CSS property names in UPPERCASE, and the function shouldn't
      // "fix" the text as it would be expensive and rarely of use.
      // Same goes for the trailing whitespace in IE.
      // Same goes for fixing the optimized removal of trailing ; in rules.
      // Also needed for Opera.
      function fixCssTextForIe(cssText) {
        cssText = cssText.toLowerCase().replace(/\s*$/, '');
        if (cssText.match(/[^;] \}/)) {
          cssText = cssText.replace(/([^;]) \}/g, '$1; }');
        }
        return cssText;
      }

      function testGetFileNameFromStyleSheet() {
        var styleSheet = {'href': 'http://foo.com/something/filename.css'};
        assertEquals('filename.css',
            goog.cssom.getFileNameFromStyleSheet(styleSheet));

        styleSheet = {'href': 'https://foo.com:123/something/filename.css'};
        assertEquals('filename.css',
            goog.cssom.getFileNameFromStyleSheet(styleSheet));

        styleSheet = {'href': 'http://foo.com/something/filename.css?bar=bas'};
        assertEquals('filename.css',
            goog.cssom.getFileNameFromStyleSheet(styleSheet));

        styleSheet = {'href': 'filename.css?bar=bas'};
        assertEquals('filename.css',
            goog.cssom.getFileNameFromStyleSheet(styleSheet));

        styleSheet = {'href': 'filename.css'};
        assertEquals('filename.css',
            goog.cssom.getFileNameFromStyleSheet(styleSheet));
      }

      function testGetAllCssStyleSheets() {
        var styleSheets = goog.cssom.getAllCssStyleSheets();
        assertEquals(4, styleSheets.length);
        // Makes sure they're in the right cascade order.
        assertEquals('cssom_test_link_1.css',
            goog.cssom.getFileNameFromStyleSheet(styleSheets[0]));
        assertEquals('cssom_test_import_2.css',
            goog.cssom.getFileNameFromStyleSheet(styleSheets[1]));
        assertEquals('cssom_test_import_1.css',
            goog.cssom.getFileNameFromStyleSheet(styleSheets[2]));
        // Not an external styleSheet
        assertNull(goog.cssom.getFileNameFromStyleSheet(styleSheets[3]));
      }

      function testGetAllCssText() {
        var allCssText = goog.cssom.getAllCssText();
        // In IE7, a CSSRule object gets included twice and replaces another
        // existing CSSRule object. We aren't using
        // goog.testing.ExpectedFailures since it brings in additional CSS
        // which breaks a lot of our expectations about the number of rules
        // present in a style sheet.
        if (!isIe7) {
          assertEquals(cssText, fixCssTextForIe(allCssText));
        }
      }

      function testGetAllCssStyleRules() {
        var allCssRules = goog.cssom.getAllCssStyleRules();
        assertEquals(6, allCssRules.length);
      }


      function testAddCssText() {
        var newCssText = '.css-add-1 { display: block; }';
        var newCssNode = goog.cssom.addCssText(newCssText);

        assertEquals(document.styleSheets.length, 3);

        var allCssText = goog.cssom.getAllCssText();

        // In IE7, a CSSRule object gets included twice and replaces another
        // existing CSSRule object. We aren't using
        // goog.testing.ExpectedFailures since it brings in additional CSS
        // which breaks a lot of our expectations about the number of rules
        // present in a style sheet.
        if (!isIe7) {
          // Opera inserts the CSSRule to the first position. And fixCssText
          // is also needed to clean up whitespace.
          if (goog.userAgent.OPERA) {
            assertEquals(newCssText + ' ' + cssText,
                         fixCssTextForIe(allCssText));
          } else {
            assertEquals(cssText + ' ' + newCssText,
                         fixCssTextForIe(allCssText));
          }
        }

        var cssRules = goog.cssom.getAllCssStyleRules();
        assertEquals(7, cssRules.length);

        // Remove the new stylesheet now so it doesn't interfere with other
        // tests.
        newCssNode.parentNode.removeChild(newCssNode);
        // Sanity check.
        cssRules = goog.cssom.getAllCssStyleRules();
        assertEquals(6, cssRules.length);
      }

      function testAddCssRule() {
        // test that addCssRule correctly adds the rule to the style
        // sheet.
        var styleSheets = goog.cssom.getAllCssStyleSheets();
        var styleSheet = styleSheets[3];
        var newCssRule = '.css-addCssRule { display: block; }';
        var rules = styleSheet.rules || styleSheet.cssRules;
        var origNumberOfRules = rules.length;

        goog.cssom.addCssRule(styleSheet, newCssRule, 1);

        rules = styleSheet.rules || styleSheet.cssRules;
        var newNumberOfRules = rules.length;
        assertEquals(newNumberOfRules, origNumberOfRules + 1);

        // Remove the added rule so we don't mess up other tests.
        goog.cssom.removeCssRule(styleSheet, 1);
      }

      function testAddCssRuleAtPos() {
        // test that addCssRule correctly adds the rule to the style
        // sheet at the specified position.
        var styleSheets = goog.cssom.getAllCssStyleSheets();
        var styleSheet = styleSheets[3];
        var newCssRule = '.css-addCssRulePos { display: block; }';
        var rules = styleSheet.rules || styleSheet.cssRules;
        var origNumberOfRules = rules.length;

        // Firefox croaks if we try to insert a CSSRule at an index that
        // contains a CSSImport Rule. Since we deal only with CSSStyleRule
        // objects, we find the first CSSStyleRule and return its index.
        //
        // NOTE(user): We could have unified the code block below for all
        // browsers but IE6 horribly mangled up the stylesheet by creating
        // duplicate instances of a rule when removeCssRule was invoked
        // just after addCssRule with the looping construct in. This is
        // perfectly fine since IE's styleSheet.rules does not contain
        // references to anything but CSSStyleRules.
        var pos = 0;
        if (!goog.userAgent.IE) {
          pos = goog.array.findIndex(rules, function(rule) {
            return rule.type == goog.cssom.CssRuleType.STYLE;
          });
        }
        goog.cssom.addCssRule(styleSheet, newCssRule, pos);

        rules = styleSheet.rules || styleSheet.cssRules;
        var newNumberOfRules = rules.length;
        assertEquals(newNumberOfRules, origNumberOfRules + 1);

        // Remove the added rule so we don't mess up other tests.
        goog.cssom.removeCssRule(styleSheet, pos);

        rules = styleSheet.rules || styleSheet.cssRules;
        assertEquals(origNumberOfRules, rules.length);
      }

      function testAddCssRuleNoIndex() {
        // How well do we handle cases where the optional index is
        //  not passed in?
        var styleSheets = goog.cssom.getAllCssStyleSheets();
        var styleSheet = styleSheets[3];
        var rules = styleSheet.rules || styleSheet.cssRules;
        var origNumberOfRules = rules.length;
        var newCssRule = '.css-addCssRuleNoIndex { display: block; }';

        // Try inserting the rule without specifying an index.
        // Make sure we don't throw an exception, and that we added
        // the entry.
        goog.cssom.addCssRule(styleSheet, newCssRule);

        rules = styleSheet.rules || styleSheet.cssRules;
        var newNumberOfRules = rules.length;
        assertEquals(newNumberOfRules, origNumberOfRules + 1);

        // Remove the added rule so we don't mess up the other tests.
        goog.cssom.removeCssRule(styleSheet, newNumberOfRules - 1);

        rules = styleSheet.rules || styleSheet.cssRules;
        assertEquals(origNumberOfRules, rules.length);
      }


      function testGetParentStyleSheetAfterGetAllCssStyleRules() {
        var cssRules = goog.cssom.getAllCssStyleRules();
        var cssRule = cssRules[4];
        var parentStyleSheet = goog.cssom.getParentStyleSheet(cssRule);
        var styleSheets = goog.cssom.getAllCssStyleSheets();
        var styleSheet = styleSheets[3];
        assertEquals(styleSheet, parentStyleSheet);
      }

      function testGetCssRuleIndexInParentStyleSheetAfterGetAllCssStyleRules() {
        var cssRules = goog.cssom.getAllCssStyleRules();
        var cssRule = cssRules[4];
        // Note here that this is correct - IE's styleSheet.rules does not
        // contain references to anything but CSSStyleRules while FF and others
        // include anything that inherits from the CSSRule interface.
        // See http://dev.w3.org/csswg/cssom/#cssrule.
        var ruleIndex = goog.userAgent.IE ? 1 : 2;
        assertEquals(ruleIndex,
            goog.cssom.getCssRuleIndexInParentStyleSheet(cssRule));
      }

      function testGetCssRuleIndexInParentStyleSheetNonStyleRule() {
        // IE's styleSheet.rules only contain CSSStyleRules.
        if (!goog.userAgent.IE) {
          var styleSheets = goog.cssom.getAllCssStyleSheets();
          var styleSheet = styleSheets[3];
          var newCssRule = '@media print { .css-nonStyle { display: block; } }';
          goog.cssom.addCssRule(styleSheet, newCssRule);
          var rules = styleSheet.rules || styleSheet.cssRules;
          var cssRule = rules[rules.length - 1];
          assertEquals(goog.cssom.CssRuleType.MEDIA, cssRule.type);
          // Make sure we don't throw an exception.
          goog.cssom.getCssRuleIndexInParentStyleSheet(cssRule, styleSheet);
          // Remove the added rule.
          goog.cssom.removeCssRule(styleSheet, rules.length - 1);
        }
      }

      // Tests the scenario where we have a known stylesheet and index.
      function testReplaceCssRuleWithStyleSheetAndIndex() {
        var styleSheets = goog.cssom.getAllCssStyleSheets();
        var styleSheet = styleSheets[3];
        var rules = goog.cssom.getCssRulesFromStyleSheet(styleSheet);
        var index = 2;
        var origCssRule = rules[index];
        var origCssText =
            fixCssTextForIe(goog.cssom.getCssTextFromCssRule(origCssRule));

        goog.cssom.replaceCssRule(origCssRule, replacementCssText, styleSheet,
            index);

        var rules = goog.cssom.getCssRulesFromStyleSheet(styleSheet);
        var newCssRule = rules[index];
        var newCssText = goog.cssom.getCssTextFromCssRule(newCssRule);
        assertEquals(replacementCssText, fixCssTextForIe(newCssText));

        // Now we need to re-replace our rule, to preserve parity for the other
        // tests.
        goog.cssom.replaceCssRule(newCssRule, origCssText, styleSheet, index);
        var rules = goog.cssom.getCssRulesFromStyleSheet(styleSheet);
        var nowCssRule = rules[index];
        var nowCssText = goog.cssom.getCssTextFromCssRule(nowCssRule);
        assertEquals(origCssText, fixCssTextForIe(nowCssText));
      }

      function testReplaceCssRuleUsingGetAllCssStyleRules() {
        var cssRules = goog.cssom.getAllCssStyleRules();
        var origCssRule = cssRules[4];
        var origCssText =
            fixCssTextForIe(goog.cssom.getCssTextFromCssRule(origCssRule));
        // notice we don't pass in the stylesheet or index.
        goog.cssom.replaceCssRule(origCssRule, replacementCssText);

        var styleSheets = goog.cssom.getAllCssStyleSheets();
        var styleSheet = styleSheets[3];
        var rules = goog.cssom.getCssRulesFromStyleSheet(styleSheet);
        var index = goog.userAgent.IE ? 1 : 2;
        var newCssRule = rules[index];
        var newCssText =
            fixCssTextForIe(goog.cssom.getCssTextFromCssRule(newCssRule));
        assertEquals(replacementCssText, newCssText);

        // try getting it the other way around too.
        var cssRules = goog.cssom.getAllCssStyleRules();
        var newCssRule = cssRules[4];
        var newCssText =
            fixCssTextForIe(goog.cssom.getCssTextFromCssRule(newCssRule));
        assertEquals(replacementCssText, newCssText);

        // Now we need to re-replace our rule, to preserve parity for the other
        // tests.
        goog.cssom.replaceCssRule(newCssRule, origCssText);
        var cssRules = goog.cssom.getAllCssStyleRules();
        var nowCssRule = cssRules[4];
        var nowCssText =
            fixCssTextForIe(goog.cssom.getCssTextFromCssRule(nowCssRule));
        assertEquals(origCssText, nowCssText);
      }
    ">13 of 13 tests run in 10ms.<br />1 passed, 12 failed.<br />1 ms/test. 1 files loaded.<br />ERROR in testAddCssRule<br />Cannot read property 'imports' of undefined<br />ERROR in testAddCssRuleAtPos<br />Cannot read property 'imports' of undefined<br />ERROR in testAddCssRuleNoIndex<br />Cannot read property 'imports' of undefined<br />ERROR in testAddCssText<br />Object #<Object> has no method 'createElement'<br />ERROR in testGetAllCssStyleRules<br />Cannot read property 'imports' of undefined<br />ERROR in testGetAllCssStyleSheets<br />Cannot read property 'imports' of undefined<br />ERROR in testGetAllCssText<br />Cannot read property 'imports' of undefined<br />ERROR in testGetCssRuleIndexInParentStyleSheetAfterGetAllCssStyleRules<br />Cannot read property 'imports' of undefined<br />ERROR in testGetCssRuleIndexInParentStyleSheetNonStyleRule<br />Cannot read property 'imports' of undefined<br />ERROR in testGetParentStyleSheetAfterGetAllCssStyleRules<br />Cannot read property 'imports' of undefined<br />ERROR in testReplaceCssRuleUsingGetAllCssStyleRules<br />Cannot read property 'imports' of undefined<br />ERROR in testReplaceCssRuleWithStyleSheetAndIndex<br />Cannot read property 'imports' of undefined<br /></td></tr></table></body></html>